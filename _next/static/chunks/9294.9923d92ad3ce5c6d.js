"use strict";(self.webpackChunk_N_E=self.webpackChunk_N_E||[]).push([[9294],{19835:(e,t,n)=>{n.d(t,{A:()=>l});let l=(0,n(78340).A)("move",[["path",{d:"M12 2v20",key:"t6zp3m"}],["path",{d:"m15 19-3 3-3-3",key:"11eu04"}],["path",{d:"m19 9 3 3-3 3",key:"1mg7y2"}],["path",{d:"M2 12h20",key:"9i4pu4"}],["path",{d:"m5 9-3 3 3 3",key:"j64kie"}],["path",{d:"m9 5 3-3 3 3",key:"l8vdw6"}]])},29294:(e,t,n)=>{n.r(t),n.d(t,{default:()=>x});var l=n(95155),r=n(12115),i=n(21975),a=n(19835),s=n(22390);let o=(0,n(78340).A)("spline",[["circle",{cx:"19",cy:"5",r:"2",key:"mhkx31"}],["circle",{cx:"5",cy:"19",r:"2",key:"v8kfzx"}],["path",{d:"M5 17A12 12 0 0 1 17 5",key:"1okkup"}]]);var c=n(68459),d=n(40980);function x(){let e=(0,r.useRef)(null),t=(0,r.useRef)(null),n=(0,r.useRef)(null),x=(0,r.useRef)({zoomLevel:1,panOffset:{x:0,y:0},isPanning:!1,panStart:{x:0,y:0},drawing:!1,startPoint:{x:0,y:0},endPoint:{x:0,y:0},areaPoints:[],lines:[],areas:[],scale:null,selectedObject:null,draggingHandle:null,dragStartMouse:{x:0,y:0},originalSelectedObjectState:null,lastMouseScreenPos:{x:0,y:0},isSpacePressed:!1,isShiftPressed:!1,snappedPoint:null,isOrthoMode:!1}),[u,p]=(0,r.useState)({mode:null,hasImage:!1,scaleSet:!1,selectedObject:!1,infoText:"請上傳平面圖開始",fillColor:"#4ade80",fillOpacity:.3,zoomDisplay:100,isOrtho:!1}),f=e=>({x:(e.x-x.current.panOffset.x)/x.current.zoomLevel,y:(e.y-x.current.panOffset.y)/x.current.zoomLevel}),h=(e,t)=>Math.sqrt((t.x-e.x)**2+(t.y-e.y)**2),m=(0,r.useCallback)(()=>{let t=e.current,l=t?.getContext("2d");if(!t||!l)return;let r=x.current,{width:i,height:a}=t;if(l.clearRect(0,0,i,a),l.save(),l.translate(r.panOffset.x,r.panOffset.y),l.scale(r.zoomLevel,r.zoomLevel),n.current){let e=n.current;l.drawImage(e,-e.naturalWidth/2,-e.naturalHeight/2)}r.zoomLevel;let s=2/r.zoomLevel,o=3.5/r.zoomLevel;if(r.areas.forEach(e=>{let t=r.selectedObject===e;if(!(e.pixelPoints.length<2)){l.beginPath(),l.moveTo(e.pixelPoints[0].x,e.pixelPoints[0].y);for(let t=1;t<e.pixelPoints.length;t++)l.lineTo(e.pixelPoints[t].x,e.pixelPoints[t].y);if(l.closePath(),l.fillStyle=y(e.fillColor,e.fillOpacity),l.fill(),l.strokeStyle=t?"#06b6d4":"#3b82f6",l.lineWidth=t?o:s,l.stroke(),r.scale){let n=(e=>{let t=0;for(let n=0,l=e.length;n<l;n++)t+=e[n].x*e[n===l-1?0:n+1].y-e[n===l-1?0:n+1].x*e[n].y;return Math.abs(t/2)})(e.pixelPoints)/(r.scale*r.scale),i=(e=>{if(0===e.length)return{x:0,y:0};let t=0,n=0,l=0;for(let r=0;r<e.length;r++){let i=e[r],a=e[(r+1)%e.length],s=i.x*a.y-a.x*i.y;l+=s,t+=(i.x+a.x)*s,n+=(i.y+a.y)*s}let r=3*l;return 0===r?e[0]:{x:t/r,y:n/r}})(e.pixelPoints);g(l,`${(n/33057.9).toFixed(2)} 坪`,i,t?"#06b6d4":"#60a5fa",r.zoomLevel)}}}),r.lines.forEach(e=>{let t=r.selectedObject===e;if(l.beginPath(),l.moveTo(e.pixelStart.x,e.pixelStart.y),l.lineTo(e.pixelEnd.x,e.pixelEnd.y),l.strokeStyle=t?"#06b6d4":e.color,l.lineWidth=t?o:s,l.stroke(),r.scale){let n=h(e.pixelStart,e.pixelEnd)/r.scale,i={x:(e.pixelStart.x+e.pixelEnd.x)/2,y:(e.pixelStart.y+e.pixelEnd.y)/2};g(l,`${n.toFixed(1)} cm`,i,t?"#06b6d4":"#f87171",r.zoomLevel)}}),r.drawing){if("setScale"===u.mode||"measureLine"===u.mode)l.beginPath(),l.moveTo(r.startPoint.x,r.startPoint.y),l.lineTo(r.endPoint.x,r.endPoint.y),l.strokeStyle="#ef4444",l.lineWidth=2/r.zoomLevel,l.stroke();else if("measureArea"===u.mode&&r.areaPoints.length>0){l.beginPath(),l.moveTo(r.areaPoints[0].x,r.areaPoints[0].y);for(let e=1;e<r.areaPoints.length;e++)l.lineTo(r.areaPoints[e].x,r.areaPoints[e].y);l.lineTo(r.endPoint.x,r.endPoint.y),l.fillStyle=y(u.fillColor,.2),l.fill(),l.strokeStyle="#3b82f6",l.lineWidth=2/r.zoomLevel,l.stroke()}}if(l.restore(),r.snappedPoint){let e,t={x:(e=r.snappedPoint).x*x.current.zoomLevel+x.current.panOffset.x,y:e.y*x.current.zoomLevel+x.current.panOffset.y};l.beginPath(),l.arc(t.x,t.y,6,0,2*Math.PI),l.strokeStyle="#facc15",l.lineWidth=2,l.stroke()}},[u]),g=(e,t,n,l,r)=>{e.save();let i=14/r;e.font=`bold ${i}px sans-serif`,e.fillStyle="rgba(0,0,0,0.7)";let a=e.measureText(t).width;e.fillRect(n.x-a/2-2/r,n.y-i-2/r,a+4/r,i+4/r),e.fillStyle=l,e.textAlign="center",e.fillText(t,n.x,n.y-4/r),e.restore()},y=(e,t)=>{let n=parseInt(e.slice(1,3),16),l=parseInt(e.slice(3,5),16),r=parseInt(e.slice(5,7),16);return`rgba(${n}, ${l}, ${r}, ${t})`};(0,r.useEffect)(()=>{x.current.isOrthoMode=u.isOrtho,m()},[u,m]);let b=(0,r.useCallback)(()=>{let e=x.current;e.areaPoints.length>=3?(e.areas.push({type:"area",pixelPoints:[...e.areaPoints],fillColor:u.fillColor,fillOpacity:u.fillOpacity}),e.areaPoints=[],e.drawing=!1,p(t=>({...t,infoText:`區域繪製完成。${e.areas.length} 個區域`}))):(e.areaPoints=[],e.drawing=!1,p(e=>({...e,infoText:`點數不足，已取消區域`}))),m()},[m,u.fillColor,u.fillOpacity]);return(0,r.useEffect)(()=>{let e=e=>{"Shift"===e.key&&(x.current.isShiftPressed=!0),"Space"===e.code&&(x.current.isSpacePressed=!0),"Enter"===e.code&&"measureArea"===u.mode&&b()},t=e=>{"Shift"===e.key&&(x.current.isShiftPressed=!1),"Space"===e.code&&(x.current.isSpacePressed=!1)};return window.addEventListener("keydown",e),window.addEventListener("keyup",t),()=>{window.removeEventListener("keydown",e),window.removeEventListener("keyup",t)}},[b,u.mode]),(0,r.useEffect)(()=>{let n=()=>{t.current&&e.current&&(e.current.width=t.current.clientWidth,e.current.height=t.current.clientHeight,m())};window.addEventListener("resize",n),n();let l=e=>{"Space"===e.code&&(x.current.isSpacePressed=!0)},r=e=>{"Space"===e.code&&(x.current.isSpacePressed=!1)};return window.addEventListener("keydown",l),window.addEventListener("keyup",r),()=>{window.removeEventListener("resize",n),window.removeEventListener("keydown",l),window.removeEventListener("keyup",r)}},[m]),(0,l.jsxs)("div",{className:"flex flex-col h-full w-full gap-4 relative",ref:t,children:[(0,l.jsxs)("div",{className:"flex flex-wrap items-center gap-2 p-2 bg-zinc-900/80 backdrop-blur border border-white/5 rounded-xl z-10 w-full lg:w-max lg:absolute lg:top-4 lg:left-1/2 lg:-translate-x-1/2 shadow-xl",children:[(0,l.jsx)("input",{type:"file",id:"fp-upload",className:"hidden",accept:"image/*",onChange:t=>{let l=t.target.files?.[0];if(!l)return;let r=new FileReader;r.onload=t=>{let l=new Image;l.onload=()=>{n.current=l,x.current.panOffset={x:(e.current?.width||0)/2,y:(e.current?.height||0)/2};let t=e.current;if(t){let e=t.width/l.naturalWidth,n=t.height/l.naturalHeight;x.current.zoomLevel=.9*Math.min(e,n)}p(e=>({...e,hasImage:!0,infoText:"圖片已載入。請設定比例尺 (Step 1)。"})),m()},l.src=t.target?.result},r.readAsDataURL(l)}}),(0,l.jsx)("label",{htmlFor:"fp-upload",className:"p-2 hover:bg-zinc-800 rounded-lg cursor-pointer text-zinc-400 hover:text-white transition-colors",title:"上傳圖片",children:(0,l.jsx)(i.A,{className:"h-5 w-5"})}),(0,l.jsx)("div",{className:"h-6 w-px bg-white/10 mx-1"}),(0,l.jsxs)("button",{onClick:()=>p(e=>({...e,mode:"setScale"})),className:(0,d.cn)("p-2 rounded-lg transition-colors flex items-center gap-2","setScale"===u.mode?"bg-cyan-600 text-white":"text-zinc-400 hover:bg-zinc-800"),disabled:!u.hasImage,title:"1. 設定比例尺",children:[(0,l.jsx)(a.A,{className:"h-5 w-5 rotate-45"}),(0,l.jsx)("span",{className:"text-xs font-bold hidden lg:block",children:"比例尺"})]}),(0,l.jsxs)("button",{onClick:()=>p(e=>({...e,mode:"measureLine"})),className:(0,d.cn)("p-2 rounded-lg transition-colors flex items-center gap-2","measureLine"===u.mode?"bg-cyan-600 text-white":"text-zinc-400 hover:bg-zinc-800"),disabled:!u.scaleSet,title:"2. 測量長度",children:[(0,l.jsx)(s.A,{className:"h-5 w-5"}),(0,l.jsx)("span",{className:"text-xs font-bold hidden lg:block",children:"測距"})]}),(0,l.jsxs)("button",{onClick:()=>p(e=>({...e,mode:"measureArea"})),className:(0,d.cn)("p-2 rounded-lg transition-colors flex items-center gap-2","measureArea"===u.mode?"bg-cyan-600 text-white":"text-zinc-400 hover:bg-zinc-800"),disabled:!u.scaleSet,title:"3. 測量面積",children:[(0,l.jsx)(o,{className:"h-5 w-5"}),(0,l.jsx)("span",{className:"text-xs font-bold hidden lg:block",children:"面積"})]}),(0,l.jsx)("div",{className:"h-6 w-px bg-white/10 mx-1"}),(0,l.jsxs)("button",{onClick:()=>p(e=>({...e,isOrtho:!e.isOrtho})),className:(0,d.cn)("p-2 rounded-lg transition-colors flex items-center gap-2",u.isOrtho?"bg-purple-600 text-white":"text-zinc-400 hover:bg-zinc-800"),title:"垂直/水平鎖定 (Shift)",children:[(0,l.jsx)(a.A,{className:"h-5 w-5"}),(0,l.jsx)("span",{className:"text-xs font-bold hidden lg:block",children:"正交"})]}),(0,l.jsx)("div",{className:"h-6 w-px bg-white/10 mx-1"}),(0,l.jsx)("button",{onClick:()=>{confirm("清除所有繪製？")&&(x.current.lines=[],x.current.areas=[],x.current.scale=null,p(e=>({...e,scaleSet:!1,infoText:"已清除，請重新設定比例尺"})),m())},className:"p-2 text-red-400 hover:bg-red-500/10 rounded-lg transition-colors",title:"全部清除",children:(0,l.jsx)(c.A,{className:"h-5 w-5"})})]}),(0,l.jsx)("div",{className:"absolute top-4 right-4 z-10 bg-black/60 backdrop-blur px-3 py-1.5 rounded-full border border-white/10 text-xs text-zinc-300",children:u.infoText}),(0,l.jsx)("canvas",{ref:e,className:(0,d.cn)("w-full h-full bg-zinc-950 cursor-crosshair touch-none",x.current.isPanning?"cursor-grab active:cursor-grabbing":""),onMouseDown:t=>{let n=x.current,l=e.current?.getBoundingClientRect();if(!l)return;let r=f({x:t.clientX-l.left,y:t.clientY-l.top});if(0===t.button){if(n.isSpacePressed){n.isPanning=!0,n.panStart={x:t.clientX,y:t.clientY};return}if(n.startPoint=n.snappedPoint?{...n.snappedPoint}:r,"measureArea"===u.mode)n.drawing=!0,n.areaPoints.push(n.startPoint),n.endPoint={...n.startPoint};else if("moveDrawing"===u.mode){let e=(e=>{let t=x.current,n=10/t.zoomLevel;for(let l of t.areas)for(let t of l.pixelPoints)if(h(e,t)<n)return l;for(let l of t.lines)if(h(e,l.pixelStart)<n||h(e,l.pixelEnd)<n)return l;return null})(r);e?(n.selectedObject=e,p(e=>({...e,selectedObject:!0}))):(n.selectedObject=null,p(e=>({...e,selectedObject:!1})))}else u.mode&&(n.drawing=!0,n.endPoint={...n.startPoint});m()}},onMouseMove:t=>{var n,l,r;let i,a,s,o,c=x.current,d=e.current?.getBoundingClientRect();if(!d)return;let p=t.clientX-d.left,g=t.clientY-d.top;if(c.isPanning){let e=t.clientX-c.panStart.x,n=t.clientY-c.panStart.y;c.panOffset.x+=e,c.panOffset.y+=n,c.panStart={x:t.clientX,y:t.clientY},m();return}let y=f({x:p,y:g});n=y,a=15/(i=x.current).zoomLevel,s=null,o=e=>{let t=h(n,e);t<a&&(a=t,s=e)},i.lines.forEach(e=>{o(e.pixelStart),o(e.pixelEnd)}),i.areas.forEach(e=>e.pixelPoints.forEach(e=>o(e))),i.areaPoints.forEach(e=>o(e)),i.snappedPoint=s;let b=c.snappedPoint?{...c.snappedPoint}:y;if(c.drawing&&(c.isShiftPressed||c.isOrthoMode)){let e=c.startPoint;"measureArea"===u.mode&&c.areaPoints.length>0&&(e=c.areaPoints[c.areaPoints.length-1]),l=e,b=Math.abs((r=b).x-l.x)>Math.abs(r.y-l.y)?{x:r.x,y:l.y}:{x:l.x,y:r.y}}c.endPoint=b,c.drawing,m()},onMouseUp:e=>{let t=x.current;if(t.isPanning){t.isPanning=!1;return}if(!t.drawing)return;if("measureArea"===u.mode){if(t.areaPoints.length>=2){let e=t.areaPoints[0],n=15/t.zoomLevel;if(h(t.endPoint,e)<n)return void b()}return}let n=h(t.startPoint,t.endPoint);if(!(n<1/t.zoomLevel)){if("setScale"===u.mode){let e=parseFloat(prompt("請輸入這段距離的實際長度(公分) e.g. 100","100")||"");e>0&&(t.scale=n/e,t.lines.push({type:"line",pixelStart:t.startPoint,pixelEnd:t.endPoint,color:"#06b6d4"}),p(e=>({...e,scaleSet:!0,mode:null,infoText:`比例尺已設定: ${(t.scale||0).toFixed(2)} px/cm`})))}else"measureLine"===u.mode&&t.scale&&t.lines.push({type:"line",pixelStart:t.startPoint,pixelEnd:t.endPoint,color:"#facc15"});t.drawing=!1,m()}},onContextMenu:e=>{e.preventDefault();let t=x.current;"measureArea"===u.mode?b():(t.areaPoints=[],t.drawing=!1,m())}}),(0,l.jsx)("div",{className:"absolute bottom-4 left-4 text-[10px] text-zinc-500 pointer-events-none bg-black/40 p-2 rounded-lg backdrop-blur-sm border border-white/5",children:(0,l.jsx)("p",{children:"左鍵: 繪圖 | 右鍵/Enter: 結束區域 | Shift: 正交模式 | 空白鍵: 平移"})})]})}},68459:(e,t,n)=>{n.d(t,{A:()=>l});let l=(0,n(78340).A)("trash-2",[["path",{d:"M10 11v6",key:"nco0om"}],["path",{d:"M14 11v6",key:"outv1u"}],["path",{d:"M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6",key:"miytrc"}],["path",{d:"M3 6h18",key:"d0wm0j"}],["path",{d:"M8 6V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2",key:"e791ji"}]])}}]);