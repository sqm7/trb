"use strict";(self.webpackChunk_N_E=self.webpackChunk_N_E||[]).push([[1886],{9505:(e,t,s)=>{s.d(t,{l:()=>o});var a=s(95155),r=s(12115),n=s(40980),i=s(68459),l=s(94514),c=s(61878);function o({projects:e,className:t,onChange:s,max:o=6,placeholder:d="搜尋並加入比較...",title:x="建案亮點標示"}){let[m,h]=(0,r.useState)(""),[p,u]=(0,r.useState)([]),[f,g]=(0,r.useState)(!1),b=(0,r.useRef)(null),j=(0,r.useRef)(null);(0,r.useEffect)(()=>{let e=e=>{b.current&&!b.current.contains(e.target)&&g(!1)};return document.addEventListener("mousedown",e),()=>document.removeEventListener("mousedown",e)},[]);let v=e.filter(e=>!p.includes(e.value)&&e.label.toLowerCase().includes(m.toLowerCase())).slice(0,10);return(0,a.jsxs)("div",{className:(0,n.cn)("space-y-2",t),ref:b,children:[(0,a.jsxs)("div",{className:"flex justify-between items-center bg-zinc-900/50 p-1 rounded-lg border border-white/5",children:[(0,a.jsxs)("h4",{className:"text-sm font-medium text-zinc-400 pl-2 border-l-2 border-yellow-500",children:[x," ",(0,a.jsxs)("span",{className:"text-xs font-normal text-zinc-600",children:["(最多 ",o," 個)"]})]}),p.length>0&&(0,a.jsxs)("button",{onClick:()=>{u([]),s([]),j.current?.focus()},className:"p-1.5 text-zinc-500 hover:text-rose-400 hover:bg-rose-500/10 rounded transition-colors flex items-center gap-1 text-xs",title:"清除所有選擇",children:[(0,a.jsx)(i.A,{size:14}),"清除"]})]}),(0,a.jsxs)("div",{className:"flex flex-wrap gap-2 min-h-[32px]",children:[0===p.length&&(0,a.jsx)("span",{className:"text-xs text-zinc-600 italic py-1",children:"尚未選擇建案..."}),p.map(e=>(0,a.jsxs)("div",{className:"flex items-center gap-1 bg-yellow-500/10 text-yellow-500 px-2 py-1 rounded text-xs border border-yellow-500/30",children:[(0,a.jsx)("span",{children:e}),(0,a.jsx)("button",{onClick:()=>{let t;u(t=p.filter(t=>t!==e)),s(t)},className:"hover:text-yellow-300",children:(0,a.jsx)(l.A,{size:12,className:"rotate-45"})})]},e))]}),(0,a.jsxs)("div",{className:"relative",children:[(0,a.jsx)(c.A,{className:"absolute left-3 top-1/2 -translate-y-1/2 w-4 h-4 text-zinc-500"}),(0,a.jsx)("input",{ref:j,type:"text",value:m,onChange:e=>{h(e.target.value),g(!0)},onFocus:()=>g(!0),placeholder:d,className:"w-full bg-zinc-900/50 border border-white/10 rounded-lg pl-9 pr-4 py-2 text-sm text-white placeholder:text-zinc-600 focus:outline-none focus:ring-1 focus:ring-cyan-500/50 transition-all",disabled:p.length>=o}),f&&(0,a.jsx)("div",{className:"absolute top-full left-0 right-0 mt-1 bg-zinc-900 border border-white/10 rounded-lg shadow-xl z-50 max-h-60 overflow-y-auto",children:v.length>0?v.map(e=>(0,a.jsx)("button",{onClick:()=>(e=>{if(p.length>=o)return;let t=[...p,e];u(t),s(t),h(""),j.current?.focus()})(e.value),className:"w-full text-left px-3 py-2 text-sm text-zinc-300 hover:bg-white/5 hover:text-white transition-colors",children:e.label},e.value)):(0,a.jsx)("div",{className:"px-3 py-2 text-sm text-zinc-600",children:"無相關建案"})})]})]})}},29991:(e,t,s)=>{s.d(t,{l:()=>l});var a=s(95155),r=s(12115),n=s(40980),i=s(66088);let l=r.forwardRef(({className:e,children:t,...s},r)=>(0,a.jsxs)("div",{className:"relative",children:[(0,a.jsx)("select",{className:(0,n.cn)("flex h-10 w-full appearance-none rounded-md border border-input bg-zinc-950/50 px-3 py-2 text-sm text-zinc-100 ring-offset-background focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2 disabled:cursor-not-allowed disabled:opacity-50 pr-8",e),ref:r,...s,children:t}),(0,a.jsx)(i.A,{className:"absolute right-3 top-2.5 h-4 w-4 opacity-50 pointer-events-none"})]}));l.displayName="Select"},30607:(e,t,s)=>{s.d(t,{b:()=>P});var a=s(95155),r=s(12115),n=s(34361),i=s(93398),l=s(89579),c=s(80642),o=s(39430),d=s(86901),x=s(94514),m=s(21628);function h({transactions:e,currentPremium:t,onApply:s,onManualChange:n}){let[i,h]=(0,r.useState)(null),[p,u]=(0,r.useState)(!1),[f,g]=(0,r.useState)(String(t)),b=(0,r.useRef)(null),[j,v]=(0,r.useState)(null),[N,y]=(0,r.useState)(360),w=Math.max(160,N-28),z=(0,r.useMemo)(()=>(function(e){if(!e||0===e.length)return[];let t=[],s={},a=new l.B$(e);e.forEach(e=>{let t=((e,t)=>{let s=e?.["戶型"];if("string"==typeof s&&s)return s;let a=t.resolve(e);if(a)return a;let r=e?.["戶別"]||e?.unit||e?.unitName;return"string"==typeof r&&r?r:""})(e,a),r=(e=>{if(!e)return 0;let t=String(e).match(/\d+/);return t?parseInt(t[0],10):0})(e["樓層"]||e.floor||""),n=parseFloat(e["房屋單價(萬)"]||e.unitPrice||0);t&&0!==r&&n>0&&(s[t]||(s[t]=[]),s[t].push({floor:r,price:n,original:e}))}),Object.entries(s).forEach(([e,s])=>{s.sort((e,t)=>e.floor-t.floor);for(let a=0;a<s.length;a++)for(let r=a+1;r<s.length;r++){let n=s[a],i=s[r],l=i.floor-n.floor;if(l>0&&l<=10){let s=Math.round(10*((i.price-n.price)/l))/10;s>=-2&&s<=2&&t.push({stack:e,floorLow:n.floor,floorHigh:i.floor,priceLow:n.price,priceHigh:i.price,diff:s,dateLow:n.original["交易年月日"]||n.original["交易日"]||n.original.transactionDate,dateHigh:i.original["交易年月日"]||i.original["交易日"]||i.original.transactionDate})}}});let r=new Map;t.forEach(e=>{let t=`${e.stack}-${e.floorLow}-${e.floorHigh}-${e.priceLow}-${e.priceHigh}`;r.has(t)||r.set(t,e)});let n=Array.from(r.values()),i={};n.forEach(e=>{i[e.diff]||(i[e.diff]={premium:e.diff,count:0,pairs:[]}),i[e.diff].count+=1,i[e.diff].pairs.push(e)});let c=Object.values(i);return c.sort((e,t)=>t.count!==e.count?t.count-e.count:e.premium-t.premium),c})(e),[e]),k=(0,r.useMemo)(()=>[...z.slice(0,5)].sort((e,t)=>e.premium-t.premium),[z]),S=(0,r.useMemo)(()=>[...z].sort((e,t)=>e.premium-t.premium),[z]),P=(0,r.useMemo)(()=>p?S:k,[p,S,k]),A=(0,r.useMemo)(()=>z.find(e=>1e-6>Math.abs(e.premium-t))||null,[z,t]),M=z.length>k.length;(0,r.useEffect)(()=>{h(null)},[A?.premium]),(0,r.useEffect)(()=>{g(String(t))},[t]),(0,r.useEffect)(()=>{if(!b.current)return;let e=()=>{if(!b.current)return;let e=Math.round(b.current.getBoundingClientRect().width);e>0&&v(e)};e();let t=new ResizeObserver(()=>e());return t.observe(b.current),window.addEventListener("resize",e),()=>{t.disconnect(),window.removeEventListener("resize",e)}},[]),(0,r.useEffect)(()=>{let e=()=>{y(Math.max(260,Math.min(520,Math.round(.55*window.innerHeight))))};return e(),window.addEventListener("resize",e),()=>window.removeEventListener("resize",e)},[]);let C=(0,r.useMemo)(()=>{let t=new Set,s=new Set,a=new l.B$(e);e.forEach(e=>{if(!e)return;let r=(e=>{let t=e?.["戶型"];if("string"==typeof t&&t)return t;let s=a.resolve(e);if(s)return s;let r=e?.["戶別"]||e?.unit||e?.unitName;return"string"==typeof r&&r?r:""})(e),n=(e=>{if(!e)return 0;let t=String(e).match(/\d+/);return t?parseInt(t[0],10):0})(e["樓層"]||e.floor);r&&t.add(r),0!==n&&s.add(n)});let r=Array.from(s).sort((e,t)=>t-e),n=e=>{let t=String(e||"").trim().toUpperCase(),s=t.match(/^([A-Z]+)(\d+)?$/);return s?{alpha:s[1]||"",num:s[2]?parseInt(s[2],10):Number.MAX_SAFE_INTEGER,raw:t}:{alpha:t,num:Number.MAX_SAFE_INTEGER,raw:t}},i=Array.from(t).sort((e,t)=>{let s=n(e),a=n(t),r=s.alpha.localeCompare(a.alpha,"en");return 0!==r?r:s.num!==a.num?s.num-a.num:s.raw.localeCompare(a.raw,"en")}),c=new Set;A&&A.pairs.forEach(e=>{c.add(`${e.stack}-${e.floorLow}`),c.add(`${e.stack}-${e.floorHigh}`)});let o=r.length||1,d=i.length||1,x=(j||0)-32-16,m=N-24-4,h=Math.min(40,Math.max(8,Math.min(x>0?Math.floor(x/d):24,m>0?Math.floor(m/o):24)));return{sortedFloors:r,sortedStacks:i,highlightedCells:c,cellSize:h,gridHeight:o*h+24}},[e,A,j,N]);if(0===z.length)return null;let _=null!==i&&A?A.pairs[i]:null;return(0,a.jsxs)("div",{className:"bg-zinc-900/50 border border-white/10 rounded-xl p-4 mb-6",children:[(0,a.jsxs)("div",{className:"flex items-center gap-2 mb-3",children:[(0,a.jsx)(d.A,{className:"w-4 h-4 text-yellow-400"}),(0,a.jsx)("h3",{className:"text-sm font-bold text-zinc-100",children:"AI 樓層價差分析建議"})]}),(0,a.jsxs)("div",{className:"flex flex-wrap gap-2 mb-4 items-center",children:[P.map(e=>{let r=1e-6>Math.abs(t-e.premium);return(0,a.jsxs)("button",{onClick:()=>{s(e.premium)},className:`
                                relative px-3 py-1.5 rounded-lg border text-xs font-mono transition-all
                                flex items-center gap-2
                                ${r?"bg-cyan-500/20 border-cyan-500 text-cyan-300":"bg-zinc-800 border-white/5 text-zinc-400 hover:border-white/20 hover:text-zinc-200"}
                            `,children:[(0,a.jsxs)("span",{className:"text-base font-bold",children:[e.premium>0?"+":"",e.premium]}),(0,a.jsx)("span",{className:"opacity-50",children:"萬/坪"}),(0,a.jsxs)("span",{className:"ml-1 bg-black/20 px-1.5 rounded text-[10px]",children:[e.count," 組"]}),r&&(0,a.jsx)(x.A,{className:"w-3 h-3 text-green-400"})]},e.premium)}),n&&(0,a.jsxs)("div",{className:"flex items-center gap-2 px-3 py-1.5 rounded-lg border border-white/10 bg-zinc-900/60 text-xs text-zinc-300",children:[(0,a.jsx)("span",{className:"text-[10px] text-zinc-500",children:"手動"}),(0,a.jsx)("input",{type:"text",inputMode:"decimal",value:f,onChange:e=>g(e.target.value),onBlur:()=>{let e=Number(f);Number.isNaN(e)||n(Math.max(0,e))},onKeyDown:e=>{if("Enter"===e.key){let t=Number(f);Number.isNaN(t)||(n(Math.max(0,t)),e.target.blur())}},className:"w-16 bg-transparent text-right pr-1 outline-none text-zinc-200"}),(0,a.jsx)("span",{className:"text-[10px] text-violet-300",children:"萬/坪"})]}),M&&(0,a.jsx)("button",{onClick:()=>u(e=>!e),className:"px-3 py-1.5 rounded-lg border border-white/10 bg-zinc-800 text-[10px] text-zinc-400 hover:text-zinc-200 hover:border-white/30 transition",children:p?"收合標籤":"顯示全部"})]}),(0,a.jsx)(c.N,{children:A&&(0,a.jsx)(o.P.div,{initial:{opacity:0,height:0},animate:{opacity:1,height:"auto"},exit:{opacity:0,height:0},className:"overflow-hidden",children:(0,a.jsxs)("div",{className:"border-t border-white/10 pt-4 mt-2",children:[(0,a.jsxs)("div",{className:"flex justify-between items-end mb-3",children:[(0,a.jsxs)("div",{className:"text-xs text-zinc-400",children:[(0,a.jsx)("span",{className:"text-cyan-400 font-bold",children:A.count})," 組對比符合此規律。 點擊右側明細可連動網格顯示。"]}),(0,a.jsx)("div",{className:"text-[10px] text-zinc-500",children:"點擊上方標籤即可套用"})]}),(0,a.jsxs)("div",{className:"flex flex-col xl:flex-row gap-4 items-stretch",children:[(0,a.jsx)("div",{ref:b,className:"flex-1 bg-black/40 rounded border border-white/5 p-2 overflow-hidden relative",style:{height:N},children:(0,a.jsxs)("div",{className:"w-full",children:[(0,a.jsxs)("div",{className:"flex",children:[(0,a.jsx)("div",{className:"shrink-0",style:{width:32}}),C.sortedStacks.map(e=>(0,a.jsx)("div",{className:"text-center text-[10px] text-zinc-500 pb-1",style:{width:C.cellSize},children:e},e))]}),C.sortedFloors.map(e=>(0,a.jsxs)("div",{className:"flex items-center relative z-10",style:{height:C.cellSize},children:[(0,a.jsxs)("div",{className:"shrink-0 text-right text-[10px] text-zinc-600 pr-2",style:{width:32},children:[e,"F"]}),C.sortedStacks.map(t=>{let s=`${t}-${e}`,r=C.highlightedCells.has(s),n=_&&_.stack===t&&(e===_.floorLow||e===_.floorHigh),i=A.pairs.some(s=>s.stack===t&&e>s.floorLow&&e<s.floorHigh),l=_&&_.stack===t&&e>_.floorLow&&e<_.floorHigh;return(0,a.jsxs)("div",{className:"h-full flex items-center justify-center p-0.5 relative",style:{width:C.cellSize},children:[i&&(0,a.jsx)("div",{className:`
                                                                    absolute w-0.5 h-[140%] top-[-20%] transition-colors duration-200
                                                                    ${l?"bg-yellow-400 z-20":"bg-cyan-500/20"}
                                                                `}),(0,a.jsx)("div",{className:`
                                                                    w-full h-full rounded-sm transition-all duration-200 relative z-10
                                                                    ${n?"bg-yellow-400 shadow-[0_0_12px_rgba(250,204,21,0.8)] scale-100 ring-2 ring-white/50 z-30":r?"bg-cyan-500 shadow-[0_0_8px_rgba(6,182,212,0.6)] scale-90":"bg-zinc-800/30"}
                                                                `})]},s)})]},e))]})}),(0,a.jsxs)("div",{className:"w-full xl:w-[380px] flex flex-col gap-2",style:{height:N},children:[(0,a.jsxs)("div",{className:"text-[10px] uppercase tracking-wider text-zinc-500 font-bold mb-1",children:["對比明細 (共 ",A.pairs.length," 組)"]}),(0,a.jsx)("div",{className:"flex flex-col gap-2 overflow-y-auto pr-2 custom-scrollbar",style:{maxHeight:w},children:A.pairs.map((e,t)=>(0,a.jsxs)("div",{onMouseEnter:()=>h(t),onMouseLeave:()=>h(null),className:`
                                                    border rounded-lg p-2 flex items-center justify-between group transition-all cursor-crosshair
                                                    ${i===t?"bg-yellow-400/10 border-yellow-400/50 translate-x-1":"bg-white/5 border-white/5 hover:border-white/20"}
                                                `,children:[(0,a.jsxs)("div",{className:"flex items-center gap-3",children:[(0,a.jsx)("div",{className:`
                                                        w-8 h-8 rounded flex items-center justify-center font-bold text-xs border transition-colors
                                                        ${i===t?"bg-yellow-400/20 text-yellow-400 border-yellow-400/30":"bg-cyan-500/10 text-cyan-400 border-cyan-500/20"}
                                                    `,children:e.stack}),(0,a.jsxs)("div",{className:"flex flex-col",children:[(0,a.jsxs)("div",{className:"flex items-center gap-1.5 leading-none",children:[(0,a.jsxs)("span",{className:"text-xs text-zinc-300",children:[e.floorLow,"F"]}),(0,a.jsx)(m.A,{className:`w-3 h-3 ${i===t?"text-yellow-400":"text-zinc-600"}`}),(0,a.jsxs)("span",{className:"text-xs text-zinc-100 font-bold",children:[e.floorHigh,"F"]})]}),(0,a.jsxs)("div",{className:"text-[10px] text-zinc-500 mt-1 flex gap-1 items-center",children:[(0,a.jsx)("span",{className:"opacity-70",children:e.dateLow||"N/A"}),(0,a.jsx)("span",{className:"opacity-30",children:"|"}),(0,a.jsx)("span",{className:"opacity-70",children:e.dateHigh||"N/A"})]})]})]}),(0,a.jsxs)("div",{className:"text-right",children:[(0,a.jsxs)("div",{className:"text-xs font-mono text-zinc-200",children:[e.priceLow,(0,a.jsx)("span",{className:"text-[10px] opacity-40 mx-1",children:"→"}),e.priceHigh]}),(0,a.jsxs)("div",{className:`text-[10px] font-bold ${i===t?"text-yellow-400":"text-cyan-400/80"}`,children:["+",e.diff," 萬/層"]})]})]},t))})]})]})]})})})]})}var p=s(13545);class u extends r.Component{static getDerivedStateFromError(e){return{hasError:!0,error:e,errorInfo:null}}componentDidCatch(e,t){console.error("Uncaught error:",e,t),this.setState({error:e,errorInfo:t})}render(){return this.state.hasError?(0,a.jsxs)("div",{className:"p-6 bg-red-950/20 border border-red-500/30 rounded-lg flex flex-col items-center justify-center text-center gap-4 min-h-[200px]",children:[(0,a.jsx)("div",{className:"bg-red-500/10 p-3 rounded-full",children:(0,a.jsx)(p.A,{className:"w-8 h-8 text-red-400"})}),(0,a.jsxs)("div",{children:[(0,a.jsx)("h2",{className:"text-lg font-bold text-red-200 mb-1",children:this.props.fallbackTitle||"Something went wrong"}),this.props.componentName&&(0,a.jsxs)("p",{className:"text-xs text-red-400/80 font-mono mb-2",children:["Component: ",this.props.componentName]}),(0,a.jsx)("div",{className:"max-w-md bg-black/50 p-3 rounded text-left overflow-auto max-h-[150px] border border-red-500/20",children:(0,a.jsx)("p",{className:"text-xs font-mono text-red-300 break-all",children:this.state.error?.toString()})}),(0,a.jsx)("button",{className:"mt-4 px-4 py-2 bg-red-900/40 hover:bg-red-900/60 text-red-200 text-xs rounded transition-colors",onClick:()=>this.setState({hasError:!1,error:null,errorInfo:null}),children:"Try to Recover"})]})]}):this.props.children}constructor(...e){super(...e),this.state={hasError:!1,error:null,errorInfo:null}}}var f=s(29991),g=s(60529),b=s(89239),j=s(37618),v=s(61878);let N=(e,t)=>{let s=e?.["戶型"];if("string"==typeof s&&s)return s;let a=t.resolve(e);if(a)return a;let r=e?.["戶別"]||e?.unit||e?.unitName;return"string"==typeof r&&r?r:"?"},y=e=>{let t=String(e?.["樓層"]||e?.floor||e?.layer||""),s="1"===t||"001"===t||t.includes("一樓"),a=e?.["建物型態"]||e?.buildingType||"",r=e?.["主要用途"]||e?.mainPurpose||"",n=e?.["備註"]||e?.note||"",i=a.includes("店")||e.buildingType?.includes("店")||"商業用"===r||"商業用"===e.mainPurpose||n.includes("店")||e.note?.includes("店"),l=a.includes("辦公")||e.buildingType?.includes("辦公")||a.includes("廠辦")||e.buildingType?.includes("廠辦")||a.includes("事務所")||e.buildingType?.includes("事務所")||r.includes("辦公")||e.mainPurpose?.includes("辦公")||r.includes("事務所")||e.mainPurpose?.includes("事務所")||n.includes("辦公")||n.includes("事務所")||e.note?.includes("辦公")||e.note?.includes("事務所");return{buildingType:a,mainPurpose:r,note:n,isStorefront:i&&s,isOffice:l||i&&!s}},w=e=>{let{note:t,isStorefront:s,isOffice:a}=y(e),r=t.includes("親友")||t.includes("員工")||t.includes("關係人")||t.includes("關係戶")||t.includes("員工關係");return{note:t,isStorefront:s,isOffice:a,isEmployeeRelated:r}};var z=s(88743),k=s(89733);function S({transactions:e,project:t}){let[s,n]=(0,r.useState)(""),[i,l]=(0,r.useState)(""),[c,o]=(0,r.useState)(null);return(0,a.jsxs)("div",{className:"flex flex-col sm:flex-row flex-wrap items-start sm:items-center gap-3 sm:gap-4 bg-zinc-900/30 p-4 rounded-lg border border-white/5",children:[(0,a.jsxs)("div",{className:"flex flex-col sm:flex-row items-start sm:items-center gap-2 w-full sm:w-auto",children:[(0,a.jsx)("span",{className:"text-sm text-zinc-400 font-semibold whitespace-nowrap",children:"區間均價試算:"}),(0,a.jsxs)("div",{className:"flex items-center gap-2",children:[(0,a.jsx)(g.p,{type:"number",placeholder:"起樓",className:"w-20 h-8 bg-zinc-950/50",value:s,onChange:e=>n(e.target.value)}),(0,a.jsx)("span",{className:"text-zinc-500",children:"~"}),(0,a.jsx)(g.p,{type:"number",placeholder:"迄樓",className:"w-20 h-8 bg-zinc-950/50",value:i,onChange:e=>l(e.target.value)})]}),(0,a.jsx)(b.$,{size:"sm",variant:"secondary",onClick:()=>{if(!t||!e)return;let a=parseInt(s),r=parseInt(i);if(isNaN(a)||isNaN(r)||a>r)return void o(null);let n=e.filter(e=>{if(e["建案名稱"]!==t)return!1;let s=parseInt(String(e["樓層"]));return!isNaN(s)&&s>=a&&s<=r});if(0===n.length)return void o({avg:0,count:0});let l=n.reduce((e,t)=>e+(t["房屋總價(萬)"]||0),0),c=n.reduce((e,t)=>e+(t["房屋面積(坪)"]||0),0);o({avg:c>0?l/c:0,count:n.length})},className:"h-8 ml-2",children:"計算"})]}),c&&(0,a.jsxs)("div",{className:"flex items-center gap-4 ml-4 animate-in fade-in",children:[(0,a.jsxs)("div",{className:"flex flex-col",children:[(0,a.jsx)("span",{className:"text-xs text-zinc-500",children:"平均單價 (加權)"}),(0,a.jsxs)("span",{className:"text-lg font-bold text-violet-400",children:[c.avg.toFixed(2)," 萬/坪"]})]}),(0,a.jsxs)("div",{className:"flex flex-col",children:[(0,a.jsx)("span",{className:"text-xs text-zinc-500",children:"參考筆數"}),(0,a.jsxs)("span",{className:"text-sm text-zinc-300",children:[c.count," 筆"]})]})]})]})}function P({data:e}){let[t,s]=(0,r.useState)(""),[c,o]=(0,r.useState)(!1),[d,x]=(0,r.useState)(.3),[m,p]=(0,r.useState)(14),[b,P]=(0,r.useState)(!1),[A,M]=(0,r.useState)(!1),C=(0,z.P)(e=>e.excludeCommercial),_=r.useRef(null),$=r.useRef(null),R=r.useRef(null);if((0,r.useEffect)(()=>{!c&&e?.priceGridAnalysis?.projectNames?.length&&!t&&s(e.priceGridAnalysis.projectNames[0])},[e,t,c]),!e?.priceGridAnalysis)return null;let{projectNames:F,byProject:E}=e.priceGridAnalysis,T=r.useMemo(()=>t&&e.transactionDetails?e.transactionDetails.filter(e=>e["建案名稱"]===t):null,[t,e.transactionDetails]),D=r.useMemo(()=>{if(!T||0===T.length)return{hasOffice:!1,hasResidential:!1,isMixed:!1};let e=T.reduce((e,t)=>{let{isStorefront:s,isOffice:a}=y(t);return a&&(e.hasOffice=!0),a||s||(e.hasResidential=!0),e},{hasOffice:!1,hasResidential:!1});return{...e,isMixed:e.hasOffice&&e.hasResidential}},[T]),L=r.useMemo(()=>!!T&&0!==T.length&&T.some(e=>{let t=e["備註"]||e.note||"";return t.includes("親友")||t.includes("員工")||t.includes("關係人")||t.includes("關係戶")||t.includes("員工關係")}),[T]);(0,r.useEffect)(()=>{t&&P(!D.isMixed&&D.hasOffice)},[t,D.isMixed,D.hasOffice]),(0,r.useEffect)(()=>{t&&M(!1)},[t]);let I=r.useMemo(()=>{if(!T)return null;let e=T;return C&&(e=e.filter(e=>{let{isStorefront:t,isOffice:s}=y(e);return!t&&!s})),e},[T,C]),O=!C&&b,B=r.useMemo(()=>{if(!t)return null;if(I&&I.length>0)try{return function(e,t=.3,s=14,a={}){let r=e.reduce((e,t)=>{let{isStorefront:s,isOffice:a}=y(t);return a&&(e.hasOffice=!0),a||s||(e.hasResidential=!0),e},{hasOffice:!1,hasResidential:!1}),n=!(r.hasOffice&&r.hasResidential)&&r.hasOffice,i="boolean"==typeof a.includeOfficePremium?a.includeOfficePremium:n,c="boolean"==typeof a.includeStorefrontPremium&&a.includeStorefrontPremium,o="boolean"==typeof a.includeEmployeePremium&&a.includeEmployeePremium,d=e=>{let{isStorefront:t,isOffice:s,isEmployeeRelated:a}=w(e);return(!!c||!t)&&(!!i||!s)&&(!!o||!a)},x={},m=new Set,h=new Set,p=new l.B$(e);if(e.forEach(e=>{let t=e["樓層"]||e.floor||e.layer;if(null==t)return;"number"==typeof t&&(t=String(t)),"number"==typeof t&&(t=String(t));let s=N(e,p);m.add(t),h.add(s),x[t]||(x[t]={}),x[t][s]||(x[t][s]=[]);let a=parseFloat(e["房屋單價(萬)"]||e.unitPrice||0),r=parseFloat(e["交易總價(萬)"]||e.totalPrice||0),n=parseFloat(e["房屋總價(萬)"]||e.housePrice||0),i=parseFloat(e["車位總價(萬)"]||e.parkingPrice||0),l=parseFloat(e["房屋面積(坪)"]||e.houseArea||0),c=e["房數"]||e.rooms,o=e["車位類別"]||e.parkingType||"";"string"==typeof o&&o.includes("車位");let{note:d,isStorefront:u,isOffice:f,isEmployeeRelated:g}=w(e),b=e["交易日"]||e["交易年月日"]||e.transactionDate||"",j=b;if(b&&/^\d{6,7}$/.test(String(b))){let e=String(b),t=6===e.length?2:3;j=`${e.substring(0,t)}/${e.substring(t,t+2)}/${e.substring(t+2)}`}x[t][s].push({...e,unitPrice:a,floor:t,unit:s,transactionDate:j,remark:d,isStorefront:u,isOffice:f,isEmployeeRelated:g,hasParking:i>0,tooltipInfo:{totalPrice:r,housePrice:n,parkingPrice:i,houseArea:l,rooms:c}})}),0===m.size)return{horizontalGrid:{},sortedFloors:[],sortedUnits:[],unitColorMap:{},summary:{totalBaselineHousePrice:0,totalPricePremiumValue:0,totalSoldArea:0,transactionCount:0,calculationFlags:{includesOfficePremium:i,includesStorefrontPremium:c,includesEmployeePremium:o}},horizontalComparison:[]};let u=Array.from(m).sort((e,t)=>{let s=e=>e?e.startsWith("B")?-parseInt(e.substring(1)):parseInt(e)||0:0;return s(t)-s(e)}),f=e=>{let t=String(e||"").trim().toUpperCase(),s=t.match(/^([A-Z]+)(\d+)?$/);return s?{alpha:s[1]||"",num:s[2]?parseInt(s[2],10):Number.MAX_SAFE_INTEGER,raw:t}:{alpha:t,num:Number.MAX_SAFE_INTEGER,raw:t}},g=Array.from(h).sort((e,t)=>{let s=f(e),a=f(t),r=s.alpha.localeCompare(a.alpha,"en");return 0!==r?r:s.num!==a.num?s.num-a.num:s.raw.localeCompare(a.raw,"en")}),b={},j=e=>{if(!e)return null;let t=e.replace(/\//g,"");if(t.length<6)return null;let s=6===t.length?2:3,a=parseInt(t.substring(0,s)),r=parseInt(t.substring(s,s+2));return new Date(1911+a,r-1,parseInt(t.substring(s+2)))},v={};e.forEach(e=>{let t=N(e,p),{note:s}=w(e),a=parseFloat(e["房屋單價(萬)"]||e.unitPrice||0);!(!d(e)||s.includes("特殊")||s.includes("毛胚"))&&a>0&&(v[t]||(v[t]=[]),v[t].push(e))}),Object.keys(v).forEach(e=>{let a=v[e];if(a.sort((e,t)=>(j(e["交易年月日"]||e.transactionDate)?.getTime()||0x9184e729fff)-(j(t["交易年月日"]||t.transactionDate)?.getTime()||0x9184e729fff)),0===a.length)return;let r=j(a[0]["交易年月日"]||a[0].transactionDate);if(!r){b[e]=a.reduce((e,t)=>parseFloat(t["房屋單價(萬)"])<parseFloat(e["房屋單價(萬)"])?t:e,a[0]);return}let n=new Date(r);n.setDate(n.getDate()+s);let i=a.filter(e=>{let t=j(e["交易年月日"]||e.transactionDate);return t&&t<=n}),l=i[0]||a[0],c=1/0;i.forEach(e=>{let s,a=parseFloat(e["房屋單價(萬)"]||0)-((s=String(e["樓層"]))?s.startsWith("B")?-parseInt(s.substring(1)):parseInt(s):0)*t;a<c&&(c=a,l=e)}),b[e]=l});let z=0,k=0,S=0,P=0;Object.keys(x).forEach(e=>{Object.keys(x[e]).forEach(s=>{x[e][s].forEach((a,r)=>{let n=null,i=b[s];if(i&&d(a)){let l=e=>e?e.startsWith("B")?-parseInt(e.substring(1)):parseInt(e):0,c=String(i["樓層"]),o=String(a.floor),d=l(c),m=l(o),h=parseFloat(i["房屋單價(萬)"]||i.unitPrice||0)+(m-d)*t;if(h>0&&(n=(a["房屋單價(萬)"]-h)/h*100,(a===i||.1>Math.abs(a["房屋單價(萬)"]-h))&&(n=0)),a.tooltipInfo.housePrice&&a.tooltipInfo.houseArea){let e=h*a.tooltipInfo.houseArea;z+=e,k+=a.tooltipInfo.housePrice-e,S+=a.tooltipInfo.houseArea,P++}x[e][s][r].theoreticalPrice=h}else n=null,x[e][s][r].theoreticalPrice=null;x[e][s][r].premium=n})})});let A={},M=["#f87171","#fb923c","#fbbf24","#a3e635","#34d399","#22d3ee","#818cf8","#c084fc","#f472b6"];g.forEach((e,t)=>{A[e]=M[t%M.length]});let C={};g.forEach(e=>{C[e]={totalOriginalPriceValue:0,totalActualPriceValue:0,totalSoldArea:0,count:0,anchorPrice:null,anchorFloor:null};let t=b[e];t&&(C[e].anchorPrice=parseFloat(t["房屋單價(萬)"]||0),C[e].anchorFloor=String(t["樓層"]))}),Object.keys(x).forEach(e=>{Object.keys(x[e]).forEach(s=>{x[e][s].forEach(e=>{let a=b[s];if(d(e)&&e.tooltipInfo.houseArea&&a){let r=e=>e?e.startsWith("B")?-parseInt(e.substring(1)):parseInt(e):0,n=r(String(a["樓層"])),i=r(e.floor),l=parseFloat(e["房屋單價(萬)"]||e.unitPrice||0),c=l-(i-n)*t,o=e.tooltipInfo.houseArea;Number.isFinite(c)&&Number.isFinite(l)&&o>0&&C[s]&&(C[s].totalOriginalPriceValue+=c*o,C[s].totalActualPriceValue+=l*o,C[s].totalSoldArea+=o,C[s].count++)}})})});let _=[],$=[],R=null,F=null,E=1/0,T=1/0;Object.keys(C).forEach(e=>{let t=C[e];if(t.totalSoldArea>0){let s=t.totalOriginalPriceValue/t.totalSoldArea,a=t.totalActualPriceValue/t.totalSoldArea;_.push(s),$.push(a),s<E&&(E=s,R=e),a<T&&(T=a,F=e)}});let D=_.length?Math.min(..._):0,L=$.length?Math.min(...$):0,I=Object.keys(C).map(e=>{let t=C[e];if(0===t.count||0===t.totalSoldArea)return null;let s=t.totalOriginalPriceValue/t.totalSoldArea,a=t.totalActualPriceValue/t.totalSoldArea,r=a-s,n=r*t.totalSoldArea;return{unitType:e,anchorInfo:t.anchorPrice?`${t.anchorFloor}F / ${t.anchorPrice}萬`:"N/A",originalHorizontalDiff:s-D,actualHorizontalDiff:a-L,unitsSold:t.count,totalSoldArea:t.totalSoldArea,originalAvgPrice:s,actualAvgPrice:a,avgPremiumPerPing:r,timePremiumContribution:n}}).filter(Boolean),O=I.reduce((e,t)=>e+(t.timePremiumContribution||0),0);return I.forEach(e=>{e.contributionPercentage=O>0?e.timePremiumContribution/O*100:0}),{horizontalGrid:x,sortedFloors:u,sortedUnits:g,unitColorMap:A,summary:{totalBaselineHousePrice:z,totalPricePremiumValue:k,totalSoldArea:S,transactionCount:P,calculationFlags:{includesOfficePremium:i,includesStorefrontPremium:c,includesEmployeePremium:o}},horizontalComparison:I,comparisonMeta:{originalMinUnit:R,originalMinAvg:Number.isFinite(E)?E:null,actualMinUnit:F,actualMinAvg:Number.isFinite(T)?T:null}}}(I,d,m,{includeOfficePremium:O,includeEmployeePremium:A})}catch(e){console.error("Heatmap generation error:",e)}return E[t]&&E[t].horizontalGrid?E[t]:null},[t,I,E,d,m,O,A]),H=r.useMemo(()=>{let e=B?.summary?.calculationFlags;if(!e)return"排除店舖/辦公室";let t=[];return e.includesStorefrontPremium||t.push("店舖"),e.includesOfficePremium||t.push("辦公室"),e.includesEmployeePremium||t.push("員工關係戶"),t.length?`排除${t.join("/")}`:"全部納入"},[B?.summary?.calculationFlags]);return(0,a.jsxs)("div",{className:"space-y-6 animate-in fade-in slide-in-from-bottom-4 duration-500",children:[(0,a.jsx)("div",{className:"flex flex-col gap-4 bg-zinc-900/30 p-4 rounded-lg border border-white/5",children:(0,a.jsx)("div",{className:"flex flex-col lg:flex-row flex-wrap items-start lg:items-center gap-4",children:(0,a.jsxs)("div",{className:"flex flex-col sm:flex-row items-start sm:items-center gap-2 w-full lg:w-auto",children:[(0,a.jsxs)("div",{className:"flex items-center gap-2",children:[(0,a.jsx)("span",{className:"text-sm text-zinc-400 whitespace-nowrap",children:"選擇建案:"}),(0,a.jsx)("button",{onClick:()=>o(!c),className:`p-1 rounded transition-colors ${c?"text-violet-400 bg-violet-400/10":"text-zinc-500 hover:text-zinc-300"}`,title:c?"切換回下拉選單":"切換手動輸入",children:(0,a.jsx)(j.A,{className:"w-3.5 h-3.5"})})]}),c?(0,a.jsxs)("div",{className:"relative w-full sm:w-[280px]",children:[(0,a.jsx)(g.p,{value:t,onChange:e=>s(e.target.value),placeholder:"輸入建案名稱...",className:"w-full h-9 bg-zinc-950/50 pl-8 pr-4",list:"project-list",autoComplete:"off"}),(0,a.jsx)(v.A,{className:"absolute left-2.5 top-1/2 -translate-y-1/2 w-4 h-4 text-zinc-500"}),(0,a.jsx)("datalist",{id:"project-list",children:F.map(e=>(0,a.jsx)("option",{value:e},e))})]}):(0,a.jsxs)(f.l,{value:t,onChange:e=>s(e.target.value),className:"w-full sm:w-[280px] bg-zinc-950/50",children:[(0,a.jsx)("option",{value:"",disabled:!0,children:"請選擇建案..."}),F.map(e=>(0,a.jsx)("option",{value:e,children:e},e))]})]})})}),t&&I&&I.length>0&&(0,a.jsx)(u,{componentName:"FloorDiffAnalyzer",children:(0,a.jsx)(h,{transactions:I,currentPremium:d,onApply:e=>x(e),onManualChange:e=>x(e)})}),t&&I&&I.length>0&&(0,a.jsx)(S,{transactions:I,project:t}),(0,a.jsxs)("div",{className:"flex flex-wrap gap-4 p-4 bg-zinc-900/20 rounded-lg border border-white/5",children:[(0,a.jsxs)("div",{className:"flex items-center gap-2",children:[(0,a.jsx)("span",{className:"text-xs text-zinc-500",children:"溢價圖例:"}),(0,a.jsxs)("span",{className:"flex items-center gap-1",children:[(0,a.jsx)("span",{className:"w-4 h-4 rounded bg-red-500/80"}),(0,a.jsx)("span",{className:"text-xs text-zinc-400",children:"> 5%"})]}),(0,a.jsxs)("span",{className:"flex items-center gap-1",children:[(0,a.jsx)("span",{className:"w-4 h-4 rounded bg-orange-500/80"}),(0,a.jsx)("span",{className:"text-xs text-zinc-400",children:"2-5%"})]}),(0,a.jsxs)("span",{className:"flex items-center gap-1",children:[(0,a.jsx)("span",{className:"w-4 h-4 rounded bg-yellow-500/80"}),(0,a.jsx)("span",{className:"text-xs text-zinc-400",children:"0-2%"})]}),(0,a.jsxs)("span",{className:"flex items-center gap-1",children:[(0,a.jsx)("span",{className:"w-4 h-4 rounded bg-green-500/80"}),(0,a.jsx)("span",{className:"text-xs text-zinc-400",children:"< 0%"})]})]}),(0,a.jsx)("div",{className:"ml-auto"})]}),(0,a.jsx)(n.c,{title:"建案銷控表與調價熱力圖",description:"可視化建案各戶別的銷售狀況與價格調整幅度",containerRef:_,headerAction:(0,a.jsxs)("div",{className:"flex flex-wrap items-center gap-2",children:[!C&&D.hasOffice&&(0,a.jsxs)("div",{className:"flex items-center gap-2",children:[(0,a.jsx)("span",{className:"text-xs text-zinc-400 whitespace-nowrap",children:"事務所/商辦調價"}),(0,a.jsx)("button",{onClick:()=>P(e=>!e),className:`px-2 h-8 rounded border text-[11px] transition ${b?"border-cyan-400 text-cyan-300 bg-cyan-500/10":"border-white/10 text-zinc-400 hover:text-zinc-200 hover:border-white/30"}`,title:b?"已納入事務所/商辦調價":"排除事務所/商辦調價",children:b?"納入":"排除"}),D.isMixed&&(0,a.jsx)("span",{className:"text-[11px] text-zinc-500 whitespace-nowrap",children:"混合用途預設排除"})]}),L&&(0,a.jsxs)("div",{className:"flex items-center gap-2",children:[(0,a.jsx)("span",{className:"text-xs text-zinc-400 whitespace-nowrap",children:"員工關係戶調價"}),(0,a.jsx)("button",{onClick:()=>M(e=>!e),className:`px-2 h-8 rounded border text-[11px] transition ${A?"border-cyan-400 text-cyan-300 bg-cyan-500/10":"border-white/10 text-zinc-400 hover:text-zinc-200 hover:border-white/30"}`,title:A?"已納入員工關係戶調價":"排除員工關係戶調價",children:A?"納入":"排除"})]}),(0,a.jsxs)("div",{className:"flex items-center gap-2 bg-zinc-950/40 border border-white/10 rounded-lg px-2 py-1",children:[(0,a.jsx)("span",{className:"text-xs text-zinc-400",children:"基準天數"}),(0,a.jsx)(g.p,{type:"number",min:"1",max:"365",value:m,onChange:e=>p(Number(e.target.value)||14),className:"w-16 h-8 bg-zinc-950/50 text-right pr-2"}),(0,a.jsx)("span",{className:"text-xs font-mono text-violet-400 whitespace-nowrap",children:"天"})]}),(0,a.jsx)(k.N,{data:I||[],filename:`heatmap_grid_${t}`,label:"匯出",chartType:"heatmap-grid",targetRef:_,snapshotData:{projectData:B,floorPremium:d,selectedProject:t}})]}),children:B?(0,a.jsx)(u,{componentName:"PricingHeatmap (Grid)",children:(0,a.jsx)(i.t,{data:B,floorPremium:d,showGrid:!0,showSummary:!1,showComparison:!1})}):(0,a.jsx)("div",{className:"text-zinc-500 text-center p-12",children:"請選擇建案以查看銷控表"})}),B?.summary&&(0,a.jsx)(n.c,{title:`調價幅度統計摘要 (${H})`,containerRef:$,headerAction:(0,a.jsx)(k.N,{data:[B.summary],filename:`heatmap_stats_${t}`,label:"匯出",chartType:"heatmap-stats",targetRef:$,snapshotData:{summary:B.summary,selectedProject:t}}),children:(0,a.jsx)(u,{componentName:"PricingHeatmap (Summary)",children:(0,a.jsx)(i.t,{data:B,showGrid:!1,showSummary:!0,showComparison:!1})})}),B?.horizontalComparison&&B.horizontalComparison.length>0&&(0,a.jsx)(n.c,{title:"戶型水平價差與溢價貢獻",containerRef:R,headerAction:(0,a.jsx)(k.N,{data:B.horizontalComparison,filename:`heatmap_comparison_${t}`,label:"匯出",chartType:"heatmap-comparison",targetRef:R,snapshotData:{horizontalComparison:B.horizontalComparison,selectedProject:t}}),children:(0,a.jsx)(u,{componentName:"PricingHeatmap (Comparison)",children:(0,a.jsx)(i.t,{data:B,showGrid:!1,showSummary:!1,showComparison:!0,configProject:t,rawTransactions:I||void 0})})})]})}},31840:(e,t,s)=>{s.d(t,{p:()=>w});var a=s(95155),r=s(12115),n=s(34361),i=s(65770),l=s(9921),c=s(66088),o=s(6296),d=s(61878),x=s(33210),m=s(18837),h=s(41641),p=s(21362),u=s(40980),f=s(88743),g=s(27529),b=s(55873),j=s(98883),v=s(51806),N=s(89733),y=s(70872);function w({data:e,trigger:t}){let{counties:s,districts:w,transactionType:z,buildingType:k,projectNames:S,dateRange:P,startDate:A,endDate:M}=(0,f.P)(),[C,_]=(0,r.useState)([]),[$,R]=(0,r.useState)(!1),[F,E]=(0,r.useState)(null),[T,D]=(0,r.useState)(1),[L,I]=(0,r.useState)(new Set),[O,B]=(0,r.useState)({key:"",direction:null}),[H,q]=(0,r.useState)(""),[W,Z]=(0,r.useState)("建案名稱"),[G,Y]=(0,r.useState)(!1),[U,K]=(0,r.useState)([]),[V,X]=(0,r.useState)(!1),[Q,J]=(0,r.useState)([]),[ee,et]=(0,r.useState)(""),es=r.useRef(null),ea=(0,r.useRef)({counties:s,districts:w,transactionType:z,buildingType:k,projectNames:S,dateRange:P,startDate:A,endDate:M});(0,r.useEffect)(()=>{ea.current={counties:s,districts:w,transactionType:z,buildingType:k,projectNames:S,dateRange:P,startDate:A,endDate:M}});let er=(0,r.useCallback)(async()=>{let{counties:e,districts:t,transactionType:s,buildingType:a,projectNames:r,dateRange:n,startDate:i,endDate:l}=ea.current;R(!0),E(null),_([]);try{if(0===e.length)return void R(!1);let c=i,o=l;if("custom"!==n){let e=(0,j.P)(n);e.startDate&&(c=e.startDate),e.endDate&&(o=e.endDate)}let d=e.map(async e=>{let n=b.WG[e],i=b.Ib[e]||[],l=t?t.filter(e=>i.includes(e)):[],d={countyCode:n,districts:l.length>0?l:void 0,type:s,dateStart:c,dateEnd:o,projectNames:r,buildingType:a};try{return await g.FH.fetchData(d,{page:1,limit:1e3})}catch(t){return console.warn(`Fetch failed for ${e}`,t),{data:[],count:0}}}),x=await Promise.all(d),m=[];x.forEach(e=>{e&&Array.isArray(e.data)&&(m=[...m,...e.data])}),m.sort((e,t)=>{let s=e["交易日"]||"";return(t["交易日"]||"").localeCompare(s)}),_(m)}catch(e){console.error("Data List fetch failed:",e),E(e.message||"讀取交易資料失敗")}finally{R(!1)}},[]),en=JSON.stringify({counties:s,districts:w,transactionType:z,buildingType:k,projectNames:S,dateRange:P,startDate:A,endDate:M});(0,r.useEffect)(()=>{er()},[en]),(0,r.useEffect)(()=>{t&&er()},[er,t]);let ei=async e=>{X(!0),K([]),J([]);let s=e["建案名稱"]||"未命名建案";et(`車位/附表明細 - ${s}`),Y(!0);let a=[],r=e=>{console.log(e),a.push(e)};try{let n=e.編號,i=ea.current?.transactionType||z;if(r(`TID: ${n}`),r(`Type: ${i}`),r(`Project: ${s}`),!n){r("Error: No Transaction ID"),J(a),X(!1);return}let l=[],c=e.縣市代碼;if(!c){let e=ea.current?.counties||[];1===e.length&&(c=b.WG[e[0]])}if(!c&&e.地址)for(let[t,s]of Object.entries(b.WG)){if(e.地址.startsWith(t)){c=s;break}let a=t.replace("台","臺");if(e.地址.replace("台","臺").startsWith(a)){c=s;break}}if(r(`CountyCode: ${c} (Inferred: ${!e.縣市代碼})`),c){let t=e["交易類型"]||i;r(`Calling API with: ${n}, ${t}, ${c}`);try{let a=await g.FH.fetchSubData(n,t,c);a.park&&Array.isArray(a.park)&&a.park.length>0?(r(`API Success: Found ${a.park.length} park records`),l=a.park.map(t=>({車位類別:t["車位類別"]||"-","車位價格(萬)":t["車位價格(萬)"]||(t["車位價格"]?(Number(t["車位價格"])/1e4).toFixed(2):"-"),"車位面積(坪)":t["車位面積(坪)"]||(t["車位面積"]?(Number(t["車位面積"])/3.30579).toFixed(2):"-"),車位樓層:t["車位樓層"]||t["車位所在樓層"]||"-",建案名稱:t["建案名稱"]||s,交易日:t["交易日"]||e["交易日"],備註:t["備註"]||"",_category:"車位資料(來自API)"}))):r("API Result: No park data found"),a.build&&Array.isArray(a.build)&&a.build.length>0?(r(`API Success: Found ${a.build.length} build records`),l=[...l,...a.build.map(e=>({...e,_category:"建物明細"}))]):r("API Result: No build data found"),a.land&&Array.isArray(a.land)&&a.land.length>0?(r(`API Success: Found ${a.land.length} land records`),l=[...l,...a.land.map(e=>({...e,"土地移轉總面積(坪)":e["土地移轉總面積(平方公尺)"]?(.3025*Number(e["土地移轉總面積(平方公尺)"])).toFixed(2):"-",土地位置:e["土地區段位置"]||e["土地位置"]||"-",_category:"土地明細"}))]):r("API Result: No land data found")}catch(e){console.warn("API fetchSubData failed, proceeding to fallback:",e),r(`API Error: ${String(e)} - Proceeding to fallback`)}}else r("Skip API: No County Code");if(0===l.length&&t?.parkingAnalysis?.rampPlanePriceByFloor){r("Check AnalysisData RawRecords...");let a=t.parkingAnalysis.rampPlanePriceByFloor,i=[],c=e=>String(e||"").replace(/[^a-zA-Z0-9]/g,"").toUpperCase(),o=c(n);for(let e of(r(`Normalized Target ID: ${o}`),a))if(e.rawRecords&&Array.isArray(e.rawRecords)){let t=e.rawRecords.filter(e=>{let t=c(e.transactionId),s=c(e["編號"]);return t===o||s===o});t.length>0&&i.push(...t.map(t=>({...t,floorFromBucket:e.floor})))}if(i.length>0)for(let t of(r(`AnalysisData: Found ${i.length} matches`),r(`Match Data: ${JSON.stringify(i[0]).substring(0,100)}...`),i))l.push({車位類別:t["車位類別"]||"坡道平面","車位價格(萬)":t.parkingPrice||t["車位價格(萬)"]||"-","車位面積(坪)":t.parkingArea||t["車位面積(坪)"]||"-",車位樓層:t["車位所在樓層"]||t.floorFromBucket||"-",建案名稱:t["建案名稱"]||s,交易日:t["交易日"]||e["交易日"],備註:t["備註"]||"",_category:"車位資料(來自分析數據)"});else r("AnalysisData: No matches found")}if(0===l.length){r("Fallback: Using Main Record");let t=e["車位數"]&&Number(e["車位數"])>0,a=e["車位總價"]||e["車位總價(萬)"];if(t||a){let t=e["車位總價(萬)"]?Number(e["車位總價(萬)"]):e["車位總價"]?(Number(e["車位總價"])/1e4).toFixed(2):"-",a=e["車位面積(坪)"]?Number(e["車位面積(坪)"]):e["車位面積"]?(Number(e["車位面積"])/3.30579).toFixed(2):"-";l.push({車位類別:e["車位類別"]||"無資料","車位價格(萬)":t,"車位面積(坪)":a,車位樓層:"-",建案名稱:s,交易日:e["交易日"],備註:e["備註"]||"",_category:"車位資料(來自交易明細)"})}else r("Fallback: No parking info in main record")}K(l),J(a)}catch(t){if(console.error("handleFetchSubTable error:",t),a.push(`Error: ${String(t)}`),J(a),e["車位數"]&&Number(e["車位數"])>0){let t=e["車位總價(萬)"]?Number(e["車位總價(萬)"]):e["車位總價"]?(Number(e["車位總價"])/1e4).toFixed(2):0,s=e["車位面積(坪)"]?Number(e["車位面積(坪)"]):e["車位面積"]?(Number(e["車位面積"])/3.30579).toFixed(2):0;K([{車位類別:e["車位類別"]||"無資料","車位價格(萬)":t,"車位面積(坪)":s,車位樓層:"-",_category:"車位資料(來自交易明細)"}])}else K([])}finally{X(!1)}},el=[{key:"行政區",label:"行政區",sortable:!0},{key:"建案名稱",label:"建案名稱",sortable:!0},{key:"交易日",label:"交易日",sortable:!0},{key:"交易筆棟數",label:"交易筆棟數",sortable:!1},{key:"主要用途",label:"主要用途",sortable:!1},{key:"建物型態",label:"建物型態",sortable:!1},{key:"戶型",label:"戶型",sortable:!0},{key:"樓層",label:"樓層",sortable:!0},{key:"房屋面積(坪)",label:"坪數",sortable:!0},{key:"房屋單價(萬)",label:"單價",sortable:!0}],ec=["編號","地址","總樓層","交易總價(萬)","房屋總價(萬)","車位總價(萬)","房數","廳數","衛浴數","備註","解約情形","戶別","主要用途","建物型態","車位類別","車位價格","車位面積","主建物面積","附屬建物面積","陽台面積","土地使用分區","地號","社區戶數"],eo=e=>{I(t=>{let s=new Set(t);return s.has(e)?s.delete(e):s.add(e),s})},ed=e=>null==e||""===e?"-":"number"==typeof e?Number.isInteger(e)?e.toLocaleString():e.toFixed(2):String(e),ex=(0,r.useMemo)(()=>{let e=[...C];if(H.trim()){let t=H.toLowerCase();e=e.filter(e=>{let s=e[W];return null!=s&&String(s).toLowerCase().includes(t)})}return O.key&&O.direction&&e.sort((e,t)=>{let s=e[O.key],a=t[O.key];if(null==s&&null==a)return 0;if(null==s)return 1;if(null==a)return -1;if("number"==typeof s&&"number"==typeof a)return"asc"===O.direction?s-a:a-s;let r=String(s),n=String(a);return"asc"===O.direction?r.localeCompare(n,"zh-TW"):n.localeCompare(r,"zh-TW")}),e},[C,H,W,O]),em=Math.ceil(ex.length/20),eh=(T-1)*20,ep=eh+20,eu=ex.slice(eh,ep);return $?(0,a.jsxs)("div",{className:"flex flex-col items-center justify-center py-20",children:[(0,a.jsx)(o.A,{className:"h-8 w-8 animate-spin text-violet-500 mb-2"}),(0,a.jsx)("p",{className:"text-zinc-500 text-sm",children:"正在載入交易資料相關明細..."})]}):F?(0,a.jsxs)("div",{className:"text-center p-12 text-red-400",children:[(0,a.jsxs)("p",{children:["載入失敗: ",F]}),(0,a.jsx)("button",{onClick:()=>er(),className:"mt-4 px-4 py-2 bg-zinc-800 rounded hover:bg-zinc-700",children:"重試"})]}):C&&0!==C.length?(0,a.jsxs)("div",{className:"space-y-4 animate-in fade-in slide-in-from-bottom-4 duration-500",children:[(0,a.jsxs)("div",{className:"flex flex-wrap gap-3 items-center p-3 bg-zinc-900/50 rounded-lg border border-white/5",children:[(0,a.jsxs)("div",{className:"flex items-center gap-2 flex-1 min-w-[200px]",children:[(0,a.jsx)(d.A,{size:16,className:"text-zinc-500"}),(0,a.jsx)("input",{type:"text",value:H,onChange:e=>{q(e.target.value),D(1)},placeholder:`搜尋 ${W}...`,className:"flex-1 bg-transparent border-none outline-none text-white placeholder-zinc-500 text-sm"}),H&&(0,a.jsx)("button",{onClick:()=>q(""),className:"text-zinc-500 hover:text-white",children:(0,a.jsx)(x.A,{size:14})})]}),(0,a.jsxs)("select",{value:W,onChange:e=>Z(e.target.value),className:"bg-zinc-800 border border-zinc-700 rounded px-2 py-1 text-sm text-zinc-300",children:[(0,a.jsx)("option",{value:"建案名稱",children:"建案名稱"}),(0,a.jsx)("option",{value:"行政區",children:"行政區"}),(0,a.jsx)("option",{value:"戶型",children:"戶型"}),(0,a.jsx)("option",{value:"主要用途",children:"主要用途"})]})]}),(0,a.jsxs)("div",{className:"flex justify-between items-center text-sm text-zinc-400",children:[(0,a.jsxs)("span",{children:["共 ",(0,a.jsx)("span",{className:"text-white font-semibold",children:ex.length.toLocaleString()})," 筆資料 ",H&&(0,a.jsx)("span",{className:"text-zinc-500",children:"(已篩選)"})]}),(0,a.jsxs)("span",{children:["第 ",T," / ",em||1," 頁"]})]}),(0,a.jsxs)(n.c,{title:"交易資料明細",description:"點擊表頭可排序，點擊「明細」可展開詳細資訊",containerRef:es,headerAction:(0,a.jsx)(N.N,{data:ex,filename:"transaction_list_data",label:"匯出",chartType:"data-list",targetRef:es}),children:[(0,a.jsx)("div",{className:"hidden md:block overflow-x-auto",children:(0,a.jsxs)("table",{className:"w-full text-sm text-left",children:[(0,a.jsx)("thead",{className:"bg-zinc-900/80 text-zinc-400 uppercase text-xs font-semibold sticky top-0",children:(0,a.jsxs)("tr",{children:[(0,a.jsx)("th",{className:"px-3 py-3 w-20 text-center",children:"操作"}),el.map(e=>{var t;return(0,a.jsx)("th",{className:(0,u.cn)("px-3 py-3 text-left whitespace-nowrap",e.sortable&&"cursor-pointer select-none group hover:text-white transition-colors","建案名稱"===e.key&&"min-w-[120px] max-w-[200px] whitespace-normal","行政區"===e.key&&"w-20","交易日"===e.key&&"w-24",("房屋單價(萬)"===e.key||"房屋面積(坪)"===e.key)&&"text-right"),onClick:()=>{var t;return e.sortable&&(t=e.key,void(B(e=>{if(e.key===t){if("asc"===e.direction)return{key:t,direction:"desc"};if("desc"===e.direction)return{key:"",direction:null}}return{key:t,direction:"asc"}}),D(1)))},children:(0,a.jsxs)("div",{className:(0,u.cn)("flex items-center gap-1",("房屋單價(萬)"===e.key||"房屋面積(坪)"===e.key)&&"justify-end"),children:[e.label,e.sortable&&(t=e.key,O.key!==t?(0,a.jsx)(i.A,{size:12,className:"opacity-30 group-hover:opacity-70"}):"asc"===O.direction?(0,a.jsx)(l.A,{size:12,className:"text-violet-400"}):(0,a.jsx)(c.A,{size:12,className:"text-violet-400"}))]})},e.key)})]})}),(0,a.jsx)("tbody",{className:"divide-y divide-white/5",children:eu.map((e,t)=>{let s=eh+t,n=L.has(s);return(0,a.jsxs)(r.Fragment,{children:[(0,a.jsxs)("tr",{className:(0,u.cn)("hover:bg-zinc-800/50 transition-colors",n&&"bg-zinc-800/30"),children:[(0,a.jsx)("td",{className:"px-3 py-2",children:(0,a.jsxs)("div",{className:"flex items-center gap-2 justify-center",children:[(0,a.jsxs)("button",{onClick:()=>ei(e),className:"px-2 py-1 rounded text-xs font-medium bg-cyan-900/30 text-cyan-400 hover:bg-cyan-900/50 hover:text-cyan-300 transition-colors flex items-center gap-1 border border-cyan-800/50 active:scale-95",title:"查看車位或其他附表資料",children:[(0,a.jsx)(m.A,{size:12}),"附表"]}),(0,a.jsxs)("button",{onClick:()=>eo(s),className:(0,u.cn)("flex items-center gap-1 px-2 py-1 rounded text-xs font-medium transition-colors border active:scale-95",n?"bg-violet-500/20 text-violet-300 border-violet-500/30":"bg-zinc-800 text-zinc-400 border-zinc-700 hover:bg-zinc-700 hover:text-zinc-200"),children:[n?(0,a.jsx)(l.A,{size:12}):(0,a.jsx)(c.A,{size:12}),"明細"]})]})}),el.map(t=>(0,a.jsx)("td",{className:(0,u.cn)("px-3 py-2","建案名稱"===t.key?"whitespace-normal min-w-[120px] max-w-[200px]":"whitespace-nowrap",("房屋單價(萬)"===t.key||"房屋面積(坪)"===t.key)&&"text-right"),children:"戶型"===t.key?(0,a.jsx)(y.Bc,{delayDuration:100,children:(0,a.jsxs)(y.m_,{children:[(0,a.jsx)(y.k$,{asChild:!0,children:(0,a.jsx)("span",{className:"cursor-help border-b border-dotted border-zinc-600 block truncate max-w-[80px]",children:ed(e[t.key])})}),(0,a.jsx)(y.ZI,{side:"top",className:"max-w-[200px]",children:(0,a.jsxs)("p",{className:"text-xs",children:["原始戶別: ",(0,a.jsx)("strong",{children:e["戶別"]||"無資料"})]})})]})}):"主要用途"===t.key?(0,a.jsx)("span",{className:"text-zinc-300",children:"見其他登記事項"===e["主要用途"]?"其他":ed(e[t.key])}):(0,a.jsx)("span",{className:(0,u.cn)("房屋單價(萬)"===t.key&&"font-mono text-violet-400 font-bold","建案名稱"===t.key&&"font-medium text-white text-sm leading-tight block","建案名稱"!==t.key&&"房屋單價(萬)"!==t.key&&"text-zinc-300"),children:ed(e[t.key])})},t.key))]}),n&&(0,a.jsx)("tr",{className:"bg-zinc-900/50",children:(0,a.jsx)("td",{colSpan:el.length+1,className:"px-4 py-4",children:(0,a.jsx)("div",{className:"grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 lg:grid-cols-6 gap-3",children:ec.map(t=>t in e?(0,a.jsxs)("div",{className:"bg-zinc-800/50 rounded p-2",children:[(0,a.jsx)("div",{className:"text-xs text-zinc-500 mb-1",children:t}),(0,a.jsx)("div",{className:"text-sm text-zinc-200 font-mono",children:ed(e[t])})]},t):null)})})})]},s)})})]})}),(0,a.jsxs)("div",{className:"md:hidden space-y-4",children:[eu.map((e,t)=>{let s=eh+t,r=L.has(s);return(0,a.jsxs)("div",{className:(0,u.cn)("bg-zinc-900/40 border border-white/5 rounded-xl overflow-hidden transition-all duration-200",r?"ring-1 ring-violet-500/30 bg-zinc-900/60":"hover:bg-zinc-900/60"),children:[(0,a.jsxs)("div",{className:"p-4",onClick:()=>eo(s),children:[(0,a.jsxs)("div",{className:"flex justify-between items-start mb-3",children:[(0,a.jsxs)("div",{children:[(0,a.jsxs)("div",{className:"flex items-center gap-2 mb-1",children:[(0,a.jsx)("span",{className:"text-xs font-medium px-1.5 py-0.5 rounded bg-zinc-800 text-zinc-400",children:e["行政區"]}),(0,a.jsx)("h3",{className:"text-base font-bold text-white leading-tight",children:e["建案名稱"]})]}),(0,a.jsxs)("div",{className:"text-xs text-zinc-500 font-mono",children:[e["交易日"]," • ",e["戶型"]||"-"]})]}),(0,a.jsxs)("div",{className:"text-right",children:[(0,a.jsxs)("div",{className:"text-lg font-bold text-violet-400 font-mono leading-none",children:[ed(e["房屋單價(萬)"]),(0,a.jsx)("span",{className:"text-xs text-zinc-500 font-normal ml-0.5",children:"萬/坪"})]}),(0,a.jsxs)("div",{className:"text-xs text-zinc-500 mt-1",children:[ed(e["交易總價(萬)"])," 萬"]})]})]}),(0,a.jsxs)("div",{className:"grid grid-cols-3 gap-2 py-3 border-t border-white/5",children:[(0,a.jsxs)("div",{className:"text-center",children:[(0,a.jsx)("div",{className:"text-[10px] text-zinc-500 mb-0.5",children:"樓層"}),(0,a.jsxs)("div",{className:"text-sm font-medium text-zinc-300",children:[ed(e["樓層"]),"F"]})]}),(0,a.jsxs)("div",{className:"text-center border-l border-white/5",children:[(0,a.jsx)("div",{className:"text-[10px] text-zinc-500 mb-0.5",children:"坪數"}),(0,a.jsx)("div",{className:"text-sm font-medium text-zinc-300",children:ed(e["房屋面積(坪)"])})]}),(0,a.jsxs)("div",{className:"text-center border-l border-white/5",children:[(0,a.jsx)("div",{className:"text-[10px] text-zinc-500 mb-0.5",children:"車位"}),(0,a.jsx)("div",{className:"text-sm font-medium text-zinc-300",children:ed(e["車位總價(萬)"])})]})]}),(0,a.jsxs)("div",{className:"flex gap-2 mt-2",children:[(0,a.jsxs)("button",{onClick:t=>{t.stopPropagation(),ei(e)},className:"flex-1 py-2 rounded-lg text-xs font-medium bg-cyan-900/20 text-cyan-400 border border-cyan-800/30 flex items-center justify-center gap-1.5 active:scale-[0.98] transition-all",children:[(0,a.jsx)(m.A,{size:14}),"查看附表"]}),(0,a.jsxs)("button",{onClick:e=>{e.stopPropagation(),eo(s)},className:(0,u.cn)("flex-1 py-2 rounded-lg text-xs font-medium border flex items-center justify-center gap-1.5 active:scale-[0.98] transition-all",r?"bg-violet-500/10 text-violet-300 border-violet-500/30":"bg-zinc-800/50 text-zinc-300 border-zinc-700"),children:[r?"收合明細":"顯示明細",r?(0,a.jsx)(l.A,{size:14}):(0,a.jsx)(c.A,{size:14})]})]})]}),r&&(0,a.jsx)("div",{className:"bg-zinc-950/50 border-t border-white/5 p-4 animate-accordion-down",children:(0,a.jsx)("div",{className:"grid grid-cols-2 gap-x-4 gap-y-3",children:ec.map(t=>t in e?(0,a.jsxs)("div",{className:"overflow-hidden",children:[(0,a.jsx)("div",{className:"text-[10px] text-zinc-500 truncate",children:t}),(0,a.jsx)("div",{className:"text-sm text-zinc-300 font-mono truncate",children:ed(e[t])})]},t):null)})})]},s)}),0===eu.length&&(0,a.jsx)("div",{className:"text-center py-12 text-zinc-500 bg-zinc-900/20 rounded-xl border border-dashed border-zinc-800",children:"無符合條件的資料"})]})]}),(0,a.jsxs)("div",{className:"flex justify-between items-center pt-4 border-t border-white/5",children:[(0,a.jsxs)("div",{className:"text-sm text-zinc-500",children:["顯示第 ",ex.length>0?eh+1:0," - ",Math.min(ep,ex.length)," 筆"]}),(0,a.jsxs)("div",{className:"flex items-center gap-2",children:[(0,a.jsx)("button",{onClick:()=>D(e=>Math.max(1,e-1)),disabled:1===T,className:"p-2 rounded bg-zinc-800 text-zinc-300 hover:bg-zinc-700 disabled:opacity-50 disabled:cursor-not-allowed transition-colors",children:(0,a.jsx)(h.A,{size:16})}),(0,a.jsx)("div",{className:"flex gap-1",children:Array.from({length:Math.min(5,em||1)},(e,t)=>{let s,r=em||1;return(s=r<=5||T<=3?t+1:T>=r-2?r-4+t:T-2+t)<1||s>r?null:(0,a.jsx)("button",{onClick:()=>D(s),className:(0,u.cn)("w-8 h-8 rounded text-sm font-medium transition-colors",T===s?"bg-violet-500 text-white":"bg-zinc-800 text-zinc-400 hover:bg-zinc-700"),children:s},s)})}),(0,a.jsx)("button",{onClick:()=>D(e=>Math.min(em||1,e+1)),disabled:T===em||0===em,className:"p-2 rounded bg-zinc-800 text-zinc-300 hover:bg-zinc-700 disabled:opacity-50 disabled:cursor-not-allowed transition-colors",children:(0,a.jsx)(p.A,{size:16})})]})]}),(0,a.jsx)(v.a,{isOpen:G,onClose:()=>Y(!1),className:"max-w-5xl",title:(0,a.jsxs)("div",{className:"flex items-center justify-between w-full",children:[(0,a.jsxs)("div",{className:"flex items-center gap-2",children:[(0,a.jsx)(m.A,{className:"text-cyan-400"}),(0,a.jsx)("span",{children:ee})]}),(0,a.jsx)(N.N,{data:U,filename:`sub_table_${ee}`,label:"匯出附表",className:"ml-4"})]}),children:V?(0,a.jsxs)("div",{className:"flex flex-col items-center justify-center py-12",children:[(0,a.jsx)(o.A,{className:"h-8 w-8 animate-spin text-cyan-400 mb-3"}),(0,a.jsx)("p",{className:"text-zinc-500 text-sm animate-pulse",children:"正在讀取附表資料..."})]}):U.length>0?(0,a.jsxs)("div",{className:"space-y-8",children:[U.some(e=>e._category.includes("車位"))&&(0,a.jsxs)("div",{className:"space-y-3",children:[(0,a.jsxs)("h4",{className:"text-sm font-bold text-violet-400 flex items-center gap-2",children:[(0,a.jsx)("div",{className:"w-1 h-4 bg-violet-500 rounded-full"}),"車位明細"]}),(0,a.jsx)("div",{className:"bg-zinc-800/30 rounded-lg overflow-hidden border border-white/5",children:(0,a.jsx)("div",{className:"overflow-x-auto",children:(0,a.jsxs)("table",{className:"w-full text-sm text-left",children:[(0,a.jsx)("thead",{className:"bg-zinc-900/80 text-zinc-400 uppercase text-xs font-semibold",children:(0,a.jsxs)("tr",{children:[(0,a.jsx)("th",{className:"px-4 py-3 whitespace-nowrap bg-zinc-900 text-cyan-400",children:"來源"}),["車位類別","車位價格(萬)","車位面積(坪)","車位樓層","建案名稱","備註"].map(e=>(0,a.jsx)("th",{className:"px-4 py-3 whitespace-nowrap bg-zinc-900",children:e},e))]})}),(0,a.jsx)("tbody",{className:"divide-y divide-white/5",children:U.filter(e=>e._category.includes("車位")).map((e,t)=>(0,a.jsxs)("tr",{className:"hover:bg-zinc-800/50 transition-colors",children:[(0,a.jsx)("td",{className:"px-4 py-3 whitespace-nowrap text-cyan-400 font-medium text-xs",children:e._category.replace("車位資料","").replace(/[()]/g,"")||"API"}),["車位類別","車位價格(萬)","車位面積(坪)","車位樓層","建案名稱","備註"].map(t=>(0,a.jsx)("td",{className:"px-4 py-3 whitespace-nowrap text-zinc-300",children:ed(e[t])},t))]},t))})]})})})]}),U.some(e=>e._category.includes("建物"))&&(0,a.jsxs)("div",{className:"space-y-3",children:[(0,a.jsxs)("h4",{className:"text-sm font-bold text-emerald-400 flex items-center gap-2",children:[(0,a.jsx)("div",{className:"w-1 h-4 bg-emerald-500 rounded-full"}),"建物明細"]}),(0,a.jsx)("div",{className:"bg-zinc-800/30 rounded-lg overflow-hidden border border-white/5",children:(0,a.jsx)("div",{className:"overflow-x-auto",children:(0,a.jsxs)("table",{className:"w-full text-sm text-left",children:[(0,a.jsx)("thead",{className:"bg-zinc-900/80 text-zinc-400 uppercase text-xs font-semibold",children:(0,a.jsx)("tr",{children:Array.from(new Set(U.filter(e=>e._category.includes("建物")).flatMap(Object.keys))).filter(e=>!["id","編號","created_at","_category","rawRecords"].includes(e)).map(e=>(0,a.jsx)("th",{className:"px-4 py-3 whitespace-nowrap bg-zinc-900",children:e},e))})}),(0,a.jsx)("tbody",{className:"divide-y divide-white/5",children:U.filter(e=>e._category.includes("建物")).map((e,t)=>(0,a.jsx)("tr",{className:"hover:bg-zinc-800/50 transition-colors",children:Array.from(new Set(U.filter(e=>e._category.includes("建物")).flatMap(Object.keys))).filter(e=>!["id","編號","created_at","_category","rawRecords"].includes(e)).map(t=>(0,a.jsx)("td",{className:"px-4 py-3 whitespace-nowrap text-zinc-300",children:ed(e[t])},t))},t))})]})})})]}),U.some(e=>e._category.includes("土地"))&&(0,a.jsxs)("div",{className:"space-y-3",children:[(0,a.jsxs)("h4",{className:"text-sm font-bold text-amber-400 flex items-center gap-2",children:[(0,a.jsx)("div",{className:"w-1 h-4 bg-amber-500 rounded-full"}),"土地明細"]}),(0,a.jsx)("div",{className:"bg-zinc-800/30 rounded-lg overflow-hidden border border-white/5",children:(0,a.jsx)("div",{className:"overflow-x-auto",children:(0,a.jsxs)("table",{className:"w-full text-sm text-left",children:[(0,a.jsx)("thead",{className:"bg-zinc-900/80 text-zinc-400 uppercase text-xs font-semibold",children:(0,a.jsx)("tr",{children:Array.from(new Set(U.filter(e=>e._category.includes("土地")).flatMap(Object.keys))).filter(e=>!["id","編號","created_at","_category","rawRecords"].includes(e)).map(e=>(0,a.jsx)("th",{className:"px-4 py-3 whitespace-nowrap bg-zinc-900",children:e},e))})}),(0,a.jsx)("tbody",{className:"divide-y divide-white/5",children:U.filter(e=>e._category.includes("土地")).map((e,t)=>(0,a.jsx)("tr",{className:"hover:bg-zinc-800/50 transition-colors",children:Array.from(new Set(U.filter(e=>e._category.includes("土地")).flatMap(Object.keys))).filter(e=>!["id","編號","created_at","_category","rawRecords"].includes(e)).map(t=>(0,a.jsx)("td",{className:"px-4 py-3 whitespace-nowrap text-zinc-300",children:ed(e[t])},t))},t))})]})})})]}),(0,a.jsx)("div",{className:"flex justify-end",children:(0,a.jsx)("button",{onClick:()=>Y(!1),className:"px-4 py-2 bg-zinc-800 hover:bg-zinc-700 text-sm text-white rounded transition-colors",children:"關閉"})})]}):(0,a.jsxs)("div",{className:"flex flex-col items-center justify-center py-12 text-zinc-500",children:[(0,a.jsx)("div",{className:"bg-zinc-800/50 p-4 rounded-full mb-3",children:(0,a.jsx)(m.A,{size:24,className:"opacity-20"})}),(0,a.jsx)("p",{children:"此筆交易沒有相關附表資料"})]})})]}):(0,a.jsx)("div",{className:"text-center p-12 text-zinc-500",children:"無交易資料可顯示"})}},34361:(e,t,s)=>{s.d(t,{c:()=>i});var a=s(95155);s(12115);var r=s(40980),n=s(88743);function i({title:e,description:t,children:s,headerAction:i,className:l,containerRef:c}){let o,d,x=(o=n.P.getState(),d=[],o.counties.length>0&&(o.districts.length>0?d.push(`${o.counties.join(", ")} - ${o.districts.join(", ")}`):d.push(o.counties.join(", "))),o.startDate&&o.endDate?d.push(`${o.startDate} ~ ${o.endDate}`):o.dateRange&&"custom"!==o.dateRange&&d.push({"1m":"近1個月","3m":"近3個月","6m":"近6個月","1y":"近1年","2y":"近2年",all:"全部時間"}[o.dateRange]||o.dateRange),o.transactionType&&d.push(o.transactionType),o.buildingType&&""!==o.buildingType&&d.push(o.buildingType),o.projectNames.length>0&&o.projectNames.length<=3?d.push(o.projectNames.join(", ")):o.projectNames.length>3&&d.push(`${o.projectNames.length} 個建案`),o.excludeCommercial&&d.push("排除商業/辦公"),d.length>0?d.join(" | "):"所有條件");return(0,a.jsxs)("div",{ref:c,className:(0,r.cn)("bg-zinc-900/50 border border-white/5 rounded-2xl p-4 md:p-6 backdrop-blur-sm",l),children:[(0,a.jsxs)("div",{className:"flex flex-col md:flex-row md:items-center justify-between gap-4 mb-6",children:[(0,a.jsxs)("div",{children:[(0,a.jsx)("h3",{className:"text-xl font-bold text-white flex items-center gap-2",children:e}),t&&(0,a.jsx)("p",{className:"text-zinc-400 text-sm mt-1",children:t})]}),i&&(0,a.jsx)("div",{className:"flex-shrink-0 w-full md:w-auto overflow-x-auto","data-html2canvas-ignore":"true",children:i})]}),s,(0,a.jsxs)("div",{className:"mt-4 pt-3 border-t border-white/10 flex flex-col sm:flex-row justify-between items-start sm:items-center gap-2 text-xs",style:{display:"none"},"data-export-footer":"true",children:[(0,a.jsx)("div",{className:"text-white font-semibold text-sm",children:"彙整：平米內參 　來源：內政部實登"}),(0,a.jsxs)("div",{className:"text-zinc-400 text-right",children:["搜尋條件：",x]})]})]})}},37847:(e,t,s)=>{s.d(t,{v:()=>w});var a=s(95155),r=s(12115),n=s(34361),i=s(97085);function l({data:e}){let t=(0,r.useMemo)(()=>e?[e.withParking.count,e.withoutParking.count]:[],[e]),s=(0,r.useMemo)(()=>({chart:{type:"donut",background:"transparent",foreColor:"#e5e7eb"},labels:["含車位","無車位"],colors:["#a5b4fc","#4b5563"],plotOptions:{pie:{donut:{labels:{show:!0,total:{show:!0,label:"總交易",color:"#e5e7eb",formatter:e=>e.globals.seriesTotals.reduce((e,t)=>e+t,0).toLocaleString()+" 筆"}}}}},dataLabels:{enabled:!0,formatter:e=>`${e.toFixed(1)}%`},legend:{show:!1},tooltip:{theme:"dark",y:{formatter:e=>`${e} 筆`}},stroke:{show:!1},responsive:[{breakpoint:480,options:{chart:{width:300},legend:{position:"bottom"}}}]}),[]);return e&&(0!==e.withParking.count||0!==e.withoutParking.count)?(0,a.jsx)(i.A,{type:"donut",series:t,options:s,height:350,className:"w-full"}):(0,a.jsx)("div",{className:"text-zinc-500 text-center p-8",children:"無車位配比資料"})}var c=s(40980);function o({data:e,xLabel:t,yLabel:s,xUnit:n="",yUnit:i="",title:l,highlightIds:o=[]}){let[d,x]=(0,r.useState)(null),[m,h]=(0,r.useState)(null),[p,u]=(0,r.useState)({x:0,y:0}),{xMin:f,xMax:g,yMin:b,yMax:j}=(0,r.useMemo)(()=>{if(0===e.length)return{xMin:0,xMax:100,yMin:0,yMax:100};let t=e.map(e=>e.x),s=e.map(e=>e.y),a=Math.min(...t),r=Math.max(...t),n=Math.min(...s),i=Math.max(...s),l=(r-a)*.1||1,c=(i-n)*.1||1;return{xMin:Math.max(0,a-l),xMax:r+l,yMin:Math.max(0,n-c),yMax:i+c}},[e]),v=o.length>0,N=e=>{let t=e.currentTarget.closest(".relative.bg-zinc-900\\/30")?.getBoundingClientRect();t&&u({x:e.clientX-t.left,y:e.clientY-t.top})},y=m||d,w=(0,r.useMemo)(()=>o.length?[...e].sort((e,t)=>!!o.includes(e.id)-!!o.includes(t.id)):e,[e,o]);return(0,a.jsxs)("div",{className:"w-full h-[400px] relative bg-zinc-900/30 rounded-xl border border-white/5 p-4 select-none cursor-crosshair",onClick:()=>{h(null),x(null)},onMouseMove:e=>{!m&&d&&N(e)},children:[l&&(0,a.jsx)("h4",{className:"absolute top-4 left-4 text-sm font-medium text-zinc-400 pointer-events-none",children:l}),(0,a.jsxs)("div",{className:"absolute inset-x-12 inset-y-12 pointer-events-none",children:[(0,a.jsx)("div",{className:"absolute inset-0 flex flex-col justify-between opacity-20",children:[0,.25,.5,.75,1].map(e=>(0,a.jsx)("div",{className:"w-full h-px border-t border-dashed border-zinc-500"},e))}),(0,a.jsx)("div",{className:"absolute inset-0 flex justify-between opacity-20",children:[0,.25,.5,.75,1].map(e=>(0,a.jsx)("div",{className:"h-full w-px border-l border-dashed border-zinc-500"},e))})]}),(0,a.jsx)("div",{className:"absolute inset-x-12 inset-y-12",children:w.map(e=>{var t,s;let r=(t=e.x,s=e.y,{left:`${(t-f)/(g-f)*100}%`,top:`${100-(s-b)/(j-b)*100}%`}),n=d?.id===e.id,i=m?.id===e.id,l=v&&o.includes(e.id),p="bg-cyan-500/60 hover:bg-cyan-400 z-10",u="";return v&&(l?(p="bg-yellow-400 shadow-[0_0_10px_rgba(250,204,21,0.6)] z-20",u="scale-125"):p="bg-zinc-700/30 z-0"),(n||i)&&(p="bg-cyan-400 shadow-[0_0_15px_rgba(34,211,238,0.8)] ring-2 ring-white z-30",u="scale-150",v&&l&&(p="bg-yellow-400 shadow-[0_0_15px_rgba(250,204,21,0.8)] ring-2 ring-white z-30")),(0,a.jsx)("div",{className:(0,c.cn)("absolute w-3 h-3 rounded-full cursor-pointer transition-all duration-300 transform -translate-x-1/2 -translate-y-1/2",p,u),style:{left:r.left,top:r.top},onMouseEnter:t=>{m||(!v||o.includes(e.id))&&(x(e),N(t))},onMouseLeave:()=>!m&&x(null),onClick:t=>{t.stopPropagation(),(!v||o.includes(e.id))&&(m?.id===e.id?(h(null),x(e)):(h(e),x(null),N(t)))}},e.id)})}),(0,a.jsxs)("div",{className:"absolute left-0 top-12 bottom-12 w-10 flex flex-col justify-between text-[10px] text-zinc-500 text-right pr-2 pointer-events-none",children:[(0,a.jsxs)("span",{children:[Math.round(j),i]}),(0,a.jsxs)("span",{children:[Math.round(b),i]})]}),(0,a.jsxs)("div",{className:"absolute left-12 right-12 bottom-4 h-6 flex justify-between text-[10px] text-zinc-500 pt-1 pointer-events-none",children:[(0,a.jsxs)("span",{children:[Math.round(f),n]}),(0,a.jsxs)("span",{children:[Math.round(g),n]})]}),(0,a.jsx)("div",{className:"absolute bottom-1 left-1/2 -translate-x-1/2 text-xs text-zinc-400 font-bold pointer-events-none",children:t}),(0,a.jsx)("div",{className:"absolute left-1 top-1/2 -translate-y-1/2 -rotate-90 text-xs text-zinc-400 font-bold pointer-events-none",children:s}),y&&(0,a.jsx)("div",{className:"absolute z-50 pointer-events-none",style:{left:p.x,top:p.y,transform:"translate(10px, 10px)"},children:(0,a.jsxs)("div",{className:"bg-zinc-950/90 border border-cyan-500/30 rounded-lg p-3 shadow-xl backdrop-blur-md w-48 animate-in zoom-in-95 fade-in duration-200",children:[(0,a.jsx)("div",{className:"text-sm font-bold text-white mb-1",children:y.label}),(0,a.jsxs)("div",{className:"space-y-1 text-xs text-zinc-400",children:[(0,a.jsxs)("div",{className:"flex justify-between",children:[(0,a.jsxs)("span",{children:[t,":"]}),(0,a.jsxs)("span",{className:"text-cyan-400 font-mono",children:[y.x.toLocaleString()," ",n]})]}),(0,a.jsxs)("div",{className:"flex justify-between",children:[(0,a.jsxs)("span",{children:[s,":"]}),(0,a.jsxs)("span",{className:"text-cyan-400 font-mono",children:[y.y.toLocaleString()," ",i]})]})]})]})})]})}var d=s(47650),x=s(39430),m=s(80642);function h({data:e,selectedFloors:t,hoveredFloor:s,onHover:n,onToggle:i,onDetail:l,floorColors:o}){let h=[...e].sort((e,t)=>{let s=e=>"B1"===e?1:"B2"===e?2:"B3"===e?3:"B4"===e?4:e.includes("B5")?5:99;return s(e.floor)-s(t.floor)}),u=h.length>4?Math.max(.7,4/h.length):1,f=r.useRef(null),[g,b]=r.useState(!1);r.useEffect(()=>{b(!0)},[]);let j=h.find(e=>e.floor===s);return(0,a.jsxs)("div",{className:"w-full h-[600px] flex items-start justify-start relative perspective-container overflow-visible pl-12 lg:pl-24 -mt-12",onMouseMove:e=>{if(f.current){let t=e.clientX+12,s=e.clientY+12;f.current.style.transform=`translate3d(${t}px, ${s}px, 0)`}},children:[(0,a.jsx)("div",{className:"relative flex items-center justify-center preserve-3d",style:{width:240,height:240,perspective:"3000px",transformStyle:"preserve-3d",zIndex:10,transform:`scale(${u})`},children:(0,a.jsx)(x.P.div,{className:"relative preserve-3d",initial:{rotateX:60,rotateZ:45},animate:{rotateX:60,rotateZ:45},transition:{duration:.8,ease:"easeOut"},style:{transformStyle:"preserve-3d",width:"100%",height:"100%"},children:(0,a.jsx)(m.N,{children:h.map((e,r)=>{let i=t.includes(e.floor),c=s===e.floor,d=o[e.floor]||"#71717a";return(0,a.jsx)(p,{data:e,color:d,isSelected:i,isHovered:c,active:i,onHover:()=>n(e.floor),onLeave:()=>n(null),onDetail:()=>l(e.floor),zIndex:h.length-r,baseZ:-(110*r),thickness:40},e.floor)})})})}),g&&(0,d.createPortal)((0,a.jsx)("div",{className:"fixed inset-0 pointer-events-none z-[9999]",children:(0,a.jsx)(m.N,{children:j&&(0,a.jsx)("div",{ref:f,className:"absolute top-0 left-0 will-change-transform",style:{transform:"translate3d(-500px, -500px, 0)"},children:(0,a.jsx)(x.P.div,{initial:{opacity:0,scale:.95},animate:{opacity:1,scale:1},exit:{opacity:0,scale:.95,transition:{duration:.1}},transition:{type:"spring",stiffness:400,damping:25},className:"flex items-center justify-start",children:(0,a.jsxs)("div",{className:"flex items-center gap-3 whitespace-nowrap",children:[(0,a.jsx)("span",{className:(0,c.cn)("text-6xl font-black text-white drop-shadow-[0_5px_8px_rgba(0,0,0,0.8)] leading-none","font-sans italic tracking-tighter"),style:{textShadow:"0 0 30px rgba(255,255,255,0.4)"},children:j.floor}),(0,a.jsxs)("div",{className:"bg-zinc-950/95 border-l-4 border-cyan-500 backdrop-blur-xl px-4 py-2 rounded-r-lg shadow-[0_20px_50px_rgba(0,0,0,0.5)] flex items-center gap-6 border border-white/10",children:[(0,a.jsxs)("div",{children:[(0,a.jsx)("div",{className:"text-[10px] text-zinc-500 uppercase font-black leading-none mb-1 tracking-widest",children:"均價 (萬)"}),(0,a.jsx)("div",{className:"text-2xl font-mono font-bold text-cyan-400 leading-none",children:Math.round(j.avgPrice).toLocaleString()})]}),(0,a.jsx)("div",{className:"h-8 w-px bg-white/10"}),(0,a.jsxs)("div",{children:[(0,a.jsx)("div",{className:"text-[10px] text-zinc-500 uppercase font-black leading-none mb-1 tracking-widest",children:"成交量"}),(0,a.jsx)("div",{className:"text-xl font-mono text-zinc-100 leading-none font-medium",children:j.count})]})]})]})},"tooltip")})})}),document.body)]})}function p({data:e,color:t,isSelected:s,isHovered:r,active:n,onHover:i,onLeave:l,onDetail:o,zIndex:d,baseZ:m,thickness:h}){let p=r?t:"#52525b";return(0,a.jsxs)(x.P.div,{className:(0,c.cn)("absolute top-0 left-0 w-full h-full preserve-3d pointer-events-none",!n&&"pointer-events-none"),initial:{scale:.9,opacity:0},animate:{translateZ:m+0,scale:+!!n,opacity:+!!n},transition:{type:"spring",stiffness:600,damping:15},style:{transformStyle:"preserve-3d",zIndex:d},children:[(0,a.jsx)("div",{className:"absolute inset-0 rounded-sm overflow-hidden transition-all duration-75 pointer-events-auto cursor-pointer",style:{backgroundColor:p,backgroundImage:r?"linear-gradient(135deg, rgba(255,255,255,0.6) 0%, rgba(255,255,255,0.1) 50%, rgba(0,0,0,0.2) 100%)":"linear-gradient(135deg, rgba(255,255,255,0.2) 0%, rgba(255,255,255,0.05) 50%, rgba(0,0,0,0.1) 100%)",filter:r?"none":"brightness(1.1)",boxShadow:r?`inset 0 0 0 1px rgba(255,255,255,0.4), 0 0 30px -5px ${t}`:"inset 0 0 0 1px rgba(255,255,255,0.1)"},onMouseEnter:i,onMouseLeave:l,onClick:e=>{e.stopPropagation(),o()},children:(0,a.jsx)(x.P.div,{initial:{x:"-100%"},animate:r?{x:"200%"}:{x:"-100%"},transition:{duration:1.5,repeat:1/0,repeatDelay:1},className:"absolute top-0 left-0 w-1/2 h-full bg-gradient-to-r from-transparent via-white/20 to-transparent skew-x-12 pointer-events-none"})}),(0,a.jsx)("div",{className:"absolute top-0 origin-top-right transition-all duration-75 pointer-events-auto cursor-pointer",style:{right:0,width:h,height:"100%",backgroundColor:p,filter:r?"brightness(0.6)":"brightness(0.5)",left:"100%",transformOrigin:"left center",transform:"rotateY(90deg)"},onMouseEnter:i,onMouseLeave:l,onClick:e=>{e.stopPropagation(),o()}}),(0,a.jsx)("div",{className:"absolute left-0 origin-bottom-left transition-all duration-75 pointer-events-auto cursor-pointer",style:{bottom:0,width:"100%",height:h,backgroundColor:p,filter:r?"brightness(0.8)":"brightness(0.3)",top:"100%",transformOrigin:"top center",transform:"rotateX(-90deg)"},onMouseEnter:i,onMouseLeave:l,onClick:e=>{e.stopPropagation(),o()}})]})}var u=s(94961),f=s(94514),g=s(57420),b=s(61878),j=s(51806),v=s(89733),N=s(9505);function y({chartData:e,hasData:t,summaryStats:s}){let[n,i]=(0,r.useState)("scale"),[l,d]=(0,r.useState)(null);r.useRef(null);let[x,m]=(0,r.useState)([]);if(!t)return(0,a.jsx)("p",{className:"text-zinc-500 text-center py-4",children:"無坡道平面車位坪數資料"});let h="scale"===n?e.map(e=>({id:e.id,label:e.id,x:e.count,y:e.avgArea})):e.map(e=>({id:e.id,label:e.id,x:e.avgPrice,y:e.avgArea}));return(0,a.jsxs)("div",{className:"grid grid-cols-1 lg:grid-cols-3 gap-8 relative",children:[l&&(0,a.jsxs)("div",{className:"fixed z-50 px-3 py-2 bg-zinc-900 border border-white/10 rounded-lg shadow-xl text-xs text-zinc-300 pointer-events-none transform -translate-x-1/2 -translate-y-full animate-in fade-in zoom-in-95",style:{left:l.x,top:l.y},children:[l.text,(0,a.jsx)("div",{className:"absolute left-1/2 bottom-0 w-2 h-2 bg-zinc-900 border-r border-b border-white/10 text-zinc-900 transform rotate-45 -translate-x-1/2 -mb-1"})]}),(0,a.jsxs)("div",{className:"lg:col-span-1 space-y-6",children:[(0,a.jsxs)("div",{className:"space-y-4",children:[(0,a.jsx)("h4",{className:"text-sm font-medium text-zinc-400 pl-1 border-l-2 border-cyan-500",children:"總體統計數據"}),(0,a.jsx)("div",{className:"bg-zinc-900/30 rounded-xl border border-white/5 p-4",children:(0,a.jsx)("table",{className:"w-full text-sm",children:(0,a.jsxs)("tbody",{className:"divide-y divide-white/5",children:[(0,a.jsxs)("tr",{children:[(0,a.jsx)("td",{className:"py-3 text-zinc-500",children:"數據範圍"}),(0,a.jsxs)("td",{className:"py-3 text-right font-mono text-white",children:[(0,a.jsx)("span",{className:"text-cyan-400",children:e.length})," 建案",(0,a.jsx)("span",{className:"mx-1 text-zinc-600",children:"/"}),(0,a.jsx)("span",{className:"text-zinc-300",children:s.count.toLocaleString()})," 車位"]})]}),(0,a.jsxs)("tr",{children:[(0,a.jsx)("td",{className:"py-3 text-zinc-500",children:"平均坪數"}),(0,a.jsxs)("td",{className:"py-3 text-right font-mono text-cyan-400 text-lg font-bold",children:[s.avgArea.toFixed(2)," ",(0,a.jsx)("span",{className:"text-xs font-normal text-zinc-500",children:"坪"})]})]}),(0,a.jsxs)("tr",{children:[(0,a.jsx)("td",{className:"py-3 text-zinc-500",children:"坪數中位數"}),(0,a.jsxs)("td",{className:"py-3 text-right font-mono text-zinc-300 text-lg font-bold",children:[s.medianArea.toFixed(2)," ",(0,a.jsx)("span",{className:"text-xs font-normal text-zinc-500",children:"坪"})]})]})]})})})]}),(0,a.jsx)(N.l,{projects:e.map(e=>({value:e.id,label:e.id})),className:"w-full",onChange:e=>m(e),max:6})]}),(0,a.jsxs)("div",{className:"lg:col-span-2 space-y-4",children:[(0,a.jsxs)("div",{className:"flex flex-wrap justify-between items-center gap-2",children:[(0,a.jsxs)("div",{children:[(0,a.jsx)("h4",{className:"text-sm font-medium text-zinc-400 pl-1 border-l-2 border-violet-500",children:"分佈散佈圖"}),(0,a.jsx)("div",{className:"mt-1 text-xs text-zinc-500 font-mono",children:"scale"===n?(0,a.jsxs)("span",{children:[(0,a.jsx)("span",{className:"text-cyan-400",children:"X軸"}),": 建案車位總數 ",(0,a.jsx)("span",{className:"text-zinc-600",children:"|"})," ",(0,a.jsx)("span",{className:"text-cyan-400",children:"Y軸"}),": 平均車位坪數"]}):(0,a.jsxs)("span",{children:[(0,a.jsx)("span",{className:"text-cyan-400",children:"X軸"}),": 平均車位價格 ",(0,a.jsx)("span",{className:"text-zinc-600",children:"|"})," ",(0,a.jsx)("span",{className:"text-cyan-400",children:"Y軸"}),": 平均車位坪數"]})})]}),(0,a.jsxs)("div",{className:"flex gap-2 items-center",children:[(0,a.jsxs)("div",{className:"relative group",children:[(0,a.jsx)("button",{className:"p-1.5 text-zinc-500 hover:text-cyan-400 transition-colors",children:(0,a.jsx)(u.A,{size:14})}),(0,a.jsx)("div",{className:"absolute right-0 top-full mt-2 w-64 p-3 bg-zinc-900 border border-white/10 rounded-lg shadow-xl z-50 opacity-0 group-hover:opacity-100 transition-opacity pointer-events-none",children:(0,a.jsx)("div",{className:"text-xs text-zinc-300 leading-relaxed",children:"scale"===n?"分析各建案「規劃車位總數」與「平均車位坪數」的關係。可觀察大社區是否傾向規劃較大或較小的車位。":"分析各建案「平均車位價格」與「平均車位坪數」的關係。可觀察車位價格是否隨著坪數增加而顯著提升。"})})]}),(0,a.jsx)("div",{className:"w-px h-4 bg-white/10 mx-1"}),(0,a.jsx)("button",{onClick:()=>i("scale"),className:(0,c.cn)("px-3 py-1.5 text-xs font-medium rounded-md border transition-all duration-200","scale"===n?"bg-cyan-500/10 text-cyan-400 border-cyan-500/50 shadow-[0_0_10px_rgba(34,211,238,0.1)]":"bg-zinc-900/50 border-white/10 text-zinc-500 hover:text-zinc-300 hover:bg-white/5"),children:"規模分析"}),(0,a.jsx)("button",{onClick:()=>i("value"),className:(0,c.cn)("px-3 py-1.5 text-xs font-medium rounded-md border transition-all duration-200","value"===n?"bg-cyan-500/10 text-cyan-400 border-cyan-500/50 shadow-[0_0_10px_rgba(34,211,238,0.1)]":"bg-zinc-900/50 border-white/10 text-zinc-500 hover:text-zinc-300 hover:bg-white/5"),children:"價值分析"})]})]}),(0,a.jsx)(o,{data:h,xLabel:"scale"===n?"建案車位總數":"平均車位價格",yLabel:"平均車位坪數",xUnit:"scale"===n?"位":"萬",yUnit:"坪",title:"scale"===n?"建案規模 vs 車位坪數分佈":"車位價值 vs 坪數分佈",highlightIds:x})]})]})}function w({data:e}){let[t,s]=(0,r.useState)(["B1","B2","B3","B4"]),[i,o]=(0,r.useState)(null),d=r.useRef(null),x=r.useRef(null),m=r.useRef(null),p=r.useRef(null),[u,N]=(0,r.useState)(!1),[w,z]=(0,r.useState)(null),[k,S]=(0,r.useState)([]),[P,A]=(0,r.useState)(!1),[M,C]=(0,r.useState)(0),_=t=>{z(t),A(!1);let s=F?.find(e=>e.floor===t),a=s?.rawRecords;if(a&&a.length>0){let e=a.map(e=>({...e,_isMatch:!0}));e.sort((e,t)=>{let s=e["交易年月日"]||0;return(t["交易年月日"]||0)-s}),S(e),C(e.length)}else{let s=e?.transactionDetails||[],a=[t];"B1"===t&&a.push("地下一層","B1","b1"),"B2"===t&&a.push("地下二層","B2","b2"),"B3"===t&&a.push("地下三層","B3","b3"),"B4"===t&&a.push("地下四層","B4","b4"),"B5_below"===t&&a.push("地下五層","B5","b5");let r=s.filter(e=>(e["車位類別"]||"").includes("坡道平面")),n=r.filter(e=>{let t=e["車位所在樓層"]||"",s=e["備註"]||"";return a.some(e=>t&&t.includes(e)||s&&s.includes(e))});C(n.length);let i=r.map(e=>{let t=e["車位所在樓層"]||"",s=e["備註"]||"",r=a.some(e=>t&&t.includes(e)||s&&s.includes(e));return{...e,_isMatch:r}});i.sort((e,t)=>{if(e._isMatch&&!t._isMatch)return -1;if(!e._isMatch&&t._isMatch)return 1;let s=e["交易年月日"]||0;return(t["交易年月日"]||0)-s}),S(i),0===n.length&&A(!0)}N(!0)};if(!e?.parkingAnalysis)return null;let{parkingRatio:$,avgPriceByType:R,rampPlanePriceByFloor:F}=e.parkingAnalysis,E=["B1","B2","B3","B4","B5_below","Unknown"],T=F?.filter(e=>E.includes(e.floor)&&e.count>0)||[],D=(0,r.useMemo)(()=>(function(e,t){let s=[];if(e.forEach(e=>{t.includes(e.floor)&&e.rawRecords&&e.rawRecords.forEach(e=>{"number"!=typeof e.parkingPrice||isNaN(e.parkingPrice)||s.push(e.parkingPrice)})}),0===s.length)return{avgPrice:0,medianPrice:0,q3Price:0,count:0};s.sort((e,t)=>e-t);let a=s.reduce((e,t)=>e+t,0)/s.length,r=s[Math.floor(s.length/2)],n=Math.floor(.75*s.length),i=s[n]||r;return{avgPrice:a,medianPrice:r,q3Price:i,count:s.length}})(T,t),[T,t]),L=(0,r.useCallback)(e=>{s(t=>t.includes(e)?t.filter(t=>t!==e):[...t,e])},[]),I=(0,r.useCallback)(()=>{t.length===E.length?s([]):s([...E])},[t.length]),O={B1:"#06b6d4",B2:"#3b82f6",B3:"#6366f1",B4:"#8b5cf6",B5_below:"#a855f7",Unknown:"#71717a"},{parkingChartData:B,parkingChartStats:H,hasParkingData:q}=(0,r.useMemo)(()=>{let e=new Map,t=!1;T.forEach(s=>{s.rawRecords&&s.rawRecords.forEach(s=>{let a=s["建案名稱"],r=s.parkingArea||s["車位面積(坪)"]||.3025*(s["車位移轉總面積平方公尺"]||0),n=s.parkingPrice||s["車位價格(萬)"]||0;if(a&&r>0){e.has(a)||e.set(a,{count:0,totalArea:0,totalPrice:0});let s=e.get(a);s.count+=1,s.totalArea+=r,s.totalPrice+=n,t=!0}})});let s=Array.from(e.entries()).map(([e,t])=>({id:e,label:e,avgArea:parseFloat((t.totalArea/t.count).toFixed(2)),count:t.count,avgPrice:parseFloat((t.totalPrice/t.count).toFixed(2))})),a=0,r=[];s.forEach(e=>{a+=e.count,r.push(e.avgArea)}),r.sort((e,t)=>e-t);let n=r.length>0?r.reduce((e,t)=>e+t,0)/r.length:0,i=r.length>0?r[Math.floor(r.length/2)]:0;return{parkingChartData:s,parkingChartStats:{count:a,avgArea:n,medianArea:i},hasParkingData:t}},[T]);return(0,a.jsxs)("div",{className:"space-y-6 animate-in fade-in slide-in-from-bottom-4 duration-500 text-white",children:[(0,a.jsxs)("div",{className:"grid grid-cols-1 lg:grid-cols-2 gap-6",children:[(0,a.jsx)(n.c,{title:"房車配比分析",description:"建案有購置車位的比例",containerRef:d,headerAction:(0,a.jsx)(v.N,{data:[{type:"有車位",...$?.withParking},{type:"無車位",...$?.withoutParking},{ratio:$?.avgRatio}],filename:"parking_ratio_data",label:"匯出",columns:{type:"類別",count:"數量",percentage:"百分比",ratio:"比率"},chartType:"parking-pie",targetRef:d,snapshotData:[{type:"有車位",...$?.withParking},{type:"無車位",...$?.withoutParking},{ratio:$?.avgRatio}]}),children:(0,a.jsxs)("div",{className:"flex flex-col md:flex-row items-start gap-6",children:[(0,a.jsx)("div",{className:"w-full md:w-1/2",children:(0,a.jsx)(l,{data:$})}),(0,a.jsx)("div",{className:"w-full md:w-1/2 flex flex-col gap-4",children:(0,a.jsxs)("table",{className:"w-full text-sm",children:[(0,a.jsx)("thead",{className:"bg-zinc-900/50 text-zinc-500",children:(0,a.jsxs)("tr",{children:[(0,a.jsx)("th",{className:"p-2 text-left",children:"類型"}),(0,a.jsx)("th",{className:"p-2 text-right",children:"筆數"}),(0,a.jsx)("th",{className:"p-2 text-right",children:"佔比"})]})}),(0,a.jsxs)("tbody",{className:"divide-y divide-white/5",children:[(0,a.jsxs)("tr",{children:[(0,a.jsxs)("td",{className:"p-2 flex items-center gap-2",children:[(0,a.jsx)("span",{className:"w-3 h-3 rounded-full bg-indigo-300"}),"有搭車位"]}),(0,a.jsx)("td",{className:"p-2 text-right font-mono text-zinc-300",children:$?.withParking?.count.toLocaleString()}),(0,a.jsxs)("td",{className:"p-2 text-right font-mono text-cyan-400",children:[$?.withParking?.percentage.toFixed(2),"%"]})]}),(0,a.jsxs)("tr",{children:[(0,a.jsxs)("td",{className:"p-2 flex items-center gap-2",children:[(0,a.jsx)("span",{className:"w-3 h-3 rounded-full bg-gray-600"}),"無車位"]}),(0,a.jsx)("td",{className:"p-2 text-right font-mono text-zinc-300",children:$?.withoutParking?.count.toLocaleString()}),(0,a.jsxs)("td",{className:"p-2 text-right font-mono text-zinc-500",children:[$?.withoutParking?.percentage.toFixed(2),"%"]})]})]})]})})]})}),(0,a.jsx)(n.c,{title:"車位類型均價",description:"各類車位成交行情",containerRef:x,headerAction:(0,a.jsx)(v.N,{data:R||[],filename:"parking_price_by_type",label:"匯出",columns:{type:"車位類型",avgPrice:"平均價格",medianPrice:"中位數",count:"數量"},chartType:"parking-price",targetRef:x,snapshotData:R||[]}),children:(0,a.jsxs)("table",{className:"w-full text-sm",children:[(0,a.jsx)("thead",{className:"bg-zinc-900/50 text-zinc-500",children:(0,a.jsxs)("tr",{children:[(0,a.jsx)("th",{className:"p-2 text-left",children:"類型"}),(0,a.jsx)("th",{className:"p-2 text-right",children:"均價(萬)"}),(0,a.jsx)("th",{className:"p-2 text-right",children:"中位數"}),(0,a.jsx)("th",{className:"p-2 text-right",children:"總數"})]})}),(0,a.jsx)("tbody",{className:"divide-y divide-white/5",children:R?.map(e=>(0,a.jsxs)("tr",{className:"hover:bg-zinc-800/50",children:[(0,a.jsx)("td",{className:"p-2 font-medium",children:e.type}),(0,a.jsx)("td",{className:"p-2 text-right font-mono text-cyan-400",children:Math.round(e.avgPrice).toLocaleString()}),(0,a.jsx)("td",{className:"p-2 text-right font-mono text-zinc-300",children:Math.round(e.medianPrice).toLocaleString()}),(0,a.jsx)("td",{className:"p-2 text-right font-mono text-zinc-500",children:e.count.toLocaleString()})]},e.type))})]})})]}),(0,a.jsx)(n.c,{title:"坡道平面車位坪數散佈分析",description:"建案車位數與坪數分佈",className:"relative z-20",containerRef:m,headerAction:(0,a.jsx)(v.N,{data:B||[],filename:"parking_area_scatter_data",label:"匯出",columns:{id:"建案名稱",label:"標籤",avgArea:"平均坪數",count:"車位數",avgPrice:"平均價格"},chartType:"parking-scatter",targetRef:m,snapshotData:B||[]}),children:(0,a.jsx)(y,{chartData:B,hasData:q,summaryStats:H})}),(0,a.jsx)(n.c,{title:"坡道平面車位 - 樓層價差分析",description:"勾選樓層以動態更新統計數據",containerRef:p,headerAction:(0,a.jsx)(v.N,{data:T||[],filename:"parking_floor_analysis",label:"匯出",columns:{floor:"樓層",count:"數量",avgPrice:"平均價格",medianPrice:"中位數",maxPrice:"最高價",minPrice:"最低價",q3Price:"第三四分位數"},chartType:"parking-floor",targetRef:p,snapshotData:T||[]}),children:(0,a.jsxs)("div",{className:"grid grid-cols-1 lg:grid-cols-2 gap-8",children:[(0,a.jsxs)("div",{className:"flex flex-col items-center justify-center p-8 bg-zinc-900/10 rounded-xl relative overflow-visible min-h-[450px]",children:[(0,a.jsx)("div",{className:"absolute inset-0 bg-gradient-to-b from-zinc-900/0 via-zinc-900/20 to-zinc-900/0 pointer-events-none"}),(0,a.jsx)(h,{data:T,selectedFloors:t,hoveredFloor:i,onHover:o,onToggle:L,onDetail:_,floorColors:O}),(0,a.jsx)("div",{className:"absolute bottom-4 left-0 w-full text-center text-zinc-600 text-xs pointer-events-none",children:"點擊方塊選取 • 懸停查看詳情"})]}),(0,a.jsxs)(j.a,{isOpen:u,onClose:()=>N(!1),title:`${w} 車位交易明細`,maxWidth:"max-w-5xl",children:[(0,a.jsx)("div",{className:"space-y-4",children:(0,a.jsxs)("div",{className:"flex items-center gap-2 bg-zinc-800/50 p-1 rounded-lg border border-white/10",children:[(0,a.jsxs)("button",{onClick:()=>A(!1),className:(0,c.cn)("px-3 py-1.5 rounded text-xs transition-colors font-medium flex items-center gap-1.5",P?"text-zinc-500 hover:text-zinc-300 hover:bg-white/5":"bg-cyan-500/20 text-cyan-400 border border-cyan-500/30 shadow-[0_0_10px_rgba(34,211,238,0.1)]"),children:[(0,a.jsx)(f.A,{size:12}),"精確匹配 (",M,")"]}),(0,a.jsxs)("button",{onClick:()=>A(!0),className:(0,c.cn)("px-3 py-1.5 rounded text-xs transition-colors font-medium",P?"bg-rose-500/20 text-rose-400 border border-rose-500/30 shadow-[0_0_10px_rgba(244,63,94,0.1)]":"text-zinc-500 hover:text-zinc-300 hover:bg-white/5"),children:["未匹配 (",k.length-M,")"]}),(0,a.jsx)("div",{className:"ml-auto",children:(0,a.jsx)(v.N,{data:k.filter(e=>P?!e._isMatch:e._isMatch),filename:`parking_details_${w}_${P?"all":"match"}`,label:"匯出明細"})})]})}),(0,a.jsx)("div",{className:"overflow-x-auto rounded-lg border border-white/10 max-h-[60vh] custom-scrollbar",children:(0,a.jsxs)("table",{className:"w-full text-sm text-left",children:[(0,a.jsx)("thead",{className:"bg-zinc-900/80 text-zinc-400 whitespace-nowrap sticky top-0 z-10 backdrop-blur-md",children:(0,a.jsxs)("tr",{children:[(0,a.jsx)("th",{className:"p-3",children:"建案名稱"}),(0,a.jsx)("th",{className:"p-3",children:"交易日期"}),(0,a.jsx)("th",{className:"p-3 text-right",children:"車位總價"}),(0,a.jsx)("th",{className:"p-3 text-right",children:"車位面積"}),(0,a.jsx)("th",{className:"p-3",children:"車位樓層"}),(0,a.jsx)("th",{className:"p-3",children:"備註"})]})}),(0,a.jsx)("tbody",{className:"divide-y divide-white/5",children:k.length>0?k.filter(e=>P?!e._isMatch:e._isMatch).map((e,t)=>(0,a.jsxs)("tr",{className:(0,c.cn)("hover:bg-zinc-800/50 transition-colors",e._isMatch?"bg-cyan-500/5":"opacity-60"),children:[(0,a.jsxs)("td",{className:"p-3 font-medium text-white",children:[(0,a.jsx)("div",{children:e["建案名稱"]}),(0,a.jsxs)("div",{className:"text-[10px] text-zinc-600 font-mono mt-0.5",children:["#",e.transactionId||e["編號"]]})]}),(0,a.jsxs)("td",{className:"p-3 text-zinc-400 flex items-center gap-1",children:[(0,a.jsx)(g.A,{size:12,className:"text-zinc-600"}),e["交易日"]]}),(0,a.jsxs)("td",{className:"p-3 text-right font-mono text-cyan-400",children:[e["車位總價元"]?(e["車位總價元"]/1e4).toLocaleString():"-"," 萬"]}),(0,a.jsxs)("td",{className:"p-3 text-right font-mono text-zinc-300",children:[e["車位移轉總面積平方公尺"]?(.3025*e["車位移轉總面積平方公尺"]).toFixed(2):"-"," 坪"]}),(0,a.jsx)("td",{className:"p-3 text-zinc-300",children:e["車位所在樓層"]||"-"}),(0,a.jsx)("td",{className:"p-3 text-zinc-500 text-xs max-w-[200px] truncate",title:e["備註"],children:e["備註"]})]},t)):(0,a.jsx)("tr",{children:(0,a.jsx)("td",{colSpan:6,className:"p-8 text-center text-zinc-500",children:"查無相關交易資料。"})})})]})})]}),(0,a.jsxs)("div",{className:"space-y-4",children:[(0,a.jsxs)("div",{className:"p-4 bg-gradient-to-r from-cyan-500/10 to-violet-500/10 border border-cyan-500/30 rounded-lg",children:[(0,a.jsx)("h4",{className:"text-sm font-medium text-cyan-400 mb-3",children:"已選樓層統計"}),(0,a.jsxs)("div",{className:"grid grid-cols-2 md:grid-cols-4 gap-4",children:[(0,a.jsxs)("div",{children:[(0,a.jsx)("div",{className:"text-xs text-zinc-500",children:"車位數"}),(0,a.jsx)("div",{className:"text-lg font-bold text-white",children:D.count.toLocaleString()})]}),(0,a.jsxs)("div",{children:[(0,a.jsx)("div",{className:"text-xs text-zinc-500",children:"平均單價"}),(0,a.jsxs)("div",{className:"text-lg font-bold text-cyan-400",children:[Math.round(D.avgPrice).toLocaleString()," 萬"]})]}),(0,a.jsxs)("div",{children:[(0,a.jsx)("div",{className:"text-xs text-zinc-500",children:"中位數"}),(0,a.jsxs)("div",{className:"text-lg font-bold text-zinc-300",children:[Math.round(D.medianPrice).toLocaleString()," 萬"]})]}),(0,a.jsxs)("div",{children:[(0,a.jsx)("div",{className:"text-xs text-zinc-500",children:"3/4位數"}),(0,a.jsxs)("div",{className:"text-lg font-bold text-zinc-300",children:[Math.round(D.q3Price).toLocaleString()," 萬"]})]})]})]}),(0,a.jsx)("div",{className:"overflow-x-auto",children:(0,a.jsxs)("table",{className:"w-full text-sm",children:[(0,a.jsx)("thead",{className:"bg-zinc-900/50 text-zinc-500",children:(0,a.jsxs)("tr",{children:[(0,a.jsx)("th",{className:"p-2 text-left",children:(0,a.jsxs)("label",{className:"flex items-center gap-2 cursor-pointer",children:[(0,a.jsx)("input",{type:"checkbox",checked:t.length===E.length,onChange:I,className:"form-checkbox rounded bg-zinc-800 border-zinc-600 text-cyan-500"}),(0,a.jsx)("span",{children:"全選"})]})}),(0,a.jsx)("th",{className:"p-2 text-left",children:"樓層"}),(0,a.jsx)("th",{className:"p-2 text-right",children:"均價(萬)"}),(0,a.jsx)("th",{className:"p-2 text-right",children:"中位數"}),(0,a.jsx)("th",{className:"p-2 text-right",children:"最高"}),(0,a.jsx)("th",{className:"p-2 text-right",children:"最低"}),(0,a.jsx)("th",{className:"p-2 text-right",children:"車位數"}),(0,a.jsx)("th",{className:"p-2 text-center",children:"操作"})]})}),(0,a.jsx)("tbody",{className:"divide-y divide-white/5",children:T.map(e=>{let s=t.includes(e.floor),r=i===e.floor;return(0,a.jsxs)("tr",{onMouseEnter:()=>o(e.floor),onMouseLeave:()=>o(null),className:(0,c.cn)("transition-colors cursor-pointer",r?"bg-zinc-800":"hover:bg-zinc-800/50",!s&&"opacity-50"),onClick:()=>L(e.floor),children:[(0,a.jsx)("td",{className:"p-2",children:(0,a.jsx)("input",{type:"checkbox",checked:s,onChange:()=>L(e.floor),className:"form-checkbox rounded bg-zinc-800 border-zinc-600 text-cyan-500",onClick:e=>e.stopPropagation()})}),(0,a.jsx)("td",{className:"p-2 font-medium",children:(0,a.jsxs)("div",{className:"flex items-center gap-2",children:[(0,a.jsx)("span",{className:"w-3 h-3 rounded-full",style:{backgroundColor:O[e.floor]}}),e.floor]})}),(0,a.jsx)("td",{className:"p-2 text-right font-mono text-cyan-400",children:Math.round(e.avgPrice).toLocaleString()}),(0,a.jsx)("td",{className:"p-2 text-right font-mono text-zinc-300",children:Math.round(e.medianPrice).toLocaleString()}),(0,a.jsx)("td",{className:"p-2 text-right font-mono text-zinc-500",children:Math.round(e.maxPrice).toLocaleString()}),(0,a.jsx)("td",{className:"p-2 text-right font-mono text-zinc-500",children:Math.round(e.minPrice).toLocaleString()}),(0,a.jsx)("td",{className:"p-2 text-right font-mono text-zinc-500",children:e.count.toLocaleString()}),(0,a.jsx)("td",{className:"p-2 text-center",children:(0,a.jsx)("button",{onClick:t=>{t.stopPropagation(),_(e.floor)},className:"p-1.5 rounded-full hover:bg-cyan-500/20 text-zinc-400 hover:text-cyan-400 transition-colors",title:"查看明細",children:(0,a.jsx)(b.A,{size:14})})})]},e.floor)})})]})})]})]})})]})}},48551:(e,t,s)=>{s.d(t,{K:()=>o});var a=s(95155),r=s(12115),n=s(88743),i=s(80642),l=s(39430),c=s(40980);function o(){let{selectedRoomTypes:e,setSelectedRoomTypes:t}=(0,n.P)(),[s,o]=(0,r.useState)(!1),[d,x]=(0,r.useState)(!1);return(0,r.useEffect)(()=>{let e=()=>{let e=document.getElementById("room-type-filter-anchor");e&&o(e.getBoundingClientRect().bottom<80)};return window.addEventListener("scroll",e),e(),()=>window.removeEventListener("scroll",e)},[]),(0,r.useEffect)(()=>{let e=document.querySelector("aside");if(!e)return;let t=()=>x(!0),s=()=>x(!1);return e.addEventListener("mouseenter",t),e.addEventListener("mouseleave",s),()=>{e.removeEventListener("mouseenter",t),e.removeEventListener("mouseleave",s)}},[]),(0,a.jsx)(i.N,{children:s&&!d&&(0,a.jsxs)(l.P.div,{initial:{opacity:0,y:20},animate:{opacity:1,y:0},exit:{opacity:0,y:20},transition:{duration:.3},className:(0,c.cn)("fixed z-[90] flex gap-1.5 p-1.5 bg-zinc-900/95 backdrop-blur-md border border-white/10 rounded-xl shadow-xl","flex-row bottom-8 left-1/2 -translate-x-1/2 items-center max-w-[90vw]","md:flex-col md:left-20 md:top-1/2 md:-translate-y-1/2 md:bottom-auto md:translate-x-0 md:items-stretch md:max-w-none"),children:[(0,a.jsx)("div",{className:(0,c.cn)("text-[9px] text-zinc-500 font-medium overflow-hidden","md:writing-mode-vertical md:text-center md:mb-0.5","whitespace-nowrap px-1"),children:"房型"}),(0,a.jsx)("div",{className:"flex md:flex-col gap-1.5 overflow-x-auto md:overflow-visible max-w-full md:max-w-none pb-2 md:pb-0 scrollbar-thumb-zinc-600 pr-8 md:pr-0",children:n.M.map(s=>(0,a.jsx)("button",{onClick:()=>{t(e.includes(s)?e.filter(e=>e!==s):[...e,s])},className:(0,c.cn)("px-2 py-1 text-[10px] font-medium rounded-lg transition-all hover:scale-105 active:scale-95 whitespace-nowrap",e.includes(s)?"bg-violet-500 text-white shadow-lg shadow-violet-500/20":"bg-zinc-800/50 text-zinc-400 hover:bg-zinc-700 hover:text-white"),children:s},s))}),e.length>0&&e.length<n.M.length&&(0,a.jsx)("button",{onClick:()=>t([]),className:(0,c.cn)("text-[9px] text-cyan-400 hover:text-cyan-300 transition-colors whitespace-nowrap px-1","md:mt-1 md:border-t md:border-white/5 md:pt-1 md:text-center md:px-0","border-l border-white/5 pl-1 md:border-l-0 md:pl-0"),children:"清除"})]})})}},52017:(e,t,s)=>{s.d(t,{A:()=>S});var a=s(95155),r=s(12115),n=s(81477),i=s(18460),l=s(40980);let c=(0,i.F)("inline-flex items-center rounded-full border px-2.5 py-0.5 text-xs font-semibold transition-colors focus:outline-none focus:ring-2 focus:ring-ring focus:ring-offset-2",{variants:{variant:{default:"border-transparent bg-primary text-primary-foreground hover:bg-primary/80",secondary:"border-transparent bg-secondary text-secondary-foreground hover:bg-secondary/80",destructive:"border-transparent bg-destructive text-destructive-foreground hover:bg-destructive/80",outline:"text-foreground"}},defaultVariants:{variant:"default"}});function o({className:e,variant:t,...s}){return(0,a.jsx)("div",{className:(0,l.cn)(c({variant:t}),e),...s})}var d=s(58742),x=s(30122),m=s(85753),h=s(68822),p=s(44071),u=s(9921),f=s(66088),g=s(57420),b=s(69220),j=s(22651),v=s(64479),N=s(9505),y=s(89733),w=s(72264),z=s(60529);let k=r.forwardRef(({className:e,...t},s)=>(0,a.jsx)("label",{ref:s,className:(0,l.cn)("text-sm font-medium leading-none peer-disabled:cursor-not-allowed peer-disabled:opacity-70",e),...t}));function S({data:e}){let t=(0,r.useMemo)(()=>{if(!e)return[];let t=new Set;return e.forEach(e=>{e["建案名稱"]&&t.add(e["建案名稱"])}),Array.from(t).map(e=>({value:e,label:e}))},[e]),[s,i]=(0,r.useState)([]),[c,S]=(0,r.useState)(null),[P,A]=(0,r.useState)(null),M=[{label:"2年/行",yearsPerRow:2},{label:"1年/行",yearsPerRow:1},{label:"6月/行",yearsPerRow:.5},{label:"3月/行",yearsPerRow:.25}],[C,_]=(0,r.useState)(0),$=M[C],R=$.yearsPerRow,[F,E]=(0,r.useState)(!1),[T,D]=(0,r.useState)(null),[L,I]=(0,r.useState)({}),[O,B]=(0,r.useState)(!0),[H,q]=(0,r.useState)(!0),[W,Z]=(0,r.useState)(null),[G,Y]=(0,r.useState)(null),U=(0,r.useMemo)(()=>{if(0===s.length||!e||0===e.length)return[];let t={};return e.forEach(e=>{let a=e["建案名稱"];if(!a||!s.includes(a))return;let r=new Date(e["交易日"]).getTime();isNaN(r)||(t[a]||(t[a]=[]),t[a].push(r))}),Object.entries(t).map(([e,t])=>{let s=Math.min(...t),a=Math.max(...t);return{name:e,start:new Date(s),end:new Date(a),startStr:new Date(s).toISOString().slice(0,10),endStr:new Date(a).toISOString().slice(0,10),count:t.length}}).sort((e,t)=>e.start.getTime()-t.start.getTime()).slice(0,10)},[e,s]),K=(0,r.useMemo)(()=>{let e=W??2012,t=new Date().getFullYear();if(U.length>0&&(t=Math.max(t,Math.max(...U.map(e=>e.end.getFullYear()))+1)),null!==G)t=G;else{let e=new Date().getFullYear();t=t>e?Math.max(e,t):e}return{start:new Date(`${e}-01-01`),end:new Date(`${t}-12-31`),totalMonths:(t-e+1)*12}},[U,W,G]),V=[16,-16,32,-32],X=K.start.getFullYear(),Q=Math.ceil((K.end.getFullYear()-X+1)/R),J=(0,r.useMemo)(()=>Array.from({length:Q}).map((e,t)=>{let s=t*R,a=(t+1)*R,r=new Date(X,0,1),n=new Date(X,0,1),i=Math.floor(12*s),l=Math.floor(12*a);r.setMonth(r.getMonth()+i),n.setMonth(n.getMonth()+l);let c=new Date(n);return c.setDate(c.getDate()-1),{startYear:r.getFullYear(),endYear:c.getFullYear(),startStr:r.toISOString().slice(0,7),endStr:c.toISOString().slice(0,7),start:r,end:n}}),[Q,R,X]),ee=24*(U.length>0),et=(0,r.useMemo)(()=>{if(null===T||T<0||T>=J.length)return null;let e=J[T],t=e.start.getTime(),s=e.end.getTime(),a=s-t,r=U.filter(e=>Math.max(e.start.getTime(),t)<Math.min(e.end.getTime(),s)),n=[],i=r.map((e,r)=>{let i=Math.max(e.start.getTime(),t),l=Math.min(e.end.getTime(),s),c=n.findIndex(e=>e<i);-1===c?(c=n.length,n.push(l)):n[c]=l;let o=(l-i)/a*100;return{...e,laneIndex:c,startPct:(i-t)/a*100,widthPct:o,originalIndex:r}});return{maxLanes:n.length,items:i}},[T,J,U]),es=(0,r.useMemo)(()=>Array.from({length:Q}).map((e,t)=>t===T&&et?Math.max(72,116+36*et.maxLanes):72),[Q,T,et]),ea=(0,r.useMemo)(()=>{let e=24;return es.map(t=>{let s=e;return e+=t,s})},[es]),er=es.reduce((e,t)=>e+t,0),en=Math.max(24+er+80,24+er+ee+36*U.length+60),ei=(0,r.useMemo)(()=>d.z.filter(e=>{let t=new Date(e.date);return!!(t>=K.start&&t<=K.end)&&("finance"!==e.category||!!O)&&("policy"!==e.category||!!H)}),[K,O,H]),el=(0,r.useMemo)(()=>{let e=Array.from({length:Q},()=>[]);ei.forEach((t,s)=>{let a=new Date(t.date),r=J.findIndex(e=>a>=e.start&&a<e.end);r<0&&(a.getTime(),J[J.length-1].end.getTime(),r=Q-1),e[r].push({index:s,date:a})});let t=Array(ei.length),s=e=>Math.min(.6,Math.max(0,e/365*.18));return e.forEach((e,a)=>{if(e.sort((e,t)=>e.date.getTime()-t.date.getTime()),0===e.length)return;let r=0;for(let t=1;t<e.length;t+=1)r+=s(Math.max(0,(e[t].date.getTime()-e[t-1].date.getTime())/864e5));let n=e.length+r,i=0,l=[-999,-999,-999,-999];e.forEach((r,c)=>{if(c>0){let t=Math.max(0,(r.date.getTime()-e[c-1].date.getTime())/864e5);i+=s(t)}i+=1;let o=n>0?(i-.5)/n:0,d=100*o,x=d-6,m=-1;for(let e=0;e<4;e++)if(l[e]+2<x){m=e;break}-1===m&&(m=l.indexOf(Math.min(...l))),l[m]=d+6,t[r.index]={rowIndex:a,posInRow:c,densityPos:o,laneIndex:m}})}),t},[ei,J,Q]),ec=(0,r.useMemo)(()=>ei.slice().reverse().map(e=>({日期:e.date,標題:e.title,類別:"finance"===e.category?"金融":"政策",影響:e.impact,變革內容:e.change_content,影響對象:e.affected_scope})),[ei]),eo=c&&P&&P.id!==c.id?P:null,ed=!!eo,ex=e=>{if(F&&c){e.id===c.id?A(null):A(e),E(!1);return}S(e),P?.id===e.id&&A(null)},em=()=>{c&&eo&&(S(eo),A(c))},eh=(e,t)=>{let s=!!L[e.id],r="primary"===t;return(0,a.jsx)("div",{className:"border border-white/10 bg-black/45 backdrop-blur-lg p-6 rounded-xl animate-in fade-in slide-in-from-top-4 shadow-2xl shadow-black/50",children:(0,a.jsxs)("div",{className:"flex flex-col gap-6",children:[(0,a.jsxs)("div",{className:"flex items-start justify-between border-b border-white/5 pb-4",children:[(0,a.jsxs)("div",{className:"space-y-2",children:[(0,a.jsxs)("div",{className:"flex items-center gap-2",children:[(0,a.jsx)("span",{className:(0,l.cn)("text-[10px] uppercase tracking-wider px-2 py-0.5 rounded border",r?"border-cyan-500/40 text-cyan-300 bg-cyan-500/10":"border-emerald-500/40 text-emerald-300 bg-emerald-500/10"),children:r?"主事件":"對照事件"}),(0,a.jsx)("span",{className:"text-zinc-400 font-mono text-xs",children:e.date})]}),(0,a.jsx)("div",{className:"flex items-center gap-3",children:(0,a.jsx)(o,{variant:"outline",className:(0,l.cn)("text-sm px-3 py-1","finance"===e.category?"bg-emerald-500/10 text-emerald-400 border-emerald-500/30":"bg-rose-500/10 text-rose-400 border-rose-500/30"),children:"finance"===e.category?"金融事件":"房市政策"})}),(0,a.jsx)("h3",{className:"text-2xl font-bold text-white tracking-tight",children:e.title})]}),(0,a.jsxs)("div",{className:"flex flex-col items-end gap-2",children:[(0,a.jsxs)("div",{className:(0,l.cn)("px-3 py-1 rounded-full text-xs font-medium border","high"===e.impact?"bg-red-500/10 text-red-400 border-red-500/30":"bg-yellow-500/10 text-yellow-400 border-yellow-500/30"),children:["影響程度: ","high"===e.impact?"高":"medium"===e.impact?"中":"低"]}),r?(0,a.jsxs)("div",{className:"flex items-center gap-2",children:[ed&&(0,a.jsx)("button",{onClick:em,className:"text-[11px] px-2 py-1 rounded border border-white/10 text-zinc-300 hover:text-white hover:border-white/30 transition-colors",children:"對調"}),ed?(0,a.jsx)("button",{onClick:()=>A(null),className:"text-[11px] px-2 py-1 rounded border border-white/10 text-zinc-300 hover:text-white hover:border-white/30 transition-colors",children:"清除對照"}):(0,a.jsx)("button",{onClick:()=>E(!0),className:"text-[11px] px-2 py-1 rounded border border-cyan-500/30 text-cyan-300 hover:text-white hover:border-cyan-400/60 transition-colors",children:"選對照事件"})]}):(0,a.jsx)("button",{onClick:()=>A(null),className:"text-[11px] px-2 py-1 rounded border border-white/10 text-zinc-300 hover:text-white hover:border-white/30 transition-colors",children:"移除對照"})]})]}),(0,a.jsxs)("div",{className:"grid grid-cols-1 gap-8",children:[(0,a.jsxs)("div",{className:"space-y-6",children:[(0,a.jsxs)("div",{children:[(0,a.jsxs)("h4",{className:"text-sm font-bold text-zinc-500 uppercase tracking-wider mb-2 flex items-center gap-2",children:[(0,a.jsx)(h.A,{className:"w-4 h-4"})," 政策/事件內容"]}),(0,a.jsx)("p",{className:"text-zinc-200 text-base leading-relaxed bg-black/40 p-4 rounded-lg border border-white/5",children:e.description})]}),(0,a.jsxs)("div",{children:[(0,a.jsxs)("h4",{className:"text-sm font-bold text-zinc-500 uppercase tracking-wider mb-2 flex items-center gap-2",children:[(0,a.jsx)(m.A,{className:"w-4 h-4"})," 具體規範變革"]}),(0,a.jsx)("div",{className:"bg-black/40 p-4 rounded-lg border border-white/5 text-cyan-400 font-medium",children:e.change_content||"無具體規範變更"})]})]}),(0,a.jsxs)("div",{className:"space-y-6",children:[(0,a.jsxs)("div",{children:[(0,a.jsxs)("h4",{className:"text-sm font-bold text-zinc-500 uppercase tracking-wider mb-2 flex items-center gap-2",children:[(0,a.jsx)(x.A,{className:"w-4 h-4"})," 時代背景與金融環境"]}),(0,a.jsx)("p",{className:"text-zinc-300 text-sm leading-relaxed bg-black/30 p-4 rounded-lg border border-white/5",children:e.background||"尚無背景資料"})]}),(0,a.jsxs)("div",{children:[(0,a.jsxs)("h4",{className:"text-sm font-bold text-zinc-500 uppercase tracking-wider mb-2 flex items-center gap-2",children:[(0,a.jsx)(p.A,{className:"w-4 h-4"})," 受眾影響分析"]}),(0,a.jsxs)("div",{className:"relative overflow-hidden rounded-lg border border-white/10 bg-gradient-to-br from-indigo-500/10 to-purple-500/10 p-4",children:[(0,a.jsx)("div",{className:"absolute top-0 right-0 p-2 opacity-10",children:(0,a.jsx)(p.A,{className:"w-24 h-24"})}),(0,a.jsxs)("div",{className:"relative z-10",children:[(0,a.jsxs)("p",{className:"text-indigo-300 font-medium mb-2 text-xs uppercase",children:["影響對象: ",e.affected_scope]}),(0,a.jsx)("p",{className:"text-white text-sm leading-relaxed",children:e.impact_analysis||"尚無詳細分析"})]})]})]})]})]}),e.details&&e.details.length>0&&(0,a.jsxs)("div",{className:"border-t border-white/5 pt-4",children:[(0,a.jsx)("button",{onClick:()=>{var t;return t=e.id,void I(e=>({...e,[t]:!e[t]}))},className:"flex items-center gap-2 text-sm text-zinc-400 hover:text-white transition-colors w-full justify-center py-2",children:s?(0,a.jsxs)(a.Fragment,{children:[(0,a.jsx)(u.A,{className:"w-4 h-4"})," 收起完整規範細節"]}):(0,a.jsxs)(a.Fragment,{children:[(0,a.jsx)(f.A,{className:"w-4 h-4"})," 展開完整規範細節 (",e.details.length," 項)"]})}),s&&(0,a.jsx)("div",{className:"mt-4 grid grid-cols-1 gap-4 animate-in fade-in slide-in-from-top-2",children:e.details.map((e,t)=>(0,a.jsxs)("div",{className:"flex items-start gap-3 bg-black/40 p-3 rounded border border-zinc-800 text-sm text-zinc-300",children:[(0,a.jsx)("span",{className:"flex items-center justify-center w-5 h-5 rounded-full bg-zinc-800 text-zinc-500 text-xs shrink-0 mt-0.5",children:t+1}),(0,a.jsx)("span",{children:e})]},t))})]})]})})};return(0,a.jsxs)(n.Zp,{className:"w-full bg-black/40 border-zinc-800 backdrop-blur-xl",children:[(0,a.jsxs)(n.aR,{children:[(0,a.jsxs)(n.ZB,{className:"flex items-center gap-2 text-xl font-bold text-transparent bg-clip-text bg-gradient-to-r from-cyan-400 to-purple-400",children:[(0,a.jsx)(g.A,{className:"w-6 h-6 text-cyan-500"}),"房市政策時光機"]}),(0,a.jsx)(n.BT,{className:"text-zinc-400",children:"建案銷售期間與重大政策/金融事件的交叉比對"})]}),(0,a.jsxs)(n.Wu,{children:[(0,a.jsxs)("div",{className:"flex flex-col md:flex-row items-start md:items-end justify-between mb-6 px-2 gap-4",children:[(0,a.jsx)("div",{className:"w-full md:w-1/2 lg:w-1/3",children:(0,a.jsx)(N.l,{projects:t,onChange:i,title:"選擇建案 (顯示銷售區間)",placeholder:"搜尋建案以顯示在時間軸...",max:6})}),(0,a.jsxs)("div",{className:"flex items-center justify-between w-full md:w-auto gap-4",children:[(0,a.jsxs)("div",{className:"flex items-center gap-2 bg-black/20 rounded-lg p-1 border border-white/5",children:[(0,a.jsx)("button",{onClick:()=>_(e=>Math.max(0,e-1)),disabled:0===C,className:"p-1.5 hover:bg-white/10 rounded-md text-zinc-400 hover:text-white transition-colors disabled:opacity-30",children:(0,a.jsx)(b.A,{className:"w-4 h-4"})}),(0,a.jsx)("span",{className:"text-xs font-mono text-zinc-500 w-16 text-center",children:$.label}),(0,a.jsx)("button",{onClick:()=>_(e=>Math.min(M.length-1,e+1)),disabled:C===M.length-1,className:"p-1.5 hover:bg-white/10 rounded-md text-zinc-400 hover:text-white transition-colors disabled:opacity-30",children:(0,a.jsx)(j.A,{className:"w-4 h-4"})})]}),(0,a.jsxs)(w.rI,{children:[(0,a.jsx)(w.ty,{asChild:!0,children:(0,a.jsx)("button",{className:"p-2 bg-black/20 hover:bg-white/10 border border-white/5 rounded-lg text-zinc-400 hover:text-white transition-colors",children:(0,a.jsx)(v.A,{className:"w-4 h-4"})})}),(0,a.jsxs)(w.SQ,{align:"end",className:"w-64 bg-zinc-950 border-zinc-800 text-zinc-200",children:[(0,a.jsx)(w.lp,{children:"顯示設定"}),(0,a.jsx)(w.mB,{className:"bg-zinc-800"}),(0,a.jsxs)(w.hO,{checked:H,onCheckedChange:q,className:"focus:bg-zinc-800 focus:text-white",children:[(0,a.jsx)("span",{className:"w-2 h-2 rounded-full bg-rose-500 mr-2"}),"房市政策"]}),(0,a.jsxs)(w.hO,{checked:O,onCheckedChange:B,className:"focus:bg-zinc-800 focus:text-white",children:[(0,a.jsx)("span",{className:"w-2 h-2 rounded-full bg-emerald-500 mr-2"}),"金融事件"]}),(0,a.jsx)(w.mB,{className:"bg-zinc-800"}),(0,a.jsx)(w.lp,{children:"時間範圍"}),(0,a.jsxs)("div",{className:"p-2 space-y-3",children:[(0,a.jsxs)("div",{className:"grid grid-cols-[1fr_auto] gap-2 items-center",children:[(0,a.jsx)(k,{htmlFor:"start-year",className:"text-xs text-zinc-500",children:"起始年"}),(0,a.jsx)(z.p,{id:"start-year",type:"number",className:"h-7 w-20 text-xs bg-zinc-900 border-zinc-700 focus-visible:ring-zinc-600",placeholder:"2012",value:W??"",onChange:e=>{Z(e.target.value?parseInt(e.target.value):null)}})]}),(0,a.jsxs)("div",{className:"grid grid-cols-[1fr_auto] gap-2 items-center",children:[(0,a.jsx)(k,{htmlFor:"end-year",className:"text-xs text-zinc-500",children:"結束年"}),(0,a.jsx)(z.p,{id:"end-year",type:"number",className:"h-7 w-20 text-xs bg-zinc-900 border-zinc-700 focus-visible:ring-zinc-600",placeholder:"Auto",value:G??"",onChange:e=>{Y(e.target.value?parseInt(e.target.value):null)}})]})]})]})]}),(0,a.jsxs)("div",{className:"flex items-center gap-3 text-xs text-zinc-500",children:[(0,a.jsxs)("div",{className:"flex items-center gap-1.5",children:[(0,a.jsx)("div",{className:"w-2 h-2 rounded-full bg-emerald-500"})," 金融事件"]}),(0,a.jsxs)("div",{className:"flex items-center gap-1.5",children:[(0,a.jsx)("div",{className:"w-2 h-2 rounded-full bg-rose-500"})," 房市政策"]})]})]})]}),F&&(0,a.jsxs)("div",{className:"mb-4 mx-2 text-xs text-amber-300 bg-amber-500/10 border border-amber-500/30 rounded-lg px-3 py-2 flex items-center justify-between",children:[(0,a.jsx)("span",{children:"對照選取中：請點選時間軸或表格的另一筆事件。"}),(0,a.jsx)("button",{onClick:()=>E(!1),className:"text-amber-200 hover:text-white transition-colors",children:"取消"})]}),(0,a.jsxs)("div",{className:"space-y-8",children:[(0,a.jsxs)("div",{className:"grid grid-cols-1 xl:grid-cols-[1fr_450px] gap-16 items-start",children:[(0,a.jsx)("div",{className:"relative w-full",children:(0,a.jsx)("div",{className:"relative w-full overflow-x-hidden pb-12 pt-8",children:(0,a.jsxs)("div",{className:"relative ml-16 border-b border-zinc-800 transition-all duration-300 ease-out cursor-default",style:{width:"90%",minWidth:"90%",height:`${en}px`,paddingRight:"140px"},onClick:()=>{S(null),A(null),E(!1)},children:[(0,a.jsx)("div",{className:"absolute inset-0 z-10",children:J.map((e,t)=>{let s=ea[t],r=s+36,n=t===T,i=e.start.getTime(),c=e.end.getTime(),o=c-i;return(0,a.jsxs)("div",{className:"group/row",onClick:e=>{D(e=>e===t?null:t)},children:[(0,a.jsx)("div",{className:(0,l.cn)("absolute left-0 right-0 transition-colors duration-200 pointer-events-auto cursor-pointer",n?"bg-white/5":"hover:bg-white/5"),style:{top:`${s}px`,height:`${es[t]}px`}}),(0,a.jsx)("div",{className:"absolute left-0 right-0 h-px bg-zinc-700/60 pointer-events-none",style:{top:`${r}px`}}),n&&et&&(0,a.jsx)("div",{className:"absolute left-0 right-0 pointer-events-none",style:{top:`${r+60}px`,bottom:0},children:et.items.map(e=>{let t=["bg-cyan-600 border-cyan-400 text-white","bg-violet-600 border-violet-400 text-white","bg-amber-600 border-amber-400 text-white","bg-emerald-600 border-emerald-400 text-white","bg-pink-600 border-pink-400 text-white"],s=t[U.findIndex(t=>t.name===e.name)%t.length];return(0,a.jsxs)("div",{className:(0,l.cn)("absolute h-7 rounded-md flex items-center px-3 text-xs font-bold whitespace-nowrap overflow-hidden shadow-lg border transition-transform hover:scale-[1.02] z-30",s),style:{left:`${e.startPct}%`,width:`${Math.max(.5,e.widthPct)}%`,top:`${36*e.laneIndex}px`},children:[(0,a.jsx)("span",{className:"mr-2",children:e.name}),(0,a.jsxs)("span",{className:"opacity-80 text-[10px] font-normal",children:[e.startStr," ~ ",e.endStr]})]},`stack-${e.name}-${e.originalIndex}`)})}),R<=1&&(0,a.jsx)(a.Fragment,{children:Array.from({length:e.endYear-e.startYear+1}).flatMap((t,s)=>{let a=e.startYear+s,r=[];if(R<=1&&r.push({m:6,d:1,label:"7/1",major:!0}),R<=.5&&(r.push({m:3,d:1,label:"4/1",major:!0}),r.push({m:9,d:1,label:"10/1",major:!0})),R<=.25)for(let e=1;e<12;e++)3!==e&&6!==e&&9!==e&&r.push({m:e,d:1,label:`${e+1}/1`,major:!1});return r.map(e=>{let t=new Date(a,e.m,e.d).getTime();return{...e,dateMs:t,year:a}})}).map((e,t)=>{if(e.dateMs>=i&&e.dateMs<=c){let t=(e.dateMs-i)/o*100,s=e.major;return(0,a.jsx)("div",{className:(0,l.cn)("absolute flex flex-col items-center justify-end group",s?"h-3 w-px bg-zinc-600":"h-2 w-px bg-zinc-700/50"),style:{left:`${t}%`,top:`${r-(s?5:4)}px`},children:(0,a.jsx)("span",{className:(0,l.cn)("font-mono -mt-4 transition-opacity",s?"text-[8px] text-zinc-500 opacity-60 group-hover:opacity-100":"text-[7px] text-zinc-700 opacity-0 group-hover:opacity-100"),children:e.label})},`mk-${e.year}-${e.m}`)}return null})}),!n&&(()=>{let e=U.filter(e=>Math.max(e.start.getTime(),i)<Math.min(e.end.getTime(),c));if(0===e.length)return null;let s=e.map(e=>({start:Math.max(e.start.getTime(),i),end:Math.min(e.end.getTime(),c)})).sort((e,t)=>e.start-t.start),n=[];if(s.length>0){let e=s[0];for(let t=1;t<s.length;t++)s[t].start<e.end?e.end=Math.max(e.end,s[t].end):(n.push(e),e=s[t]);n.push(e)}return n.map((e,s)=>{let n=(e.start-i)/o*100,l=(e.end-e.start)/o*100;return(0,a.jsx)("div",{className:"absolute h-1.5 bg-cyan-400 rounded-full shadow-[0_0_8px_rgba(34,211,238,0.6)] z-20 pointer-events-none",style:{left:`${n}%`,width:`${Math.max(.5,l)}%`,top:`${r}px`,marginTop:"-3px"}},`summary-${t}-${s}`)})})(),(0,a.jsx)("div",{className:"absolute text-[10px] font-mono text-zinc-500",style:{top:`${r-22}px`,left:"16px"},children:R<=.5?e.startStr:e.start.getFullYear()}),(0,a.jsx)("div",{className:"absolute text-[10px] font-mono text-zinc-500",style:{top:`${r-22}px`,right:"16px"},children:R<=.5?e.endStr:e.end.getFullYear()})]},`row-${e.startStr}-${e.endStr}`)})}),ei.map((e,t)=>{let s="high"===e.impact,{rowIndex:r,posInRow:n,densityPos:i,laneIndex:o}=el[t]||{rowIndex:0,posInRow:0,densityPos:0,laneIndex:0},d=J[r];if(!d)return null;let p=d.start.getTime(),u=d.end.getTime(),f=new Date(e.date).getTime(),g=u>p?(f-p)/(u-p):0,b=Math.min(95,Math.max(5,100*Math.min(1,Math.max(0,(i??g)*.8+.2*g)))),j=ea[r],v=V[o%V.length],N=v<0,y=Math.max(10,Math.abs(v)-6),w=!1;if(U.length>0){let t=new Date(e.date);w=U.some(e=>t>=e.start&&t<=e.end)}let z=c?.id===e.id,k=P?.id===e.id;return(0,a.jsxs)("div",{className:(0,l.cn)("absolute transform -translate-x-1/2 flex flex-col items-center group cursor-pointer transition-all duration-200 ease-out z-20",z?"scale-[2.0] opacity-100 z-40":k?"scale-[1.8] opacity-100 z-40":w?"scale-100 opacity-90 hover:scale-[2.5] hover:opacity-100 hover:z-50":"scale-75 opacity-50 hover:scale-[2.5] hover:opacity-100 hover:z-50"),style:{left:`${b}%`,top:`${j+36+v}px`},onClick:t=>{t.stopPropagation(),ex(e)},children:[(0,a.jsx)("div",{className:(0,l.cn)("w-px absolute",N?"top-full bg-gradient-to-b":"bottom-full bg-gradient-to-t","from-transparent to-zinc-700"),style:{height:`${y}px`}}),(0,a.jsx)("div",{className:(0,l.cn)("w-3 h-3 rounded-full flex items-center justify-center border shadow-[0_0_10px_rgba(0,0,0,0.5)] transition-all","finance"===e.category?"bg-emerald-950/80 border-emerald-500/50 text-emerald-400 group-hover:shadow-emerald-500/20":"bg-rose-950/80 border-rose-500/50 text-rose-400 group-hover:shadow-rose-500/20",s&&"ring-1 ring-offset-1 ring-offset-black/50 ring-opacity-50","finance"===e.category&&s?"ring-emerald-500":"ring-rose-500",z&&"ring-1 ring-white ring-offset-1 ring-offset-black",!z&&k&&"ring-1 ring-emerald-400/70 ring-offset-1 ring-offset-black/70"),children:(e=>{switch(e){case"finance":return(0,a.jsx)(x.A,{className:"w-2 h-2 text-emerald-400"});case"policy":return(0,a.jsx)(m.A,{className:"w-2 h-2 text-rose-400"});default:return(0,a.jsx)(h.A,{className:"w-2 h-2 text-blue-400"})}})(e.category)}),(0,a.jsx)("div",{className:(0,l.cn)("absolute whitespace-nowrap text-[8px] px-1.5 py-0.5 rounded bg-black/80 border border-zinc-700 backdrop-blur-md transition-all font-medium",N?"-top-7":"-bottom-7",w?"text-white border-yellow-500/50":"text-zinc-400 group-hover:text-white",z&&"text-white border-white/50 bg-zinc-800",!z&&k&&"text-emerald-200 border-emerald-400/50 bg-emerald-950/60"),children:e.title}),(0,a.jsx)("div",{className:(0,l.cn)("absolute whitespace-nowrap text-[6px] font-mono text-zinc-600",N?"top-8":"bottom-8"),children:e.date})]},e.id)})]})})}),c?(0,a.jsx)("aside",{className:"xl:sticky xl:top-24 self-start max-h-[calc(100vh-8rem)] overflow-y-auto pr-1 bg-black/35 border border-white/10 rounded-2xl backdrop-blur-xl shadow-[0_20px_60px_rgba(0,0,0,0.55)] w-full max-w-[420px] justify-self-end",children:(0,a.jsx)("div",{className:"p-4",children:(0,a.jsxs)("div",{className:(0,l.cn)("grid grid-cols-1 gap-4",ed&&"xl:grid-cols-2"),children:[eh(c,"primary"),eo&&eh(eo,"compare")]})})}):(0,a.jsx)("div",{className:"hidden xl:block"})]}),(0,a.jsxs)("div",{className:"border-t border-zinc-800 pt-6",children:[(0,a.jsxs)("div",{className:"flex items-center justify-between mb-4",children:[(0,a.jsxs)("div",{className:"flex items-center gap-2",children:[(0,a.jsx)(p.A,{className:"w-5 h-5 text-purple-400"}),(0,a.jsx)("h3",{className:"text-lg font-bold text-zinc-200",children:"政策影響比較表"})]}),(0,a.jsx)(y.N,{data:ec,filename:"policy_comparison",label:"匯出政策表"})]}),(0,a.jsxs)("div",{className:"rounded-xl border border-white/10 overflow-hidden bg-black/20",children:[(0,a.jsxs)("div",{className:"grid grid-cols-12 gap-4 p-4 bg-zinc-900/50 border-b border-white/5 text-xs font-bold text-zinc-400 uppercase tracking-wider",children:[(0,a.jsx)("div",{className:"col-span-2",children:"實施日期"}),(0,a.jsx)("div",{className:"col-span-3",children:"政策/事件名稱"}),(0,a.jsx)("div",{className:"col-span-4",children:"變革內容 (Before vs After)"}),(0,a.jsx)("div",{className:"col-span-3",children:"影響對象與範圍"})]}),(0,a.jsx)("div",{className:"divide-y divide-white/5 max-h-[400px] overflow-y-auto custom-scrollbar",children:ei.slice().reverse().map(e=>{let t=c?.id===e.id,s=P?.id===e.id&&!t;return(0,a.jsxs)("div",{className:(0,l.cn)("grid grid-cols-12 gap-4 p-4 text-sm transition-colors hover:bg-white/5 cursor-pointer",t?"bg-white/10":"",s?"bg-emerald-500/10":""),onClick:()=>ex(e),children:[(0,a.jsx)("div",{className:"col-span-2 font-mono text-zinc-500",children:e.date}),(0,a.jsxs)("div",{className:"col-span-3 flex items-start gap-2",children:[(0,a.jsx)(o,{variant:"outline",className:(0,l.cn)("shrink-0 mt-0.5","finance"===e.category?"text-emerald-400 border-emerald-500/30":"text-rose-400 border-rose-500/30"),children:"finance"===e.category?"金融":"政策"}),(0,a.jsx)("span",{className:(0,l.cn)("font-medium","high"===e.impact?"text-white":"text-zinc-400"),children:e.title})]}),(0,a.jsx)("div",{className:"col-span-4 text-zinc-300",children:e.change_content?(0,a.jsxs)("div",{className:"flex items-center gap-2",children:[(0,a.jsx)("span",{className:"w-1.5 h-1.5 rounded-full bg-cyan-500 shrink-0"}),e.change_content]}):(0,a.jsx)("span",{className:"text-zinc-600 italic",children:"--"})}),(0,a.jsx)("div",{className:"col-span-3 text-zinc-400",children:e.affected_scope||(0,a.jsx)("span",{className:"text-zinc-600 italic",children:"--"})})]},e.id)})})]})]})]})]})]})}k.displayName="Label"},53812:(e,t,s)=>{s.d(t,{Q:()=>g});var a=s(95155),r=s(12115),n=s(34361),i=s(3083),l=s(4439),c=s(40980);function o({data:e,viewType:t,selectedRooms:s}){if(!e||0===Object.keys(e).length)return(0,a.jsx)("div",{className:"text-zinc-500 text-center p-8",children:"無銷售速度資料"});let n=Object.keys(e).sort().reverse();return(0,a.jsx)("div",{className:"overflow-x-auto max-h-[600px] border border-white/5 rounded-lg",children:(0,a.jsxs)("table",{className:"w-full text-sm text-left border-collapse",children:[(0,a.jsxs)("thead",{className:"bg-zinc-900 sticky top-0 z-20 shadow-md",children:[(0,a.jsxs)("tr",{children:[(0,a.jsx)("th",{rowSpan:2,className:"px-4 py-3 sticky left-0 z-30 bg-zinc-900 border-r border-white/10 font-medium text-white min-w-[120px]",children:"時間"}),s.map(e=>(0,a.jsx)("th",{colSpan:3,className:"px-2 py-2 text-center border-l border-white/5 text-zinc-300 font-medium bg-zinc-900/90",children:e},e)),(0,a.jsx)("th",{colSpan:3,className:"px-2 py-2 text-center border-l-2 border-white/10 text-cyan-400 font-bold bg-zinc-900/90",children:"總計"})]}),(0,a.jsxs)("tr",{children:[s.map((e,t)=>(0,a.jsxs)(r.Fragment,{children:[(0,a.jsx)("th",{className:(0,c.cn)("px-2 py-2 text-center text-xs text-zinc-500 font-normal bg-zinc-900/90 border-b border-white/10",0===t&&"border-l border-white/5"),children:"筆數"}),(0,a.jsx)("th",{className:"px-2 py-2 text-center text-xs text-zinc-500 font-normal bg-zinc-900/90 border-b border-white/10",children:"總價(萬)"}),(0,a.jsx)("th",{className:"px-2 py-2 text-center text-xs text-zinc-500 font-normal bg-zinc-900/90 border-b border-white/10",children:"坪數"})]},e)),(0,a.jsx)("th",{className:"px-2 py-2 text-center text-xs text-zinc-400 font-medium bg-zinc-900/90 border-b border-white/10 border-l-2 border-white/10",children:"筆數"}),(0,a.jsx)("th",{className:"px-2 py-2 text-center text-xs text-zinc-400 font-medium bg-zinc-900/90 border-b border-white/10",children:"總價(萬)"}),(0,a.jsx)("th",{className:"px-2 py-2 text-center text-xs text-zinc-400 font-medium bg-zinc-900/90 border-b border-white/10",children:"坪數"})]})]}),(0,a.jsx)("tbody",{className:"divide-y divide-white/5",children:n.map(n=>{let i=e[n]||{},l={count:0,priceSum:0,areaSum:0};return(0,a.jsxs)("tr",{className:"hover:bg-zinc-800/30 transition-colors",children:[(0,a.jsx)("td",{className:"px-4 py-2 sticky left-0 z-10 bg-zinc-950/90 border-r border-white/10 font-mono text-zinc-400",children:("weekly"===t&&n.includes("-W"),n)}),s.map((e,t)=>{let s=i[e];return s?(l.count+=s.count,l.priceSum+=s.priceSum,l.areaSum+=s.areaSum,(0,a.jsxs)(r.Fragment,{children:[(0,a.jsx)("td",{className:(0,c.cn)("px-2 py-2 text-center text-zinc-300",0===t&&"border-l border-white/5"),children:s.count>0?s.count.toLocaleString():"-"}),(0,a.jsx)("td",{className:"px-2 py-2 text-center text-zinc-500 font-mono text-xs",children:s.count>0?(0,c.Z)(s.priceSum,0):"-"}),(0,a.jsx)("td",{className:"px-2 py-2 text-center text-zinc-500 font-mono text-xs",children:s.count>0?(0,c.Z)(s.areaSum,1):"-"})]},e)):(0,a.jsxs)(r.Fragment,{children:[(0,a.jsx)("td",{className:(0,c.cn)("px-2 py-2 text-center text-zinc-700",0===t&&"border-l border-white/5"),children:"-"}),(0,a.jsx)("td",{className:"px-2 py-2 text-center text-zinc-700",children:"-"}),(0,a.jsx)("td",{className:"px-2 py-2 text-center text-zinc-700",children:"-"})]},e)}),(0,a.jsx)("td",{className:"px-2 py-2 text-center font-bold text-cyan-400 border-l-2 border-white/10",children:l.count.toLocaleString()}),(0,a.jsx)("td",{className:"px-2 py-2 text-center font-bold text-zinc-300 font-mono text-xs",children:(0,c.Z)(l.priceSum,0)}),(0,a.jsx)("td",{className:"px-2 py-2 text-center font-bold text-zinc-300 font-mono text-xs",children:(0,c.Z)(l.areaSum,1)})]},n)})})]})})}var d=s(29991),x=s(60529),m=s(89733),h=s(88743),p=s(48551),u=s(39430),f=s(80642);function g({data:e}){let[t,s]=(0,r.useState)("monthly"),[g,b]=(0,r.useState)("count"),[j,v]=(0,r.useState)(15),[N,y]=(0,r.useState)(65),[w,z]=(0,r.useState)(5),[k,S]=(0,r.useState)([]),[P,A]=(0,r.useState)(null),{selectedRoomTypes:M,setSelectedRoomTypes:C}=(0,h.P)();if(!e)return null;let{salesVelocityAnalysis:_,areaDistributionAnalysis:$}=e,R=e=>Math.round(e)+"萬",F=r.useRef(null),E=r.useRef(null),T=r.useRef(null),D=r.useRef(null);return(0,a.jsxs)("div",{className:"space-y-6 animate-in fade-in slide-in-from-bottom-4 duration-500",children:[(0,a.jsxs)("div",{id:"room-type-filter-anchor",className:"p-4 bg-zinc-900/30 border border-white/5 rounded-lg flex flex-wrap gap-2 items-center scroll-mt-24",children:[(0,a.jsx)("span",{className:"text-zinc-400 text-sm mr-2",children:"分析房型:"}),h.M.map(e=>(0,a.jsx)("button",{onClick:()=>{C(M.includes(e)?M.filter(t=>t!==e):[...M,e])},className:(0,c.cn)("px-3 py-1 text-xs rounded-full border transition-colors",M.includes(e)?"bg-violet-500/20 border-violet-500 text-violet-200":"bg-zinc-800 border-zinc-700 text-zinc-500 hover:bg-zinc-700"),children:e},e))]}),(0,a.jsx)(n.c,{title:"房型銷售速度與趨勢分析",containerRef:E,headerAction:(0,a.jsxs)("div",{className:"flex gap-2",children:[(0,a.jsxs)(d.l,{value:t,onChange:e=>s(e.target.value),className:"w-[100px] h-8 text-xs bg-zinc-950/50",children:[(0,a.jsx)("option",{value:"weekly",children:"每週"}),(0,a.jsx)("option",{value:"monthly",children:"每月"}),(0,a.jsx)("option",{value:"quarterly",children:"每季"})]}),(0,a.jsxs)(d.l,{value:g,onChange:e=>b(e.target.value),className:"w-[100px] h-8 text-xs bg-zinc-950/50",children:[(0,a.jsx)("option",{value:"count",children:"交易筆數"}),(0,a.jsx)("option",{value:"priceSum",children:"總銷金額"}),(0,a.jsx)("option",{value:"areaSum",children:"總銷坪數"})]}),(0,a.jsx)(m.N,{data:_?.[t]||[],filename:`sales_velocity_${t}`,label:"匯出",chartType:"sales-velocity-chart",targetRef:E,snapshotData:_?.[t]||[],columns:{period:"時間區間",count:"交易筆數",priceSum:"總銷金額",areaSum:"總銷坪數"}})]}),children:(0,a.jsx)(i.M,{data:_?.[t]||{},selectedRooms:M,metric:g})}),(0,a.jsx)(n.c,{title:"銷售速度明細表",description:"各時間段詳細銷售數據統計",containerRef:T,headerAction:(0,a.jsx)(m.N,{data:_?.[t],filename:`sales_velocity_table_${t}`,label:"匯出",chartType:"sales-velocity-table",targetRef:T,snapshotData:_?.[t]||[],columns:{period:"時間區間",count:"交易筆數",priceSum:"總銷金額",areaSum:"總銷坪數"}}),children:(0,a.jsx)(o,{data:_?.[t]||[],viewType:t,selectedRooms:M})}),(0,a.jsx)(n.c,{title:"房型面積分佈熱力圖",description:"分析不同坪數區間的產品供給與去化分佈",containerRef:D,headerAction:(0,a.jsxs)("div",{className:"flex gap-2 items-center text-zinc-400 text-xs",children:[(0,a.jsx)("span",{children:"範圍:"}),(0,a.jsx)(x.p,{type:"number",value:j,onChange:e=>v(Number(e.target.value)),className:"w-16 h-8 text-xs bg-zinc-950/50"}),(0,a.jsx)("span",{children:"-"}),(0,a.jsx)(x.p,{type:"number",value:N,onChange:e=>y(Number(e.target.value)),className:"w-16 h-8 text-xs bg-zinc-950/50"}),(0,a.jsx)("span",{className:"ml-2",children:"級距:"}),(0,a.jsx)(x.p,{type:"number",value:w,onChange:e=>z(Number(e.target.value)),step:"0.5",className:"w-16 h-8 text-xs bg-zinc-950/50"}),(0,a.jsx)("div",{className:"border-l border-white/10 h-4 mx-1"}),(0,a.jsx)(m.N,{data:$?Object.entries($).map(([e,t])=>({key:e,value:JSON.stringify(t)})):[],filename:"area_distribution_heatmap",label:"匯出",chartType:"sales-heatmap",targetRef:D,snapshotData:{distribution:$,selectedRooms:M,min:j,max:N,interval:w},columns:{key:"坪數區間",value:"分佈數據"}})]}),children:(0,a.jsxs)("div",{className:(0,c.cn)("flex flex-col lg:flex-row gap-6 relative overflow-hidden items-stretch transition-all duration-300",P?"lg:h-[600px]":"min-h-[500px]"),children:[(0,a.jsx)(u.P.div,{layout:!0,initial:!1,animate:{flex:P?"0 0 60%":"0 0 100%"},transition:{type:"spring",stiffness:300,damping:35,mass:1},onAnimationStart:()=>{},onAnimationComplete:()=>{F.current&&(F.current.style.width="100%",window.dispatchEvent(new Event("resize")))},className:"min-w-0 overflow-hidden h-full flex flex-col",children:(0,a.jsx)("div",{ref:F,className:"w-full h-full flex flex-col",children:(0,a.jsx)(l.m,{data:$||{},selectedRooms:M,minArea:j,maxArea:N,interval:w,onDataPointClick:(t,s)=>{F.current&&(F.current.style.width=`${F.current.offsetWidth}px`);let a=0,r=1/0;if(s.includes("<"))r=parseFloat(s.replace("<","").trim());else if(s.includes(">"))a=parseFloat(s.replace(">","").trim());else if(s.includes("-")){let e=s.split("-");a=parseFloat(e[0].trim()),r=parseFloat(e[1].trim())}let n=(e.transactionDetails||[]).filter(e=>{let s=function(e){let t=e=>e?String(e).normalize("NFKC").toUpperCase().replace(/\s+/g,""):"",s=t(e["建物型態"]||e.buildingType),a=t(e["主要用途"]||e.mainPurpose),r=t(e["戶別"]||e.unit),n=void 0!==e["房數"]?e["房數"]:e.rooms,i=void 0!==e["房屋面積(坪)"]?parseFloat(e["房屋面積(坪)"]):parseFloat(e.houseArea||0);if(s.includes("住宅大樓")&&r.includes("S")||r.includes("店舖")||r.includes("店面")||r.includes("店鋪"))return"店舖";if(r.includes("事務所")||r.includes("辦公"))return"辦公/事務所";if(s.includes("店舖")||s.includes("店面")||s.includes("店鋪"))return"店舖";if(s.includes("工廠")||s.includes("倉庫")||s.includes("廠辦"))return"廠辦/工廠";if(a.includes("商業")||s.includes("辦公")||s.includes("事務所"))return"辦公/事務所";if((s.includes("住宅大樓")||s.includes("華廈"))&&0===n){if(i>35)return"毛胚";if(i<=35)return"套房"}if("number"==typeof n&&!isNaN(n)){if(1===n)return"1房";if(2===n)return"2房";if(3===n)return"3房";if(4===n)return"4房";if(n>=5)return"5房以上"}return"其他"}(e),n=parseFloat(e["房屋面積(坪)"]||e.houseArea||(e["建物移轉平方公尺"]?.3025*e["建物移移轉平方公尺"]:0));if(!s)return!1;let i=n>=a&&n<r;return s===t&&i});console.log(`[Heatmap Click] Room: ${t}, Range: ${a}-${r}, Found: ${n.length}`);let i={};n.forEach(e=>{let t=e["建案名稱"]||e.projectName||"未知建案";i[t]||(i[t]=[]),i[t].push(e)});let l=Object.entries(i).map(([e,t])=>{let s=t.map(e=>e["產權總價"]||e["交易總價(萬)"]||e.totalPrice||0).filter(e=>e>0).sort((e,t)=>e-t),a=t.map(e=>e["房屋單價"]||e["房屋單價(萬)"]||e.unitPrice||0).filter(e=>e>0),r=0;if(s.length>0){let e=Math.floor(s.length/2);r=s.length%2!=0?s[e]:(s[e-1]+s[e])/2}return{projectName:e,count:t.length,priceRange:{min:s.length>0?s[0]:0,max:s.length>0?s[s.length-1]:0,median:r},unitPriceRange:{min:a.length>0?Math.min(...a):0,max:a.length>0?Math.max(...a):0},transactions:t.sort((e,t)=>{let s=e["房屋單價"]||e["房屋單價(萬)"]||e.unitPrice||0;return(t["房屋單價"]||t["房屋單價(萬)"]||t.unitPrice||0)-s}),isExpanded:!1}});l.sort((e,t)=>t.unitPriceRange.max-e.unitPriceRange.max),S(l),A({roomType:t,areaRange:s,totalCount:n.length})},height:P?"100%":void 0})})}),(0,a.jsx)(f.N,{mode:"wait",children:P&&(0,a.jsxs)(u.P.div,{initial:{opacity:0,x:50,width:0},animate:{opacity:1,x:0,width:"40%"},exit:{opacity:0,x:50,width:0},transition:{type:"spring",stiffness:300,damping:35},className:"flex-1 min-w-0 bg-zinc-900/50 border border-white/10 rounded-lg h-full flex flex-col p-4 overflow-hidden",children:[(0,a.jsxs)("div",{className:"flex justify-between items-start mb-4 pb-4 border-b border-white/5",children:[(0,a.jsxs)("div",{children:[(0,a.jsxs)("h4",{className:"text-white font-medium flex items-center gap-2 text-lg",children:[(0,a.jsx)("span",{className:"text-cyan-400",children:P.roomType}),(0,a.jsx)("span",{className:"text-zinc-500",children:"|"}),(0,a.jsxs)("span",{children:[P.areaRange," 坪"]})]}),(0,a.jsxs)("p",{className:"text-zinc-400 text-xs mt-1",children:["共找到 ",(0,a.jsx)("span",{className:"text-white font-mono",children:k.length})," 個建案",(0,a.jsx)("br",{}),"合計 ",(0,a.jsx)("span",{className:"text-white font-mono",children:P.totalCount})," 筆交易"]})]}),(0,a.jsxs)("div",{className:"flex gap-2 items-center",children:[(0,a.jsxs)("div",{className:"flex gap-1 mr-2",children:[(0,a.jsx)(m.N,{data:k,filename:`heatmap_aggregated_${P.roomType}_${P.areaRange}`,label:"統計",chartType:"sales-heatmap-detail",snapshotData:k,className:"whitespace-nowrap px-3 py-1 text-xs h-7 min-w-0"}),(0,a.jsx)(m.N,{data:k.flatMap(e=>e.transactions),filename:`heatmap_details_${P.roomType}_${P.areaRange}`,label:"明細",className:"whitespace-nowrap px-3 py-1 text-xs h-7 min-w-0"})]}),(0,a.jsx)("div",{className:"w-px h-4 bg-white/10 mx-1"}),(0,a.jsx)("button",{onClick:()=>{F.current&&(F.current.style.width=`${F.current.offsetWidth}px`),A(null)},className:"text-zinc-400 hover:text-white p-1 hover:bg-zinc-800 rounded transition-colors",children:(0,a.jsxs)("svg",{xmlns:"http://www.w3.org/2000/svg",width:"20",height:"20",viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:"2",strokeLinecap:"round",strokeLinejoin:"round",children:[(0,a.jsx)("path",{d:"M18 6 6 18"}),(0,a.jsx)("path",{d:"m6 6 12 12"})]})})]})]}),k.length>0?(0,a.jsx)("div",{className:"flex-1 overflow-y-auto custom-scrollbar pr-1 -mr-1",children:(0,a.jsx)("div",{className:"space-y-3",children:k.map((e,t)=>(0,a.jsxs)("div",{className:"bg-zinc-950/30 rounded border border-white/5 overflow-hidden",children:[(0,a.jsxs)("div",{className:(0,c.cn)("p-3 cursor-pointer transition-colors flex justify-between items-center",e.isExpanded?"bg-zinc-800/80":"hover:bg-zinc-800/40"),onClick:()=>{S(e=>e.map((e,s)=>s===t?{...e,isExpanded:!e.isExpanded}:e))},children:[(0,a.jsxs)("div",{className:"flex items-center gap-2",children:[(0,a.jsx)("div",{className:(0,c.cn)("w-4 h-4 rounded-full bg-zinc-800 flex items-center justify-center text-[10px] text-zinc-400 transition-transform duration-200",e.isExpanded?"rotate-90 bg-violet-500/20 text-violet-300":""),children:"▶"}),(0,a.jsx)("span",{className:"font-medium text-sm text-zinc-200",children:e.projectName}),(0,a.jsxs)("span",{className:"px-1.5 py-0.5 rounded text-[10px] bg-zinc-800 text-zinc-400 border border-white/5",children:[e.count,"戶"]})]}),(0,a.jsx)("div",{className:"text-right",children:(0,a.jsxs)("div",{className:"text-xs font-mono text-cyan-400",children:[e.unitPriceRange.min===e.unitPriceRange.max?e.unitPriceRange.min.toFixed(1):`${e.unitPriceRange.min.toFixed(1)}~${e.unitPriceRange.max.toFixed(1)}`," ",(0,a.jsx)("span",{className:"text-zinc-500 text-[10px]",children:"萬/坪"})]})})]}),e.isExpanded&&(0,a.jsxs)("div",{className:"p-3 bg-black/20 border-t border-white/5",children:[(0,a.jsxs)("div",{className:"grid grid-cols-2 gap-x-4 gap-y-2 text-xs mb-3 text-zinc-400",children:[(0,a.jsxs)("div",{className:"flex justify-between border-b border-white/5 pb-1",children:[(0,a.jsx)("span",{children:"總價範圍"}),(0,a.jsx)("span",{className:"font-mono text-zinc-300",children:e.priceRange.min===e.priceRange.max?R(e.priceRange.min):`${R(e.priceRange.min)}~${R(e.priceRange.max)}`})]}),(0,a.jsxs)("div",{className:"flex justify-between border-b border-white/5 pb-1",children:[(0,a.jsx)("span",{children:"總價中位數"}),(0,a.jsx)("span",{className:"font-mono text-violet-300",children:R(e.priceRange.median||0)})]})]}),(0,a.jsxs)("div",{className:"space-y-1",children:[(0,a.jsxs)("div",{className:"grid grid-cols-5 text-[10px] text-zinc-500 pb-1 border-b border-white/5",children:[(0,a.jsx)("div",{className:"col-span-1",children:"樓層"}),(0,a.jsx)("div",{className:"col-span-1",children:"坪數"}),(0,a.jsx)("div",{className:"col-span-1 text-right",children:"單價"}),(0,a.jsx)("div",{className:"col-span-2 text-right",children:"總價"})]}),e.transactions.slice(0,e.showAll?void 0:10).map((e,t)=>(0,a.jsxs)("div",{className:"grid grid-cols-5 text-xs py-1 hover:bg-white/5 rounded px-1 -mx-1 transition-colors",children:[(0,a.jsx)("div",{className:"col-span-1 text-zinc-300",children:e["樓層"]||e.floor||"-"}),(0,a.jsx)("div",{className:"col-span-1 text-zinc-400",children:(e["房屋面積(坪)"]||e.houseArea||0).toFixed(1)}),(0,a.jsx)("div",{className:"col-span-1 text-right text-cyan-400",children:(e["房屋單價(萬)"]||e.unitPrice||0).toFixed(0)}),(0,a.jsx)("div",{className:"col-span-2 text-right text-zinc-300 font-mono",children:R(e["交易總價(萬)"]||e.totalPrice||0)})]},t)),e.transactions.length>10&&(0,a.jsx)("button",{onClick:e=>{e.stopPropagation(),S(e=>e.map((e,s)=>s===t?{...e,showAll:!e.showAll}:e))},className:"w-full text-center text-[10px] text-zinc-500 hover:text-cyan-400 py-1.5 mt-1 border-t border-white/5 transition-colors",children:e.showAll?"收合內容":`還有 ${e.transactions.length-10} 筆交易...`})]})]})]},t))})}):(0,a.jsx)("div",{className:"flex-1 flex flex-col items-center justify-center text-zinc-500 border border-dashed border-zinc-800 rounded bg-zinc-900/30",children:(0,a.jsx)("p",{children:"無詳細資料"})})]})})]})}),(0,a.jsx)(p.K,{})]})}},55810:(e,t,s)=>{s.d(t,{p:()=>b});var a=s(95155),r=s(12115),n=s(34361),i=s(69690),l=s(88743),c=s(89239),o=s(86901),d=s(89123),x=s(37595),m=s(56842),h=s(72055),p=s(65770),u=s(41641),f=s(21362),g=s(89733);function b({data:e,visibleSections:t=["metrics","chart","table"]}){let{rankingCurrentPage:s,rankingPageSize:b,setRankingCurrentPage:j,setRankingPageSize:v}=(0,l.P)(),[N,y]=(0,r.useState)(1),[w,z]=(0,r.useState)(10),[k,S]=(0,r.useState)({key:"saleAmountSum",order:"desc"}),[P,A]=(0,r.useState)(30),[M,C]=(0,r.useState)("auto"),_=r.useRef(null),$=r.useRef(null),R=r.useRef(null);if(!e)return null;let{coreMetrics:F,projectRanking:E}=e,T=(0,r.useMemo)(()=>{if(!E||0===E.length)return{min:0,max:0,median:0,parking:0};let e=Math.min(...E.map(e=>e.minPrice).filter(e=>e>0)),t=Math.max(...E.map(e=>e.maxPrice)),s=E.map(e=>e.medianPrice).filter(e=>e>0),a=s.length>0?s.reduce((e,t)=>e+t,0)/s.length:0,r=E.map(e=>e.avgParkingPrice).filter(e=>e>0);return{min:e,max:t,median:a,parking:r.length>0?r.reduce((e,t)=>e+t,0)/r.length:0}},[E]),D=(0,r.useMemo)(()=>E?[...E].sort((e,t)=>{let s=e[k.key]||0,a=t[k.key]||0;return"desc"===k.order?a-s:s-a}):[],[E,k]),L=Math.ceil(D.length/w),I=D.slice((N-1)*w,N*w),O=e=>{S({key:e,order:"desc"})},B=({title:e,value:t,unit:s,sortKey:r})=>(0,a.jsxs)("div",{onClick:()=>r&&O(r),className:`bg-zinc-800/50 rounded-lg p-4 border border-white/5 flex flex-col items-center justify-center text-center transition-all duration-300 ${r?"cursor-pointer hover:bg-zinc-800 hover:border-violet-500/30 hover:shadow-[0_0_20px_rgba(139,92,246,0.1)] group":""}`,children:[(0,a.jsx)("div",{className:`text-zinc-400 text-sm mb-1 ${r?"group-hover:text-violet-300":""}`,children:e}),(0,a.jsxs)("div",{className:"flex items-baseline gap-1",children:[(0,a.jsx)("span",{className:`text-2xl font-bold text-white ${r?"group-hover:text-white":""}`,children:t}),(0,a.jsx)("span",{className:"text-xs text-zinc-500",children:s})]})]});return(0,a.jsxs)("div",{className:"space-y-6 animate-in fade-in slide-in-from-bottom-4 duration-500",children:[t.includes("metrics")&&(0,a.jsx)(n.c,{title:"核心數據指標",containerRef:_,headerAction:(0,a.jsx)(g.N,{data:[F,T],filename:"core_metrics",label:"匯出",chartType:"ranking-metrics",targetRef:_,snapshotData:{coreMetrics:F,derivedMetrics:T}}),children:(0,a.jsxs)("div",{className:"grid grid-cols-1 sm:grid-cols-2 md:grid-cols-4 gap-3 sm:gap-4",children:[(0,a.jsx)(B,{title:"市場去化總銷售金額",value:F.totalSaleAmount.toLocaleString(),unit:"萬",sortKey:"saleAmountSum"}),(0,a.jsx)(B,{title:"總銷去化房屋坪數",value:F.totalHouseArea.toLocaleString(void 0,{maximumFractionDigits:2}),unit:"坪",sortKey:"houseAreaSum"}),(0,a.jsx)(B,{title:"總平均單價",value:F.overallAveragePrice.toLocaleString(void 0,{maximumFractionDigits:2}),unit:"萬/坪",sortKey:"averagePrice"}),(0,a.jsx)(B,{title:"總交易筆數",value:F.transactionCount.toLocaleString(),unit:"筆",sortKey:"transactionCount"}),(0,a.jsx)(B,{title:"最低成交單價 (Min)",value:T.min.toLocaleString(void 0,{maximumFractionDigits:1}),unit:"萬/坪",sortKey:"minPrice"}),(0,a.jsx)(B,{title:"最高成交單價 (Max)",value:T.max.toLocaleString(void 0,{maximumFractionDigits:1}),unit:"萬/坪",sortKey:"maxPrice"}),(0,a.jsx)(B,{title:"平均中位數單價",value:T.median.toLocaleString(void 0,{maximumFractionDigits:1}),unit:"萬/坪",sortKey:"medianPrice"}),(0,a.jsx)(B,{title:"平均車位價格",value:T.parking.toLocaleString(void 0,{maximumFractionDigits:0}),unit:"萬",sortKey:"avgParkingPrice"})]})}),t.includes("chart")&&(0,a.jsxs)("div",{className:"space-y-4",children:[(0,a.jsx)("div",{className:"flex flex-wrap gap-2 justify-center",children:[{key:"saleAmountSum",label:"交易總價(萬)"},{key:"houseAreaSum",label:"房屋面積(坪)"},{key:"transactionCount",label:"資料筆數"},{key:"marketShare",label:"市場佔比(%)"},{key:"averagePrice",label:"平均單價"},{key:"minPrice",label:"最低單價"},{key:"maxPrice",label:"最高單價"},{key:"medianPrice",label:"中位數單價"},{key:"avgParkingPrice",label:"車位均價"}].map(e=>(0,a.jsx)("button",{onClick:()=>O(e.key),className:`px-3 py-1.5 text-xs font-medium rounded-full border transition-all duration-300 ${k.key===e.key?"bg-violet-600/20 border-violet-500/50 text-violet-300 shadow-[0_0_15px_rgba(139,92,246,0.2)]":"bg-zinc-800/50 border-white/5 text-zinc-400 hover:text-white hover:bg-zinc-800 hover:border-white/10"}`,children:e.label},e.key))}),(0,a.jsx)(n.c,{title:"建案分析圖表",description:"根據排序指標顯示建案排名",containerRef:$,headerAction:(0,a.jsxs)("div",{className:"flex flex-col sm:flex-row items-start sm:items-center gap-3 w-full sm:w-auto",children:[(0,a.jsxs)("div",{className:"flex bg-zinc-800 p-0.5 rounded-lg border border-white/5",children:[(0,a.jsx)("button",{onClick:()=>C("auto"),className:`p-1.5 rounded-md transition-all ${"auto"===M?"bg-violet-600 text-white shadow-lg shadow-violet-500/20":"text-zinc-400 hover:text-white hover:bg-white/5"}`,title:"自動選擇 (Auto)",children:(0,a.jsx)(o.A,{size:14})}),(0,a.jsx)("button",{onClick:()=>C("bar"),className:`p-1.5 rounded-md transition-all ${"bar"===M?"bg-violet-600 text-white shadow-lg shadow-violet-500/20":"text-zinc-400 hover:text-white hover:bg-white/5"}`,title:"長條圖 (Bar)",children:(0,a.jsx)(d.A,{size:14})}),(0,a.jsx)("button",{onClick:()=>C("treemap"),className:`p-1.5 rounded-md transition-all ${"treemap"===M?"bg-violet-600 text-white shadow-lg shadow-violet-500/20":"text-zinc-400 hover:text-white hover:bg-white/5"}`,title:"矩形樹圖 (Treemap)",children:(0,a.jsx)(x.A,{size:14})})]}),(0,a.jsx)("div",{className:"hidden sm:block w-px h-6 bg-white/10"}),(0,a.jsxs)("div",{className:"flex items-center gap-3 w-full sm:w-auto justify-between sm:justify-start",children:[(0,a.jsx)("div",{className:"flex bg-zinc-800 p-0.5 rounded-lg border border-white/5 overflow-x-auto max-w-[200px] sm:max-w-none scrollbar-hide",children:[10,30,50,100].map(e=>(0,a.jsxs)("button",{onClick:()=>A(e),className:`px-3 py-1 text-xs rounded-md transition-all whitespace-nowrap ${P===e?"bg-violet-600 text-white shadow-lg shadow-violet-500/20":"text-zinc-400 hover:text-white hover:bg-white/5"}`,children:["Top ",e]},e))}),(0,a.jsx)("div",{className:"hidden sm:block w-px h-6 bg-white/10"}),(0,a.jsx)(g.N,{data:D.slice(0,P),filename:"ranking_chart_data",label:"匯出",chartType:"ranking-chart",targetRef:$,snapshotData:D.slice(0,P),columns:{projectName:"建案名稱",county:"縣市",district:"行政區",saleAmountSum:"交易總價",houseAreaSum:"房屋面積",transactionCount:"資料筆數",marketShare:"市場佔比",averagePrice:"平均單價",minPrice:"最低單價",maxPrice:"最高單價",medianPrice:"中位數單價",avgParkingPrice:"車位均價"}})]})]}),children:(0,a.jsx)(i.l,{data:D,sortKey:k.key,limit:P,chartType:M})})]}),t.includes("table")&&(0,a.jsxs)(n.c,{title:"區域建案排行列表",description:"點擊表頭可進行排序",containerRef:R,headerAction:(0,a.jsx)(g.N,{data:D,filename:"ranking_table_data",label:"匯出",chartType:"ranking-table",targetRef:R,snapshotData:D,columns:{projectName:"建案名稱",county:"縣市",district:"行政區",saleAmountSum:"交易總價",houseAreaSum:"房屋面積",transactionCount:"資料筆數",marketShare:"市場佔比",averagePrice:"平均單價",minPrice:"最低單價",maxPrice:"最高單價",medianPrice:"中位數單價",avgParkingPrice:"車位均價"}}),children:[(0,a.jsx)("div",{className:"overflow-x-auto",children:(0,a.jsxs)("table",{className:"w-full text-sm text-left",children:[(0,a.jsx)("thead",{className:"bg-zinc-900/80 text-zinc-400 uppercase text-xs font-semibold",children:(0,a.jsxs)("tr",{children:[(0,a.jsx)("th",{className:"px-4 py-3 cursor-default",children:"排名"}),(0,a.jsx)("th",{className:"px-4 py-3 cursor-default",children:"建案名稱"}),[{key:"saleAmountSum",label:(0,a.jsxs)(a.Fragment,{children:["交易",(0,a.jsx)("br",{}),"總價(萬)"]})},{key:"houseAreaSum",label:(0,a.jsxs)(a.Fragment,{children:["房屋",(0,a.jsx)("br",{}),"面積(坪)"]})},{key:"transactionCount",label:(0,a.jsxs)(a.Fragment,{children:["資料",(0,a.jsx)("br",{}),"筆數"]})},{key:"marketShare",label:(0,a.jsxs)(a.Fragment,{children:["市場",(0,a.jsx)("br",{}),"佔比(%)"]})},{key:"averagePrice",label:(0,a.jsxs)(a.Fragment,{children:["平均",(0,a.jsx)("br",{}),"單價"]})},{key:"minPrice",label:(0,a.jsxs)(a.Fragment,{children:["最低",(0,a.jsx)("br",{}),"單價"]})},{key:"maxPrice",label:(0,a.jsxs)(a.Fragment,{children:["最高",(0,a.jsx)("br",{}),"單價"]})},{key:"medianPrice",label:(0,a.jsxs)(a.Fragment,{children:["中位數",(0,a.jsx)("br",{}),"單價"]})},{key:"avgParkingPrice",label:(0,a.jsxs)(a.Fragment,{children:["車位",(0,a.jsx)("br",{}),"均價"]})}].map(e=>(0,a.jsx)("th",{className:"px-3 py-3 cursor-pointer hover:text-white transition-colors text-center whitespace-nowrap",onClick:()=>O(e.key),children:(0,a.jsxs)("div",{className:"flex items-center justify-center gap-1.5 group/header",children:[(0,a.jsx)("span",{className:"leading-tight",children:e.label}),(0,a.jsx)("div",{className:"flex flex-col opacity-50 group-hover/header:opacity-100 transition-opacity",children:k.key===e.key?"desc"===k.order?(0,a.jsx)(m.A,{size:14,className:"text-violet-500"}):(0,a.jsx)(h.A,{size:14,className:"text-violet-500"}):(0,a.jsx)(p.A,{size:14,className:"text-zinc-600 group-hover/header:text-zinc-400"})})]})},e.key))]})}),(0,a.jsx)("tbody",{className:"divide-y divide-white/5",children:I.map((e,t)=>(0,a.jsxs)("tr",{className:"hover:bg-zinc-800/50 transition-colors",children:[(0,a.jsx)("td",{className:"px-4 py-3 text-zinc-500 font-mono",children:(N-1)*w+t+1}),(0,a.jsx)("td",{className:"px-4 py-3",children:(0,a.jsxs)("div",{className:"flex flex-col",children:[(0,a.jsx)("span",{className:"font-medium text-white",children:e.projectName}),(0,a.jsxs)("div",{className:"flex gap-1 mt-1",children:[e.county&&(0,a.jsx)("span",{className:"text-[10px] bg-zinc-800 text-zinc-400 px-1 py-0.5 rounded",children:e.county}),e.district&&(0,a.jsx)("span",{className:"text-[10px] bg-zinc-800 text-zinc-400 px-1 py-0.5 rounded",children:e.district})]})]})}),(0,a.jsx)("td",{className:"px-4 py-3 font-mono text-zinc-300",children:e.saleAmountSum.toLocaleString()}),(0,a.jsx)("td",{className:"px-4 py-3 font-mono text-zinc-300",children:e.houseAreaSum.toLocaleString()}),(0,a.jsx)("td",{className:"px-4 py-3 font-mono text-zinc-300",children:e.transactionCount.toLocaleString()}),(0,a.jsxs)("td",{className:"px-4 py-3 font-mono text-zinc-300",children:[e.marketShare.toFixed(2),"%"]}),(0,a.jsx)("td",{className:"px-4 py-3 font-mono text-cyan-400",children:e.averagePrice.toFixed(1)}),(0,a.jsx)("td",{className:"px-4 py-3 font-mono text-zinc-500",children:e.minPrice.toFixed(1)}),(0,a.jsx)("td",{className:"px-4 py-3 font-mono text-zinc-500",children:e.maxPrice.toFixed(1)}),(0,a.jsx)("td",{className:"px-4 py-3 font-mono text-zinc-400",children:e.medianPrice.toFixed(1)}),(0,a.jsx)("td",{className:"px-4 py-3 font-mono text-zinc-400",children:e.avgParkingPrice>0?e.avgParkingPrice.toLocaleString():"-"})]},t))}),(0,a.jsx)("tfoot",{className:"bg-zinc-900/80 font-bold border-t-2 border-zinc-700",children:(0,a.jsxs)("tr",{children:[(0,a.jsx)("td",{colSpan:2,className:"px-4 py-3 text-center text-zinc-300",children:"總計"}),(0,a.jsx)("td",{className:"px-4 py-3 text-zinc-300",children:F.totalSaleAmount.toLocaleString()}),(0,a.jsx)("td",{className:"px-4 py-3 text-zinc-300",children:F.totalHouseArea.toLocaleString()}),(0,a.jsx)("td",{className:"px-4 py-3 text-zinc-300",children:F.transactionCount.toLocaleString()}),(0,a.jsx)("td",{colSpan:6})]})})]})}),(0,a.jsxs)("div",{className:"flex items-center justify-between mt-4 border-t border-white/5 pt-4",children:[(0,a.jsxs)("div",{className:"text-sm text-zinc-500",children:["顯示 ",(N-1)*w+1," 到 ",Math.min(N*w,D.length)," 筆，共 ",D.length," 筆"]}),(0,a.jsxs)("div",{className:"flex items-center gap-2",children:[(0,a.jsx)(c.$,{variant:"outline",size:"sm",onClick:()=>y(e=>Math.max(1,e-1)),disabled:1===N,children:(0,a.jsx)(u.A,{size:16})}),(0,a.jsxs)("span",{className:"text-sm text-zinc-300",children:["Page ",N," of ",L]}),(0,a.jsx)(c.$,{variant:"outline",size:"sm",onClick:()=>y(e=>Math.min(L,e+1)),disabled:N===L,children:(0,a.jsx)(f.A,{size:16})})]})]})]})]})}},72264:(e,t,s)=>{s.d(t,{SQ:()=>o,_2:()=>d,hO:()=>x,lp:()=>m,mB:()=>h,rI:()=>l,ty:()=>c});var a=s(95155);s(12115);var r=s(61108),n=s(94514),i=s(40980);function l({...e}){return(0,a.jsx)(r.bL,{"data-slot":"dropdown-menu",...e})}function c({...e}){return(0,a.jsx)(r.l9,{"data-slot":"dropdown-menu-trigger",...e})}function o({className:e,sideOffset:t=4,...s}){return(0,a.jsx)(r.ZL,{children:(0,a.jsx)(r.UC,{"data-slot":"dropdown-menu-content",sideOffset:t,className:(0,i.cn)("bg-popover text-popover-foreground data-[state=open]:animate-in data-[state=closed]:animate-out data-[state=closed]:fade-out-0 data-[state=open]:fade-in-0 data-[state=closed]:zoom-out-95 data-[state=open]:zoom-in-95 data-[side=bottom]:slide-in-from-top-2 data-[side=left]:slide-in-from-right-2 data-[side=right]:slide-in-from-left-2 data-[side=top]:slide-in-from-bottom-2 z-50 max-h-(--radix-dropdown-menu-content-available-height) min-w-[8rem] origin-(--radix-dropdown-menu-content-transform-origin) overflow-x-hidden overflow-y-auto rounded-md border p-1 shadow-md",e),...s})})}function d({className:e,inset:t,variant:s="default",...n}){return(0,a.jsx)(r.q7,{"data-slot":"dropdown-menu-item","data-inset":t,"data-variant":s,className:(0,i.cn)("focus:bg-accent focus:text-accent-foreground data-[variant=destructive]:text-destructive data-[variant=destructive]:focus:bg-destructive/10 dark:data-[variant=destructive]:focus:bg-destructive/20 data-[variant=destructive]:focus:text-destructive data-[variant=destructive]:*:[svg]:!text-destructive [&_svg:not([class*='text-'])]:text-muted-foreground relative flex cursor-default items-center gap-2 rounded-sm px-2 py-1.5 text-sm outline-hidden select-none data-[disabled]:pointer-events-none data-[disabled]:opacity-50 data-[inset]:pl-8 [&_svg]:pointer-events-none [&_svg]:shrink-0 [&_svg:not([class*='size-'])]:size-4",e),...n})}function x({className:e,children:t,checked:s,...l}){return(0,a.jsxs)(r.H_,{"data-slot":"dropdown-menu-checkbox-item",className:(0,i.cn)("focus:bg-accent focus:text-accent-foreground relative flex cursor-default items-center gap-2 rounded-sm py-1.5 pr-2 pl-8 text-sm outline-hidden select-none data-[disabled]:pointer-events-none data-[disabled]:opacity-50 [&_svg]:pointer-events-none [&_svg]:shrink-0 [&_svg:not([class*='size-'])]:size-4",e),checked:s,...l,children:[(0,a.jsx)("span",{className:"pointer-events-none absolute left-2 flex size-3.5 items-center justify-center",children:(0,a.jsx)(r.VF,{children:(0,a.jsx)(n.A,{className:"size-4"})})}),t]})}function m({className:e,inset:t,...s}){return(0,a.jsx)(r.JU,{"data-slot":"dropdown-menu-label","data-inset":t,className:(0,i.cn)("px-2 py-1.5 text-sm font-medium data-[inset]:pl-8",e),...s})}function h({className:e,...t}){return(0,a.jsx)(r.wv,{"data-slot":"dropdown-menu-separator",className:(0,i.cn)("bg-border -mx-1 my-1 h-px",e),...t})}},75444:(e,t,s)=>{s.d(t,{P:()=>u});var a=s(95155),r=s(12115),n=s(34361),i=s(826),l=s(97085);function c({roomTypes:e,locations:t,crossTable:s,dimension:n}){let i=(0,r.useMemo)(()=>e&&t&&s?e.map(e=>{let a=t.map(t=>s[e]&&s[e][t]||0);return{name:e,data:a}}):[],[e,t,s]),c=(0,r.useMemo)(()=>{let e="county"===n?"縣市":"行政區";return{chart:{type:"bar",height:Math.max(350,35*t.length),stacked:!0,background:"transparent",toolbar:{show:!0},foreColor:"#e5e7eb"},plotOptions:{bar:{horizontal:!0,barHeight:"70%",borderRadius:4,dataLabels:{total:{enabled:!0,offsetX:5,style:{fontSize:"11px",fontWeight:600,color:"#e5e7eb"},formatter:function(e,t){let s=t.w.config.series,a=t.dataPointIndex,r=0;return s.forEach(e=>{r+=e.data[a]||0}),r>0?r.toString():""}}}}},colors:["#06b6d4","#8b5cf6","#10b981","#f59e0b","#ef4444","#3b82f6","#ec4899","#84cc16","#6366f1","#14b8a6"],dataLabels:{enabled:!1},xaxis:{categories:t,title:{text:"成交筆數",style:{color:"#9ca3af"}},labels:{style:{colors:"#9ca3af"}}},yaxis:{title:{text:e,style:{color:"#9ca3af"}},labels:{style:{colors:"#e5e7eb"},maxWidth:150}},legend:{position:"top",horizontalAlign:"center",labels:{colors:"#e5e7eb"}},tooltip:{theme:"dark",y:{formatter:function(e){return e+" 筆"}}},grid:{borderColor:"#374151"},title:{text:`各${e}房型成交筆數分佈`,align:"center",style:{fontSize:"16px",color:"#e5e7eb"}}}},[t,n]);return i&&0!==i.length?(0,a.jsx)(l.A,{type:"bar",series:i,options:c,height:c.chart?.height||350,className:"w-full"}):(0,a.jsx)("div",{className:"text-zinc-500 text-center p-8",children:"無區域分佈資料"})}var o=s(33210),d=s(40980);function x({isOpen:e,onClose:t,title:s,projects:n}){let i=(0,r.useRef)(null);return((0,r.useEffect)(()=>{let s=e=>{"Escape"===e.key&&t()};return e&&(document.addEventListener("keydown",s),document.body.style.overflow="hidden"),()=>{document.removeEventListener("keydown",s),document.body.style.overflow=""}},[e,t]),e)?(0,a.jsx)("div",{className:"fixed inset-0 z-50 flex items-center justify-center bg-black/60 backdrop-blur-sm animate-in fade-in duration-200",onClick:e=>{i.current&&!i.current.contains(e.target)&&t()},children:(0,a.jsxs)("div",{ref:i,className:"bg-zinc-900 border border-white/10 rounded-xl shadow-2xl max-w-md w-full mx-4 animate-in zoom-in-95 duration-200",children:[(0,a.jsxs)("div",{className:"flex items-center justify-between px-5 py-4 border-b border-white/5",children:[(0,a.jsx)("h3",{className:"text-lg font-semibold text-white",children:s}),(0,a.jsx)("button",{onClick:t,className:"p-1 rounded hover:bg-white/10 text-zinc-400 hover:text-white transition-colors",children:(0,a.jsx)(o.A,{size:20})})]}),(0,a.jsx)("div",{className:"px-5 py-4 max-h-[50vh] overflow-y-auto scrollbar-thin scrollbar-thumb-zinc-700",children:0===n.length?(0,a.jsx)("p",{className:"text-zinc-500 text-center py-4",children:"無建案資料"}):(0,a.jsx)("ul",{className:"space-y-2",children:n.map((e,t)=>(0,a.jsx)("li",{className:(0,d.cn)("px-3 py-2 rounded-lg text-zinc-200 text-sm","bg-zinc-800/50 hover:bg-zinc-800 transition-colors","border border-white/5"),children:e},t))})}),(0,a.jsxs)("div",{className:"px-5 py-3 border-t border-white/5 flex justify-between items-center",children:[(0,a.jsxs)("span",{className:"text-xs text-zinc-500",children:["共 ",n.length," 個建案"]}),(0,a.jsx)("button",{onClick:t,className:"px-4 py-1.5 text-sm rounded-lg bg-zinc-800 text-zinc-300 hover:bg-zinc-700 transition-colors",children:"關閉"})]})]})}):null}var m=s(89733),h=s(88743),p=s(48551);function u({data:e,visibleSections:t=["chart","table","location-table","location-chart"]}){let{selectedRoomTypes:s,setSelectedRoomTypes:l}=(0,h.P)(),o=["套房","1房","2房","3房","4房","毛胚"],u=r.useRef(null),f=r.useRef(null),g=r.useRef(null),b=r.useRef(null),[j,v]=(0,r.useState)("district"),[N,y]=(0,r.useState)(!1),[w,z]=(0,r.useState)(""),[k,S]=(0,r.useState)([]),[P,A]=(0,r.useState)(null),M=(0,r.useMemo)(()=>{if(!e?.transactionDetails)return[];let t=new Set;return e.transactionDetails.forEach(e=>{e["縣市"]&&t.add(e["縣市"])}),Array.from(t).sort()},[e?.transactionDetails]);r.useEffect(()=>{!P&&M.length>0&&A(M[0])},[M,P]);let C=(e,t,s)=>{z(`${e}${null!==t?` / ${t}衛`:""} 建案組成`),S(s),y(!0)};if(!e||!e.details||0===e.details.length)return null;let{details:_,locationCrossTable:$,allDistricts:R,transactionDetails:F}=e,E=(0,r.useMemo)(()=>_.filter(e=>s.includes(e.roomType)),[_,s]),[T,D]=(0,r.useState)(!0),L=(0,r.useMemo)(()=>{let e=_.filter(e=>s.includes(e.roomType));if(!T)return e;let t=new Map;return e.forEach(e=>{let s=e.roomType;t.has(s)||t.set(s,{...e,bathrooms:null,projectNames:e.projectNames?[...e.projectNames]:[],count:0,avgPrice:0});let a=t.get(s),r=a.avgPrice*a.count,n=e.avgPrice*e.count,i=a.count+e.count;a.count=i,a.avgPrice=i>0?(r+n)/i:0,a.minPrice=Math.min(a.minPrice,e.minPrice),a.maxPrice=Math.max(a.maxPrice,e.maxPrice);let l=a.count-e.count,c=e.count;if(a.medianPrice=(a.medianPrice*l+e.medianPrice*c)/i,a.q1Price=(a.q1Price*l+e.q1Price*c)/i,a.q3Price=(a.q3Price*l+e.q3Price*c)/i,e.projectNames){let t=new Set([...a.projectNames||[],...e.projectNames]);a.projectNames=Array.from(t)}}),Array.from(t.values()).sort((e,t)=>o.indexOf(e.roomType)-o.indexOf(t.roomType))},[_,s,T,o]),I=(0,r.useMemo)(()=>{if("county"===j&&F){let e={},t=new Set;F.forEach(s=>{let a=s["房型"]||s.roomType||s["戶型"];if(!a||"其他"===a){let e=Number(s["房數"]);a=!isNaN(e)&&e>0?`${e}房`:"其他"}let r="string"==typeof a?a.replace(/\s+/g,""):a;("number"==typeof r||"string"==typeof r&&/^\d+$/.test(r))&&(r=`${r}房`);let n=s["縣市"]||"未知";e[r]||(e[r]={}),e[r][n]=(e[r][n]||0)+1,t.add(n)});let a=Array.from(t).sort(),r={},n=0;a.forEach(e=>r[e]=0);let i=s.map(t=>{let s=e[t]||{},i=0,l=a.map(e=>{let t=s[e]||0;return i+=t,r[e]+=t,t});return n+=i,{roomType:t,cells:l,rowTotal:i}});return{locations:a,rows:i,locationTotals:r,grandTotal:n}}if("district"===j){let e={},t=new Set;if(F)F.forEach(s=>{let a=s["房型"]||s.roomType||s["戶型"];if(!a||"其他"===a){let e=Number(s["房數"]);a=!isNaN(e)&&e>0?`${e}房`:"其他"}let r="string"==typeof a?a.replace(/\s+/g,""):a;("number"==typeof r||"string"==typeof r&&/^\d+$/.test(r))&&(r=`${r}房`);let n=s["行政區"]||"未知",i=s["縣市"]||"未知";P&&i!==P||(e[r]||(e[r]={}),e[r][n]=(e[r][n]||0)+1,t.add(n))});else if($){let a=new Set;s.forEach(e=>{let t=$[e];t&&Object.keys(t).forEach(e=>a.add(e))}),a.forEach(e=>t.add(e)),s.forEach(t=>{let s=$[t];s&&(e[t]=s)})}let a=Array.from(t).sort(),r={},n=0;a.forEach(e=>r[e]=0);let i=s.map(t=>{let s=e[t]||{},i=0,l=a.map(e=>{let t=s[e]||0;return i+=t,r[e]+=t,t});return n+=i,{roomType:t,cells:l,rowTotal:i}});return{locations:a,rows:i,locationTotals:r,grandTotal:n}}return null},[$,F,s,j,P]),[O,B]=(0,r.useState)(new Set),H=(0,r.useMemo)(()=>I?I.rows.map(e=>{let t={房型:e.roomType};return I.locations.forEach((s,a)=>{t[s]=e.cells[a]}),t["總計"]=e.rowTotal,t}):[],[I]),q=e=>_.filter(t=>t.roomType===e).sort((e,t)=>(Number(e.bathrooms)||0)-(Number(t.bathrooms)||0)),W=(0,r.useMemo)(()=>{if(!T)return L;let e=[];return L.forEach(t=>{if(e.push(t),O.has(t.roomType)){let s=q(t.roomType);e.push(...s)}}),e},[L,T,O,_]);return(0,a.jsxs)("div",{className:"space-y-6 animate-in fade-in slide-in-from-bottom-4 duration-500",children:[(0,a.jsxs)("div",{id:"room-type-filter-anchor",className:"p-4 bg-zinc-900/30 border border-white/5 rounded-lg flex flex-col sm:flex-row sm:flex-wrap items-start sm:items-center justify-between gap-3 sm:gap-4 scroll-mt-24",children:[(0,a.jsxs)("div",{className:"w-full sm:w-auto flex flex-wrap items-center gap-2",children:[(0,a.jsx)("span",{className:"text-zinc-400 text-sm whitespace-nowrap shrink-0 mr-1",children:"分析房型:"}),(0,a.jsx)("div",{className:"flex flex-wrap gap-1.5 sm:gap-2",children:h.M.map(e=>(0,a.jsx)("button",{onClick:()=>{l(s.includes(e)?s.filter(t=>t!==e):[...s,e])},className:(0,d.cn)("px-3 py-1 rounded-full text-xs font-medium transition-colors border",s.includes(e)?"bg-violet-500/20 border-violet-500 text-violet-200":"bg-zinc-800 border-zinc-700 text-zinc-500 hover:bg-zinc-700"),children:e},e))})]}),(0,a.jsxs)("div",{className:"flex items-center gap-2 bg-zinc-800/50 p-1 rounded-lg border border-white/5 ml-auto sm:ml-0",children:[(0,a.jsx)("span",{className:"text-xs text-zinc-400 pl-2",children:"表格顯示:"}),(0,a.jsx)("button",{onClick:()=>D(!T),className:(0,d.cn)("px-3 py-1 text-xs font-medium rounded-md transition-all whitespace-nowrap",T?"bg-violet-500 text-white shadow-sm":"text-zinc-400 hover:text-white hover:bg-zinc-700"),children:T?"依房型合併":"顯示衛浴細節"})]})]}),t.includes("chart")&&(0,a.jsx)(n.c,{title:"各房型總價帶分佈箱型圖",description:"顯示各房型總價的中位數與四分位距",containerRef:u,headerAction:(0,a.jsx)(m.N,{data:L,filename:"price_band_chart_data",label:"匯出",chartType:"price-band-chart",targetRef:u,snapshotData:L,columns:{roomType:"房型",bathrooms:"衛浴",minPrice:"最低價",q1Price:"Q1",medianPrice:"中位數",q3Price:"Q3",maxPrice:"最高價",avgPrice:"平均價",count:"筆數"}}),children:(0,a.jsx)(i.B,{data:L})}),t.includes("table")&&(0,a.jsx)(n.c,{title:"總價帶詳細數據",description:T?"各房型合併統計 (點擊「全部」可展開細節)":"各房型詳細價格統計",containerRef:f,headerAction:(0,a.jsx)(m.N,{data:W,filename:"price_band_detail_data",label:"匯出",chartType:"price-band-table",targetRef:f,snapshotData:W,columns:{roomType:"房型",bathrooms:"衛浴",minPrice:"最低價",q1Price:"Q1",medianPrice:"中位數",q3Price:"Q3",maxPrice:"最高價",avgPrice:"平均價",count:"筆數"}}),children:(0,a.jsx)("div",{className:"overflow-x-auto",children:(0,a.jsxs)("table",{className:"w-full text-sm text-left",children:[(0,a.jsx)("thead",{className:"bg-zinc-900/80 text-zinc-400 uppercase text-xs font-semibold",children:(0,a.jsxs)("tr",{children:[(0,a.jsx)("th",{className:"px-4 py-3",children:"房型"}),(0,a.jsx)("th",{className:"px-4 py-3",children:"衛浴"}),(0,a.jsx)("th",{className:"px-4 py-3 whitespace-nowrap min-w-[100px]",children:"建案數"}),(0,a.jsx)("th",{className:"px-4 py-3 whitespace-nowrap",children:"筆數"}),(0,a.jsx)("th",{className:"px-4 py-3 whitespace-nowrap",children:"平均總價"}),(0,a.jsx)("th",{className:"px-4 py-3",children:"最低總價"}),(0,a.jsx)("th",{className:"px-4 py-3",children:"1/4位總價"}),(0,a.jsx)("th",{className:"px-4 py-3 text-violet-400",children:"中位數總價"}),(0,a.jsx)("th",{className:"px-4 py-3",children:"3/4位總價"}),(0,a.jsx)("th",{className:"px-4 py-3",children:"最高總價"})]})}),(0,a.jsxs)("tbody",{className:"divide-y divide-white/5",children:[L.map((e,t)=>{let s=T&&null===e.bathrooms,n=O.has(e.roomType),i=s&&n?q(e.roomType):[];return(0,a.jsxs)(r.Fragment,{children:[(0,a.jsxs)("tr",{className:(0,d.cn)("hover:bg-zinc-800/50 transition-colors",n&&"bg-zinc-800/30"),children:[(0,a.jsx)("td",{className:"px-4 py-3 font-medium text-white",children:e.roomType}),(0,a.jsx)("td",{className:"px-4 py-3 text-zinc-400",children:s?(0,a.jsxs)("button",{onClick:()=>{var t;return t=e.roomType,void B(e=>{let s=new Set(e);return s.has(t)?s.delete(t):s.add(t),s})},className:"flex items-center gap-1 text-xs px-2 py-0.5 rounded bg-zinc-700/50 hover:bg-zinc-600 hover:text-white transition-colors cursor-pointer",children:[(0,a.jsx)("span",{children:"全部"}),(0,a.jsx)("span",{className:(0,d.cn)("transform transition-transform text-[10px]",n?"rotate-180":""),children:"▼"})]}):e.bathrooms??"-"}),(0,a.jsx)("td",{className:"px-4 py-3",children:e.projectNames&&e.projectNames.length>0?(0,a.jsxs)("button",{onClick:()=>C(e.roomType,e.bathrooms,e.projectNames||[]),className:"px-2 py-1 text-xs font-medium rounded-full bg-violet-500/20 border border-violet-500/50 text-violet-300 hover:bg-violet-500/30 transition-colors cursor-pointer whitespace-nowrap",children:[e.projectNames.length," 建案"]}):(0,a.jsx)("span",{className:"text-zinc-500",children:"-"})}),(0,a.jsx)("td",{className:"px-4 py-3 text-zinc-300",children:e.count.toLocaleString()}),(0,a.jsx)("td",{className:"px-4 py-3 font-mono text-zinc-300",children:e.avgPrice.toLocaleString(void 0,{maximumFractionDigits:0})}),(0,a.jsx)("td",{className:"px-4 py-3 font-mono text-zinc-500",children:e.minPrice.toLocaleString()}),(0,a.jsx)("td",{className:"px-4 py-3 font-mono text-zinc-500",children:e.q1Price.toLocaleString()}),(0,a.jsx)("td",{className:"px-4 py-3 font-mono text-violet-400 font-bold",children:e.medianPrice.toLocaleString()}),(0,a.jsx)("td",{className:"px-4 py-3 font-mono text-zinc-500",children:e.q3Price.toLocaleString()}),(0,a.jsx)("td",{className:"px-4 py-3 font-mono text-zinc-500",children:e.maxPrice.toLocaleString()})]}),i.map((e,s)=>(0,a.jsxs)("tr",{className:"bg-zinc-900/50 hover:bg-zinc-900 border-l-2 border-l-violet-500/30",children:[(0,a.jsxs)("td",{className:"px-4 py-2 font-medium text-zinc-500 text-xs pl-8",children:["↳ ",e.roomType]}),(0,a.jsxs)("td",{className:"px-4 py-2 text-zinc-400 text-xs",children:[e.bathrooms," 衛"]}),(0,a.jsx)("td",{className:"px-4 py-2",children:e.projectNames&&e.projectNames.length>0?(0,a.jsxs)("button",{onClick:()=>C(e.roomType,e.bathrooms,e.projectNames||[]),className:"text-xs text-zinc-500 hover:text-zinc-300 underline decoration-zinc-700",children:[e.projectNames.length," 建案"]}):"-"}),(0,a.jsx)("td",{className:"px-4 py-2 text-zinc-500 text-xs",children:e.count.toLocaleString()}),(0,a.jsx)("td",{className:"px-4 py-2 font-mono text-zinc-500 text-xs",children:e.avgPrice.toLocaleString(void 0,{maximumFractionDigits:0})}),(0,a.jsx)("td",{className:"px-4 py-2 font-mono text-zinc-600 text-xs",children:e.minPrice.toLocaleString()}),(0,a.jsx)("td",{className:"px-4 py-2 font-mono text-zinc-600 text-xs",children:e.q1Price.toLocaleString()}),(0,a.jsx)("td",{className:"px-4 py-2 font-mono text-zinc-500 text-xs font-medium",children:e.medianPrice.toLocaleString()}),(0,a.jsx)("td",{className:"px-4 py-2 font-mono text-zinc-600 text-xs",children:e.q3Price.toLocaleString()}),(0,a.jsx)("td",{className:"px-4 py-2 font-mono text-zinc-600 text-xs",children:e.maxPrice.toLocaleString()})]},`${t}-sub-${s}`))]},t)}),0===E.length&&(0,a.jsx)("tr",{children:(0,a.jsx)("td",{colSpan:10,className:"p-8 text-center text-zinc-500",children:"請選擇房型顯示數據"})})]})]})})}),(I||F)&&(0,a.jsxs)("div",{className:"space-y-6 pt-4 border-t border-white/5",children:[(0,a.jsxs)("div",{className:"flex items-center justify-between",children:[(0,a.jsx)("h3",{className:"text-lg font-semibold text-white",children:"區域分組交叉分析"}),(0,a.jsxs)("div",{className:"flex bg-zinc-800 rounded-md p-0.5",children:[(0,a.jsx)("button",{onClick:()=>v("district"),className:(0,d.cn)("px-2 py-1 text-xs rounded transition-colors","district"===j?"bg-zinc-700 text-white":"text-zinc-400 hover:text-white"),children:"行政區"}),(0,a.jsx)("button",{onClick:()=>v("county"),className:(0,d.cn)("px-2 py-1 text-xs rounded transition-colors","county"===j?"bg-zinc-700 text-white":"text-zinc-400 hover:text-white"),children:"縣市"})]})]}),"district"===j&&M.length>1&&(0,a.jsxs)("div",{className:"flex items-center gap-2 pb-2",children:[(0,a.jsx)("span",{className:"text-sm text-zinc-500",children:"顯示縣市:"}),(0,a.jsx)("div",{className:"flex gap-1 bg-zinc-900 p-1 rounded-lg",children:M.map(e=>(0,a.jsx)("button",{onClick:()=>A(e),className:(0,d.cn)("px-3 py-1 text-xs font-medium rounded-md transition-all",P===e?"bg-violet-500/20 text-violet-300 shadow-sm border border-violet-500/50":"text-zinc-500 hover:text-zinc-300 hover:bg-zinc-800"),children:e},e))})]}),t.includes("location-table")&&(0,a.jsx)(n.c,{title:"區域房型成交分佈",description:"各區域不同房型的成交數量熱力分佈",containerRef:g,headerAction:(0,a.jsx)(m.N,{data:H,filename:"price_band_location_cross_table",label:"匯出",chartType:"price-band-location-table",targetRef:g,snapshotData:I}),children:(0,a.jsx)("div",{className:"overflow-x-auto",children:I?(0,a.jsxs)("table",{className:"w-full text-sm text-left border-collapse",children:[(0,a.jsx)("thead",{className:"bg-zinc-900/80 text-zinc-400 font-semibold",children:(0,a.jsxs)("tr",{children:[(0,a.jsx)("th",{className:"px-3 py-2 sticky left-0 bg-zinc-900 z-10 border-r border-white/5",children:"房型"}),I.locations.map(e=>(0,a.jsx)("th",{className:"px-3 py-2 text-center min-w-[80px]",children:e},e)),(0,a.jsx)("th",{className:"px-3 py-2 text-center border-l border-white/5 bg-zinc-900 font-bold text-white",children:"總計"})]})}),(0,a.jsx)("tbody",{className:"divide-y divide-white/5",children:I.rows.map((e,t)=>(0,a.jsxs)("tr",{className:"hover:bg-zinc-800/30",children:[(0,a.jsx)("td",{className:"px-3 py-2 font-medium text-zinc-300 sticky left-0 bg-zinc-950/90 border-r border-white/5",children:e.roomType}),e.cells.map((e,t)=>{let s=e>0?Math.min(e/20,1):0,r=e>0?{backgroundColor:`rgba(6, 182, 212, ${.3*s})`}:{};return(0,a.jsx)("td",{className:"px-3 py-2 text-center text-zinc-400",style:r,children:e>0?e:"-"},t)}),(0,a.jsx)("td",{className:"px-3 py-2 text-center font-bold text-white border-l border-white/5 bg-zinc-900/50",children:e.rowTotal})]},t))}),(0,a.jsx)("tfoot",{className:"bg-zinc-900 font-bold border-t-2 border-zinc-700",children:(0,a.jsxs)("tr",{children:[(0,a.jsx)("td",{className:"px-3 py-2 sticky left-0 bg-zinc-900 border-r border-white/5 text-white",children:"總計"}),I.locations.map(e=>(0,a.jsx)("td",{className:"px-3 py-2 text-center text-white",children:I.locationTotals[e]},e)),(0,a.jsx)("td",{className:"px-3 py-2 text-center text-cyan-400 border-l border-white/5 bg-zinc-900",children:I.grandTotal})]})})]}):(0,a.jsx)("div",{className:"p-8 text-center text-zinc-500",children:"無區域分佈數據"})})}),t.includes("location-chart")&&(0,a.jsx)(n.c,{title:"區域成交佔比圖表",containerRef:b,headerAction:(0,a.jsx)(m.N,{data:H,filename:"price_band_location_chart_data",label:"匯出",chartType:"price-band-location-chart",targetRef:b,snapshotData:I}),children:I&&(0,a.jsx)(c,{roomTypes:s,locations:I.locations,crossTable:I.rows.reduce((e,t)=>{let s={};return I.locations.forEach((e,a)=>{s[e]=t.cells[a]}),e[t.roomType]=s,e},{}),dimension:j})})]}),(0,a.jsx)(x,{isOpen:N,onClose:()=>y(!1),title:w,projects:k}),(0,a.jsx)(x,{isOpen:N,onClose:()=>y(!1),title:w,projects:k}),(0,a.jsx)(p.K,{})]})}},83632:(e,t,s)=>{s.d(t,{U:()=>x});var a=s(95155),r=s(12115),n=s(34361),i=s(88042),l=s(98563),c=s(40980);function o({data:e}){if(!e||0===e.length)return(0,a.jsx)("div",{className:"text-zinc-500 text-center p-8",children:"無符合條件的建案可進行類型比較"});let t=Math.max(...e.map(e=>e.shopMultiple),1),s=Math.max(...e.map(e=>e.officeMultiple),1);return(0,a.jsx)("div",{className:"overflow-x-auto max-h-[600px] overflow-y-auto relative scrollbar-thin scrollbar-thumb-zinc-700 scrollbar-track-transparent",children:(0,a.jsxs)("table",{className:"w-full text-sm text-left",children:[(0,a.jsx)("thead",{className:"sticky top-0 z-10 bg-zinc-900 text-zinc-400 font-semibold uppercase text-xs shadow-md",children:(0,a.jsxs)("tr",{children:[(0,a.jsx)("th",{className:"px-4 py-3 whitespace-nowrap",children:"建案名稱"}),(0,a.jsx)("th",{className:"px-4 py-3 text-right",children:"住宅均價"}),(0,a.jsxs)("th",{className:"px-4 py-3 text-right",children:["店舖均價 ",(0,a.jsx)("span",{className:"text-[10px] text-zinc-500 font-normal ml-1",children:"/ 倍數"})]}),(0,a.jsxs)("th",{className:"px-4 py-3 text-right",children:["事務所均價 ",(0,a.jsx)("span",{className:"text-[10px] text-zinc-500 font-normal ml-1",children:"/ 倍數"})]})]})}),(0,a.jsx)("tbody",{className:"divide-y divide-white/5",children:e.map((e,r)=>(0,a.jsxs)("tr",{className:"hover:bg-zinc-800/30 transition-colors",children:[(0,a.jsxs)("td",{className:"px-4 py-3 whitespace-nowrap",children:[(0,a.jsx)("div",{className:"font-medium text-white",children:e.projectName}),(0,a.jsxs)("div",{className:"text-xs text-zinc-500 flex gap-1 mt-0.5",children:[e.county&&(0,a.jsx)("span",{className:"bg-zinc-800 px-1 rounded",children:e.county}),e.district&&(0,a.jsx)("span",{className:"bg-zinc-800 px-1 rounded",children:e.district})]})]}),(0,a.jsx)("td",{className:"px-4 py-3 text-right font-mono text-zinc-300",children:e.residentialAvg>0?(0,c.Z)(e.residentialAvg):"-"}),(0,a.jsxs)("td",{className:"px-4 py-3 text-right",children:[(0,a.jsx)("div",{className:"font-mono text-zinc-300",children:e.shopAvg>0?(0,c.Z)(e.shopAvg):"-"}),e.shopMultiple>0&&(0,a.jsxs)("div",{className:"flex flex-col gap-1 mt-1.5 w-[80px] ml-auto",children:[(0,a.jsx)("div",{className:"h-1 bg-zinc-800 rounded-full overflow-hidden w-full",children:(0,a.jsx)("div",{className:"h-full bg-violet-600 rounded-full",style:{width:`${Math.min(e.shopMultiple/t*100,100)}%`}})}),(0,a.jsxs)("div",{className:"text-[10px] text-right text-violet-400 font-medium",children:[e.shopMultiple.toFixed(2),"x"]})]})]}),(0,a.jsxs)("td",{className:"px-4 py-3 text-right",children:[(0,a.jsx)("div",{className:"font-mono text-zinc-300",children:e.officeAvg>0?(0,c.Z)(e.officeAvg):"-"}),e.officeMultiple>0&&(0,a.jsxs)("div",{className:"flex flex-col gap-1 mt-1.5 w-[80px] ml-auto",children:[(0,a.jsx)("div",{className:"h-1 bg-zinc-800 rounded-full overflow-hidden w-full",children:(0,a.jsx)("div",{className:"h-full bg-cyan-600 rounded-full",style:{width:`${Math.min(e.officeMultiple/s*100,100)}%`}})}),(0,a.jsxs)("div",{className:"text-[10px] text-right text-cyan-400 font-medium",children:[e.officeMultiple.toFixed(2),"x"]})]})]})]},r))})]})})}var d=s(89733);function x({data:e,visibleSections:t=["stats","comparison","chart"]}){let[s,x]=(0,r.useState)("weighted"),[m,h]=(0,r.useState)(30),[p,u]=(0,r.useState)(150),[f,g]=(0,r.useState)(5),[b,j]=(0,r.useState)("count"),v=r.useRef(null),N=r.useRef(null),y=r.useRef(null),w=e?.transactionDetails||[],z=e?.unitPriceAnalysis,k=z?.residentialStats,S=z?.officeStats,P=z?.storeStats,A=z?.typeComparison;return e&&(w.length||z)?(0,a.jsxs)("div",{className:"space-y-8 animate-in fade-in slide-in-from-bottom-4 duration-500",children:[t.includes("stats")&&(0,a.jsx)(n.c,{title:"各用途單價統計",containerRef:v,headerAction:(0,a.jsxs)("div",{className:"flex items-center gap-4",children:[(0,a.jsxs)("div",{className:"flex items-center gap-2",children:[(0,a.jsx)("span",{className:"text-zinc-400 text-xs",children:"平均類型:"}),(0,a.jsxs)("div",{className:"flex bg-zinc-950/50 rounded-md p-1 border border-white/5",children:[(0,a.jsx)("button",{onClick:()=>x("arithmetic"),className:(0,c.cn)("px-2 py-0.5 text-[10px] rounded transition-colors","arithmetic"===s?"bg-violet-500 text-white":"text-zinc-500 hover:text-white"),children:"算術"}),(0,a.jsx)("button",{onClick:()=>x("weighted"),className:(0,c.cn)("px-2 py-0.5 text-[10px] rounded transition-colors","weighted"===s?"bg-violet-500 text-white":"text-zinc-500 hover:text-white"),children:"加權"})]})]}),(0,a.jsx)(d.N,{data:[k,S,P],filename:"unit_price_stats",label:"匯出",chartType:"unit-price-stats",targetRef:v,snapshotData:{residentialStats:k,officeStats:S,storeStats:P,averageType:s}})]}),children:(0,a.jsxs)("div",{className:"grid grid-cols-1 md:grid-cols-3 gap-6",children:[(0,a.jsx)(l.E,{title:"住宅建案統計",stats:k,noDataMessage:"無住宅交易數據",className:"border-violet-500/20",averageType:s}),(0,a.jsx)(l.E,{title:"一般事務所/辦公室統計",stats:S,noDataMessage:"無事務所/辦公室交易數據",className:"border-cyan-500/20",averageType:s}),(0,a.jsx)(l.E,{title:"店舖統計",stats:P,noDataMessage:"無店舖交易數據",className:"border-amber-500/20",averageType:s})]})}),(0,a.jsxs)("div",{className:"flex flex-col lg:flex-row gap-6 items-stretch",children:[t.includes("comparison")&&A&&A.length>0&&(0,a.jsx)("div",{className:"flex-1 min-w-0 flex flex-col",children:(0,a.jsx)(n.c,{title:"建案產品類型單價比較",description:"同一建案內不同用途（住宅/店面/事務所）的單價與倍數比較",containerRef:N,headerAction:(0,a.jsx)(d.N,{data:A,filename:"type_comparison_data",label:"匯出",chartType:"type-comparison-table",targetRef:N,snapshotData:A,columns:{projectName:"建案",residentialAvg:"住宅均價",officeAvg:"辦公均價",storeAvg:"店舖均價",officeRatio:"辦公倍數",storeRatio:"店舖倍數"}}),className:"h-full",children:(0,a.jsx)(o,{data:A})})}),t.includes("chart")&&(0,a.jsx)("div",{className:"flex-1 min-w-0 flex flex-col",children:(0,a.jsx)(n.c,{title:"單價分佈泡泡圖",description:"分析各單價區間的成交熱度與分佈密集區",containerRef:y,headerAction:(0,a.jsx)(d.N,{data:w,filename:"bubble_chart_source_data",label:"匯出",chartType:"unit-price-bubble",targetRef:y,snapshotData:w}),className:"h-full",children:(0,a.jsx)(i.$,{data:w,minPrice:m,maxPrice:p,interval:f,sizeMetric:b,onMinPriceChange:h,onMaxPriceChange:u,onIntervalChange:g,onSizeMetricChange:j})})})]})]}):null}},89733:(e,t,s)=>{s.d(t,{N:()=>v});var a=s(95155),r=s(98500),n=s.n(r);s(12115);var i=s(73321),l=s(6296),c=s(25777),o=s(6962),d=s(66088),x=s(95057),m=s(89239),h=s(38346),p=s(96066),u=s(70872),f=s(72264),g=s(40980),b=s(66609),j=s(98028);function v({data:e,filename:t="export",label:s="匯出",className:r,disabled:v=!1,columns:N,chartType:y,snapshotData:w,targetRef:z}){let{role:k,isLoading:S}=(0,h.h)(),P=(0,i.useRouter)(),A=(0,p.Q)(e=>e.addItem),M=["pro","pro_max","admin","super_admin"].includes(k||""),C=!S,_=()=>{if(C&&M){if(!e||0===e.length)return void alert("無數據可導出");try{let s=Object.keys(e[0]),a=[s.map(e=>N&&N[e]||e).join(","),...e.map(e=>s.map(t=>{let s=e[t];if(null==s)return"";if("number"==typeof s){let e=N&&N[t]||t;return/Area|坪|Rate|Ratio|Share|Percent|比|率/.test(t)||/Area|坪|Rate|Ratio|Share|Percent|比|率/.test(e)?s.toFixed(2):Math.round(s).toFixed(0)}if("object"==typeof s)try{return`"${JSON.stringify(s).replace(/"/g,'""')}"`}catch(e){return""}return"string"==typeof s?`"${s.replace(/"/g,'""').replace(/\n/g," ")}"`:s}).join(","))].join("\n"),r=new Blob(["\uFEFF"+a],{type:"text/csv;charset=utf-8;"}),n=URL.createObjectURL(r),i=document.createElement("a"),l=new Date().toISOString().split("T")[0],c=`${t}_${l}.csv`;i.href=n,i.setAttribute("download",c),document.body.appendChild(i),i.click(),document.body.removeChild(i),URL.revokeObjectURL(n)}catch(e){console.error("Export failed:",e),alert("匯出失敗，請查看控制台日誌")}}},$=async()=>{if(M&&z?.current)try{let e=z.current,s=e.querySelectorAll('[data-export-footer="true"]');s.forEach(e=>{e.style.display="flex"});let a=await (0,j.domToPng)(e,{scale:2,backgroundColor:"#18181b",filter:e=>!(e instanceof HTMLElement&&e.getAttribute("data-html2canvas-ignore"))});s.forEach(e=>{e.style.display="none"});let r=document.createElement("a"),n=new Date().toISOString().split("T")[0];r.href=a,r.download=`${t}_${n}.png`,document.body.appendChild(r),r.click(),document.body.removeChild(r),b.o.success("已成功匯出圖片")}catch(t){console.error("PNG export failed:",t);let e=z.current;e&&e.querySelectorAll('[data-export-footer="true"]').forEach(e=>{e.style.display="none"}),b.o.error("匯出圖片失敗",{description:"請稍後再試或聯繫客服"})}};return S?(0,a.jsxs)(m.$,{variant:"outline",size:"sm",disabled:!0,className:`gap-2 border-dashed border-zinc-700 bg-zinc-900/50 text-zinc-600 ${r}`,children:[(0,a.jsx)(l.A,{className:"h-4 w-4 animate-spin"}),(0,a.jsx)("span",{className:"hidden sm:inline",children:"載入中..."})]}):y?(0,a.jsx)(u.Bc,{children:(0,a.jsxs)(u.m_,{delayDuration:0,children:[(0,a.jsx)(u.k$,{asChild:!0,children:(0,a.jsx)("span",{className:"inline-flex",tabIndex:M?-1:0,children:M?(0,a.jsxs)(f.rI,{children:[(0,a.jsx)(f.ty,{asChild:!0,children:(0,a.jsxs)(m.$,{variant:"outline",size:"sm",disabled:v||!e||0===e.length,className:(0,g.cn)("gap-1.5 border-dashed transition-all border-zinc-700 bg-zinc-900/50 hover:bg-zinc-800 text-zinc-400 hover:text-white",r),children:[(0,a.jsx)(o.A,{className:"h-4 w-4"}),(0,a.jsx)("span",{className:"hidden sm:inline",children:s}),(0,a.jsx)(d.A,{className:"h-3 w-3"})]})}),(0,a.jsxs)(f.SQ,{align:"start",className:"min-w-[180px] bg-zinc-900 border-zinc-700",children:[(0,a.jsxs)(f._2,{onClick:_,className:"flex items-center gap-2 text-zinc-300 hover:text-white focus:text-white cursor-pointer",children:[(0,a.jsx)(o.A,{className:"h-4 w-4 text-zinc-500"}),"匯出 CSV"]}),z&&(0,a.jsxs)(f._2,{onClick:$,className:"flex items-center gap-2 text-zinc-300 hover:text-white focus:text-white cursor-pointer",children:[(0,a.jsx)("div",{className:"h-4 w-4 flex items-center justify-center text-zinc-500 font-bold text-[10px] border border-zinc-600 rounded",children:"P"}),"匯出 PNG (圖片)"]}),(0,a.jsxs)(f._2,{onClick:()=>{M&&y&&(A(y,void 0!==w?w:e),b.o.success("已新增至報表編輯器",{description:"請點選左側「生成報告」繼續編輯",action:{label:"前往編輯",onClick:()=>P.push("/reports/builder")}}))},className:"flex items-center gap-2 text-zinc-300 hover:text-violet-300 focus:text-violet-300 hover:bg-violet-600/20 focus:bg-violet-600/20 cursor-pointer",children:[(0,a.jsx)(x.A,{className:"h-4 w-4 text-violet-500"}),"新增到報表編輯器"]})]})]}):(0,a.jsxs)(m.$,{variant:"outline",size:"sm",disabled:!0,className:(0,g.cn)("gap-1.5 border-dashed transition-all border-zinc-800 bg-zinc-900/30 text-zinc-600 cursor-not-allowed hover:bg-zinc-900/30",r),children:[(0,a.jsx)(c.A,{className:"h-3 w-3"}),(0,a.jsx)("span",{className:"hidden sm:inline",children:s})]})})}),!M&&(0,a.jsx)(u.ZI,{className:"bg-zinc-950 border border-zinc-800 p-0 overflow-hidden",children:(0,a.jsxs)("div",{className:"flex flex-col gap-1 items-center p-3",children:[(0,a.jsx)("p",{className:"font-medium text-zinc-200",children:"Pro 會員限定功能"}),(0,a.jsx)(n(),{href:"/pricing",className:"text-xs text-violet-400 hover:text-violet-300 underline underline-offset-2 transition-colors flex items-center gap-1",children:"查看升級方案 →"})]})})]})}):(0,a.jsx)(u.Bc,{children:(0,a.jsxs)(u.m_,{delayDuration:0,children:[(0,a.jsx)(u.k$,{asChild:!0,children:(0,a.jsx)("span",{className:"inline-flex",tabIndex:M?-1:0,children:(0,a.jsxs)(m.$,{variant:"outline",size:"sm",onClick:_,disabled:v||M&&(!e||0===e.length),className:(0,g.cn)("gap-1.5 border-dashed transition-all",M?"border-zinc-700 bg-zinc-900/50 hover:bg-zinc-800 text-zinc-400 hover:text-white":"border-zinc-800 bg-zinc-900/30 text-zinc-600 cursor-not-allowed hover:bg-zinc-900/30",r),children:[M?(0,a.jsx)(o.A,{className:"h-4 w-4"}):(0,a.jsx)(c.A,{className:"h-3 w-3"}),(0,a.jsx)("span",{className:"hidden sm:inline",children:s})]})})}),!M&&(0,a.jsx)(u.ZI,{className:"bg-zinc-950 border border-zinc-800 p-0 overflow-hidden",children:(0,a.jsxs)("div",{className:"flex flex-col gap-1 items-center p-3",children:[(0,a.jsx)("p",{className:"font-medium text-zinc-200",children:"Pro 會員限定功能"}),(0,a.jsx)(n(),{href:"/pricing",className:"text-xs text-violet-400 hover:text-violet-300 underline underline-offset-2 transition-colors flex items-center gap-1",children:"查看升級方案 →"})]})})]})})}}}]);