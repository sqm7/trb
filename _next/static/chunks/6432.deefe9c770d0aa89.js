(self.webpackChunk_N_E=self.webpackChunk_N_E||[]).push([[6432],{21362:(e,t,r)=>{"use strict";r.d(t,{A:()=>a});let a=(0,r(78340).A)("chevron-right",[["path",{d:"m9 18 6-6-6-6",key:"mthhwq"}]])},23879:()=>{},27529:(e,t,r)=>{"use strict";r.d(t,{FH:()=>n});var a=r(16385),l=r(55873);async function s(){let{data:{session:e}}=await a.N.auth.getSession();return{"Content-Type":"application/json",apikey:l.m5,Authorization:`Bearer ${e?.access_token||l.m5}`}}async function i(e){let t=await s(),r=await fetch(l.Sn.RANKING_ANALYSIS,{method:"POST",headers:t,body:JSON.stringify({filters:e})});if(!r.ok)throw Error((await r.json().catch(()=>({error:`Analysis request failed: ${r.status}`}))).error||"Analyze data failed");return r.json()}let n={checkAuth:async function(){let{data:{session:e}}=await a.N.auth.getSession();e||console.log("User not logged in, but allowing access.")},getUser:async function(){let{data:{user:e}}=await a.N.auth.getUser();return e},signOut:async function(){let{error:e}=await a.N.auth.signOut();if(e)throw console.error("Sign out failed:",e),e},fetchData:async function(e,t){let r=await s(),a=await fetch(l.Sn.QUERY_DATA,{method:"POST",headers:r,body:JSON.stringify({filters:e,pagination:t})});if(!a.ok)throw Error((await a.json().catch(()=>({error:"Failed to parse server response"}))).error||"Fetch data failed");return a.json()},analyzeData:i,analyzeProjectRanking:i,fetchSubData:async function(e,t,r){if(!e||!t||!r)throw Error(`Insufficient parameters: ${e}, ${t}, ${r}`);let a=await s(),i=await fetch(l.Sn.SUB_DATA,{method:"POST",headers:a,body:JSON.stringify({id:e,type:t,county:r})});if(!i.ok)throw Error((await i.json().catch(()=>({error:"Failed to fetch sub data"}))).error||"Fetch sub data failed");return i.json()},fetchProjectNameSuggestions:async function(e,t,r=[]){let a=await s(),i=t.replace(/\u3127/g,"一"),n=await fetch(l.Sn.PROJECT_NAMES,{method:"POST",headers:a,body:JSON.stringify({countyCode:e,query:i,districts:r,detailed:!0})});if(!n.ok)throw Error(`Server error: ${n.status}`);return n.json()},getAdminUsers:async function(){let e=await s(),t=await fetch(l.Sn.GET_USERS,{method:"POST",headers:e,body:JSON.stringify({})});if(!t.ok)throw Error((await t.json().catch(()=>({error:"Failed to fetch users"}))).error||"Fetch users failed");return t.json()},getUserActivity:async function(e,t=200,r=0){let a=await s(),i=await fetch(l.Sn.GET_USER_ACTIVITY,{method:"POST",headers:a,body:JSON.stringify({userId:e,limit:t,offset:r})});if(!i.ok)throw Error((await i.json().catch(()=>({error:"Failed to fetch user activity"}))).error||"Fetch user activity failed");return i.json()},getActivityStats:async function(){let e=await s(),t=await fetch(l.Sn.GET_ACTIVITY_STATS,{method:"POST",headers:e,body:JSON.stringify({})});if(!t.ok)throw Error((await t.json().catch(()=>({error:"Failed to fetch activity stats"}))).error||"Fetch activity stats failed");return t.json()},validateReferralCode:async function(e){let t=await s();return(await fetch(l.Sn.VALIDATE_REFERRAL_CODE,{method:"POST",headers:t,body:JSON.stringify({code:e})})).json()},activateSubscription:async function(e){let t=await s(),r=await fetch(l.Sn.ACTIVATE_SUBSCRIPTION,{method:"POST",headers:t,body:JSON.stringify(e)});if(!r.ok)throw Error((await r.json().catch(()=>({error:"Activation failed"}))).error||"Activation failed");return r.json()},bindReferralCode:async function(e){let t=await s(),r=await fetch(l.Sn.BIND_REFERRAL_CODE,{method:"POST",headers:t,body:JSON.stringify("string"==typeof e?{code:e}:e)});if(!r.ok)throw Error((await r.json().catch(()=>({error:"Failed to bind referral code"}))).error||"Failed to bind referral code");return r.json()},clearReferralCode:async function(){let e=await s(),t=await fetch(l.Sn.BIND_REFERRAL_CODE,{method:"POST",headers:e,body:JSON.stringify({action:"clear"})});if(!t.ok)throw Error((await t.json().catch(()=>({error:"Failed to clear referral code"}))).error||"Failed to clear referral code");return t.json()},getReferralDashboard:async function(){let e=await s(),t=await fetch(l.Sn.GET_REFERRAL_DASHBOARD,{method:"POST",headers:e,body:JSON.stringify({})});if(!t.ok)throw Error((await t.json().catch(()=>({error:"Failed to fetch referral data"}))).error||"Fetch referral dashboard failed");return t.json()},consumeReferralFeature:async function(e,t="consume"){let r=await s(),a=await fetch(l.Sn.CONSUME_REFERRAL_FEATURE,{method:"POST",headers:r,body:JSON.stringify({feature:e,mode:t})});if(!a.ok){let e=await a.json().catch(()=>({error:"Failed to consume feature"}));throw Error(e.error||e.reason||"Failed to consume feature")}return a.json()}}},33024:(e,t,r)=>{"use strict";r.d(t,{A:()=>a});let a=(0,r(78340).A)("layers",[["path",{d:"M12.83 2.18a2 2 0 0 0-1.66 0L2.6 6.08a1 1 0 0 0 0 1.83l8.58 3.91a2 2 0 0 0 1.66 0l8.58-3.9a1 1 0 0 0 0-1.83z",key:"zw3jo"}],["path",{d:"M2 12a1 1 0 0 0 .58.91l8.6 3.91a2 2 0 0 0 1.65 0l8.58-3.9A1 1 0 0 0 22 12",key:"1wduqc"}],["path",{d:"M2 17a1 1 0 0 0 .58.91l8.6 3.91a2 2 0 0 0 1.65 0l8.58-3.9A1 1 0 0 0 22 17",key:"kqbvx6"}]])},33210:(e,t,r)=>{"use strict";r.d(t,{A:()=>a});let a=(0,r(78340).A)("x",[["path",{d:"M18 6 6 18",key:"1bl5f8"}],["path",{d:"m6 6 12 12",key:"d8bk6v"}]])},34198:(e,t,r)=>{"use strict";r.d(t,{K:()=>o});var a=r(95155),l=r(12115),s=r(40980),i=r(33210),n=r(94514);let o=(0,l.forwardRef)(({options:e,value:t,onChange:r,placeholder:o="Select...",maxItems:c,disabled:d=!1,className:u,onSearch:p,loading:y=!1,onFocus:m},h)=>{let[f,x]=(0,l.useState)(""),[b,g]=(0,l.useState)(!1),v=(0,l.useRef)(null),w=(0,l.useRef)(null),j=p?e:e.filter(e=>e.label.toLowerCase().includes(f.toLowerCase()));return t.map(t=>{let r=e.find(e=>e.value===t);return r?r.label:t}),(0,l.useEffect)(()=>{let e=e=>{v.current&&!v.current.contains(e.target)&&g(!1)};return document.addEventListener("mousedown",e),()=>document.removeEventListener("mousedown",e)},[]),(0,l.useEffect)(()=>{p&&p(f)},[f,p]),(0,a.jsxs)("div",{className:(0,s.cn)("relative w-full",u),ref:v,children:[(0,a.jsxs)("div",{className:(0,s.cn)("flex items-center gap-2 bg-zinc-950/50 border border-input rounded-md px-2 py-1.5 h-[42px] overflow-x-auto custom-scrollbar cursor-text transition-all",b&&"ring-2 ring-ring ring-offset-0 border-ring",d&&"bg-zinc-900/50 cursor-not-allowed opacity-50"),onClick:()=>!d&&w.current?.focus(),children:[t.map(l=>{let s=e.find(e=>e.value===l),n=s?s.label:l,o=s?.renderLabel??n;return(0,a.jsxs)("span",{className:"bg-violet-500/20 text-violet-200 border border-violet-500/30 text-xs rounded-full px-2 py-0.5 flex items-center gap-1 animate-in fade-in zoom-in-95 duration-100 whitespace-nowrap shrink-0",children:[o,!d&&(0,a.jsx)(i.A,{size:12,className:"cursor-pointer hover:text-white transition-colors",onClick:e=>{e.stopPropagation(),r(t.filter(e=>e!==l))}})]},l)}),(0,a.jsx)("input",{ref:w,type:"text",value:f,onChange:e=>x(e.target.value),onFocus:()=>{g(!0),m?.()},onKeyDown:e=>{"Backspace"===e.key&&""===f&&t.length>0&&r(t.slice(0,-1))},placeholder:0===t.length?o:"",className:(0,s.cn)("bg-transparent outline-none flex-grow min-w-[60px] text-zinc-100 placeholder:text-zinc-500 text-sm",d&&"cursor-not-allowed"),disabled:d})]}),b&&!d&&(0,a.jsx)("div",{className:"absolute z-[110] w-full mt-1 bg-zinc-900 border border-zinc-700 rounded-md shadow-xl max-h-60 overflow-y-auto custom-scrollbar animate-in fade-in slide-in-from-top-2 duration-100",children:y?(0,a.jsx)("div",{className:"p-2 text-center text-zinc-500 text-sm",children:"Loading..."}):0===j.length?(0,a.jsx)("div",{className:"p-2 text-center text-zinc-500 text-sm",children:"No options found"}):j.map((e,i)=>{if(!e)return null;let o=0===i||e.group!==j[i-1]?.group;return(0,a.jsxs)(l.Fragment,{children:[o&&e.group&&(0,a.jsx)("div",{className:"px-2 py-1 bg-zinc-800/50 text-xs font-semibold text-zinc-400 sticky top-0 backdrop-blur-sm z-10",children:e.group}),(0,a.jsxs)("div",{className:(0,s.cn)("px-3 py-2 cursor-pointer text-sm flex items-start justify-between hover:bg-zinc-800 transition-colors",t.includes(e.value)&&"bg-violet-500/10 text-violet-400"),onClick:()=>(e=>{if(t.includes(e))r(t.filter(t=>t!==e));else{if(c&&t.length>=c)return;r([...t,e])}x("")})(e.value),children:[(0,a.jsxs)("div",{className:"flex flex-col",children:[(0,a.jsx)("span",{className:"font-medium",children:e.renderLabel??e.label}),e.details&&(0,a.jsxs)("div",{className:"flex items-center gap-2 mt-0.5",children:[(e.details.county||e.details.district)&&(0,a.jsxs)("span",{className:"text-xs text-zinc-500 bg-zinc-800/80 px-1.5 rounded border border-zinc-700",children:[e.details.county,e.details.district]}),e.details.date&&(0,a.jsx)("span",{className:"text-xs text-zinc-600 font-mono",children:e.details.date.substring(0,7)})]})]}),t.includes(e.value)&&(0,a.jsx)(n.A,{size:16,className:"mt-1"})]})]},e.value)})})]})});o.displayName="MultiSelect"},41641:(e,t,r)=>{"use strict";r.d(t,{A:()=>a});let a=(0,r(78340).A)("chevron-left",[["path",{d:"m15 18-6-6 6-6",key:"1wnfg3"}]])},61878:(e,t,r)=>{"use strict";r.d(t,{A:()=>a});let a=(0,r(78340).A)("search",[["path",{d:"m21 21-4.34-4.34",key:"14j7rj"}],["circle",{cx:"11",cy:"11",r:"8",key:"4ej97u"}]])},76432:(e,t,r)=>{"use strict";r.r(t),r.d(t,{default:()=>L});var a=r(95155),l=r(12115),s=r(36379),i=r.n(s);r(23879);var n=r(56572),o=r(78340);let c=(0,o.A)("satellite",[["path",{d:"m13.5 6.5-3.148-3.148a1.205 1.205 0 0 0-1.704 0L6.352 5.648a1.205 1.205 0 0 0 0 1.704L9.5 10.5",key:"dzhfyz"}],["path",{d:"M16.5 7.5 19 5",key:"1ltcjm"}],["path",{d:"m17.5 10.5 3.148 3.148a1.205 1.205 0 0 1 0 1.704l-2.296 2.296a1.205 1.205 0 0 1-1.704 0L13.5 14.5",key:"nfoymv"}],["path",{d:"M9 21a6 6 0 0 0-6-6",key:"1iajcf"}],["path",{d:"M9.352 10.648a1.205 1.205 0 0 0 0 1.704l2.296 2.296a1.205 1.205 0 0 0 1.704 0l4.296-4.296a1.205 1.205 0 0 0 0-1.704l-2.296-2.296a1.205 1.205 0 0 0-1.704 0z",key:"nv9zqy"}]]);var d=r(33024);let u=(0,o.A)("palette",[["path",{d:"M12 22a1 1 0 0 1 0-20 10 9 0 0 1 10 9 5 5 0 0 1-5 5h-2.25a1.75 1.75 0 0 0-1.4 2.8l.3.4a1.75 1.75 0 0 1-1.4 2.8z",key:"e79jfc"}],["circle",{cx:"13.5",cy:"6.5",r:".5",fill:"currentColor",key:"1okk4w"}],["circle",{cx:"17.5",cy:"10.5",r:".5",fill:"currentColor",key:"f64h9f"}],["circle",{cx:"6.5",cy:"12.5",r:".5",fill:"currentColor",key:"qy21gx"}],["circle",{cx:"8.5",cy:"7.5",r:".5",fill:"currentColor",key:"fotxhn"}]]);var p=r(21362),y=r(41641),m=r(61878),h=r(6296),f=r(1610),x=r(16385),b=r(34198),g=r(55873),v=r(27529),w=r(41463);let j=[121.5318,25.0478],N="sqm_map_theme",k="sqm_map_theme_manual",S="sqm_map_follow_theme",z="sqm-map-settings",C=e=>e?"cyberpunk"===e?"cyberpunk":"neon_noir"===e?"neon":"default":"default",P=()=>{if("true"!==window.localStorage.getItem(k))return"default";let e=window.localStorage.getItem(N);return"default"===e||"dark"===e||"cyberpunk"===e||"graphite"===e||"neon"===e?e:"default"},A=()=>"true"===window.localStorage.getItem(S),E=e=>e.replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/"/g,"&quot;").replace(/'/g,"&#039;");function L({projects:e=[],refreshToken:t,onMetaChange:r}){let s=(0,l.useRef)(null),o=(0,l.useRef)(null),[L,T]=(0,l.useState)(!1),_="1GYoblfxWX2uc8edFcbq",[F,M]=(0,l.useState)(_?"streets-v2":"demo"),[R,O]=(0,l.useState)(!0),[$,I]=(0,l.useState)(()=>P()),[D,B]=(0,l.useState)(()=>A()),[U,G]=(0,l.useState)(!1),[J,H]=(0,l.useState)("idle"),[q,K]=(0,l.useState)({visible:!1,opacity:.6}),[W,Y]=(0,l.useState)({road:{visible:!1,opacity:.65},school:{visible:!1,opacity:.65},amenity:{visible:!1,opacity:.2}}),[V,Z]=(0,l.useState)(""),[X,Q]=(0,l.useState)([]),[ee,et]=(0,l.useState)(!1),[er,ea]=(0,l.useState)(!1),[el,es]=(0,l.useState)(null),[ei,en]=(0,l.useState)(null),[eo,ec]=(0,l.useState)({zoning:{visible:!1,opacity:.6},cadastral:{visible:!1,opacity:.6}}),[ed,eu]=(0,l.useState)(!1),[ep,ey]=(0,l.useState)(e),[em,eh]=(0,l.useState)(!1),[ef,ex]=(0,l.useState)(null),[eb,eg]=(0,l.useState)("idle"),[ev,ew]=(0,l.useState)(null),[ej,eN]=(0,l.useState)(12),[ek,eS]=(0,l.useState)(18),[ez,eC]=(0,l.useState)([]),[eP,eA]=(0,l.useState)([]),[eE,eL]=(0,l.useState)([]),[eT,e_]=(0,l.useState)([]),[eF,eM]=(0,l.useState)(!1),[eR,eO]=(0,l.useState)(null),[e$,eI]=(0,l.useState)([]),[eD,eB]=(0,l.useState)(!1),[eU,eG]=(0,l.useState)(null),[eJ,eH]=(0,l.useState)([]),[eq,eK]=(0,l.useState)(!1),[eW,eY]=(0,l.useState)(null),[eV,eZ]=(0,l.useState)(!1),[eX,eQ]=(0,l.useState)(.7),e0=(0,l.useRef)(eo),e1=(0,l.useRef)(R),e2=(0,l.useRef)($),e5=(0,l.useRef)($),e3=(0,l.useRef)(!0),e4=(0,l.useRef)(U),e6=(0,l.useRef)(q),e8=(0,l.useRef)(W),e9=(0,l.useRef)(null),e7=(0,l.useRef)(null),te=(0,l.useRef)(null),tt=(0,l.useRef)(null),tr=(0,l.useRef)(null),ta=(0,l.useRef)(null),tl=(0,l.useRef)(null),ts=(0,l.useRef)(!1),ti=(0,l.useRef)(null),tn=(0,l.useRef)(null),to=(0,l.useRef)(0),tc=(0,l.useRef)(null),td=(0,l.useRef)(null),tu=(0,l.useRef)([]),tp=(0,l.useRef)([]),ty=(0,l.useRef)(!1),tm=(0,l.useRef)([]),th=(0,l.useRef)({visible:!1,opacity:.7}),tf=(0,l.useCallback)(()=>{r?.({count:ep.length,isLoading:em,error:ef,status:eb,hasMore:!!ev})},[ep.length,em,ef,eb,ev,r]);(0,l.useEffect)(()=>{tf()},[tf]);let tx=(0,l.useMemo)(()=>Object.keys(g.WG).map(e=>({label:e,value:e})),[]),tb=(0,l.useMemo)(()=>0===ez.length?[]:ez.flatMap(e=>(g.Ib[e]||[]).map(t=>({label:t,value:t,group:e}))),[ez]),tg=(0,l.useCallback)(e=>{e.length>6||(eC(e),eA(t=>t.filter(t=>e.some(e=>(g.Ib[e]||[]).includes(t)))),e_([]),eL([]),eI([]),eG(null))},[]),tv=(0,l.useCallback)(e=>{eA(e),e_([]),eL([]),eI([]),eG(null)},[]),tw=(0,l.useCallback)(async e=>{let t=e.trim();if(0===ez.length||t.length<2)return void eL([]);eM(!0),eO(null);try{let e=ez.map(async e=>{let r=g.WG[e],a=eP.filter(t=>(g.Ib[e]||[]).includes(t));return v.FH.fetchProjectNameSuggestions(r,t,a).then(t=>{let r=[];return Array.isArray(t)?r=t:t&&t.data&&Array.isArray(t.data)?r=t.data:t&&t.names&&Array.isArray(t.names)&&(r=t.names),r.map(t=>{let r="string"==typeof t,a=r?t:t.name||t.建案名稱||String(t);return{label:a,value:a,group:e,details:r?void 0:{county:e,district:t.district||t.行政區,date:t.earliestDate||t.交易日}}})}).catch(t=>(console.error(`Failed to fetch projects for ${e}:`,t),[]))}),r=(await Promise.all(e)).flat(),a=Array.from(new Map(r.map(e=>[e.value,e])).values());eL(a)}catch(e){console.error("Project search error:",e),eO("搜尋失敗，請稍後再試")}finally{eM(!1)}},[ez,eP]),tj=(0,l.useCallback)(e=>{ti.current&&clearTimeout(ti.current),ti.current=setTimeout(()=>{tw(e)},300)},[tw]);(0,l.useEffect)(()=>()=>{ti.current&&clearTimeout(ti.current)},[]);let tN=(0,l.useCallback)(e=>{e_(e),0===e.length&&(eI([]),eG(null))},[]),tk=(0,l.useCallback)(async()=>{if(0===eP.length||0===ez.length){eH([]),eY(null);return}eK(!0),eY(null);try{let e=ez.map(async e=>{let t=g.WG[e],r=eP.filter(t=>(g.Ib[e]||[]).includes(t));return r.length?v.FH.fetchProjectNameSuggestions(t,"",r).then(e=>{let t=[];return Array.isArray(e)?t=e:e&&e.data&&Array.isArray(e.data)?t=e.data:e&&e.names&&Array.isArray(e.names)&&(t=e.names),t.map(e=>"string"==typeof e?e:e.name||e.建案名稱||String(e)).filter(Boolean)}).catch(t=>(console.error(`Failed to fetch district projects for ${e}:`,t),[])):[]}),t=(await Promise.all(e)).flat(),r=Array.from(new Set(t));eH(r)}catch(e){console.error("District project list error:",e),eY("行政區建案清單載入失敗"),eH([])}finally{eK(!1)}},[ez,eP]);(0,l.useEffect)(()=>{tk()},[tk]);let tS=(0,l.useCallback)(async e=>{if(0!==e.length){eB(!0),eG(null);try{let{data:t}=await x.N.auth.getSession(),r=t?.session?.access_token;if(!r)throw Error("無效的授權金鑰");let a=ez.length>0?ez.map(e=>g.WG[e]).filter(Boolean).map(e=>e.toLowerCase()):"all",l=await fetch("https://zxbmbbfrzbtuueysicoc.supabase.co/functions/v1/map-projects",{method:"POST",headers:{"Content-Type":"application/json",Authorization:`Bearer ${r}`},body:JSON.stringify({countyCode:a,projectNames:e,limit:Math.max(200,20*e.length)})});if(!l.ok){let e=await l.json();throw Error(e.error||`HTTP Error: ${l.status}`)}let s=await l.json(),n=(Array.isArray(s?.projects)?s.projects:[]).map(e=>{let t=Number(e.latitude),r=Number(e.longitude);return Number.isFinite(t)&&Number.isFinite(r)?{lat:t,lng:r,name:e.project_name||"建案"}:null}).filter(Boolean);if(eI(n),0===n.length)return void eG("找不到建案座標");let c=o.current;if(c)if(1===n.length)c.flyTo({center:[n[0].lng,n[0].lat],zoom:Math.max(ej,16),speed:1.4});else{let e=new(i()).LngLatBounds;n.forEach(t=>e.extend([t.lng,t.lat])),c.fitBounds(e,{padding:80,maxZoom:Math.max(ej,16)})}}catch(e){console.error("Locate projects error:",e),eG(e.message||"定位失敗")}finally{eB(!1)}}},[ez,ej]);(0,l.useEffect)(()=>{0!==eT.length&&tS(eT)},[eT,tS]);let tz=(0,l.useCallback)(()=>{let e=o.current;if(!e)return null;let t=e.getBounds(),r=e.getZoom(),a={south:t.getSouth(),west:t.getWest(),north:t.getNorth(),east:t.getEast()},l=e.getCenter(),s=Math.abs(a.north-a.south),i=Math.abs(a.east-a.west);return{bbox:a,zoom:r,maxSpanKm:Math.max(111*s,111*i*Math.cos(l.lat*Math.PI/180))}},[]),tC=(0,l.useCallback)((e,t)=>{let r=new Map;return e.forEach(e=>r.set(`${e.county_code}-${e.id}`,e)),t.forEach(e=>r.set(`${e.county_code}-${e.id}`,e)),Array.from(r.values())},[]),tP=(0,l.useCallback)(async({append:e=!1,cursor:t}={})=>{let r=tz();if(!r)return;if(r.zoom<ej){eg("zoom"),ex(null),e||(ey([]),ew(null));return}if(ek>0&&r.maxSpanKm>ek){eg("range"),ex(null),e||(ey([]),ew(null));return}if(eP.length>0){if(eq)return void eg("loading");if(0===eJ.length){ey([]),ew(null),eg("ready");return}}let a=[r.bbox.south.toFixed(5),r.bbox.west.toFixed(5),r.bbox.north.toFixed(5),r.bbox.east.toFixed(5),r.zoom,ej,ek].join("|");if(e){if(tn.current?.key&&tn.current.key!==a)return tP({append:!1})}else tn.current={key:a,bbox:r.bbox,zoom:r.zoom},ew(null);let l=to.current+1;to.current=l,eh(!0),ex(null),eg("loading");try{let{data:a}=await x.N.auth.getSession(),s=a?.session?.access_token;if(!s)throw Error("無效的授權金鑰");let i=ez.length>0?ez.map(e=>g.WG[e]).filter(Boolean).map(e=>e.toLowerCase()):"all",n=eP.length>0?eJ:null,o=await fetch("https://zxbmbbfrzbtuueysicoc.supabase.co/functions/v1/map-projects",{method:"POST",headers:{"Content-Type":"application/json",Authorization:`Bearer ${s}`},body:JSON.stringify({countyCode:i,projectNames:n&&n.length>0?n:void 0,bbox:r.bbox,zoom:r.zoom,limit:800,cursor:e?t:null})});if(!o.ok){let e=await o.json();throw Error(e.error||`HTTP Error: ${o.status}`)}let c=await o.json();if(to.current!==l)return;let d=Array.isArray(c?.projects)?c.projects:[];ey(t=>e?tC(t,d):d),ew(c?.nextCursor??null),eg("ready")}catch(e){if(to.current!==l)return;console.error("Failed to fetch map projects:",e),ex(e.message||"載入建案資料失敗"),eg("error")}finally{to.current===l&&eh(!1)}},[tz,tC,ej,ek,ez,eP,eJ,eq]);(0,l.useEffect)(()=>{void 0!==t&&tP({append:!1})},[t,tP]),(0,l.useEffect)(()=>{tP({append:!1})},[ej,ek,ez,eP,eJ,tP]);let tA=(0,l.useMemo)(()=>[{id:"zoning",label:"國土利用現況調查成果圖",tiles:"https://wmts.nlsc.gov.tw/wmts/LUIMAP/default/GoogleMapsCompatible/{z}/{y}/{x}"},{id:"cadastral",label:"段籍圖（地籍）",tiles:"https://wmts.nlsc.gov.tw/wmts/LANDSECT/default/GoogleMapsCompatible/{z}/{y}/{x}"}],[]),tE=(0,l.useMemo)(()=>[{id:"road",label:"交通路網",tiles:"https://wmts.nlsc.gov.tw/wmts/ROAD/default/GoogleMapsCompatible/{z}/{y}/{x}"},{id:"school",label:"學區範圍",tiles:"https://wmts.nlsc.gov.tw/wmts/SCHOOL/default/GoogleMapsCompatible/{z}/{y}/{x}"}],[]),tL=(0,l.useMemo)(()=>{let e={id:"demo",label:"開源預設",url:"https://demotiles.maplibre.org/style.json"},t={id:"osm",label:"OSM 標準",supportsTheme:!1,style:{version:8,name:"OpenStreetMap Standard",sources:{"osm-tiles":{type:"raster",tiles:["https://tile.openstreetmap.org/{z}/{x}/{y}.png"],tileSize:256,attribution:"\xa9 OpenStreetMap contributors"}},layers:[{id:"osm-tiles",type:"raster",source:"osm-tiles",minzoom:0,maxzoom:19}]}},r=w.env.NEXT_PUBLIC_MAP_CUSTOM_STYLE_URL,a=w.env.NEXT_PUBLIC_MAP_CUSTOM_DARK_STYLE_URL,l=r?[{id:"custom",label:"商業配色",url:r,supportsTheme:!0}]:[],s=a?[{id:"custom-dark",label:"深色自訂",url:a,supportsTheme:!0}]:[],i=_?[{id:"streets-v2",label:"街景",url:`https://api.maptiler.com/maps/streets-v2/style.json?key=${_}`,supportsTheme:!0},{id:"satellite",label:"衛星",url:`https://api.maptiler.com/maps/satellite/style.json?key=${_}`,supportsTheme:!1},{id:"hybrid",label:"衛星混合",url:`https://api.maptiler.com/maps/hybrid/style.json?key=${_}`,supportsTheme:!1},{id:"basic-v2",label:"極簡",url:`https://api.maptiler.com/maps/basic-v2/style.json?key=${_}`,supportsTheme:!0},{id:"topo-v2",label:"地形",url:`https://api.maptiler.com/maps/topo-v2/style.json?key=${_}`,supportsTheme:!0},{id:"dataviz",label:"數據",url:`https://api.maptiler.com/maps/dataviz/style.json?key=${_}`,supportsTheme:!0}]:[];return _?[t,...l,...s,...i]:l.length?[t,...l,...s,e]:[t,e]},[_]),tT={"streets-v2":n.A,satellite:c,hybrid:c,"basic-v2":n.A,"topo-v2":d.A,dataviz:u,osm:n.A,demo:n.A,custom:n.A,"custom-dark":n.A},t_=(0,l.useCallback)(e=>{if(!e3.current)return;let t=e2.current;if("default"===t)return;let r="cyberpunk"===t?{background:"#05020d",land:"#0d0b1f",landSecondary:"#12162a",water:"#00d1ff",park:"#0f3b2e",road:"#3a2b5a",roadMajor:"#ff2bd6",boundary:"#2a1a52",building:"#121022",text:"#e5e7ff",textHalo:"#05020d",poi:"#7dd3fc"}:"neon"===t?{background:"#06070b",land:"#0b0f1a",landSecondary:"#0f172a",water:"#22d3ee",park:"#0b3b3b",road:"#1f2a44",roadMajor:"#22c55e",boundary:"#1f2937",building:"#0b1327",text:"#e2f2ff",textHalo:"#05070d",poi:"#f472b6"}:"graphite"===t?{background:"#0b0c10",land:"#12141b",landSecondary:"#171a22",water:"#475569",park:"#1f2937",road:"#2b313c",roadMajor:"#94a3b8",boundary:"#232833",building:"#111827",text:"#e5e7eb",textHalo:"#0b0c10",poi:"#cbd5f5"}:{background:"#0b0d13",land:"#111827",landSecondary:"#0f172a",water:"#0ea5e9",park:"#0f3d2e",road:"#334155",roadMajor:"#38bdf8",boundary:"#1f2937",building:"#0f172a",text:"#e2e8f0",textHalo:"#020617",poi:"#22d3ee"},a=e.getStyle();if(!a?.layers)return;a.layers.forEach(t=>{let a=t.id,l=t["source-layer"],s=a.toLowerCase();if("background"===t.type&&e.setPaintProperty(a,"background-color",r.background),"fill"===t.type&&("water"===l?e.setPaintProperty(a,"fill-color",r.water):"landcover"===l||"landuse"===l||s.includes("land")?e.setPaintProperty(a,"fill-color",r.land):(s.includes("park")||s.includes("garden"))&&e.setPaintProperty(a,"fill-color",r.park)),"line"===t.type){if("waterway"===l)e.setPaintProperty(a,"line-color",r.water);else if("boundary"===l)e.setPaintProperty(a,"line-color",r.boundary);else if("transportation"===l||"road"===l||s.includes("road")){let t=s.includes("motorway")||s.includes("trunk")||s.includes("primary");e.setPaintProperty(a,"line-color",t?r.roadMajor:r.road)}}"fill-extrusion"===t.type&&"3d-buildings"===a&&e.setPaintProperty(a,"fill-extrusion-color",["interpolate",["linear"],["coalesce",["get","render_height"],["get","height"],6],0,r.building,20,r.road,60,r.poi,120,r.roadMajor,200,"#ef4444"]),"symbol"===t.type&&t.layout?.["text-field"]&&(e.setPaintProperty(a,"text-color",r.text),e.setPaintProperty(a,"text-halo-color",r.textHalo),e.setPaintProperty(a,"text-halo-width",1.2),s.includes("poi")&&e.setPaintProperty(a,"text-color",r.poi))});let l="gov-cadastral-layer";if(e.getLayer(l)){let r="cyberpunk"===t||"neon"===t?{contrast:.6,min:.2,max:1.7,saturation:1.25}:"graphite"===t?{contrast:.4,min:.2,max:1.4,saturation:.9}:{contrast:.35,min:.25,max:1.35,saturation:1.05};e.setPaintProperty(l,"raster-contrast",r.contrast),e.setPaintProperty(l,"raster-brightness-min",r.min),e.setPaintProperty(l,"raster-brightness-max",r.max),e.setPaintProperty(l,"raster-saturation",r.saturation)}let s="osm-levels-points",i="osm-levels-label";e.getLayer(s)&&(e.setPaintProperty(s,"circle-color",r.roadMajor),e.setPaintProperty(s,"circle-stroke-color",r.poi)),e.getLayer(i)&&(e.setPaintProperty(i,"text-color",r.text),e.setPaintProperty(i,"text-halo-color",r.textHalo),e.setPaintProperty(i,"text-halo-width",1.1))},[]),tF=(0,l.useCallback)(e=>{let t=e.getStyle();t?.layers&&t.layers.forEach(t=>{"symbol"!==t.type||t.layout?.["text-field"]&&e.setLayoutProperty(t.id,"text-field",["coalesce",["get","name:zh-Hant"],["get","name:zh"],["get","name"],["get","name:en"]])})},[]),tM=(0,l.useCallback)(e=>{e.getSource("osm-overlay")||e.addSource("osm-overlay",{type:"raster",tiles:["https://tile.openstreetmap.org/{z}/{x}/{y}.png"],tileSize:256,attribution:"\xa9 OpenStreetMap contributors"}),e.getLayer("osm-overlay-layer")||e.addLayer({id:"osm-overlay-layer",type:"raster",source:"osm-overlay",layout:{visibility:"none"},paint:{"raster-opacity":e6.current.opacity}})},[]),tR=(0,l.useCallback)(e=>{let t="osm-overlay-layer";e.getLayer(t)&&(e.setLayoutProperty(t,"visibility",e6.current.visible?"visible":"none"),e.setPaintProperty(t,"raster-opacity",e6.current.opacity))},[]),tO=(0,l.useCallback)((e,t,r=64)=>{let[a,l]=e,s=[],i=t/(111320*Math.cos(l*Math.PI/180)),n=t/110540;for(let e=0;e<=r;e++){let t=e*Math.PI*2/r,o=Math.cos(t)*i,c=Math.sin(t)*n;s.push([a+o,l+c])}return s},[]),t$=(0,l.useCallback)(e=>{e.getSource("amenity-circles")||e.addSource("amenity-circles",{type:"geojson",data:{type:"FeatureCollection",features:[]}}),e.getLayer("amenity-circles-fill")||e.addLayer({id:"amenity-circles-fill",type:"fill",source:"amenity-circles",paint:{"fill-color":"#22d3ee","fill-opacity":e8.current.amenity.opacity}}),e.getLayer("amenity-circles-line")||e.addLayer({id:"amenity-circles-line",type:"line",source:"amenity-circles",paint:{"line-color":"#38bdf8","line-width":1.2,"line-opacity":.85}})},[]),tI=(0,l.useCallback)(e=>{let t=e7.current||e9.current||[e.getCenter().lng,e.getCenter().lat],r=[300,600,1e3].map((e,r)=>({type:"Feature",properties:{radius:e,label:`${e}m`,idx:r},geometry:{type:"Polygon",coordinates:[tO(t,e)]}}));e.getSource("amenity-circles").setData({type:"FeatureCollection",features:r})},[tO]),tD=(0,l.useCallback)(e=>{tE.forEach(t=>{let r=`life-${t.id}-layer`;if(!e.getLayer(r))return;let a=e8.current[t.id];a&&(e.setLayoutProperty(r,"visibility",a.visible?"visible":"none"),e.setPaintProperty(r,"raster-opacity",a.opacity))}),e.getLayer("amenity-circles-fill")&&(e.setLayoutProperty("amenity-circles-fill","visibility",e8.current.amenity.visible?"visible":"none"),e.setLayoutProperty("amenity-circles-line","visibility",e8.current.amenity.visible?"visible":"none"),e.setPaintProperty("amenity-circles-fill","fill-opacity",e8.current.amenity.opacity))},[tE]),tB=(0,l.useCallback)(e=>{e.getSource("osm-levels")||e.addSource("osm-levels",{type:"geojson",data:{type:"FeatureCollection",features:[]}}),e.getLayer("osm-levels-points")||e.addLayer({id:"osm-levels-points",type:"circle",source:"osm-levels",paint:{"circle-color":"#38bdf8","circle-radius":4,"circle-opacity":.7,"circle-stroke-color":"#22d3ee","circle-stroke-width":1}}),e.getLayer("osm-levels-label")||e.addLayer({id:"osm-levels-label",type:"symbol",source:"osm-levels",layout:{"text-field":["get","levelsLabel"],"text-size":11,"text-anchor":"center","text-allow-overlap":!0},paint:{"text-color":"#e2e8f0","text-halo-color":"#0b0d13","text-halo-width":1.1}})},[]),tU=(0,l.useCallback)((e,t)=>{let r=t?"visible":"none";e.getLayer("osm-levels-points")&&e.setLayoutProperty("osm-levels-points","visibility",r),e.getLayer("osm-levels-label")&&e.setLayoutProperty("osm-levels-label","visibility",r)},[]),tG=(0,l.useCallback)(e=>{e.getSource("search-point")||e.addSource("search-point",{type:"geojson",data:{type:"FeatureCollection",features:[]}}),e.getLayer("search-point-layer")||e.addLayer({id:"search-point-layer",type:"circle",source:"search-point",paint:{"circle-color":"#22d3ee","circle-radius":6,"circle-stroke-color":"#0ea5e9","circle-stroke-width":2,"circle-opacity":.9}})},[]),tJ=(0,l.useCallback)(e=>{e.getSource("project-points")||e.addSource("project-points",{type:"geojson",data:{type:"FeatureCollection",features:[]}}),e.getLayer("project-points-layer")||e.addLayer({id:"project-points-layer",type:"circle",source:"project-points",paint:{"circle-color":["case",["boolean",["get","isSelected"],!1],"#f59e0b",["boolean",["get","filterActive"],!1],"#2dd4bf","#22d3ee"],"circle-radius":["case",["boolean",["get","isSelected"],!1],7,5],"circle-opacity":["case",["boolean",["get","dim"],!1],.35,.9],"circle-stroke-color":["case",["boolean",["get","isSelected"],!1],"#fcd34d",["boolean",["get","filterActive"],!1],"#99f6e4","#67e8f9"],"circle-stroke-width":["case",["boolean",["get","isSelected"],!1],2,1.2]}}),e.getSource("project-locate")||e.addSource("project-locate",{type:"geojson",data:{type:"FeatureCollection",features:[]}}),e.getLayer("project-locate-layer")||e.addLayer({id:"project-locate-layer",type:"circle",source:"project-locate",paint:{"circle-color":"#f59e0b","circle-radius":8,"circle-opacity":.85,"circle-stroke-color":"#fef3c7","circle-stroke-width":2}})},[]),tH=(0,l.useCallback)(e=>{let t=e.getSource("project-points");if(t){let e=new Set(tp.current),r=tp.current.length>0,a=ty.current,l=tu.current.map(t=>{let l=Number(t.latitude),s=Number(t.longitude);if(!Number.isFinite(l)||!Number.isFinite(s))return null;let i=e.has(t.project_name);return{type:"Feature",properties:{id:t.id,project_name:t.project_name,developer:t.developer,total_households:t.total_households,total_floors:t.total_floors,structure:t.structure,public_ratio:t.public_ratio,site_area:t.site_area,enrichment_status:t.enrichment_status,isSelected:i,dim:r&&!i,filterActive:a},geometry:{type:"Point",coordinates:[s,l]}}}).filter(Boolean);t.setData({type:"FeatureCollection",features:l})}let r=e.getSource("project-locate");if(r){let e=tm.current.map(e=>({type:"Feature",properties:{name:e.name},geometry:{type:"Point",coordinates:[e.lng,e.lat]}}));r.setData({type:"FeatureCollection",features:e})}},[]),tq=(0,l.useCallback)(e=>{e.getSource("village-boundary")||e.addSource("village-boundary",{type:"raster",tiles:["https://wmts.nlsc.gov.tw/wmts/VILLAGE/default/GoogleMapsCompatible/{z}/{y}/{x}"],tileSize:256}),e.getLayer("village-boundary-layer")||e.addLayer({id:"village-boundary-layer",type:"raster",source:"village-boundary",layout:{visibility:"none"},minzoom:13,paint:{"raster-opacity":th.current.opacity}})},[]),tK=(0,l.useCallback)(e=>{e.getLayer("village-boundary-layer")&&(e.setLayoutProperty("village-boundary-layer","visibility",th.current.visible?"visible":"none"),e.setPaintProperty("village-boundary-layer","raster-opacity",th.current.opacity))},[]),tW=(0,l.useCallback)(async e=>{if(16>e.getZoom())return void H("zoom");let t=e.getBounds(),r=Math.abs(t.getNorth()-t.getSouth()),a=Math.abs(t.getEast()-t.getWest());if(r>.12||a>.12)return void H("zoom");let l=`${t.getSouth()},${t.getWest()},${t.getNorth()},${t.getEast()}`;if(l===tl.current)return;tl.current=l,tr.current&&tr.current.abort();let s=new AbortController;tr.current=s,H("loading");let i=`[out:json][timeout:25];
(
  way["building"]["building:levels"](${l});
  way["building"]["levels"](${l});
);
out center;`,n=null;for(let e of["https://overpass-api.de/api/interpreter","https://overpass.kumi.systems/api/interpreter","https://overpass.nchc.org.tw/api/interpreter"])try{let t=await fetch(e,{method:"POST",body:i,signal:s.signal,headers:{"Content-Type":"text/plain"}});if(!t.ok)throw Error(`OSM fetch failed: ${t.status}`);n=await t.json();break}catch(e){if(e?.name==="AbortError")return;n=null}if(!n)return void H("error");let o=(n?.elements||[]).filter(e=>"way"===e.type&&e.center).map(e=>{let t=e.tags||{},r=Number.parseInt(t["building:levels"]||t.levels,10);return r&&e.center?{type:"Feature",properties:{id:e.id,levels:r,levelsLabel:`${r}F`},geometry:{type:"Point",coordinates:[e.center.lon,e.center.lat]}}:null}).filter(Boolean);e.getSource("osm-levels").setData({type:"FeatureCollection",features:o}),H("ready")},[]),tY=(0,l.useCallback)(e=>{if(!e1.current)return;let t=e.getStyle();if(!t?.layers)return;let r=t.layers.find(e=>"symbol"===e.type&&e.layout?.["text-field"])?.id,a=e.getSource("openmaptiles")?"openmaptiles":e.getSource("maptiler")?"maptiler":null;!a||e.getLayer("3d-buildings")||e.addLayer({id:"3d-buildings",source:a,"source-layer":"building",type:"fill-extrusion",minzoom:15,paint:{"fill-extrusion-color":["interpolate",["linear"],["coalesce",["get","render_height"],["get","height"],6],0,"#1f2937",20,"#334155",50,"#38bdf8",100,"#f97316",200,"#ef4444"],"fill-extrusion-height":["coalesce",["get","render_height"],["get","height"],6],"fill-extrusion-base":["coalesce",["get","render_min_height"],["get","min_height"],0],"fill-extrusion-opacity":.85}},r)},[]),tV=(0,l.useCallback)(e=>{tE.forEach(t=>{let r=`life-${t.id}`,a=`life-${t.id}-layer`;e.getSource(r)||e.addSource(r,{type:"raster",tiles:[t.tiles],tileSize:256}),e.getLayer(a)||e.addLayer({id:a,type:"raster",source:r,layout:{visibility:"none"},paint:{"raster-opacity":e8.current[t.id].opacity}})})},[tE]);(0,l.useEffect)(()=>{if(!s.current||o.current)return;let e=tL.find(e=>e.id===F),t=e?.url??e?.style??"https://demotiles.maplibre.org/style.json";e3.current=e?.supportsTheme??!0;let r=new(i()).Map({container:s.current,style:t,center:j,zoom:14,pitch:45,bearing:-15,antialias:!0});r.addControl(new(i()).NavigationControl({showCompass:!0}),"top-right"),r.on("style.load",()=>{if(tY(r),tA.forEach(e=>{if(!e.tiles)return;let t=`gov-${e.id}`,a=`gov-${e.id}-layer`;r.getSource(t)||r.addSource(t,{type:"raster",tiles:[e.tiles],tileSize:256}),r.getLayer(a)||r.addLayer({id:a,type:"raster",source:t,layout:{visibility:"none"},paint:{"raster-opacity":e0.current[e.id]?.opacity??.6}})}),tA.forEach(e=>{if(!e.tiles)return;let t=`gov-${e.id}-layer`;if(!r.getLayer(t))return;let a=e0.current[e.id];a&&(r.setLayoutProperty(t,"visibility",a.visible?"visible":"none"),r.setPaintProperty(t,"raster-opacity",a.opacity))}),tM(r),tR(r),tV(r),t$(r),tD(r),tI(r),tG(r),tB(r),tU(r,e4.current),tJ(r),tH(r),tq(r),tK(r),e4.current&&tW(r),e9.current){let e=r.getSource("search-point");e&&e.setData({type:"FeatureCollection",features:[{type:"Feature",properties:{},geometry:{type:"Point",coordinates:e9.current}}]})}tF(r),t_(r),ts.current||(ts.current=!0,T(!0))}),o.current=r;let a=new ResizeObserver(()=>r.resize());return a.observe(s.current),()=>{a.disconnect(),r.remove(),o.current=null}},[]),(0,l.useEffect)(()=>{e1.current=R,e4.current=U,e6.current=q,e8.current=W,e7.current=ei,e9.current=el,e0.current=eo;let e=o.current;if(e&&(tA.forEach(t=>{if(!t.tiles)return;let r=`gov-${t.id}-layer`;if(!e.getLayer(r))return;let a=eo[t.id];a&&(e.setLayoutProperty(r,"visibility",a.visible?"visible":"none"),e.setPaintProperty(r,"raster-opacity",a.opacity))}),tR(e),tD(e),W.amenity.visible&&tI(e),el)){let t=e.getSource("search-point");t&&t.setData({type:"FeatureCollection",features:[{type:"Feature",properties:{},geometry:{type:"Point",coordinates:el}}]})}},[eo,tA,q,W,ei,el,tD,tI]),(0,l.useEffect)(()=>{e2.current=$},[$]),(0,l.useEffect)(()=>{let e=()=>{let e=A();(B(e),e)?I(C(document.documentElement.getAttribute("data-theme"))):I(P())},t=t=>{(t.key===N||t.key===S||t.key===k)&&e()};return window.addEventListener("storage",t),window.addEventListener(z,e),()=>{window.removeEventListener("storage",t),window.removeEventListener(z,e)}},[]),(0,l.useEffect)(()=>{if(!D)return;let e=()=>{I(C(document.documentElement.getAttribute("data-theme")))};e();let t=new MutationObserver(e);return t.observe(document.documentElement,{attributes:!0,attributeFilter:["data-theme"]}),()=>t.disconnect()},[D]),(0,l.useEffect)(()=>{D||(window.localStorage.setItem(N,$),window.localStorage.setItem(k,"true"))},[$,D]),(0,l.useEffect)(()=>{let e=o.current;if(e){if(!R){e.getLayer("3d-buildings")&&e.removeLayer("3d-buildings"),e.easeTo({pitch:0,bearing:0,duration:450});return}tY(e),e.easeTo({pitch:45,bearing:-15,duration:450})}},[R,tY]),(0,l.useEffect)(()=>{let e=o.current;if(!e)return;let t=tL.find(e=>e.id===F);if(!t)return;let r=t.url??t.style;r&&(e3.current=t.supportsTheme??!0,e.setStyle(r,{diff:!1}))},[F,tL]),(0,l.useEffect)(()=>{let e=o.current;if(e&&L){if("default"===$){if("default"!==e5.current){let t=tL.find(e=>e.id===F),r=t?.url??t?.style;r&&e.setStyle(r,{diff:!1})}}else t_(e);e5.current=$}},[$,L,t_,F,tL]),(0,l.useEffect)(()=>{let e=o.current;e&&L&&tF(e)},[L,tF]),(0,l.useEffect)(()=>{if(!_)return;let e=V.trim();if(e.length<2){Q([]),et(!1),ea(!1);return}return tt.current&&window.clearTimeout(tt.current),te.current&&te.current.abort(),ea(!0),tt.current=window.setTimeout(async()=>{let t=new AbortController;te.current=t;try{let r=o.current,a=r?r.getCenter():{lng:j[0],lat:j[1]},l=`https://api.maptiler.com/geocoding/${encodeURIComponent(e)}.json?key=${_}&language=zh&limit=6&proximity=${a.lng},${a.lat}`,s=await fetch(l,{signal:t.signal});if(!s.ok)throw Error(`Geocoding error ${s.status}`);let i=await s.json();Q(Array.isArray(i?.features)?i.features:[]),et(!0)}catch(e){if(e?.name==="AbortError")return;Q([]),et(!1)}finally{ea(!1)}},320),()=>{tt.current&&window.clearTimeout(tt.current),te.current&&te.current.abort()}},[V,_]);let tZ=(0,l.useCallback)(e=>{if(!e?.center)return;let[t,r]=e.center,a=[t,r];es(a),en(a);let l=o.current;l&&l.flyTo({center:a,zoom:Math.max(l.getZoom(),16),speed:1.4}),et(!1)},[]),tX=(0,l.useCallback)(()=>{let e=o.current;if(!e)return;let t=e.getCenter();en([t.lng,t.lat]),tI(e)},[tI]);return(0,l.useEffect)(()=>{let e=o.current;if(!e||!L)return;tB(e),tU(e,U),U?tW(e):H("idle");let t=()=>{e4.current&&(ta.current&&window.clearTimeout(ta.current),ta.current=window.setTimeout(()=>{tW(e)},400)),e8.current.amenity.visible&&!e7.current&&tI(e),tc.current&&window.clearTimeout(tc.current),tc.current=window.setTimeout(()=>{tP({append:!1})},250)};return e.on("moveend",t),()=>{e.off("moveend",t),ta.current&&window.clearTimeout(ta.current),tc.current&&window.clearTimeout(tc.current)}},[L,U,tB,tU,tW,tI,tP]),(0,l.useEffect)(()=>{L&&tP({append:!1})},[L,tP]),(0,l.useEffect)(()=>{tu.current=ep,tp.current=eT,ty.current=ez.length>0||eP.length>0,tm.current=e$,th.current={visible:eV,opacity:eX};let e=o.current;e&&(tH(e),tK(e))},[ep,eT,ez,eP,e$,eV,eX,tH,tK]),(0,l.useEffect)(()=>{let e=o.current;if(!e||!L)return;let t=t=>{let r=e.queryRenderedFeatures(t.point,{layers:["project-points-layer"]}),a=r?.[0];if(!a||"Point"!==a.geometry.type)return;let l=a.properties||{},s=E(l.project_name||"建案"),n=E(l.developer||"未知建商"),o=E(l.total_households||"-"),c=E(l.total_floors||"-"),d=E(l.public_ratio||"-"),u=E(l.site_area||"-"),p=E(l.structure||"-"),y="done"===l.enrichment_status,m=`
        <div class="min-w-[240px] text-sm text-zinc-100">
          <div class="flex items-start justify-between gap-3 border-b border-white/10 pb-2">
            <div>
              <div class="text-base font-semibold text-white">${s}</div>
              <div class="text-[12px] text-zinc-400">${n}</div>
            </div>
            ${y?'<span class="text-[10px] px-2 py-0.5 rounded-full bg-emerald-500/20 text-emerald-200">資料完備</span>':""}
          </div>
          <div class="grid grid-cols-2 gap-x-4 gap-y-2 mt-2 text-[12px]">
            <div><span class="text-zinc-500">總戶數</span><div class="text-zinc-200">${o} 戶</div></div>
            <div><span class="text-zinc-500">樓層</span><div class="text-zinc-200">${c}</div></div>
            <div><span class="text-zinc-500">公設比</span><div class="text-zinc-200">${d}</div></div>
            <div><span class="text-zinc-500">基地面積</span><div class="text-zinc-200">${u}</div></div>
            <div class="col-span-2"><span class="text-zinc-500">結構</span><div class="text-zinc-200">${p}</div></div>
          </div>
        </div>
      `,h=a.geometry.coordinates;td.current&&td.current.remove(),td.current=new(i()).Popup({closeButton:!0,closeOnClick:!0}).setLngLat(h).setHTML(m).addTo(e)},r=()=>{e.getCanvas().style.cursor="pointer"},a=()=>{e.getCanvas().style.cursor=""};return e.on("click",t),e.on("mouseenter","project-points-layer",r),e.on("mouseleave","project-points-layer",a),()=>{e.off("click",t),e.off("mouseenter","project-points-layer",r),e.off("mouseleave","project-points-layer",a)}},[L]),(0,a.jsxs)("div",{className:"relative w-full h-full rounded-xl overflow-hidden border border-white/10 shadow-2xl",children:[ed?(0,a.jsxs)("button",{onClick:()=>eu(!1),className:"absolute top-4 left-4 z-[500] flex items-center gap-2 rounded-full border border-white/10 bg-zinc-900/80 px-2.5 py-1.5 text-[11px] text-zinc-200 shadow-lg backdrop-blur hover:border-white/30",children:[(0,a.jsx)(p.A,{className:"h-3.5 w-3.5"}),"工具面板"]}):(0,a.jsxs)("div",{className:"absolute top-4 left-4 z-[500] w-72 flex flex-col gap-3 max-h-[calc(100vh-2rem)] overflow-y-auto pr-1",children:[(0,a.jsx)("div",{className:"flex justify-end",children:(0,a.jsxs)("button",{onClick:()=>eu(!0),className:"flex items-center gap-1 rounded-full border border-white/10 bg-zinc-900/80 px-2 py-0.5 text-[10px] text-zinc-400 hover:border-white/30",children:[(0,a.jsx)(y.A,{className:"h-3.5 w-3.5"}),"收合"]})}),(0,a.jsxs)("div",{className:"bg-zinc-900/90 backdrop-blur-md p-3 rounded-xl border border-white/10 shadow-lg",children:[(0,a.jsxs)("div",{className:"flex gap-2",children:[(0,a.jsxs)("div",{className:"relative flex-1",children:[(0,a.jsx)(m.A,{className:"absolute left-3 top-2 h-3.5 w-3.5 text-zinc-400"}),(0,a.jsx)("input",{value:V,onChange:e=>Z(e.target.value),onFocus:()=>et(!0),onKeyDown:e=>{"Enter"===e.key&&X.length>0&&tZ(X[0])},placeholder:_?"搜尋地址或地標":"需要 MapTiler Key 才能搜尋",className:"w-full bg-zinc-800/50 border border-zinc-700 rounded-lg pl-9 pr-3 py-1.5 text-[12px] text-white focus:ring-1 focus:ring-cyan-500 outline-none",disabled:!_})]}),er&&(0,a.jsx)("span",{className:"text-[11px] text-cyan-300",children:"搜尋中"})]}),ee&&X.length>0&&(0,a.jsx)("div",{className:"mt-2 rounded-xl border border-white/10 bg-zinc-950/95 shadow-xl overflow-hidden",children:X.map(e=>(0,a.jsxs)("button",{onMouseDown:()=>tZ(e),className:"w-full text-left px-2.5 py-1.5 text-[11px] text-zinc-200 hover:bg-white/5 transition-colors",children:[(0,a.jsx)("div",{className:"font-medium",children:e.text||e.place_name}),e.place_name&&(0,a.jsx)("div",{className:"text-[10px] text-zinc-500",children:e.place_name})]},e.id))})]}),(0,a.jsxs)("div",{className:"bg-zinc-900/90 backdrop-blur-md p-3 rounded-xl border border-white/10 shadow-lg space-y-2.5",children:[(0,a.jsxs)("div",{className:"flex items-center justify-between",children:[(0,a.jsxs)("div",{className:"text-[11px] font-bold text-zinc-400 uppercase flex items-center gap-2",children:[(0,a.jsx)(d.A,{className:"h-3 w-3"})," 建案搜尋"]}),eD&&(0,a.jsx)("span",{className:"text-[10px] text-cyan-300",children:"定位中..."})]}),(0,a.jsxs)("div",{className:"space-y-2.5",children:[(0,a.jsxs)("div",{className:"space-y-1",children:[(0,a.jsx)("label",{className:"text-[10px] text-zinc-500",children:"縣市"}),(0,a.jsx)(b.K,{options:tx,value:ez,onChange:tg,placeholder:"選擇縣市..."})]}),(0,a.jsxs)("div",{className:"space-y-1",children:[(0,a.jsx)("label",{className:"text-[10px] text-zinc-500",children:"行政區"}),(0,a.jsx)(b.K,{options:tb,value:eP,onChange:tv,placeholder:ez.length>0?"選擇行政區...":"請先選縣市",disabled:0===ez.length})]}),(0,a.jsxs)("div",{className:"space-y-1",children:[(0,a.jsx)("label",{className:"text-[10px] text-zinc-500",children:"建案名稱"}),(0,a.jsx)(b.K,{options:eE,value:eT,onChange:tN,placeholder:ez.length>0?"輸入建案名稱搜尋...":"請先選縣市",onSearch:tj,loading:eF,disabled:0===ez.length})]}),(0,a.jsxs)("div",{className:"flex items-center justify-between pt-0.5",children:[(0,a.jsxs)("div",{className:"text-[10px] text-zinc-500 flex items-center gap-2",children:[(0,a.jsx)(d.A,{className:"h-3 w-3 text-cyan-400"}),"村里界線（NLSC）"]}),(0,a.jsxs)("label",{className:"relative inline-flex items-center cursor-pointer",children:[(0,a.jsx)("input",{type:"checkbox",checked:eV,onChange:e=>eZ(e.target.checked),className:"sr-only peer"}),(0,a.jsx)("div",{className:"w-9 h-5 bg-zinc-700 peer-focus:outline-none rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-4 after:w-4 after:transition-all peer-checked:bg-cyan-600"})]})]}),(0,a.jsxs)("label",{className:"space-y-1 text-[10px] text-zinc-500 block",children:[(0,a.jsx)("span",{children:"界線透明度"}),(0,a.jsx)("input",{type:"range",min:.2,max:1,step:.05,value:eX,onChange:e=>eQ(parseFloat(e.target.value)),className:"w-full",disabled:!eV})]}),(0,a.jsx)("div",{className:"text-[10px] text-zinc-600",children:"縮放到 z13+ 才會顯示細部里界"})]}),eR&&(0,a.jsx)("div",{className:"text-[10px] text-rose-300",children:eR}),eW&&(0,a.jsx)("div",{className:"text-[10px] text-rose-300",children:eW}),eU&&(0,a.jsx)("div",{className:"text-[10px] text-rose-300",children:eU}),eq&&(0,a.jsxs)("div",{className:"text-[10px] text-cyan-300 flex items-center gap-2",children:[(0,a.jsx)(h.A,{className:"h-3 w-3 animate-spin"})," 讀取行政區建案清單..."]}),(0,a.jsxs)("div",{className:"text-[10px] text-zinc-600 leading-relaxed",children:["篩選後建案會以 ",(0,a.jsx)("span",{className:"text-teal-300",children:"藍綠色"})," 呈現；選定建案會以 ",(0,a.jsx)("span",{className:"text-amber-300",children:"琥珀色"})," 高亮並定位。"]})]}),(0,a.jsxs)("div",{className:"bg-zinc-900/90 backdrop-blur-md p-3 rounded-xl border border-white/10 shadow-lg space-y-2.5",children:[(0,a.jsxs)("div",{className:"flex items-center justify-between text-[12px] text-zinc-200",children:[(0,a.jsxs)("div",{className:"flex items-center gap-2",children:[(0,a.jsx)(d.A,{className:"h-4 w-4 text-cyan-400"}),(0,a.jsx)("span",{children:"建案載入"})]}),(0,a.jsxs)("span",{className:"text-[10px] text-zinc-500",children:[ep.length.toLocaleString()," 筆"]})]}),(0,a.jsxs)("label",{className:"space-y-1 text-[10px] text-zinc-500 block",children:[(0,a.jsxs)("span",{children:["最小縮放層級：",ej]}),(0,a.jsx)("input",{type:"range",min:10,max:18,step:1,value:ej,onChange:e=>eN(parseInt(e.target.value,10)),className:"w-full"})]}),(0,a.jsxs)("label",{className:"space-y-1 text-[10px] text-zinc-500 block",children:[(0,a.jsxs)("span",{children:["最大可視範圍：",ek," km"]}),(0,a.jsx)("input",{type:"range",min:4,max:60,step:1,value:ek,onChange:e=>eS(parseInt(e.target.value,10)),className:"w-full"})]}),"zoom"===eb&&(0,a.jsxs)("div",{className:"text-[10px] text-amber-300",children:["請放大到 ",ej,"+ 才會載入建案"]}),"range"===eb&&(0,a.jsxs)("div",{className:"text-[10px] text-amber-300",children:["範圍過大，請縮小到 ",ek," km 內"]}),"loading"===eb&&(0,a.jsxs)("div",{className:"text-[10px] text-cyan-300 flex items-center gap-2",children:[(0,a.jsx)(h.A,{className:"h-3 w-3 animate-spin"})," 載入建案中..."]}),"error"===eb&&(0,a.jsx)("div",{className:"text-[10px] text-rose-300",children:"建案載入失敗，請稍後再試"}),ev&&(0,a.jsx)("button",{onClick:()=>tP({append:!0,cursor:ev}),disabled:em,className:"w-full rounded-lg border border-white/10 px-2 py-1 text-[10px] text-zinc-200 hover:border-white/30 disabled:opacity-50",children:"載入更多"})]})]}),(0,a.jsxs)("div",{className:"absolute top-4 right-4 z-20 rounded-2xl bg-zinc-900/85 px-3 py-2.5 text-[10px] text-zinc-300 border border-white/10 shadow-lg space-y-2.5 w-56",children:[(0,a.jsxs)("div",{className:"flex items-center gap-2 text-[11px] font-semibold text-white",children:[(0,a.jsx)(d.A,{className:"h-4 w-4 text-cyan-400"}),"圖層控制"]}),(0,a.jsx)("div",{className:"space-y-2.5",children:tA.map(e=>{let t=eo[e.id],r=!e.tiles;return(0,a.jsxs)("div",{className:r?"opacity-40":"",children:[(0,a.jsxs)("label",{className:"flex items-center justify-between gap-3 text-[11px] text-zinc-300",children:[(0,a.jsx)("span",{children:e.label}),(0,a.jsx)("input",{type:"checkbox",checked:t?.visible||!1,onChange:t=>ec(r=>({...r,[e.id]:{...r[e.id]||{opacity:.6,visible:!1},visible:t.target.checked}})),className:"h-4 w-4 accent-cyan-500",disabled:r})]}),(0,a.jsxs)("label",{className:"space-y-1 text-[10px] text-zinc-500",children:[(0,a.jsx)("span",{children:"透明度"}),(0,a.jsx)("input",{type:"range",min:0,max:1,step:.05,value:t?.opacity??.6,onChange:t=>ec(r=>({...r,[e.id]:{...r[e.id]||{visible:!1,opacity:.6},opacity:parseFloat(t.target.value)}})),className:"w-full",disabled:r})]}),r&&(0,a.jsx)("div",{className:"text-[10px] text-zinc-600",children:"未設定圖資 URL"})]},e.id)})}),(0,a.jsxs)("div",{className:"pt-2 border-t border-white/10 space-y-2.5",children:[(0,a.jsx)("div",{className:"text-[11px] text-white font-semibold",children:"生活機能圖層"}),tE.map(e=>{let t=W[e.id];return(0,a.jsxs)("div",{children:[(0,a.jsxs)("label",{className:"flex items-center justify-between gap-3 text-[11px] text-zinc-300",children:[(0,a.jsx)("span",{children:e.label}),(0,a.jsx)("input",{type:"checkbox",checked:t?.visible||!1,onChange:t=>Y(r=>({...r,[e.id]:{...r[e.id],visible:t.target.checked}})),className:"h-4 w-4 accent-cyan-500"})]}),(0,a.jsxs)("label",{className:"space-y-1 text-[10px] text-zinc-500",children:[(0,a.jsx)("span",{children:"透明度"}),(0,a.jsx)("input",{type:"range",min:0,max:1,step:.05,value:t?.opacity??.6,onChange:t=>Y(r=>({...r,[e.id]:{...r[e.id],opacity:parseFloat(t.target.value)}})),className:"w-full",disabled:!t?.visible})]})]},e.id)}),(0,a.jsxs)("div",{children:[(0,a.jsxs)("label",{className:"flex items-center justify-between gap-3 text-[11px] text-zinc-300",children:[(0,a.jsx)("span",{children:"機能圈（300/600/1000m）"}),(0,a.jsx)("input",{type:"checkbox",checked:W.amenity.visible,onChange:e=>Y(t=>({...t,amenity:{...t.amenity,visible:e.target.checked}})),className:"h-4 w-4 accent-cyan-500"})]}),(0,a.jsxs)("div",{className:"mt-2 flex items-center gap-2",children:[(0,a.jsx)("button",{onClick:tX,className:"rounded-lg border border-white/10 px-2 py-0.5 text-[10px] text-zinc-300 hover:border-white/30",children:"以地圖中心"}),el&&(0,a.jsx)("span",{className:"text-[10px] text-zinc-500",children:"已套用搜尋點"})]}),(0,a.jsxs)("label",{className:"mt-2 space-y-1 text-[10px] text-zinc-500 block",children:[(0,a.jsx)("span",{children:"圈層透明度"}),(0,a.jsx)("input",{type:"range",min:0,max:1,step:.05,value:W.amenity.opacity,onChange:e=>Y(t=>({...t,amenity:{...t.amenity,opacity:parseFloat(e.target.value)}})),className:"w-full",disabled:!W.amenity.visible})]})]})]}),(0,a.jsxs)("div",{className:"pt-2 border-t border-white/10 space-y-2",children:[(0,a.jsx)("div",{className:"text-[11px] text-white font-semibold",children:"OpenStreetMap"}),(0,a.jsxs)("label",{className:"flex items-center justify-between gap-3 text-[11px] text-zinc-300",children:[(0,a.jsx)("span",{children:"OSM 底圖疊加"}),(0,a.jsx)("input",{type:"checkbox",checked:q.visible,onChange:e=>K(t=>({...t,visible:e.target.checked})),className:"h-4 w-4 accent-cyan-500"})]}),(0,a.jsxs)("label",{className:"space-y-1 text-[10px] text-zinc-500",children:[(0,a.jsx)("span",{children:"疊加透明度"}),(0,a.jsx)("input",{type:"range",min:0,max:1,step:.05,value:q.opacity,onChange:e=>K(t=>({...t,opacity:parseFloat(e.target.value)})),className:"w-full",disabled:!q.visible})]}),(0,a.jsxs)("label",{className:"flex items-center justify-between gap-3 text-[11px] text-zinc-300",children:[(0,a.jsx)("span",{children:"建物樓層（OSM）"}),(0,a.jsx)("input",{type:"checkbox",checked:U,onChange:e=>G(e.target.checked),className:"h-4 w-4 accent-cyan-500"})]}),(0,a.jsx)("div",{className:"text-[10px] text-zinc-500",children:"放大到 16+ 才會載入"}),U&&"loading"===J&&(0,a.jsx)("div",{className:"text-[10px] text-cyan-300",children:"載入建物樓層中..."}),U&&"zoom"===J&&(0,a.jsx)("div",{className:"text-[10px] text-zinc-500",children:"請再放大一些"}),U&&"error"===J&&(0,a.jsx)("div",{className:"text-[10px] text-rose-300",children:"OSM 讀取失敗，稍後再試"})]}),(0,a.jsxs)("div",{className:"pt-2 border-t border-white/10 space-y-2",children:[(0,a.jsxs)("div",{className:"text-[11px] text-white font-semibold flex items-center gap-2",children:[(0,a.jsx)(n.A,{className:"h-3.5 w-3.5 text-cyan-400"}),"底圖風格"]}),(0,a.jsx)("div",{className:"grid grid-cols-5 gap-2",children:tL.map(e=>{let t=tT[e.id]||n.A,r=F===e.id;return(0,a.jsx)("button",{onClick:()=>M(e.id),title:e.label,"aria-label":e.label,className:`h-8 w-8 flex items-center justify-center rounded-lg border transition-all ${r?"bg-cyan-500/20 border-cyan-500 text-cyan-200":"bg-zinc-800/60 border-white/10 text-zinc-400 hover:border-white/30"}`,children:(0,a.jsx)(t,{className:"h-4 w-4"})},e.id)})}),(0,a.jsx)("div",{className:"text-[10px] text-zinc-500",children:"3D 建物已啟用（縮放 15+）"})]}),(0,a.jsxs)("div",{className:"pt-2 border-t border-white/10 space-y-2",children:[(0,a.jsxs)("div",{className:"text-[11px] text-white font-semibold flex items-center gap-2",children:[(0,a.jsx)(u,{className:"h-3.5 w-3.5 text-cyan-400"}),"配色"]}),(0,a.jsx)("div",{className:"grid grid-cols-3 gap-2",children:["default","dark","cyberpunk","graphite","neon"].map(e=>(0,a.jsx)("button",{onClick:()=>{D||I(e)},disabled:D,className:`rounded-lg px-2 py-1 text-[10px] border transition-colors ${$===e?"border-cyan-500 text-cyan-200 bg-cyan-500/10":"border-white/10 text-zinc-400 hover:border-white/30"} ${D?"opacity-50 cursor-not-allowed":""}`,children:"default"===e?"預設":"dark"===e?"深色":"cyberpunk"===e?"賽博":"graphite"===e?"石墨":"霓虹"},e))}),(0,a.jsx)("div",{className:"text-[10px] text-zinc-500",children:D?"已跟隨網站主題（可到外觀設定關閉）":"深色系會重新套色"})]})]}),(0,a.jsx)("div",{className:"absolute top-1/2 right-4 -translate-y-1/2 z-30 w-48",children:(0,a.jsxs)("div",{className:"bg-zinc-900/85 backdrop-blur-md rounded-xl border border-white/10 shadow-lg p-2.5 space-y-2",children:[(0,a.jsxs)("div",{className:"flex items-center justify-between",children:[(0,a.jsxs)("div",{className:"flex items-center gap-2 text-[12px] text-zinc-200",children:[(0,a.jsx)(f.A,{className:"h-4 w-4 text-orange-400"}),(0,a.jsx)("span",{children:"3D 建物模型"})]}),(0,a.jsxs)("label",{className:"relative inline-flex items-center cursor-pointer",children:[(0,a.jsx)("input",{type:"checkbox",checked:R,onChange:e=>O(e.target.checked),className:"sr-only peer"}),(0,a.jsx)("div",{className:"w-9 h-5 bg-zinc-700 peer-focus:outline-none rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-4 after:w-4 after:transition-all peer-checked:bg-cyan-600"})]})]}),(0,a.jsx)("div",{className:"text-[10px] text-zinc-500",children:"縮放到 15+ 才會顯示完整模型"})]})}),!L&&(0,a.jsx)("div",{className:"absolute inset-0 flex items-center justify-center bg-zinc-950/70 z-20",children:(0,a.jsx)("div",{className:"text-sm text-zinc-400",children:"正在載入地圖引擎..."})}),(0,a.jsx)("div",{ref:s,className:"w-full h-full"})]})}},94514:(e,t,r)=>{"use strict";r.d(t,{A:()=>a});let a=(0,r(78340).A)("check",[["path",{d:"M20 6 9 17l-5-5",key:"1gmf2c"}]])}}]);