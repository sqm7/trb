"use strict";(self.webpackChunk_N_E=self.webpackChunk_N_E||[]).push([[4489],{27529:(e,t,r)=>{r.d(t,{FH:()=>c});var a=r(16385),i=r(55873);async function n(){let{data:{session:e}}=await a.N.auth.getSession();return{"Content-Type":"application/json",apikey:i.m5,Authorization:`Bearer ${e?.access_token||i.m5}`}}async function o(e){let t=await n(),r=await fetch(i.Sn.RANKING_ANALYSIS,{method:"POST",headers:t,body:JSON.stringify({filters:e})});if(!r.ok)throw Error((await r.json().catch(()=>({error:`Analysis request failed: ${r.status}`}))).error||"Analyze data failed");return r.json()}let c={checkAuth:async function(){let{data:{session:e}}=await a.N.auth.getSession();e||console.log("User not logged in, but allowing access.")},getUser:async function(){let{data:{user:e}}=await a.N.auth.getUser();return e},signOut:async function(){let{error:e}=await a.N.auth.signOut();if(e)throw console.error("Sign out failed:",e),e},fetchData:async function(e,t){let r=await n(),a=await fetch(i.Sn.QUERY_DATA,{method:"POST",headers:r,body:JSON.stringify({filters:e,pagination:t})});if(!a.ok)throw Error((await a.json().catch(()=>({error:"Failed to parse server response"}))).error||"Fetch data failed");return a.json()},analyzeData:o,analyzeProjectRanking:o,fetchSubData:async function(e,t,r){if(!e||!t||!r)throw Error(`Insufficient parameters: ${e}, ${t}, ${r}`);let a=await n(),o=await fetch(i.Sn.SUB_DATA,{method:"POST",headers:a,body:JSON.stringify({id:e,type:t,county:r})});if(!o.ok)throw Error((await o.json().catch(()=>({error:"Failed to fetch sub data"}))).error||"Fetch sub data failed");return o.json()},fetchProjectNameSuggestions:async function(e,t,r=[]){let a=await n(),o=t.replace(/\u3127/g,"一"),c=await fetch(i.Sn.PROJECT_NAMES,{method:"POST",headers:a,body:JSON.stringify({countyCode:e,query:o,districts:r,detailed:!0})});if(!c.ok)throw Error(`Server error: ${c.status}`);return c.json()},generateShareLink:async function(e){let t=await n(),r=await fetch(i.Sn.GENERATE_SHARE_LINK,{method:"POST",headers:t,body:JSON.stringify(e)});if(!r.ok)throw Error((await r.json().catch(()=>({error:"Generate share link failed"}))).error);return r.json()},getAdminUsers:async function(){let e=await n(),t=await fetch(i.Sn.GET_USERS,{method:"POST",headers:e,body:JSON.stringify({})});if(!t.ok)throw Error((await t.json().catch(()=>({error:"Failed to fetch users"}))).error||"Fetch users failed");return t.json()}}},41780:(e,t,r)=>{r.d(t,{g:()=>m});var a=r(12115),i=r(27529),n=r(88743),o=r(55873),c=r(98883);function s(e,t){let r=(e.length-1)*t,a=Math.floor(r);return void 0!==e[a+1]?parseFloat((e[a]+(r-a)*(e[a+1]-e[a])).toFixed(2)):parseFloat(e[a].toFixed(2))}var l=r(38346);let u={user:-1,business:6,pro:-1,pro_max:-1,admin:-1,super_admin:-1};function m(){let e=(0,n.P)(),[t,r]=(0,a.useState)(!1),[m,f]=(0,a.useState)(null),{checkQuota:y,incrementQuota:d,limit:h,isUnlimited:P}=function(){let{role:e}=(0,l.h)(),[t,r]=(0,a.useState)(null),[i,n]=(0,a.useState)(!1),o=()=>{let e=new Date().toISOString().split("T")[0];return`vibe_daily_quota_${e}`};return(0,a.useEffect)(()=>{let t=u[e||"user"]??3;if(-1===t){n(!0),r(999);return}n(!1);let a=o();r(Math.max(0,t-parseInt(localStorage.getItem(a)||"0",10)))},[e]),{remaining:t,isUnlimited:i,checkQuota:()=>{let t=u[e||"user"]??3;if(-1===t)return!0;let r=o();return parseInt(localStorage.getItem(r)||"0",10)<t},incrementQuota:()=>{let t=u[e||"user"]??3;if(-1===t)return;let a=o(),i=parseInt(localStorage.getItem(a)||"0",10);localStorage.setItem(a,(i+1).toString()),r(Math.max(0,t-(i+1)))},limit:e&&u[e]?u[e]:-1}}(),p=(0,a.useCallback)(async()=>{if(r(!0),f(null),e.setAnalysisData(null),!y()){let e=P?"":` (每日上限 ${h} 次)`;f(`您已達到今日分析次數上限${e}。請升級方案以解鎖更多次數。`),r(!1);return}try{let l=e.counties.map(e=>o.WG[e]||e);if(0===l.length){f("請至少選擇一個縣市"),r(!1);return}let{dateRange:u,startDate:m,endDate:y}=e;if("custom"!==u&&(!m||!y)){let e=(0,c.P)(u);e.startDate&&e.endDate&&(m=e.startDate,y=e.endDate)}let h={districts:e.districts,transactionType:e.transactionType,type:e.transactionType,projectNames:e.projectNames,buildingType:e.buildingType,excludeCommercial:e.excludeCommercial,floorPremium:e.floorPremium,dateRange:u,dateStart:m,dateEnd:y};console.log("[useAnalysisData] Analyzing with counties:",l);let P=l.map(e=>{let t={...h,countyCode:e,counties:[e]};return i.FH.analyzeProjectRanking(t).catch(t=>(console.error(`Failed to fetch data for ${e}:`,t),null))}),p=await Promise.all(P),g=null,S=0;for(let e of p)if(e&&e.projectRanking&&e.coreMetrics){var t,a,n;console.log("Merging result for county:",e.projectRanking?.[0]?.county),t=g,g=e?t?(e.transactionDetails&&Array.isArray(e.transactionDetails)&&(t.transactionDetails||(t.transactionDetails=[]),t.transactionDetails=[...t.transactionDetails,...e.transactionDetails]),t.coreMetrics=function(e,t){if(!t)return e;if(!e)return t;let r=(e.totalSaleAmount||0)+(t.totalSaleAmount||0),a=(e.totalHouseArea||0)+(t.totalHouseArea||0),i=(e.transactionCount||0)+(t.transactionCount||0);return{totalSaleAmount:r,totalHouseArea:a,overallAveragePrice:a>0?r/a:0,transactionCount:i,medianPrice:0,q1Price:0,q3Price:0,minPrice:Math.min(e.minPrice||1/0,t.minPrice||1/0),maxPrice:Math.max(e.maxPrice||0,t.maxPrice||0)}}(t.coreMetrics,e.coreMetrics),e.projectRanking&&Array.isArray(e.projectRanking)&&(t.projectRanking=[...t.projectRanking,...e.projectRanking]),t.priceBandAnalysis=function(e,t){if(!t)return e;let r=Array.isArray(e)?e:e?.details||[],a=Array.isArray(t)?t:t?.details||[],i=e?.locationCrossTable||{},n=t?.locationCrossTable||{},o=e?.allDistricts||[],c=t?.allDistricts||[],s=e?.allRoomTypes||[],l=t?.allRoomTypes||[],u=new Map,m=e=>{let t=null!==e.bathrooms&&void 0!==e.bathrooms?String(e.bathrooms):"null",r=(e.roomType||"").replace(/\s+/g,""),a=`${r}-${t}`,i=Number(e.count)||0,n=Number(e.avgPrice)||0,o=Number(e.minPrice)||0,c=Number(e.maxPrice)||0;if(u.has(a)){let t=u.get(a),r=Number(t.count)||0,s=Number(t.avgPrice)||0,l=n*i,m=r+i,f=m>0?(s*r+l)/m:0;if(t.count=m,t.avgPrice=parseFloat(f.toFixed(2)),t.minPrice=Math.min(t.minPrice,o),t.maxPrice=Math.max(t.maxPrice,c),e.projectNames){let r=new Set([...t.projectNames,...e.projectNames]);t.projectNames=Array.from(r)}e.byDistrict&&Object.entries(e.byDistrict).forEach(([e,r])=>{t.byDistrict[e]=(t.byDistrict[e]||0)+r})}else u.set(a,{...e,roomType:r,count:i,avgPrice:n,minPrice:o,maxPrice:c,projectNames:e.projectNames?[...e.projectNames]:[],byDistrict:e.byDistrict?{...e.byDistrict}:{}})};r.forEach(m),a.forEach(m);let f={...i};Object.entries(n).forEach(([e,t])=>{f[e]?Object.entries(t).forEach(([t,r])=>{f[e][t]=(f[e][t]||0)+r}):f[e]={...t}});let y=Array.from(new Set([...o,...c])).sort(),d=Array.from(new Set([...s,...l])).sort();return{details:Array.from(u.values()),locationCrossTable:f,allDistricts:y,allRoomTypes:d}}(t.priceBandAnalysis,e.priceBandAnalysis),t.unitPriceAnalysis=function(e,t){if(!t)return e;let r=(e,t)=>{if(!t)return e;if(!e)return t;let r=(e.count||0)+(t.count||0);if(0===r)return e;let a={arithmetic:0,weighted:0},i=(e,t)=>"number"==typeof e.avgPrice?e.weightedAvgPrice||e.avgPrice:e.avgPrice?.[t]||0;["arithmetic","weighted"].forEach(n=>{let o=i(e,n),c=i(t,n);a[n]=(o*(e.count||0)+c*(t.count||0))/r});let n=Math.min(e.minPrice,t.minPrice),o=Math.max(e.maxPrice,t.maxPrice),c=e.minPrice<t.minPrice?e.minPriceProject:t.minPriceProject;return{count:r,avgPrice:a,minPrice:n,maxPrice:o,minPriceProject:c,maxPriceProject:e.maxPrice>t.maxPrice?e.maxPriceProject:t.maxPriceProject,medianPrice:0,q1Price:0,q3Price:0}},a=r(e.residentialStats,t.residentialStats),i=r(e.officeStats,t.officeStats),n=r(e.storeStats,t.storeStats),o=[...e.typeComparison||[]];return t.typeComparison&&(o=[...o,...t.typeComparison]),{residentialStats:a,officeStats:i,storeStats:n,typeComparison:o}}(t.unitPriceAnalysis,e.unitPriceAnalysis),t.transactionDetails&&t.transactionDetails.length>0&&function(e,t){if(!e||!t||0===t.length)return;let r=[],a={price:0,area:0,count:0},i=[],n={price:0,area:0,count:0},o=[],c={price:0,area:0,count:0},l=()=>({minPrice:1/0,maxPrice:-1/0,minRecord:null,maxRecord:null}),u=l(),m=l(),f=l();t.forEach(e=>{let t=e["建物型態"],s=e["主要用途"],l=e["房屋單價(萬)"],y=e["房屋總價(萬)"]||0,d=e["建物移轉總面積"]||0;if("number"!=typeof l||l<=0)return;let h=r,P=a,p=u;t?.includes("店")||"商業用"===s||e["備註"]?.includes("店")?(h=o,P=c,p=f):(t?.includes("辦公")||t?.includes("廠辦")||t?.includes("事務所")||s?.includes("辦公"))&&(h=i,P=n,p=m),h.push(l),P.price+=y,P.area+=d,P.count+=1,l>p.maxPrice&&(p.maxPrice=l,p.maxRecord=e),l<p.minPrice&&(p.minPrice=l,p.minRecord=e)});let y=(e,t,r,a)=>{e&&(function(e,t){if(!t||0===t.length){e.medianPrice=0,e.q1Price=0,e.q3Price=0;return}t.sort((e,t)=>e-t),e.medianPrice=s(t,.5),e.q1Price=s(t,.25),e.q3Price=s(t,.75)}(e,t),e.count=r.count,e.avgPrice=r.count>0?t.reduce((e,t)=>e+t,0)/r.count:0,e.weightedAvgPrice=r.area>0?r.price/r.area:0,a.maxRecord&&(e.maxPrice=a.maxPrice,e.maxPriceProject=a.maxRecord["建案名稱"],e.maxPriceUnit=a.maxRecord["戶型"]||a.maxRecord["戶別"],e.maxPriceFloor=a.maxRecord["樓層"]),a.minRecord&&(e.minPrice=a.minPrice,e.minPriceProject=a.minRecord["建案名稱"],e.minPriceUnit=a.minRecord["戶型"]||a.minRecord["戶別"],e.minPriceFloor=a.minRecord["樓層"]))};e.residentialStats&&y(e.residentialStats,r,a,u),e.officeStats&&y(e.officeStats,i,n,m),e.storeStats&&y(e.storeStats,o,c,f);let d=new Map;t.forEach(e=>{let t=e["建案名稱"];if(!t)return;d.has(t)||d.set(t,{resSum:{price:0,area:0,count:0},shopSum:{price:0,area:0,count:0},officeSum:{price:0,area:0,count:0},county:e["縣市"],district:e["行政區"]});let r=d.get(t),a=e["建物型態"],i=e["主要用途"],n=e["房屋單價(萬)"],o=e["房屋總價(萬)"]||0,c=e["建物移轉總面積"]||0;"number"!=typeof n||n<=0||(a?.includes("店")||"商業用"===i||e["備註"]?.includes("店")?(r.shopSum.price+=o,r.shopSum.area+=c,r.shopSum.count+=1):a?.includes("辦公")||a?.includes("廠辦")||a?.includes("事務所")||i?.includes("辦公")?(r.officeSum.price+=o,r.officeSum.area+=c,r.officeSum.count+=1):(r.resSum.price+=o,r.resSum.area+=c,r.resSum.count+=1))});let h=[];d.forEach((e,t)=>{let r=e.resSum.area>0?e.resSum.price/e.resSum.area:0,a=e.shopSum.area>0?e.shopSum.price/e.shopSum.area:0,i=e.officeSum.area>0?e.officeSum.price/e.officeSum.area:0;r>0&&(a>0||i>0)&&h.push({projectName:t,county:e.county,district:e.district,residentialAvg:r,shopAvg:a,officeAvg:i,shopMultiple:r>0?a/r:0,officeMultiple:r>0?i/r:0})}),h.sort((e,t)=>e.projectName.localeCompare(t.projectName))}(t.unitPriceAnalysis,t.transactionDetails),t.parkingAnalysis=function(e,t){if(!t)return e;let r=e.parkingRatio,a=t.parkingRatio,i=null;if(r&&a){let e=r.withParking.count,t=r.withoutParking.count,n=a.withParking.count,o=a.withoutParking.count,c=e+n,s=t+o,l=c+s;i={withParking:{count:c,percentage:l>0?c/l*100:0},withoutParking:{count:s,percentage:l>0?s/l*100:0}}}else i=r||a;let n=new Map,o=e=>{if(n.has(e.type)){let t=n.get(e.type),r=t.count+e.count,a=t.transactionCount+e.transactionCount,i=t.avgPrice,o=e.avgPrice,c=a>0?(i*t.transactionCount+o*e.transactionCount)/a:0;t.count=r,t.transactionCount=a,t.avgPrice=c}else n.set(e.type,{...e})};(e.avgPriceByType||[]).forEach(o),(t.avgPriceByType||[]).forEach(o);let c=Array.from(n.values()),s=new Map,l=e=>{if(s.has(e.floor)){let t=s.get(e.floor),r=t.count+e.count;e.rawRecords&&(t.rawRecords=[...t.rawRecords||[],...e.rawRecords]);let a=r>0?(t.avgPrice*t.count+e.avgPrice*e.count)/r:0;t.count=r,t.avgPrice=a,t.minPrice=Math.min(t.minPrice,e.minPrice),t.maxPrice=Math.max(t.maxPrice,e.maxPrice),e.maxPrice>t.maxPrice&&(t.maxPriceProject=e.maxPriceProject,t.maxPriceUnit=e.maxPriceUnit,t.maxPriceFloor=e.maxPriceFloor),e.minPrice<t.minPrice&&(t.minPriceProject=e.minPriceProject,t.minPriceUnit=e.minPriceUnit,t.minPriceFloor=e.minPriceFloor)}else s.set(e.floor,{...e,rawRecords:e.rawRecords?[...e.rawRecords]:[]})};return(e.rampPlanePriceByFloor||[]).forEach(l),(t.rampPlanePriceByFloor||[]).forEach(l),{parkingRatio:i,avgPriceByType:c,rampPlanePriceByFloor:Array.from(s.values())}}(t.parkingAnalysis,e.parkingAnalysis),t.salesVelocityAnalysis=function(e,t){if(!t)return e;let r=e.overall||{},a=t.overall||{},i=r.transactionCount||0,n=a.transactionCount||0,o=i+n,c={avgDaysToSell:0,medianDaysToSell:0,fastestSale:0,transactionCount:o};if(o>0){c.avgDaysToSell=((r.avgDaysToSell||0)*i+(a.avgDaysToSell||0)*n)/o;let e=void 0!==r.fastestSale?r.fastestSale:1/0;c.fastestSale=Math.min(e,void 0!==a.fastestSale?a.fastestSale:1/0),c.fastestSale===1/0&&(c.fastestSale=0),c.medianDaysToSell=((r.medianDaysToSell||0)*i+(a.medianDaysToSell||0)*n)/o}let s=new Map,l=e=>{if(!e)return;let t=e.roomType;if(s.has(t)){let r=s.get(t),a=r.count+e.count,i=r.avgDays||0,n=e.avgDays||0;r.avgDays=a>0?(i*r.count+n*e.count)/a:0,r.count=a}else s.set(t,{...e})};(e.byRoomType||[]).forEach(l),(t.byRoomType||[]).forEach(l);let u=Array.from(s.values()),m=Array.from(new Set([...e.allRoomTypes||[],...t.allRoomTypes||[]])),f={};return["monthly","quarterly","yearly","weekly"].forEach(r=>{let a=e[r]||{},i=t[r]||{},n={};new Set([...Object.keys(a),...Object.keys(i)]).forEach(e=>{let t=a[e]||{},r=i[e]||{},o=new Set([...Object.keys(t),...Object.keys(r)]),c={};o.forEach(e=>{let a=t[e],i=r[e];if(a&&i){let t=a.count+i.count,r=a.priceSum+i.priceSum,n=a.areaSum+i.areaSum;c[e]={count:t,priceSum:r,areaSum:n,avgPrice:n>0?r/n:0}}else a?c[e]={...a}:i&&(c[e]={...i})}),n[e]=c}),f[r]=n}),{overall:c,byRoomType:u,allRoomTypes:m,...f}}(t.salesVelocityAnalysis,e.salesVelocityAnalysis),a=t.priceGridAnalysis,t.priceGridAnalysis=(n=e.priceGridAnalysis)?{projectNames:[...a.projectNames||[],...n.projectNames||[]],byProject:{...a.byProject||{},...n.byProject||{}}}:a,t.areaDistributionAnalysis=function(e,t){if(!t)return e;if(!e)return t;let r={...e};return Object.keys(t).forEach(e=>{r[e]?r[e]=[...r[e],...t[e]]:r[e]=[...t[e]]}),r}(t.areaDistributionAnalysis,e.areaDistributionAnalysis),t):JSON.parse(JSON.stringify(e)):t,S++}if(console.log("Aggregation complete. Total Transaction Details:",g?.transactionDetails?.length),0===S){if(e.projectNames.length>0)throw Error("這段時間 這個建案查詢不到資料");throw Error("無法取得任何縣市的分析數據")}if(S<l.length){let e=l.length-S;f(`注意：有 ${e} 個縣市的資料載入失敗，分析結果可能不完整。`)}e.setAnalysisData(g),d()}catch(e){console.error("Analysis failed:",e),f(e.message||"無法取得分析數據，請稍後再試。")}finally{r(!1)}},[e,y,d,h,P]);return{loading:t,error:m,analysisData:e.analysisData,handleAnalyze:p,setError:f,setLoading:r,setAnalysisData:e.setAnalysisData}}},58822:(e,t,r)=>{r.d(t,{e:()=>o});var a=r(95155);r(12115);var i=r(9425),n=r(68500);function o({children:e}){return(0,a.jsxs)("div",{className:"min-h-screen bg-zinc-950 text-zinc-100 flex",children:[(0,a.jsx)(i.Sidebar,{}),(0,a.jsxs)("div",{className:"flex-1 flex flex-col lg:pl-20 min-w-0 transition-all duration-300",children:[(0,a.jsx)(n.Header,{}),(0,a.jsxs)("main",{className:"flex-1 p-4 md:p-6 lg:p-8",children:[(0,a.jsx)("div",{className:"container-custom py-6 space-y-8 animate-in fade-in slide-in-from-bottom-4 duration-500 min-h-[calc(100vh-12rem)]",children:e}),(0,a.jsxs)("footer",{className:"py-8 text-center border-t border-white/5 mt-8",children:[(0,a.jsx)("p",{className:"text-zinc-600 text-sm font-medium",children:"\xa9 2026 平米內參 sqmtalk.com. All rights reserved."}),(0,a.jsx)("a",{href:"mailto:sqmtalk7@gmail.com",className:"block mt-2 text-zinc-700 hover:text-cyan-500 text-xs transition-colors",children:"Contact: sqmtalk7@gmail.com"})]})]})]})]})}},98883:(e,t,r)=>{r.d(t,{P:()=>a});let a=e=>{let t=new Date,r=new Date;switch(e){case"1q":r.setMonth(t.getMonth()-3);break;case"2q":r.setMonth(t.getMonth()-6);break;case"3q":r.setMonth(t.getMonth()-9);break;case"1y":r.setFullYear(t.getFullYear()-1);break;case"this_year":r=new Date(t.getFullYear(),0,1);break;case"last_2_years":r=new Date(t.getFullYear()-1,0,1);break;case"last_3_years":r=new Date(t.getFullYear()-2,0,1);break;default:return{startDate:"",endDate:""}}return{startDate:r.toISOString().split("T")[0],endDate:t.toISOString().split("T")[0]}}}}]);