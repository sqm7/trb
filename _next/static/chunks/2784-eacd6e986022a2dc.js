"use strict";(self.webpackChunk_N_E=self.webpackChunk_N_E||[]).push([[2784],{85993:(e,t,r)=>{r.d(t,{T:()=>n});var i=r(1934),s=r(16385);let a={map_mode:{key:"map_mode",is_active:!0,default_min_role:"user",overrides:{}},floor_plan:{key:"floor_plan",is_active:!0,default_min_role:"user",overrides:{}},report_builder:{key:"report_builder",is_active:!0,default_min_role:"pro",overrides:{}},export_report:{key:"export_report",is_active:!0,default_min_role:"pro",overrides:{}},market_heatmap:{key:"market_heatmap",is_active:!0,default_min_role:"pro",overrides:{user:{access:"time_limited",start_time:new Date().toISOString(),end_time:new Date(Date.now()+2592e6).toISOString(),is_manual_override:!0}}},price_analysis:{key:"price_analysis",is_active:!0,default_min_role:"pro",overrides:{user:{access:"time_limited",start_time:new Date().toISOString(),end_time:new Date(Date.now()+2592e6).toISOString(),is_manual_override:!0}}},total_price_analysis:{key:"total_price_analysis",is_active:!0,default_min_role:"pro",overrides:{user:{access:"time_limited",start_time:new Date().toISOString(),end_time:new Date(Date.now()+2592e6).toISOString(),is_manual_override:!0}}},policy_timeline:{key:"policy_timeline",is_active:!0,default_min_role:"pro",overrides:{user:{access:"time_limited",start_time:new Date().toISOString(),end_time:new Date(Date.now()+2592e6).toISOString(),is_manual_override:!0}}},sales_velocity:{key:"sales_velocity",is_active:!0,default_min_role:"pro",overrides:{user:{access:"time_limited",start_time:new Date().toISOString(),end_time:new Date(Date.now()+2592e6).toISOString(),is_manual_override:!0}}},parking_analysis:{key:"parking_analysis",is_active:!0,default_min_role:"pro",overrides:{user:{access:"time_limited",start_time:new Date().toISOString(),end_time:new Date(Date.now()+2592e6).toISOString(),is_manual_override:!0}}},transaction_list:{key:"transaction_list",is_active:!0,default_min_role:"pro",overrides:{user:{access:"time_limited",start_time:new Date().toISOString(),end_time:new Date(Date.now()+2592e6).toISOString(),is_manual_override:!0}}},share_report:{key:"share_report",is_active:!0,default_min_role:"pro",overrides:{user:{access:"time_limited",start_time:new Date().toISOString(),end_time:new Date(Date.now()+2592e6).toISOString(),is_manual_override:!0}}},system_settings:{key:"system_settings",is_active:!0,default_min_role:"user",overrides:{}},system_announcement:{key:"system_announcement",is_active:!0,default_min_role:"user",overrides:{}},admin_panel:{key:"admin_panel",is_active:!0,default_min_role:"admin",overrides:{}}},n=(0,i.v)((e,t)=>({flags:a,isLoading:!0,error:null,fetchFlags:async()=>{e({isLoading:!0,error:null});try{let{data:t,error:r}=await s.N.from("feature_flags").select("*");if(r){console.warn("Failed to fetch feature flags (using defaults):",r.message),e({isLoading:!1});return}if(t&&t.length>0){let r={...a};t.forEach(e=>{r[e.key]&&(r[e.key]={...r[e.key],...e,overrides:e.overrides||{}})}),e({flags:r,isLoading:!1})}else e({isLoading:!1})}catch(t){console.error("Feature flag fetch error:",t),e({isLoading:!1,error:t.message})}},updateFlag:async(r,i)=>{let a=t().flags,n=a[r],l={...n,...i};e({flags:{...a,[r]:l}});try{let{error:e}=await s.N.from("feature_flags").upsert({key:r,is_active:l.is_active,default_min_role:l.default_min_role,overrides:l.overrides,updated_at:new Date().toISOString()});if(e)throw e}catch(t){throw console.error("Failed to update feature flag:",t),e({flags:{...a,[r]:n}}),t}},checkAccess:(e,r)=>{let i=t().flags[e];if(!i||!i.is_active)return{allowed:!1,reason:"default"};let s=r||"user",a=i.overrides[s];if(a){if("granted"===a.access)return{allowed:!0,reason:"override"};if("denied"===a.access)return{allowed:!1,reason:"override"};if("time_limited"===a.access){let e=new Date().getTime(),t=a.start_time?new Date(a.start_time).getTime():0,r=a.end_time?new Date(a.end_time).getTime():1/0;return e>=t&&e<=r?{allowed:!0,reason:"beta",remainingTime:r-e}:{allowed:!1,reason:"override"}}}let n=["user","pro","pro_max","admin","super_admin"];return n.indexOf(s)>=n.indexOf(i.default_min_role||"user")?{allowed:!0,reason:"default"}:{allowed:!1,reason:"default"}}}))},86120:(e,t,r)=>{r.d(t,{b:()=>u,i:()=>_});var i=r(95155),s=r(12115),a=r(73321),n=r(16385),l=r(39430),o=r(62032),c=r(66614),d=r(80723);function m(){let e=(0,a.useRouter)();return(0,i.jsxs)("div",{className:"min-h-screen bg-black flex items-center justify-center p-4 relative overflow-hidden",children:[(0,i.jsx)("div",{className:"absolute top-0 left-1/4 w-96 h-96 bg-red-600/10 rounded-full blur-[128px] pointer-events-none"}),(0,i.jsx)("div",{className:"absolute bottom-0 right-1/4 w-96 h-96 bg-amber-600/10 rounded-full blur-[128px] pointer-events-none"}),(0,i.jsx)("div",{className:"relative z-10 max-w-md w-full",children:(0,i.jsxs)(l.P.div,{initial:{opacity:0,scale:.95},animate:{opacity:1,scale:1},transition:{duration:.5},className:"bg-zinc-900/50 backdrop-blur-xl border border-red-500/20 rounded-3xl p-8 shadow-2xl overflow-hidden",children:[(0,i.jsxs)(l.P.div,{className:"w-20 h-20 bg-red-500/10 rounded-full flex items-center justify-center mx-auto mb-6 border border-red-500/20 relative",initial:{rotate:-180,opacity:0},animate:{rotate:0,opacity:1},transition:{delay:.2,type:"spring"},children:[(0,i.jsx)(o.A,{className:"w-10 h-10 text-red-500"}),(0,i.jsx)(l.P.div,{className:"absolute inset-0 bg-red-500/20 rounded-full",animate:{scale:[1,1.2,1]},transition:{duration:2,repeat:1/0}})]}),(0,i.jsxs)("div",{className:"text-center space-y-3 mb-8",children:[(0,i.jsx)("h1",{className:"text-2xl font-bold text-white tracking-tight",children:"Access Denied"}),(0,i.jsxs)("p",{className:"text-zinc-400 text-sm leading-relaxed",children:["權限不足。此區域僅限系統管理員訪問。",(0,i.jsx)("br",{}),"若您認為這是錯誤，請聯繫技術支援。"]})]}),(0,i.jsxs)("div",{className:"space-y-3",children:[(0,i.jsxs)("button",{onClick:()=>e.push("/dashboard"),className:"w-full flex items-center justify-center gap-2 bg-white text-black hover:bg-zinc-200 font-bold py-3.5 px-4 rounded-xl transition-all active:scale-[0.98]",children:[(0,i.jsx)(c.A,{className:"w-4 h-4"}),"返回主控台 (Dashboard)"]}),(0,i.jsxs)("button",{onClick:()=>e.back(),className:"w-full flex items-center justify-center gap-2 bg-transparent hover:bg-white/5 text-zinc-400 hover:text-white font-medium py-3.5 px-4 rounded-xl border border-white/5 hover:border-white/10 transition-all active:scale-[0.98]",children:[(0,i.jsx)(d.A,{className:"w-4 h-4"}),"回上一頁"]})]}),(0,i.jsx)(l.P.div,{className:"mt-8 pt-6 border-t border-white/5 text-center",initial:{opacity:0},animate:{opacity:1},transition:{delay:.8},children:(0,i.jsx)("p",{className:"text-[10px] text-zinc-600 font-mono uppercase tracking-widest",children:"Error: 403_FORBIDDEN"})})]})})]})}function u(){let[e,t]=(0,s.useState)({user:null,isAdmin:!1,permissions:{canPostAnnouncement:!1,accessibleCounties:[],isSuperAdmin:!1},isLoading:!0,error:null});return(0,s.useEffect)(()=>{let e=async()=>{try{let{data:{session:e},error:r}=await n.N.auth.getSession();if(r)throw r;if(!e?.user)return void t({user:null,isAdmin:!1,permissions:{canPostAnnouncement:!1,accessibleCounties:[],isSuperAdmin:!1},isLoading:!1,error:null});let{data:i,error:s}=await n.N.from("profiles").select("role, accessible_counties, can_post_announcement").eq("id",e.user.id).single();if(s){console.warn("Profile fetch error:",s),t({user:e.user,isAdmin:!1,permissions:{canPostAnnouncement:!1,accessibleCounties:[],isSuperAdmin:!1},isLoading:!1,error:null});return}let a=i?.role==="super_admin",l=i?.role==="admin"||a,o=a?null:i?.accessible_counties,c=!!a||i?.can_post_announcement||!1;t({user:e.user,isAdmin:l,permissions:{canPostAnnouncement:c,accessibleCounties:o,isSuperAdmin:a},isLoading:!1,error:null})}catch(e){console.error("Admin auth check error:",e),t({user:null,isAdmin:!1,permissions:{canPostAnnouncement:!1,accessibleCounties:[],isSuperAdmin:!1},isLoading:!1,error:e.message})}};e();let{data:{subscription:r}}=n.N.auth.onAuthStateChange(()=>{e()});return()=>r.unsubscribe()},[]),e}function _(e){return function(t){let{user:r,isAdmin:n,isLoading:l,error:o}=u(),c=(0,a.useRouter)();return((0,s.useEffect)(()=>{l||n||c.replace("/")},[l,n,c]),l)?(0,i.jsx)("div",{className:"min-h-screen bg-zinc-950 flex items-center justify-center",children:(0,i.jsxs)("div",{className:"text-center space-y-4",children:[(0,i.jsx)("div",{className:"h-8 w-8 border-2 border-cyan-500/30 border-t-cyan-500 rounded-full animate-spin mx-auto"}),(0,i.jsx)("p",{className:"text-zinc-500 text-sm",children:"驗證管理員權限..."})]})}):r?n?(0,i.jsx)(e,{...t}):(0,i.jsx)(m,{}):(0,i.jsx)("div",{className:"min-h-screen bg-zinc-950 flex items-center justify-center",children:(0,i.jsxs)("div",{className:"text-center space-y-4 p-8",children:[(0,i.jsx)("div",{className:"text-4xl",children:"\uD83D\uDD12"}),(0,i.jsx)("h1",{className:"text-xl font-bold text-white",children:"請先登入"}),(0,i.jsx)("p",{className:"text-zinc-500",children:"此頁面需要登入才能訪問"}),(0,i.jsx)("button",{onClick:()=>c.push("/"),className:"bg-cyan-600 hover:bg-cyan-500 text-white px-6 py-2 rounded-lg transition-colors",children:"前往登入"})]})})}}}}]);