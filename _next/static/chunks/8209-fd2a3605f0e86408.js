"use strict";(self.webpackChunk_N_E=self.webpackChunk_N_E||[]).push([[8209],{37717:(e,t,a)=>{a.d(t,{A:()=>o});var r=a(12115);let n=(e,t)=>getComputedStyle(document.documentElement).getPropertyValue(e).trim()||t,i=e=>{let t=e.match(/rgba?\((\d+),\s*(\d+),\s*(\d+)/i);return t?[Number(t[1]),Number(t[2]),Number(t[3])]:null},s=e=>{let t=e.replace("#","").trim();if(![3,6].includes(t.length))return null;let a=parseInt(3===t.length?t.split("").map(e=>e+e).join(""):t,16);return Number.isNaN(a)?null:[a>>16&255,a>>8&255,255&a]},d=()=>{let e=[n("--color-chart-1","#8b5cf6"),n("--color-chart-2","#06b6d4"),n("--color-chart-3","#10b981"),n("--color-chart-4","#f43f5e"),n("--color-chart-5","#f59e0b")],t=n("--color-dark-bg","#09090b");return{bg:n("--color-dark-bg","#09090b"),card:n("--color-dark-card","#18181b"),surface:n("--color-dark-surface","#27272a"),primary:n("--color-primary","#8b5cf6"),primaryHover:n("--color-primary-hover","#7c3aed"),accent:n("--color-chart-2","#06b6d4"),accentAlt:n("--color-chart-4","#f43f5e"),text:n("--color-text-primary","#fafafa"),textMuted:n("--color-text-secondary","#a1a1aa"),border:n("--color-border","#27272a"),grid:n("--color-zinc-700","#3f3f46"),danger:n("--color-destructive","#ef4444"),warning:n("--color-amber-500","#f59e0b"),success:n("--color-emerald-500","#10b981"),chart:e,chartPalette:((e,t)=>{if(0===e.length)return[];let a=e.map(e=>((e,t,a=.35)=>{let r=s(e)??i(e),n=s(t)??i(t);if(!r||!n)return e;let d=(e,t)=>Math.round(e*(1-a)+t*a),o=d(r[0],n[0]),l=d(r[1],n[1]),c=d(r[2],n[2]);return`rgb(${o}, ${l}, ${c})`})(e,t,.4));return[...e,...a]})(e,t)}};function o(){let[e,t]=(0,r.useState)(()=>d());return(0,r.useEffect)(()=>{let e=()=>t(d());e();let a=new MutationObserver(e);a.observe(document.documentElement,{attributes:!0,attributeFilter:["data-theme"]});let r=t=>{"sqm_theme"===t.key&&e()};return window.addEventListener("storage",r),()=>{a.disconnect(),window.removeEventListener("storage",r)}},[]),(0,r.useMemo)(()=>e,[e])}},62400:(e,t,a)=>{a.d(t,{b:()=>n});var r=a(88743);function n(){let e=r.P.getState(),t=[];return e.counties.length>0&&(e.districts.length>0?t.push(`${e.counties.join(", ")} - ${e.districts.join(", ")}`):t.push(e.counties.join(", "))),e.startDate&&e.endDate?t.push(`${e.startDate} ~ ${e.endDate}`):e.dateRange&&"custom"!==e.dateRange&&t.push({"3m":"近3個月","6m":"近6個月","9m":"近9個月","12m":"近12個月","15m":"近15個月","18m":"近18個月","21m":"近21個月","24m":"近24個月","36m":"近36個月","48m":"近48個月",all:"全部時間"}[e.dateRange]||e.dateRange),e.transactionType&&t.push(e.transactionType),e.buildingType&&""!==e.buildingType&&t.push(e.buildingType),e.projectNames.length>0&&e.projectNames.length<=3?t.push(e.projectNames.join(", ")):e.projectNames.length>3&&t.push(`${e.projectNames.length} 個建案`),e.excludeCommercial&&t.push("排除商業/辦公"),t.length>0?t.join(" | "):"所有條件"}},68605:(e,t,a)=>{a.d(t,{c:()=>s});var r=a(95155);a(12115);var n=a(40980),i=a(62400);function s({title:e,description:t,children:a,headerAction:s,className:d,containerRef:o}){let l=(0,i.b)();return(0,r.jsxs)("div",{ref:o,className:(0,n.cn)("bg-zinc-900/50 border border-white/5 rounded-2xl p-4 md:p-6 backdrop-blur-sm",d),children:[(0,r.jsxs)("div",{className:"flex flex-col md:flex-row md:items-center justify-between gap-4 mb-6",children:[(0,r.jsxs)("div",{children:[(0,r.jsx)("h3",{className:"text-xl font-bold text-white flex items-center gap-2",children:e}),t&&(0,r.jsx)("p",{className:"text-zinc-400 text-sm mt-1",children:t})]}),s&&(0,r.jsx)("div",{className:"flex-shrink-0 w-full md:w-auto overflow-x-auto","data-html2canvas-ignore":"true",children:s})]}),a,(0,r.jsxs)("div",{className:"mt-4 pt-3 border-t border-white/10 flex flex-col items-center gap-1 text-xs text-center",style:{display:"none"},"data-export-footer":"true",children:[(0,r.jsx)("div",{className:"text-white font-semibold text-sm whitespace-nowrap",children:"彙整：平米內參 　來源：內政部實登"}),(0,r.jsxs)("div",{className:"text-zinc-400 text-center whitespace-nowrap overflow-hidden text-ellipsis w-full",children:["搜尋條件：",l]})]})]})}},70872:(e,t,a)=>{a.d(t,{Bc:()=>d,ZI:()=>c,k$:()=>l,m_:()=>o});var r=a(95155),n=a(12115),i=a(36376),s=a(40980);let d=i.Kq,o=i.bL,l=i.l9,c=n.forwardRef(({className:e,sideOffset:t=4,...a},n)=>(0,r.jsx)(i.UC,{ref:n,sideOffset:t,className:(0,s.cn)("z-50 overflow-hidden rounded-md border border-zinc-800 bg-zinc-950 px-3 py-1.5 text-sm text-zinc-100 shadow-md animate-in fade-in-0 zoom-in-95 data-[state=closed]:animate-out data-[state=closed]:fade-out-0 data-[state=closed]:zoom-out-95 data-[side=bottom]:slide-in-from-top-2 data-[side=left]:slide-in-from-right-2 data-[side=right]:slide-in-from-left-2 data-[side=top]:slide-in-from-bottom-2",e),...a}));c.displayName=i.UC.displayName},72264:(e,t,a)=>{a.d(t,{SQ:()=>l,_2:()=>c,hO:()=>h,lp:()=>m,mB:()=>g,rI:()=>d,ty:()=>o});var r=a(95155);a(12115);var n=a(61108),i=a(94514),s=a(40980);function d({...e}){return(0,r.jsx)(n.bL,{"data-slot":"dropdown-menu",...e})}function o({...e}){return(0,r.jsx)(n.l9,{"data-slot":"dropdown-menu-trigger",...e})}function l({className:e,sideOffset:t=4,...a}){return(0,r.jsx)(n.ZL,{children:(0,r.jsx)(n.UC,{"data-slot":"dropdown-menu-content",sideOffset:t,className:(0,s.cn)("bg-popover text-popover-foreground data-[state=open]:animate-in data-[state=closed]:animate-out data-[state=closed]:fade-out-0 data-[state=open]:fade-in-0 data-[state=closed]:zoom-out-95 data-[state=open]:zoom-in-95 data-[side=bottom]:slide-in-from-top-2 data-[side=left]:slide-in-from-right-2 data-[side=right]:slide-in-from-left-2 data-[side=top]:slide-in-from-bottom-2 z-50 max-h-(--radix-dropdown-menu-content-available-height) min-w-[8rem] origin-(--radix-dropdown-menu-content-transform-origin) overflow-x-hidden overflow-y-auto rounded-md border p-1 shadow-md",e),...a})})}function c({className:e,inset:t,variant:a="default",...i}){return(0,r.jsx)(n.q7,{"data-slot":"dropdown-menu-item","data-inset":t,"data-variant":a,className:(0,s.cn)("focus:bg-accent focus:text-accent-foreground data-[variant=destructive]:text-destructive data-[variant=destructive]:focus:bg-destructive/10 dark:data-[variant=destructive]:focus:bg-destructive/20 data-[variant=destructive]:focus:text-destructive data-[variant=destructive]:*:[svg]:!text-destructive [&_svg:not([class*='text-'])]:text-muted-foreground relative flex cursor-default items-center gap-2 rounded-sm px-2 py-1.5 text-sm outline-hidden select-none data-[disabled]:pointer-events-none data-[disabled]:opacity-50 data-[inset]:pl-8 [&_svg]:pointer-events-none [&_svg]:shrink-0 [&_svg:not([class*='size-'])]:size-4",e),...i})}function h({className:e,children:t,checked:a,...d}){return(0,r.jsxs)(n.H_,{"data-slot":"dropdown-menu-checkbox-item",className:(0,s.cn)("focus:bg-accent focus:text-accent-foreground relative flex cursor-default items-center gap-2 rounded-sm py-1.5 pr-2 pl-8 text-sm outline-hidden select-none data-[disabled]:pointer-events-none data-[disabled]:opacity-50 [&_svg]:pointer-events-none [&_svg]:shrink-0 [&_svg:not([class*='size-'])]:size-4",e),checked:a,...d,children:[(0,r.jsx)("span",{className:"pointer-events-none absolute left-2 flex size-3.5 items-center justify-center",children:(0,r.jsx)(n.VF,{children:(0,r.jsx)(i.A,{className:"size-4"})})}),t]})}function m({className:e,inset:t,...a}){return(0,r.jsx)(n.JU,{"data-slot":"dropdown-menu-label","data-inset":t,className:(0,s.cn)("px-2 py-1.5 text-sm font-medium data-[inset]:pl-8",e),...a})}function g({className:e,...t}){return(0,r.jsx)(n.wv,{"data-slot":"dropdown-menu-separator",className:(0,s.cn)("bg-border -mx-1 my-1 h-px",e),...t})}},89733:(e,t,a)=>{a.d(t,{N:()=>I});var r=a(95155),n=a(98500),i=a.n(n);a(12115);var s=a(73321),d=a(6296),o=a(25777),l=a(6962),c=a(66088),h=a(95057),m=a(89239),g=a(38346),u=a(96066),p=a(70872),x=a(72264),f=a(40980),b=a(62400),v=a(66609),w=a(37717),y=a(98028);function I({data:e,filename:t="export",label:n="匯出",className:I,disabled:j=!1,columns:N,chartType:z,snapshotData:P,targetRef:S,chartId:C}){let{role:k,isLoading:$}=(0,g.h)(),R=(0,s.useRouter)(),T=(0,u.Q)(e=>e.addItem),_=(0,w.A)(),A=["pro","pro_max","admin","super_admin"].includes(k||""),F=!$,M=()=>{if(F&&A){if(!e||0===e.length)return void alert("無數據可導出");try{let a=Object.keys(e[0]),r=[a.map(e=>N&&N[e]||e).join(","),...e.map(e=>a.map(t=>{let a=e[t];if(null==a)return"";if("number"==typeof a){let e=N&&N[t]||t;return/Area|坪|Rate|Ratio|Share|Percent|比|率/.test(t)||/Area|坪|Rate|Ratio|Share|Percent|比|率/.test(e)?a.toFixed(2):Math.round(a).toFixed(0)}if("object"==typeof a)try{return`"${JSON.stringify(a).replace(/"/g,'""')}"`}catch(e){return""}return"string"==typeof a?`"${a.replace(/"/g,'""').replace(/\n/g," ")}"`:a}).join(","))].join("\n"),n=new Blob(["\uFEFF"+r],{type:"text/csv;charset=utf-8;"}),i=URL.createObjectURL(n),s=document.createElement("a"),d=new Date().toISOString().split("T")[0],o=`${t}_${d}.csv`;s.href=i,s.setAttribute("download",o),document.body.appendChild(s),s.click(),document.body.removeChild(s),URL.revokeObjectURL(i)}catch(e){console.error("Export failed:",e),alert("匯出失敗，請查看控制台日誌")}}},L=async()=>{if(A&&S?.current){if(C&&await U(C,S.current,t))return void v.o.success("已成功匯出圖片");try{let e=S.current,a=e.querySelectorAll('[data-export-footer="true"]');a.forEach(e=>{e.style.display="flex"}),await new Promise(e=>{requestAnimationFrame(()=>e())});let r=await (0,y.domToPng)(e,{scale:2,backgroundColor:_.card||_.bg,filter:e=>!(e instanceof HTMLElement&&e.getAttribute("data-html2canvas-ignore"))});a.forEach(e=>{e.style.display="none"});let n=document.createElement("a"),i=new Date().toISOString().split("T")[0];n.href=r,n.download=`${t}_${i}.png`,document.body.appendChild(n),n.click(),document.body.removeChild(n),v.o.success("已成功匯出圖片")}catch(t){console.error("PNG export failed:",t);let e=S.current;e&&e.querySelectorAll('[data-export-footer="true"]').forEach(e=>{e.style.display="none"}),v.o.error("匯出圖片失敗",{description:"請稍後再試或聯繫客服"})}}},U=async(e,t,r)=>{try{let n,{default:i}=await a.e(7776).then(a.bind(a,95338)),s=i.getChartByID(e);if(!s||!s.el)return!1;let d=s.el.querySelector(".apexcharts-canvas"),o=d?.style.backgroundColor;if(d&&(d.style.backgroundColor=_.card||_.bg),"function"==typeof s.dataURI)try{n=await s.dataURI()}catch(t){n=await i.exec(e,"dataURI")}else n=await i.exec(e,"dataURI");d&&(d.style.backgroundColor=o||"");let l=null,c=null;if(n?.blob instanceof Blob&&(c=l=URL.createObjectURL(n.blob)),l||(l=n?.imgURI||n?.imgUri||n?.dataURI),!l)return!1;let h=new Image;h.src=l,await new Promise((e,t)=>{h.onload=()=>e(null),h.onerror=t});let m=window.getComputedStyle(t),g=parseFloat(m.paddingTop||"0")||0,u=parseFloat(m.paddingBottom||"0")||0,p=parseFloat(m.paddingLeft||"0")||0,x=parseFloat(m.paddingRight||"0")||0,f=t.querySelector(":scope > div"),v=f?.querySelector("div"),w=v?.querySelector("h3"),y=v?.querySelector("p"),I=f&&parseFloat(window.getComputedStyle(f).marginBottom||"0")||0,j=w?.textContent?.trim()||"",N=y?.textContent?.trim()||"",z=w?window.getComputedStyle(w):null,P=y?window.getComputedStyle(y):null,S=z&&parseFloat(z.fontSize||"20")||20,C=z&&parseFloat(z.lineHeight||`${1.3*S}`)||1.3*S,k=z?.fontWeight||"700",$=z?.fontFamily||'"Noto Sans TC", "Inter", sans-serif',R=P&&parseFloat(P.fontSize||"13")||13,T=P&&parseFloat(P.lineHeight||`${1.4*R}`)||1.4*R,A=P?.fontWeight||"400",F=P?.fontFamily||'"Noto Sans TC", "Inter", sans-serif',M=j&&N?6:0,L=(j?C:0)+(N?T+M:0),U=h.width,D=Math.max(U+p+x,t.clientWidth||0),E=D-p-x,O=E/U,B=h.height*O,q=g+L+I+B+64+u,H=window.devicePixelRatio||1,Z=document.createElement("canvas");Z.width=Math.round(D*H),Z.height=Math.round(q*H);let Q=Z.getContext("2d");if(!Q)return!1;Q.scale(H,H),Q.fillStyle=_.card||_.bg,Q.fillRect(0,0,D,q);let V=g;Q.textBaseline="top",j&&(Q.font=`${k} ${S}px ${$}`,Q.fillStyle=_.text,Q.textAlign="left",Q.fillText(j,p,V),V+=C),N&&(V+=M,Q.font=`${A} ${R}px ${F}`,Q.fillStyle=_.textMuted,Q.textAlign="left",Q.fillText(N,p,V),V+=T),V+=I,Q.drawImage(h,p,V,E,B);let W=q-64-u;Q.strokeStyle=_.border,Q.beginPath(),Q.moveTo(0,W),Q.lineTo(D,W),Q.stroke();let G=`搜尋條件：${(0,b.b)()}`,J=D-48;Q.textAlign="center",Q.font=`600 13px ${$}`,Q.fillStyle=_.text,Q.fillText("彙整：平米內參 　來源：內政部實登",D/2,W+18),Q.font=`400 11px ${F}`,Q.fillStyle=_.textMuted;let K=G;for(;Q.measureText(K).width>J&&K.length>4;)K=K.slice(0,-1);K!==G&&(K=`${K.slice(0,-1)}…`),Q.fillText(K,D/2,W+38);let Y=Z.toDataURL("image/png"),X=document.createElement("a"),ee=new Date().toISOString().split("T")[0];return X.href=Y,X.download=`${r}_${ee}.png`,document.body.appendChild(X),X.click(),document.body.removeChild(X),c&&URL.revokeObjectURL(c),!0}catch(e){return console.warn("ApexCharts export failed",e),!1}};return $?(0,r.jsxs)(m.$,{variant:"outline",size:"sm",disabled:!0,"data-report-control":"always-hide",className:`gap-2 border-dashed border-zinc-700 bg-zinc-900/50 text-zinc-600 ${I}`,children:[(0,r.jsx)(d.A,{className:"h-4 w-4 animate-spin"}),(0,r.jsx)("span",{className:"hidden sm:inline",children:"載入中..."})]}):z?(0,r.jsx)(p.Bc,{children:(0,r.jsxs)(p.m_,{delayDuration:0,children:[(0,r.jsx)(p.k$,{asChild:!0,children:(0,r.jsx)("span",{className:"inline-flex",tabIndex:A?-1:0,"data-report-control":"always-hide",children:A?(0,r.jsxs)(x.rI,{children:[(0,r.jsx)(x.ty,{asChild:!0,children:(0,r.jsxs)(m.$,{variant:"outline",size:"sm",disabled:j||!e||0===e.length,className:(0,f.cn)("gap-1.5 border-dashed transition-all border-zinc-700 bg-zinc-900/50 hover:bg-zinc-800 text-zinc-400 hover:text-white",I),children:[(0,r.jsx)(l.A,{className:"h-4 w-4"}),(0,r.jsx)("span",{className:"hidden sm:inline",children:n}),(0,r.jsx)(c.A,{className:"h-3 w-3"})]})}),(0,r.jsxs)(x.SQ,{align:"start",className:"min-w-[180px] bg-zinc-900 border-zinc-700",children:[(0,r.jsxs)(x._2,{onClick:M,className:"flex items-center gap-2 text-zinc-300 hover:text-white focus:text-white cursor-pointer",children:[(0,r.jsx)(l.A,{className:"h-4 w-4 text-zinc-500"}),"匯出 CSV"]}),S&&(0,r.jsxs)(x._2,{onClick:L,className:"flex items-center gap-2 text-zinc-300 hover:text-white focus:text-white cursor-pointer",children:[(0,r.jsx)("div",{className:"h-4 w-4 flex items-center justify-center text-zinc-500 font-bold text-[10px] border border-zinc-600 rounded",children:"P"}),"匯出 PNG (圖片)"]}),(0,r.jsxs)(x._2,{onClick:()=>{A&&z&&(T(z,void 0!==P?P:e),v.o.success("已新增至報表編輯器",{description:"請點選左側「生成報告」繼續編輯",action:{label:"前往編輯",onClick:()=>R.push("/reports/builder")}}))},className:"flex items-center gap-2 text-zinc-300 hover:text-violet-300 focus:text-violet-300 hover:bg-violet-600/20 focus:bg-violet-600/20 cursor-pointer",children:[(0,r.jsx)(h.A,{className:"h-4 w-4 text-violet-500"}),"新增到報表編輯器"]})]})]}):(0,r.jsxs)(m.$,{variant:"outline",size:"sm",disabled:!0,className:(0,f.cn)("gap-1.5 border-dashed transition-all border-zinc-800 bg-zinc-900/30 text-zinc-600 cursor-not-allowed hover:bg-zinc-900/30",I),children:[(0,r.jsx)(o.A,{className:"h-3 w-3"}),(0,r.jsx)("span",{className:"hidden sm:inline",children:n})]})})}),!A&&(0,r.jsx)(p.ZI,{className:"bg-zinc-950 border border-zinc-800 p-0 overflow-hidden",children:(0,r.jsxs)("div",{className:"flex flex-col gap-1 items-center p-3",children:[(0,r.jsx)("p",{className:"font-medium text-zinc-200",children:"Pro 會員限定功能"}),(0,r.jsx)(i(),{href:"/pricing",className:"text-xs text-violet-400 hover:text-violet-300 underline underline-offset-2 transition-colors flex items-center gap-1",children:"查看升級方案 →"})]})})]})}):(0,r.jsx)(p.Bc,{children:(0,r.jsxs)(p.m_,{delayDuration:0,children:[(0,r.jsx)(p.k$,{asChild:!0,children:(0,r.jsx)("span",{className:"inline-flex",tabIndex:A?-1:0,"data-report-control":"always-hide",children:(0,r.jsxs)(m.$,{variant:"outline",size:"sm",onClick:M,disabled:j||A&&(!e||0===e.length),className:(0,f.cn)("gap-1.5 border-dashed transition-all",A?"border-zinc-700 bg-zinc-900/50 hover:bg-zinc-800 text-zinc-400 hover:text-white":"border-zinc-800 bg-zinc-900/30 text-zinc-600 cursor-not-allowed hover:bg-zinc-900/30",I),children:[A?(0,r.jsx)(l.A,{className:"h-4 w-4"}):(0,r.jsx)(o.A,{className:"h-3 w-3"}),(0,r.jsx)("span",{className:"hidden sm:inline",children:n})]})})}),!A&&(0,r.jsx)(p.ZI,{className:"bg-zinc-950 border border-zinc-800 p-0 overflow-hidden",children:(0,r.jsxs)("div",{className:"flex flex-col gap-1 items-center p-3",children:[(0,r.jsx)("p",{className:"font-medium text-zinc-200",children:"Pro 會員限定功能"}),(0,r.jsx)(i(),{href:"/pricing",className:"text-xs text-violet-400 hover:text-violet-300 underline underline-offset-2 transition-colors flex items-center gap-1",children:"查看升級方案 →"})]})})]})})}},96066:(e,t,a)=>{a.d(t,{Q:()=>d});var r=a(1934),n=a(31692);let i={"cover-template":{width:900,height:500},"ranking-chart":{width:400,height:300},"ranking-table":{width:600,height:400},"ranking-metrics":{width:600,height:200},"price-band-chart":{width:450,height:280},"price-band-table":{width:600,height:400},"price-band-location-table":{width:600,height:400},"price-band-location-chart":{width:600,height:400},"unit-price-bubble":{width:380,height:320},"unit-price-stats":{width:1e3,height:400},"type-comparison-table":{width:600,height:350},"sales-velocity-chart":{width:420,height:260},"sales-velocity-table":{width:600,height:400},"sales-heatmap":{width:450,height:350},"sales-heatmap-detail":{width:800,height:400},"parking-pie":{width:300,height:300},"parking-price":{width:400,height:300},"parking-scatter":{width:450,height:350},"parking-floor":{width:400,height:400},"parking-floor-detail":{width:900,height:420},"policy-timeline":{width:900,height:500},heatmap:{width:500,height:350},"heatmap-grid":{width:800,height:500},"heatmap-stats":{width:800,height:120},"heatmap-comparison":{width:800,height:300},"data-list":{width:600,height:400},"text-box":{width:280,height:90}},s=e=>({id:`page-${Date.now()}`,name:`第 ${e+1} 頁`,items:[]}),d=(0,r.v)()((0,n.Zr)((e,t)=>({pages:[s(0)],currentPageIndex:0,canvasRatio:"16:9",zoomLevel:100,viewMode:"continuous",selectedIds:[],isDragging:!1,draggedItemCount:0,hoveredPageIndex:null,setViewMode:t=>e({viewMode:t}),setDragging:(t,a=0)=>e({isDragging:t,draggedItemCount:a}),setHoveredPageIndex:t=>e({hoveredPageIndex:t}),get items(){let e=t();return e.pages[e.currentPageIndex]?.items||[]},addPage:()=>{e(e=>{let t=s(e.pages.length);return{pages:[...e.pages,t],currentPageIndex:e.pages.length,selectedIds:[]}})},deletePage:t=>{e(e=>{if(e.pages.length<=1||-1===e.pages.findIndex(e=>e.id===t))return e;let a=e.pages.filter(e=>e.id!==t).map((e,t)=>({...e,name:`第 ${t+1} 頁`})),r=Math.min(e.currentPageIndex,a.length-1);return{pages:a,currentPageIndex:r,selectedIds:[]}})},setCurrentPage:t=>{e(e=>({currentPageIndex:Math.max(0,Math.min(t,e.pages.length-1)),selectedIds:[]}))},renamePage:(t,a)=>{e(e=>({pages:e.pages.map(e=>e.id===t?{...e,name:a}:e)}))},reorderPages:(t,a)=>{e(e=>{if(t===a)return e;let r=[...e.pages],[n]=r.splice(t,1);r.splice(a,0,n);let i=r.map((e,t)=>({...e,name:`第 ${t+1} 頁`})),s=e.currentPageIndex;return e.currentPageIndex===t?s=a:t<e.currentPageIndex&&a>=e.currentPageIndex?s=e.currentPageIndex-1:t>e.currentPageIndex&&a<=e.currentPageIndex&&(s=e.currentPageIndex+1),{pages:i,currentPageIndex:s}})},addItem:(t,a)=>{let r=i[t]||{width:400,height:300};e(e=>{let n=e.pages[e.currentPageIndex];if(!n)return e;let i=20*n.items.length,s="cover-template"===t,d={id:`item-${Date.now()}`,type:t,x:s?0:50+i,y:s?0:50+i,width:r.width,height:r.height,contentBase:{width:r.width,height:r.height},headerLocked:!1,showControls:"text-box"===t,scaleMode:"select",panOffset:{x:0,y:0},contentScale:s||"text-box"===t?1:.5,data:a??(e=>{if("cover-template"===e){let e=new Date,t=e.getFullYear(),a=String(e.getMonth()+1).padStart(2,"0"),r=String(e.getDate()).padStart(2,"0");return{logoText:"平米內參",title:"市場分析報告",subtitle:"價格帶與銷售動能評估",projectName:"請填寫建案名稱",period:"2026 Q1",preparedBy:"平米內參",reportDate:`${t}-${a}-${r}`,searchConditions:[]}}if("text-box"===e)return{html:"<div>請輸入文字或數字</div>",align:"left",verticalAlign:"top",fontSize:20,maxFontSize:20,fontFamily:'"Noto Sans TC", "PingFang TC", "Microsoft JhengHei", system-ui, sans-serif',fontWeight:500,italic:!1,underline:!1,color:"var(--color-text-primary)",autoFit:!1,autoGrow:!0,rotation:0}})(t)};return{pages:e.pages.map((t,a)=>a===e.currentPageIndex?{...t,items:[...t.items,d]}:t),selectedIds:[d.id]}})},addItems:t=>{t.length&&e(e=>e.pages[e.currentPageIndex]?{pages:e.pages.map((a,r)=>r===e.currentPageIndex?{...a,items:[...a.items,...t]}:a),selectedIds:t.map(e=>e.id)}:e)},updateItem:(t,a)=>{e(e=>({pages:e.pages.map((r,n)=>n===e.currentPageIndex?{...r,items:r.items.map(e=>e.id===t?{...e,...a}:e)}:r)}))},removeItem:t=>{e(e=>({pages:e.pages.map((a,r)=>r===e.currentPageIndex?{...a,items:a.items.filter(e=>e.id!==t)}:a),selectedIds:e.selectedIds.filter(e=>e!==t)}))},moveItemToPage:(t,a)=>{e(e=>{let r=e.pages[e.currentPageIndex],n=r?.items.find(e=>e.id===t);return!n||a===e.currentPageIndex||a<0||a>=e.pages.length?e:{pages:e.pages.map((r,i)=>i===e.currentPageIndex?{...r,items:r.items.filter(e=>e.id!==t)}:i===a?{...r,items:[...r.items,{...n,x:50,y:50}]}:r),selectedIds:[]}})},clearCanvas:()=>{e(e=>({pages:e.pages.map((t,a)=>a===e.currentPageIndex?{...t,items:[]}:t),selectedIds:[]}))},batchUpdateItems:t=>{e(e=>({pages:e.pages.map((a,r)=>r===e.currentPageIndex?{...a,items:a.items.map(e=>t[e.id]?{...e,...t[e.id]}:e)}:a)}))},setCanvasRatio:t=>e({canvasRatio:t}),setZoomLevel:t=>e({zoomLevel:Math.max(25,Math.min(400,t))}),resetZoom:()=>e({zoomLevel:100}),setSelectedIds:t=>e({selectedIds:t}),toggleSelection:t=>{e(e=>({selectedIds:e.selectedIds.includes(t)?e.selectedIds.filter(e=>e!==t):[...e.selectedIds,t]}))},addToSelection:t=>{e(e=>({selectedIds:e.selectedIds.includes(t)?e.selectedIds:[...e.selectedIds,t]}))},clearSelection:()=>e({selectedIds:[]}),removeSelectedItems:()=>{e(e=>e.pages[e.currentPageIndex]?{pages:e.pages.map((t,a)=>a===e.currentPageIndex?{...t,items:t.items.filter(t=>!e.selectedIds.includes(t.id))}:t),selectedIds:[]}:e)},moveSelectedItemsToPage:t=>{e(e=>{if(t===e.currentPageIndex||t<0||t>=e.pages.length)return e;let a=e.pages[e.currentPageIndex].items.filter(t=>e.selectedIds.includes(t.id));return 0===a.length?e:{pages:e.pages.map((r,n)=>n===e.currentPageIndex?{...r,items:r.items.filter(t=>!e.selectedIds.includes(t.id))}:n===t?{...r,items:[...r.items,...a.map((e,t)=>({...e,x:50+20*t,y:50+20*t}))]}:r),selectedIds:[]}})}}),{name:"report-builder-storage"}))}}]);