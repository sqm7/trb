"use strict";(self.webpackChunk_N_E=self.webpackChunk_N_E||[]).push([[2047],{19835:(e,t,n)=>{n.d(t,{A:()=>i});let i=(0,n(78340).A)("move",[["path",{d:"M12 2v20",key:"t6zp3m"}],["path",{d:"m15 19-3 3-3-3",key:"11eu04"}],["path",{d:"m19 9 3 3-3 3",key:"1mg7y2"}],["path",{d:"M2 12h20",key:"9i4pu4"}],["path",{d:"m5 9-3 3 3 3",key:"j64kie"}],["path",{d:"m9 5 3-3 3 3",key:"l8vdw6"}]])},22651:(e,t,n)=>{n.d(t,{A:()=>i});let i=(0,n(78340).A)("zoom-in",[["circle",{cx:"11",cy:"11",r:"8",key:"4ej97u"}],["line",{x1:"21",x2:"16.65",y1:"21",y2:"16.65",key:"13gj7c"}],["line",{x1:"11",x2:"11",y1:"8",y2:"14",key:"1vmskp"}],["line",{x1:"8",x2:"14",y1:"11",y2:"11",key:"durymu"}]])},68459:(e,t,n)=>{n.d(t,{A:()=>i});let i=(0,n(78340).A)("trash-2",[["path",{d:"M10 11v6",key:"nco0om"}],["path",{d:"M14 11v6",key:"outv1u"}],["path",{d:"M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6",key:"miytrc"}],["path",{d:"M3 6h18",key:"d0wm0j"}],["path",{d:"M8 6V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2",key:"e791ji"}]])},69220:(e,t,n)=>{n.d(t,{A:()=>i});let i=(0,n(78340).A)("zoom-out",[["circle",{cx:"11",cy:"11",r:"8",key:"4ej97u"}],["line",{x1:"21",x2:"16.65",y1:"21",y2:"16.65",key:"13gj7c"}],["line",{x1:"8",x2:"14",y1:"11",y2:"11",key:"durymu"}]])},82047:(e,t,n)=>{n.r(t),n.d(t,{default:()=>b});var i=n(95155),l=n(12115),r=n(21975),a=n(19835),s=n(22390),o=n(78340);let d=(0,o.A)("spline",[["circle",{cx:"19",cy:"5",r:"2",key:"mhkx31"}],["circle",{cx:"5",cy:"19",r:"2",key:"v8kfzx"}],["path",{d:"M5 17A12 12 0 0 1 17 5",key:"1okkup"}]]),c=(0,o.A)("square",[["rect",{width:"18",height:"18",x:"3",y:"3",rx:"2",key:"afitv7"}]]),u=(0,o.A)("app-window",[["rect",{x:"2",y:"4",width:"20",height:"16",rx:"2",key:"izxlao"}],["path",{d:"M10 4v4",key:"pp8u80"}],["path",{d:"M2 8h20",key:"d11cs7"}],["path",{d:"M6 4v4",key:"1svtjw"}]]);var x=n(22651),m=n(69220),h=n(68459),p=n(40980),g=n(38346);let y={wall:"#60a5fa",window:"#38bdf8",pillar:"#f97316"},f=[{type:"wardrobe",label:"衣櫃",size:{w:80,h:40}},{type:"cabinet",label:"櫃體",size:{w:60,h:30}},{type:"bed",label:"床",size:{w:120,h:80}},{type:"sofa",label:"沙發",size:{w:110,h:50}},{type:"diningTable",label:"餐桌",size:{w:90,h:60}},{type:"desk",label:"書桌",size:{w:80,h:45}},{type:"chair",label:"椅子",size:{w:30,h:30}},{type:"sink",label:"洗手台",size:{w:50,h:35}},{type:"toilet",label:"馬桶",size:{w:35,h:45}},{type:"kitchen",label:"流理台",size:{w:120,h:40}},{type:"fridge",label:"冰箱",size:{w:40,h:35}}],w=()=>Math.random().toString(36).slice(2,10);function b({onUploadSuccess:e}){let t=(0,l.useRef)(null),n=(0,l.useRef)(null),o=(0,l.useRef)(null),b=(0,l.useRef)({zoomLevel:1,panOffset:{x:0,y:0},isPanning:!1,panStart:{x:0,y:0},drawing:!1,startPoint:{x:0,y:0},endPoint:{x:0,y:0},drawingPoints:[],measureLines:[],wallPaths:[],rooms:[],columns:[],windows:[],furniture:[],scale:null,selected:null,draggingFurnitureId:null,draggingWindowId:null,draggingWindowHandle:null,draggingWallPathId:null,draggingRoomId:null,draggingColumnId:null,draggingMeasureId:null,draggingColumnResize:null,dragStartMouse:{x:0,y:0},dragStartFurniturePos:{x:0,y:0},dragStartRoomPoints:[],dragStartColumnPoints:[],dragStartWallMouse:{x:0,y:0},dragStartWallPoints:[],dragStartMeasure:null,dragStartWindow:null,snappedPoint:null,snappedType:null,pointerWorld:null,activeMeasureMode:null,measureFinalizePending:!1,isCtrlPressed:!1,isAltPressed:!1,isSpacePressed:!1,isShiftPressed:!1,isOrthoMode:!1,usedOrthoDuringDraw:!1,history:[],historyIndex:-1,clipboard:null}),[v,k]=(0,l.useState)({mode:null,hasImage:!1,scaleSet:!1,infoText:"請上傳平面圖開始",fillColor:"#4ade80",fillOpacity:.2,imageOpacity:.7,boundaryFillColor:"#22c55e",boundaryFillOpacity:.15,boundaryLineScale:1,innerLineScale:1,wallLineScale:1,zoomDisplay:100,isOrtho:!1,selectedFurnitureType:"wardrobe",wallThicknessDefault:15,windowWidthCm:120,windowType:"sliding",planType:"indoor",planNote:""}),P=(0,l.useRef)(v.wallThicknessDefault),[S,z]=(0,l.useState)(null),{role:j,isLoading:M}=(0,g.h)(),C="super_admin"!==j||M,N=e=>({x:(e.x-b.current.panOffset.x)/b.current.zoomLevel,y:(e.y-b.current.panOffset.y)/b.current.zoomLevel}),T=(e,t)=>Math.sqrt((t.x-e.x)**2+(t.y-e.y)**2),L=(e,t,n,i)=>{let l=t.x-e.x,r=t.y-e.y,a=en();if(Math.abs(l)>=Math.abs(r)){let l={x:t.x,y:e.y},r={x:(e.x+l.x)/2,y:e.y},s=!a||U(r,a.points);return{id:w(),type:"line",pixelStart:{...e},pixelEnd:l,color:n,offset:0,orientation:"h",purpose:i,isInside:s}}let s={x:e.x,y:t.y},o={x:e.x,y:(e.y+s.y)/2},d=!a||U(o,a.points);return{id:w(),type:"line",pixelStart:{...e},pixelEnd:s,color:n,offset:0,orientation:"v",purpose:i,isInside:d}},I=(e,t=1)=>{let n=e.pixelStart,i=e.pixelEnd,l=Math.min(Math.abs(e.offset),18/t),r=e.offset>=0?l:-l;if("h"===e.orientation){let t=n.y+e.offset,l={x:n.x,y:t},a={x:i.x,y:t};return{start:n,end:i,dimStart:l,dimEnd:a,extStart:{x:n.x,y:n.y},extStartTo:{x:n.x,y:n.y+r},extEnd:{x:i.x,y:i.y},extEndTo:{x:i.x,y:i.y+r}}}let a=n.x+e.offset,s={x:a,y:n.y},o={x:a,y:i.y};return{start:n,end:i,dimStart:s,dimEnd:o,extStart:{x:n.x,y:n.y},extStartTo:{x:n.x+r,y:n.y},extEnd:{x:i.x,y:i.y},extEndTo:{x:i.x+r,y:i.y}}},E=e=>e.map(e=>({...e})),W=(0,l.useCallback)(()=>{let e,t=b.current,n={wallPaths:(e=b.current).wallPaths.map(e=>({...e,points:E(e.points),segments:e.segments.map(e=>({...e}))})),rooms:e.rooms.map(e=>({...e,points:E(e.points)})),columns:e.columns.map(e=>({...e,points:E(e.points)})),windows:e.windows.map(e=>({...e})),furniture:e.furniture.map(e=>({...e,position:{...e.position}})),measureLines:e.measureLines.map(e=>({...e,pixelStart:{...e.pixelStart},pixelEnd:{...e.pixelEnd}})),scale:e.scale};t.history=t.history.slice(0,t.historyIndex+1),t.history.push(n),t.historyIndex=t.history.length-1},[]),F=(0,l.useCallback)(()=>{let e,t=b.current;if(t.historyIndex<=0)return;t.historyIndex-=1;let n=t.history[t.historyIndex];n&&((e=b.current).wallPaths=n.wallPaths.map(e=>({...e,points:E(e.points),segments:e.segments.map(e=>({...e}))})),e.rooms=n.rooms.map(e=>({...e,points:E(e.points)})),e.columns=n.columns.map(e=>({...e,points:E(e.points)})),e.windows=n.windows.map(e=>({...e})),e.furniture=n.furniture.map(e=>({...e,position:{...e.position}})),e.measureLines=n.measureLines.map(e=>({...e,pixelStart:{...e.pixelStart},pixelEnd:{...e.pixelEnd}})),e.scale=n.scale,es(null),k(e=>({...e,scaleSet:!!n.scale,infoText:"已復原"})),ea())},[]),R=(0,l.useCallback)(()=>{let e=b.current;if(S){if("room"===S.kind){let t=e.rooms.find(e=>e.id===S.id);t&&(e.clipboard={kind:"room",data:{...t,points:E(t.points)}})}else if("column"===S.kind){let t=e.columns.find(e=>e.id===S.id);t&&(e.clipboard={kind:"column",data:{...t,points:E(t.points)}})}else if("furniture"===S.kind){let t=e.furniture.find(e=>e.id===S.id);t&&(e.clipboard={kind:"furniture",data:{...t,position:{...t.position}}})}else if("window"===S.kind){let t=e.windows.find(e=>e.id===S.id);t&&(e.clipboard={kind:"window",data:{...t}})}else if("wall"===S.kind){let t=e.wallPaths.find(e=>e.id===S.pathId);t&&!t.isBoundary&&(e.clipboard={kind:"wall",data:{...t,points:E(t.points),segments:t.segments.map(e=>({...e}))}})}e.clipboard&&k(e=>({...e,infoText:"已複製"}))}},[S]),D=(0,l.useCallback)(()=>{let e=b.current;if(!e.clipboard)return;let t=20/e.zoomLevel;if("room"===e.clipboard.kind){let n=e.clipboard.data,i={...n,id:w(),name:`${n.name} (複製)`,points:n.points.map(e=>({x:e.x+t,y:e.y+t}))};e.rooms.push(i),es({kind:"room",id:i.id})}else if("column"===e.clipboard.kind){let n=e.clipboard.data,i={id:w(),points:n.points.map(e=>({x:e.x+t,y:e.y+t}))};e.columns.push(i),es({kind:"column",id:i.id})}else if("furniture"===e.clipboard.kind){let n=e.clipboard.data,i={...n,id:w(),position:{x:n.position.x+t,y:n.position.y+t}};e.furniture.push(i),es({kind:"furniture",id:i.id})}else if("window"===e.clipboard.kind){let t=e.clipboard.data;if(en()){let n={...t,id:w(),t:Math.min(.95,Math.max(.05,t.t+.05))};ew(n),e.windows.push(n),es({kind:"window",id:n.id})}}else if("wall"===e.clipboard.kind){let n=e.clipboard.data,i={...n,id:w(),points:n.points.map(e=>({x:e.x+t,y:e.y+t})),segments:n.segments.map(e=>({...e}))};e.wallPaths.push(i),es({kind:"wall",pathId:i.id,segmentIndex:0})}W(),ea()},[W]),A=e=>{let t=0;for(let n=0,i=e.length;n<i;n++)t+=e[n].x*e[n===i-1?0:n+1].y-e[n===i-1?0:n+1].x*e[n].y;return Math.abs(t/2)},O=e=>{let t=0;for(let n=0,i=e.length;n<i;n++){let l=e[n],r=e[n===i-1?0:n+1];t+=l.x*r.y-r.x*l.y}return t/2},B=e=>{if(0===e.length)return{x:0,y:0};let t=0,n=0,i=0;for(let l=0;l<e.length;l++){let r=e[l],a=e[(l+1)%e.length],s=r.x*a.y-a.x*r.y;i+=s,t+=(r.x+a.x)*s,n+=(r.y+a.y)*s}let l=3*i;return 0===l?e[0]:{x:t/l,y:n/l}},$=(e,t)=>{let n=parseInt(e.slice(1,3),16),i=parseInt(e.slice(3,5),16),l=parseInt(e.slice(5,7),16);return`rgba(${n}, ${i}, ${l}, ${t})`},X=(e,t,n)=>{let i=n.x-t.x,l=n.y-t.y,r=e.x-t.x,a=e.y-t.y,s=i*i+l*l;if(0===s)return T(e,t);let o=Math.max(0,Math.min(1,(r*i+a*l)/s));return T(e,{x:t.x+i*o,y:t.y+l*o})},Y=(e,t,n)=>{let i=n.x-t.x,l=n.y-t.y,r=e.x-t.x,a=e.y-t.y,s=i*i+l*l;if(0===s)return{point:t,t:0};let o=Math.max(0,Math.min(1,(r*i+a*l)/s));return{point:{x:t.x+i*o,y:t.y+l*o},t:o}},K=(e,t,n)=>{let i=n,l=null;for(let n=0;n<e.length;n++){let r=e[n],a=e[(n+1)%e.length],s=X(t,r,a);s<i&&(i=s,l={a:r,b:a})}return l},H=e=>{let t=e.map(e=>e.x),n=e.map(e=>e.y);return{minX:Math.min(...t),maxX:Math.max(...t),minY:Math.min(...n),maxY:Math.max(...n)}},q=e=>{let t=b.current,n=[];return t.wallPaths.forEach(i=>{if(i.isBoundary||e&&i.id===e)return;let l=Math.max(0,i.points.length-1);for(let e=0;e<l;e++){let l=i.points[e],r=i.points[e+1],a=r.x-l.x,s=r.y-l.y,o=Math.sqrt(a*a+s*s)||1,d={x:-s/o,y:a/o},c=t.scale?(i.segments[e]?.thicknessCm??v.wallThicknessDefault)*t.scale:12,u=(i.offsetSide??1)*c,x=d.x*u,m=d.y*u;n.push(l,r,{x:l.x+x,y:l.y+m},{x:r.x+x,y:r.y+m})}}),n},_=e=>{let t=b.current;if(!S||"column"!==S.kind)return null;let n=t.columns.find(e=>e.id===S.id);if(!n)return null;let i=H(n.points),l=8/t.zoomLevel;for(let t of[{handle:"nw",x:i.minX,y:i.minY},{handle:"ne",x:i.maxX,y:i.minY},{handle:"se",x:i.maxX,y:i.maxY},{handle:"sw",x:i.minX,y:i.maxY}])if(T(e,{x:t.x,y:t.y})<=l)return{column:n,handle:t.handle,bounds:i};return null},U=(e,t)=>{let n=!1;for(let i=0,l=t.length-1;i<t.length;l=i++){let r=t[i].x,a=t[i].y,s=t[l].x,o=t[l].y;a>e.y!=o>e.y&&e.x<(s-r)*(e.y-a)/(o-a+1e-5)+r&&(n=!n)}return n},V=(e,t,n,i)=>{let l={x:i.x-t.x,y:i.y-t.y},r={x:n.x-t.x,y:n.y-t.y},a={x:e.x-t.x,y:e.y-t.y},s=l.x*l.x+l.y*l.y,o=l.x*r.x+l.y*r.y,d=l.x*a.x+l.y*a.y,c=r.x*r.x+r.y*r.y,u=r.x*a.x+r.y*a.y,x=s*c-o*o;if(0===x)return!1;let m=1/x,h=(c*d-o*u)*m,p=(s*u-o*d)*m;return h>=-1e-4&&p>=-1e-4&&h+p<=1.0001},Z=e=>f.find(t=>t.type===e)||f[0],G=e=>{let t=Z(e.type),n=t.size.w*e.scale/2,i=t.size.h*e.scale/2,l=Math.cos(e.rotation),r=Math.sin(e.rotation),a=[{x:-n,y:-i},{x:n,y:-i},{x:n,y:i},{x:-n,y:i}].map(t=>({x:e.position.x+t.x*l-t.y*r,y:e.position.y+t.x*r+t.y*l})),s=a.map(e=>e.x),o=a.map(e=>e.y);return{minX:Math.min(...s),maxX:Math.max(...s),minY:Math.min(...o),maxY:Math.max(...o)}},J=(e,t,n,i,l)=>{e.save();let r=13/l;e.font=`bold ${r}px sans-serif`,e.fillStyle="rgba(0,0,0,0.7)";let a=e.measureText(t).width;e.fillRect(n.x-a/2-2/l,n.y-r-2/l,a+4/l,r+4/l),e.fillStyle=i,e.textAlign="center",e.fillText(t,n.x,n.y-4/l),e.restore()},Q=(e,t)=>Math.abs(t.x-e.x)>Math.abs(t.y-e.y)?{x:t.x,y:e.y}:{x:e.x,y:t.y},ee=e=>{if(e.length<2)return e;let t=e[0],n=e[1],i=e[e.length-1];return Math.abs(n.x-t.x)>=Math.abs(n.y-t.y)?[{x:i.x,y:t.y},...e.slice(1)]:[{x:t.x,y:i.y},...e.slice(1)]},et=e=>{if(e.length<2)return e;let t=[{...e[0]}];for(let n=1;n<e.length;n++){let i=t[n-1],l={...e[n]};Math.abs(l.x-i.x)>=Math.abs(l.y-i.y)?l.y=i.y:l.x=i.x,t.push(l)}return t},en=()=>b.current.wallPaths.find(e=>e.isBoundary)||null,ei=(e,t=!0)=>{let n=b.current,i=18/n.zoomLevel,l=e;n.wallPaths.forEach(n=>{if(!t&&n.isBoundary)return;let r=n.isBoundary?n.points.length:n.points.length-1;for(let t=0;t<r;t++){let r=n.points[t],a=n.points[(t+1)%n.points.length],s=X(e,r,a);s<i&&(i=s,l=Y(e,r,a).point)}});let r=er()?.polygon;if(r&&r.length>=2)for(let t=0;t<r.length;t++){let n=r[t],a=r[(t+1)%r.length],s=X(e,n,a);s<i&&(i=s,l=Y(e,n,a).point)}return l},el=e=>en()?e.map(e=>ei(e,!0)):e,er=()=>{let e=b.current;if(!e.scale)return null;let t=en();if(!t||t.points.length<3)return null;let n=[],i=t.segments,l=t.points.length;for(let t=0;t<l;t++){let l=i[t]?.thicknessCm??v.wallThicknessDefault;n.push(l*e.scale)}let r=((e,t)=>{if(e.length<3)return[];let n=O(e)>0,i=(e,t)=>{let i=t.x-e.x,l=t.y-e.y,r=Math.sqrt(i*i+l*l)||1,a=-l/r,s=i/r;return n?{x:a,y:s}:{x:-a,y:-s}},l=[],r=e.length;for(let n=0;n<r;n++){let a=e[(n-1+r)%r],s=e[n],o=e[(n+1)%r],d=t[(n-1+r)%r],c=t[n],u=i(a,s),x=i(s,o),m={x:a.x+u.x*d,y:a.y+u.y*d},h={x:s.x+u.x*d,y:s.y+u.y*d},p={x:s.x+x.x*c,y:s.y+x.y*c},g={x:o.x+x.x*c,y:o.y+x.y*c},y=(m.x-h.x)*(p.y-g.y)-(m.y-h.y)*(p.x-g.x);if(1e-5>Math.abs(y)){l.push({x:s.x+u.x*d,y:s.y+u.y*d});continue}let f=((m.x*h.y-m.y*h.x)*(p.x-g.x)-(m.x-h.x)*(p.x*g.y-p.y*g.x))/y,w=((m.x*h.y-m.y*h.x)*(p.y-g.y)-(m.y-h.y)*(p.x*g.y-p.y*g.x))/y;l.push({x:f,y:w})}return l})(t.points,n.map(e=>e));if(((e,t=.5)=>{if(e.length<2)return!1;for(let n=0;n<e.length;n++){let i=e[n],l=e[(n+1)%e.length],r=Math.abs(i.x-l.x),a=Math.abs(i.y-l.y);if(r>t&&a>t)return!1}return!0})(t.points)&&(r=et(r)),r.length<3)return null;let a=A(r)/(e.scale*e.scale);return{areaCm2:a,areaM2:a/1e4,areaPing:a/33057.9,polygon:r}},ea=(0,l.useCallback)(()=>{let e=t.current,n=e?.getContext("2d");if(!e||!n)return;let i=b.current,{width:l,height:r}=e;if(n.clearRect(0,0,l,r),n.save(),n.translate(i.panOffset.x,i.panOffset.y),n.scale(i.zoomLevel,i.zoomLevel),o.current){let e=o.current;n.save(),n.globalAlpha=v.imageOpacity,n.drawImage(e,-e.naturalWidth/2,-e.naturalHeight/2),n.restore()}let a=en(),s=er()?.polygon||null;if(a&&a.points.length>=3){n.beginPath(),n.moveTo(a.points[0].x,a.points[0].y);for(let e=1;e<a.points.length;e++)n.lineTo(a.points[e].x,a.points[e].y);n.closePath(),n.fillStyle=$(v.boundaryFillColor,v.boundaryFillOpacity),n.fill()}if(i.wallPaths.forEach(e=>{if(!(e.points.length<2))for(let t=0;t<e.points.length;t++){let l=e.points[t],r=e.points[(t+1)%e.points.length];if(!e.isBoundary&&t===e.points.length-1)break;let a=e.segments[t%e.segments.length],s=S?.kind==="wall"&&S.pathId===e.id&&S.segmentIndex===t,o=e.isBoundary?"#a855f7":y[a.wallType],d=i.scale?(a.thicknessCm||v.wallThicknessDefault)*i.scale:6,c=Math.max(2,d/12)/i.zoomLevel*(e.isBoundary?v.boundaryLineScale:v.wallLineScale);if(e.isBoundary)n.beginPath(),n.moveTo(l.x,l.y),n.lineTo(r.x,r.y),"window"===a.wallType?n.setLineDash([8/i.zoomLevel,6/i.zoomLevel]):n.setLineDash([]),n.strokeStyle=s?"#facc15":o,n.lineWidth=s?1.6*c:c,n.stroke(),n.setLineDash([]);else{let t=r.x-l.x,i=r.y-l.y,a=Math.sqrt(t*t+i*i)||1,u={x:-i/a,y:t/a},x=(e.offsetSide??1)*d,m=u.x*x,h=u.y*x;n.beginPath(),n.moveTo(l.x,l.y),n.lineTo(r.x,r.y),n.lineTo(r.x+m,r.y+h),n.lineTo(l.x+m,l.y+h),n.closePath(),n.fillStyle="rgba(96,165,250,0.2)",n.fill(),n.strokeStyle=s?"#facc15":o,n.lineWidth=s?1.4*c:c,n.stroke()}}}),i.windows.forEach(e=>{let t=ef(e);if(!t)return;let l=S?.kind==="window"&&S.id===e.id,r=Math.atan2(t.uy,t.ux);n.save(),n.translate(t.center.x,t.center.y),n.rotate(r),n.fillStyle="rgba(56,189,248,0.2)",n.strokeStyle=l?"#facc15":"#38bdf8",n.lineWidth=2/i.zoomLevel,n.fillRect(-t.widthPx/2,-t.thicknessPx/2,t.widthPx,t.thicknessPx),n.strokeRect(-t.widthPx/2,-t.thicknessPx/2,t.widthPx,t.thicknessPx),"sliding"===e.type?(n.beginPath(),n.moveTo(-t.widthPx/2,0),n.lineTo(t.widthPx/2,0),n.moveTo(-t.widthPx/2,-(.25*t.thicknessPx)),n.lineTo(0,-(.25*t.thicknessPx)),n.moveTo(0,.25*t.thicknessPx),n.lineTo(t.widthPx/2,.25*t.thicknessPx)):(n.beginPath(),n.moveTo(-t.widthPx/2,0),n.lineTo(t.widthPx/2,0),n.stroke(),n.beginPath(),n.arc(-t.widthPx/2,0,Math.min(.35*t.widthPx,24/i.zoomLevel),-Math.PI/2,Math.PI/2)),n.stroke(),n.fillStyle=l?"#facc15":"#38bdf8",n.beginPath(),n.arc(-t.widthPx/2,0,3/i.zoomLevel,0,2*Math.PI),n.arc(t.widthPx/2,0,3/i.zoomLevel,0,2*Math.PI),n.fill(),n.restore()}),s&&s.length>=3){n.beginPath(),n.moveTo(s[0].x,s[0].y);for(let e=1;e<s.length;e++)n.lineTo(s[e].x,s[e].y);n.closePath(),n.strokeStyle="#a78bfa",n.lineWidth=1.6*v.innerLineScale/i.zoomLevel,n.setLineDash([6/i.zoomLevel,6/i.zoomLevel]),n.stroke(),n.setLineDash([])}if("placeWindow"===v.mode&&s&&s.length>=2&&i.pointerWorld){let e=K(s,i.pointerWorld,12/i.zoomLevel);e&&(n.beginPath(),n.moveTo(e.a.x,e.a.y),n.lineTo(e.b.x,e.b.y),n.strokeStyle="rgba(56,189,248,0.9)",n.lineWidth=3/i.zoomLevel,n.setLineDash([8/i.zoomLevel,4/i.zoomLevel]),n.stroke(),n.setLineDash([]))}if(("drawWall"===v.mode||i.draggingWallPathId)&&s&&s.length>=2&&i.pointerWorld){let e=K(s,i.pointerWorld,12/i.zoomLevel);e&&(n.beginPath(),n.moveTo(e.a.x,e.a.y),n.lineTo(e.b.x,e.b.y),n.strokeStyle="rgba(56,189,248,0.9)",n.lineWidth=3/i.zoomLevel,n.setLineDash([]),n.stroke())}if(i.rooms.forEach(e=>{if(e.points.length<3)return;let t=S?.kind==="room"&&S.id===e.id;n.beginPath(),n.moveTo(e.points[0].x,e.points[0].y);for(let t=1;t<e.points.length;t++)n.lineTo(e.points[t].x,e.points[t].y);if(n.closePath(),n.fillStyle=$(e.fillColor,e.fillOpacity),n.fill(),n.strokeStyle=t?"#facc15":"#34d399",n.lineWidth=(t?3:2)/i.zoomLevel,n.stroke(),i.scale){let t=A(e.points)/(i.scale*i.scale),l=B(e.points);J(n,`${e.name} ${(t/33057.9).toFixed(2)} 坪`,l,"#fbbf24",i.zoomLevel)}}),i.columns.forEach(e=>{if(e.points.length<3)return;let t=S?.kind==="column"&&S.id===e.id;n.beginPath(),n.moveTo(e.points[0].x,e.points[0].y);for(let t=1;t<e.points.length;t++)n.lineTo(e.points[t].x,e.points[t].y);if(n.closePath(),n.fillStyle="rgba(148,163,184,0.35)",n.fill(),n.strokeStyle=t?"#facc15":"#94a3b8",n.lineWidth=(t?2.5:1.5)/i.zoomLevel,n.stroke(),t){let t=H(e.points);n.strokeStyle="rgba(250,204,21,0.8)",n.lineWidth=1.2/i.zoomLevel,n.strokeRect(t.minX,t.minY,t.maxX-t.minX,t.maxY-t.minY);let l=5/i.zoomLevel,r=[{x:t.minX,y:t.minY},{x:t.maxX,y:t.minY},{x:t.maxX,y:t.maxY},{x:t.minX,y:t.maxY}];n.fillStyle="#facc15",r.forEach(e=>{n.fillRect(e.x-l,e.y-l,2*l,2*l)})}}),i.measureLines.forEach(e=>{let t=I(e,i.zoomLevel);n.strokeStyle=e.color,n.lineWidth=2/i.zoomLevel;let l={x:(t.dimStart.x+t.dimEnd.x)/2,y:(t.dimStart.y+t.dimEnd.y)/2},r=!a||U(l,a.points);if(r&&(n.beginPath(),n.moveTo(t.extStart.x,t.extStart.y),n.lineTo(t.extStartTo.x,t.extStartTo.y),n.moveTo(t.extEnd.x,t.extEnd.y),n.lineTo(t.extEndTo.x,t.extEndTo.y),n.stroke()),n.beginPath(),n.moveTo(t.dimStart.x,t.dimStart.y),n.lineTo(t.dimEnd.x,t.dimEnd.y),n.stroke(),!r){let l=8/i.zoomLevel;n.beginPath(),"h"===e.orientation?(n.moveTo(t.dimStart.x,t.dimStart.y-l),n.lineTo(t.dimStart.x,t.dimStart.y+l),n.moveTo(t.dimEnd.x,t.dimEnd.y-l),n.lineTo(t.dimEnd.x,t.dimEnd.y+l)):(n.moveTo(t.dimStart.x-l,t.dimStart.y),n.lineTo(t.dimStart.x+l,t.dimStart.y),n.moveTo(t.dimEnd.x-l,t.dimEnd.y),n.lineTo(t.dimEnd.x+l,t.dimEnd.y)),n.stroke()}if(i.scale){let t=T(e.pixelStart,e.pixelEnd)/i.scale;J(n,`${t.toFixed(1)} cm`,l,"#f87171",i.zoomLevel)}else{let t=T(e.pixelStart,e.pixelEnd);J(n,`${t.toFixed(0)} px`,l,"#f87171",i.zoomLevel)}}),i.furniture.forEach(e=>{let t=S?.kind==="furniture"&&S.id===e.id;((e,t,n,i)=>{let l=Z(t.type),r=l.size.w*t.scale,a=l.size.h*t.scale;e.save(),e.translate(t.position.x,t.position.y),e.rotate(t.rotation),e.lineWidth=2/i,e.strokeStyle=n?"#facc15":"#e5e7eb";let s=(t,n,i,l)=>e.strokeRect(t,n,i,l),o=(t,n,i)=>{e.beginPath(),e.arc(t,n,i,0,2*Math.PI),e.stroke()};switch(t.type){case"bed":s(-r/2,-a/2,r,a),s(-r/2,-a/2,r,.25*a),s(-r/2+.08*r,-a/2+.06*a,.28*r,.14*a),s(r/2-.36*r,-a/2+.06*a,.28*r,.14*a),e.beginPath(),e.moveTo(-r/2,-(.05*a)),e.lineTo(r/2,-(.05*a)),e.stroke();break;case"sofa":s(-r/2,-a/2,r,a),s(-r/2,-a/2,r,.25*a),s(-r/2,-a/2,.15*r,a),s(r/2-.15*r,-a/2,.15*r,a),s(-r/2+.2*r,-a/2+.35*a,.6*r,.45*a);break;case"wardrobe":s(-r/2,-a/2,r,a),e.beginPath(),e.moveTo(0,-a/2),e.lineTo(0,a/2),e.stroke(),o(-(.15*r),0,Math.max(2,.03*r)),o(.15*r,0,Math.max(2,.03*r));break;case"cabinet":s(-r/2,-a/2,r,a),e.beginPath(),e.moveTo(-r/2,-a/6),e.lineTo(r/2,-a/6),e.moveTo(-r/2,a/6),e.lineTo(r/2,a/6),e.stroke();break;case"diningTable":{s(-r/2,-a/2,r,a);let e=.18*r,t=.28*a;s(-r/2-.9*e,-t/2,e,t),s(r/2-.1*e,-t/2,e,t),s(-e/2,-a/2-.9*t,e,t),s(-e/2,a/2-.1*t,e,t);break}case"desk":s(-r/2,-a/2,r,a),e.beginPath(),e.moveTo(-r/2,-a/6),e.lineTo(r/2,-a/6),e.stroke(),s(r/2-.22*r,-a/2,.2*r,.45*a),e.beginPath(),e.moveTo(r/2-.22*r,-a/2+.22*a),e.lineTo(r/2-.02*r,-a/2+.22*a),e.stroke();break;case"chair":s(-r/2,-a/6,r,a/2),s(-r/2,-a/2,r,a/3);break;case"sink":s(-r/2,-a/2,r,a),o(0,0,.25*Math.min(r,a));break;case"toilet":s(-r/2,-a/2,r,.35*a),e.beginPath(),e.ellipse(0,.1*a,.4*r,.35*a,0,0,2*Math.PI),e.stroke(),e.beginPath(),e.ellipse(0,.1*a,.2*r,.18*a,0,0,2*Math.PI),e.stroke();break;case"kitchen":s(-r/2,-a/2,r,a),o(-(.2*r),0,.18*Math.min(r,a)),o(.2*r,0,.18*Math.min(r,a)),s(-r/2+.05*r,-a/2+.05*a,.35*r,.4*a);break;case"fridge":s(-r/2,-a/2,r,a),e.beginPath(),e.moveTo(-r/2,-a/2+.45*a),e.lineTo(r/2,-a/2+.45*a),e.stroke(),e.beginPath(),e.moveTo(r/2-.15*r,-a/2+.1*a),e.lineTo(r/2-.15*r,-a/2+.4*a),e.moveTo(r/2-.15*r,-a/2+.55*a),e.lineTo(r/2-.15*r,-a/2+.85*a),e.stroke();break;default:s(-r/2,-a/2,r,a)}e.restore()})(n,e,t,i.zoomLevel)}),i.drawing){if("setScale"===v.mode||"measureLine"===v.mode)n.beginPath(),n.moveTo(i.startPoint.x,i.startPoint.y),n.lineTo(i.endPoint.x,i.endPoint.y),n.strokeStyle="#ef4444",n.lineWidth=2/i.zoomLevel,n.stroke();else if(("drawBoundary"===v.mode||"drawRoom"===v.mode||"drawWall"===v.mode||"drawColumn"===v.mode)&&i.drawingPoints.length>0){n.beginPath(),n.moveTo(i.drawingPoints[0].x,i.drawingPoints[0].y);for(let e=1;e<i.drawingPoints.length;e++)n.lineTo(i.drawingPoints[e].x,i.drawingPoints[e].y);n.lineTo(i.endPoint.x,i.endPoint.y),n.strokeStyle="#38bdf8",n.lineWidth=2/i.zoomLevel,n.stroke()}else if("drawColumnRect"===v.mode){let e=Math.min(i.startPoint.x,i.endPoint.x),t=Math.max(i.startPoint.x,i.endPoint.x),l=Math.min(i.startPoint.y,i.endPoint.y),r=Math.max(i.startPoint.y,i.endPoint.y);n.strokeStyle="#94a3b8",n.lineWidth=2/i.zoomLevel,n.strokeRect(e,l,t-e,r-l)}}if(i.snappedPoint){let e=6/i.zoomLevel,t=i.snappedPoint;"boundary"===i.snappedType?(n.strokeStyle="#38bdf8",n.lineWidth=2/i.zoomLevel,n.strokeRect(t.x-e,t.y-e,2*e,2*e)):("inner"===i.snappedType?(n.strokeStyle="#a78bfa",n.lineWidth=2/i.zoomLevel,n.beginPath(),n.moveTo(t.x,t.y-1.3*e),n.lineTo(t.x+1.3*e,t.y),n.lineTo(t.x,t.y+1.3*e),n.lineTo(t.x-1.3*e,t.y),n.closePath()):"wall"===i.snappedType?(n.strokeStyle="#60a5fa",n.lineWidth=2/i.zoomLevel,n.beginPath(),n.moveTo(t.x,t.y-1.3*e),n.lineTo(t.x+1.3*e,t.y+1.3*e),n.lineTo(t.x-1.3*e,t.y+1.3*e),n.closePath()):(n.beginPath(),n.arc(t.x,t.y,1.1*e,0,2*Math.PI),n.strokeStyle="#facc15",n.lineWidth=2/i.zoomLevel),n.stroke())}n.restore()},[S,v]);(0,l.useEffect)(()=>{b.current.isOrthoMode=v.isOrtho,ea()},[v.isOrtho,ea]),(0,l.useEffect)(()=>{W()},[W]),(0,l.useEffect)(()=>{let e=en(),t=P.current;e&&(e.segments.forEach(e=>{e.thicknessCm&&e.thicknessCm!==t||(e.thicknessCm=v.wallThicknessDefault)}),ea()),P.current=v.wallThicknessDefault},[v.wallThicknessDefault,ea]),(0,l.useEffect)(()=>{ea()},[v.imageOpacity,v.fillColor,v.fillOpacity,v.boundaryFillColor,v.boundaryFillOpacity,v.boundaryLineScale,v.innerLineScale,v.wallLineScale,v.mode,v.wallThicknessDefault,S,ea]);let es=e=>{b.current.selected=e,z(e)},eo=(0,l.useCallback)(()=>{let e=b.current;if(e.drawingPoints.length>=3){let t=e.isOrthoMode||e.usedOrthoDuringDraw?et(ee(e.drawingPoints)):[...e.drawingPoints];if(t.length>2){let n=t[0],i=t[t.length-1],l=8/e.zoomLevel;T(n,i)<l&&t.pop()}let n={id:w(),points:t,segments:Array.from({length:t.length},()=>({wallType:"wall",thicknessCm:v.wallThicknessDefault})),isBoundary:!0};e.wallPaths=e.wallPaths.filter(e=>!e.isBoundary),e.wallPaths.push(n),e.windows=[],k(e=>({...e,infoText:`外框建立完成。`,mode:"select"})),W()}e.drawingPoints=[],e.drawing=!1,ea()},[ea,v.wallThicknessDefault,W]),ed=(0,l.useCallback)(()=>{let e=b.current;if(e.drawingPoints.length>=2){let t=prompt("請輸入內牆厚度 (cm)","10"),n=t?parseFloat(t):v.wallThicknessDefault,i=Number.isFinite(n)&&n>0?n:v.wallThicknessDefault,l=e.isOrthoMode||e.usedOrthoDuringDraw?et(e.drawingPoints):[...e.drawingPoints],r=en(),a=1;if(r&&l.length>=2){let e=l[0],t=l[1],n=t.x-e.x,i=t.y-e.y,s=Math.sqrt(n*n+i*i)||1,o={x:-i/s,y:n/s},d={x:(e.x+t.x)/2,y:(e.y+t.y)/2};a=U({x:d.x+6*o.x,y:d.y+6*o.y},r.points)?1:-1}let s={id:w(),points:l,segments:Array.from({length:l.length-1},()=>({wallType:"wall",thicknessCm:i})),offsetSide:a};e.wallPaths.push(s),k(e=>({...e,infoText:`內牆已新增。`,mode:"select"})),W()}e.drawingPoints=[],e.drawing=!1,ea()},[ea,v.wallThicknessDefault,W]),ec=(0,l.useCallback)(()=>{let e=b.current;if(e.drawingPoints.length>=3){let t,n=e.isOrthoMode||e.usedOrthoDuringDraw?et(ee(e.drawingPoints)):[...e.drawingPoints],i={id:w(),name:(t=e.rooms.length+1,`空間${(e=>{if(!Number.isFinite(e)||e<=0)return`${e}`;let t=["零","一","二","三","四","五","六","七","八","九"];if(e<10)return t[e];if(10===e)return"十";if(e<20)return`十${t[e%10]}`;if(e<100){let n=Math.floor(e/10),i=e%10;return 0===i?`${t[n]}十`:`${t[n]}十${t[i]}`}return`${e}`})(t)}`),points:n,fillColor:v.fillColor,fillOpacity:v.fillOpacity};e.rooms.push(i),k(e=>({...e,infoText:`空間已新增。`,mode:"select"})),W()}e.drawingPoints=[],e.drawing=!1,ea()},[ea,v.fillColor,v.fillOpacity,W]),eu=(0,l.useCallback)(()=>{let e=b.current;if(e.drawingPoints.length>=3){let t=el(e.isOrthoMode||e.usedOrthoDuringDraw?et(ee(e.drawingPoints)):[...e.drawingPoints]),n={id:w(),points:t};e.columns.push(n),k(e=>({...e,infoText:`柱子已新增。`,mode:"select"})),W()}e.drawingPoints=[],e.drawing=!1,ea()},[ea,W]),ex=(0,l.useCallback)(()=>{let e,t,n,i,l=b.current,r=l.startPoint,a=l.endPoint,s=Math.abs(a.x-r.x),o=Math.abs(a.y-r.y);if(s<1||o<1){let a=l.scale?20*l.scale:40;s=a,o=a,e=r.x-s/2,t=r.x+s/2,n=r.y-o/2,i=r.y+o/2}else e=Math.min(r.x,a.x),t=Math.max(r.x,a.x),n=Math.min(r.y,a.y),i=Math.max(r.y,a.y);let d=el([{x:e,y:n},{x:t,y:n},{x:t,y:i},{x:e,y:i}]);l.columns.push({id:w(),points:d}),k(e=>({...e,infoText:`矩形柱子已新增。`,mode:"select"})),W(),l.drawing=!1,ea()},[ea,W]),em=(0,l.useCallback)(()=>{let e=b.current;if(S){if("furniture"===S.kind)e.furniture=e.furniture.filter(e=>e.id!==S.id);else if("window"===S.kind)e.windows=e.windows.filter(e=>e.id!==S.id);else if("room"===S.kind)e.rooms=e.rooms.filter(e=>e.id!==S.id);else if("column"===S.kind)e.columns=e.columns.filter(e=>e.id!==S.id);else if("wall"===S.kind){let t=e.wallPaths.find(e=>e.id===S.pathId);t?.isBoundary?(e.wallPaths=e.wallPaths.filter(e=>e.id!==t.id),e.windows=[]):e.wallPaths=e.wallPaths.filter(e=>e.id!==S.pathId)}else"measure"===S.kind&&(e.measureLines=e.measureLines.filter(e=>e.id!==S.id));es(null),W(),ea()}},[S,ea,W]),eh=(0,l.useCallback)((e,t)=>{if(!S||"wall"!==S.kind)return;let n=b.current.wallPaths.find(e=>e.id===S.pathId);if(!n||!n.isBoundary)return;let i=n.points,l=i.length,r=S.segmentIndex%l,a=e=>.5>Math.abs(i[e].y-i[(e+1)%l].y),s=e=>.5>Math.abs(i[e].x-i[(e+1)%l].x),o=s(r),d=(e,t,n)=>{e>t?n.min=Math.max(n.min,t):e<t&&(n.max=Math.min(n.max,t))},c=(e,t,n,r)=>{let a=n,s=0;for(;s<l&&(i[a][e]=t,a!==r);)a=(a+1)%l,s++};if(o&&("left"===e||"right"===e)){let n=r,a=0;for(;a<l&&s((n-1+l)%l);)n=(n-1+l)%l,a++;let o=r;for(a=0;a<l&&s((o+1)%l);)o=(o+1)%l,a++;let u=n,x=(o+1)%l,m=i[u].x,h=i[(u-1+l)%l],p=i[(x+1)%l],g=m+("left"===e?-t:t),y={min:-1/0,max:1/0};d(m,h.x,y),d(m,p.x,y),g<y.min&&(g=y.min),g>y.max&&(g=y.max);let f=g-m;if(!Number.isFinite(f)||1e-4>Math.abs(f))return;c("x",g,u,x)}else{if(o||"up"!==e&&"down"!==e)return;let n=r,s=0;for(;s<l&&a((n-1+l)%l);)n=(n-1+l)%l,s++;let u=r;for(s=0;s<l&&a((u+1)%l);)u=(u+1)%l,s++;let x=n,m=(u+1)%l,h=i[x].y,p=i[(x-1+l)%l],g=i[(m+1)%l],y=h+("up"===e?-t:t),f={min:-1/0,max:1/0};d(h,p.y,f),d(h,g.y,f),y<f.min&&(y=f.min),y>f.max&&(y=f.max);let w=y-h;if(!Number.isFinite(w)||1e-4>Math.abs(w))return;c("y",y,x,m)}ea()},[S,ea]),ep=(0,l.useCallback)((e,t)=>{if(!S||"wall"!==S.kind)return;let n=b.current.wallPaths.find(e=>e.id===S.pathId);if(!n||n.isBoundary)return;let i="left"===e?-t:"right"===e?t:0,l="up"===e?-t:"down"===e?t:0;n.points=n.points.map(e=>({x:e.x+i,y:e.y+l})),ea()},[S,ea]);(0,l.useEffect)(()=>{let e=e=>{if(!(document.activeElement?.tagName==="INPUT"||document.activeElement?.tagName==="TEXTAREA"||document.activeElement?.isContentEditable)){if("Shift"===e.key&&(b.current.isShiftPressed=!0),("Control"===e.key||"Meta"===e.key)&&(b.current.isCtrlPressed=!0),"Alt"===e.key&&(b.current.isAltPressed=!0),"Space"===e.code&&(b.current.isSpacePressed=!0),(e.ctrlKey||e.metaKey)&&"z"===e.key.toLowerCase()){F(),e.preventDefault();return}if((e.ctrlKey||e.metaKey)&&"c"===e.key.toLowerCase()){R(),e.preventDefault();return}if((e.ctrlKey||e.metaKey)&&"v"===e.key.toLowerCase()){D(),e.preventDefault();return}if("Escape"===e.key){let e=b.current;(e.drawing||e.drawingPoints.length>0)&&(e.drawingPoints=[],e.drawing=!1),k(e=>({...e,mode:"select",infoText:"已進入選取模式"})),ea();return}if("Delete"===e.key||"Backspace"===e.key){em(),e.preventDefault();return}if("Enter"===e.code&&("drawBoundary"===v.mode&&eo(),"drawWall"===v.mode&&ed(),"drawRoom"===v.mode&&ec(),"drawColumn"===v.mode&&eu(),"drawColumnRect"===v.mode&&ex()),e.key.startsWith("Arrow")){let t=(e.shiftKey?3:.5)/b.current.zoomLevel,n=b.current,i=S&&"wall"===S.kind?n.wallPaths.find(e=>e.id===S.pathId):null;i?.isBoundary?("ArrowLeft"===e.key&&eh("left",t),"ArrowRight"===e.key&&eh("right",t),"ArrowUp"===e.key&&eh("up",t),"ArrowDown"===e.key&&eh("down",t)):i&&("ArrowLeft"===e.key&&ep("left",t),"ArrowRight"===e.key&&ep("right",t),"ArrowUp"===e.key&&ep("up",t),"ArrowDown"===e.key&&ep("down",t)),e.preventDefault()}}},t=e=>{"Shift"===e.key&&(b.current.isShiftPressed=!1),("Control"===e.key||"Meta"===e.key)&&(b.current.isCtrlPressed=!1),"Alt"===e.key&&(b.current.isAltPressed=!1),"Space"===e.code&&(b.current.isSpacePressed=!1)};return window.addEventListener("keydown",e),window.addEventListener("keyup",t),()=>{window.removeEventListener("keydown",e),window.removeEventListener("keyup",t)}},[eo,ed,ec,eu,ex,v.mode,ea,em,eh,ep,F,R,D]);let eg=e=>{let t=b.current,n="measureLine"===v.mode||"setScale"===v.mode,i=t.isCtrlPressed,l=t.isAltPressed;if(!i&&!l){t.snappedPoint=null,t.snappedType=null;return}let r=(n?26:20)/t.zoomLevel,a=null,s=null,o=t=>{let n=T(e,t);n<r&&(r=n,a=t,s="vertex")};if(i){let n,i,l=en();if(l)for(let t=0;t<l.points.length;t++){let n=l.points[t],i=l.points[(t+1)%l.points.length],o=X(e,n,i);o<r&&(r=o,a=Y(e,n,i).point,s="boundary")}let o=er()?.polygon;if(o&&o.length>=2)for(let t=0;t<o.length;t++){let n=o[t],i=o[(t+1)%o.length],l=X(e,n,i);l<r&&(r=l,a=Y(e,n,i).point,s="inner")}t.wallPaths.forEach(t=>{let n=t.isBoundary?t.points.length:t.points.length-1;for(let i=0;i<n;i++){let n=t.points[i],l=t.points[(i+1)%t.points.length];if(!t.isBoundary&&i===t.points.length-1)continue;let o=X(e,n,l);o<r&&(r=o,a=Y(e,n,l).point,s=t.isBoundary?"boundary":"wall")}}),(n=b.current,i=[],n.wallPaths.forEach(e=>{if(e.isBoundary)return;let t=Math.max(0,e.points.length-1);for(let l=0;l<t;l++){let t=e.points[l],r=e.points[l+1],a=r.x-t.x,s=r.y-t.y,o=Math.sqrt(a*a+s*s)||1,d={x:-s/o,y:a/o},c=n.scale?(e.segments[l]?.thicknessCm??v.wallThicknessDefault)*n.scale:12,u=(e.offsetSide??1)*c,x=d.x*u,m=d.y*u,h={x:t.x+x,y:t.y+m},p={x:r.x+x,y:r.y+m};i.push({a:h,b:p}),i.push({a:t,b:h}),i.push({a:r,b:p})}}),i).forEach(t=>{let n=X(e,t.a,t.b);n<r&&(r=n,a=Y(e,t.a,t.b).point,s="wall")}),t.rooms.forEach(t=>{for(let n=0;n<t.points.length;n++){let i=t.points[n],l=t.points[(n+1)%t.points.length],o=X(e,i,l);o<r&&(r=o,a=Y(e,i,l).point,s="wall")}})}if(l){t.wallPaths.forEach(e=>e.points.forEach(e=>o(e))),t.rooms.forEach(e=>e.points.forEach(e=>o(e))),t.columns.forEach(e=>e.points.forEach(e=>o(e))),t.drawingPoints.forEach(e=>o(e));let e=er()?.polygon;e&&e.forEach(e=>o(e)),q().forEach(e=>o(e)),t.measureLines.forEach(e=>{o(e.pixelStart),o(e.pixelEnd)})}t.snappedPoint=a,t.snappedType=a?s:null},ey=e=>{let t=b.current,n=10/t.zoomLevel,i=null,l=n;return t.wallPaths.forEach(t=>{let n=t.isBoundary?t.points.length:t.points.length-1;for(let r=0;r<n;r++){let n=t.points[r],a=t.points[(r+1)%t.points.length],s=X(e,n,a);if(s<l){l=s;let o=Y(e,n,a);i={pathId:t.id,segmentIndex:r,point:o.point}}}}),i},ef=e=>{let t=b.current,n=en();if(!n||n.points.length<2)return null;let i=n.points;if(e.segmentIndex>=i.length)return null;let l=i[e.segmentIndex],r=i[(e.segmentIndex+1)%i.length],a=r.x-l.x,s=r.y-l.y,o=Math.sqrt(a*a+s*s)||1,d=a/o,c=s/o,u={x:-c,y:d},x={x:l.x+a*e.t,y:l.y+s*e.t},m=U({x:x.x+2*u.x,y:x.y+2*u.y},n.points)?u:{x:-u.x,y:-u.y},h=t.scale?(n.segments[e.segmentIndex]?.thicknessCm??v.wallThicknessDefault)*t.scale:12,p=t.scale?e.widthCm*t.scale:e.widthCm,g={x:x.x+m.x*(h/2),y:x.y+m.y*(h/2)},y={x:x.x-p/2*d,y:x.y-p/2*c},f={x:x.x+p/2*d,y:x.y+p/2*c};return{center:g,ux:d,uy:c,inward:m,widthPx:p,thicknessPx:h,start:y,end:f,segmentLength:o}},ew=e=>{let t=en();if(!t||t.points.length<2)return;let n=t.points;if(e.segmentIndex>=n.length)return;let i=T(n[e.segmentIndex],n[(e.segmentIndex+1)%n.length])||1,l=b.current.scale??1,r=Math.max(30,i/l*.95);e.widthCm>r&&(e.widthCm=r),e.widthCm<30&&(e.widthCm=30);let a=e.widthCm*l/(2*i);a>=.5?e.t=.5:e.t=Math.min(1-a,Math.max(a,e.t))},eb=e=>{let t=b.current,n=6/t.zoomLevel;for(let i of t.windows){let t=ef(i);if(!t)continue;let l=e.x-t.center.x,r=e.y-t.center.y,a=l*t.ux+r*t.uy,s=l*t.inward.x+r*t.inward.y;if(Math.abs(a)<=t.widthPx/2+n&&Math.abs(s)<=t.thicknessPx/2+n)return i}return null},ev=e=>{let t=b.current,n=4/t.zoomLevel;for(let i of t.windows){let t=ef(i);if(!t)continue;let l=e.x-t.center.x,r=e.y-t.center.y,a=l*t.ux+r*t.uy;if(!(Math.abs(l*t.inward.x+r*t.inward.y)>t.thicknessPx/2+n)){if(Math.abs(a+t.widthPx/2)<=n)return{window:i,handle:"start"};if(Math.abs(a-t.widthPx/2)<=n)return{window:i,handle:"end"}}}return null},ek=e=>{for(let t of b.current.rooms)if(U(e,t.points))return t;return null},eP=e=>{for(let t of b.current.columns)if(U(e,t.points))return t;return null},eS=e=>{for(let t of b.current.furniture){let n=G(t);if(e.x>=n.minX&&e.x<=n.maxX&&e.y>=n.minY&&e.y<=n.maxY)return t}return null},ez=e=>{let t=b.current,n=6/t.zoomLevel;for(let i of t.measureLines){let l=I(i,t.zoomLevel);if(Math.min(X(e,l.dimStart,l.dimEnd),X(e,l.extStart,l.extStartTo),X(e,l.extEnd,l.extEndTo))<=n)return i}return null};(0,l.useEffect)(()=>{let e=()=>{if(n.current&&t.current){t.current.width=n.current.clientWidth,t.current.height=n.current.clientHeight;let e=document;if((e.fullscreenElement||e.webkitFullscreenElement)&&o.current){let e=o.current,n=t.current.width/e.naturalWidth,i=t.current.height/e.naturalHeight;b.current.zoomLevel=.9*Math.min(n,i),b.current.panOffset={x:(t.current.width||0)/2,y:(t.current.height||0)/2},k(e=>({...e,zoomDisplay:Math.round(100*b.current.zoomLevel)}))}ea()}},i=()=>e(),l=new ResizeObserver(()=>e());n.current&&l.observe(n.current),window.addEventListener("resize",e),document.addEventListener("fullscreenchange",i),document.addEventListener("webkitfullscreenchange",i),e();let r=e=>{"Space"===e.code&&(b.current.isSpacePressed=!0)},a=e=>{"Space"===e.code&&(b.current.isSpacePressed=!1)};return window.addEventListener("keydown",r),window.addEventListener("keyup",a),()=>{l.disconnect(),window.removeEventListener("resize",e),document.removeEventListener("fullscreenchange",i),document.removeEventListener("webkitfullscreenchange",i),window.removeEventListener("keydown",r),window.removeEventListener("keyup",a)}},[ea]);let ej=(()=>{if(!S||"wall"!==S.kind)return null;let e=b.current.wallPaths.find(e=>e.id===S.pathId);if(!e)return null;let t=e.segments[S.segmentIndex];return{path:e,segment:t,segmentIndex:S.segmentIndex}})(),eM=S&&"furniture"===S.kind&&b.current.furniture.find(e=>e.id===S.id)||null,eC=S&&"window"===S.kind&&b.current.windows.find(e=>e.id===S.id)||null,eN=S&&"column"===S.kind&&b.current.columns.find(e=>e.id===S.id)||null,eT=er(),eL=en(),eI=b.current.scale,eE=!!eI,eW=eL&&eE?A(eL.points)/(eI*eI):null,eF=b.current.rooms.map(e=>{let t=eE?A(e.points)/(eI*eI):null;return{room:e,areaCm2:t}}),eR=(()=>{let e=b.current;if(null===e.scale)return null;let t=e.scale,n=0;return e.columns.forEach(e=>{if(e.points.length<3)return;let i=A(e.points);n+=i/(t*t)}),n})(),eD=(e=>{let t=b.current;if(!e||e.length<3||null===t.scale)return null;let n=t.scale,i=0,l=(e=>{let t=[];if(e.length<3)return t;let n=e.map((e,t)=>t),i=O(e)>0,l=(e,t,n)=>{let l=(t.x-e.x)*(n.y-e.y)-(t.y-e.y)*(n.x-e.x);return i?l>0:l<0},r=0;for(;n.length>2&&r<1e4;){r++;let i=!1;for(let r=0;r<n.length;r++){let a=n[(r-1+n.length)%n.length],s=n[r],o=n[(r+1)%n.length],d=e[a],c=e[s],u=e[o];if(!l(d,c,u))continue;let x=!1;for(let t=0;t<n.length;t++){let i=n[t];if(i!==a&&i!==s&&i!==o&&V(e[i],d,c,u)){x=!0;break}}if(!x){t.push([d,c,u]),n.splice(r,1),i=!0;break}}if(!i)break}return t})(e),r=l.length>0;return t.columns.forEach(t=>{if(t.points.length<3)return;if(!r){if(!U(B(t.points),e))return;let l=A(t.points);i+=l/(n*n);return}let a=0;l.forEach(e=>{let n=((e,t)=>{if(0===e.length)return[];let n=[...e],i=O(t)>0,l=(e,t,n)=>{let l=(n.x-t.x)*(e.y-t.y)-(n.y-t.y)*(e.x-t.x);return i?l>=-1e-4:l<=1e-4},r=(e,t,n,i)=>{let l=t.y-e.y,r=e.x-t.x,a=l*e.x+r*e.y,s=i.y-n.y,o=n.x-i.x,d=s*n.x+o*n.y,c=l*o-s*r;return 1e-5>Math.abs(c)?t:{x:(o*a-r*d)/c,y:(l*d-s*a)/c}};for(let e=0;e<t.length;e++){let i=t[e],a=t[(e+1)%t.length],s=n;if(n=[],0===s.length)break;let o=s[s.length-1];for(let e of s){let t=l(e,i,a),s=l(o,i,a);t?(s||n.push(r(o,e,i,a)),n.push(e)):s&&n.push(r(o,e,i,a)),o=e}}return n})(t.points,e);n.length>=3&&(a+=A(n))}),i+=a/(n*n)}),i})(eT?.polygon??null),eA=eT&&null!==eD?Math.max(0,eT.areaCm2-eD):eT?.areaCm2??null,eO=(()=>{let e=b.current;if(null===e.scale)return null;let t=e.scale,n=0;return e.wallPaths.forEach(e=>{if(e.isBoundary)return;let i=Math.max(0,e.points.length-1);for(let l=0;l<i;l++){let i=T(e.points[l],e.points[l+1])/t,r=e.segments[l]?.thicknessCm??v.wallThicknessDefault;n+=i*r}}),n})(),eB=eT&&eE?Math.max(0,eT.areaCm2-(eR||0)-(eO||0)):null,e$=e=>null!==e&&eE?`${(e/1e4).toFixed(2)} ㎡ / ${(e/33057.9).toFixed(2)} 坪`:"-",eX=(e,t)=>{k(n=>({...n,mode:e,infoText:t}))},eY=[{id:"upload",label:"Step 1 上傳平面圖",done:v.hasImage,action:"upload"},{id:"scale",label:"Step 2 設定比例尺",done:v.scaleSet,action:()=>eX("setScale","Step 2：請標出已知距離並輸入實際公分")},{id:"boundary",label:"Step 3 繪製外框",done:!!eL&&eL.points.length>=3,action:()=>eX("drawBoundary","Step 3：繪製外框（右鍵或 Enter 結束）")},{id:"rooms",label:"Step 4 繪製空間",done:b.current.rooms.length>0,action:()=>eX("drawRoom","Step 4：繪製各空間範圍")},{id:"walls",label:"Step 5 內牆（可選）",done:b.current.wallPaths.some(e=>!e.isBoundary),action:()=>eX("drawWall","Step 5：繪製內牆，可拖曳移動")},{id:"columns",label:"Step 6 柱子（可選）",done:b.current.columns.length>0,action:()=>eX("drawColumnRect","Step 6：拖拉建立矩形柱子")},{id:"windows",label:"Step 7 窗戶（可選）",done:b.current.windows.length>0,action:()=>eX("placeWindow","Step 7：點外框新增窗戶並可拖曳")},{id:"furniture",label:"Step 8 家具配置（可選）",done:b.current.furniture.length>0,action:()=>eX("placeFurniture","Step 8：拖放家具並可旋轉/縮放"),disabled:C}],eK="drawColumnRect"===v.mode||"drawColumn"===v.mode||!!eN,eH="placeWindow"===v.mode||!!eC,eq=!C&&("placeFurniture"===v.mode||!!eM),e_=eK||eH||eq;return(0,l.useEffect)(()=>{C&&"placeFurniture"===v.mode&&k(e=>({...e,mode:"select",infoText:"家具功能僅限超級管理員"}))},[C,v.mode]),(0,i.jsxs)("div",{className:"flex h-full w-full gap-4",children:[(0,i.jsxs)("div",{className:"relative flex-1 min-w-0",ref:n,children:[(0,i.jsxs)("div",{className:"flex flex-wrap items-center gap-2 p-2 bg-zinc-900/80 backdrop-blur border border-white/5 rounded-xl z-10 w-full lg:absolute lg:top-4 lg:left-4 lg:right-4 shadow-xl",children:[(0,i.jsx)("input",{type:"file",id:"fp-upload",className:"hidden",accept:"image/*",onChange:n=>{let i=n.target.files?.[0];if(!i)return;let l=new FileReader;l.onload=n=>{let i=new Image;i.onload=()=>{o.current=i,b.current.panOffset={x:(t.current?.width||0)/2,y:(t.current?.height||0)/2};let n=t.current;if(n){let e=n.width/i.naturalWidth,t=n.height/i.naturalHeight;b.current.zoomLevel=.9*Math.min(e,t),k(e=>({...e,zoomDisplay:Math.round(100*b.current.zoomLevel)}))}k(e=>({...e,hasImage:!0,infoText:"圖片已載入。請設定比例尺 (Step 1)。"})),e?.(),ea()},i.src=n.target?.result},l.readAsDataURL(i)}}),(0,i.jsx)("label",{htmlFor:"fp-upload",className:"p-2 hover:bg-zinc-800 rounded-lg cursor-pointer text-zinc-400 hover:text-white transition-colors",title:"上傳圖片",children:(0,i.jsx)(r.A,{className:"h-5 w-5"})}),(0,i.jsx)("div",{className:"h-6 w-px bg-white/10 mx-1"}),(0,i.jsxs)("button",{onClick:()=>k(e=>({...e,mode:"setScale"})),className:(0,p.cn)("p-2 rounded-lg transition-colors flex items-center gap-2","setScale"===v.mode?"bg-cyan-600 text-white":"text-zinc-400 hover:bg-zinc-800"),disabled:!v.hasImage,title:"1. 設定比例尺（Ctrl：抓線 / Alt：抓角）",children:[(0,i.jsx)(a.A,{className:"h-5 w-5 rotate-45"}),(0,i.jsx)("span",{className:"text-xs font-bold hidden lg:block",children:"比例尺"})]}),(0,i.jsxs)("button",{onClick:()=>k(e=>({...e,mode:"measureLine"})),className:(0,p.cn)("p-2 rounded-lg transition-colors flex items-center gap-2","measureLine"===v.mode?"bg-cyan-600 text-white":"text-zinc-400 hover:bg-zinc-800"),disabled:!v.scaleSet,title:"測量長度（Ctrl：抓線 / Alt：抓角）",children:[(0,i.jsx)(s.A,{className:"h-5 w-5"}),(0,i.jsx)("span",{className:"text-xs font-bold hidden lg:block",children:"測距"})]}),(0,i.jsxs)("button",{onClick:()=>k(e=>({...e,mode:"drawBoundary"})),className:(0,p.cn)("p-2 rounded-lg transition-colors flex items-center gap-2","drawBoundary"===v.mode?"bg-violet-600 text-white":"text-zinc-400 hover:bg-zinc-800"),title:"外框（牆）",children:[(0,i.jsx)(d,{className:"h-5 w-5"}),(0,i.jsx)("span",{className:"text-xs font-bold hidden lg:block",children:"外框"})]}),(0,i.jsxs)("button",{onClick:()=>k(e=>({...e,mode:"drawRoom"})),className:(0,p.cn)("p-2 rounded-lg transition-colors flex items-center gap-2","drawRoom"===v.mode?"bg-emerald-600 text-white":"text-zinc-400 hover:bg-zinc-800"),title:"空間範圍",children:[(0,i.jsx)(d,{className:"h-5 w-5"}),(0,i.jsx)("span",{className:"text-xs font-bold hidden lg:block",children:"空間"})]}),(0,i.jsxs)("button",{onClick:()=>k(e=>({...e,mode:"drawWall"})),className:(0,p.cn)("p-2 rounded-lg transition-colors flex items-center gap-2","drawWall"===v.mode?"bg-sky-600 text-white":"text-zinc-400 hover:bg-zinc-800"),title:"內牆",children:[(0,i.jsx)(d,{className:"h-5 w-5"}),(0,i.jsx)("span",{className:"text-xs font-bold hidden lg:block",children:"內牆"})]}),(0,i.jsxs)("button",{onClick:()=>k(e=>({...e,mode:"drawColumnRect"})),className:(0,p.cn)("p-2 rounded-lg transition-colors flex items-center gap-2","drawColumn"===v.mode||"drawColumnRect"===v.mode?"bg-slate-500 text-white":"text-zinc-400 hover:bg-zinc-800"),title:"柱子（矩形）",children:[(0,i.jsx)(c,{className:"h-5 w-5"}),(0,i.jsx)("span",{className:"text-xs font-bold hidden lg:block",children:"柱子"})]}),(0,i.jsxs)("button",{onClick:()=>k(e=>({...e,mode:"placeWindow"})),className:(0,p.cn)("p-2 rounded-lg transition-colors flex items-center gap-2","placeWindow"===v.mode?"bg-cyan-600 text-white":"text-zinc-400 hover:bg-zinc-800"),title:"窗戶",children:[(0,i.jsx)(u,{className:"h-5 w-5"}),(0,i.jsx)("span",{className:"text-xs font-bold hidden lg:block",children:"窗戶"})]}),(0,i.jsxs)("button",{onClick:()=>k(e=>({...e,mode:"placeFurniture"})),className:(0,p.cn)("p-2 rounded-lg transition-colors flex items-center gap-2","placeFurniture"===v.mode?"bg-amber-600 text-white":"text-zinc-400 hover:bg-zinc-800",C&&"opacity-40 cursor-not-allowed hover:bg-transparent"),title:C?"僅超級管理員可用":"放置家具",disabled:C,children:[(0,i.jsx)("span",{className:"text-xs font-bold hidden lg:block",children:"家具"}),(0,i.jsx)("span",{className:"text-xs font-bold",children:"+F"})]}),(0,i.jsxs)("button",{onClick:()=>k(e=>({...e,mode:"select"})),className:(0,p.cn)("p-2 rounded-lg transition-colors flex items-center gap-2","select"===v.mode?"bg-slate-600 text-white":"text-zinc-400 hover:bg-zinc-800"),title:"選取/編輯",children:[(0,i.jsx)(a.A,{className:"h-5 w-5"}),(0,i.jsx)("span",{className:"text-xs font-bold hidden lg:block",children:"選取"})]}),(0,i.jsx)("div",{className:"h-6 w-px bg-white/10 mx-1"}),(0,i.jsxs)("button",{onClick:()=>k(e=>({...e,isOrtho:!e.isOrtho})),className:(0,p.cn)("p-2 rounded-lg transition-colors flex items-center gap-2",v.isOrtho?"bg-purple-600 text-white":"text-zinc-400 hover:bg-zinc-800"),title:"垂直/水平鎖定 (Shift)",children:[(0,i.jsx)(a.A,{className:"h-5 w-5"}),(0,i.jsx)("span",{className:"text-xs font-bold hidden lg:block",children:"正交"})]}),(0,i.jsx)("div",{className:"h-6 w-px bg-white/10 mx-1"}),(0,i.jsx)("button",{onClick:()=>{b.current.zoomLevel=Math.min(1.1*b.current.zoomLevel,5),k(e=>({...e,zoomDisplay:Math.round(100*b.current.zoomLevel)})),ea()},className:"p-2 text-zinc-400 hover:bg-zinc-800 rounded-lg transition-colors",title:"放大",children:(0,i.jsx)(x.A,{className:"h-5 w-5"})}),(0,i.jsx)("button",{onClick:()=>{b.current.zoomLevel=Math.max(b.current.zoomLevel/1.1,.2),k(e=>({...e,zoomDisplay:Math.round(100*b.current.zoomLevel)})),ea()},className:"p-2 text-zinc-400 hover:bg-zinc-800 rounded-lg transition-colors",title:"縮小",children:(0,i.jsx)(m.A,{className:"h-5 w-5"})}),(0,i.jsx)("div",{className:"h-6 w-px bg-white/10 mx-1"}),(0,i.jsx)("button",{onClick:()=>{confirm("清除所有繪製？")&&(b.current.measureLines=[],b.current.wallPaths=[],b.current.rooms=[],b.current.columns=[],b.current.windows=[],b.current.furniture=[],b.current.scale=null,es(null),k(e=>({...e,scaleSet:!1,infoText:"已清除，請重新設定比例尺"})),W(),ea())},className:"p-2 text-red-400 hover:bg-red-500/10 rounded-lg transition-colors",title:"全部清除",children:(0,i.jsx)(h.A,{className:"h-5 w-5"})}),(0,i.jsxs)("div",{className:"flex items-center gap-2 pl-2",children:[(0,i.jsx)("span",{className:"text-xs text-zinc-400",children:"圖片透明度"}),(0,i.jsx)("input",{type:"range",min:.1,max:1,step:.05,value:v.imageOpacity,onChange:e=>k(t=>({...t,imageOpacity:parseFloat(e.target.value)})),className:"w-24"})]})]}),e_&&(0,i.jsxs)("div",{className:"absolute top-16 left-4 right-4 z-10 bg-zinc-900/90 border border-white/10 rounded-xl shadow-xl px-3 py-2 flex flex-nowrap items-center gap-6 overflow-x-auto overflow-y-hidden",children:[eK&&(0,i.jsxs)("div",{className:"flex items-center gap-3 shrink-0 text-xs whitespace-nowrap",children:[(0,i.jsx)("span",{className:"text-white font-semibold",children:"柱子"}),(0,i.jsx)("button",{type:"button",onClick:()=>k(e=>({...e,mode:"drawColumnRect"})),className:(0,p.cn)("rounded-lg border px-2 py-1","drawColumnRect"===v.mode?"border-slate-400/40 bg-slate-500/20 text-slate-100":"border-white/10 text-zinc-300 hover:border-white/20"),children:"矩形"}),(0,i.jsx)("button",{type:"button",onClick:()=>k(e=>({...e,mode:"drawColumn"})),className:(0,p.cn)("rounded-lg border px-2 py-1","drawColumn"===v.mode?"border-slate-400/40 bg-slate-500/20 text-slate-100":"border-white/10 text-zinc-300 hover:border-white/20"),children:"手繪"}),eN&&eE&&(0,i.jsxs)(i.Fragment,{children:[(0,i.jsxs)("label",{className:"flex items-center gap-2",children:[(0,i.jsx)("span",{className:"text-zinc-400",children:"寬"}),(0,i.jsx)("input",{type:"number",min:10,value:Number(((Math.max(...eN.points.map(e=>e.x))-Math.min(...eN.points.map(e=>e.x)))/(eI||1)).toFixed(1)),onChange:e=>{let t=parseFloat(e.target.value||"");if(!Number.isFinite(t)||!eI)return;let n=eN.points.map(e=>e.x),i=eN.points.map(e=>e.y),l=Math.min(...i),r=Math.max(...i),a=(Math.min(...n)+Math.max(...n))/2,s=t*eI;eN.points=[{x:a-s/2,y:l},{x:a+s/2,y:l},{x:a+s/2,y:r},{x:a-s/2,y:r}],ea(),z(e=>e?{...e}:e)},className:"w-16 bg-zinc-900 border border-white/10 rounded px-2 py-1 text-white"})]}),(0,i.jsxs)("label",{className:"flex items-center gap-2",children:[(0,i.jsx)("span",{className:"text-zinc-400",children:"高"}),(0,i.jsx)("input",{type:"number",min:10,value:Number(((Math.max(...eN.points.map(e=>e.y))-Math.min(...eN.points.map(e=>e.y)))/(eI||1)).toFixed(1)),onChange:e=>{let t=parseFloat(e.target.value||"");if(!Number.isFinite(t)||!eI)return;let n=eN.points.map(e=>e.x),i=eN.points.map(e=>e.y),l=Math.min(...n),r=Math.max(...n),a=(Math.min(...i)+Math.max(...i))/2,s=t*eI;eN.points=[{x:l,y:a-s/2},{x:r,y:a-s/2},{x:r,y:a+s/2},{x:l,y:a+s/2}],ea(),z(e=>e?{...e}:e)},className:"w-16 bg-zinc-900 border border-white/10 rounded px-2 py-1 text-white"})]}),(0,i.jsx)("button",{type:"button",onClick:()=>{b.current.columns=b.current.columns.filter(e=>e.id!==eN.id),es(null),ea()},className:"rounded-lg border border-red-500/30 text-red-200 hover:bg-red-500/10 px-2 py-1",children:"刪除"})]})]}),eH&&(0,i.jsxs)("div",{className:"flex items-center gap-3 shrink-0 text-xs whitespace-nowrap",children:[(0,i.jsx)("span",{className:"text-white font-semibold",children:"窗戶"}),(0,i.jsxs)("select",{value:v.windowType,onChange:e=>k(t=>({...t,windowType:e.target.value})),className:"bg-zinc-900 border border-white/10 rounded px-2 py-1 text-white",children:[(0,i.jsx)("option",{value:"sliding",children:"橫拉窗"}),(0,i.jsx)("option",{value:"casement",children:"推窗"})]}),(0,i.jsxs)("label",{className:"flex items-center gap-2",children:[(0,i.jsx)("span",{className:"text-zinc-400",children:"預設寬"}),(0,i.jsx)("input",{type:"number",min:30,value:v.windowWidthCm,onChange:e=>k(t=>({...t,windowWidthCm:parseFloat(e.target.value||"0")})),className:"w-16 bg-zinc-900 border border-white/10 rounded px-2 py-1 text-white"})]}),eC&&(0,i.jsxs)(i.Fragment,{children:[(0,i.jsxs)("label",{className:"flex items-center gap-2",children:[(0,i.jsx)("span",{className:"text-zinc-400",children:"選取寬"}),(0,i.jsx)("input",{type:"number",min:30,value:eC.widthInput??String(eC.widthCm),onChange:e=>{let t=e.target.value;eC.widthInput=t;let n=parseFloat(t);Number.isFinite(n)&&(eC.widthCm=n,ea()),z(e=>e?{...e}:e)},onBlur:()=>{if(void 0!==eC.widthInput){let e=parseFloat(eC.widthInput);Number.isFinite(e)&&(eC.widthCm=e,ew(eC)),eC.widthInput=void 0,ea(),z(e=>e?{...e}:e)}},onKeyDown:e=>{"Enter"===e.key&&e.target.blur()},className:"w-16 bg-zinc-900 border border-white/10 rounded px-2 py-1 text-white"})]}),(0,i.jsx)("button",{type:"button",onClick:()=>{b.current.windows=b.current.windows.filter(e=>e.id!==eC.id),es(null),ea()},className:"rounded-lg border border-red-500/30 text-red-200 hover:bg-red-500/10 px-2 py-1",children:"刪除"})]})]}),eq&&(0,i.jsxs)("div",{className:"flex items-center gap-3 shrink-0 text-xs whitespace-nowrap",children:[(0,i.jsx)("span",{className:"text-white font-semibold",children:"家具"}),(0,i.jsx)("div",{className:"flex items-center gap-2",children:f.map(e=>(0,i.jsx)("button",{onClick:()=>k(t=>({...t,mode:"placeFurniture",selectedFurnitureType:e.type})),className:(0,p.cn)("rounded-lg border px-2 py-1",v.selectedFurnitureType===e.type&&"placeFurniture"===v.mode?"border-amber-400 bg-amber-500/10 text-amber-200":"border-white/10 text-zinc-400 hover:border-white/20"),children:e.label},e.type))}),eM&&(0,i.jsxs)("label",{className:"flex items-center gap-2",children:[(0,i.jsx)("span",{className:"text-zinc-400",children:"縮放"}),(0,i.jsx)("input",{type:"range",min:.4,max:2,step:.05,value:eM.scale,onChange:e=>{eM.scale=parseFloat(e.target.value),ea(),z(e=>e?{...e}:e)},className:"w-24"})]})]})]}),(0,i.jsx)("canvas",{ref:t,className:(0,p.cn)("w-full h-full bg-zinc-950 cursor-crosshair touch-none",b.current.isPanning?"cursor-grab active:cursor-grabbing":""),onMouseDown:e=>{let n=b.current,i=t.current?.getBoundingClientRect();if(!i)return;let l=N({x:e.clientX-i.left,y:e.clientY-i.top});if(n.pointerWorld=l,n.isCtrlPressed=e.ctrlKey||e.metaKey,n.isAltPressed=e.altKey,0!==e.button)return;if(n.isSpacePressed){n.isPanning=!0,n.panStart={x:e.clientX,y:e.clientY};return}eg(l);let r=n.snappedPoint?{...n.snappedPoint}:l;if(("measureLine"===v.mode||"setScale"===v.mode)&&n.drawing){n.endPoint={...r},n.measureFinalizePending=!0,ea();return}if(("drawBoundary"===v.mode||"drawWall"===v.mode||"drawRoom"===v.mode||"drawColumn"===v.mode)&&(n.isShiftPressed||n.isOrthoMode)&&n.drawingPoints.length>0){let e=n.drawingPoints[n.drawingPoints.length-1];n.startPoint=Q(e,r)}else n.startPoint=r;if("select"===v.mode||"placeFurniture"===v.mode||"placeWindow"===v.mode){if(((e,t)=>{let n=b.current,i=ez(e);if(i)return es({kind:"measure",id:i.id}),n.draggingMeasureId=i.id,n.dragStartMeasure={offset:i.offset,mouse:{...e}},ea(),!0;let l=ev(e);if(l){let{window:e,handle:t}=l,i=en();if(i){let l=T(i.points[e.segmentIndex],i.points[(e.segmentIndex+1)%i.points.length])||1,r=b.current.scale??1,a=e.widthCm*r/(2*l);return n.dragStartWindow={startT:e.t-a,endT:e.t+a,segmentIndex:e.segmentIndex},n.draggingWindowId=e.id,n.draggingWindowHandle=t,es({kind:"window",id:e.id}),ea(),!0}}let r=eb(e);if(r)return es({kind:"window",id:r.id}),n.draggingWindowId=r.id,n.draggingWindowHandle=null,ea(),!0;let a=eS(e);if(a)return es({kind:"furniture",id:a.id}),n.draggingFurnitureId=a.id,n.dragStartMouse={x:e.x,y:e.y},n.dragStartFurniturePos={...a.position},ea(),!0;let s=_(e);if(s){let{column:t,handle:i,bounds:l}=s;return es({kind:"column",id:t.id}),n.draggingColumnResize={id:t.id,handle:i,startBounds:l,startPoints:t.points.map(e=>({...e})),startMouse:{x:e.x,y:e.y}},ea(),!0}let o=eP(e);if(o)return es({kind:"column",id:o.id}),n.draggingColumnId=o.id,n.dragStartMouse={x:e.x,y:e.y},n.dragStartColumnPoints=o.points.map(e=>({...e})),ea(),!0;let d=ey(e);if(d){es({kind:"wall",pathId:d.pathId,segmentIndex:d.segmentIndex});let t=n.wallPaths.find(e=>e.id===d.pathId);return t&&!t.isBoundary&&(n.draggingWallPathId=t.id,n.dragStartWallMouse={x:e.x,y:e.y},n.dragStartWallPoints=t.points.map(e=>({...e}))),ea(),!0}let c=ek(e);return!!c&&(es({kind:"room",id:c.id}),n.draggingRoomId=c.id,n.dragStartMouse={x:e.x,y:e.y},n.dragStartRoomPoints=c.points.map(e=>({...e})),ea(),!0)})(l,0))return;if("select"===v.mode){es(null),ea();return}}if("drawWall"===v.mode){n.drawing=!0,0===n.drawingPoints.length&&(n.usedOrthoDuringDraw=!1),n.drawingPoints.push(n.startPoint),n.endPoint={...n.startPoint},n.drawingPoints.length>=2?ed():ea();return}if("drawBoundary"===v.mode||"drawRoom"===v.mode||"drawColumn"===v.mode){n.drawing=!0,0===n.drawingPoints.length&&(n.usedOrthoDuringDraw=!1),n.drawingPoints.push(n.startPoint),n.endPoint={...n.startPoint},ea();return}if("drawColumnRect"===v.mode){n.drawing=!0,n.usedOrthoDuringDraw=!1,n.drawingPoints=[],n.endPoint={...n.startPoint},ea();return}if("placeWindow"===v.mode){let e=(e=>{let t=b.current,n=en();if(!n)return null;let i=1/0,l=null,r=n.points.length,a=er()?.polygon,s=a&&a.length===r;for(let o=0;o<r;o++){let d=n.points[o],c=n.points[(o+1)%r],u=X(e,d,c),x=u,m=t.scale?(n.segments[o]?.thicknessCm??v.wallThicknessDefault)*t.scale:12,h=Math.max(12/t.zoomLevel,1.2*m);if(s&&(x=Math.min(u,X(e,a[o],a[(o+1)%r]))),x<=h&&x<i){i=x;let t=Y(e,d,c);l={segmentIndex:o,point:t.point,t:t.t}}}return l})(l),t=en();if(!t)return void k(e=>({...e,infoText:"請先繪製外框再放置窗戶"}));if(e){let i={id:w(),pathId:t.id,segmentIndex:e.segmentIndex,t:e.t,widthCm:v.windowWidthCm,type:v.windowType};ew(i),n.windows.push(i),es({kind:"window",id:i.id}),k(e=>({...e,mode:"select",infoText:"窗戶已新增。"})),W(),ea()}return}if("placeFurniture"===v.mode){let e={id:w(),type:v.selectedFurnitureType,position:n.startPoint,rotation:0,scale:1};n.furniture.push(e),es({kind:"furniture",id:e.id}),k(e=>({...e,mode:"select",infoText:"家具已新增。"})),W(),ea();return}if("measureLine"===v.mode||"setScale"===v.mode){if(n.drawing){n.endPoint={...r},n.measureFinalizePending=!0,ea();return}n.activeMeasureMode=v.mode,n.drawing=!0,n.measureFinalizePending=!1,n.endPoint={...n.startPoint},ea()}},onMouseMove:e=>{let n=b.current,i=t.current?.getBoundingClientRect();if(!i)return;let l=e.clientX-i.left,r=e.clientY-i.top;if(n.isPanning){let t=e.clientX-n.panStart.x,i=e.clientY-n.panStart.y;n.panOffset.x+=t,n.panOffset.y+=i,n.panStart={x:e.clientX,y:e.clientY},ea();return}let a=N({x:l,y:r});if(n.isCtrlPressed=e.ctrlKey||e.metaKey,n.isAltPressed=e.altKey,"select"===v.mode){let e=t.current;if(e&&!n.draggingMeasureId&&!n.draggingFurnitureId&&!n.draggingWindowId&&!n.draggingRoomId&&!n.draggingColumnId&&!n.draggingColumnResize&&!n.draggingWallPathId){let t=_(a);if(t)e.style.cursor="nw"===t.handle||"se"===t.handle?"nwse-resize":"nesw-resize";else if(ev(a))e.style.cursor="ew-resize";else{let t=ez(a);t?e.style.cursor="h"===t.orientation?"ns-resize":"ew-resize":eb(a)?e.style.cursor="move":eS(a)||eP(a)||ek(a)||ey(a)?e.style.cursor="grab":e.style.cursor="default"}}if(n.draggingMeasureId){let e=n.measureLines.find(e=>e.id===n.draggingMeasureId);if(e&&n.dragStartMeasure){let t="h"===e.orientation?a.y-n.dragStartMeasure.mouse.y:a.x-n.dragStartMeasure.mouse.x,i=n.dragStartMeasure.offset+t,l=6/n.zoomLevel,r="h"===e.orientation?e.pixelStart.y+i:e.pixelStart.x+i;n.measureLines.forEach(t=>{if(t.id===e.id||t.orientation!==e.orientation)return;let n="h"===t.orientation?t.pixelStart.y+t.offset:t.pixelStart.x+t.offset;Math.abs(r-n)<=l&&(i+=n-r)}),e.offset=i,ea()}return}if(n.draggingFurnitureId){let e=n.furniture.find(e=>e.id===n.draggingFurnitureId);e&&(e.position={x:n.dragStartFurniturePos.x+(a.x-n.dragStartMouse.x),y:n.dragStartFurniturePos.y+(a.y-n.dragStartMouse.y)},ea());return}if(n.draggingWindowId){let e=n.windows.find(e=>e.id===n.draggingWindowId),t=en();if(e&&t){let i=t.points[e.segmentIndex],l=t.points[(e.segmentIndex+1)%t.points.length],r=Y(a,i,l);if(n.draggingWindowHandle&&n.dragStartWindow){let t=n.dragStartWindow.startT,a=n.dragStartWindow.endT,s=T(i,l)||1,o=n.scale??1;"start"===n.draggingWindowHandle?t=Math.max(0,t=Math.min(r.t,a-.02)):a=Math.min(1,a=Math.max(r.t,t+.02)),e.t=(t+a)/2,e.widthCm=(a-t)*s/o}else if(n.isShiftPressed){let t=T(i,l)||1,a=n.scale??1,s=Math.max(.02,Math.abs(r.t-e.t));e.widthCm=2*s*t/a}else e.t=r.t;ew(e),ea()}return}if(n.draggingRoomId){let e=n.rooms.find(e=>e.id===n.draggingRoomId);if(e){let t=a.x-n.dragStartMouse.x,i=a.y-n.dragStartMouse.y;e.points=n.dragStartRoomPoints.map(e=>({x:e.x+t,y:e.y+i})),ea()}return}if(n.draggingColumnResize){let e=n.columns.find(e=>e.id===n.draggingColumnResize?.id);if(e){let{handle:t,startBounds:i,startPoints:l,startMouse:r}=n.draggingColumnResize,s=a.x-r.x,o=a.y-r.y,d=i.minX,c=i.maxX,u=i.minY,x=i.maxY;t.includes("w")&&(d+=s),t.includes("e")&&(c+=s),t.includes("n")&&(u+=o),t.includes("s")&&(x+=o);let m=10/n.zoomLevel;c-d<m&&(t.includes("w")&&(d=c-m),t.includes("e")&&(c=d+m)),x-u<m&&(t.includes("n")&&(u=x-m),t.includes("s")&&(x=u+m));let h=(c-d)/(i.maxX-i.minX||1),p=(x-u)/(i.maxY-i.minY||1);e.points=l.map(e=>({x:d+(e.x-i.minX)*h,y:u+(e.y-i.minY)*p})),ea()}return}if(n.draggingColumnId){let e=n.columns.find(e=>e.id===n.draggingColumnId);if(e){let t=a.x-n.dragStartMouse.x,i=a.y-n.dragStartMouse.y;e.points=n.dragStartColumnPoints.map(e=>({x:e.x+t,y:e.y+i})),ea()}return}if(n.draggingWallPathId){let e=n.wallPaths.find(e=>e.id===n.draggingWallPathId);if(e){let t=a.x-n.dragStartWallMouse.x,i=a.y-n.dragStartWallMouse.y;if(n.isAltPressed||n.isCtrlPressed){let l=n.dragStartWallPoints.map(e=>({x:e.x+t,y:e.y+i})),r=10/n.zoomLevel,a=null;if(n.isAltPressed){let t=[],i=en();i&&t.push(...i.points);let s=er()?.polygon;for(let i of(s&&t.push(...s),n.wallPaths.forEach(n=>{n.id===e.id||n.isBoundary||t.push(...n.points)}),t.push(...q(e.id)),l))for(let e of t){let t=T(i,e);t<=r&&(!a||t<a.dist)&&(a={dx:e.x-i.x,dy:e.y-i.y,dist:t})}}else if(n.isCtrlPressed){let t=l[Math.floor(l.length/2)]||l[0],i=er()?.polygon;if(i&&i.length>=2)for(let e=0;e<i.length;e++){let n=Y(t,i[e],i[(e+1)%i.length]),l=T(t,n.point);l<=r&&(!a||l<a.dist)&&(a={dx:n.point.x-t.x,dy:n.point.y-t.y,dist:l})}n.wallPaths.forEach(n=>{if(n.id===e.id||n.isBoundary)return;let i=Math.max(0,n.points.length-1);for(let e=0;e<i;e++){let i=Y(t,n.points[e],n.points[e+1]),l=T(t,i.point);l<=r&&(!a||l<a.dist)&&(a={dx:i.point.x-t.x,dy:i.point.y-t.y,dist:l})}})}a&&(t+=a.dx,i+=a.dy)}e.points=n.dragStartWallPoints.map(e=>({x:e.x+t,y:e.y+i})),ea()}return}}let s=t.current;s&&"select"!==v.mode&&(s.style.cursor=""),eg(a);let o=n.snappedPoint?{...n.snappedPoint}:a;if(n.drawing&&(n.isShiftPressed||n.isOrthoMode)){n.usedOrthoDuringDraw=!0;let e=n.startPoint;("drawBoundary"===v.mode||"drawWall"===v.mode||"drawRoom"===v.mode||"drawColumn"===v.mode)&&n.drawingPoints.length>0&&(e=n.drawingPoints[n.drawingPoints.length-1]),o=Q(e,o)}n.endPoint=o,ea()},onMouseUp:()=>{let e=b.current;if(e.isPanning){e.isPanning=!1;return}if(e.draggingMeasureId){e.draggingMeasureId=null,e.dragStartMeasure=null,W();return}if(e.draggingFurnitureId){e.draggingFurnitureId=null,W();return}if(e.draggingWindowId){e.draggingWindowId=null,e.draggingWindowHandle=null,e.dragStartWindow=null,W();return}if(e.draggingRoomId){e.draggingRoomId=null,e.dragStartRoomPoints=[],W();return}if(e.draggingColumnResize){let t=e.columns.find(t=>t.id===e.draggingColumnResize?.id);t&&(t.points=el(t.points)),e.draggingColumnResize=null,W();return}if(e.draggingColumnId){let t=e.columns.find(t=>t.id===e.draggingColumnId);t&&(t.points=el(t.points)),e.draggingColumnId=null,e.dragStartColumnPoints=[],W();return}if(e.draggingWallPathId){let t=e.wallPaths.find(t=>t.id===e.draggingWallPathId);t&&(t.points=t.points.map(e=>ei(e,!0))),e.draggingWallPathId=null,e.dragStartWallPoints=[],W();return}if(!e.drawing)return;if("drawBoundary"===v.mode){if(e.drawingPoints.length>=2){let t=e.drawingPoints[0],n=15/e.zoomLevel;T(e.endPoint,t)<n&&eo()}return}if("drawRoom"===v.mode){if(e.drawingPoints.length>=2){let t=e.drawingPoints[0],n=15/e.zoomLevel;T(e.endPoint,t)<n&&ec()}return}if("drawColumn"===v.mode){if(e.drawingPoints.length>=2){let t=e.drawingPoints[0],n=15/e.zoomLevel;T(e.endPoint,t)<n&&eu()}return}if("drawColumnRect"===v.mode)return void ex();if("drawWall"===v.mode){1===e.drawingPoints.length&&T(e.startPoint,e.endPoint)>1/e.zoomLevel&&(e.drawingPoints.push(e.endPoint),ed());return}let t=T(e.startPoint,e.endPoint);if("measureLine"===v.mode||"setScale"===v.mode){let n=3/e.zoomLevel;if(!e.measureFinalizePending&&t<n){e.drawing=!0,ea();return}}else if(t<1/e.zoomLevel)return;let n=e.activeMeasureMode||v.mode,i={...e.startPoint},l={...e.endPoint};if("setScale"===n){let t=parseFloat(prompt("請輸入這段距離的實際長度(公分) e.g. 100","100")||"");if(t>0){let n=L(i,l,"#06b6d4","scale"),r=T(n.pixelStart,n.pixelEnd);r>0&&(e.scale=r/t,e.measureLines.push(n)),es({kind:"measure",id:n.id}),k(t=>({...t,scaleSet:!0,mode:"select",infoText:`比例尺已設定: ${(e.scale||0).toFixed(2)} px/cm`})),W()}}else if("measureLine"===n){let t=L(i,l,"#facc15","measure");t.isInside?t.color=e.measureLines.filter(e=>"measure"===e.purpose&&e.isInside).length%2==0?"#facc15":"#38bdf8":t.color="#f97316",e.measureLines.push(t),es({kind:"measure",id:t.id}),k(e=>({...e,mode:"select",infoText:"測距已新增。"})),W()}e.drawing=!1,e.activeMeasureMode=null,e.measureFinalizePending=!1,ea()},onContextMenu:e=>{e.preventDefault();let t=b.current;"drawBoundary"===v.mode?eo():"drawWall"===v.mode?ed():"drawRoom"===v.mode?ec():"drawColumn"===v.mode?eu():"drawColumnRect"===v.mode?ex():(t.drawingPoints=[],t.drawing=!1,ea())}}),(0,i.jsx)("div",{className:"absolute bottom-4 left-4 text-[10px] text-zinc-300 pointer-events-none bg-zinc-950/90 p-2 rounded-lg border border-white/10",children:(0,i.jsx)("p",{children:"Esc: 選取 | Delete: 刪除 | 左鍵: 繪圖 | 右鍵/Enter: 結束 | Shift: 正交/調整窗寬 | 方向鍵: 微調外牆段 | Shift+方向鍵: 快速微調 | 空白鍵: 平移 | Ctrl: 抓線 | Alt: 抓角 | Ctrl/Cmd+Z: 復原 | Ctrl/Cmd+C/V: 複製/貼上 | 拖曳: 內牆/窗戶/空間/柱子"})})]}),(0,i.jsxs)("div",{className:"w-80 shrink-0 h-full overflow-y-auto bg-zinc-900/80 border border-white/5 rounded-xl shadow-xl p-4 space-y-4",children:[(0,i.jsxs)("div",{className:"rounded-xl border border-amber-400/40 bg-amber-500/15 px-3 py-2 text-amber-100",children:[(0,i.jsx)("div",{className:"text-xs font-semibold tracking-wide",children:"提示"}),(0,i.jsx)("div",{className:"text-sm font-bold mt-1",children:v.infoText})]}),(0,i.jsxs)("div",{children:[(0,i.jsx)("h3",{className:"text-sm font-semibold text-white",children:"使用流程"}),(0,i.jsx)("div",{className:"mt-2 space-y-2 text-xs",children:eY.map(e=>(0,i.jsxs)("div",{className:"flex items-center justify-between gap-2",children:[(0,i.jsxs)("div",{className:"flex items-center gap-2",children:[(0,i.jsx)("span",{className:(0,p.cn)("h-2.5 w-2.5 rounded-full",e.done?"bg-emerald-400":"bg-zinc-600")}),(0,i.jsx)("span",{className:e.done?"text-emerald-200":"text-zinc-300",children:e.label})]}),"upload"===e.action?(0,i.jsx)("label",{htmlFor:"fp-upload",className:"cursor-pointer rounded-full border border-white/10 px-2 py-0.5 text-[11px] text-zinc-300 hover:border-white/20",children:"上傳"}):(0,i.jsx)("button",{type:"button",onClick:e.action,disabled:e.disabled,className:(0,p.cn)("rounded-full border border-white/10 px-2 py-0.5 text-[11px] text-zinc-300 hover:border-white/20",e.disabled&&"opacity-40 cursor-not-allowed hover:border-white/10"),children:"前往"})]},e.id))})]}),(0,i.jsxs)("div",{children:[(0,i.jsx)("h3",{className:"text-sm font-semibold text-white",children:"圖面備註"}),(0,i.jsxs)("div",{className:"mt-2 space-y-2 text-xs",children:[(0,i.jsxs)("label",{className:"flex items-center justify-between gap-2",children:[(0,i.jsx)("span",{className:"text-zinc-400",children:"圖面類型"}),(0,i.jsxs)("select",{value:v.planType,onChange:e=>k(t=>({...t,planType:e.target.value})),className:"bg-zinc-900 border border-white/10 rounded px-2 py-1 text-white",children:[(0,i.jsx)("option",{value:"indoor",children:"家配圖（室內）"}),(0,i.jsx)("option",{value:"public",children:"公設圖"})]})]}),(0,i.jsxs)("div",{children:[(0,i.jsx)("span",{className:"text-zinc-400",children:"備註"}),(0,i.jsx)("textarea",{value:v.planNote,onChange:e=>k(t=>({...t,planNote:e.target.value})),rows:2,className:"mt-1 w-full bg-zinc-900 border border-white/10 rounded px-2 py-1 text-white text-xs",placeholder:"例如：客變版本 / 家配圖"})]})]})]}),(0,i.jsxs)("div",{children:[(0,i.jsx)("h3",{className:"text-sm font-semibold text-white",children:"外框 / 淨面積"}),(0,i.jsx)("p",{className:"text-xs text-zinc-400",children:"外框牆厚可在選取牆段後調整"}),(0,i.jsxs)("div",{className:"mt-2 flex items-center justify-between text-xs",children:[(0,i.jsx)("span",{className:"text-zinc-400",children:"預設牆厚 (cm)"}),(0,i.jsx)("input",{type:"number",min:1,value:v.wallThicknessDefault,onChange:e=>k(t=>({...t,wallThicknessDefault:parseFloat(e.target.value||"0")})),className:"w-20 bg-zinc-900 border border-white/10 rounded px-2 py-1 text-white"})]}),(0,i.jsxs)("div",{className:"mt-2 flex items-center justify-between text-xs",children:[(0,i.jsx)("span",{className:"text-zinc-400",children:"外框填色"}),(0,i.jsx)("input",{type:"color",value:v.boundaryFillColor,onChange:e=>k(t=>({...t,boundaryFillColor:e.target.value})),className:"h-6 w-10 bg-transparent border border-white/10 rounded"})]}),(0,i.jsxs)("div",{className:"mt-2 flex items-center justify-between text-xs",children:[(0,i.jsx)("span",{className:"text-zinc-400",children:"外框透明度"}),(0,i.jsx)("input",{type:"range",min:0,max:.6,step:.05,value:v.boundaryFillOpacity,onChange:e=>k(t=>({...t,boundaryFillOpacity:parseFloat(e.target.value)})),className:"w-24"})]}),(0,i.jsxs)("div",{className:"mt-3 space-y-2 text-xs",children:[(0,i.jsxs)("div",{className:"flex items-center justify-between",children:[(0,i.jsx)("span",{className:"text-zinc-400",children:"外牆線粗細"}),(0,i.jsx)("input",{type:"range",min:.1,max:1.3,step:.05,value:v.boundaryLineScale,onChange:e=>k(t=>({...t,boundaryLineScale:parseFloat(e.target.value)})),className:"w-24"})]}),(0,i.jsxs)("div",{className:"flex items-center justify-between",children:[(0,i.jsx)("span",{className:"text-zinc-400",children:"內測線粗細"}),(0,i.jsx)("input",{type:"range",min:.1,max:1.3,step:.05,value:v.innerLineScale,onChange:e=>k(t=>({...t,innerLineScale:parseFloat(e.target.value)})),className:"w-24"})]}),(0,i.jsxs)("div",{className:"flex items-center justify-between",children:[(0,i.jsx)("span",{className:"text-zinc-400",children:"內牆線粗細"}),(0,i.jsx)("input",{type:"range",min:.1,max:1.3,step:.05,value:v.wallLineScale,onChange:e=>k(t=>({...t,wallLineScale:parseFloat(e.target.value)})),className:"w-24"})]})]}),eE?(0,i.jsxs)("div",{className:"mt-2 space-y-1 text-xs text-zinc-200",children:[(0,i.jsxs)("div",{children:["外框淨面積：",e$(eW)]}),(0,i.jsxs)("div",{children:["內框淨面積：",e$(eA)]}),(0,i.jsxs)("div",{children:["柱子面積：",e$(eD)]})]}):(0,i.jsx)("p",{className:"mt-2 text-xs text-zinc-500",children:"尚未設定外框或比例尺"})]}),(0,i.jsxs)("div",{children:[(0,i.jsx)("h3",{className:"text-sm font-semibold text-white",children:"房間列表"}),(0,i.jsx)("div",{className:"mt-2 space-y-2 max-h-48 overflow-auto",children:0===b.current.rooms.length?(0,i.jsx)("p",{className:"text-xs text-zinc-500",children:"尚未新增空間"}):b.current.rooms.map(e=>{let t=b.current.scale?A(e.points)/(b.current.scale*b.current.scale):null,n=null!==t?t/1e4:null,l=null!==t?t/33057.9:null;return(0,i.jsxs)("div",{className:"rounded-lg border border-white/10 bg-zinc-950/40 p-2",children:[(0,i.jsx)("input",{value:e.name,onChange:t=>{e.name=t.target.value,ea(),k(e=>({...e})),z(t=>t&&"room"===t.kind&&t.id===e.id?{...t}:t)},className:"w-full bg-transparent text-xs text-white mb-1 outline-none border-b border-white/10"}),(0,i.jsxs)("div",{className:"text-[11px] text-zinc-400 flex flex-col gap-0.5",children:[(0,i.jsxs)("span",{children:["坪數：",null!==l?l.toFixed(2):"-"]}),(0,i.jsxs)("span",{children:["平方公尺：",null!==n?n.toFixed(2):"-"]}),(0,i.jsxs)("span",{children:["面積：",null!==t?t.toFixed(0):"-"]})]})]},e.id)})})]}),(0,i.jsxs)("div",{children:[(0,i.jsx)("h3",{className:"text-sm font-semibold text-white",children:"報表輸出"}),(0,i.jsx)("div",{className:"mt-2",children:(0,i.jsx)("button",{type:"button",onClick:()=>{var e,n;let i,l=t.current;if(!l)return;let r=eF.slice(0,10),a=Math.max(0,eF.length-r.length),s=r.length+ +!!a,o=Math.max(l.height,20+(5+s+4)*18),d=document.createElement("canvas");d.width=l.width+84+300,d.height=o+56+56;let c=d.getContext("2d");if(!c)return;c.fillStyle="#0b0c10",c.fillRect(0,0,d.width,d.height),c.fillStyle="#e5e7eb",c.font="bold 20px sans-serif",c.fillText("平面圖測量報表",28,50),c.font="12px sans-serif",c.fillStyle="#94a3b8",c.fillText(new Date().toLocaleString("zh-TW"),28,68),c.fillText(`圖面類型：${"public"===v.planType?"公設圖":"家配圖(室內)"}`,28,84),v.planNote.trim()&&c.fillText(`備註：${v.planNote.trim()}`,28,100);c.strokeStyle="#1f2937",c.lineWidth=2,c.strokeRect(28,84,l.width,l.height),c.drawImage(l,28,84);let u=28+l.width+28;c.fillStyle="#111827",c.fillRect(u,84,300,o),c.strokeStyle="#1f2937",c.strokeRect(u,84,300,o);let x=108;c.fillStyle="#e5e7eb",c.font="bold 14px sans-serif",c.fillText("面積統計",u+16,x),x+=20,c.font="12px sans-serif";let m=e=>null==e?"-":`${(e/33057.9).toFixed(2)} 坪 / ${(e/1e4).toFixed(2)} ㎡`;c.fillStyle="#cbd5f5",c.fillText(`外框淨面積：${m(eT?.areaCm2??null)}`,u+16,x),x+=18,c.fillText(`柱子面積：${m(eR)}`,u+16,x),x+=18,c.fillText(`內牆面積：${m(eO)}`,u+16,x),x+=18,c.fillText(`可用面積：${m(eB)}`,u+16,x),x+=28,c.fillStyle="#e5e7eb",c.font="bold 14px sans-serif",c.fillText("空間明細",u+16,x),x+=20,c.font="12px sans-serif",c.fillStyle="#cbd5f5",r.forEach(e=>{let t=e.areaCm2,n=null!==t?t/1e4:null,i=null!==t?t/33057.9:null;c.fillText(`${e.room.name}  ${null!==i?i.toFixed(2):"-"} 坪 / ${null!==n?n.toFixed(2):"-"} ㎡`,u+16,x),x+=18}),a&&(c.fillStyle="#94a3b8",c.fillText(`... 另有 ${a} 個空間`,u+16,x)),e=d.toDataURL("image/png"),n=`平面圖_報表_${Date.now()}.png`,(i=document.createElement("a")).href=e,i.download=n,i.click()},className:"w-full rounded-lg border border-emerald-400/30 bg-emerald-500/10 px-3 py-1.5 text-xs text-emerald-200 hover:bg-emerald-500/20",children:"匯出量測平面圖"})})]}),ej&&(0,i.jsxs)("div",{children:[(0,i.jsx)("h3",{className:"text-sm font-semibold text-white",children:"牆段設定"}),(0,i.jsxs)("div",{className:"mt-2 space-y-2 text-xs",children:[(0,i.jsxs)("label",{className:"flex items-center justify-between gap-2",children:[(0,i.jsx)("span",{className:"text-zinc-400",children:"類型"}),(0,i.jsxs)("select",{value:ej.segment.wallType,onChange:e=>{ej.segment.wallType=e.target.value,ea(),W()},className:"bg-zinc-900 border border-white/10 rounded px-2 py-1 text-white",children:[(0,i.jsx)("option",{value:"wall",children:"牆"}),(0,i.jsx)("option",{value:"window",children:"窗"}),(0,i.jsx)("option",{value:"pillar",children:"柱"})]})]}),(0,i.jsxs)("label",{className:"flex items-center justify-between gap-2",children:[(0,i.jsx)("span",{className:"text-zinc-400",children:"牆厚 (cm)"}),(0,i.jsx)("input",{type:"number",min:1,value:ej.segment.thicknessCm,onChange:e=>{let t=parseFloat(e.target.value||"0");if(ej.path.isBoundary){let e=Number.isFinite(t)&&t>0?t:ej.segment.thicknessCm;ej.segment.thicknessCm=e}else ej.segment.thicknessCm=parseFloat(e.target.value||"0");ea(),W()},className:"w-20 bg-zinc-900 border border-white/10 rounded px-2 py-1 text-white"})]}),!ej.path.isBoundary&&(0,i.jsx)("button",{type:"button",onClick:()=>{ej.path.offsetSide=-((ej.path.offsetSide??1)*1),ea(),W()},className:"w-full rounded-lg border border-white/10 text-zinc-200 hover:border-white/20 px-2 py-1.5",children:"翻轉內牆方向"})]})]}),eM&&(0,i.jsxs)("div",{children:[(0,i.jsx)("h3",{className:"text-sm font-semibold text-white",children:"家具設定"}),(0,i.jsxs)("div",{className:"mt-2 space-y-2 text-xs",children:[(0,i.jsxs)("label",{className:"flex items-center justify-between gap-2",children:[(0,i.jsx)("span",{className:"text-zinc-400",children:"旋轉"}),(0,i.jsx)("input",{type:"range",min:0,max:360,value:180*eM.rotation/Math.PI,onChange:e=>{eM.rotation=parseFloat(e.target.value)*Math.PI/180,ea()},className:"w-32"})]}),(0,i.jsxs)("label",{className:"flex items-center justify-between gap-2",children:[(0,i.jsx)("span",{className:"text-zinc-400",children:"縮放"}),(0,i.jsx)("input",{type:"range",min:.4,max:2,step:.05,value:eM.scale,onChange:e=>{eM.scale=parseFloat(e.target.value),ea()},className:"w-32"})]})]})]})]})]})}}}]);