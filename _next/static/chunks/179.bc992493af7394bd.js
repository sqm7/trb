"use strict";(self.webpackChunk_N_E=self.webpackChunk_N_E||[]).push([[179],{21628:(e,t,s)=>{s.d(t,{A:()=>a});let a=(0,s(78340).A)("arrow-right",[["path",{d:"M5 12h14",key:"1ays0h"}],["path",{d:"m12 5 7 7-7 7",key:"xquz4c"}]])},37618:(e,t,s)=>{s.d(t,{A:()=>a});let a=(0,s(78340).A)("pen-line",[["path",{d:"M13 21h8",key:"1jsn5i"}],["path",{d:"M21.174 6.812a1 1 0 0 0-3.986-3.987L3.842 16.174a2 2 0 0 0-.5.83l-1.321 4.352a.5.5 0 0 0 .623.622l4.353-1.32a2 2 0 0 0 .83-.497z",key:"1a8usu"}]])},38346:(e,t,s)=>{s.d(t,{h:()=>l});var a=s(12115),n=s(16385);function l(){let[e,t]=(0,a.useState)(null),[s,l]=(0,a.useState)(!0);return(0,a.useEffect)(()=>{let e=!0,s=async()=>{try{let{data:{session:s}}=await n.N.auth.getSession();if(!s?.user){e&&(t(null),l(!1));return}let{data:a,error:r}=await n.N.from("profiles").select("role").eq("id",s.user.id).single();e&&(a?t(a.role):t("user"),l(!1))}catch(s){console.error("Error fetching user role:",s),e&&(t("user"),l(!1))}};s();let{data:{subscription:a}}=n.N.auth.onAuthStateChange((e,a)=>{a?s():t(null)});return()=>{e=!1,a.unsubscribe()}},[]),{role:e,isLoading:s}}},43987:(e,t,s)=>{s.d(t,{A:()=>a});let a=(0,s(78340).A)("sprout",[["path",{d:"M14 9.536V7a4 4 0 0 1 4-4h1.5a.5.5 0 0 1 .5.5V5a4 4 0 0 1-4 4 4 4 0 0 0-4 4c0 2 1 3 1 5a5 5 0 0 1-1 3",key:"139s4v"}],["path",{d:"M4 9a5 5 0 0 1 8 4 5 5 0 0 1-8-4",key:"1dlkgp"}],["path",{d:"M5 21h14",key:"11awu3"}]])},72566:(e,t,s)=>{s.d(t,{q:()=>l});var a=s(95155);s(12115);var n=s(40980);function l({title:e,description:t,children:s,headerAction:l,className:r,containerRef:i}){return(0,a.jsxs)("div",{ref:i,className:(0,n.cn)("bg-zinc-900/50 border border-white/5 rounded-2xl p-4 md:p-6 backdrop-blur-sm",r),children:[(0,a.jsxs)("div",{className:"flex flex-col md:flex-row md:items-center justify-between gap-4 mb-6",children:[(0,a.jsxs)("div",{children:[(0,a.jsx)("h3",{className:"text-xl font-bold text-white flex items-center gap-2",children:e}),t&&(0,a.jsx)("p",{className:"text-zinc-400 text-sm mt-1",children:t})]}),l&&(0,a.jsx)("div",{className:"flex-shrink-0 w-full md:w-auto overflow-x-auto","data-html2canvas-ignore":"true",children:l})]}),s]})}},84367:(e,t,s)=>{s.r(t),s.d(t,{MapHeatmapReport:()=>w});var a=s(95155),n=s(12115),l=s(72566),r=s(93398),i=s(1509),c=s(81789),o=s(29991),d=s(60529),u=s(89239),x=s(37618),m=s(61878),h=s(48165),p=s(88743),f=s(27529),g=s(55873),j=s(98883);function N({transactions:e,project:t}){let[s,l]=(0,n.useState)(""),[r,i]=(0,n.useState)(""),[c,o]=(0,n.useState)(null),[x,m]=(0,n.useState)(!1),[h,p]=(0,n.useState)(null),f=e=>{if(null==e)return null;if("number"==typeof e&&Number.isFinite(e))return e;let t=String(e).trim();if(!t||t.startsWith("B")||t.includes("地下")||t.includes("負"))return null;let s=t.match(/-?\d+/);if(!s)return null;let a=parseInt(s[0],10);return!Number.isFinite(a)||a<=0?null:a};(0,n.useEffect)(()=>{l(""),i(""),o(null)},[t]),(0,n.useEffect)(()=>{let e=()=>{m(!1),p(null)};return window.addEventListener("pointerup",e),()=>window.removeEventListener("pointerup",e)},[]);let g=n.useMemo(()=>{if(!e||0===e.length)return[];let t=0;return(e.forEach(e=>{let s=f(e["樓層"]);s&&s>t&&(t=s)}),t)?Array.from({length:t},(e,t)=>t+1):[]},[e]),j=n.useMemo(()=>{let e=parseInt(s,10),t=parseInt(r,10);return Number.isFinite(e)&&Number.isFinite(t)?{start:Math.min(e,t),end:Math.max(e,t)}:null},[s,r]),N=n.useCallback(s=>{if(!t||!e||!s)return void o(null);let a=e.filter(e=>{let t=f(e["樓層"]);return!!t&&t>=s.start&&t<=s.end});if(0===a.length)return void o({avg:0,count:0});let n=a.reduce((e,t)=>e+(t["房屋總價(萬)"]||0),0),l=a.reduce((e,t)=>e+(t["房屋面積(坪)"]||0),0);o({avg:l>0?n/l:0,count:a.length})},[t,e]);(0,n.useEffect)(()=>{N(j)},[j,N]);let w=(e,t)=>{let s=Math.min(e,t),a=Math.max(e,t);l(String(s)),i(String(a))};return(0,a.jsxs)("div",{className:"flex flex-col gap-3 bg-zinc-900/30 p-4 rounded-lg border border-white/5",children:[(0,a.jsxs)("div",{className:"flex flex-col sm:flex-row items-start sm:items-center gap-2 w-full sm:w-auto",children:[(0,a.jsx)("span",{className:"text-sm text-zinc-400 font-semibold whitespace-nowrap",children:"區間均價試算:"}),(0,a.jsxs)("div",{className:"flex items-center gap-2",children:[(0,a.jsx)(d.p,{type:"number",placeholder:"起樓",className:"w-20 h-8 bg-zinc-950/50",value:s,onChange:e=>l(e.target.value)}),(0,a.jsx)("span",{className:"text-zinc-500",children:"~"}),(0,a.jsx)(d.p,{type:"number",placeholder:"迄樓",className:"w-20 h-8 bg-zinc-950/50",value:r,onChange:e=>i(e.target.value)})]}),(0,a.jsx)(u.$,{size:"sm",variant:"secondary",onClick:()=>N(j),className:"h-8 ml-2",children:"計算"})]}),g.length>0&&(0,a.jsxs)("div",{className:"flex flex-col gap-2",children:[(0,a.jsx)("div",{className:"flex flex-wrap gap-2",children:g.map(e=>{let t=!!j&&e>=j.start&&e<=j.end,s=!!j&&(e===j.start||e===j.end);return(0,a.jsx)("button",{type:"button",onPointerDown:()=>{m(!0),p(e),w(e,e)},onPointerEnter:()=>{x&&null!==h&&w(h,e)},className:`h-9 w-9 rounded-md border text-xs font-semibold transition ${t?s?"border-violet-400 bg-violet-500/25 text-violet-200 shadow-[0_0_12px_rgba(139,92,246,0.35)]":"border-violet-500/40 bg-violet-500/15 text-violet-300":"border-white/10 bg-zinc-950/50 text-zinc-400 hover:border-white/30 hover:text-zinc-200"}`,children:e},`floor-${e}`)})}),(0,a.jsx)("span",{className:"text-[11px] text-zinc-500",children:"可點選或拖曳選取樓層範圍"})]}),c&&(0,a.jsxs)("div",{className:"flex flex-wrap items-center gap-4 animate-in fade-in",children:[(0,a.jsxs)("div",{className:"flex flex-col",children:[(0,a.jsx)("span",{className:"text-xs text-zinc-500",children:"平均單價 (加權)"}),(0,a.jsxs)("span",{className:"text-lg font-bold text-violet-400",children:[c.avg.toFixed(2)," 萬/坪"]})]}),(0,a.jsxs)("div",{className:"flex flex-col",children:[(0,a.jsx)("span",{className:"text-xs text-zinc-500",children:"參考筆數"}),(0,a.jsxs)("span",{className:"text-sm text-zinc-300",children:[c.count," 筆"]})]})]})]})}function w({data:e,visibleSections:t=["grid","stats","comparison"],simpleMode:s=!1}){let[u,w]=(0,n.useState)(""),[b,v]=(0,n.useState)(!1),[y,z]=(0,n.useState)(.3),[S,M]=(0,n.useState)(14),[C,k]=(0,n.useState)(!1),[E,A]=(0,n.useState)(!1),P=(0,p.P)(e=>e.excludeCommercial),{counties:R,districts:F,transactionType:G,buildingType:O,dateRange:D,startDate:$,endDate:_}=(0,p.P)(),[q,H]=(0,n.useState)(null),[L,W]=(0,n.useState)(!1),I=n.useRef(null),B=n.useRef(null),V=n.useRef(null);if((0,n.useEffect)(()=>{!b&&e?.priceGridAnalysis?.projectNames?.length&&!u&&w(e.priceGridAnalysis.projectNames[0])},[e,u,b]),!e?.priceGridAnalysis)return null;let{projectNames:Z,byProject:K}=e.priceGridAnalysis,T=t.includes("grid"),J=t.includes("stats"),Q=t.includes("comparison"),U=e=>String(e??"").normalize("NFKC").replace(/\s+/g,"").trim().toLowerCase(),X=n.useMemo(()=>{if(!u||!e.transactionDetails)return null;let t=U(u);return t?e.transactionDetails.filter(e=>U(e["建案名稱"])===t):null},[u,e.transactionDetails]);(0,n.useEffect)(()=>{let e=!0;return(async()=>{if(!u||X&&X.length>0)return H(null);let t=R.map(e=>g.WG[e]||e).filter(Boolean);if(0===t.length)return;let s=$,a=_;if("custom"!==D&&(!s||!a)){let e=(0,j.P)(D);s=e.startDate||s,a=e.endDate||a}W(!0);try{let n=[];for(let l of t){let t=1,r=1/0;for(;n.length<r;){let i=await f.FH.fetchData({countyCode:l,districts:F,type:G,transactionType:G,projectNames:[u],buildingType:O,dateStart:s,dateEnd:a},{page:t,pageSize:1e3,totalRecords:0});if(!e)return;let c=i?.data||[],o="number"==typeof i?.count?i.count:null;if(n.push(...c),null!==o&&(r=o),c.length<1e3||null!==o&&n.length>=o||(t+=1)>20)break}}e&&H(n)}catch(t){console.warn("Fetch project transactions failed:",t),e&&H([])}finally{e&&W(!1)}})(),()=>{e=!1}},[u,X,R,F,G,O,D,$,_]);let Y=X&&X.length>0?X:q,ee=n.useMemo(()=>{if(!Y||0===Y.length)return{hasOffice:!1,hasResidential:!1,isMixed:!1};let e=Y.reduce((e,t)=>{let{isStorefront:s,isOffice:a}=(0,h.ZW)(t);return a&&(e.hasOffice=!0),a||s||(e.hasResidential=!0),e},{hasOffice:!1,hasResidential:!1});return{...e,isMixed:e.hasOffice&&e.hasResidential}},[Y]),et=n.useMemo(()=>!!Y&&0!==Y.length&&Y.some(e=>{let t=e["備註"]||e.note||"";return t.includes("親友")||t.includes("員工")||t.includes("關係人")||t.includes("關係戶")||t.includes("員工關係")}),[Y]);(0,n.useEffect)(()=>{u&&k(!ee.isMixed&&ee.hasOffice)},[u,ee.isMixed,ee.hasOffice]),(0,n.useEffect)(()=>{u&&A(!1)},[u]);let es=n.useMemo(()=>{if(!Y)return null;let e=Y;return P&&(e=e.filter(e=>{let{isStorefront:t,isOffice:s}=(0,h.ZW)(e);return!t&&!s})),e},[Y,P]),ea=!P&&C,en=n.useMemo(()=>{if(!u)return null;if(es&&es.length>0)try{return(0,h.e7)(es,y,S,{includeOfficePremium:ea,includeEmployeePremium:E})}catch(e){console.error("Heatmap generation error:",e)}return K[u]&&K[u].horizontalGrid?K[u]:null},[u,es,K,y,S,ea,E]),el=n.useMemo(()=>{let e=en?.summary?.calculationFlags;if(!e)return"排除店舖/辦公室";let t=[];return e.includesStorefrontPremium||t.push("店舖"),e.includesOfficePremium||t.push("辦公室"),e.includesEmployeePremium||t.push("員工關係戶"),t.length?`排除${t.join("/")}`:"全部納入"},[en?.summary?.calculationFlags]);return(0,a.jsxs)("div",{className:"space-y-6 animate-in fade-in slide-in-from-bottom-4 duration-500",children:[!s&&(0,a.jsx)("div",{className:"flex flex-col gap-4 bg-zinc-900/30 p-4 rounded-lg border border-white/5","data-report-control":"hide",children:(0,a.jsx)("div",{className:"flex flex-col lg:flex-row flex-wrap items-start lg:items-center gap-4",children:(0,a.jsxs)("div",{className:"flex flex-col sm:flex-row items-start sm:items-center gap-2 w-full lg:w-auto",children:[(0,a.jsxs)("div",{className:"flex items-center gap-2",children:[(0,a.jsx)("span",{className:"text-sm text-zinc-400 whitespace-nowrap",children:"選擇建案:"}),(0,a.jsx)("button",{onClick:()=>v(!b),className:`p-1 rounded transition-colors ${b?"text-violet-400 bg-violet-400/10":"text-zinc-500 hover:text-zinc-300"}`,title:b?"切換回下拉選單":"切換手動輸入",children:(0,a.jsx)(x.A,{className:"w-3.5 h-3.5"})})]}),b?(0,a.jsxs)("div",{className:"relative w-full sm:w-[280px]",children:[(0,a.jsx)(d.p,{value:u,onChange:e=>w(e.target.value),placeholder:"輸入建案名稱...",className:"w-full h-9 bg-zinc-950/50 pl-8 pr-4",list:"project-list",autoComplete:"off"}),(0,a.jsx)(m.A,{className:"absolute left-2.5 top-1/2 -translate-y-1/2 w-4 h-4 text-zinc-500"}),(0,a.jsx)("datalist",{id:"project-list",children:Z.map(e=>(0,a.jsx)("option",{value:e},e))})]}):(0,a.jsxs)(o.l,{value:u,onChange:e=>w(e.target.value),className:"w-full sm:w-[280px] bg-zinc-950/50",children:[(0,a.jsx)("option",{value:"",disabled:!0,children:"請選擇建案..."}),Z.map(e=>(0,a.jsx)("option",{value:e,children:e},e))]})]})})}),!s&&u&&es&&es.length>0&&(0,a.jsx)("div",{"data-report-control":"hide",children:(0,a.jsx)(c.t,{componentName:"FloorDiffAnalyzer",children:(0,a.jsx)(i.S,{transactions:es,currentPremium:y,onApply:e=>z(e),onManualChange:e=>z(e)})})}),!s&&u&&es&&es.length>0&&(0,a.jsx)("div",{"data-report-control":"hide",children:(0,a.jsx)(N,{transactions:es,project:u})}),!s&&(0,a.jsxs)("div",{className:"flex flex-wrap gap-4 p-4 bg-zinc-900/20 rounded-lg border border-white/5",children:[(0,a.jsxs)("div",{className:"flex items-center gap-2",children:[(0,a.jsx)("span",{className:"text-xs text-zinc-500",children:"溢價圖例:"}),(0,a.jsxs)("span",{className:"flex items-center gap-1",children:[(0,a.jsx)("span",{className:"w-4 h-4 rounded bg-red-500/80"}),(0,a.jsx)("span",{className:"text-xs text-zinc-400",children:"> 5%"})]}),(0,a.jsxs)("span",{className:"flex items-center gap-1",children:[(0,a.jsx)("span",{className:"w-4 h-4 rounded bg-orange-500/80"}),(0,a.jsx)("span",{className:"text-xs text-zinc-400",children:"2-5%"})]}),(0,a.jsxs)("span",{className:"flex items-center gap-1",children:[(0,a.jsx)("span",{className:"w-4 h-4 rounded bg-yellow-500/80"}),(0,a.jsx)("span",{className:"text-xs text-zinc-400",children:"0-2%"})]}),(0,a.jsxs)("span",{className:"flex items-center gap-1",children:[(0,a.jsx)("span",{className:"w-4 h-4 rounded bg-green-500/80"}),(0,a.jsx)("span",{className:"text-xs text-zinc-400",children:"< 0%"})]})]}),(0,a.jsx)("div",{className:"ml-auto"})]}),T&&(0,a.jsx)(l.q,{title:"建案銷控表與調價熱力圖",description:"可視化建案各戶別的銷售狀況與價格調整幅度",containerRef:I,headerAction:s?null:(0,a.jsxs)("div",{className:"flex flex-wrap items-center gap-2",children:[!P&&ee.hasOffice&&(0,a.jsxs)("div",{className:"flex items-center gap-2",children:[(0,a.jsx)("span",{className:"text-xs text-zinc-400 whitespace-nowrap",children:"事務所/商辦調價"}),(0,a.jsx)("button",{onClick:()=>k(e=>!e),className:`px-2 h-8 rounded border text-[11px] transition ${C?"border-cyan-400 text-cyan-300 bg-cyan-500/10":"border-white/10 text-zinc-400 hover:text-zinc-200 hover:border-white/30"}`,title:C?"已納入事務所/商辦調價":"排除事務所/商辦調價",children:C?"納入":"排除"}),ee.isMixed&&(0,a.jsx)("span",{className:"text-[11px] text-zinc-500 whitespace-nowrap",children:"混合用途預設排除"})]}),et&&(0,a.jsxs)("div",{className:"flex items-center gap-2",children:[(0,a.jsx)("span",{className:"text-xs text-zinc-400 whitespace-nowrap",children:"員工關係戶調價"}),(0,a.jsx)("button",{onClick:()=>A(e=>!e),className:`px-2 h-8 rounded border text-[11px] transition ${E?"border-cyan-400 text-cyan-300 bg-cyan-500/10":"border-white/10 text-zinc-400 hover:text-zinc-200 hover:border-white/30"}`,title:E?"已納入員工關係戶調價":"排除員工關係戶調價",children:E?"納入":"排除"})]}),(0,a.jsxs)("div",{className:"flex items-center gap-2 bg-zinc-950/40 border border-white/10 rounded-lg px-2 py-1","data-report-control":"hide",children:[(0,a.jsx)("span",{className:"text-xs text-zinc-400",children:"基準天數"}),(0,a.jsx)(d.p,{type:"number",min:"1",max:"365",value:S,onChange:e=>M(Number(e.target.value)||14),className:"w-16 h-8 bg-zinc-950/50 text-right pr-2"}),(0,a.jsx)("span",{className:"text-xs font-mono text-violet-400 whitespace-nowrap",children:"天"})]})]}),children:en?(0,a.jsx)(c.t,{componentName:"PricingHeatmap (Grid)",children:(0,a.jsx)(r.t,{data:en,floorPremium:y,showGrid:!0,showSummary:!1,showComparison:!1})}):(0,a.jsx)("div",{className:"text-zinc-500 text-center p-12",children:"請選擇建案以查看銷控表"})}),J&&en?.summary&&(0,a.jsx)(l.q,{title:`調價幅度統計摘要 (${el})`,containerRef:B,children:(0,a.jsx)(c.t,{componentName:"PricingHeatmap (Summary)",children:(0,a.jsx)(r.t,{data:en,showGrid:!1,showSummary:!0,showComparison:!1})})}),Q&&en?.horizontalComparison&&en.horizontalComparison.length>0&&(0,a.jsx)(l.q,{title:"戶型水平價差與溢價貢獻",containerRef:V,children:(0,a.jsx)(c.t,{componentName:"PricingHeatmap (Comparison)",children:(0,a.jsx)(r.t,{data:en,showGrid:!1,showSummary:!1,showComparison:!0,configProject:u,rawTransactions:es||void 0})})})]})}}}]);