"use strict";(self.webpackChunk_N_E=self.webpackChunk_N_E||[]).push([[3894],{39734:(e,t,r)=>{r.d(t,{g:()=>d});var a=r(12115),i=r(27529),n=r(88743),o=r(55873),s=r(98883),l=r(89579),c=r(56722);function m(e,t){var r,a;return t?e?(t.transactionDetails&&Array.isArray(t.transactionDetails)&&(e.transactionDetails||(e.transactionDetails=[]),e.transactionDetails=[...e.transactionDetails,...t.transactionDetails]),e.coreMetrics=function(e,t){if(!t)return e;if(!e)return t;let r=(e.totalSaleAmount||0)+(t.totalSaleAmount||0),a=(e.totalHouseArea||0)+(t.totalHouseArea||0);return{totalSaleAmount:r,totalHouseArea:a,overallAveragePrice:a>0?r/a:0,transactionCount:(e.transactionCount||0)+(t.transactionCount||0),medianPrice:0,q1Price:0,q3Price:0,minPrice:Math.min(e.minPrice||1/0,t.minPrice||1/0),maxPrice:Math.max(e.maxPrice||0,t.maxPrice||0)}}(e.coreMetrics,t.coreMetrics),t.projectRanking&&Array.isArray(t.projectRanking)&&(e.projectRanking=[...e.projectRanking,...t.projectRanking]),e.priceBandAnalysis=function(e,t){if(!t)return e;let r=Array.isArray(e)?e:e?.details||[],a=Array.isArray(t)?t:t?.details||[],i=e?.locationCrossTable||{},n=t?.locationCrossTable||{},o=e?.allDistricts||[],s=t?.allDistricts||[],l=e?.allRoomTypes||[],c=t?.allRoomTypes||[],m=new Map,u=e=>{let t=null!==e.bathrooms&&void 0!==e.bathrooms?String(e.bathrooms):"null",r=(e.roomType||"").replace(/\s+/g,""),a=`${r}-${t}`,i=Number(e.count)||0,n=Number(e.avgPrice)||0,o=Number(e.minPrice)||0,s=Number(e.maxPrice)||0;if(m.has(a)){let t=m.get(a),r=Number(t.count)||0,l=Number(t.avgPrice)||0,c=n*i,u=r+i,d=u>0?(l*r+c)/u:0;if(t.count=u,t.avgPrice=parseFloat(d.toFixed(2)),t.minPrice=Math.min(t.minPrice,o),t.maxPrice=Math.max(t.maxPrice,s),e.projectNames){let r=new Set([...t.projectNames,...e.projectNames]);t.projectNames=Array.from(r)}e.byDistrict&&Object.entries(e.byDistrict).forEach(([e,r])=>{t.byDistrict[e]=(t.byDistrict[e]||0)+r})}else m.set(a,{...e,roomType:r,count:i,avgPrice:n,minPrice:o,maxPrice:s,projectNames:e.projectNames?[...e.projectNames]:[],byDistrict:e.byDistrict?{...e.byDistrict}:{}})};r.forEach(u),a.forEach(u);let d={...i};Object.entries(n).forEach(([e,t])=>{d[e]?Object.entries(t).forEach(([t,r])=>{d[e][t]=(d[e][t]||0)+r}):d[e]={...t}});let f=Array.from(new Set([...o,...s])).sort(),y=Array.from(new Set([...l,...c])).sort();return{details:Array.from(m.values()),locationCrossTable:d,allDistricts:f,allRoomTypes:y}}(e.priceBandAnalysis,t.priceBandAnalysis),e.unitPriceAnalysis=function(e,t){if(!t)return e;let r=(e,t)=>{if(!t)return e;if(!e)return t;let r=(e.count||0)+(t.count||0);if(0===r)return e;let a={arithmetic:0,weighted:0},i=(e,t)=>"number"==typeof e.avgPrice?e.weightedAvgPrice||e.avgPrice:e.avgPrice?.[t]||0;["arithmetic","weighted"].forEach(n=>{let o=i(e,n),s=i(t,n);a[n]=(o*(e.count||0)+s*(t.count||0))/r});let n=Math.min(e.minPrice,t.minPrice),o=Math.max(e.maxPrice,t.maxPrice);return{count:r,avgPrice:a,minPrice:n,maxPrice:o,minPriceProject:e.minPrice<t.minPrice?e.minPriceProject:t.minPriceProject,maxPriceProject:e.maxPrice>t.maxPrice?e.maxPriceProject:t.maxPriceProject,medianPrice:0,q1Price:0,q3Price:0}},a=r(e.residentialStats,t.residentialStats),i=r(e.officeStats,t.officeStats),n=r(e.storeStats,t.storeStats),o=[...e.typeComparison||[]];return t.typeComparison&&(o=[...o,...t.typeComparison]),{residentialStats:a,officeStats:i,storeStats:n,typeComparison:o}}(e.unitPriceAnalysis,t.unitPriceAnalysis),e.transactionDetails&&e.transactionDetails.length>0&&function(e,t){if(!e||!t||0===t.length)return;let r=new l.B$(t),a=[],i={price:0,area:0,count:0},n=[],o={price:0,area:0,count:0},s=[],m={price:0,area:0,count:0},d=()=>({minPrice:1/0,maxPrice:-1/0,minRecord:null,maxRecord:null}),f=d(),y=d(),g=d();t.forEach(e=>{let t=e["建物型態"],r=e["主要用途"],l=e["房屋單價(萬)"],c=e["房屋總價(萬)"]||0,u=e["建物移轉總面積"]||0;if("number"!=typeof l||l<=0)return;let d=a,p=i,_=f,P=String(e["樓層"]||e.floor||e.layer||""),h="1"===P||"001"===P||P.includes("一樓"),v=t?.includes("店")||"商業用"===r||e.buildingType?.includes("店")||"商業用"===e.mainPurpose||e["備註"]?.includes("店")||e.note?.includes("店"),S=t?.includes("辦公")||t?.includes("廠辦")||t?.includes("事務所")||r?.includes("辦公")||e.buildingType?.includes("辦公")||e.buildingType?.includes("廠辦")||e.buildingType?.includes("事務所")||e.mainPurpose?.includes("辦公");v&&h?(d=s,p=m,_=g):(S||v&&!h)&&(d=n,p=o,_=y),d.push(l),p.price+=c,p.area+=u,p.count+=1,l>_.maxPrice&&(_.maxPrice=l,_.maxRecord=e),l<_.minPrice&&(_.minPrice=l,_.minRecord=e)});let p=(e,t,a,i)=>{e&&(function(e,t){if(!t||0===t.length){e.medianPrice=0,e.q1Price=0,e.q3Price=0;return}t.sort((e,t)=>e-t),e.medianPrice=u(t,.5),e.q1Price=u(t,.25),e.q3Price=u(t,.75)}(e,t),e.count=a.count,e.avgPrice=a.count>0?t.reduce((e,t)=>e+t,0)/a.count:0,e.weightedAvgPrice=a.area>0?a.price/a.area:0,i.maxRecord&&(e.maxPrice=i.maxPrice,e.maxPriceProject=i.maxRecord["建案名稱"],e.maxPriceUnit=(0,c.n)(i.maxRecord,r),e.maxPriceFloor=i.maxRecord["樓層"]),i.minRecord&&(e.minPrice=i.minPrice,e.minPriceProject=i.minRecord["建案名稱"],e.minPriceUnit=(0,c.n)(i.minRecord,r),e.minPriceFloor=i.minRecord["樓層"]))};e.residentialStats&&p(e.residentialStats,a,i,f),e.officeStats&&p(e.officeStats,n,o,y),e.storeStats&&p(e.storeStats,s,m,g);let _=new Map;t.forEach(e=>{let t=e["建案名稱"];if(!t)return;_.has(t)||_.set(t,{resSum:{price:0,area:0,count:0},shopSum:{price:0,area:0,count:0},officeSum:{price:0,area:0,count:0},county:e["縣市"],district:e["行政區"]});let r=_.get(t),a=e["建物型態"],i=e["主要用途"],n=e["房屋單價(萬)"],o=e["房屋總價(萬)"]||0,s=e["建物移轉總面積"]||0;if("number"!=typeof n||n<=0)return;let l=String(e["樓層"]||e.floor||e.layer||""),c="1"===l||"001"===l||l.includes("一樓"),m=a?.includes("店")||"商業用"===i||e.buildingType?.includes("店")||"商業用"===e.mainPurpose||e["備註"]?.includes("店")||e.note?.includes("店"),u=a?.includes("辦公")||a?.includes("廠辦")||a?.includes("事務所")||i?.includes("辦公")||e.buildingType?.includes("辦公")||e.buildingType?.includes("廠辦")||e.buildingType?.includes("事務所")||e.mainPurpose?.includes("辦公");m&&c?(r.shopSum.price+=o,r.shopSum.area+=s,r.shopSum.count+=1):u||m&&!c?(r.officeSum.price+=o,r.officeSum.area+=s,r.officeSum.count+=1):(r.resSum.price+=o,r.resSum.area+=s,r.resSum.count+=1)});let P=[];_.forEach((e,t)=>{let r=e.resSum.area>0?e.resSum.price/e.resSum.area:0,a=e.shopSum.area>0?e.shopSum.price/e.shopSum.area:0,i=e.officeSum.area>0?e.officeSum.price/e.officeSum.area:0;r>0&&(a>0||i>0)&&P.push({projectName:t,county:e.county,district:e.district,residentialAvg:r,shopAvg:a,officeAvg:i,shopMultiple:r>0?a/r:0,officeMultiple:r>0?i/r:0})}),P.sort((e,t)=>e.projectName.localeCompare(t.projectName))}(e.unitPriceAnalysis,e.transactionDetails),e.parkingAnalysis=function(e,t){if(!t)return e;let r=e.parkingRatio,a=t.parkingRatio,i=null;if(r&&a){let e=r.withParking.count,t=r.withoutParking.count,n=a.withParking.count,o=a.withoutParking.count,s=e+n,l=t+o,c=s+l;i={withParking:{count:s,percentage:c>0?s/c*100:0},withoutParking:{count:l,percentage:c>0?l/c*100:0}}}else i=r||a;let n=new Map,o=e=>{if(n.has(e.type)){let t=n.get(e.type),r=t.count+e.count,a=t.transactionCount+e.transactionCount,i=t.avgPrice,o=e.avgPrice,s=a>0?(i*t.transactionCount+o*e.transactionCount)/a:0;t.count=r,t.transactionCount=a,t.avgPrice=s}else n.set(e.type,{...e})};(e.avgPriceByType||[]).forEach(o),(t.avgPriceByType||[]).forEach(o);let s=Array.from(n.values()),l=new Map,c=e=>{if(l.has(e.floor)){let t=l.get(e.floor),r=t.count+e.count;e.rawRecords&&(t.rawRecords=[...t.rawRecords||[],...e.rawRecords]);let a=r>0?(t.avgPrice*t.count+e.avgPrice*e.count)/r:0;t.count=r,t.avgPrice=a,t.minPrice=Math.min(t.minPrice,e.minPrice),t.maxPrice=Math.max(t.maxPrice,e.maxPrice),e.maxPrice>t.maxPrice&&(t.maxPriceProject=e.maxPriceProject,t.maxPriceUnit=e.maxPriceUnit,t.maxPriceFloor=e.maxPriceFloor),e.minPrice<t.minPrice&&(t.minPriceProject=e.minPriceProject,t.minPriceUnit=e.minPriceUnit,t.minPriceFloor=e.minPriceFloor)}else l.set(e.floor,{...e,rawRecords:e.rawRecords?[...e.rawRecords]:[]})};return(e.rampPlanePriceByFloor||[]).forEach(c),(t.rampPlanePriceByFloor||[]).forEach(c),{parkingRatio:i,avgPriceByType:s,rampPlanePriceByFloor:Array.from(l.values())}}(e.parkingAnalysis,t.parkingAnalysis),e.salesVelocityAnalysis=function(e,t){if(!t)return e;let r=e.overall||{},a=t.overall||{},i=r.transactionCount||0,n=a.transactionCount||0,o=i+n,s={avgDaysToSell:0,medianDaysToSell:0,fastestSale:0,transactionCount:o};o>0&&(s.avgDaysToSell=((r.avgDaysToSell||0)*i+(a.avgDaysToSell||0)*n)/o,s.fastestSale=Math.min(void 0!==r.fastestSale?r.fastestSale:1/0,void 0!==a.fastestSale?a.fastestSale:1/0),s.fastestSale===1/0&&(s.fastestSale=0),s.medianDaysToSell=((r.medianDaysToSell||0)*i+(a.medianDaysToSell||0)*n)/o);let l=new Map,c=e=>{if(!e)return;let t=e.roomType;if(l.has(t)){let r=l.get(t),a=r.count+e.count,i=r.avgDays||0,n=e.avgDays||0;r.avgDays=a>0?(i*r.count+n*e.count)/a:0,r.count=a}else l.set(t,{...e})};(e.byRoomType||[]).forEach(c),(t.byRoomType||[]).forEach(c);let m=Array.from(l.values()),u=Array.from(new Set([...e.allRoomTypes||[],...t.allRoomTypes||[]])),d={};return["monthly","quarterly","yearly","weekly"].forEach(r=>{let a=e[r]||{},i=t[r]||{},n={};new Set([...Object.keys(a),...Object.keys(i)]).forEach(e=>{let t=a[e]||{},r=i[e]||{},o=new Set([...Object.keys(t),...Object.keys(r)]),s={};o.forEach(e=>{let a=t[e],i=r[e];if(a&&i){let t=a.count+i.count,r=a.priceSum+i.priceSum,n=a.areaSum+i.areaSum;s[e]={count:t,priceSum:r,areaSum:n,avgPrice:n>0?r/n:0}}else a?s[e]={...a}:i&&(s[e]={...i})}),n[e]=s}),d[r]=n}),{overall:s,byRoomType:m,allRoomTypes:u,...d}}(e.salesVelocityAnalysis,t.salesVelocityAnalysis),r=e.priceGridAnalysis,e.priceGridAnalysis=(a=t.priceGridAnalysis)?{projectNames:[...r.projectNames||[],...a.projectNames||[]],byProject:{...r.byProject||{},...a.byProject||{}}}:r,e.areaDistributionAnalysis=function(e,t){if(!t)return e;if(!e)return t;let r={...e};return Object.keys(t).forEach(e=>{r[e]?r[e]=[...r[e],...t[e]]:r[e]=[...t[e]]}),r}(e.areaDistributionAnalysis,t.areaDistributionAnalysis),e):JSON.parse(JSON.stringify(t)):e}function u(e,t){let r=(e.length-1)*t,a=Math.floor(r);return void 0!==e[a+1]?parseFloat((e[a]+(r-a)*(e[a+1]-e[a])).toFixed(2)):parseFloat(e[a].toFixed(2))}function d(){let e=(0,n.P)(),[t,r]=(0,a.useState)(!1),[l,c]=(0,a.useState)(null),[u,d]=(0,a.useState)(null),f=(0,a.useCallback)(async()=>{r(!0),c(null),d(null),e.setAnalysisData(null);let t=!1;try{let a=e.counties.map(e=>({name:e,code:o.WG[e]||e})),n=a.map(e=>e.code);if(0===n.length)return c("請至少選擇一個縣市"),r(!1),!1;let{dateRange:l,startDate:u,endDate:f}=e;if("custom"!==l&&(!u||!f)){let e=(0,s.P)(l);e.startDate&&e.endDate&&(u=e.startDate,f=e.endDate)}let y={districts:e.districts,transactionType:e.transactionType,type:e.transactionType,projectNames:e.projectNames,buildingType:e.buildingType,excludeCommercial:e.excludeCommercial,floorPremium:e.floorPremium,dateRange:l,dateStart:u,dateEnd:f},g=e=>{if(!e)return null;let t=e.match(/^(\d{4})[-\/](\d{2})[-\/](\d{2})$/);if(t){let e=Number(t[1]),r=Number(t[2]),a=Number(t[3]);if(!Number.isFinite(e)||!Number.isFinite(r)||!Number.isFinite(a))return null;let i=new Date(Date.UTC(e,r-1,a));return Number.isNaN(i.getTime())?null:i}let r=new Date(e);return Number.isNaN(r.getTime())?null:r},p=e=>{let t=e.getUTCFullYear(),r=String(e.getUTCMonth()+1).padStart(2,"0"),a=String(e.getUTCDate()).padStart(2,"0");return`${t}-${r}-${a}`},_=(e,t)=>{let r=new Date(e.getTime());return r.setUTCDate(r.getUTCDate()+t),r},P=(e,t,r)=>{let a=[],i=e;for(;i.getTime()<=t.getTime();){let e=_(i,r-1);e.getTime()>t.getTime()&&(e=t),a.push({dateStart:p(i),dateEnd:p(e)}),i=_(e,1)}return a},h=e=>!!(e?.projectRanking&&e?.coreMetrics),v=((e,t)=>{let r=g(e),a=g(t);if(!r||!a||r.getTime()>a.getTime())return null;let i=a.getTime()-r.getTime(),n=Math.floor(i/864e5)+1;return{start:r,end:a,totalDays:n}})(u,f),S=!!(v&&v.totalDays>=360),w=()=>{d(e=>{if(!e)return e;let t=Math.min(e.completed+1,e.total);return{...e,completed:t}})},D=async(e,t,r)=>{if(!v)throw Error("無法解析日期區間，無法進行分段查詢。");let a=P(v.start,v.end,r),n=null,o=0,s=[];for(let r of a){d(e=>e?{...e,currentCounty:t,currentRange:`${r.dateStart} ~ ${r.dateEnd}`}:e);try{let a={...y,countyCode:e,counties:[e],dateStart:r.dateStart,dateEnd:r.dateEnd},l=await i.FH.analyzeProjectRanking(a);if(h(l))n=m(n,l),o++;else if("message"in l&&l.message)s.push(l.message);else if("error"in l&&l.error)throw Error(l.error);else throw Error(`縣市 ${t} 分段查詢回傳格式異常`)}finally{w()}}return 0===o?s.length>0?{message:s[0]}:{error:`縣市 ${t} 在此區間無可用資料`}:{data:n}},b=async(e,t)=>{let r=v?`${p(v.start)} ~ ${p(v.end)}`:void 0,a={...y,countyCode:e,counties:[e]},n=!1;try{if(S&&v){n=!0;let r=v.totalDays>=720?120:180;return console.warn(`[useAnalysisData] ${t} 區間過長，改用 ${r} 天分段查詢。`),await D(e,t,r)}d(e=>e?{...e,currentCounty:t,currentRange:r}:e);let o=await i.FH.analyzeProjectRanking(a);if(h(o))return{data:o};if("message"in o&&o.message)return{message:o.message};if("error"in o&&o.error)return{error:o.error};return{error:`縣市 ${t} 回傳格式異常`}}catch(r){if(v&&v.totalDays>=90){console.warn(`[useAnalysisData] ${t} 單次查詢失敗，改用分段查詢。`,r);try{var o;return n=!0,(o=P(v.start,v.end,90).length-1)&&d(e=>{if(!e)return e;let t=Math.max(e.completed,e.total+o);return{...e,total:t}}),await D(e,t,90)}catch(e){return{error:e?.message||r?.message||"未知錯誤"}}}return{error:r?.message||"未知錯誤"}}finally{n||w()}},k=async(e,t,r)=>{let a=Array(e.length),i=0,n=Array.from({length:Math.min(t,e.length)},async()=>{for(;;){let t=i++;if(t>=e.length)break;a[t]=await r(e[t],t)}});return await Promise.all(n),a};console.log("[useAnalysisData] Analyzing with counties:",n);let T=S&&v?a.reduce(e=>{let t=v.totalDays>=720?120:180;return e+P(v.start,v.end,t).length},0):a.length;d({total:Math.max(T,1),completed:0,currentCounty:a[0]?.name,currentRange:v?`${p(v.start)} ~ ${p(v.end)}`:void 0});let x=await k(a,S?1:2,e=>b(e.code,e.name)),A=null,j=0,R=[],N=[],E=[];for(let e=0;e<x.length;e++){let t=x[e],r=a[e]?.name||n[e]||"未知";t?.data&&t.data.projectRanking&&t.data.coreMetrics?(console.log("Merging result for county:",t.data.projectRanking?.[0]?.county||r),A=m(A,t.data),j++):(t?.message?R.push(`[${r}] ${t.message}`):t?.error?N.push(`[${r}] ${t.error}`):N.push(`[${r}] 回傳格式異常`),E.push(r))}if(console.log("Aggregation complete. Total Transaction Details:",A?.transactionDetails?.length),0===j){if(e.projectNames.length>0)throw Error("這段時間 這個建案查詢不到資料");if(R.length>0)throw Error(R[0]);if(N.length>0)throw Error(N[0]);throw Error("無法取得任何縣市的分析數據")}if(j<n.length){let e=n.length-j,t=E.length>0?`（${E.join("、")}）`:"";c(`注意：有 ${e} 個縣市的資料載入失敗${t}，分析結果可能不完整。`)}e.setAnalysisData(A),t=!0}catch(e){console.error("Analysis failed:",e),c(e.message||"無法取得分析數據，請稍後再試。"),t=!1}finally{r(!1),d(null)}return t},[e]);return{loading:t,error:l,analysisData:e.analysisData,analysisProgress:u,handleAnalyze:f,setError:c,setLoading:r,setAnalysisData:e.setAnalysisData}}},85993:(e,t,r)=>{r.d(t,{T:()=>o});var a=r(1934),i=r(16385);let n={map_mode:{key:"map_mode",is_active:!0,default_min_role:"user",overrides:{}},floor_plan:{key:"floor_plan",is_active:!0,default_min_role:"user",overrides:{}},report_builder:{key:"report_builder",is_active:!0,default_min_role:"pro",overrides:{}},export_report:{key:"export_report",is_active:!0,default_min_role:"pro",overrides:{}},market_heatmap:{key:"market_heatmap",is_active:!0,default_min_role:"pro",overrides:{user:{access:"time_limited",start_time:new Date().toISOString(),end_time:new Date(Date.now()+2592e6).toISOString(),is_manual_override:!0}}},price_analysis:{key:"price_analysis",is_active:!0,default_min_role:"pro",overrides:{user:{access:"time_limited",start_time:new Date().toISOString(),end_time:new Date(Date.now()+2592e6).toISOString(),is_manual_override:!0}}},total_price_analysis:{key:"total_price_analysis",is_active:!0,default_min_role:"pro",overrides:{user:{access:"time_limited",start_time:new Date().toISOString(),end_time:new Date(Date.now()+2592e6).toISOString(),is_manual_override:!0}}},policy_timeline:{key:"policy_timeline",is_active:!0,default_min_role:"pro",overrides:{user:{access:"time_limited",start_time:new Date().toISOString(),end_time:new Date(Date.now()+2592e6).toISOString(),is_manual_override:!0}}},sales_velocity:{key:"sales_velocity",is_active:!0,default_min_role:"pro",overrides:{user:{access:"time_limited",start_time:new Date().toISOString(),end_time:new Date(Date.now()+2592e6).toISOString(),is_manual_override:!0}}},parking_analysis:{key:"parking_analysis",is_active:!0,default_min_role:"pro",overrides:{user:{access:"time_limited",start_time:new Date().toISOString(),end_time:new Date(Date.now()+2592e6).toISOString(),is_manual_override:!0}}},transaction_list:{key:"transaction_list",is_active:!0,default_min_role:"pro",overrides:{user:{access:"time_limited",start_time:new Date().toISOString(),end_time:new Date(Date.now()+2592e6).toISOString(),is_manual_override:!0}}},share_report:{key:"share_report",is_active:!0,default_min_role:"pro",overrides:{user:{access:"time_limited",start_time:new Date().toISOString(),end_time:new Date(Date.now()+2592e6).toISOString(),is_manual_override:!0}}},system_settings:{key:"system_settings",is_active:!0,default_min_role:"user",overrides:{}},system_announcement:{key:"system_announcement",is_active:!0,default_min_role:"user",overrides:{}},admin_panel:{key:"admin_panel",is_active:!0,default_min_role:"admin",overrides:{}},manage_members:{key:"manage_members",is_active:!0,default_min_role:"admin",overrides:{}},delete_members:{key:"delete_members",is_active:!0,default_min_role:"super_admin",overrides:{}},manage_projects:{key:"manage_projects",is_active:!0,default_min_role:"admin",overrides:{}},post_annoucement:{key:"post_annoucement",is_active:!0,default_min_role:"admin",overrides:{}},upload_tools:{key:"upload_tools",is_active:!0,default_min_role:"admin",overrides:{}},edit_permissions:{key:"edit_permissions",is_active:!0,default_min_role:"super_admin",overrides:{}},manage_plans:{key:"manage_plans",is_active:!0,default_min_role:"admin",overrides:{}},dashboard_metrics:{key:"dashboard_metrics",is_active:!0,default_min_role:"user",overrides:{}}},o=(0,a.v)((e,t)=>({flags:n,isLoading:!0,error:null,fetchFlags:async()=>{e({isLoading:!0,error:null});try{let{data:t,error:r}=await i.N.from("feature_flags").select("*");if(r){console.warn("Failed to fetch feature flags (using defaults):",r.message),e({isLoading:!1});return}if(t&&t.length>0){let r={...n};t.forEach(e=>{r[e.key]&&(r[e.key]={...r[e.key],...e,overrides:e.overrides||{}})}),e({flags:r,isLoading:!1})}else e({isLoading:!1})}catch(t){console.error("Feature flag fetch error:",t),e({isLoading:!1,error:t.message})}},updateFlag:async(r,a)=>{let n=t().flags,o=n[r],s={...o,...a};e({flags:{...n,[r]:s}});try{let{error:e}=await i.N.from("feature_flags").upsert({key:r,is_active:s.is_active,default_min_role:s.default_min_role,overrides:s.overrides,updated_at:new Date().toISOString()});if(e)throw e}catch(t){throw console.error("Failed to update feature flag:",t),e({flags:{...n,[r]:o}}),t}},checkAccess:(e,r)=>{let a=t().flags[e];if(!a||!a.is_active)return{allowed:!1,reason:"default"};let i=r||"user",n=a.overrides[i];if(n){if("granted"===n.access)return{allowed:!0,reason:"override"};if("denied"===n.access)return{allowed:!1,reason:"override"};if("time_limited"===n.access){let e=new Date().getTime(),t=n.start_time?new Date(n.start_time).getTime():0,r=n.end_time?new Date(n.end_time).getTime():1/0;return e>=t&&e<=r?{allowed:!0,reason:"beta",remainingTime:r-e}:{allowed:!1,reason:"override"}}}let o=["user","pro","pro_max","admin","super_admin"];return o.indexOf(i)>=o.indexOf(a.default_min_role||"user")?{allowed:!0,reason:"default"}:{allowed:!1,reason:"default"}}}))}}]);