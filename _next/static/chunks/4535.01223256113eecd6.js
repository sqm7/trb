(self.webpackChunk_N_E=self.webpackChunk_N_E||[]).push([[4535],{6296:(e,t,r)=>{"use strict";r.d(t,{A:()=>a});let a=(0,r(78340).A)("loader-circle",[["path",{d:"M21 12a9 9 0 1 1-6.219-8.56",key:"13zald"}]])},14535:(e,t,r)=>{"use strict";r.r(t),r.d(t,{default:()=>j});var a=r(95155),l=r(12115),n=r(36379),s=r.n(n);r(23879);var i=r(56572),o=r(33024),c=r(6296),u=r(16385),d=r(34198),p=r(55873),f=r(27529),m=r(41463);let h=[121.5318,25.0478],y=m.env.NEXT_PUBLIC_METRO_GEOJSON_URL,g=["https://overpass-api.de/api/interpreter","https://overpass.kumi.systems/api/interpreter","https://overpass.nchc.org.tw/api/interpreter"],b=e=>e*Math.PI/180,x=(e,t)=>{let r=b(t[1]-e[1]),a=b(t[0]-e[0]);return 12742*Math.asin(Math.sqrt(Math.sin(r/2)**2+Math.cos(b(e[1]))*Math.cos(b(t[1]))*Math.sin(a/2)**2))},v=e=>e.replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/"/g,"&quot;").replace(/'/g,"&#039;"),w=e=>null==e||""===e?"-":String(e);function j({projects:e=[],refreshToken:t,onMetaChange:r,panelCollapsed:n=!1}){let m=(0,l.useRef)(null),b=(0,l.useRef)(null),[j,S]=(0,l.useState)(!1),k="1GYoblfxWX2uc8edFcbq",[N,z]=(0,l.useState)(k?"topo-v2":"demo"),[C,E]=(0,l.useState)(!0),[_,A]=(0,l.useState)(!1),[L,T]=(0,l.useState)("idle"),[F,R]=(0,l.useState)(""),[$,M]=(0,l.useState)([]),[P,O]=(0,l.useState)(!1),[D,I]=(0,l.useState)(!1),[B,G]=(0,l.useState)([]),[J,U]=(0,l.useState)("idle"),[W,K]=(0,l.useState)(null),[q,H]=(0,l.useState)(null),[Z,V]=(0,l.useState)(0),[Y,X]=(0,l.useState)(null),[Q,ee]=(0,l.useState)({zoning:{visible:!1,opacity:.6},cadastral:{visible:!1,opacity:.6}}),[et,er]=(0,l.useState)(e),[ea,el]=(0,l.useState)(!1),[en,es]=(0,l.useState)(null),[ei,eo]=(0,l.useState)("idle"),[ec,eu]=(0,l.useState)(null),[ed,ep]=(0,l.useState)(12),[ef,em]=(0,l.useState)(18),[eh,ey]=(0,l.useState)([]),[eg,eb]=(0,l.useState)([]),[ex,ev]=(0,l.useState)([]),[ew,ej]=(0,l.useState)([]),[eS,ek]=(0,l.useState)(!1),[eN,ez]=(0,l.useState)(null),[eC,eE]=(0,l.useState)([]),[e_,eA]=(0,l.useState)(!1),[eL,eT]=(0,l.useState)(null),[eF,eR]=(0,l.useState)([]),[e$,eM]=(0,l.useState)(!1),[eP,eO]=(0,l.useState)(null),[eD,eI]=(0,l.useState)(!1),[eB,eG]=(0,l.useState)(.85),[eJ,eU]=(0,l.useState)(!1),[eW,eK]=(0,l.useState)(.8),[eq,eH]=(0,l.useState)(!1),[eZ,eV]=(0,l.useState)(.8),[eY,eX]=(0,l.useState)("idle"),[eQ,e0]=(0,l.useState)(null),e1=(0,l.useRef)(Q),e2=(0,l.useRef)(C),e5=(0,l.useRef)(N),e3=(0,l.useRef)(_),e8=(0,l.useRef)(null),e6=(0,l.useRef)(null),e4=(0,l.useRef)(null),e9=(0,l.useRef)(new Map),e7=(0,l.useRef)(null),te=(0,l.useRef)(null),tt=(0,l.useRef)(null),tr=(0,l.useRef)(null),ta=(0,l.useRef)(null),tl=(0,l.useRef)(null),tn=(0,l.useRef)(!1),ts=(0,l.useRef)(null),ti=(0,l.useRef)(null),to=(0,l.useRef)(0),tc=(0,l.useRef)(null),tu=(0,l.useRef)(null),td=(0,l.useRef)(null),tp=(0,l.useRef)(null),tf=(0,l.useRef)(null),tm=(0,l.useRef)([]),th=(0,l.useRef)([]),ty=(0,l.useRef)(!1),tg=(0,l.useRef)([]),tb=(0,l.useRef)({visible:!1,opacity:.85}),tx=(0,l.useRef)({visible:!1,opacity:.8}),tv=(0,l.useRef)({visible:!1,opacity:.8}),tw=(0,l.useRef)(null),tj=(0,l.useRef)(null),tS=(0,l.useRef)(null),tk=(0,l.useRef)(!1),tN=(0,l.useCallback)(()=>{r?.({count:et.length,isLoading:ea,error:en,status:ei,hasMore:!!ec})},[et.length,ea,en,ei,ec,r]);(0,l.useEffect)(()=>{tN()},[tN]);let tz=(0,l.useMemo)(()=>Object.keys(p.WG).map(e=>({label:e,value:e})),[]),tC=(0,l.useMemo)(()=>0===eh.length?[]:eh.flatMap(e=>(p.Ib[e]||[]).map(t=>({label:t,value:t,group:e}))),[eh]),tE=(0,l.useMemo)(()=>Object.keys(p.WG),[]),t_=(0,l.useCallback)(e=>e.replace(/台/g,"臺").replace(/\s/g,"").trim(),[]),tA=(0,l.useCallback)(e=>{let t,r=[],a=e=>{if("string"!=typeof e)return;let t=e.trim();t&&r.push(t)};a(e?.text),a(e?.place_name),e?.properties&&(a(e.properties.county),a(e.properties.city),a(e.properties.region),a(e.properties.state),a(e.properties.district),a(e.properties.locality)),Array.isArray(e?.context)&&e.context.forEach(e=>{a(e?.text),a(e?.name)});let l=r.map(t_),n=tE.find(e=>l.some(t=>t.includes(t_(e))));return n&&(t=(p.Ib[n]||[]).find(e=>l.some(t=>t.includes(t_(e))))),{county:n,district:t}},[tE,t_]),tL=(0,l.useCallback)(e=>{if(!e?.center)return;let[t,r]=e.center,a=[t,r];X(a);let l=tA(e);if(l.county&&eh.includes(l.county)){let e=p.Ib[l.county]||[],t=l.district&&e.includes(l.district)?[l.district]:[];t.length>0&&eb(t)}H({lng:t,lat:r,label:e.text||e.place_name||"地址"});let n=b.current;n&&n.flyTo({center:a,zoom:Math.max(n.getZoom(),16),speed:1.4})},[tA,eh]);(0,l.useEffect)(()=>{if(!k)return;if(0===eh.length){M([]),H(null),O(!1);return}let e=F.trim();if(e.length<2){M([]),H(null),O(!1),G([]),U("idle"),K(null);return}return e4.current&&window.clearTimeout(e4.current),e6.current&&e6.current.abort(),O(!0),e4.current=window.setTimeout(async()=>{let t=new AbortController;e6.current=t;try{let r=b.current,a=r?r.getCenter():{lng:h[0],lat:h[1]},l=`https://api.maptiler.com/geocoding/${encodeURIComponent(e)}.json?key=${k}&language=zh&limit=6&proximity=${a.lng},${a.lat}`,n=await fetch(l,{signal:t.signal});if(!n.ok)throw Error(`Geocoding error ${n.status}`);let s=await n.json(),i=(Array.isArray(s?.features)?s.features:[]).filter(e=>{let t=tA(e);return t.county&&eh.includes(t.county)});if(M(i),i[0]?.center){let[e,t]=i[0].center;H({lng:e,lat:t,label:i[0].text||i[0].place_name||"地址"})}else H(null)}catch(e){if(e?.name==="AbortError")return;M([])}finally{O(!1)}},320),()=>{e4.current&&window.clearTimeout(e4.current),e6.current&&e6.current.abort()}},[F,k,eh,tA]);let tT=(0,l.useCallback)(e=>{e.length>6||(ey(e),eb(t=>t.filter(t=>e.some(e=>(p.Ib[e]||[]).includes(t)))),ej([]),ev([]),eE([]),R(""),M([]),X(null),H(null),G([]),U("idle"),K(null),eT(null))},[]),tF=(0,l.useCallback)(e=>{eb(e),ej([]),ev([]),eE([]),eT(null)},[]),tR=(0,l.useCallback)(async e=>{let t=e.trim();if(0===eh.length||t.length<2)return void ev([]);ek(!0),ez(null);try{let e=eh.map(async e=>{let r=p.WG[e],a=eg.filter(t=>(p.Ib[e]||[]).includes(t));return f.FH.fetchProjectNameSuggestions(r,t,a).then(t=>{let r=[];return Array.isArray(t)?r=t:t&&t.data&&Array.isArray(t.data)?r=t.data:t&&t.names&&Array.isArray(t.names)&&(r=t.names),r.map(t=>{let r="string"==typeof t,a=r?t:t.name||t.建案名稱||String(t);return{label:a,value:a,group:e,details:r?void 0:{county:e,district:t.district||t.行政區,date:t.earliestDate||t.交易日}}})}).catch(t=>(console.error(`Failed to fetch projects for ${e}:`,t),[]))}),r=(await Promise.all(e)).flat(),a=Array.from(new Map(r.map(e=>[e.value,e])).values());ev(a)}catch(e){console.error("Project search error:",e),ez("搜尋失敗，請稍後再試")}finally{ek(!1)}},[eh,eg]),t$=(0,l.useCallback)(e=>{ts.current&&clearTimeout(ts.current),ts.current=setTimeout(()=>{tR(e)},300)},[tR]),tM=(0,l.useCallback)(e=>{R(e),t$(e)},[t$]);(0,l.useEffect)(()=>()=>{ts.current&&clearTimeout(ts.current)},[]),(0,l.useEffect)(()=>{if(!D)return;let e=e=>{tt.current&&!tt.current.contains(e.target)&&I(!1)};return document.addEventListener("mousedown",e),()=>document.removeEventListener("mousedown",e)},[D]);let tP=(0,l.useMemo)(()=>{let e=new Map,t=$.map((t,r)=>{let a=t?.id?String(t.id):`${t?.center?.[0]}-${t?.center?.[1]}-${r}`,l=`addr:${a}`;e.set(l,t);let n=tA(t);return{label:t.text||t.place_name||"地址",value:l,group:"地址搜尋",details:n.county||n.district?{county:n.county,district:n.district}:void 0}});return e9.current=e,t},[$,tA]),tO=(0,l.useMemo)(()=>Array.from(new Map([...tP,...B,...ex].map(e=>[e.value,e])).values()),[tP,B,ex]),tD=(0,l.useCallback)(e=>{let t=e.filter(e=>e.startsWith("addr:")),r=e.filter(e=>!e.startsWith("addr:"));t.length>0&&t.forEach(e=>{let t=e9.current.get(e);t&&tL(t)}),ej(r),0===r.length&&(eE([]),eT(null))},[tL]),tI=(0,l.useCallback)(async()=>{if(0===eg.length||0===eh.length){eR([]),eO(null);return}eM(!0),eO(null);try{let e=eh.map(async e=>{let t=p.WG[e],r=eg.filter(t=>(p.Ib[e]||[]).includes(t));return r.length?f.FH.fetchProjectNameSuggestions(t,"",r).then(e=>{let t=[];return Array.isArray(e)?t=e:e&&e.data&&Array.isArray(e.data)?t=e.data:e&&e.names&&Array.isArray(e.names)&&(t=e.names),t.map(e=>"string"==typeof e?e:e.name||e.建案名稱||String(e)).filter(Boolean)}).catch(t=>(console.error(`Failed to fetch district projects for ${e}:`,t),[])):[]}),t=(await Promise.all(e)).flat(),r=Array.from(new Set(t));eR(r)}catch(e){console.error("District project list error:",e),eO("行政區建案清單載入失敗"),eR([])}finally{eM(!1)}},[eh,eg]);(0,l.useEffect)(()=>{tI()},[tI]);let tB=(0,l.useCallback)(async e=>{if(0!==e.length){eA(!0),eT(null);try{let{data:t}=await u.N.auth.getSession(),r=t?.session?.access_token;if(!r)throw Error("無效的授權金鑰");let a=eh.length>0?eh.map(e=>p.WG[e]).filter(Boolean).map(e=>e.toLowerCase()):"all",l=await fetch("https://zxbmbbfrzbtuueysicoc.supabase.co/functions/v1/map-projects",{method:"POST",headers:{"Content-Type":"application/json",Authorization:`Bearer ${r}`},body:JSON.stringify({countyCode:a,projectNames:e,limit:Math.max(200,20*e.length)})});if(!l.ok){let e=await l.json();throw Error(e.error||`HTTP Error: ${l.status}`)}let n=await l.json(),i=(Array.isArray(n?.projects)?n.projects:[]).map(e=>{let t=Number(e.latitude),r=Number(e.longitude);return Number.isFinite(t)&&Number.isFinite(r)?{lat:t,lng:r,name:e.project_name||"建案"}:null}).filter(Boolean);if(eE(i),0===i.length)return void eT("找不到建案座標");let o=b.current;if(o)if(1===i.length)o.flyTo({center:[i[0].lng,i[0].lat],zoom:Math.max(ed,16),speed:1.4});else{let e=new(s()).LngLatBounds;i.forEach(t=>e.extend([t.lng,t.lat])),o.fitBounds(e,{padding:80,maxZoom:Math.max(ed,16)})}}catch(e){console.error("Locate projects error:",e),eT(e.message||"定位失敗")}finally{eA(!1)}}},[eh,ed]);(0,l.useEffect)(()=>{0!==ew.length&&tB(ew)},[ew,tB]);let tG=(0,l.useCallback)(()=>{let e=b.current;if(!e)return null;let t=e.getBounds(),r=e.getZoom(),a={south:t.getSouth(),west:t.getWest(),north:t.getNorth(),east:t.getEast()},l=e.getCenter(),n=Math.abs(a.north-a.south),s=Math.abs(a.east-a.west);return{bbox:a,zoom:r,maxSpanKm:Math.max(111*n,111*s*Math.cos(l.lat*Math.PI/180))}},[]),tJ=(0,l.useCallback)((e,t)=>{let r=new Map;return e.forEach(e=>r.set(`${e.county_code}-${e.id}`,e)),t.forEach(e=>r.set(`${e.county_code}-${e.id}`,e)),Array.from(r.values())},[]),tU=(0,l.useCallback)(async({append:e=!1,cursor:t}={})=>{let r=tG();if(!r)return;if(r.zoom<ed){eo("zoom"),es(null),e||(er([]),eu(null));return}if(ef>0&&r.maxSpanKm>ef){eo("range"),es(null),e||(er([]),eu(null));return}if(eg.length>0){if(e$)return void eo("loading");if(0===eF.length){er([]),eu(null),eo("ready");return}}let a=[r.bbox.south.toFixed(5),r.bbox.west.toFixed(5),r.bbox.north.toFixed(5),r.bbox.east.toFixed(5),r.zoom,ed,ef].join("|");if(e){if(ti.current?.key&&ti.current.key!==a)return tU({append:!1})}else ti.current={key:a,bbox:r.bbox,zoom:r.zoom},eu(null);let l=to.current+1;to.current=l,el(!0),es(null),eo("loading");try{let{data:a}=await u.N.auth.getSession(),n=a?.session?.access_token;if(!n)throw Error("無效的授權金鑰");let s=eh.length>0?eh.map(e=>p.WG[e]).filter(Boolean).map(e=>e.toLowerCase()):"all",i=eg.length>0?eF:null,o=await fetch("https://zxbmbbfrzbtuueysicoc.supabase.co/functions/v1/map-projects",{method:"POST",headers:{"Content-Type":"application/json",Authorization:`Bearer ${n}`},body:JSON.stringify({countyCode:s,projectNames:i&&i.length>0?i:void 0,bbox:r.bbox,zoom:r.zoom,limit:800,cursor:e?t:null})});if(!o.ok){let e=await o.json();throw Error(e.error||`HTTP Error: ${o.status}`)}let c=await o.json();if(to.current!==l)return;let d=Array.isArray(c?.projects)?c.projects:[];er(t=>e?tJ(t,d):d),eu(c?.nextCursor??null),eo("ready")}catch(e){if(to.current!==l)return;console.error("Failed to fetch map projects:",e),es(e.message||"載入建案資料失敗"),eo("error")}finally{to.current===l&&el(!1)}},[tG,tJ,ed,ef,eh,eg,eF,e$]);(0,l.useEffect)(()=>{void 0!==t&&tU({append:!1})},[t,tU]),(0,l.useEffect)(()=>{tU({append:!1})},[ed,ef,eh,eg,eF,tU]);let tW=(0,l.useMemo)(()=>[{id:"zoning",label:"國土利用現況調查成果圖",tiles:"https://wmts.nlsc.gov.tw/wmts/LUIMAP/default/GoogleMapsCompatible/{z}/{y}/{x}"},{id:"cadastral",label:"段籍圖（地籍）",tiles:"https://wmts.nlsc.gov.tw/wmts/LANDSECT/default/GoogleMapsCompatible/{z}/{y}/{x}"}],[]),tK=(0,l.useMemo)(()=>{let e={id:"osm",label:"OSM 標準",supportsTheme:!1,style:{version:8,name:"OpenStreetMap Standard",sources:{"osm-tiles":{type:"raster",tiles:["https://tile.openstreetmap.org/{z}/{x}/{y}.png"],tileSize:256,attribution:"\xa9 OpenStreetMap contributors"}},layers:[{id:"osm-tiles",type:"raster",source:"osm-tiles",minzoom:0,maxzoom:19}]}},t={id:"dark",label:"黑底",supportsTheme:!1,style:{version:8,name:"Dark Matter",sources:{"carto-dark":{type:"raster",tiles:["https://basemaps.cartocdn.com/dark_all/{z}/{x}/{y}.png"],tileSize:256,attribution:"\xa9 OpenStreetMap contributors \xa9 CARTO"}},layers:[{id:"carto-dark",type:"raster",source:"carto-dark",minzoom:0,maxzoom:19}]}},r=k?[{id:"topo-v2",label:"地形",url:`https://api.maptiler.com/maps/topo-v2/style.json?key=${k}`,supportsTheme:!1}]:[];return k?[e,t,...r]:[e,t,{id:"demo",label:"開源預設",url:"https://demotiles.maplibre.org/style.json"}]},[k]),tq={dark:i.A,"topo-v2":o.A,osm:i.A,demo:i.A},tH=(0,l.useCallback)(e=>{let t=e.getStyle();t?.layers&&t.layers.forEach(t=>{"symbol"!==t.type||t.layout?.["text-field"]&&e.setLayoutProperty(t.id,"text-field",["coalesce",["get","name:zh-Hant"],["get","name:zh"],["get","name"],["get","name:en"]])})},[]),tZ=(0,l.useCallback)(e=>{e.getSource("osm-levels")||e.addSource("osm-levels",{type:"geojson",data:{type:"FeatureCollection",features:[]}}),e.getLayer("osm-levels-points")||e.addLayer({id:"osm-levels-points",type:"circle",source:"osm-levels",paint:{"circle-color":"#38bdf8","circle-radius":4,"circle-opacity":.7,"circle-stroke-color":"#22d3ee","circle-stroke-width":1}}),e.getLayer("osm-levels-label")||e.addLayer({id:"osm-levels-label",type:"symbol",source:"osm-levels",layout:{"text-field":["get","levelsLabel"],"text-size":11,"text-anchor":"center","text-allow-overlap":!0},paint:{"text-color":"#e2e8f0","text-halo-color":"#0b0d13","text-halo-width":1.1}})},[]),tV=(0,l.useCallback)((e,t)=>{let r=t?"visible":"none";e.getLayer("osm-levels-points")&&e.setLayoutProperty("osm-levels-points","visibility",r),e.getLayer("osm-levels-label")&&e.setLayoutProperty("osm-levels-label","visibility",r)},[]),tY=(0,l.useCallback)(e=>{e.getSource("search-point")||e.addSource("search-point",{type:"geojson",data:{type:"FeatureCollection",features:[]}}),e.getLayer("search-point-layer")||e.addLayer({id:"search-point-layer",type:"circle",source:"search-point",paint:{"circle-color":"#22d3ee","circle-radius":6,"circle-stroke-color":"#0ea5e9","circle-stroke-width":2,"circle-opacity":.9}})},[]),tX=(0,l.useCallback)(e=>{e.getSource("project-distance")||e.addSource("project-distance",{type:"geojson",data:{type:"FeatureCollection",features:[]}}),e.getLayer("project-distance-line")||e.addLayer({id:"project-distance-line",type:"line",source:"project-distance",filter:["==","$type","LineString"],paint:{"line-color":"#f59e0b","line-width":2,"line-opacity":.85}}),e.getLayer("project-distance-label")||e.addLayer({id:"project-distance-label",type:"symbol",source:"project-distance",filter:["==","$type","Point"],layout:{"text-field":["get","label"],"text-size":12,"text-anchor":"center","text-allow-overlap":!0},paint:{"text-color":"#fde68a","text-halo-color":"#111827","text-halo-width":1.2}})},[]),tQ=(0,l.useCallback)(e=>{let t=e.getSource("project-distance");if(!t)return;let r=tf.current;if(!r)return void t.setData({type:"FeatureCollection",features:[]});let a=r.coordinates,l=[(a[0][0]+a[1][0])/2,(a[0][1]+a[1][1])/2];t.setData({type:"FeatureCollection",features:[{type:"Feature",properties:{label:r.label},geometry:{type:"LineString",coordinates:a}},{type:"Feature",properties:{label:r.label},geometry:{type:"Point",coordinates:l}}]})},[]),t0=(0,l.useCallback)(e=>{e.getSource("project-points")||e.addSource("project-points",{type:"geojson",data:{type:"FeatureCollection",features:[]}}),e.getLayer("project-points-layer")||e.addLayer({id:"project-points-layer",type:"circle",source:"project-points",paint:{"circle-color":["case",["boolean",["get","isSelected"],!1],"#f59e0b",["boolean",["get","filterActive"],!1],"#2dd4bf","#22d3ee"],"circle-radius":["case",["boolean",["get","isSelected"],!1],7,5],"circle-opacity":["case",["boolean",["get","dim"],!1],.35,.9],"circle-stroke-color":["case",["boolean",["get","isSelected"],!1],"#fcd34d",["boolean",["get","filterActive"],!1],"#99f6e4","#67e8f9"],"circle-stroke-width":["case",["boolean",["get","isSelected"],!1],2,1.2]}}),e.getSource("project-locate")||e.addSource("project-locate",{type:"geojson",data:{type:"FeatureCollection",features:[]}}),e.getLayer("project-locate-layer")||e.addLayer({id:"project-locate-layer",type:"circle",source:"project-locate",paint:{"circle-color":"#f59e0b","circle-radius":8,"circle-opacity":.85,"circle-stroke-color":"#fef3c7","circle-stroke-width":2}})},[]),t1=(0,l.useCallback)(e=>{let t=e.getSource("project-points");if(t){let e=new Set(th.current),r=th.current.length>0,a=ty.current,l=tm.current.map(t=>{let l=Number(t.latitude),n=Number(t.longitude);if(!Number.isFinite(l)||!Number.isFinite(n))return null;let s=e.has(t.project_name);return{type:"Feature",properties:{id:t.id,project_name:t.project_name,developer:t.developer,contractor:t.contractor,architect:t.architect,sales_agent:t.sales_agent,affiliated_companies:t.affiliated_companies,construction_license:t.construction_license,total_households:t.total_households,community_unit_count:t.community_unit_count,total_floors:t.total_floors,basement_floors:t.basement_floors,structure:t.structure,public_ratio:t.public_ratio,site_area:t.site_area,land_use_zoning:t.land_use_zoning,land_plot_number:t.land_plot_number,parking_type:t.parking_type,parking_count:t.parking_count,enrichment_status:t.enrichment_status,isSelected:s,dim:r&&!s,filterActive:a},geometry:{type:"Point",coordinates:[n,l]}}}).filter(Boolean);t.setData({type:"FeatureCollection",features:l})}let r=e.getSource("project-locate");if(r){let e=tg.current.map(e=>({type:"Feature",properties:{name:e.name},geometry:{type:"Point",coordinates:[e.lng,e.lat]}}));r.setData({type:"FeatureCollection",features:e})}},[]),t2=(0,l.useCallback)(e=>{e.getSource("village-boundary")||e.addSource("village-boundary",{type:"raster",tiles:["https://wmts.nlsc.gov.tw/wmts/VILLAGE/default/GoogleMapsCompatible/{z}/{y}/{x}"],tileSize:256}),e.getLayer("village-boundary-layer")||e.addLayer({id:"village-boundary-layer",type:"raster",source:"village-boundary",layout:{visibility:"none"},minzoom:13,paint:{"raster-opacity":tb.current.opacity}})},[]),t5=(0,l.useCallback)(e=>{e.getLayer("village-boundary-layer")&&(e.setLayoutProperty("village-boundary-layer","visibility",tb.current.visible?"visible":"none"),e.setPaintProperty("village-boundary-layer","raster-opacity",tb.current.opacity))},[]),t3=(0,l.useCallback)(e=>{e.getSource("district-boundary")||e.addSource("district-boundary",{type:"raster",tiles:["https://wmts.nlsc.gov.tw/wmts/TOWN/default/GoogleMapsCompatible/{z}/{y}/{x}"],tileSize:256}),e.getLayer("district-boundary-layer")||e.addLayer({id:"district-boundary-layer",type:"raster",source:"district-boundary",layout:{visibility:"none"},minzoom:8,paint:{"raster-opacity":tx.current.opacity}})},[]),t8=(0,l.useCallback)(e=>{e.getLayer("district-boundary-layer")&&(e.setLayoutProperty("district-boundary-layer","visibility",tx.current.visible?"visible":"none"),e.setPaintProperty("district-boundary-layer","raster-opacity",tx.current.opacity))},[]),t6=(0,l.useCallback)(e=>{e.getSource("metro-lines")||e.addSource("metro-lines",{type:"geojson",data:{type:"FeatureCollection",features:[]}}),e.getLayer("metro-lines-layer")||e.addLayer({id:"metro-lines-layer",type:"line",source:"metro-lines",layout:{"line-join":"round","line-cap":"round",visibility:"none"},paint:{"line-color":"#f97316","line-width":["interpolate",["linear"],["zoom"],9,1.2,14,3.2],"line-opacity":tv.current.opacity}})},[]),t4=(0,l.useCallback)(e=>{e.getLayer("metro-lines-layer")&&(e.setLayoutProperty("metro-lines-layer","visibility",tv.current.visible?"visible":"none"),e.setPaintProperty("metro-lines-layer","line-opacity",tv.current.opacity))},[]),t9=(0,l.useCallback)(async e=>{if(16>e.getZoom())return void T("zoom");let t=e.getBounds(),r=Math.abs(t.getNorth()-t.getSouth()),a=Math.abs(t.getEast()-t.getWest());if(r>.12||a>.12)return void T("zoom");let l=`${t.getSouth()},${t.getWest()},${t.getNorth()},${t.getEast()}`;if(l===tl.current)return;tl.current=l,tr.current&&tr.current.abort();let n=new AbortController;tr.current=n,T("loading");let s=`[out:json][timeout:25];
(
  way["building"]["building:levels"](${l});
  way["building"]["levels"](${l});
);
out center;`,i=null;for(let e of["https://overpass-api.de/api/interpreter","https://overpass.kumi.systems/api/interpreter","https://overpass.nchc.org.tw/api/interpreter"])try{let t=await fetch(e,{method:"POST",body:s,signal:n.signal,headers:{"Content-Type":"text/plain"}});if(!t.ok)throw Error(`OSM fetch failed: ${t.status}`);i=await t.json();break}catch(e){if(e?.name==="AbortError")return;i=null}if(!i)return void T("error");let o=(i?.elements||[]).filter(e=>"way"===e.type&&e.center).map(e=>{let t=e.tags||{},r=Number.parseInt(t["building:levels"]||t.levels,10);return r&&e.center?{type:"Feature",properties:{id:e.id,levels:r,levelsLabel:`${r}F`},geometry:{type:"Point",coordinates:[e.center.lon,e.center.lat]}}:null}).filter(Boolean);e.getSource("osm-levels").setData({type:"FeatureCollection",features:o}),T("ready")},[]),t7=(0,l.useCallback)(async e=>{if(y){if(tk.current)return void eX("ready");tw.current&&tw.current.abort();let t=new AbortController;tw.current=t,eX("loading"),e0(null);try{let r=await fetch(y,{signal:t.signal});if(!r.ok)throw Error(`Metro GeoJSON fetch failed: ${r.status}`);let a=await r.json(),l=e.getSource("metro-lines");a?.type==="FeatureCollection"?l.setData(a):l.setData({type:"FeatureCollection",features:[]}),tk.current=!0,eX("ready")}catch(e){if(e?.name==="AbortError")return;eX("error"),e0("捷運路線載入失敗")}return}if(10>e.getZoom())return void eX("zoom");let t=e.getBounds(),r=`${t.getSouth()},${t.getWest()},${t.getNorth()},${t.getEast()}`;if(r===tS.current)return;tS.current=r,tw.current&&tw.current.abort();let a=new AbortController;tw.current=a,eX("loading"),e0(null);let l=`[out:json][timeout:25];
(
  way["railway"="subway"](${r});
  way["railway"="light_rail"](${r});
);
out geom;`,n=null;for(let e of g)try{let t=await fetch(e,{method:"POST",body:l,signal:a.signal,headers:{"Content-Type":"text/plain"}});if(!t.ok)throw Error(`Metro fetch failed: ${t.status}`);n=await t.json();break}catch(e){if(e?.name==="AbortError")return;n=null}if(!n){eX("error"),e0("捷運路線載入失敗");return}let s=(n?.elements||[]).filter(e=>"way"===e.type&&Array.isArray(e.geometry)).map(e=>{let t=(e.geometry||[]).map(e=>[e.lon,e.lat]);return t.length<2?null:{type:"Feature",properties:{id:e.id,name:e.tags?.name||"",ref:e.tags?.ref||""},geometry:{type:"LineString",coordinates:t}}}).filter(Boolean);e.getSource("metro-lines").setData({type:"FeatureCollection",features:s}),eX("ready")},[]),re=(0,l.useCallback)(e=>{if(!e2.current)return;let t=e.getStyle();if(!t?.layers)return;let r=t.layers.find(e=>"symbol"===e.type&&e.layout?.["text-field"])?.id,a=e.getSource("openmaptiles")?"openmaptiles":e.getSource("maptiler")?"maptiler":null;!a||e.getLayer("3d-buildings")||e.addLayer({id:"3d-buildings",source:a,"source-layer":"building",type:"fill-extrusion",minzoom:15,paint:{"fill-extrusion-color":["interpolate",["linear"],["coalesce",["get","render_height"],["get","height"],6],0,"#1f2937",20,"#334155",50,"#38bdf8",100,"#f97316",200,"#ef4444"],"fill-extrusion-height":["coalesce",["get","render_height"],["get","height"],6],"fill-extrusion-base":["coalesce",["get","render_min_height"],["get","min_height"],0],"fill-extrusion-opacity":.85}},r)},[]);(0,l.useEffect)(()=>{if(!m.current||b.current)return;let e=tK.find(e=>e.id===N),t=e?.url??e?.style??"https://demotiles.maplibre.org/style.json",r=new(s()).Map({container:m.current,style:t,center:h,zoom:14,pitch:45,bearing:-15,antialias:!0,attributionControl:!1});r.addControl(new(s()).NavigationControl({showCompass:!0}),"top-right"),r.addControl(new(s()).AttributionControl({compact:!0}),"bottom-left"),r.on("style.load",()=>{if(re(r),tW.forEach(e=>{if(!e.tiles)return;let t=`gov-${e.id}`,a=`gov-${e.id}-layer`;r.getSource(t)||r.addSource(t,{type:"raster",tiles:[e.tiles],tileSize:256}),r.getLayer(a)||r.addLayer({id:a,type:"raster",source:t,layout:{visibility:"none"},paint:{"raster-opacity":e1.current[e.id]?.opacity??.6}})}),tW.forEach(e=>{if(!e.tiles)return;let t=`gov-${e.id}-layer`;if(!r.getLayer(t))return;let a=e1.current[e.id];a&&(r.setLayoutProperty(t,"visibility",a.visible?"visible":"none"),r.setPaintProperty(t,"raster-opacity",a.opacity))}),tY(r),tZ(r),tV(r,e3.current),t0(r),tX(r),t1(r),tQ(r),t2(r),t5(r),t3(r),t8(r),t6(r),t4(r),tv.current.visible&&(tS.current=null,tk.current=!1,t7(r)),e3.current&&t9(r),e8.current){let e=r.getSource("search-point");e&&e.setData({type:"FeatureCollection",features:[{type:"Feature",properties:{},geometry:{type:"Point",coordinates:e8.current}}]})}tH(r),tn.current||(tn.current=!0,S(!0))}),b.current=r;let a=new ResizeObserver(()=>r.resize());return a.observe(m.current),()=>{a.disconnect(),r.remove(),b.current=null}},[]),(0,l.useEffect)(()=>{e2.current=C,e3.current=_,e8.current=Y,e1.current=Q;let e=b.current;if(e&&(tW.forEach(t=>{if(!t.tiles)return;let r=`gov-${t.id}-layer`;if(!e.getLayer(r))return;let a=Q[t.id];a&&(e.setLayoutProperty(r,"visibility",a.visible?"visible":"none"),e.setPaintProperty(r,"raster-opacity",a.opacity))}),Y)){let t=e.getSource("search-point");t&&t.setData({type:"FeatureCollection",features:[{type:"Feature",properties:{},geometry:{type:"Point",coordinates:Y}}]})}},[Q,tW,Y]),(0,l.useEffect)(()=>{let e=b.current;e&&j&&(t2(e),t5(e),t3(e),t8(e),t6(e),t4(e))},[j,eD,eB,eJ,eW,eq,eZ,t2,t5,t3,t8,t6,t4]),(0,l.useEffect)(()=>{let e=b.current;if(e){if(!C){e.getLayer("3d-buildings")&&e.removeLayer("3d-buildings"),e.easeTo({pitch:0,bearing:0,duration:450});return}re(e),e.easeTo({pitch:45,bearing:-15,duration:450})}},[C,re]),(0,l.useEffect)(()=>{let e=b.current;if(!e)return;let t=tK.find(e=>e.id===N);if(!t)return;let r=t.url??t.style;r&&e.setStyle(r,{diff:!1})},[N,tK]),(0,l.useEffect)(()=>{let e=b.current;if(e&&j){if(e5.current!==N){let t=tK.find(e=>e.id===N),r=t?.url??t?.style;r&&e.setStyle(r,{diff:!1})}e5.current=N}},[N,j,tK]),(0,l.useEffect)(()=>{let e=b.current;e&&j&&tH(e)},[j,tH]),(0,l.useEffect)(()=>{let e=b.current;e&&j&&V(e.getZoom())},[j]);let rt=(0,l.useCallback)(async e=>{if(!e||0===eh.length){G([]),U("idle");return}e7.current&&e7.current.abort();let t=new AbortController;e7.current=t,U("loading"),K(null);try{let r=[{label:"鄰近 0.5km",maxKm:.5},{label:"鄰近 0.75km",maxKm:.75},{label:"鄰近 1km",maxKm:1}],a=r[r.length-1].maxKm,l=a/111,n=a/(111*Math.cos(e.lat*Math.PI/180)),s={south:e.lat-l,north:e.lat+l,west:e.lng-n,east:e.lng+n},{data:i}=await u.N.auth.getSession(),o=i?.session?.access_token;if(!o)throw Error("無效的授權金鑰");let c=eh.map(e=>p.WG[e]).filter(Boolean).map(e=>e.toLowerCase()),d=await fetch("https://zxbmbbfrzbtuueysicoc.supabase.co/functions/v1/map-projects",{method:"POST",headers:{"Content-Type":"application/json",Authorization:`Bearer ${o}`},body:JSON.stringify({countyCode:c.length>0?c:"all",bbox:s,zoom:16,limit:800}),signal:t.signal});if(!d.ok){let e=await d.json();throw Error(e.error||`HTTP Error: ${d.status}`)}let f=await d.json(),m=Array.isArray(f?.projects)?f.projects:[],h=[],y=new Set;m.forEach(t=>{let a=Number(t.latitude),l=Number(t.longitude);if(!Number.isFinite(a)||!Number.isFinite(l))return;let n=x([l,a],[e.lng,e.lat]),s=r.find(e=>n<=e.maxKm);if(!s)return;let i=t.project_name||"建案",o=`${s.label}-${i}`;y.has(o)||(y.add(o),h.push({label:i,value:i,group:s.label}))});let g=new Map(r.map((e,t)=>[e.label,t]));h.sort((e,t)=>{let r=g.get(e.group||"")??99,a=g.get(t.group||"")??99;return r!==a?r-a:e.label.localeCompare(t.label)}),G(h),U("ready")}catch(e){if(e?.name==="AbortError")return;G([]),U("error"),K(e?.message||"鄰近建案載入失敗")}},[eh]);return(0,l.useEffect)(()=>{if(!q||0===eh.length){G([]),U("idle"),K(null);return}return te.current&&window.clearTimeout(te.current),te.current=window.setTimeout(()=>{rt(q)},280),()=>{te.current&&window.clearTimeout(te.current),e7.current&&e7.current.abort()}},[q,eh,rt]),(0,l.useEffect)(()=>{let e=b.current;if(!e||!j)return;tZ(e),tV(e,_),_?t9(e):T("idle");let t=()=>{V(e.getZoom()),e3.current&&(ta.current&&window.clearTimeout(ta.current),ta.current=window.setTimeout(()=>{t9(e)},400)),tv.current.visible&&(tj.current&&window.clearTimeout(tj.current),tj.current=window.setTimeout(()=>{t7(e)},450)),tc.current&&window.clearTimeout(tc.current),tc.current=window.setTimeout(()=>{tU({append:!1})},250)};return e.on("moveend",t),()=>{e.off("moveend",t),ta.current&&window.clearTimeout(ta.current),tj.current&&window.clearTimeout(tj.current),tc.current&&window.clearTimeout(tc.current)}},[j,_,tZ,tV,t9,t7,tU]),(0,l.useEffect)(()=>{let e=b.current;e&&j&&(t6(e),t4(e),eq?t7(e):(tw.current&&(tw.current.abort(),tw.current=null),tk.current=!1,tS.current=null,eX("idle"),e0(null)))},[j,eq,eZ,t6,t4,t7]),(0,l.useEffect)(()=>{j&&tU({append:!1})},[j,tU]),(0,l.useEffect)(()=>{if(2===eC.length){let e=eC[0],t=eC[1],r=x([e.lng,e.lat],[t.lng,t.lat]);tf.current={coordinates:[[e.lng,e.lat],[t.lng,t.lat]],label:`${r.toFixed(2)} km`}}else tf.current=null;tm.current=et,th.current=ew,ty.current=eh.length>0||eg.length>0,tg.current=eC,tb.current={visible:eD,opacity:eB},tx.current={visible:eJ,opacity:eW},tv.current={visible:eq,opacity:eZ};let e=b.current;e&&(t1(e),tQ(e),t5(e),t8(e),t4(e))},[et,ew,eh,eg,eC,eD,eB,eJ,eW,eq,eZ,t1,tQ,t5,t8,t4]),(0,l.useEffect)(()=>{let e=b.current;if(!e||!j)return;let t=t=>{let r=e.queryRenderedFeatures(t.point,{layers:["project-points-layer"]}),a=r?.[0];if(!a||"Point"!==a.geometry.type)return;let l=a.properties||{},n=v(l.project_name||"建案"),i=w(l.developer),o=v("-"===i?"未知建商":i),c=v(w(l.contractor)),u=v(w(l.architect)),d=v(w(l.sales_agent)),p=v(w(l.affiliated_companies)),f=v(w(l.construction_license)),m=v(w(l.total_households)),h=v(w(l.community_unit_count)),y=v(w(l.total_floors)),g=v(w(l.basement_floors)),b=v(w(l.public_ratio)),x=v(w(l.site_area)),j=v(w(l.structure)),S=v(w(l.land_use_zoning)),k=v(w(l.land_plot_number)),N=v(w(l.parking_type)),z=v(w(l.parking_count)),C="done"===l.enrichment_status,E=`
        <div class="min-w-[240px] text-sm text-zinc-100">
          <div class="flex items-start justify-between gap-3 border-b border-white/10 pb-2">
            <div>
              <div class="text-base font-semibold text-white">${n}</div>
              <div class="text-[12px] text-zinc-400">${o}</div>
            </div>
            ${C?'<span class="text-[10px] px-2 py-0.5 rounded-full bg-emerald-500/20 text-emerald-200">資料完備</span>':""}
          </div>
          <div class="grid grid-cols-2 gap-x-4 gap-y-2 mt-2 text-[12px]">
            <div><span class="text-zinc-500">總戶數</span><div class="text-zinc-200">${m}</div></div>
            <div><span class="text-zinc-500">社區戶數</span><div class="text-zinc-200">${h}</div></div>
            <div><span class="text-zinc-500">總樓層</span><div class="text-zinc-200">${y}</div></div>
            <div><span class="text-zinc-500">地下層</span><div class="text-zinc-200">${g}</div></div>
            <div><span class="text-zinc-500">公設比</span><div class="text-zinc-200">${b}</div></div>
            <div><span class="text-zinc-500">基地面積</span><div class="text-zinc-200">${x}</div></div>
            <div><span class="text-zinc-500">結構</span><div class="text-zinc-200">${j}</div></div>
            <div><span class="text-zinc-500">土地分區</span><div class="text-zinc-200">${S}</div></div>
            <div><span class="text-zinc-500">地號</span><div class="text-zinc-200">${k}</div></div>
            <div><span class="text-zinc-500">車位</span><div class="text-zinc-200">${z}</div></div>
            <div><span class="text-zinc-500">車位型式</span><div class="text-zinc-200">${N}</div></div>
            <div><span class="text-zinc-500">營造</span><div class="text-zinc-200">${c}</div></div>
            <div><span class="text-zinc-500">建築設計</span><div class="text-zinc-200">${u}</div></div>
            <div><span class="text-zinc-500">代銷企劃</span><div class="text-zinc-200">${d}</div></div>
            <div class="col-span-2"><span class="text-zinc-500">關係企業</span><div class="text-zinc-200">${p}</div></div>
            <div class="col-span-2"><span class="text-zinc-500">建造號碼</span><div class="text-zinc-200">${f}</div></div>
          </div>
        </div>
      `,_=a.geometry.coordinates;tu.current&&tu.current.remove(),tu.current=new(s()).Popup({closeButton:!0,closeOnClick:!0,className:"sqm-map-popup"}).setLngLat(_).setHTML(E).addTo(e)},r=t=>{let r=t.features?.[0];if(!r||"Point"!==r.geometry.type)return;let a=v(r.properties?.project_name||"建案"),l=r.geometry.coordinates;td.current||(td.current=new(s()).Popup({closeButton:!1,closeOnClick:!1,className:"sqm-map-tooltip",offset:12})),tp.current!==a&&(td.current.setHTML(`<div class="text-[11px] font-medium">${a}</div>`),tp.current=a),td.current.setLngLat(l).addTo(e),e.getCanvas().style.cursor="pointer"},a=()=>{e.getCanvas().style.cursor="",tp.current=null,td.current&&(td.current.remove(),td.current=null)};return e.on("click",t),e.on("mousemove","project-points-layer",r),e.on("mouseleave","project-points-layer",a),()=>{e.off("click",t),e.off("mousemove","project-points-layer",r),e.off("mouseleave","project-points-layer",a),td.current&&(td.current.remove(),td.current=null)}},[j]),(0,a.jsxs)("div",{className:"flex flex-col w-full h-full gap-2",children:[!n&&(0,a.jsxs)("div",{className:"flex flex-col gap-3 bg-zinc-900/90 backdrop-blur-md p-3 rounded-xl border border-white/10 shadow-lg flex-shrink-0 z-10 relative",children:[(0,a.jsxs)("div",{className:"flex flex-wrap items-center gap-4",children:[(0,a.jsx)("div",{className:"w-32",children:(0,a.jsx)(d.K,{options:tz,value:eh,onChange:tT,placeholder:"選擇縣市..."})}),(0,a.jsx)("div",{className:"w-32",children:(0,a.jsx)(d.K,{options:tC,value:eg,onChange:tF,placeholder:eh.length>0?"選擇行政區...":"請先選縣市",disabled:0===eh.length})}),(0,a.jsx)("div",{className:"flex-1 min-w-[260px]",children:(0,a.jsx)(d.K,{options:tO,value:ew,onChange:tD,placeholder:eh.length>0?"輸入地址或建案名稱...":"請先選縣市",onSearch:tM,loading:eS||P||"loading"===J,disabled:0===eh.length})}),(0,a.jsxs)("div",{className:"flex items-center gap-4 border-l border-white/10 pl-4",children:[(0,a.jsxs)("div",{className:"flex items-center gap-2",children:[(0,a.jsx)("span",{className:"text-[11px] text-zinc-300 whitespace-nowrap",children:"行政區界線"}),(0,a.jsxs)("label",{className:"relative inline-flex items-center cursor-pointer",children:[(0,a.jsx)("input",{type:"checkbox",checked:eJ,onChange:e=>eU(e.target.checked),className:"sr-only peer"}),(0,a.jsx)("div",{className:"w-8 h-4 bg-zinc-700 peer-focus:outline-none rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-3 after:w-3 after:transition-all peer-checked:bg-cyan-600"})]}),eJ&&(0,a.jsx)("input",{type:"range",min:.2,max:1,step:.05,value:eW,onChange:e=>eK(parseFloat(e.target.value)),className:"w-16 h-1 ml-1"})]}),(0,a.jsxs)("div",{className:"flex items-center gap-2",children:[(0,a.jsx)("span",{className:"text-[11px] text-zinc-300 whitespace-nowrap",children:"村里界線"}),(0,a.jsxs)("label",{className:"relative inline-flex items-center cursor-pointer",children:[(0,a.jsx)("input",{type:"checkbox",checked:eD,onChange:e=>eI(e.target.checked),className:"sr-only peer"}),(0,a.jsx)("div",{className:"w-8 h-4 bg-zinc-700 peer-focus:outline-none rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-3 after:w-3 after:transition-all peer-checked:bg-cyan-600"})]}),eD&&(0,a.jsx)("input",{type:"range",min:.2,max:1,step:.05,value:eB,onChange:e=>eG(parseFloat(e.target.value)),className:"w-16 h-1 ml-1"})]}),(0,a.jsxs)("div",{className:"flex items-center gap-2",children:[(0,a.jsx)("span",{className:"text-[11px] text-zinc-300 whitespace-nowrap",children:"捷運路線"}),(0,a.jsxs)("label",{className:"relative inline-flex items-center cursor-pointer",children:[(0,a.jsx)("input",{type:"checkbox",checked:eq,onChange:e=>eH(e.target.checked),className:"sr-only peer"}),(0,a.jsx)("div",{className:"w-8 h-4 bg-zinc-700 peer-focus:outline-none rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-3 after:w-3 after:transition-all peer-checked:bg-cyan-600"})]}),eq&&(0,a.jsx)("input",{type:"range",min:.2,max:1,step:.05,value:eZ,onChange:e=>eV(parseFloat(e.target.value)),className:"w-16 h-1 ml-1"})]})]}),(0,a.jsxs)("div",{className:"flex items-center gap-3 border-l border-white/10 pl-4",children:[(0,a.jsxs)("label",{className:"flex items-center gap-2 text-[11px] text-zinc-300 whitespace-nowrap cursor-pointer",children:[(0,a.jsx)("input",{type:"checkbox",checked:_,onChange:e=>A(e.target.checked),className:"h-3.5 w-3.5 accent-cyan-500 rounded border-zinc-700"}),"OSM 樓層"]}),(0,a.jsxs)("label",{className:"flex items-center gap-2 text-[11px] text-zinc-300 whitespace-nowrap cursor-pointer",children:[(0,a.jsx)("input",{type:"checkbox",checked:C,onChange:e=>E(e.target.checked),className:"h-3.5 w-3.5 accent-cyan-500 rounded border-zinc-700"}),"3D 建物"]})]}),(0,a.jsx)("div",{className:"flex items-center gap-1 border-l border-white/10 pl-4",children:tK.map(e=>{let t=tq[e.id]||i.A,r=N===e.id;return(0,a.jsx)("button",{onClick:()=>z(e.id),title:e.label,"aria-label":e.label,className:`h-7 w-7 flex items-center justify-center rounded-md border transition-all ${r?"bg-cyan-500/20 border-cyan-500 text-cyan-200":"bg-zinc-800/60 border-white/10 text-zinc-400 hover:border-white/30"}`,children:(0,a.jsx)(t,{className:"h-3.5 w-3.5"})},e.id)})}),(0,a.jsxs)("div",{ref:tt,className:"relative flex items-center gap-3 ml-auto border-l border-white/10 pl-4",children:[(0,a.jsxs)("button",{onClick:()=>I(e=>!e),className:"rounded-lg bg-zinc-800/70 border border-white/10 px-2.5 py-1.5 text-[11px] text-zinc-200 hover:border-white/30 whitespace-nowrap",children:["載入設定 z",ed," / ",ef,"k"]}),D&&(0,a.jsxs)("div",{className:"absolute right-0 top-full mt-2 w-52 bg-zinc-950/95 border border-white/10 rounded-xl p-3 shadow-xl z-[120]",children:[(0,a.jsxs)("div",{className:"flex items-center gap-2 text-[10px] text-zinc-400 justify-between",children:[(0,a.jsxs)("span",{children:["載入敏感度 (z",ed,")"]}),(0,a.jsx)("input",{type:"range",min:10,max:18,step:1,value:ed,onChange:e=>ep(parseInt(e.target.value,10)),className:"w-16 h-1"})]}),(0,a.jsxs)("div",{className:"flex items-center gap-2 text-[10px] text-zinc-400 justify-between mt-2",children:[(0,a.jsxs)("span",{children:["最大範圍 (",ef,"k)"]}),(0,a.jsx)("input",{type:"range",min:4,max:60,step:1,value:ef,onChange:e=>em(parseInt(e.target.value,10)),className:"w-16 h-1"})]})]}),ec&&(0,a.jsx)("button",{onClick:()=>tU({append:!0,cursor:ec}),disabled:ea,className:"hidden xl:block rounded bg-zinc-800 border border-white/10 px-2 py-1 text-[10px] text-zinc-200 hover:border-white/30 disabled:opacity-50 whitespace-nowrap",children:"分頁載入"})]})]}),(0,a.jsxs)("div",{className:"flex flex-wrap items-center gap-4 text-[10px] text-zinc-500 bg-black/20 px-2 py-1.5 rounded border border-white/5",children:[(0,a.jsxs)("div",{className:"flex gap-4 items-center flex-1",children:[eN&&(0,a.jsx)("span",{className:"text-rose-300",children:eN}),eP&&(0,a.jsx)("span",{className:"text-rose-300",children:eP}),eL&&(0,a.jsx)("span",{className:"text-rose-300",children:eL}),P&&(0,a.jsx)("span",{className:"text-cyan-300",children:"地址搜尋中..."}),"loading"===J&&(0,a.jsx)("span",{className:"text-cyan-300",children:"鄰近建案載入中..."}),W&&(0,a.jsx)("span",{className:"text-rose-300",children:W}),eQ&&(0,a.jsx)("span",{className:"text-rose-300",children:eQ}),e_&&(0,a.jsx)("span",{className:"text-cyan-300",children:"定位中..."}),e$&&(0,a.jsxs)("span",{className:"text-cyan-300 flex items-center gap-1",children:[(0,a.jsx)(c.A,{className:"h-2.5 w-2.5 animate-spin"})," 讀取行政區清單"]}),"zoom"===ei&&(0,a.jsxs)("span",{className:"text-amber-300",children:["請放大至 z",ed,"+"]}),"range"===ei&&(0,a.jsxs)("span",{className:"text-amber-300",children:["範圍內縮至 ",ef,"km"]}),eD&&Z>0&&Z<13&&(0,a.jsx)("span",{className:"text-amber-300",children:"村里界線需放大至 z13+"}),eq&&"zoom"===eY&&(0,a.jsx)("span",{className:"text-amber-300",children:"捷運路線需放大至 z10+"}),"loading"===ei&&(0,a.jsxs)("span",{className:"text-cyan-300 flex items-center gap-1",children:[(0,a.jsx)(c.A,{className:"h-2.5 w-2.5 animate-spin"})," 建案載入中"]}),"error"===ei&&(0,a.jsx)("span",{className:"text-rose-300",children:"建案載入失敗"}),_&&"loading"===L&&(0,a.jsx)("span",{className:"text-cyan-300",children:"載入 OSM 建物中"}),_&&"zoom"===L&&(0,a.jsx)("span",{children:"OSM 建物需放大至 16+"}),_&&"error"===L&&(0,a.jsx)("span",{className:"text-rose-300",children:"OSM 載入失敗"}),eq&&"loading"===eY&&(0,a.jsx)("span",{className:"text-cyan-300",children:"載入捷運路線中"})]}),(0,a.jsxs)("div",{className:"flex items-center gap-3 border-l border-white/10 pl-4",children:[(0,a.jsx)("span",{className:"text-zinc-400 font-semibold",children:"圖層控制:"}),et.length>0&&(0,a.jsxs)("span",{className:"text-[10px] text-zinc-400 whitespace-nowrap",children:["共載入 ",et.length.toLocaleString()," 個建案"]}),tW.map(e=>{let t=Q[e.id];return e.tiles?(0,a.jsxs)("div",{className:"flex items-center gap-2",children:[(0,a.jsxs)("label",{className:"flex items-center gap-1 cursor-pointer text-zinc-300",children:[(0,a.jsx)("input",{type:"checkbox",checked:t?.visible||!1,onChange:t=>ee(r=>({...r,[e.id]:{...r[e.id]||{opacity:.6,visible:!1},visible:t.target.checked}})),className:"h-3 w-3 accent-cyan-500 rounded border-zinc-700"}),e.label]}),t?.visible&&(0,a.jsx)("input",{type:"range",min:0,max:1,step:.05,value:t.opacity??.6,onChange:t=>ee(r=>({...r,[e.id]:{...r[e.id]||{visible:!1,opacity:.6},opacity:parseFloat(t.target.value)}})),className:"w-12 h-1"})]},e.id):null})]})]})]}),(0,a.jsxs)("div",{className:"relative flex-1 rounded-xl overflow-hidden border border-white/10 shadow-inner",children:[!j&&(0,a.jsx)("div",{className:"absolute inset-0 flex items-center justify-center bg-zinc-950/70 z-20",children:(0,a.jsxs)("div",{className:"flex flex-col items-center gap-3",children:[(0,a.jsx)(c.A,{className:"h-8 w-8 text-cyan-500 animate-spin"}),(0,a.jsx)("div",{className:"text-sm text-zinc-400",children:"正在載入地圖引擎..."})]})}),(0,a.jsx)("div",{ref:m,className:"w-full h-full"})]})]})}},23879:()=>{},27529:(e,t,r)=>{"use strict";r.d(t,{FH:()=>i});var a=r(16385),l=r(55873);async function n(){let{data:{session:e}}=await a.N.auth.getSession();return{"Content-Type":"application/json",apikey:l.m5,Authorization:`Bearer ${e?.access_token||l.m5}`}}async function s(e){let t=await n(),r=await fetch(l.Sn.RANKING_ANALYSIS,{method:"POST",headers:t,body:JSON.stringify({filters:e})});if(!r.ok)throw Error((await r.json().catch(()=>({error:`Analysis request failed: ${r.status}`}))).error||"Analyze data failed");return r.json()}let i={checkAuth:async function(){let{data:{session:e}}=await a.N.auth.getSession();e||console.log("User not logged in, but allowing access.")},getUser:async function(){let{data:{user:e}}=await a.N.auth.getUser();return e},signOut:async function(){let{error:e}=await a.N.auth.signOut();if(e)throw console.error("Sign out failed:",e),e},fetchData:async function(e,t){let r=await n(),a=await fetch(l.Sn.QUERY_DATA,{method:"POST",headers:r,body:JSON.stringify({filters:e,pagination:t})});if(!a.ok)throw Error((await a.json().catch(()=>({error:"Failed to parse server response"}))).error||"Fetch data failed");return a.json()},analyzeData:s,analyzeProjectRanking:s,fetchSubData:async function(e,t,r){if(!e||!t||!r)throw Error(`Insufficient parameters: ${e}, ${t}, ${r}`);let a=await n(),s=await fetch(l.Sn.SUB_DATA,{method:"POST",headers:a,body:JSON.stringify({id:e,type:t,county:r})});if(!s.ok)throw Error((await s.json().catch(()=>({error:"Failed to fetch sub data"}))).error||"Fetch sub data failed");return s.json()},fetchProjectNameSuggestions:async function(e,t,r=[]){let a=await n(),s=t.replace(/\u3127/g,"一"),i=await fetch(l.Sn.PROJECT_NAMES,{method:"POST",headers:a,body:JSON.stringify({countyCode:e,query:s,districts:r,detailed:!0})});if(!i.ok)throw Error(`Server error: ${i.status}`);return i.json()},getAdminUsers:async function(){let e=await n(),t=await fetch(l.Sn.GET_USERS,{method:"POST",headers:e,body:JSON.stringify({})});if(!t.ok)throw Error((await t.json().catch(()=>({error:"Failed to fetch users"}))).error||"Fetch users failed");return t.json()},getUserActivity:async function(e,t=200,r=0){let a=await n(),s=await fetch(l.Sn.GET_USER_ACTIVITY,{method:"POST",headers:a,body:JSON.stringify({userId:e,limit:t,offset:r})});if(!s.ok)throw Error((await s.json().catch(()=>({error:"Failed to fetch user activity"}))).error||"Fetch user activity failed");return s.json()},getActivityStats:async function(){let e=await n(),t=await fetch(l.Sn.GET_ACTIVITY_STATS,{method:"POST",headers:e,body:JSON.stringify({})});if(!t.ok)throw Error((await t.json().catch(()=>({error:"Failed to fetch activity stats"}))).error||"Fetch activity stats failed");return t.json()},validateReferralCode:async function(e){let t=await n();return(await fetch(l.Sn.VALIDATE_REFERRAL_CODE,{method:"POST",headers:t,body:JSON.stringify({code:e})})).json()},activateSubscription:async function(e){let t=await n(),r=await fetch(l.Sn.ACTIVATE_SUBSCRIPTION,{method:"POST",headers:t,body:JSON.stringify(e)});if(!r.ok)throw Error((await r.json().catch(()=>({error:"Activation failed"}))).error||"Activation failed");return r.json()},bindReferralCode:async function(e){let t=await n(),r=await fetch(l.Sn.BIND_REFERRAL_CODE,{method:"POST",headers:t,body:JSON.stringify("string"==typeof e?{code:e}:e)});if(!r.ok)throw Error((await r.json().catch(()=>({error:"Failed to bind referral code"}))).error||"Failed to bind referral code");return r.json()},clearReferralCode:async function(){let e=await n(),t=await fetch(l.Sn.BIND_REFERRAL_CODE,{method:"POST",headers:e,body:JSON.stringify({action:"clear"})});if(!t.ok)throw Error((await t.json().catch(()=>({error:"Failed to clear referral code"}))).error||"Failed to clear referral code");return t.json()},getReferralDashboard:async function(){let e=await n(),t=await fetch(l.Sn.GET_REFERRAL_DASHBOARD,{method:"POST",headers:e,body:JSON.stringify({})});if(!t.ok)throw Error((await t.json().catch(()=>({error:"Failed to fetch referral data"}))).error||"Fetch referral dashboard failed");return t.json()},consumeReferralFeature:async function(e,t="consume"){let r=await n(),a=await fetch(l.Sn.CONSUME_REFERRAL_FEATURE,{method:"POST",headers:r,body:JSON.stringify({feature:e,mode:t})});if(!a.ok){let e=await a.json().catch(()=>({error:"Failed to consume feature"}));throw Error(e.error||e.reason||"Failed to consume feature")}return a.json()}}},33024:(e,t,r)=>{"use strict";r.d(t,{A:()=>a});let a=(0,r(78340).A)("layers",[["path",{d:"M12.83 2.18a2 2 0 0 0-1.66 0L2.6 6.08a1 1 0 0 0 0 1.83l8.58 3.91a2 2 0 0 0 1.66 0l8.58-3.9a1 1 0 0 0 0-1.83z",key:"zw3jo"}],["path",{d:"M2 12a1 1 0 0 0 .58.91l8.6 3.91a2 2 0 0 0 1.65 0l8.58-3.9A1 1 0 0 0 22 12",key:"1wduqc"}],["path",{d:"M2 17a1 1 0 0 0 .58.91l8.6 3.91a2 2 0 0 0 1.65 0l8.58-3.9A1 1 0 0 0 22 17",key:"kqbvx6"}]])},33210:(e,t,r)=>{"use strict";r.d(t,{A:()=>a});let a=(0,r(78340).A)("x",[["path",{d:"M18 6 6 18",key:"1bl5f8"}],["path",{d:"m6 6 12 12",key:"d8bk6v"}]])},34198:(e,t,r)=>{"use strict";r.d(t,{K:()=>o});var a=r(95155),l=r(12115),n=r(40980),s=r(33210),i=r(94514);let o=(0,l.forwardRef)(({options:e,value:t,onChange:r,placeholder:o="Select...",maxItems:c,disabled:u=!1,className:d,onSearch:p,loading:f=!1,onFocus:m},h)=>{let[y,g]=(0,l.useState)(""),[b,x]=(0,l.useState)(!1),v=(0,l.useRef)(null),w=(0,l.useRef)(null),j=p?e:e.filter(e=>e.label.toLowerCase().includes(y.toLowerCase()));return t.map(t=>{let r=e.find(e=>e.value===t);return r?r.label:t}),(0,l.useEffect)(()=>{let e=e=>{v.current&&!v.current.contains(e.target)&&x(!1)};return document.addEventListener("mousedown",e),()=>document.removeEventListener("mousedown",e)},[]),(0,l.useEffect)(()=>{p&&p(y)},[y,p]),(0,a.jsxs)("div",{className:(0,n.cn)("relative w-full",d),ref:v,children:[(0,a.jsxs)("div",{className:(0,n.cn)("flex items-center gap-2 bg-zinc-950/50 border border-input rounded-md px-2 py-1.5 h-[42px] overflow-x-auto custom-scrollbar cursor-text transition-all",b&&"ring-2 ring-ring ring-offset-0 border-ring",u&&"bg-zinc-900/50 cursor-not-allowed opacity-50"),onClick:()=>!u&&w.current?.focus(),children:[t.map(l=>{let n=e.find(e=>e.value===l),i=n?n.label:l,o=n?.renderLabel??i;return(0,a.jsxs)("span",{className:"bg-violet-500/20 text-violet-200 border border-violet-500/30 text-xs rounded-full px-2 py-0.5 flex items-center gap-1 animate-in fade-in zoom-in-95 duration-100 whitespace-nowrap shrink-0",children:[o,!u&&(0,a.jsx)(s.A,{size:12,className:"cursor-pointer hover:text-white transition-colors",onClick:e=>{e.stopPropagation(),r(t.filter(e=>e!==l))}})]},l)}),(0,a.jsx)("input",{ref:w,type:"text",value:y,onChange:e=>g(e.target.value),onFocus:()=>{x(!0),m?.()},onKeyDown:e=>{"Backspace"===e.key&&""===y&&t.length>0&&r(t.slice(0,-1))},placeholder:0===t.length?o:"",className:(0,n.cn)("bg-transparent outline-none flex-grow min-w-[60px] text-zinc-100 placeholder:text-zinc-500 text-sm",u&&"cursor-not-allowed"),disabled:u})]}),b&&!u&&(0,a.jsx)("div",{className:"absolute z-[110] w-full mt-1 bg-zinc-900 border border-zinc-700 rounded-md shadow-xl max-h-60 overflow-y-auto custom-scrollbar animate-in fade-in slide-in-from-top-2 duration-100",children:f?(0,a.jsx)("div",{className:"p-2 text-center text-zinc-500 text-sm",children:"Loading..."}):0===j.length?(0,a.jsx)("div",{className:"p-2 text-center text-zinc-500 text-sm",children:"No options found"}):j.map((e,s)=>{if(!e)return null;let o=0===s||e.group!==j[s-1]?.group;return(0,a.jsxs)(l.Fragment,{children:[o&&e.group&&(0,a.jsx)("div",{className:"px-2 py-1 bg-zinc-800/50 text-xs font-semibold text-zinc-400 sticky top-0 backdrop-blur-sm z-10",children:e.group}),(0,a.jsxs)("div",{className:(0,n.cn)("px-3 py-2 cursor-pointer text-sm flex items-start justify-between hover:bg-zinc-800 transition-colors",t.includes(e.value)&&"bg-violet-500/10 text-violet-400"),onClick:()=>(e=>{if(t.includes(e))r(t.filter(t=>t!==e));else{if(c&&t.length>=c)return;r([...t,e])}g("")})(e.value),children:[(0,a.jsxs)("div",{className:"flex flex-col",children:[(0,a.jsx)("span",{className:"font-medium",children:e.renderLabel??e.label}),e.details&&(0,a.jsxs)("div",{className:"flex items-center gap-2 mt-0.5",children:[(e.details.county||e.details.district)&&(0,a.jsxs)("span",{className:"text-xs text-zinc-500 bg-zinc-800/80 px-1.5 rounded border border-zinc-700",children:[e.details.county,e.details.district]}),e.details.date&&(0,a.jsx)("span",{className:"text-xs text-zinc-600 font-mono",children:e.details.date.substring(0,7)})]})]}),t.includes(e.value)&&(0,a.jsx)(i.A,{size:16,className:"mt-1"})]})]},e.value)})})]})});o.displayName="MultiSelect"},94514:(e,t,r)=>{"use strict";r.d(t,{A:()=>a});let a=(0,r(78340).A)("check",[["path",{d:"M20 6 9 17l-5-5",key:"1gmf2c"}]])}}]);