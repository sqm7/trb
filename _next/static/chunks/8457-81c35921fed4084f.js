"use strict";(self.webpackChunk_N_E=self.webpackChunk_N_E||[]).push([[8457],{9505:(e,t,i)=>{i.d(t,{l:()=>o});var s=i(95155),n=i(12115),a=i(40980),r=i(68459),l=i(94514),c=i(61878);function o({projects:e,className:t,onChange:i,max:o=6,placeholder:d="搜尋並加入比較...",title:x="建案亮點標示"}){let[m,h]=(0,n.useState)(""),[p,u]=(0,n.useState)([]),[f,g]=(0,n.useState)(!1),b=(0,n.useRef)(null),j=(0,n.useRef)(null);(0,n.useEffect)(()=>{let e=e=>{b.current&&!b.current.contains(e.target)&&g(!1)};return document.addEventListener("mousedown",e),()=>document.removeEventListener("mousedown",e)},[]);let v=e.filter(e=>!p.includes(e.value)&&e.label.toLowerCase().includes(m.toLowerCase())).slice(0,10);return(0,s.jsxs)("div",{className:(0,a.cn)("space-y-2",t),ref:b,children:[(0,s.jsxs)("div",{className:"flex justify-between items-center bg-zinc-900/50 p-1 rounded-lg border border-white/5",children:[(0,s.jsxs)("h4",{className:"text-sm font-medium text-zinc-400 pl-2 border-l-2 border-yellow-500",children:[x," ",(0,s.jsxs)("span",{className:"text-xs font-normal text-zinc-600",children:["(最多 ",o," 個)"]})]}),p.length>0&&(0,s.jsxs)("button",{onClick:()=>{u([]),i([]),j.current?.focus()},className:"p-1.5 text-zinc-500 hover:text-rose-400 hover:bg-rose-500/10 rounded transition-colors flex items-center gap-1 text-xs",title:"清除所有選擇",children:[(0,s.jsx)(r.A,{size:14}),"清除"]})]}),(0,s.jsxs)("div",{className:"flex flex-wrap gap-2 min-h-[32px]",children:[0===p.length&&(0,s.jsx)("span",{className:"text-xs text-zinc-600 italic py-1",children:"尚未選擇建案..."}),p.map(e=>(0,s.jsxs)("div",{className:"flex items-center gap-1 bg-yellow-500/10 text-yellow-500 px-2 py-1 rounded text-xs border border-yellow-500/30",children:[(0,s.jsx)("span",{children:e}),(0,s.jsx)("button",{onClick:()=>{let t;u(t=p.filter(t=>t!==e)),i(t)},className:"hover:text-yellow-300",children:(0,s.jsx)(l.A,{size:12,className:"rotate-45"})})]},e))]}),(0,s.jsxs)("div",{className:"relative",children:[(0,s.jsx)(c.A,{className:"absolute left-3 top-1/2 -translate-y-1/2 w-4 h-4 text-zinc-500"}),(0,s.jsx)("input",{ref:j,type:"text",value:m,onChange:e=>{h(e.target.value),g(!0)},onFocus:()=>g(!0),placeholder:d,className:"w-full bg-zinc-900/50 border border-white/10 rounded-lg pl-9 pr-4 py-2 text-sm text-white placeholder:text-zinc-600 focus:outline-none focus:ring-1 focus:ring-cyan-500/50 transition-all",disabled:p.length>=o}),f&&(0,s.jsx)("div",{className:"absolute top-full left-0 right-0 mt-1 bg-zinc-900 border border-white/10 rounded-lg shadow-xl z-50 max-h-60 overflow-y-auto",children:v.length>0?v.map(e=>(0,s.jsx)("button",{onClick:()=>(e=>{if(p.length>=o)return;let t=[...p,e];u(t),i(t),h(""),j.current?.focus()})(e.value),className:"w-full text-left px-3 py-2 text-sm text-zinc-300 hover:bg-white/5 hover:text-white transition-colors",children:e.label},e.value)):(0,s.jsx)("div",{className:"px-3 py-2 text-sm text-zinc-600",children:"無相關建案"})})]})]})}},29991:(e,t,i)=>{i.d(t,{l:()=>l});var s=i(95155),n=i(12115),a=i(40980),r=i(66088);let l=n.forwardRef(({className:e,children:t,...i},n)=>(0,s.jsxs)("div",{className:"relative",children:[(0,s.jsx)("select",{className:(0,a.cn)("flex h-10 w-full appearance-none rounded-md border border-input bg-zinc-950/50 px-3 py-2 text-sm text-zinc-100 ring-offset-background focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2 disabled:cursor-not-allowed disabled:opacity-50 pr-8",e),ref:n,...i,children:t}),(0,s.jsx)(r.A,{className:"absolute right-3 top-2.5 h-4 w-4 opacity-50 pointer-events-none"})]}));l.displayName="Select"},30327:(e,t,i)=>{i.d(t,{A:()=>N});var s=i(95155),n=i(12115),a=i(81477),r=i(18460),l=i(40980);let c=(0,r.F)("inline-flex items-center rounded-full border px-2.5 py-0.5 text-xs font-semibold transition-colors focus:outline-none focus:ring-2 focus:ring-ring focus:ring-offset-2",{variants:{variant:{default:"border-transparent bg-primary text-primary-foreground hover:bg-primary/80",secondary:"border-transparent bg-secondary text-secondary-foreground hover:bg-secondary/80",destructive:"border-transparent bg-destructive text-destructive-foreground hover:bg-destructive/80",outline:"text-foreground"}},defaultVariants:{variant:"default"}});function o({className:e,variant:t,...i}){return(0,s.jsx)("div",{className:(0,l.cn)(c({variant:t}),e),...i})}let d=[{id:"p-2012-08-01",date:"2012-08-01",title:"實價登錄 1.0 上路",category:"policy",impact:"high",description:"交易後30日內申報，區段化揭露(30號區間)，預售屋採代銷結案後整批申報。",change_content:"交易資訊不透明 -> 區段化揭露",affected_scope:"房仲業者、買賣雙方、預售屋投機客",background:"低利環境延續：國內房貸利率處於低檔 (約1.8%-1.9%)。",impact_analysis:"[受益] 買方獲得參考依據。[適應] 房仲失去資訊壟斷優勢。[無感] 預售屋投機客因資訊未即時揭露，仍可操作紅單。",details:["申報義務人：地政士、經紀業或權利人。","申報時機：買賣案件於辦竣所有權移轉登記後30日內申報。","揭露方式：以區段化、去識別化方式提供查詢 (例如：中正路1-30號)。","預售屋規定：委託代銷者，於委託代銷契約屆滿或終止30日內「整批」申報 (資訊落後嚴重)。"]},{id:"p-2014-06-04",date:"2014-06-04",title:"囤房稅 1.0",category:"policy",impact:"medium",description:"非自住住家用稅率由1.2%-2%調高為1.5%-3.6%，授權地方政府自訂差別稅率。",change_content:"非自住稅率 1.2% -> 1.5%~3.6%",affected_scope:"多屋族、台北市置產客",background:"美國聯準會結束QE：預期升息心理浮現，全球資金派對暫歇。",impact_analysis:"[微痛] 持有成本上升，但因多數縣市未採最高稅率，且稅基(房屋評定現值)偏低，實質痛感有限。",details:["自住房屋稅率：維持 1.2% (需本人、配偶或直系親屬實際居住，且全國合計3戶以內)。","非自住房屋稅率：由 1.2%~2% 調升至 1.5%~3.6%。","地方權限：各地方政府可視地方發展需要，在範圍內自訂差別稅率。","持有認定：以個人(自然人)或法人(公司)為單位個別計算。"]},{id:"p-2016-01-01",date:"2016-01-01",title:"房地合一稅 1.0",category:"policy",impact:"high",description:"獲利課稅取代舊制。持有<1年45%，1-2年35%，自用滿6年獲利400萬免稅。奢侈稅同步停徵。",change_content:"按售價課稅(奢侈稅) -> 按獲利課稅(45%~15%)",affected_scope:"短線炒作客、自住客",background:"奢侈稅同步停徵：象徵房市進入「實價課稅」新紀元。",impact_analysis:"[毀滅] 短進短出獲利被腰斬，投資客大量退場。[受益] 房價盤整，自住客獲得較佳議價空間。",details:["課稅基礎：房地交易所得 = 交易成交價額 - 原始取得成本 - 相關費用 - 土地漲價總數額。","持有1年以內：稅率 45%。","持有1-2年：稅率 35%。","持有2-10年：稅率 20%。","持有超過10年：稅率 15%。","自用住宅優惠：獲利400萬元以下免稅，超過部分10%。(需連續設籍滿6年)","日出條款：2016年1月1日以後取得之房地適用新制。"]},{id:"f-2016-03-24",date:"2016-03-24",title:"央行大幅鬆綁信用管制",category:"finance",impact:"high",description:"刪除特定地區管制與自然人第3戶以上限制，僅保留豪宅管制(6成)。",change_content:"刪除多數管制，僅保留豪宅限貸",affected_scope:"換屋族、一般投資客",background:"經濟成長疲弱：為提振內需經濟，央行解除長達6年的房市管制。",impact_analysis:"[受益] 貸款成數恢復，換屋與置產門檻降低，市場交易量逐漸回溫。",details:["解除管制區域：台北市及新北市特定地區。","解除限制對象：自然人第3戶以上購屋貸款、公司法人購屋貸款。","保留限制：高價住宅(豪宅)貸款最高成數仍維持6成。"]},{id:"p-2018-06-27",date:"2018-06-27",title:"租賃住宅市場發展及管理條例",category:"policy",impact:"low",description:"建立包租代管機制，鼓勵房東釋出空屋，給予稅賦優惠(所得稅減免)。",change_content:"包租代管稅賦優惠",affected_scope:"房東、租屋族",background:"美中貿易戰開打：全球供應鏈重組，資金開始撤離中國。",impact_analysis:"[受益] 房東享有所得稅減免；租屋族獲得專業代管服務，租賃關係較有保障。",details:["租稅優惠：個人房東委託包租代管，月租金6000元以下免稅；6000-20000元必要費用率53%。","專業證照：建立租賃住宅管理人員證照制度。","糾紛處理：建立租賃糾紛免費調處機制。"]},{id:"f-2019-08-15",date:"2019-08-15",title:"境外資金匯回專法",category:"finance",impact:"medium",description:"鼓勵台商資金回流享優惠稅率，禁止直接投資房地產，但產生外溢效應帶動豪宅與工業地產。",change_content:"資金專法回流 (禁入房市但有外溢)",affected_scope:"工業地產主、豪宅建商",background:"台商回流潮：史上最大規模資金回台，雖禁入房市，但產生外溢效應。",impact_analysis:"[暴富] 工業用地與廠房價格飆漲。[受益] 企業主獲利與分紅轉入豪宅市場，帶動高總價產品去化。",details:["優惠稅率：第一年匯回稅率8%，第二年10%。(實質投資可退稅一半)","投資限制：禁止資金直接投資房地產(避免炒房)。","資金控管：資金需存入專戶，控管5-7年才能分批提取。","外溢效應：雖然不能直接買房，但增加市場資金總量，且企業獲利後的分紅仍可自由運用。"]},{id:"f-2020-03-19",date:"2020-03-19",title:"央行降息 1 碼",category:"finance",impact:"high",description:"重貼現率降至1.125%，房貸利率跌破1.4%歷史新低，無限QE背景下引發資產通膨。",change_content:"重貼現率 1.375% -> 1.125%",affected_scope:"全體購屋族、股市投資人",background:"COVID-19 疫情爆發：美國聯準會無限QE，全球熱錢氾濫。",impact_analysis:"[刺激] 持有成本極低，「租不如買」與「買房抗通膨」心理大爆發，股房雙漲。",details:["降息幅度：調降重貼現率 0.25個百分點。","房貸利率：五大銀行新承做房貸利率跌破 1.4%，創歷史新低。","配套補貼：針對受疫情影響產業及自用住宅貸款提供額外補貼。"]},{id:"f-2020-12-08",date:"2020-12-08",title:"央行信用管制 (第一波)",category:"finance",impact:"medium",description:"法人購屋限貸6成，自然人第3戶限貸6成，建商餘屋限貸5成。",change_content:"法人/第3戶/餘屋 限貸 5-6成",affected_scope:"公司法人、多屋族(3戶+)",background:"房市過熱跡象：紅單炒作猖獗，排隊買房現象頻傳。",impact_analysis:"[警示] 宣示政府打炒房決心，但因低利環境，實質殺傷力有限。",details:["公司法人：第一戶貸款成數最高 6成，無寬限期。","自然人第3戶(含)以上：貸款成數最高 6成，無寬限期。","購地貸款：限貸 6.5成，需保留 1成動工款。","餘屋貸款：限貸 5成。"]},{id:"f-2021-03-19",date:"2021-03-19",title:"央行信用管制 (第二波)",category:"finance",impact:"medium",description:"法人購屋成數降至4成，豪宅降至5.5成。",change_content:"法人限貸 4成；豪宅限貸 5.5成",affected_scope:"公司法人、豪宅客",background:"投機風氣未減",impact_analysis:"[打擊] 封鎖利用公司名義高槓桿炒房的途徑。",details:["公司法人：貸款成數調降至 4成。","自然人高價住宅：第1戶限貸 5.5成，第3戶以上限貸 4成。","工業區閒置土地：貸款最高 5.5成。"]},{id:"p-2021-07-01",date:"2021-07-01",title:"實價登錄 2.0 & 房地合一 2.0",category:"policy",impact:"high",description:"門牌完整揭露，預售屋即時申報(30日)，禁止紅單轉售；重稅期延長(45%改2年, 35%改5年)，預售屋納稅。",change_content:"預售屋納管、重稅閉鎖期延長、禁紅單",affected_scope:"預售屋買方/投機客、建商、換屋族",background:"房市多頭確立；疫情三級警戒(內需停滯但房市創高)",impact_analysis:"[雙面刃] 資訊全透明反成定錨工具。[閉鎖] 投機客無法短進短出，成屋惜售供給減少，價格難跌。",details:["實價登錄2.0：門牌號碼完整揭露 (不再區段化)。","預售屋納管：銷售前需備查，簽約後30日內申報實價登錄。","紅單禁止：禁止預售屋紅單轉售。","房地合一2.0：預售屋獲利納入房地合一稅課徵。","延長重稅期：持有2年內45%，2-5年35% (原為1-2年)。","法人比照：法人交易比照自然人稅率 (防堵公司名義短期炒作)。"]},{id:"f-2021-09-24",date:"2021-09-24",title:"央行信用管制 (第三波)",category:"finance",impact:"medium",description:"特定地區 (六都+新竹) 第2戶取消寬限期。",change_content:"特定地區第2戶 取消寬限期",affected_scope:"投資客、換屋族",background:"房價持續攀升",impact_analysis:"[壓力] 買第2間房必須立刻還本金，增加現金流壓力，迫使部分槓桿過大者退場。",details:["管制區域：新增特定地區 (六都 + 新竹縣市)。","自然人第2戶：取消寬限期 (需本息攤還)。","購地貸款：調降至 6成。","工業區閒置土地：調降至 5成。"]},{id:"f-2021-12-17",date:"2021-12-17",title:"央行信用管制 (第四波)",category:"finance",impact:"medium",description:"豪宅貸款降至4成，第3戶降至4成，餘屋貸款降至4成。",change_content:"豪宅/第3戶/餘屋 限貸 4成",affected_scope:"建商、豪宅客",background:"營建成本飆漲：缺工缺料議題發酵。",impact_analysis:"[緊縮] 建商資金鏈趨緊，中小型建商生存困難，市場走向大者恆大。",details:["自然人高價住宅：貸款成數一律降至 4成 (無寬限期)。","自然人第3戶(含)以上：貸款成數一律降至 4成。","購地貸款：降至 5成。","餘屋貸款：降至 4成。"]},{id:"f-2022-03-17",date:"2022-03-17",title:"央行升息循環啟動",category:"finance",impact:"medium",description:"央行跟進Fed升息(全年共2.5碼)，房貸利率重回2%以上。",change_content:"升息 2.5碼 (利率重回 2% table+)",affected_scope:"房貸族",background:"全球通膨危機：美國暴力升息，全球股市修正。",impact_analysis:"[負擔增加] 每千萬房貸每年利息支出增加約3-4萬元，稍微冷卻追價意願。",details:["2022-03：升息 1碼 (0.25%)。","2022-06：升息 半碼 (0.125%)。","2022-09：升息 半碼 (0.125%)。","2022-12：升息 半碼 (0.125%)。","存款準備率：同步調升，緊縮市場游資。"]},{id:"f-2023-06-16",date:"2023-06-16",title:"央行信用管制 (第五波)",category:"finance",impact:"medium",description:"特定地區第2戶限貸成數上限 7成。",change_content:"特定地區第2戶 限貸 7成",affected_scope:"換屋族、投資客",background:"房市量縮價穩：市場觀望平均地權條例上路。",impact_analysis:"[微痛] 需多準備1成自備款，影響尚可控。",details:["管制區域：特定地區 (六都 + 新竹縣市)。","自然人第2戶：新增貸款成數上限 7成 (此前僅無寬限期)。"]},{id:"p-2023-07-01",date:"2023-07-01",title:"平均地權條例修正",category:"policy",impact:"high",description:"預售屋禁止換約轉售，建立檢舉獎金，私法人購屋許可制。",change_content:"預售屋禁換約、私法人許可制",affected_scope:"預售屋黃牛、豪宅法人",background:"投機客的大限",impact_analysis:"[滅絕] 純粹賺價差的紅單與換約客徹底消失。豪宅市場因法人需經許可，交易量急凍。",details:["限制換約轉售：預售屋與新建成屋簽約後，除配偶、直系或二親等旁系外，不得讓與或轉售 (禁止黃牛)。","重罰炒作：嚴懲散播不實資訊影響房價，最高罰5000萬元。","檢舉獎金：建立檢舉實名制，獎金為罰鍰 30%。","私法人購屋許可制：私法人購買住宅用房屋需經內政部許可 (限制豪宅私法人節稅管道)。"]},{id:"p-2023-08-01",date:"2023-08-01",title:"新青安貸款專案",category:"policy",impact:"high",description:"額度1000萬，年限40年，寬限期5年，利率補貼(1.775%起)。",change_content:"40年期/5年寬限/降息補貼",affected_scope:"首購族、投機客(人頭)、低總價屋主",background:"總統大選前夕：政府釋出利多，試圖減輕年輕人負擔。",impact_analysis:"[狂熱] 創造「租不如買」與「5年免還本」的套利空間。低總價成屋被掃貨，房價逆勢暴漲。",details:["貸款額度：提高至 1000萬元。","利息補貼：政府補貼 1.5碼 (0.375%) + 公股銀行減半碼 = 利率 1.775% 起。","貸款年限：延長至 40年。","寬限期：延長至 5年 (只繳息不還本)。","資格：本人、配偶及未成年子女名下均無自有住宅。"]},{id:"f-2024-06-14",date:"2024-06-14",title:"央行信用管制 (第六波)",category:"finance",impact:"medium",description:"特定地區第2戶限貸成數降至 6成。",change_content:"特定地區第2戶 限貸 6成",affected_scope:"換屋族、置產客",background:"台股站上2萬點：AI熱潮帶動股市財富效應，資金外溢至房市。",impact_analysis:"[無效] 股市獲利豐厚，6成限貸無法阻擋資金湧入房市。",details:["管制區域：特定地區 (六都 + 新竹縣市)。","自然人第2戶：貸款成數上限由 7成調降為 6成。","調升存款準備率：調升 0.25個百分點 (收回市場資金)。"]},{id:"p-2024-07-01",date:"2024-07-01",title:"囤房稅 2.0 實施",category:"policy",impact:"medium",description:"全國歸戶，非自用稅率調高至 2.0%-4.8%，建商餘屋依持有年限課稅。",change_content:"全國歸戶；稅率 2.0%~4.8%",affected_scope:"多屋族、租屋族、建商",background:"租金指數創高",impact_analysis:"[轉嫁] 多屋族將稅負轉嫁至租金，導致租金上漲。建商面臨餘屋去化壓力，傾向預售完銷。",details:["全國歸戶：由縣市歸戶改為全國歸戶計算戶數。","稅率調升：非自住住家用稅率調升為 2%~4.8% (原1.5%~3.6%)。","單一自住優惠：全國單一自住(本人配偶子女僅一戶)且房屋現值在一定金額以下，稅率降至 1%。","建商餘屋：持有2年以內稅率 2%~3.6%；超過2年稅率 2%~4.8% (鼓勵釋出餘屋)。"]},{id:"f-2024-08-01",date:"2024-08-01",title:"銀行限貸令 (72-2水位)",category:"finance",impact:"high",description:"銀行法72-2條逼近30%上限，自主限貸、排隊撥款，市場流動性急凍。",change_content:"銀行自主限貸、排隊撥款",affected_scope:"即將交屋族、賣屋換屋族",background:"新青安效應發酵：過多成屋交易與新青安撥款，耗盡銀行額度。",impact_analysis:"[恐慌] 買了房卻貸不到款，面臨違約風險。市場流動性瞬間急凍。",details:["銀行法72-2條：商業銀行辦理住宅建築及企業建築放款總額，不得超過存款總餘額及金融債券發售額之 30%。","現象：多家銀行房貸水位接近滿載。","影響：銀行暫停收件、排隊撥款(需等數月)、利率大幅調升(2.6%-3%以上)。"]},{id:"f-2024-09-20",date:"2024-09-20",title:"央行信用管制 (第七波)",category:"finance",impact:"high",description:"有房者第1戶無寬限期；全國第2戶限貸5成；法人/豪宅/第3戶限貸3成。",change_content:"有房者第1戶無寬限；第2戶全國限貸5成",affected_scope:"換屋族、繼承族、交屋族",background:"金龍海嘯：央行判定房市過熱，認為新青安助長投機，決心斷絕金流。",impact_analysis:"[重傷/錯殺] 史上最嚴厲管制。1. 換屋族需5成自備。2. 繼承祖產失寬限。3. 預售交屋斷頭風險大增。",details:["自然人第1戶：名下有房屋者(含繼承、持分)，第1戶購屋貸款「無寬限期」。","自然人第2戶：貸款成數上限降至 5成，且擴及「全國」。","自然人第3戶以上：貸款成數上限降至 3成。","公司法人：購屋貸款成數降至 3成。","豪宅(高價住宅)：貸款成數降至 3成。","餘屋貸款：降至 3成。","存款準備率：再調升 0.25個百分點。"]}];var x=i(30122),m=i(85753),h=i(68822),p=i(57420),u=i(69220),f=i(22651),g=i(44071),b=i(9921),j=i(66088),v=i(9505),y=i(78795);function N({data:e}){let t=(0,n.useMemo)(()=>{if(!e)return[];let t=new Set;return e.forEach(e=>{e["建案名稱"]&&t.add(e["建案名稱"])}),Array.from(t).map(e=>({value:e,label:e}))},[e]),[i,r]=(0,n.useState)([]),[c,N]=(0,n.useState)(null),[w,z]=(0,n.useState)(1),[k,S]=(0,n.useState)(!1),_=(0,n.useMemo)(()=>{if(0===i.length||!e||0===e.length)return[];let t={};return e.forEach(e=>{let s=e["建案名稱"];if(!s||!i.includes(s))return;let n=new Date(e["交易日"]).getTime();isNaN(n)||(t[s]||(t[s]=[]),t[s].push(n))}),Object.entries(t).map(([e,t])=>{let i=Math.min(...t),s=Math.max(...t);return{name:e,start:new Date(i),end:new Date(s),startStr:new Date(i).toISOString().slice(0,10),endStr:new Date(s).toISOString().slice(0,10),count:t.length}}).sort((e,t)=>e.start.getTime()-t.start.getTime()).slice(0,10)},[e,i]),P=(0,n.useMemo)(()=>{let e=new Date().getFullYear()+1;return _.length>0&&(e=Math.max(e,Math.max(..._.map(e=>e.end.getFullYear()))+1)),{start:new Date("2012-01-01"),end:new Date(`${e}-12-31`),totalMonths:(e-2012+1)*12}},[_]),A=Math.max(350,100+40*_.length+80),M=e=>{let t=new Date(e),i=P.start.getTime(),s=P.end.getTime(),n=t.getTime();return n<i?0:n>s?100:(n-i)/(s-i)*100},C=(0,n.useMemo)(()=>d.filter(e=>{let t=new Date(e.date);return t>=P.start&&t<=P.end}),[P]),F=(0,n.useMemo)(()=>C.slice().reverse().map(e=>({日期:e.date,標題:e.title,類別:"finance"===e.category?"金融":"政策",影響:e.impact,變革內容:e.change_content,影響對象:e.affected_scope})),[C]);return(0,s.jsxs)(a.Zp,{className:"w-full bg-black/40 border-zinc-800 backdrop-blur-xl",children:[(0,s.jsxs)(a.aR,{children:[(0,s.jsxs)(a.ZB,{className:"flex items-center gap-2 text-xl font-bold text-transparent bg-clip-text bg-gradient-to-r from-cyan-400 to-purple-400",children:[(0,s.jsx)(p.A,{className:"w-6 h-6 text-cyan-500"}),"房市政策時光機"]}),(0,s.jsx)(a.BT,{className:"text-zinc-400",children:"建案銷售期間與重大政策/金融事件的交叉比對"})]}),(0,s.jsxs)(a.Wu,{children:[(0,s.jsxs)("div",{className:"flex flex-col md:flex-row items-start md:items-end justify-between mb-6 px-2 gap-4",children:[(0,s.jsx)("div",{className:"w-full md:w-1/2 lg:w-1/3",children:(0,s.jsx)(v.l,{projects:t,onChange:r,title:"選擇建案 (顯示銷售區間)",placeholder:"搜尋建案以顯示在時間軸...",max:6})}),(0,s.jsxs)("div",{className:"flex items-center justify-between w-full md:w-auto gap-4",children:[(0,s.jsxs)("div",{className:"flex items-center gap-2 bg-black/20 rounded-lg p-1 border border-white/5",children:[(0,s.jsx)("button",{onClick:()=>z(e=>Math.max(.5,e-.25)),className:"p-1.5 hover:bg-white/10 rounded-md text-zinc-400 hover:text-white transition-colors",children:(0,s.jsx)(u.A,{className:"w-4 h-4"})}),(0,s.jsxs)("span",{className:"text-xs font-mono text-zinc-500 w-12 text-center",children:[(100*w).toFixed(0),"%"]}),(0,s.jsx)("button",{onClick:()=>z(e=>Math.min(3,e+.25)),className:"p-1.5 hover:bg-white/10 rounded-md text-zinc-400 hover:text-white transition-colors",children:(0,s.jsx)(f.A,{className:"w-4 h-4"})})]}),(0,s.jsxs)("div",{className:"flex items-center gap-3 text-xs text-zinc-500",children:[(0,s.jsxs)("div",{className:"flex items-center gap-1.5",children:[(0,s.jsx)("div",{className:"w-2 h-2 rounded-full bg-emerald-500"})," 金融事件"]}),(0,s.jsxs)("div",{className:"flex items-center gap-1.5",children:[(0,s.jsx)("div",{className:"w-2 h-2 rounded-full bg-rose-500"})," 房市政策"]})]})]})]}),(0,s.jsx)("div",{className:"relative w-full overflow-x-auto pb-12 pt-8 hide-scrollbar",children:(0,s.jsxs)("div",{className:"relative pr-20 ml-24 border-b border-zinc-800 transition-all duration-300 ease-out",style:{minWidth:`${1200*w}px`,height:`${A}px`},children:[(0,s.jsx)("div",{className:"absolute top-0 w-full h-full pointer-events-none",children:Array.from({length:P.end.getFullYear()-P.start.getFullYear()+1}).map((e,t)=>{let i=P.start.getFullYear()+t,n=M(`${i}-01-01`);return(0,s.jsx)("div",{className:"absolute h-full border-l border-dashed border-zinc-800/50",style:{left:`${n}%`},children:(0,s.jsx)("span",{className:"absolute -top-6 -left-3 text-xs font-mono text-zinc-500",children:i})},i)})}),_.map((e,t)=>{let i=["from-cyan-500/20 to-blue-500/20 border-cyan-500/30 text-cyan-400","from-violet-500/20 to-purple-500/20 border-violet-500/30 text-violet-400","from-amber-500/20 to-orange-500/20 border-amber-500/30 text-amber-400","from-emerald-500/20 to-teal-500/20 border-emerald-500/30 text-emerald-400","from-pink-500/20 to-rose-500/20 border-pink-500/30 text-pink-400"],n=i[t%i.length];return(0,s.jsxs)("div",{className:(0,l.cn)("absolute h-8 border-y backdrop-blur-sm z-10 flex items-center justify-center group transition-all hover:bg-white/5",`bg-gradient-to-r ${n}`),style:{left:`${M(e.startStr)}%`,width:`${Math.max(.5,M(e.endStr)-M(e.startStr))}%`,top:`${100+40*t}px`},children:[(0,s.jsx)("div",{className:"absolute right-full mr-2 flex items-center h-full top-0",children:(0,s.jsx)("span",{className:"text-[10px] font-bold text-zinc-400 whitespace-nowrap bg-black/40 px-1.5 py-0.5 rounded border border-white/5",children:e.name})}),(0,s.jsxs)("div",{className:"absolute -top-8 text-[10px] whitespace-nowrap opacity-0 group-hover:opacity-100 transition-opacity bg-black/90 px-2 py-1 rounded border border-zinc-700 z-20 pointer-events-none",children:[e.startStr," ~ ",e.endStr," (",e.count,"筆)"]})]},e.name)}),C.map((e,t)=>{let i=M(e.date),n="high"===e.impact,a=t%2==0?"8%":"85%",r=!1;if(_.length>0){let t=new Date(e.date);r=_.some(e=>t>=e.start&&t<=e.end)}return(0,s.jsxs)("div",{className:(0,l.cn)("absolute transform -translate-x-1/2 flex flex-col items-center group cursor-pointer transition-all duration-300 z-20",r?"opacity-100 scale-110":"opacity-60 hover:opacity-100 hover:scale-110",c?.id===e.id&&"scale-125 opacity-100 z-30"),style:{left:`${i}%`,top:a},onClick:()=>N(e),children:[(0,s.jsx)("div",{className:(0,l.cn)("h-8 w-px absolute","8%"===a?"top-full bg-gradient-to-b":"bottom-full bg-gradient-to-t","from-transparent to-zinc-700")}),(0,s.jsx)("div",{className:(0,l.cn)("w-8 h-8 rounded-full flex items-center justify-center border shadow-[0_0_15px_rgba(0,0,0,0.5)] transition-all","finance"===e.category?"bg-emerald-950/80 border-emerald-500/50 text-emerald-400 group-hover:shadow-emerald-500/20":"bg-rose-950/80 border-rose-500/50 text-rose-400 group-hover:shadow-rose-500/20",n&&"ring-2 ring-offset-2 ring-offset-black/50 ring-opacity-50","finance"===e.category&&n?"ring-emerald-500":"ring-rose-500",c?.id===e.id&&"ring-2 ring-white ring-offset-2 ring-offset-black"),children:(e=>{switch(e){case"finance":return(0,s.jsx)(x.A,{className:"w-3 h-3 text-emerald-400"});case"policy":return(0,s.jsx)(m.A,{className:"w-3 h-3 text-rose-400"});default:return(0,s.jsx)(h.A,{className:"w-3 h-3 text-blue-400"})}})(e.category)}),(0,s.jsx)("div",{className:(0,l.cn)("absolute whitespace-nowrap text-[10px] px-2 py-0.5 mt-2 rounded bg-black/80 border border-zinc-700 backdrop-blur-md transition-all font-medium","8%"===a?"-top-8":"-bottom-8",r?"text-white border-yellow-500/50":"text-zinc-400 group-hover:text-white",c?.id===e.id&&"text-white border-white/50 bg-zinc-800"),children:e.title}),(0,s.jsx)("div",{className:(0,l.cn)("absolute text-[9px] font-mono text-zinc-600","8%"===a?"top-10":"bottom-10"),children:e.date})]},e.id)})]})}),c&&(0,s.jsx)("div",{className:"mt-6 mb-8 border border-zinc-700/50 bg-zinc-900/80 p-6 rounded-xl animate-in fade-in slide-in-from-top-4 shadow-2xl shadow-black/50",children:(0,s.jsxs)("div",{className:"flex flex-col gap-6",children:[(0,s.jsxs)("div",{className:"flex items-start justify-between border-b border-white/5 pb-4",children:[(0,s.jsxs)("div",{className:"space-y-1",children:[(0,s.jsxs)("div",{className:"flex items-center gap-3",children:[(0,s.jsx)(o,{variant:"outline",className:(0,l.cn)("text-sm px-3 py-1","finance"===c.category?"bg-emerald-500/10 text-emerald-400 border-emerald-500/30":"bg-rose-500/10 text-rose-400 border-rose-500/30"),children:"finance"===c.category?"金融事件":"房市政策"}),(0,s.jsx)("span",{className:"text-zinc-400 font-mono text-sm",children:c.date})]}),(0,s.jsx)("h3",{className:"text-2xl font-bold text-white tracking-tight",children:c.title})]}),(0,s.jsxs)("div",{className:(0,l.cn)("px-3 py-1 rounded-full text-xs font-medium border","high"===c.impact?"bg-red-500/10 text-red-400 border-red-500/30":"bg-yellow-500/10 text-yellow-400 border-yellow-500/30"),children:["影響程度: ","high"===c.impact?"高":"medium"===c.impact?"中":"低"]})]}),(0,s.jsxs)("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-8",children:[(0,s.jsxs)("div",{className:"space-y-6",children:[(0,s.jsxs)("div",{children:[(0,s.jsxs)("h4",{className:"text-sm font-bold text-zinc-500 uppercase tracking-wider mb-2 flex items-center gap-2",children:[(0,s.jsx)(h.A,{className:"w-4 h-4"})," 政策/事件內容"]}),(0,s.jsx)("p",{className:"text-zinc-200 text-base leading-relaxed bg-zinc-950/50 p-4 rounded-lg border border-white/5",children:c.description})]}),(0,s.jsxs)("div",{children:[(0,s.jsxs)("h4",{className:"text-sm font-bold text-zinc-500 uppercase tracking-wider mb-2 flex items-center gap-2",children:[(0,s.jsx)(m.A,{className:"w-4 h-4"})," 具體規範變革"]}),(0,s.jsx)("div",{className:"bg-zinc-950/50 p-4 rounded-lg border border-white/5 text-cyan-400 font-medium",children:c.change_content||"無具體規範變更"})]})]}),(0,s.jsxs)("div",{className:"space-y-6",children:[(0,s.jsxs)("div",{children:[(0,s.jsxs)("h4",{className:"text-sm font-bold text-zinc-500 uppercase tracking-wider mb-2 flex items-center gap-2",children:[(0,s.jsx)(x.A,{className:"w-4 h-4"})," 時代背景與金融環境"]}),(0,s.jsx)("p",{className:"text-zinc-300 text-sm leading-relaxed bg-zinc-950/30 p-4 rounded-lg border border-white/5",children:c.background||"尚無背景資料"})]}),(0,s.jsxs)("div",{children:[(0,s.jsxs)("h4",{className:"text-sm font-bold text-zinc-500 uppercase tracking-wider mb-2 flex items-center gap-2",children:[(0,s.jsx)(g.A,{className:"w-4 h-4"})," 受眾影響分析"]}),(0,s.jsxs)("div",{className:"relative overflow-hidden rounded-lg border border-white/10 bg-gradient-to-br from-indigo-500/10 to-purple-500/10 p-4",children:[(0,s.jsx)("div",{className:"absolute top-0 right-0 p-2 opacity-10",children:(0,s.jsx)(g.A,{className:"w-24 h-24"})}),(0,s.jsxs)("div",{className:"relative z-10",children:[(0,s.jsxs)("p",{className:"text-indigo-300 font-medium mb-2 text-xs uppercase",children:["影響對象: ",c.affected_scope]}),(0,s.jsx)("p",{className:"text-white text-sm leading-relaxed",children:c.impact_analysis||"尚無詳細分析"})]})]})]})]})]}),c.details&&c.details.length>0&&(0,s.jsxs)("div",{className:"border-t border-white/5 pt-4",children:[(0,s.jsx)("button",{onClick:()=>S(!k),className:"flex items-center gap-2 text-sm text-zinc-400 hover:text-white transition-colors w-full justify-center py-2",children:k?(0,s.jsxs)(s.Fragment,{children:[(0,s.jsx)(b.A,{className:"w-4 h-4"})," 收起完整規範細節"]}):(0,s.jsxs)(s.Fragment,{children:[(0,s.jsx)(j.A,{className:"w-4 h-4"})," 展開完整規範細節 (",c.details.length," 項)"]})}),k&&(0,s.jsx)("div",{className:"mt-4 grid grid-cols-1 md:grid-cols-2 gap-4 animate-in fade-in slide-in-from-top-2",children:c.details.map((e,t)=>(0,s.jsxs)("div",{className:"flex items-start gap-3 bg-black/40 p-3 rounded border border-zinc-800 text-sm text-zinc-300",children:[(0,s.jsx)("span",{className:"flex items-center justify-center w-5 h-5 rounded-full bg-zinc-800 text-zinc-500 text-xs shrink-0 mt-0.5",children:t+1}),(0,s.jsx)("span",{children:e})]},t))})]})]})}),(0,s.jsxs)("div",{className:"mt-8 border-t border-zinc-800 pt-6",children:[(0,s.jsxs)("div",{className:"flex items-center justify-between mb-4",children:[(0,s.jsxs)("div",{className:"flex items-center gap-2",children:[(0,s.jsx)(g.A,{className:"w-5 h-5 text-purple-400"}),(0,s.jsx)("h3",{className:"text-lg font-bold text-zinc-200",children:"政策影響比較表"})]}),(0,s.jsx)(y.N,{data:F,filename:"policy_comparison",label:"匯出政策表"})]}),(0,s.jsxs)("div",{className:"rounded-xl border border-white/10 overflow-hidden bg-black/20",children:[(0,s.jsxs)("div",{className:"grid grid-cols-12 gap-4 p-4 bg-zinc-900/50 border-b border-white/5 text-xs font-bold text-zinc-400 uppercase tracking-wider",children:[(0,s.jsx)("div",{className:"col-span-2",children:"實施日期"}),(0,s.jsx)("div",{className:"col-span-3",children:"政策/事件名稱"}),(0,s.jsx)("div",{className:"col-span-4",children:"變革內容 (Before vs After)"}),(0,s.jsx)("div",{className:"col-span-3",children:"影響對象與範圍"})]}),(0,s.jsx)("div",{className:"divide-y divide-white/5 max-h-[400px] overflow-y-auto custom-scrollbar",children:C.slice().reverse().map(e=>(0,s.jsxs)("div",{className:(0,l.cn)("grid grid-cols-12 gap-4 p-4 text-sm transition-colors hover:bg-white/5 cursor-pointer",c?.id===e.id?"bg-white/10":""),onClick:()=>N(e),children:[(0,s.jsx)("div",{className:"col-span-2 font-mono text-zinc-500",children:e.date}),(0,s.jsxs)("div",{className:"col-span-3 flex items-start gap-2",children:[(0,s.jsx)(o,{variant:"outline",className:(0,l.cn)("shrink-0 mt-0.5","finance"===e.category?"text-emerald-400 border-emerald-500/30":"text-rose-400 border-rose-500/30"),children:"finance"===e.category?"金融":"政策"}),(0,s.jsx)("span",{className:(0,l.cn)("font-medium","high"===e.impact?"text-white":"text-zinc-400"),children:e.title})]}),(0,s.jsx)("div",{className:"col-span-4 text-zinc-300",children:e.change_content?(0,s.jsxs)("div",{className:"flex items-center gap-2",children:[(0,s.jsx)("span",{className:"w-1.5 h-1.5 rounded-full bg-cyan-500 shrink-0"}),e.change_content]}):(0,s.jsx)("span",{className:"text-zinc-600 italic",children:"--"})}),(0,s.jsx)("div",{className:"col-span-3 text-zinc-400",children:e.affected_scope||(0,s.jsx)("span",{className:"text-zinc-600 italic",children:"--"})})]},e.id))})]})]})]})]})}},31840:(e,t,i)=>{i.d(t,{p:()=>w});var s=i(95155),n=i(12115),a=i(34361),r=i(65770),l=i(9921),c=i(66088),o=i(6296),d=i(61878),x=i(33210),m=i(18837),h=i(41641),p=i(21362),u=i(40980),f=i(88743),g=i(27529),b=i(55873),j=i(98883),v=i(51806),y=i(78795),N=i(70872);function w({data:e,trigger:t}){let{counties:i,districts:w,transactionType:z,buildingType:k,projectNames:S,dateRange:_,startDate:P,endDate:A}=(0,f.P)(),[M,C]=(0,n.useState)([]),[F,$]=(0,n.useState)(!1),[R,T]=(0,n.useState)(null),[E,D]=(0,n.useState)(1),[I,L]=(0,n.useState)(new Set),[O,B]=(0,n.useState)({key:"",direction:null}),[Z,W]=(0,n.useState)(""),[U,H]=(0,n.useState)("建案名稱"),[q,K]=(0,n.useState)(!1),[X,Y]=(0,n.useState)([]),[G,V]=(0,n.useState)(!1),[Q,J]=(0,n.useState)([]),[ee,et]=(0,n.useState)(""),ei=n.useRef(null),es=(0,n.useRef)({counties:i,districts:w,transactionType:z,buildingType:k,projectNames:S,dateRange:_,startDate:P,endDate:A});(0,n.useEffect)(()=>{es.current={counties:i,districts:w,transactionType:z,buildingType:k,projectNames:S,dateRange:_,startDate:P,endDate:A}});let en=(0,n.useCallback)(async()=>{let{counties:e,districts:t,transactionType:i,buildingType:s,projectNames:n,dateRange:a,startDate:r,endDate:l}=es.current;$(!0),T(null),C([]);try{if(0===e.length)return void $(!1);let c=r,o=l;if("custom"!==a){let e=(0,j.P)(a);e.startDate&&(c=e.startDate),e.endDate&&(o=e.endDate)}let d=e.map(async e=>{let a=b.WG[e],r=b.Ib[e]||[],l=t?t.filter(e=>r.includes(e)):[],d={countyCode:a,districts:l.length>0?l:void 0,type:i,dateStart:c,dateEnd:o,projectNames:n,buildingType:s};try{return await g.FH.fetchData(d,{page:1,limit:1e3})}catch(t){return console.warn(`Fetch failed for ${e}`,t),{data:[],count:0}}}),x=await Promise.all(d),m=[];x.forEach(e=>{e&&Array.isArray(e.data)&&(m=[...m,...e.data])}),m.sort((e,t)=>{let i=e["交易日"]||"";return(t["交易日"]||"").localeCompare(i)}),C(m)}catch(e){console.error("Data List fetch failed:",e),T(e.message||"讀取交易資料失敗")}finally{$(!1)}},[]),ea=JSON.stringify({counties:i,districts:w,transactionType:z,buildingType:k,projectNames:S,dateRange:_,startDate:P,endDate:A});(0,n.useEffect)(()=>{en()},[ea]),(0,n.useEffect)(()=>{t&&en()},[en,t]);let er=async e=>{V(!0),Y([]),J([]);let i=e["建案名稱"]||"未命名建案";et(`車位/附表明細 - ${i}`),K(!0);let s=[],n=e=>{console.log(e),s.push(e)};try{let a=e.編號,r=es.current?.transactionType||z;if(n(`TID: ${a}`),n(`Type: ${r}`),n(`Project: ${i}`),!a){n("Error: No Transaction ID"),J(s),V(!1);return}let l=[],c=e.縣市代碼;if(!c){let e=es.current?.counties||[];1===e.length&&(c=b.WG[e[0]])}if(!c&&e.地址)for(let[t,i]of Object.entries(b.WG)){if(e.地址.startsWith(t)){c=i;break}let s=t.replace("台","臺");if(e.地址.replace("台","臺").startsWith(s)){c=i;break}}if(n(`CountyCode: ${c} (Inferred: ${!e.縣市代碼})`),c){let t=e["交易類型"]||r;n(`Calling API with: ${a}, ${t}, ${c}`);try{let s=await g.FH.fetchSubData(a,t,c);s.park&&Array.isArray(s.park)&&s.park.length>0?(n(`API Success: Found ${s.park.length} park records`),l=s.park.map(t=>({車位類別:t["車位類別"]||"-","車位價格(萬)":t["車位價格(萬)"]||(t["車位價格"]?(Number(t["車位價格"])/1e4).toFixed(2):"-"),"車位面積(坪)":t["車位面積(坪)"]||(t["車位面積"]?(Number(t["車位面積"])/3.30579).toFixed(2):"-"),車位樓層:t["車位樓層"]||t["車位所在樓層"]||"-",建案名稱:t["建案名稱"]||i,交易日:t["交易日"]||e["交易日"],備註:t["備註"]||"",_category:"車位資料(來自API)"}))):n("API Result: No park data found"),s.build&&Array.isArray(s.build)&&s.build.length>0?(n(`API Success: Found ${s.build.length} build records`),l=[...l,...s.build.map(e=>({...e,_category:"建物明細"}))]):n("API Result: No build data found"),s.land&&Array.isArray(s.land)&&s.land.length>0?(n(`API Success: Found ${s.land.length} land records`),l=[...l,...s.land.map(e=>({...e,"土地移轉總面積(坪)":e["土地移轉總面積(平方公尺)"]?(.3025*Number(e["土地移轉總面積(平方公尺)"])).toFixed(2):"-",土地位置:e["土地區段位置"]||e["土地位置"]||"-",_category:"土地明細"}))]):n("API Result: No land data found")}catch(e){console.warn("API fetchSubData failed, proceeding to fallback:",e),n(`API Error: ${String(e)} - Proceeding to fallback`)}}else n("Skip API: No County Code");if(0===l.length&&t?.parkingAnalysis?.rampPlanePriceByFloor){n("Check AnalysisData RawRecords...");let s=t.parkingAnalysis.rampPlanePriceByFloor,r=[],c=e=>String(e||"").replace(/[^a-zA-Z0-9]/g,"").toUpperCase(),o=c(a);for(let e of(n(`Normalized Target ID: ${o}`),s))if(e.rawRecords&&Array.isArray(e.rawRecords)){let t=e.rawRecords.filter(e=>{let t=c(e.transactionId),i=c(e["編號"]);return t===o||i===o});t.length>0&&r.push(...t.map(t=>({...t,floorFromBucket:e.floor})))}if(r.length>0)for(let t of(n(`AnalysisData: Found ${r.length} matches`),n(`Match Data: ${JSON.stringify(r[0]).substring(0,100)}...`),r))l.push({車位類別:t["車位類別"]||"坡道平面","車位價格(萬)":t.parkingPrice||t["車位價格(萬)"]||"-","車位面積(坪)":t.parkingArea||t["車位面積(坪)"]||"-",車位樓層:t["車位所在樓層"]||t.floorFromBucket||"-",建案名稱:t["建案名稱"]||i,交易日:t["交易日"]||e["交易日"],備註:t["備註"]||"",_category:"車位資料(來自分析數據)"});else n("AnalysisData: No matches found")}if(0===l.length){n("Fallback: Using Main Record");let t=e["車位數"]&&Number(e["車位數"])>0,s=e["車位總價"]||e["車位總價(萬)"];if(t||s){let t=e["車位總價(萬)"]?Number(e["車位總價(萬)"]):e["車位總價"]?(Number(e["車位總價"])/1e4).toFixed(2):"-",s=e["車位面積(坪)"]?Number(e["車位面積(坪)"]):e["車位面積"]?(Number(e["車位面積"])/3.30579).toFixed(2):"-";l.push({車位類別:e["車位類別"]||"無資料","車位價格(萬)":t,"車位面積(坪)":s,車位樓層:"-",建案名稱:i,交易日:e["交易日"],備註:e["備註"]||"",_category:"車位資料(來自交易明細)"})}else n("Fallback: No parking info in main record")}Y(l),J(s)}catch(t){if(console.error("handleFetchSubTable error:",t),s.push(`Error: ${String(t)}`),J(s),e["車位數"]&&Number(e["車位數"])>0){let t=e["車位總價(萬)"]?Number(e["車位總價(萬)"]):e["車位總價"]?(Number(e["車位總價"])/1e4).toFixed(2):0,i=e["車位面積(坪)"]?Number(e["車位面積(坪)"]):e["車位面積"]?(Number(e["車位面積"])/3.30579).toFixed(2):0;Y([{車位類別:e["車位類別"]||"無資料","車位價格(萬)":t,"車位面積(坪)":i,車位樓層:"-",_category:"車位資料(來自交易明細)"}])}else Y([])}finally{V(!1)}},el=[{key:"行政區",label:"行政區",sortable:!0},{key:"建案名稱",label:"建案名稱",sortable:!0},{key:"交易日",label:"交易日",sortable:!0},{key:"交易筆棟數",label:"交易筆棟數",sortable:!1},{key:"主要用途",label:"主要用途",sortable:!1},{key:"建物型態",label:"建物型態",sortable:!1},{key:"戶型",label:"戶型",sortable:!0},{key:"樓層",label:"樓層",sortable:!0},{key:"房屋面積(坪)",label:"坪數",sortable:!0},{key:"房屋單價(萬)",label:"單價",sortable:!0}],ec=["編號","地址","總樓層","交易總價(萬)","房屋總價(萬)","車位總價(萬)","房數","廳數","衛浴數","備註","解約情形","戶別","主要用途","建物型態","車位類別","車位價格","車位面積","主建物面積","附屬建物面積","陽台面積","土地使用分區","地號","社區戶數"],eo=e=>{L(t=>{let i=new Set(t);return i.has(e)?i.delete(e):i.add(e),i})},ed=e=>null==e||""===e?"-":"number"==typeof e?Number.isInteger(e)?e.toLocaleString():e.toFixed(2):String(e),ex=(0,n.useMemo)(()=>{let e=[...M];if(Z.trim()){let t=Z.toLowerCase();e=e.filter(e=>{let i=e[U];return null!=i&&String(i).toLowerCase().includes(t)})}return O.key&&O.direction&&e.sort((e,t)=>{let i=e[O.key],s=t[O.key];if(null==i&&null==s)return 0;if(null==i)return 1;if(null==s)return -1;if("number"==typeof i&&"number"==typeof s)return"asc"===O.direction?i-s:s-i;let n=String(i),a=String(s);return"asc"===O.direction?n.localeCompare(a,"zh-TW"):a.localeCompare(n,"zh-TW")}),e},[M,Z,U,O]),em=Math.ceil(ex.length/20),eh=(E-1)*20,ep=eh+20,eu=ex.slice(eh,ep);return F?(0,s.jsxs)("div",{className:"flex flex-col items-center justify-center py-20",children:[(0,s.jsx)(o.A,{className:"h-8 w-8 animate-spin text-violet-500 mb-2"}),(0,s.jsx)("p",{className:"text-zinc-500 text-sm",children:"正在載入交易資料相關明細..."})]}):R?(0,s.jsxs)("div",{className:"text-center p-12 text-red-400",children:[(0,s.jsxs)("p",{children:["載入失敗: ",R]}),(0,s.jsx)("button",{onClick:()=>en(),className:"mt-4 px-4 py-2 bg-zinc-800 rounded hover:bg-zinc-700",children:"重試"})]}):M&&0!==M.length?(0,s.jsxs)("div",{className:"space-y-4 animate-in fade-in slide-in-from-bottom-4 duration-500",children:[(0,s.jsxs)("div",{className:"flex flex-wrap gap-3 items-center p-3 bg-zinc-900/50 rounded-lg border border-white/5",children:[(0,s.jsxs)("div",{className:"flex items-center gap-2 flex-1 min-w-[200px]",children:[(0,s.jsx)(d.A,{size:16,className:"text-zinc-500"}),(0,s.jsx)("input",{type:"text",value:Z,onChange:e=>{W(e.target.value),D(1)},placeholder:`搜尋 ${U}...`,className:"flex-1 bg-transparent border-none outline-none text-white placeholder-zinc-500 text-sm"}),Z&&(0,s.jsx)("button",{onClick:()=>W(""),className:"text-zinc-500 hover:text-white",children:(0,s.jsx)(x.A,{size:14})})]}),(0,s.jsxs)("select",{value:U,onChange:e=>H(e.target.value),className:"bg-zinc-800 border border-zinc-700 rounded px-2 py-1 text-sm text-zinc-300",children:[(0,s.jsx)("option",{value:"建案名稱",children:"建案名稱"}),(0,s.jsx)("option",{value:"行政區",children:"行政區"}),(0,s.jsx)("option",{value:"戶型",children:"戶型"}),(0,s.jsx)("option",{value:"主要用途",children:"主要用途"})]})]}),(0,s.jsxs)("div",{className:"flex justify-between items-center text-sm text-zinc-400",children:[(0,s.jsxs)("span",{children:["共 ",(0,s.jsx)("span",{className:"text-white font-semibold",children:ex.length.toLocaleString()})," 筆資料 ",Z&&(0,s.jsx)("span",{className:"text-zinc-500",children:"(已篩選)"})]}),(0,s.jsxs)("span",{children:["第 ",E," / ",em||1," 頁"]})]}),(0,s.jsxs)(a.c,{title:"交易資料明細",description:"點擊表頭可排序，點擊「明細」可展開詳細資訊",containerRef:ei,headerAction:(0,s.jsx)(y.N,{data:ex,filename:"transaction_list_data",label:"匯出",chartType:"data-list",targetRef:ei}),children:[(0,s.jsx)("div",{className:"hidden md:block overflow-x-auto",children:(0,s.jsxs)("table",{className:"w-full text-sm text-left",children:[(0,s.jsx)("thead",{className:"bg-zinc-900/80 text-zinc-400 uppercase text-xs font-semibold sticky top-0",children:(0,s.jsxs)("tr",{children:[(0,s.jsx)("th",{className:"px-3 py-3 w-20 text-center",children:"操作"}),el.map(e=>{var t;return(0,s.jsx)("th",{className:(0,u.cn)("px-3 py-3 text-left whitespace-nowrap",e.sortable&&"cursor-pointer select-none group hover:text-white transition-colors","建案名稱"===e.key&&"min-w-[120px] max-w-[200px] whitespace-normal","行政區"===e.key&&"w-20","交易日"===e.key&&"w-24",("房屋單價(萬)"===e.key||"房屋面積(坪)"===e.key)&&"text-right"),onClick:()=>{var t;return e.sortable&&(t=e.key,void(B(e=>{if(e.key===t){if("asc"===e.direction)return{key:t,direction:"desc"};if("desc"===e.direction)return{key:"",direction:null}}return{key:t,direction:"asc"}}),D(1)))},children:(0,s.jsxs)("div",{className:(0,u.cn)("flex items-center gap-1",("房屋單價(萬)"===e.key||"房屋面積(坪)"===e.key)&&"justify-end"),children:[e.label,e.sortable&&(t=e.key,O.key!==t?(0,s.jsx)(r.A,{size:12,className:"opacity-30 group-hover:opacity-70"}):"asc"===O.direction?(0,s.jsx)(l.A,{size:12,className:"text-violet-400"}):(0,s.jsx)(c.A,{size:12,className:"text-violet-400"}))]})},e.key)})]})}),(0,s.jsx)("tbody",{className:"divide-y divide-white/5",children:eu.map((e,t)=>{let i=eh+t,a=I.has(i);return(0,s.jsxs)(n.Fragment,{children:[(0,s.jsxs)("tr",{className:(0,u.cn)("hover:bg-zinc-800/50 transition-colors",a&&"bg-zinc-800/30"),children:[(0,s.jsx)("td",{className:"px-3 py-2",children:(0,s.jsxs)("div",{className:"flex items-center gap-2 justify-center",children:[(0,s.jsxs)("button",{onClick:()=>er(e),className:"px-2 py-1 rounded text-xs font-medium bg-cyan-900/30 text-cyan-400 hover:bg-cyan-900/50 hover:text-cyan-300 transition-colors flex items-center gap-1 border border-cyan-800/50 active:scale-95",title:"查看車位或其他附表資料",children:[(0,s.jsx)(m.A,{size:12}),"附表"]}),(0,s.jsxs)("button",{onClick:()=>eo(i),className:(0,u.cn)("flex items-center gap-1 px-2 py-1 rounded text-xs font-medium transition-colors border active:scale-95",a?"bg-violet-500/20 text-violet-300 border-violet-500/30":"bg-zinc-800 text-zinc-400 border-zinc-700 hover:bg-zinc-700 hover:text-zinc-200"),children:[a?(0,s.jsx)(l.A,{size:12}):(0,s.jsx)(c.A,{size:12}),"明細"]})]})}),el.map(t=>(0,s.jsx)("td",{className:(0,u.cn)("px-3 py-2","建案名稱"===t.key?"whitespace-normal min-w-[120px] max-w-[200px]":"whitespace-nowrap",("房屋單價(萬)"===t.key||"房屋面積(坪)"===t.key)&&"text-right"),children:"戶型"===t.key?(0,s.jsx)(N.Bc,{delayDuration:100,children:(0,s.jsxs)(N.m_,{children:[(0,s.jsx)(N.k$,{asChild:!0,children:(0,s.jsx)("span",{className:"cursor-help border-b border-dotted border-zinc-600 block truncate max-w-[80px]",children:ed(e[t.key])})}),(0,s.jsx)(N.ZI,{side:"top",className:"max-w-[200px]",children:(0,s.jsxs)("p",{className:"text-xs",children:["原始戶別: ",(0,s.jsx)("strong",{children:e["戶別"]||"無資料"})]})})]})}):"主要用途"===t.key?(0,s.jsx)("span",{className:"text-zinc-300",children:"見其他登記事項"===e["主要用途"]?"其他":ed(e[t.key])}):(0,s.jsx)("span",{className:(0,u.cn)("房屋單價(萬)"===t.key&&"font-mono text-violet-400 font-bold","建案名稱"===t.key&&"font-medium text-white text-sm leading-tight block","建案名稱"!==t.key&&"房屋單價(萬)"!==t.key&&"text-zinc-300"),children:ed(e[t.key])})},t.key))]}),a&&(0,s.jsx)("tr",{className:"bg-zinc-900/50",children:(0,s.jsx)("td",{colSpan:el.length+1,className:"px-4 py-4",children:(0,s.jsx)("div",{className:"grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 lg:grid-cols-6 gap-3",children:ec.map(t=>t in e?(0,s.jsxs)("div",{className:"bg-zinc-800/50 rounded p-2",children:[(0,s.jsx)("div",{className:"text-xs text-zinc-500 mb-1",children:t}),(0,s.jsx)("div",{className:"text-sm text-zinc-200 font-mono",children:ed(e[t])})]},t):null)})})})]},i)})})]})}),(0,s.jsxs)("div",{className:"md:hidden space-y-4",children:[eu.map((e,t)=>{let i=eh+t,n=I.has(i);return(0,s.jsxs)("div",{className:(0,u.cn)("bg-zinc-900/40 border border-white/5 rounded-xl overflow-hidden transition-all duration-200",n?"ring-1 ring-violet-500/30 bg-zinc-900/60":"hover:bg-zinc-900/60"),children:[(0,s.jsxs)("div",{className:"p-4",onClick:()=>eo(i),children:[(0,s.jsxs)("div",{className:"flex justify-between items-start mb-3",children:[(0,s.jsxs)("div",{children:[(0,s.jsxs)("div",{className:"flex items-center gap-2 mb-1",children:[(0,s.jsx)("span",{className:"text-xs font-medium px-1.5 py-0.5 rounded bg-zinc-800 text-zinc-400",children:e["行政區"]}),(0,s.jsx)("h3",{className:"text-base font-bold text-white leading-tight",children:e["建案名稱"]})]}),(0,s.jsxs)("div",{className:"text-xs text-zinc-500 font-mono",children:[e["交易日"]," • ",e["戶型"]||"-"]})]}),(0,s.jsxs)("div",{className:"text-right",children:[(0,s.jsxs)("div",{className:"text-lg font-bold text-violet-400 font-mono leading-none",children:[ed(e["房屋單價(萬)"]),(0,s.jsx)("span",{className:"text-xs text-zinc-500 font-normal ml-0.5",children:"萬/坪"})]}),(0,s.jsxs)("div",{className:"text-xs text-zinc-500 mt-1",children:[ed(e["交易總價(萬)"])," 萬"]})]})]}),(0,s.jsxs)("div",{className:"grid grid-cols-3 gap-2 py-3 border-t border-white/5",children:[(0,s.jsxs)("div",{className:"text-center",children:[(0,s.jsx)("div",{className:"text-[10px] text-zinc-500 mb-0.5",children:"樓層"}),(0,s.jsxs)("div",{className:"text-sm font-medium text-zinc-300",children:[ed(e["樓層"]),"F"]})]}),(0,s.jsxs)("div",{className:"text-center border-l border-white/5",children:[(0,s.jsx)("div",{className:"text-[10px] text-zinc-500 mb-0.5",children:"坪數"}),(0,s.jsx)("div",{className:"text-sm font-medium text-zinc-300",children:ed(e["房屋面積(坪)"])})]}),(0,s.jsxs)("div",{className:"text-center border-l border-white/5",children:[(0,s.jsx)("div",{className:"text-[10px] text-zinc-500 mb-0.5",children:"車位"}),(0,s.jsx)("div",{className:"text-sm font-medium text-zinc-300",children:ed(e["車位總價(萬)"])})]})]}),(0,s.jsxs)("div",{className:"flex gap-2 mt-2",children:[(0,s.jsxs)("button",{onClick:t=>{t.stopPropagation(),er(e)},className:"flex-1 py-2 rounded-lg text-xs font-medium bg-cyan-900/20 text-cyan-400 border border-cyan-800/30 flex items-center justify-center gap-1.5 active:scale-[0.98] transition-all",children:[(0,s.jsx)(m.A,{size:14}),"查看附表"]}),(0,s.jsxs)("button",{onClick:e=>{e.stopPropagation(),eo(i)},className:(0,u.cn)("flex-1 py-2 rounded-lg text-xs font-medium border flex items-center justify-center gap-1.5 active:scale-[0.98] transition-all",n?"bg-violet-500/10 text-violet-300 border-violet-500/30":"bg-zinc-800/50 text-zinc-300 border-zinc-700"),children:[n?"收合明細":"顯示明細",n?(0,s.jsx)(l.A,{size:14}):(0,s.jsx)(c.A,{size:14})]})]})]}),n&&(0,s.jsx)("div",{className:"bg-zinc-950/50 border-t border-white/5 p-4 animate-accordion-down",children:(0,s.jsx)("div",{className:"grid grid-cols-2 gap-x-4 gap-y-3",children:ec.map(t=>t in e?(0,s.jsxs)("div",{className:"overflow-hidden",children:[(0,s.jsx)("div",{className:"text-[10px] text-zinc-500 truncate",children:t}),(0,s.jsx)("div",{className:"text-sm text-zinc-300 font-mono truncate",children:ed(e[t])})]},t):null)})})]},i)}),0===eu.length&&(0,s.jsx)("div",{className:"text-center py-12 text-zinc-500 bg-zinc-900/20 rounded-xl border border-dashed border-zinc-800",children:"無符合條件的資料"})]})]}),(0,s.jsxs)("div",{className:"flex justify-between items-center pt-4 border-t border-white/5",children:[(0,s.jsxs)("div",{className:"text-sm text-zinc-500",children:["顯示第 ",ex.length>0?eh+1:0," - ",Math.min(ep,ex.length)," 筆"]}),(0,s.jsxs)("div",{className:"flex items-center gap-2",children:[(0,s.jsx)("button",{onClick:()=>D(e=>Math.max(1,e-1)),disabled:1===E,className:"p-2 rounded bg-zinc-800 text-zinc-300 hover:bg-zinc-700 disabled:opacity-50 disabled:cursor-not-allowed transition-colors",children:(0,s.jsx)(h.A,{size:16})}),(0,s.jsx)("div",{className:"flex gap-1",children:Array.from({length:Math.min(5,em||1)},(e,t)=>{let i,n=em||1;return(i=n<=5||E<=3?t+1:E>=n-2?n-4+t:E-2+t)<1||i>n?null:(0,s.jsx)("button",{onClick:()=>D(i),className:(0,u.cn)("w-8 h-8 rounded text-sm font-medium transition-colors",E===i?"bg-violet-500 text-white":"bg-zinc-800 text-zinc-400 hover:bg-zinc-700"),children:i},i)})}),(0,s.jsx)("button",{onClick:()=>D(e=>Math.min(em||1,e+1)),disabled:E===em||0===em,className:"p-2 rounded bg-zinc-800 text-zinc-300 hover:bg-zinc-700 disabled:opacity-50 disabled:cursor-not-allowed transition-colors",children:(0,s.jsx)(p.A,{size:16})})]})]}),(0,s.jsx)(v.a,{isOpen:q,onClose:()=>K(!1),className:"max-w-5xl",title:(0,s.jsxs)("div",{className:"flex items-center justify-between w-full",children:[(0,s.jsxs)("div",{className:"flex items-center gap-2",children:[(0,s.jsx)(m.A,{className:"text-cyan-400"}),(0,s.jsx)("span",{children:ee})]}),(0,s.jsx)(y.N,{data:X,filename:`sub_table_${ee}`,label:"匯出附表",className:"ml-4"})]}),children:G?(0,s.jsxs)("div",{className:"flex flex-col items-center justify-center py-12",children:[(0,s.jsx)(o.A,{className:"h-8 w-8 animate-spin text-cyan-400 mb-3"}),(0,s.jsx)("p",{className:"text-zinc-500 text-sm animate-pulse",children:"正在讀取附表資料..."})]}):X.length>0?(0,s.jsxs)("div",{className:"space-y-8",children:[X.some(e=>e._category.includes("車位"))&&(0,s.jsxs)("div",{className:"space-y-3",children:[(0,s.jsxs)("h4",{className:"text-sm font-bold text-violet-400 flex items-center gap-2",children:[(0,s.jsx)("div",{className:"w-1 h-4 bg-violet-500 rounded-full"}),"車位明細"]}),(0,s.jsx)("div",{className:"bg-zinc-800/30 rounded-lg overflow-hidden border border-white/5",children:(0,s.jsx)("div",{className:"overflow-x-auto",children:(0,s.jsxs)("table",{className:"w-full text-sm text-left",children:[(0,s.jsx)("thead",{className:"bg-zinc-900/80 text-zinc-400 uppercase text-xs font-semibold",children:(0,s.jsxs)("tr",{children:[(0,s.jsx)("th",{className:"px-4 py-3 whitespace-nowrap bg-zinc-900 text-cyan-400",children:"來源"}),["車位類別","車位價格(萬)","車位面積(坪)","車位樓層","建案名稱","備註"].map(e=>(0,s.jsx)("th",{className:"px-4 py-3 whitespace-nowrap bg-zinc-900",children:e},e))]})}),(0,s.jsx)("tbody",{className:"divide-y divide-white/5",children:X.filter(e=>e._category.includes("車位")).map((e,t)=>(0,s.jsxs)("tr",{className:"hover:bg-zinc-800/50 transition-colors",children:[(0,s.jsx)("td",{className:"px-4 py-3 whitespace-nowrap text-cyan-400 font-medium text-xs",children:e._category.replace("車位資料","").replace(/[()]/g,"")||"API"}),["車位類別","車位價格(萬)","車位面積(坪)","車位樓層","建案名稱","備註"].map(t=>(0,s.jsx)("td",{className:"px-4 py-3 whitespace-nowrap text-zinc-300",children:ed(e[t])},t))]},t))})]})})})]}),X.some(e=>e._category.includes("建物"))&&(0,s.jsxs)("div",{className:"space-y-3",children:[(0,s.jsxs)("h4",{className:"text-sm font-bold text-emerald-400 flex items-center gap-2",children:[(0,s.jsx)("div",{className:"w-1 h-4 bg-emerald-500 rounded-full"}),"建物明細"]}),(0,s.jsx)("div",{className:"bg-zinc-800/30 rounded-lg overflow-hidden border border-white/5",children:(0,s.jsx)("div",{className:"overflow-x-auto",children:(0,s.jsxs)("table",{className:"w-full text-sm text-left",children:[(0,s.jsx)("thead",{className:"bg-zinc-900/80 text-zinc-400 uppercase text-xs font-semibold",children:(0,s.jsx)("tr",{children:Array.from(new Set(X.filter(e=>e._category.includes("建物")).flatMap(Object.keys))).filter(e=>!["id","編號","created_at","_category","rawRecords"].includes(e)).map(e=>(0,s.jsx)("th",{className:"px-4 py-3 whitespace-nowrap bg-zinc-900",children:e},e))})}),(0,s.jsx)("tbody",{className:"divide-y divide-white/5",children:X.filter(e=>e._category.includes("建物")).map((e,t)=>(0,s.jsx)("tr",{className:"hover:bg-zinc-800/50 transition-colors",children:Array.from(new Set(X.filter(e=>e._category.includes("建物")).flatMap(Object.keys))).filter(e=>!["id","編號","created_at","_category","rawRecords"].includes(e)).map(t=>(0,s.jsx)("td",{className:"px-4 py-3 whitespace-nowrap text-zinc-300",children:ed(e[t])},t))},t))})]})})})]}),X.some(e=>e._category.includes("土地"))&&(0,s.jsxs)("div",{className:"space-y-3",children:[(0,s.jsxs)("h4",{className:"text-sm font-bold text-amber-400 flex items-center gap-2",children:[(0,s.jsx)("div",{className:"w-1 h-4 bg-amber-500 rounded-full"}),"土地明細"]}),(0,s.jsx)("div",{className:"bg-zinc-800/30 rounded-lg overflow-hidden border border-white/5",children:(0,s.jsx)("div",{className:"overflow-x-auto",children:(0,s.jsxs)("table",{className:"w-full text-sm text-left",children:[(0,s.jsx)("thead",{className:"bg-zinc-900/80 text-zinc-400 uppercase text-xs font-semibold",children:(0,s.jsx)("tr",{children:Array.from(new Set(X.filter(e=>e._category.includes("土地")).flatMap(Object.keys))).filter(e=>!["id","編號","created_at","_category","rawRecords"].includes(e)).map(e=>(0,s.jsx)("th",{className:"px-4 py-3 whitespace-nowrap bg-zinc-900",children:e},e))})}),(0,s.jsx)("tbody",{className:"divide-y divide-white/5",children:X.filter(e=>e._category.includes("土地")).map((e,t)=>(0,s.jsx)("tr",{className:"hover:bg-zinc-800/50 transition-colors",children:Array.from(new Set(X.filter(e=>e._category.includes("土地")).flatMap(Object.keys))).filter(e=>!["id","編號","created_at","_category","rawRecords"].includes(e)).map(t=>(0,s.jsx)("td",{className:"px-4 py-3 whitespace-nowrap text-zinc-300",children:ed(e[t])},t))},t))})]})})})]}),(0,s.jsx)("div",{className:"flex justify-end",children:(0,s.jsx)("button",{onClick:()=>K(!1),className:"px-4 py-2 bg-zinc-800 hover:bg-zinc-700 text-sm text-white rounded transition-colors",children:"關閉"})})]}):(0,s.jsxs)("div",{className:"flex flex-col items-center justify-center py-12 text-zinc-500",children:[(0,s.jsx)("div",{className:"bg-zinc-800/50 p-4 rounded-full mb-3",children:(0,s.jsx)(m.A,{size:24,className:"opacity-20"})}),(0,s.jsx)("p",{children:"此筆交易沒有相關附表資料"})]})})]}):(0,s.jsx)("div",{className:"text-center p-12 text-zinc-500",children:"無交易資料可顯示"})}},34361:(e,t,i)=>{i.d(t,{c:()=>r});var s=i(95155);i(12115);var n=i(40980),a=i(88743);function r({title:e,description:t,children:i,headerAction:r,className:l,containerRef:c}){let o,d,x=(o=a.P.getState(),d=[],o.counties.length>0&&(o.districts.length>0?d.push(`${o.counties.join(", ")} - ${o.districts.join(", ")}`):d.push(o.counties.join(", "))),o.startDate&&o.endDate?d.push(`${o.startDate} ~ ${o.endDate}`):o.dateRange&&"custom"!==o.dateRange&&d.push({"1m":"近1個月","3m":"近3個月","6m":"近6個月","1y":"近1年","2y":"近2年",all:"全部時間"}[o.dateRange]||o.dateRange),o.transactionType&&d.push(o.transactionType),o.buildingType&&""!==o.buildingType&&d.push(o.buildingType),o.projectNames.length>0&&o.projectNames.length<=3?d.push(o.projectNames.join(", ")):o.projectNames.length>3&&d.push(`${o.projectNames.length} 個建案`),o.excludeCommercial&&d.push("排除商業/辦公"),d.length>0?d.join(" | "):"所有條件");return(0,s.jsxs)("div",{ref:c,className:(0,n.cn)("bg-zinc-900/50 border border-white/5 rounded-2xl p-4 md:p-6 backdrop-blur-sm",l),children:[(0,s.jsxs)("div",{className:"flex flex-col md:flex-row md:items-center justify-between gap-4 mb-6",children:[(0,s.jsxs)("div",{children:[(0,s.jsx)("h3",{className:"text-xl font-bold text-white flex items-center gap-2",children:e}),t&&(0,s.jsx)("p",{className:"text-zinc-400 text-sm mt-1",children:t})]}),r&&(0,s.jsx)("div",{className:"flex-shrink-0 w-full md:w-auto overflow-x-auto","data-html2canvas-ignore":"true",children:r})]}),i,(0,s.jsxs)("div",{className:"mt-4 pt-3 border-t border-white/10 flex flex-col sm:flex-row justify-between items-start sm:items-center gap-2 text-xs",style:{display:"none"},"data-export-footer":"true",children:[(0,s.jsx)("div",{className:"text-white font-semibold text-sm",children:"彙整：平米內參 　來源：內政部實登"}),(0,s.jsxs)("div",{className:"text-zinc-400 text-right",children:["搜尋條件：",x]})]})]})}},37847:(e,t,i)=>{i.d(t,{v:()=>w});var s=i(95155),n=i(12115),a=i(34361),r=i(97085);function l({data:e}){let t=(0,n.useMemo)(()=>e?[e.withParking.count,e.withoutParking.count]:[],[e]),i=(0,n.useMemo)(()=>({chart:{type:"donut",background:"transparent",foreColor:"#e5e7eb"},labels:["含車位","無車位"],colors:["#a5b4fc","#4b5563"],plotOptions:{pie:{donut:{labels:{show:!0,total:{show:!0,label:"總交易",color:"#e5e7eb",formatter:e=>e.globals.seriesTotals.reduce((e,t)=>e+t,0).toLocaleString()+" 筆"}}}}},dataLabels:{enabled:!0,formatter:e=>`${e.toFixed(1)}%`},legend:{show:!1},tooltip:{theme:"dark",y:{formatter:e=>`${e} 筆`}},stroke:{show:!1},responsive:[{breakpoint:480,options:{chart:{width:300},legend:{position:"bottom"}}}]}),[]);return e&&(0!==e.withParking.count||0!==e.withoutParking.count)?(0,s.jsx)(r.A,{type:"donut",series:t,options:i,height:350,className:"w-full"}):(0,s.jsx)("div",{className:"text-zinc-500 text-center p-8",children:"無車位配比資料"})}var c=i(40980);function o({data:e,xLabel:t,yLabel:i,xUnit:a="",yUnit:r="",title:l,highlightIds:o=[]}){let[d,x]=(0,n.useState)(null),[m,h]=(0,n.useState)(null),[p,u]=(0,n.useState)({x:0,y:0}),{xMin:f,xMax:g,yMin:b,yMax:j}=(0,n.useMemo)(()=>{if(0===e.length)return{xMin:0,xMax:100,yMin:0,yMax:100};let t=e.map(e=>e.x),i=e.map(e=>e.y),s=Math.min(...t),n=Math.max(...t),a=Math.min(...i),r=Math.max(...i),l=(n-s)*.1||1,c=(r-a)*.1||1;return{xMin:Math.max(0,s-l),xMax:n+l,yMin:Math.max(0,a-c),yMax:r+c}},[e]),v=o.length>0,y=e=>{let t=e.currentTarget.closest(".relative.bg-zinc-900\\/30")?.getBoundingClientRect();t&&u({x:e.clientX-t.left,y:e.clientY-t.top})},N=m||d,w=(0,n.useMemo)(()=>o.length?[...e].sort((e,t)=>!!o.includes(e.id)-!!o.includes(t.id)):e,[e,o]);return(0,s.jsxs)("div",{className:"w-full h-[400px] relative bg-zinc-900/30 rounded-xl border border-white/5 p-4 select-none cursor-crosshair",onClick:()=>{h(null),x(null)},onMouseMove:e=>{!m&&d&&y(e)},children:[l&&(0,s.jsx)("h4",{className:"absolute top-4 left-4 text-sm font-medium text-zinc-400 pointer-events-none",children:l}),(0,s.jsxs)("div",{className:"absolute inset-x-12 inset-y-12 pointer-events-none",children:[(0,s.jsx)("div",{className:"absolute inset-0 flex flex-col justify-between opacity-20",children:[0,.25,.5,.75,1].map(e=>(0,s.jsx)("div",{className:"w-full h-px border-t border-dashed border-zinc-500"},e))}),(0,s.jsx)("div",{className:"absolute inset-0 flex justify-between opacity-20",children:[0,.25,.5,.75,1].map(e=>(0,s.jsx)("div",{className:"h-full w-px border-l border-dashed border-zinc-500"},e))})]}),(0,s.jsx)("div",{className:"absolute inset-x-12 inset-y-12",children:w.map(e=>{var t,i;let n=(t=e.x,i=e.y,{left:`${(t-f)/(g-f)*100}%`,top:`${100-(i-b)/(j-b)*100}%`}),a=d?.id===e.id,r=m?.id===e.id,l=v&&o.includes(e.id),p="bg-cyan-500/60 hover:bg-cyan-400 z-10",u="";return v&&(l?(p="bg-yellow-400 shadow-[0_0_10px_rgba(250,204,21,0.6)] z-20",u="scale-125"):p="bg-zinc-700/30 z-0"),(a||r)&&(p="bg-cyan-400 shadow-[0_0_15px_rgba(34,211,238,0.8)] ring-2 ring-white z-30",u="scale-150",v&&l&&(p="bg-yellow-400 shadow-[0_0_15px_rgba(250,204,21,0.8)] ring-2 ring-white z-30")),(0,s.jsx)("div",{className:(0,c.cn)("absolute w-3 h-3 rounded-full cursor-pointer transition-all duration-300 transform -translate-x-1/2 -translate-y-1/2",p,u),style:{left:n.left,top:n.top},onMouseEnter:t=>{m||(!v||o.includes(e.id))&&(x(e),y(t))},onMouseLeave:()=>!m&&x(null),onClick:t=>{t.stopPropagation(),(!v||o.includes(e.id))&&(m?.id===e.id?(h(null),x(e)):(h(e),x(null),y(t)))}},e.id)})}),(0,s.jsxs)("div",{className:"absolute left-0 top-12 bottom-12 w-10 flex flex-col justify-between text-[10px] text-zinc-500 text-right pr-2 pointer-events-none",children:[(0,s.jsxs)("span",{children:[Math.round(j),r]}),(0,s.jsxs)("span",{children:[Math.round(b),r]})]}),(0,s.jsxs)("div",{className:"absolute left-12 right-12 bottom-4 h-6 flex justify-between text-[10px] text-zinc-500 pt-1 pointer-events-none",children:[(0,s.jsxs)("span",{children:[Math.round(f),a]}),(0,s.jsxs)("span",{children:[Math.round(g),a]})]}),(0,s.jsx)("div",{className:"absolute bottom-1 left-1/2 -translate-x-1/2 text-xs text-zinc-400 font-bold pointer-events-none",children:t}),(0,s.jsx)("div",{className:"absolute left-1 top-1/2 -translate-y-1/2 -rotate-90 text-xs text-zinc-400 font-bold pointer-events-none",children:i}),N&&(0,s.jsx)("div",{className:"absolute z-50 pointer-events-none",style:{left:p.x,top:p.y,transform:"translate(10px, 10px)"},children:(0,s.jsxs)("div",{className:"bg-zinc-950/90 border border-cyan-500/30 rounded-lg p-3 shadow-xl backdrop-blur-md w-48 animate-in zoom-in-95 fade-in duration-200",children:[(0,s.jsx)("div",{className:"text-sm font-bold text-white mb-1",children:N.label}),(0,s.jsxs)("div",{className:"space-y-1 text-xs text-zinc-400",children:[(0,s.jsxs)("div",{className:"flex justify-between",children:[(0,s.jsxs)("span",{children:[t,":"]}),(0,s.jsxs)("span",{className:"text-cyan-400 font-mono",children:[N.x.toLocaleString()," ",a]})]}),(0,s.jsxs)("div",{className:"flex justify-between",children:[(0,s.jsxs)("span",{children:[i,":"]}),(0,s.jsxs)("span",{className:"text-cyan-400 font-mono",children:[N.y.toLocaleString()," ",r]})]})]})]})})]})}var d=i(47650),x=i(39430),m=i(80642);function h({data:e,selectedFloors:t,hoveredFloor:i,onHover:a,onToggle:r,onDetail:l,floorColors:o}){let h=[...e].sort((e,t)=>{let i=e=>"B1"===e?1:"B2"===e?2:"B3"===e?3:"B4"===e?4:e.includes("B5")?5:99;return i(e.floor)-i(t.floor)}),u=h.length>4?Math.max(.7,4/h.length):1,f=n.useRef(null),[g,b]=n.useState(!1);n.useEffect(()=>{b(!0)},[]);let j=h.find(e=>e.floor===i);return(0,s.jsxs)("div",{className:"w-full h-[600px] flex items-start justify-start relative perspective-container overflow-visible pl-12 lg:pl-24 -mt-12",onMouseMove:e=>{if(f.current){let t=e.clientX+12,i=e.clientY+12;f.current.style.transform=`translate3d(${t}px, ${i}px, 0)`}},children:[(0,s.jsx)("div",{className:"relative flex items-center justify-center preserve-3d",style:{width:240,height:240,perspective:"3000px",transformStyle:"preserve-3d",zIndex:10,transform:`scale(${u})`},children:(0,s.jsx)(x.P.div,{className:"relative preserve-3d",initial:{rotateX:60,rotateZ:45},animate:{rotateX:60,rotateZ:45},transition:{duration:.8,ease:"easeOut"},style:{transformStyle:"preserve-3d",width:"100%",height:"100%"},children:(0,s.jsx)(m.N,{children:h.map((e,n)=>{let r=t.includes(e.floor),c=i===e.floor,d=o[e.floor]||"#71717a";return(0,s.jsx)(p,{data:e,color:d,isSelected:r,isHovered:c,active:r,onHover:()=>a(e.floor),onLeave:()=>a(null),onDetail:()=>l(e.floor),zIndex:h.length-n,baseZ:-(110*n),thickness:40},e.floor)})})})}),g&&(0,d.createPortal)((0,s.jsx)("div",{className:"fixed inset-0 pointer-events-none z-[9999]",children:(0,s.jsx)(m.N,{children:j&&(0,s.jsx)("div",{ref:f,className:"absolute top-0 left-0 will-change-transform",style:{transform:"translate3d(-500px, -500px, 0)"},children:(0,s.jsx)(x.P.div,{initial:{opacity:0,scale:.95},animate:{opacity:1,scale:1},exit:{opacity:0,scale:.95,transition:{duration:.1}},transition:{type:"spring",stiffness:400,damping:25},className:"flex items-center justify-start",children:(0,s.jsxs)("div",{className:"flex items-center gap-3 whitespace-nowrap",children:[(0,s.jsx)("span",{className:(0,c.cn)("text-6xl font-black text-white drop-shadow-[0_5px_8px_rgba(0,0,0,0.8)] leading-none","font-sans italic tracking-tighter"),style:{textShadow:"0 0 30px rgba(255,255,255,0.4)"},children:j.floor}),(0,s.jsxs)("div",{className:"bg-zinc-950/95 border-l-4 border-cyan-500 backdrop-blur-xl px-4 py-2 rounded-r-lg shadow-[0_20px_50px_rgba(0,0,0,0.5)] flex items-center gap-6 border border-white/10",children:[(0,s.jsxs)("div",{children:[(0,s.jsx)("div",{className:"text-[10px] text-zinc-500 uppercase font-black leading-none mb-1 tracking-widest",children:"均價 (萬)"}),(0,s.jsx)("div",{className:"text-2xl font-mono font-bold text-cyan-400 leading-none",children:Math.round(j.avgPrice).toLocaleString()})]}),(0,s.jsx)("div",{className:"h-8 w-px bg-white/10"}),(0,s.jsxs)("div",{children:[(0,s.jsx)("div",{className:"text-[10px] text-zinc-500 uppercase font-black leading-none mb-1 tracking-widest",children:"成交量"}),(0,s.jsx)("div",{className:"text-xl font-mono text-zinc-100 leading-none font-medium",children:j.count})]})]})]})},"tooltip")})})}),document.body)]})}function p({data:e,color:t,isSelected:i,isHovered:n,active:a,onHover:r,onLeave:l,onDetail:o,zIndex:d,baseZ:m,thickness:h}){let p=n?t:"#52525b";return(0,s.jsxs)(x.P.div,{className:(0,c.cn)("absolute top-0 left-0 w-full h-full preserve-3d pointer-events-none",!a&&"pointer-events-none"),initial:{scale:.9,opacity:0},animate:{translateZ:m+0,scale:+!!a,opacity:+!!a},transition:{type:"spring",stiffness:600,damping:15},style:{transformStyle:"preserve-3d",zIndex:d},children:[(0,s.jsx)("div",{className:"absolute inset-0 rounded-sm overflow-hidden transition-all duration-75 pointer-events-auto cursor-pointer",style:{backgroundColor:p,backgroundImage:n?"linear-gradient(135deg, rgba(255,255,255,0.6) 0%, rgba(255,255,255,0.1) 50%, rgba(0,0,0,0.2) 100%)":"linear-gradient(135deg, rgba(255,255,255,0.2) 0%, rgba(255,255,255,0.05) 50%, rgba(0,0,0,0.1) 100%)",filter:n?"none":"brightness(1.1)",boxShadow:n?`inset 0 0 0 1px rgba(255,255,255,0.4), 0 0 30px -5px ${t}`:"inset 0 0 0 1px rgba(255,255,255,0.1)"},onMouseEnter:r,onMouseLeave:l,onClick:e=>{e.stopPropagation(),o()},children:(0,s.jsx)(x.P.div,{initial:{x:"-100%"},animate:n?{x:"200%"}:{x:"-100%"},transition:{duration:1.5,repeat:1/0,repeatDelay:1},className:"absolute top-0 left-0 w-1/2 h-full bg-gradient-to-r from-transparent via-white/20 to-transparent skew-x-12 pointer-events-none"})}),(0,s.jsx)("div",{className:"absolute top-0 origin-top-right transition-all duration-75 pointer-events-auto cursor-pointer",style:{right:0,width:h,height:"100%",backgroundColor:p,filter:n?"brightness(0.6)":"brightness(0.5)",left:"100%",transformOrigin:"left center",transform:"rotateY(90deg)"},onMouseEnter:r,onMouseLeave:l,onClick:e=>{e.stopPropagation(),o()}}),(0,s.jsx)("div",{className:"absolute left-0 origin-bottom-left transition-all duration-75 pointer-events-auto cursor-pointer",style:{bottom:0,width:"100%",height:h,backgroundColor:p,filter:n?"brightness(0.8)":"brightness(0.3)",top:"100%",transformOrigin:"top center",transform:"rotateX(-90deg)"},onMouseEnter:r,onMouseLeave:l,onClick:e=>{e.stopPropagation(),o()}})]})}var u=i(94961),f=i(94514),g=i(57420),b=i(61878),j=i(51806),v=i(78795),y=i(9505);function N({chartData:e,hasData:t,summaryStats:i}){let[a,r]=(0,n.useState)("scale"),[l,d]=(0,n.useState)(null);n.useRef(null);let[x,m]=(0,n.useState)([]);if(!t)return(0,s.jsx)("p",{className:"text-zinc-500 text-center py-4",children:"無坡道平面車位坪數資料"});let h="scale"===a?e.map(e=>({id:e.id,label:e.id,x:e.count,y:e.avgArea})):e.map(e=>({id:e.id,label:e.id,x:e.avgPrice,y:e.avgArea}));return(0,s.jsxs)("div",{className:"grid grid-cols-1 lg:grid-cols-3 gap-8 relative",children:[l&&(0,s.jsxs)("div",{className:"fixed z-50 px-3 py-2 bg-zinc-900 border border-white/10 rounded-lg shadow-xl text-xs text-zinc-300 pointer-events-none transform -translate-x-1/2 -translate-y-full animate-in fade-in zoom-in-95",style:{left:l.x,top:l.y},children:[l.text,(0,s.jsx)("div",{className:"absolute left-1/2 bottom-0 w-2 h-2 bg-zinc-900 border-r border-b border-white/10 text-zinc-900 transform rotate-45 -translate-x-1/2 -mb-1"})]}),(0,s.jsxs)("div",{className:"lg:col-span-1 space-y-6",children:[(0,s.jsxs)("div",{className:"space-y-4",children:[(0,s.jsx)("h4",{className:"text-sm font-medium text-zinc-400 pl-1 border-l-2 border-cyan-500",children:"總體統計數據"}),(0,s.jsx)("div",{className:"bg-zinc-900/30 rounded-xl border border-white/5 p-4",children:(0,s.jsx)("table",{className:"w-full text-sm",children:(0,s.jsxs)("tbody",{className:"divide-y divide-white/5",children:[(0,s.jsxs)("tr",{children:[(0,s.jsx)("td",{className:"py-3 text-zinc-500",children:"數據範圍"}),(0,s.jsxs)("td",{className:"py-3 text-right font-mono text-white",children:[(0,s.jsx)("span",{className:"text-cyan-400",children:e.length})," 建案",(0,s.jsx)("span",{className:"mx-1 text-zinc-600",children:"/"}),(0,s.jsx)("span",{className:"text-zinc-300",children:i.count.toLocaleString()})," 車位"]})]}),(0,s.jsxs)("tr",{children:[(0,s.jsx)("td",{className:"py-3 text-zinc-500",children:"平均坪數"}),(0,s.jsxs)("td",{className:"py-3 text-right font-mono text-cyan-400 text-lg font-bold",children:[i.avgArea.toFixed(2)," ",(0,s.jsx)("span",{className:"text-xs font-normal text-zinc-500",children:"坪"})]})]}),(0,s.jsxs)("tr",{children:[(0,s.jsx)("td",{className:"py-3 text-zinc-500",children:"坪數中位數"}),(0,s.jsxs)("td",{className:"py-3 text-right font-mono text-zinc-300 text-lg font-bold",children:[i.medianArea.toFixed(2)," ",(0,s.jsx)("span",{className:"text-xs font-normal text-zinc-500",children:"坪"})]})]})]})})})]}),(0,s.jsx)(y.l,{projects:e.map(e=>({value:e.id,label:e.id})),className:"w-full",onChange:e=>m(e),max:6})]}),(0,s.jsxs)("div",{className:"lg:col-span-2 space-y-4",children:[(0,s.jsxs)("div",{className:"flex flex-wrap justify-between items-center gap-2",children:[(0,s.jsxs)("div",{children:[(0,s.jsx)("h4",{className:"text-sm font-medium text-zinc-400 pl-1 border-l-2 border-violet-500",children:"分佈散佈圖"}),(0,s.jsx)("div",{className:"mt-1 text-xs text-zinc-500 font-mono",children:"scale"===a?(0,s.jsxs)("span",{children:[(0,s.jsx)("span",{className:"text-cyan-400",children:"X軸"}),": 建案車位總數 ",(0,s.jsx)("span",{className:"text-zinc-600",children:"|"})," ",(0,s.jsx)("span",{className:"text-cyan-400",children:"Y軸"}),": 平均車位坪數"]}):(0,s.jsxs)("span",{children:[(0,s.jsx)("span",{className:"text-cyan-400",children:"X軸"}),": 平均車位價格 ",(0,s.jsx)("span",{className:"text-zinc-600",children:"|"})," ",(0,s.jsx)("span",{className:"text-cyan-400",children:"Y軸"}),": 平均車位坪數"]})})]}),(0,s.jsxs)("div",{className:"flex gap-2 items-center",children:[(0,s.jsxs)("div",{className:"relative group",children:[(0,s.jsx)("button",{className:"p-1.5 text-zinc-500 hover:text-cyan-400 transition-colors",children:(0,s.jsx)(u.A,{size:14})}),(0,s.jsx)("div",{className:"absolute right-0 top-full mt-2 w-64 p-3 bg-zinc-900 border border-white/10 rounded-lg shadow-xl z-50 opacity-0 group-hover:opacity-100 transition-opacity pointer-events-none",children:(0,s.jsx)("div",{className:"text-xs text-zinc-300 leading-relaxed",children:"scale"===a?"分析各建案「規劃車位總數」與「平均車位坪數」的關係。可觀察大社區是否傾向規劃較大或較小的車位。":"分析各建案「平均車位價格」與「平均車位坪數」的關係。可觀察車位價格是否隨著坪數增加而顯著提升。"})})]}),(0,s.jsx)("div",{className:"w-px h-4 bg-white/10 mx-1"}),(0,s.jsx)("button",{onClick:()=>r("scale"),className:(0,c.cn)("px-3 py-1.5 text-xs font-medium rounded-md border transition-all duration-200","scale"===a?"bg-cyan-500/10 text-cyan-400 border-cyan-500/50 shadow-[0_0_10px_rgba(34,211,238,0.1)]":"bg-zinc-900/50 border-white/10 text-zinc-500 hover:text-zinc-300 hover:bg-white/5"),children:"規模分析"}),(0,s.jsx)("button",{onClick:()=>r("value"),className:(0,c.cn)("px-3 py-1.5 text-xs font-medium rounded-md border transition-all duration-200","value"===a?"bg-cyan-500/10 text-cyan-400 border-cyan-500/50 shadow-[0_0_10px_rgba(34,211,238,0.1)]":"bg-zinc-900/50 border-white/10 text-zinc-500 hover:text-zinc-300 hover:bg-white/5"),children:"價值分析"})]})]}),(0,s.jsx)(o,{data:h,xLabel:"scale"===a?"建案車位總數":"平均車位價格",yLabel:"平均車位坪數",xUnit:"scale"===a?"位":"萬",yUnit:"坪",title:"scale"===a?"建案規模 vs 車位坪數分佈":"車位價值 vs 坪數分佈",highlightIds:x})]})]})}function w({data:e}){let[t,i]=(0,n.useState)(["B1","B2","B3","B4"]),[r,o]=(0,n.useState)(null),d=n.useRef(null),x=n.useRef(null),m=n.useRef(null),p=n.useRef(null),[u,y]=(0,n.useState)(!1),[w,z]=(0,n.useState)(null),[k,S]=(0,n.useState)([]),[_,P]=(0,n.useState)(!1),[A,M]=(0,n.useState)(0),C=t=>{z(t),P(!1);let i=R?.find(e=>e.floor===t),s=i?.rawRecords;if(s&&s.length>0){let e=s.map(e=>({...e,_isMatch:!0}));e.sort((e,t)=>{let i=e["交易年月日"]||0;return(t["交易年月日"]||0)-i}),S(e),M(e.length)}else{let i=e?.transactionDetails||[],s=[t];"B1"===t&&s.push("地下一層","B1","b1"),"B2"===t&&s.push("地下二層","B2","b2"),"B3"===t&&s.push("地下三層","B3","b3"),"B4"===t&&s.push("地下四層","B4","b4"),"B5_below"===t&&s.push("地下五層","B5","b5");let n=i.filter(e=>(e["車位類別"]||"").includes("坡道平面")),a=n.filter(e=>{let t=e["車位所在樓層"]||"",i=e["備註"]||"";return s.some(e=>t&&t.includes(e)||i&&i.includes(e))});M(a.length);let r=n.map(e=>{let t=e["車位所在樓層"]||"",i=e["備註"]||"",n=s.some(e=>t&&t.includes(e)||i&&i.includes(e));return{...e,_isMatch:n}});r.sort((e,t)=>{if(e._isMatch&&!t._isMatch)return -1;if(!e._isMatch&&t._isMatch)return 1;let i=e["交易年月日"]||0;return(t["交易年月日"]||0)-i}),S(r),0===a.length&&P(!0)}y(!0)};if(!e?.parkingAnalysis)return null;let{parkingRatio:F,avgPriceByType:$,rampPlanePriceByFloor:R}=e.parkingAnalysis,T=["B1","B2","B3","B4","B5_below","Unknown"],E=R?.filter(e=>T.includes(e.floor)&&e.count>0)||[],D=(0,n.useMemo)(()=>(function(e,t){let i=[];if(e.forEach(e=>{t.includes(e.floor)&&e.rawRecords&&e.rawRecords.forEach(e=>{"number"!=typeof e.parkingPrice||isNaN(e.parkingPrice)||i.push(e.parkingPrice)})}),0===i.length)return{avgPrice:0,medianPrice:0,q3Price:0,count:0};i.sort((e,t)=>e-t);let s=i.reduce((e,t)=>e+t,0)/i.length,n=i[Math.floor(i.length/2)],a=Math.floor(.75*i.length),r=i[a]||n;return{avgPrice:s,medianPrice:n,q3Price:r,count:i.length}})(E,t),[E,t]),I=(0,n.useCallback)(e=>{i(t=>t.includes(e)?t.filter(t=>t!==e):[...t,e])},[]),L=(0,n.useCallback)(()=>{t.length===T.length?i([]):i([...T])},[t.length]),O={B1:"#06b6d4",B2:"#3b82f6",B3:"#6366f1",B4:"#8b5cf6",B5_below:"#a855f7",Unknown:"#71717a"},{parkingChartData:B,parkingChartStats:Z,hasParkingData:W}=(0,n.useMemo)(()=>{let e=new Map,t=!1;E.forEach(i=>{i.rawRecords&&i.rawRecords.forEach(i=>{let s=i["建案名稱"],n=i.parkingArea||i["車位面積(坪)"]||.3025*(i["車位移轉總面積平方公尺"]||0),a=i.parkingPrice||i["車位價格(萬)"]||0;if(s&&n>0){e.has(s)||e.set(s,{count:0,totalArea:0,totalPrice:0});let i=e.get(s);i.count+=1,i.totalArea+=n,i.totalPrice+=a,t=!0}})});let i=Array.from(e.entries()).map(([e,t])=>({id:e,label:e,avgArea:parseFloat((t.totalArea/t.count).toFixed(2)),count:t.count,avgPrice:parseFloat((t.totalPrice/t.count).toFixed(2))})),s=0,n=[];i.forEach(e=>{s+=e.count,n.push(e.avgArea)}),n.sort((e,t)=>e-t);let a=n.length>0?n.reduce((e,t)=>e+t,0)/n.length:0,r=n.length>0?n[Math.floor(n.length/2)]:0;return{parkingChartData:i,parkingChartStats:{count:s,avgArea:a,medianArea:r},hasParkingData:t}},[E]);return(0,s.jsxs)("div",{className:"space-y-6 animate-in fade-in slide-in-from-bottom-4 duration-500 text-white",children:[(0,s.jsxs)("div",{className:"grid grid-cols-1 lg:grid-cols-2 gap-6",children:[(0,s.jsx)(a.c,{title:"房車配比分析",description:"建案有購置車位的比例",containerRef:d,headerAction:(0,s.jsx)(v.N,{data:[{type:"有車位",...F?.withParking},{type:"無車位",...F?.withoutParking},{ratio:F?.avgRatio}],filename:"parking_ratio_data",label:"匯出",columns:{type:"類別",count:"數量",percentage:"百分比",ratio:"比率"},chartType:"parking-pie",targetRef:d,snapshotData:[{type:"有車位",...F?.withParking},{type:"無車位",...F?.withoutParking},{ratio:F?.avgRatio}]}),children:(0,s.jsxs)("div",{className:"flex flex-col md:flex-row items-start gap-6",children:[(0,s.jsx)("div",{className:"w-full md:w-1/2",children:(0,s.jsx)(l,{data:F})}),(0,s.jsx)("div",{className:"w-full md:w-1/2 flex flex-col gap-4",children:(0,s.jsxs)("table",{className:"w-full text-sm",children:[(0,s.jsx)("thead",{className:"bg-zinc-900/50 text-zinc-500",children:(0,s.jsxs)("tr",{children:[(0,s.jsx)("th",{className:"p-2 text-left",children:"類型"}),(0,s.jsx)("th",{className:"p-2 text-right",children:"筆數"}),(0,s.jsx)("th",{className:"p-2 text-right",children:"佔比"})]})}),(0,s.jsxs)("tbody",{className:"divide-y divide-white/5",children:[(0,s.jsxs)("tr",{children:[(0,s.jsxs)("td",{className:"p-2 flex items-center gap-2",children:[(0,s.jsx)("span",{className:"w-3 h-3 rounded-full bg-indigo-300"}),"有搭車位"]}),(0,s.jsx)("td",{className:"p-2 text-right font-mono text-zinc-300",children:F?.withParking?.count.toLocaleString()}),(0,s.jsxs)("td",{className:"p-2 text-right font-mono text-cyan-400",children:[F?.withParking?.percentage.toFixed(2),"%"]})]}),(0,s.jsxs)("tr",{children:[(0,s.jsxs)("td",{className:"p-2 flex items-center gap-2",children:[(0,s.jsx)("span",{className:"w-3 h-3 rounded-full bg-gray-600"}),"無車位"]}),(0,s.jsx)("td",{className:"p-2 text-right font-mono text-zinc-300",children:F?.withoutParking?.count.toLocaleString()}),(0,s.jsxs)("td",{className:"p-2 text-right font-mono text-zinc-500",children:[F?.withoutParking?.percentage.toFixed(2),"%"]})]})]})]})})]})}),(0,s.jsx)(a.c,{title:"車位類型均價",description:"各類車位成交行情",containerRef:x,headerAction:(0,s.jsx)(v.N,{data:$||[],filename:"parking_price_by_type",label:"匯出",columns:{type:"車位類型",avgPrice:"平均價格",medianPrice:"中位數",count:"數量"},chartType:"parking-price",targetRef:x,snapshotData:$||[]}),children:(0,s.jsxs)("table",{className:"w-full text-sm",children:[(0,s.jsx)("thead",{className:"bg-zinc-900/50 text-zinc-500",children:(0,s.jsxs)("tr",{children:[(0,s.jsx)("th",{className:"p-2 text-left",children:"類型"}),(0,s.jsx)("th",{className:"p-2 text-right",children:"均價(萬)"}),(0,s.jsx)("th",{className:"p-2 text-right",children:"中位數"}),(0,s.jsx)("th",{className:"p-2 text-right",children:"總數"})]})}),(0,s.jsx)("tbody",{className:"divide-y divide-white/5",children:$?.map(e=>(0,s.jsxs)("tr",{className:"hover:bg-zinc-800/50",children:[(0,s.jsx)("td",{className:"p-2 font-medium",children:e.type}),(0,s.jsx)("td",{className:"p-2 text-right font-mono text-cyan-400",children:Math.round(e.avgPrice).toLocaleString()}),(0,s.jsx)("td",{className:"p-2 text-right font-mono text-zinc-300",children:Math.round(e.medianPrice).toLocaleString()}),(0,s.jsx)("td",{className:"p-2 text-right font-mono text-zinc-500",children:e.count.toLocaleString()})]},e.type))})]})})]}),(0,s.jsx)(a.c,{title:"坡道平面車位坪數散佈分析",description:"建案車位數與坪數分佈",className:"relative z-20",containerRef:m,headerAction:(0,s.jsx)(v.N,{data:B||[],filename:"parking_area_scatter_data",label:"匯出",columns:{id:"建案名稱",label:"標籤",avgArea:"平均坪數",count:"車位數",avgPrice:"平均價格"},chartType:"parking-scatter",targetRef:m,snapshotData:B||[]}),children:(0,s.jsx)(N,{chartData:B,hasData:W,summaryStats:Z})}),(0,s.jsx)(a.c,{title:"坡道平面車位 - 樓層價差分析",description:"勾選樓層以動態更新統計數據",containerRef:p,headerAction:(0,s.jsx)(v.N,{data:E||[],filename:"parking_floor_analysis",label:"匯出",columns:{floor:"樓層",count:"數量",avgPrice:"平均價格",medianPrice:"中位數",maxPrice:"最高價",minPrice:"最低價",q3Price:"第三四分位數"},chartType:"parking-floor",targetRef:p,snapshotData:E||[]}),children:(0,s.jsxs)("div",{className:"grid grid-cols-1 lg:grid-cols-2 gap-8",children:[(0,s.jsxs)("div",{className:"flex flex-col items-center justify-center p-8 bg-zinc-900/10 rounded-xl relative overflow-visible min-h-[450px]",children:[(0,s.jsx)("div",{className:"absolute inset-0 bg-gradient-to-b from-zinc-900/0 via-zinc-900/20 to-zinc-900/0 pointer-events-none"}),(0,s.jsx)(h,{data:E,selectedFloors:t,hoveredFloor:r,onHover:o,onToggle:I,onDetail:C,floorColors:O}),(0,s.jsx)("div",{className:"absolute bottom-4 left-0 w-full text-center text-zinc-600 text-xs pointer-events-none",children:"點擊方塊選取 • 懸停查看詳情"})]}),(0,s.jsxs)(j.a,{isOpen:u,onClose:()=>y(!1),title:`${w} 車位交易明細`,maxWidth:"max-w-5xl",children:[(0,s.jsx)("div",{className:"space-y-4",children:(0,s.jsxs)("div",{className:"flex items-center gap-2 bg-zinc-800/50 p-1 rounded-lg border border-white/10",children:[(0,s.jsxs)("button",{onClick:()=>P(!1),className:(0,c.cn)("px-3 py-1.5 rounded text-xs transition-colors font-medium flex items-center gap-1.5",_?"text-zinc-500 hover:text-zinc-300 hover:bg-white/5":"bg-cyan-500/20 text-cyan-400 border border-cyan-500/30 shadow-[0_0_10px_rgba(34,211,238,0.1)]"),children:[(0,s.jsx)(f.A,{size:12}),"精確匹配 (",A,")"]}),(0,s.jsxs)("button",{onClick:()=>P(!0),className:(0,c.cn)("px-3 py-1.5 rounded text-xs transition-colors font-medium",_?"bg-rose-500/20 text-rose-400 border border-rose-500/30 shadow-[0_0_10px_rgba(244,63,94,0.1)]":"text-zinc-500 hover:text-zinc-300 hover:bg-white/5"),children:["未匹配 (",k.length-A,")"]}),(0,s.jsx)("div",{className:"ml-auto",children:(0,s.jsx)(v.N,{data:k.filter(e=>_?!e._isMatch:e._isMatch),filename:`parking_details_${w}_${_?"all":"match"}`,label:"匯出明細"})})]})}),(0,s.jsx)("div",{className:"overflow-x-auto rounded-lg border border-white/10 max-h-[60vh] custom-scrollbar",children:(0,s.jsxs)("table",{className:"w-full text-sm text-left",children:[(0,s.jsx)("thead",{className:"bg-zinc-900/80 text-zinc-400 whitespace-nowrap sticky top-0 z-10 backdrop-blur-md",children:(0,s.jsxs)("tr",{children:[(0,s.jsx)("th",{className:"p-3",children:"建案名稱"}),(0,s.jsx)("th",{className:"p-3",children:"交易日期"}),(0,s.jsx)("th",{className:"p-3 text-right",children:"車位總價"}),(0,s.jsx)("th",{className:"p-3 text-right",children:"車位面積"}),(0,s.jsx)("th",{className:"p-3",children:"車位樓層"}),(0,s.jsx)("th",{className:"p-3",children:"備註"})]})}),(0,s.jsx)("tbody",{className:"divide-y divide-white/5",children:k.length>0?k.filter(e=>_?!e._isMatch:e._isMatch).map((e,t)=>(0,s.jsxs)("tr",{className:(0,c.cn)("hover:bg-zinc-800/50 transition-colors",e._isMatch?"bg-cyan-500/5":"opacity-60"),children:[(0,s.jsxs)("td",{className:"p-3 font-medium text-white",children:[(0,s.jsx)("div",{children:e["建案名稱"]}),(0,s.jsxs)("div",{className:"text-[10px] text-zinc-600 font-mono mt-0.5",children:["#",e.transactionId||e["編號"]]})]}),(0,s.jsxs)("td",{className:"p-3 text-zinc-400 flex items-center gap-1",children:[(0,s.jsx)(g.A,{size:12,className:"text-zinc-600"}),e["交易日"]]}),(0,s.jsxs)("td",{className:"p-3 text-right font-mono text-cyan-400",children:[e["車位總價元"]?(e["車位總價元"]/1e4).toLocaleString():"-"," 萬"]}),(0,s.jsxs)("td",{className:"p-3 text-right font-mono text-zinc-300",children:[e["車位移轉總面積平方公尺"]?(.3025*e["車位移轉總面積平方公尺"]).toFixed(2):"-"," 坪"]}),(0,s.jsx)("td",{className:"p-3 text-zinc-300",children:e["車位所在樓層"]||"-"}),(0,s.jsx)("td",{className:"p-3 text-zinc-500 text-xs max-w-[200px] truncate",title:e["備註"],children:e["備註"]})]},t)):(0,s.jsx)("tr",{children:(0,s.jsx)("td",{colSpan:6,className:"p-8 text-center text-zinc-500",children:"查無相關交易資料。"})})})]})})]}),(0,s.jsxs)("div",{className:"space-y-4",children:[(0,s.jsxs)("div",{className:"p-4 bg-gradient-to-r from-cyan-500/10 to-violet-500/10 border border-cyan-500/30 rounded-lg",children:[(0,s.jsx)("h4",{className:"text-sm font-medium text-cyan-400 mb-3",children:"已選樓層統計"}),(0,s.jsxs)("div",{className:"grid grid-cols-2 md:grid-cols-4 gap-4",children:[(0,s.jsxs)("div",{children:[(0,s.jsx)("div",{className:"text-xs text-zinc-500",children:"車位數"}),(0,s.jsx)("div",{className:"text-lg font-bold text-white",children:D.count.toLocaleString()})]}),(0,s.jsxs)("div",{children:[(0,s.jsx)("div",{className:"text-xs text-zinc-500",children:"平均單價"}),(0,s.jsxs)("div",{className:"text-lg font-bold text-cyan-400",children:[Math.round(D.avgPrice).toLocaleString()," 萬"]})]}),(0,s.jsxs)("div",{children:[(0,s.jsx)("div",{className:"text-xs text-zinc-500",children:"中位數"}),(0,s.jsxs)("div",{className:"text-lg font-bold text-zinc-300",children:[Math.round(D.medianPrice).toLocaleString()," 萬"]})]}),(0,s.jsxs)("div",{children:[(0,s.jsx)("div",{className:"text-xs text-zinc-500",children:"3/4位數"}),(0,s.jsxs)("div",{className:"text-lg font-bold text-zinc-300",children:[Math.round(D.q3Price).toLocaleString()," 萬"]})]})]})]}),(0,s.jsx)("div",{className:"overflow-x-auto",children:(0,s.jsxs)("table",{className:"w-full text-sm",children:[(0,s.jsx)("thead",{className:"bg-zinc-900/50 text-zinc-500",children:(0,s.jsxs)("tr",{children:[(0,s.jsx)("th",{className:"p-2 text-left",children:(0,s.jsxs)("label",{className:"flex items-center gap-2 cursor-pointer",children:[(0,s.jsx)("input",{type:"checkbox",checked:t.length===T.length,onChange:L,className:"form-checkbox rounded bg-zinc-800 border-zinc-600 text-cyan-500"}),(0,s.jsx)("span",{children:"全選"})]})}),(0,s.jsx)("th",{className:"p-2 text-left",children:"樓層"}),(0,s.jsx)("th",{className:"p-2 text-right",children:"均價(萬)"}),(0,s.jsx)("th",{className:"p-2 text-right",children:"中位數"}),(0,s.jsx)("th",{className:"p-2 text-right",children:"最高"}),(0,s.jsx)("th",{className:"p-2 text-right",children:"最低"}),(0,s.jsx)("th",{className:"p-2 text-right",children:"車位數"}),(0,s.jsx)("th",{className:"p-2 text-center",children:"操作"})]})}),(0,s.jsx)("tbody",{className:"divide-y divide-white/5",children:E.map(e=>{let i=t.includes(e.floor),n=r===e.floor;return(0,s.jsxs)("tr",{onMouseEnter:()=>o(e.floor),onMouseLeave:()=>o(null),className:(0,c.cn)("transition-colors cursor-pointer",n?"bg-zinc-800":"hover:bg-zinc-800/50",!i&&"opacity-50"),onClick:()=>I(e.floor),children:[(0,s.jsx)("td",{className:"p-2",children:(0,s.jsx)("input",{type:"checkbox",checked:i,onChange:()=>I(e.floor),className:"form-checkbox rounded bg-zinc-800 border-zinc-600 text-cyan-500",onClick:e=>e.stopPropagation()})}),(0,s.jsx)("td",{className:"p-2 font-medium",children:(0,s.jsxs)("div",{className:"flex items-center gap-2",children:[(0,s.jsx)("span",{className:"w-3 h-3 rounded-full",style:{backgroundColor:O[e.floor]}}),e.floor]})}),(0,s.jsx)("td",{className:"p-2 text-right font-mono text-cyan-400",children:Math.round(e.avgPrice).toLocaleString()}),(0,s.jsx)("td",{className:"p-2 text-right font-mono text-zinc-300",children:Math.round(e.medianPrice).toLocaleString()}),(0,s.jsx)("td",{className:"p-2 text-right font-mono text-zinc-500",children:Math.round(e.maxPrice).toLocaleString()}),(0,s.jsx)("td",{className:"p-2 text-right font-mono text-zinc-500",children:Math.round(e.minPrice).toLocaleString()}),(0,s.jsx)("td",{className:"p-2 text-right font-mono text-zinc-500",children:e.count.toLocaleString()}),(0,s.jsx)("td",{className:"p-2 text-center",children:(0,s.jsx)("button",{onClick:t=>{t.stopPropagation(),C(e.floor)},className:"p-1.5 rounded-full hover:bg-cyan-500/20 text-zinc-400 hover:text-cyan-400 transition-colors",title:"查看明細",children:(0,s.jsx)(b.A,{size:14})})})]},e.floor)})})]})})]})]})})]})}},48551:(e,t,i)=>{i.d(t,{K:()=>o});var s=i(95155),n=i(12115),a=i(88743),r=i(80642),l=i(39430),c=i(40980);function o(){let{selectedRoomTypes:e,setSelectedRoomTypes:t}=(0,a.P)(),[i,o]=(0,n.useState)(!1),[d,x]=(0,n.useState)(!1);return(0,n.useEffect)(()=>{let e=()=>{let e=document.getElementById("room-type-filter-anchor");e&&o(e.getBoundingClientRect().bottom<80)};return window.addEventListener("scroll",e),e(),()=>window.removeEventListener("scroll",e)},[]),(0,n.useEffect)(()=>{let e=document.querySelector("aside");if(!e)return;let t=()=>x(!0),i=()=>x(!1);return e.addEventListener("mouseenter",t),e.addEventListener("mouseleave",i),()=>{e.removeEventListener("mouseenter",t),e.removeEventListener("mouseleave",i)}},[]),(0,s.jsx)(r.N,{children:i&&!d&&(0,s.jsxs)(l.P.div,{initial:{opacity:0,y:20},animate:{opacity:1,y:0},exit:{opacity:0,y:20},transition:{duration:.3},className:(0,c.cn)("fixed z-[90] flex gap-1.5 p-1.5 bg-zinc-900/95 backdrop-blur-md border border-white/10 rounded-xl shadow-xl","flex-row bottom-8 left-1/2 -translate-x-1/2 items-center max-w-[90vw]","md:flex-col md:left-20 md:top-1/2 md:-translate-y-1/2 md:bottom-auto md:translate-x-0 md:items-stretch md:max-w-none"),children:[(0,s.jsx)("div",{className:(0,c.cn)("text-[9px] text-zinc-500 font-medium overflow-hidden","md:writing-mode-vertical md:text-center md:mb-0.5","whitespace-nowrap px-1"),children:"房型"}),(0,s.jsx)("div",{className:"flex md:flex-col gap-1.5 overflow-x-auto md:overflow-visible max-w-full md:max-w-none pb-2 md:pb-0 scrollbar-thumb-zinc-600 pr-8 md:pr-0",children:a.M.map(i=>(0,s.jsx)("button",{onClick:()=>{t(e.includes(i)?e.filter(e=>e!==i):[...e,i])},className:(0,c.cn)("px-2 py-1 text-[10px] font-medium rounded-lg transition-all hover:scale-105 active:scale-95 whitespace-nowrap",e.includes(i)?"bg-violet-500 text-white shadow-lg shadow-violet-500/20":"bg-zinc-800/50 text-zinc-400 hover:bg-zinc-700 hover:text-white"),children:i},i))}),e.length>0&&e.length<a.M.length&&(0,s.jsx)("button",{onClick:()=>t([]),className:(0,c.cn)("text-[9px] text-cyan-400 hover:text-cyan-300 transition-colors whitespace-nowrap px-1","md:mt-1 md:border-t md:border-white/5 md:pt-1 md:text-center md:px-0","border-l border-white/5 pl-1 md:border-l-0 md:pl-0"),children:"清除"})]})})}},53812:(e,t,i)=>{i.d(t,{Q:()=>g});var s=i(95155),n=i(12115),a=i(34361),r=i(3083),l=i(4439),c=i(40980);function o({data:e,viewType:t,selectedRooms:i}){if(!e||0===Object.keys(e).length)return(0,s.jsx)("div",{className:"text-zinc-500 text-center p-8",children:"無銷售速度資料"});let a=Object.keys(e).sort().reverse();return(0,s.jsx)("div",{className:"overflow-x-auto max-h-[600px] border border-white/5 rounded-lg",children:(0,s.jsxs)("table",{className:"w-full text-sm text-left border-collapse",children:[(0,s.jsxs)("thead",{className:"bg-zinc-900 sticky top-0 z-20 shadow-md",children:[(0,s.jsxs)("tr",{children:[(0,s.jsx)("th",{rowSpan:2,className:"px-4 py-3 sticky left-0 z-30 bg-zinc-900 border-r border-white/10 font-medium text-white min-w-[120px]",children:"時間"}),i.map(e=>(0,s.jsx)("th",{colSpan:3,className:"px-2 py-2 text-center border-l border-white/5 text-zinc-300 font-medium bg-zinc-900/90",children:e},e)),(0,s.jsx)("th",{colSpan:3,className:"px-2 py-2 text-center border-l-2 border-white/10 text-cyan-400 font-bold bg-zinc-900/90",children:"總計"})]}),(0,s.jsxs)("tr",{children:[i.map((e,t)=>(0,s.jsxs)(n.Fragment,{children:[(0,s.jsx)("th",{className:(0,c.cn)("px-2 py-2 text-center text-xs text-zinc-500 font-normal bg-zinc-900/90 border-b border-white/10",0===t&&"border-l border-white/5"),children:"筆數"}),(0,s.jsx)("th",{className:"px-2 py-2 text-center text-xs text-zinc-500 font-normal bg-zinc-900/90 border-b border-white/10",children:"總價(萬)"}),(0,s.jsx)("th",{className:"px-2 py-2 text-center text-xs text-zinc-500 font-normal bg-zinc-900/90 border-b border-white/10",children:"坪數"})]},e)),(0,s.jsx)("th",{className:"px-2 py-2 text-center text-xs text-zinc-400 font-medium bg-zinc-900/90 border-b border-white/10 border-l-2 border-white/10",children:"筆數"}),(0,s.jsx)("th",{className:"px-2 py-2 text-center text-xs text-zinc-400 font-medium bg-zinc-900/90 border-b border-white/10",children:"總價(萬)"}),(0,s.jsx)("th",{className:"px-2 py-2 text-center text-xs text-zinc-400 font-medium bg-zinc-900/90 border-b border-white/10",children:"坪數"})]})]}),(0,s.jsx)("tbody",{className:"divide-y divide-white/5",children:a.map(a=>{let r=e[a]||{},l={count:0,priceSum:0,areaSum:0};return(0,s.jsxs)("tr",{className:"hover:bg-zinc-800/30 transition-colors",children:[(0,s.jsx)("td",{className:"px-4 py-2 sticky left-0 z-10 bg-zinc-950/90 border-r border-white/10 font-mono text-zinc-400",children:("weekly"===t&&a.includes("-W"),a)}),i.map((e,t)=>{let i=r[e];return i?(l.count+=i.count,l.priceSum+=i.priceSum,l.areaSum+=i.areaSum,(0,s.jsxs)(n.Fragment,{children:[(0,s.jsx)("td",{className:(0,c.cn)("px-2 py-2 text-center text-zinc-300",0===t&&"border-l border-white/5"),children:i.count>0?i.count.toLocaleString():"-"}),(0,s.jsx)("td",{className:"px-2 py-2 text-center text-zinc-500 font-mono text-xs",children:i.count>0?(0,c.Z)(i.priceSum,0):"-"}),(0,s.jsx)("td",{className:"px-2 py-2 text-center text-zinc-500 font-mono text-xs",children:i.count>0?(0,c.Z)(i.areaSum,1):"-"})]},e)):(0,s.jsxs)(n.Fragment,{children:[(0,s.jsx)("td",{className:(0,c.cn)("px-2 py-2 text-center text-zinc-700",0===t&&"border-l border-white/5"),children:"-"}),(0,s.jsx)("td",{className:"px-2 py-2 text-center text-zinc-700",children:"-"}),(0,s.jsx)("td",{className:"px-2 py-2 text-center text-zinc-700",children:"-"})]},e)}),(0,s.jsx)("td",{className:"px-2 py-2 text-center font-bold text-cyan-400 border-l-2 border-white/10",children:l.count.toLocaleString()}),(0,s.jsx)("td",{className:"px-2 py-2 text-center font-bold text-zinc-300 font-mono text-xs",children:(0,c.Z)(l.priceSum,0)}),(0,s.jsx)("td",{className:"px-2 py-2 text-center font-bold text-zinc-300 font-mono text-xs",children:(0,c.Z)(l.areaSum,1)})]},a)})})]})})}var d=i(29991),x=i(60529),m=i(78795),h=i(88743),p=i(48551),u=i(39430),f=i(80642);function g({data:e}){let[t,i]=(0,n.useState)("monthly"),[g,b]=(0,n.useState)("count"),[j,v]=(0,n.useState)(15),[y,N]=(0,n.useState)(65),[w,z]=(0,n.useState)(5),[k,S]=(0,n.useState)([]),[_,P]=(0,n.useState)(null),{selectedRoomTypes:A,setSelectedRoomTypes:M}=(0,h.P)();if(!e)return null;let{salesVelocityAnalysis:C,areaDistributionAnalysis:F}=e,$=e=>Math.round(e)+"萬",R=n.useRef(null),T=n.useRef(null),E=n.useRef(null),D=n.useRef(null);return(0,s.jsxs)("div",{className:"space-y-6 animate-in fade-in slide-in-from-bottom-4 duration-500",children:[(0,s.jsxs)("div",{id:"room-type-filter-anchor",className:"p-4 bg-zinc-900/30 border border-white/5 rounded-lg flex flex-wrap gap-2 items-center scroll-mt-24",children:[(0,s.jsx)("span",{className:"text-zinc-400 text-sm mr-2",children:"分析房型:"}),h.M.map(e=>(0,s.jsx)("button",{onClick:()=>{M(A.includes(e)?A.filter(t=>t!==e):[...A,e])},className:(0,c.cn)("px-3 py-1 text-xs rounded-full border transition-colors",A.includes(e)?"bg-violet-500/20 border-violet-500 text-violet-200":"bg-zinc-800 border-zinc-700 text-zinc-500 hover:bg-zinc-700"),children:e},e))]}),(0,s.jsx)(a.c,{title:"房型銷售速度與趨勢分析",containerRef:T,headerAction:(0,s.jsxs)("div",{className:"flex gap-2",children:[(0,s.jsxs)(d.l,{value:t,onChange:e=>i(e.target.value),className:"w-[100px] h-8 text-xs bg-zinc-950/50",children:[(0,s.jsx)("option",{value:"weekly",children:"每週"}),(0,s.jsx)("option",{value:"monthly",children:"每月"}),(0,s.jsx)("option",{value:"quarterly",children:"每季"})]}),(0,s.jsxs)(d.l,{value:g,onChange:e=>b(e.target.value),className:"w-[100px] h-8 text-xs bg-zinc-950/50",children:[(0,s.jsx)("option",{value:"count",children:"交易筆數"}),(0,s.jsx)("option",{value:"priceSum",children:"總銷金額"}),(0,s.jsx)("option",{value:"areaSum",children:"總銷坪數"})]}),(0,s.jsx)(m.N,{data:C?.[t]||[],filename:`sales_velocity_${t}`,label:"匯出",chartType:"sales-velocity-chart",targetRef:T,snapshotData:C?.[t]||[],columns:{period:"時間區間",count:"交易筆數",priceSum:"總銷金額",areaSum:"總銷坪數"}})]}),children:(0,s.jsx)(r.M,{data:C?.[t]||{},selectedRooms:A,metric:g})}),(0,s.jsx)(a.c,{title:"銷售速度明細表",description:"各時間段詳細銷售數據統計",containerRef:E,headerAction:(0,s.jsx)(m.N,{data:C?.[t],filename:`sales_velocity_table_${t}`,label:"匯出",chartType:"sales-velocity-table",targetRef:E,snapshotData:C?.[t]||[],columns:{period:"時間區間",count:"交易筆數",priceSum:"總銷金額",areaSum:"總銷坪數"}}),children:(0,s.jsx)(o,{data:C?.[t]||[],viewType:t,selectedRooms:A})}),(0,s.jsx)(a.c,{title:"房型面積分佈熱力圖",description:"分析不同坪數區間的產品供給與去化分佈",containerRef:D,headerAction:(0,s.jsxs)("div",{className:"flex gap-2 items-center text-zinc-400 text-xs",children:[(0,s.jsx)("span",{children:"範圍:"}),(0,s.jsx)(x.p,{type:"number",value:j,onChange:e=>v(Number(e.target.value)),className:"w-16 h-8 text-xs bg-zinc-950/50"}),(0,s.jsx)("span",{children:"-"}),(0,s.jsx)(x.p,{type:"number",value:y,onChange:e=>N(Number(e.target.value)),className:"w-16 h-8 text-xs bg-zinc-950/50"}),(0,s.jsx)("span",{className:"ml-2",children:"級距:"}),(0,s.jsx)(x.p,{type:"number",value:w,onChange:e=>z(Number(e.target.value)),step:"0.5",className:"w-16 h-8 text-xs bg-zinc-950/50"}),(0,s.jsx)("div",{className:"border-l border-white/10 h-4 mx-1"}),(0,s.jsx)(m.N,{data:F?Object.entries(F).map(([e,t])=>({key:e,value:JSON.stringify(t)})):[],filename:"area_distribution_heatmap",label:"匯出",chartType:"sales-heatmap",targetRef:D,snapshotData:{distribution:F,selectedRooms:A,min:j,max:y,interval:w},columns:{key:"坪數區間",value:"分佈數據"}})]}),children:(0,s.jsxs)("div",{className:(0,c.cn)("flex flex-col lg:flex-row gap-6 relative overflow-hidden items-stretch transition-all duration-300",_?"lg:h-[600px]":"min-h-[500px]"),children:[(0,s.jsx)(u.P.div,{layout:!0,initial:!1,animate:{flex:_?"0 0 60%":"0 0 100%"},transition:{type:"spring",stiffness:300,damping:35,mass:1},onAnimationStart:()=>{},onAnimationComplete:()=>{R.current&&(R.current.style.width="100%",window.dispatchEvent(new Event("resize")))},className:"min-w-0 overflow-hidden h-full flex flex-col",children:(0,s.jsx)("div",{ref:R,className:"w-full h-full flex flex-col",children:(0,s.jsx)(l.m,{data:F||{},selectedRooms:A,minArea:j,maxArea:y,interval:w,onDataPointClick:(t,i)=>{R.current&&(R.current.style.width=`${R.current.offsetWidth}px`);let s=0,n=1/0;if(i.includes("<"))n=parseFloat(i.replace("<","").trim());else if(i.includes(">"))s=parseFloat(i.replace(">","").trim());else if(i.includes("-")){let e=i.split("-");s=parseFloat(e[0].trim()),n=parseFloat(e[1].trim())}let a=(e.transactionDetails||[]).filter(e=>{let i=function(e){let t=e=>e?String(e).normalize("NFKC").toUpperCase().replace(/\s+/g,""):"",i=t(e["建物型態"]||e.buildingType),s=t(e["主要用途"]||e.mainPurpose),n=t(e["戶別"]||e.unit),a=void 0!==e["房數"]?e["房數"]:e.rooms,r=void 0!==e["房屋面積(坪)"]?parseFloat(e["房屋面積(坪)"]):parseFloat(e.houseArea||0);if(i.includes("住宅大樓")&&n.includes("S")||n.includes("店舖")||n.includes("店面")||n.includes("店鋪"))return"店舖";if(n.includes("事務所")||n.includes("辦公"))return"辦公/事務所";if(i.includes("店舖")||i.includes("店面")||i.includes("店鋪"))return"店舖";if(i.includes("工廠")||i.includes("倉庫")||i.includes("廠辦"))return"廠辦/工廠";if(s.includes("商業")||i.includes("辦公")||i.includes("事務所"))return"辦公/事務所";if((i.includes("住宅大樓")||i.includes("華廈"))&&0===a){if(r>35)return"毛胚";if(r<=35)return"套房"}if("number"==typeof a&&!isNaN(a)){if(1===a)return"1房";if(2===a)return"2房";if(3===a)return"3房";if(4===a)return"4房";if(a>=5)return"5房以上"}return"其他"}(e),a=parseFloat(e["房屋面積(坪)"]||e.houseArea||(e["建物移轉平方公尺"]?.3025*e["建物移移轉平方公尺"]:0));if(!i)return!1;let r=a>=s&&a<n;return i===t&&r});console.log(`[Heatmap Click] Room: ${t}, Range: ${s}-${n}, Found: ${a.length}`);let r={};a.forEach(e=>{let t=e["建案名稱"]||e.projectName||"未知建案";r[t]||(r[t]=[]),r[t].push(e)});let l=Object.entries(r).map(([e,t])=>{let i=t.map(e=>e["產權總價"]||e["交易總價(萬)"]||e.totalPrice||0).filter(e=>e>0).sort((e,t)=>e-t),s=t.map(e=>e["房屋單價"]||e["房屋單價(萬)"]||e.unitPrice||0).filter(e=>e>0),n=0;if(i.length>0){let e=Math.floor(i.length/2);n=i.length%2!=0?i[e]:(i[e-1]+i[e])/2}return{projectName:e,count:t.length,priceRange:{min:i.length>0?i[0]:0,max:i.length>0?i[i.length-1]:0,median:n},unitPriceRange:{min:s.length>0?Math.min(...s):0,max:s.length>0?Math.max(...s):0},transactions:t.sort((e,t)=>{let i=e["房屋單價"]||e["房屋單價(萬)"]||e.unitPrice||0;return(t["房屋單價"]||t["房屋單價(萬)"]||t.unitPrice||0)-i}),isExpanded:!1}});l.sort((e,t)=>t.unitPriceRange.max-e.unitPriceRange.max),S(l),P({roomType:t,areaRange:i,totalCount:a.length})},height:_?"100%":void 0})})}),(0,s.jsx)(f.N,{mode:"wait",children:_&&(0,s.jsxs)(u.P.div,{initial:{opacity:0,x:50,width:0},animate:{opacity:1,x:0,width:"40%"},exit:{opacity:0,x:50,width:0},transition:{type:"spring",stiffness:300,damping:35},className:"flex-1 min-w-0 bg-zinc-900/50 border border-white/10 rounded-lg h-full flex flex-col p-4 overflow-hidden",children:[(0,s.jsxs)("div",{className:"flex justify-between items-start mb-4 pb-4 border-b border-white/5",children:[(0,s.jsxs)("div",{children:[(0,s.jsxs)("h4",{className:"text-white font-medium flex items-center gap-2 text-lg",children:[(0,s.jsx)("span",{className:"text-cyan-400",children:_.roomType}),(0,s.jsx)("span",{className:"text-zinc-500",children:"|"}),(0,s.jsxs)("span",{children:[_.areaRange," 坪"]})]}),(0,s.jsxs)("p",{className:"text-zinc-400 text-xs mt-1",children:["共找到 ",(0,s.jsx)("span",{className:"text-white font-mono",children:k.length})," 個建案",(0,s.jsx)("br",{}),"合計 ",(0,s.jsx)("span",{className:"text-white font-mono",children:_.totalCount})," 筆交易"]})]}),(0,s.jsxs)("div",{className:"flex gap-2 items-center",children:[(0,s.jsxs)("div",{className:"flex gap-1 mr-2",children:[(0,s.jsx)(m.N,{data:k,filename:`heatmap_aggregated_${_.roomType}_${_.areaRange}`,label:"統計",chartType:"sales-heatmap-detail",snapshotData:k,className:"whitespace-nowrap px-3 py-1 text-xs h-7 min-w-0"}),(0,s.jsx)(m.N,{data:k.flatMap(e=>e.transactions),filename:`heatmap_details_${_.roomType}_${_.areaRange}`,label:"明細",className:"whitespace-nowrap px-3 py-1 text-xs h-7 min-w-0"})]}),(0,s.jsx)("div",{className:"w-px h-4 bg-white/10 mx-1"}),(0,s.jsx)("button",{onClick:()=>{R.current&&(R.current.style.width=`${R.current.offsetWidth}px`),P(null)},className:"text-zinc-400 hover:text-white p-1 hover:bg-zinc-800 rounded transition-colors",children:(0,s.jsxs)("svg",{xmlns:"http://www.w3.org/2000/svg",width:"20",height:"20",viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:"2",strokeLinecap:"round",strokeLinejoin:"round",children:[(0,s.jsx)("path",{d:"M18 6 6 18"}),(0,s.jsx)("path",{d:"m6 6 12 12"})]})})]})]}),k.length>0?(0,s.jsx)("div",{className:"flex-1 overflow-y-auto custom-scrollbar pr-1 -mr-1",children:(0,s.jsx)("div",{className:"space-y-3",children:k.map((e,t)=>(0,s.jsxs)("div",{className:"bg-zinc-950/30 rounded border border-white/5 overflow-hidden",children:[(0,s.jsxs)("div",{className:(0,c.cn)("p-3 cursor-pointer transition-colors flex justify-between items-center",e.isExpanded?"bg-zinc-800/80":"hover:bg-zinc-800/40"),onClick:()=>{S(e=>e.map((e,i)=>i===t?{...e,isExpanded:!e.isExpanded}:e))},children:[(0,s.jsxs)("div",{className:"flex items-center gap-2",children:[(0,s.jsx)("div",{className:(0,c.cn)("w-4 h-4 rounded-full bg-zinc-800 flex items-center justify-center text-[10px] text-zinc-400 transition-transform duration-200",e.isExpanded?"rotate-90 bg-violet-500/20 text-violet-300":""),children:"▶"}),(0,s.jsx)("span",{className:"font-medium text-sm text-zinc-200",children:e.projectName}),(0,s.jsxs)("span",{className:"px-1.5 py-0.5 rounded text-[10px] bg-zinc-800 text-zinc-400 border border-white/5",children:[e.count,"戶"]})]}),(0,s.jsx)("div",{className:"text-right",children:(0,s.jsxs)("div",{className:"text-xs font-mono text-cyan-400",children:[e.unitPriceRange.min===e.unitPriceRange.max?e.unitPriceRange.min.toFixed(1):`${e.unitPriceRange.min.toFixed(1)}~${e.unitPriceRange.max.toFixed(1)}`," ",(0,s.jsx)("span",{className:"text-zinc-500 text-[10px]",children:"萬/坪"})]})})]}),e.isExpanded&&(0,s.jsxs)("div",{className:"p-3 bg-black/20 border-t border-white/5",children:[(0,s.jsxs)("div",{className:"grid grid-cols-2 gap-x-4 gap-y-2 text-xs mb-3 text-zinc-400",children:[(0,s.jsxs)("div",{className:"flex justify-between border-b border-white/5 pb-1",children:[(0,s.jsx)("span",{children:"總價範圍"}),(0,s.jsx)("span",{className:"font-mono text-zinc-300",children:e.priceRange.min===e.priceRange.max?$(e.priceRange.min):`${$(e.priceRange.min)}~${$(e.priceRange.max)}`})]}),(0,s.jsxs)("div",{className:"flex justify-between border-b border-white/5 pb-1",children:[(0,s.jsx)("span",{children:"總價中位數"}),(0,s.jsx)("span",{className:"font-mono text-violet-300",children:$(e.priceRange.median||0)})]})]}),(0,s.jsxs)("div",{className:"space-y-1",children:[(0,s.jsxs)("div",{className:"grid grid-cols-5 text-[10px] text-zinc-500 pb-1 border-b border-white/5",children:[(0,s.jsx)("div",{className:"col-span-1",children:"樓層"}),(0,s.jsx)("div",{className:"col-span-1",children:"坪數"}),(0,s.jsx)("div",{className:"col-span-1 text-right",children:"單價"}),(0,s.jsx)("div",{className:"col-span-2 text-right",children:"總價"})]}),e.transactions.slice(0,e.showAll?void 0:10).map((e,t)=>(0,s.jsxs)("div",{className:"grid grid-cols-5 text-xs py-1 hover:bg-white/5 rounded px-1 -mx-1 transition-colors",children:[(0,s.jsx)("div",{className:"col-span-1 text-zinc-300",children:e["樓層"]||e.floor||"-"}),(0,s.jsx)("div",{className:"col-span-1 text-zinc-400",children:(e["房屋面積(坪)"]||e.houseArea||0).toFixed(1)}),(0,s.jsx)("div",{className:"col-span-1 text-right text-cyan-400",children:(e["房屋單價(萬)"]||e.unitPrice||0).toFixed(0)}),(0,s.jsx)("div",{className:"col-span-2 text-right text-zinc-300 font-mono",children:$(e["交易總價(萬)"]||e.totalPrice||0)})]},t)),e.transactions.length>10&&(0,s.jsx)("button",{onClick:e=>{e.stopPropagation(),S(e=>e.map((e,i)=>i===t?{...e,showAll:!e.showAll}:e))},className:"w-full text-center text-[10px] text-zinc-500 hover:text-cyan-400 py-1.5 mt-1 border-t border-white/5 transition-colors",children:e.showAll?"收合內容":`還有 ${e.transactions.length-10} 筆交易...`})]})]})]},t))})}):(0,s.jsx)("div",{className:"flex-1 flex flex-col items-center justify-center text-zinc-500 border border-dashed border-zinc-800 rounded bg-zinc-900/30",children:(0,s.jsx)("p",{children:"無詳細資料"})})]})})]})}),(0,s.jsx)(p.K,{})]})}},55810:(e,t,i)=>{i.d(t,{p:()=>b});var s=i(95155),n=i(12115),a=i(34361),r=i(69690),l=i(88743),c=i(89239),o=i(86901),d=i(89123),x=i(37595),m=i(56842),h=i(72055),p=i(65770),u=i(41641),f=i(21362),g=i(78795);function b({data:e,visibleSections:t=["metrics","chart","table"]}){let{rankingCurrentPage:i,rankingPageSize:b,setRankingCurrentPage:j,setRankingPageSize:v}=(0,l.P)(),[y,N]=(0,n.useState)(1),[w,z]=(0,n.useState)(10),[k,S]=(0,n.useState)({key:"saleAmountSum",order:"desc"}),[_,P]=(0,n.useState)(30),[A,M]=(0,n.useState)("auto"),C=n.useRef(null),F=n.useRef(null),$=n.useRef(null);if(!e)return null;let{coreMetrics:R,projectRanking:T}=e,E=(0,n.useMemo)(()=>{if(!T||0===T.length)return{min:0,max:0,median:0,parking:0};let e=Math.min(...T.map(e=>e.minPrice).filter(e=>e>0)),t=Math.max(...T.map(e=>e.maxPrice)),i=T.map(e=>e.medianPrice).filter(e=>e>0),s=i.length>0?i.reduce((e,t)=>e+t,0)/i.length:0,n=T.map(e=>e.avgParkingPrice).filter(e=>e>0);return{min:e,max:t,median:s,parking:n.length>0?n.reduce((e,t)=>e+t,0)/n.length:0}},[T]),D=(0,n.useMemo)(()=>T?[...T].sort((e,t)=>{let i=e[k.key]||0,s=t[k.key]||0;return"desc"===k.order?s-i:i-s}):[],[T,k]),I=Math.ceil(D.length/w),L=D.slice((y-1)*w,y*w),O=e=>{S({key:e,order:"desc"})},B=({title:e,value:t,unit:i,sortKey:n})=>(0,s.jsxs)("div",{onClick:()=>n&&O(n),className:`bg-zinc-800/50 rounded-lg p-4 border border-white/5 flex flex-col items-center justify-center text-center transition-all duration-300 ${n?"cursor-pointer hover:bg-zinc-800 hover:border-violet-500/30 hover:shadow-[0_0_20px_rgba(139,92,246,0.1)] group":""}`,children:[(0,s.jsx)("div",{className:`text-zinc-400 text-sm mb-1 ${n?"group-hover:text-violet-300":""}`,children:e}),(0,s.jsxs)("div",{className:"flex items-baseline gap-1",children:[(0,s.jsx)("span",{className:`text-2xl font-bold text-white ${n?"group-hover:text-white":""}`,children:t}),(0,s.jsx)("span",{className:"text-xs text-zinc-500",children:i})]})]});return(0,s.jsxs)("div",{className:"space-y-6 animate-in fade-in slide-in-from-bottom-4 duration-500",children:[t.includes("metrics")&&(0,s.jsx)(a.c,{title:"核心數據指標",containerRef:C,headerAction:(0,s.jsx)(g.N,{data:[R,E],filename:"core_metrics",label:"匯出",chartType:"ranking-metrics",targetRef:C,snapshotData:{coreMetrics:R,derivedMetrics:E}}),children:(0,s.jsxs)("div",{className:"grid grid-cols-1 sm:grid-cols-2 md:grid-cols-4 gap-3 sm:gap-4",children:[(0,s.jsx)(B,{title:"市場去化總銷售金額",value:R.totalSaleAmount.toLocaleString(),unit:"萬",sortKey:"saleAmountSum"}),(0,s.jsx)(B,{title:"總銷去化房屋坪數",value:R.totalHouseArea.toLocaleString(void 0,{maximumFractionDigits:2}),unit:"坪",sortKey:"houseAreaSum"}),(0,s.jsx)(B,{title:"總平均單價",value:R.overallAveragePrice.toLocaleString(void 0,{maximumFractionDigits:2}),unit:"萬/坪",sortKey:"averagePrice"}),(0,s.jsx)(B,{title:"總交易筆數",value:R.transactionCount.toLocaleString(),unit:"筆",sortKey:"transactionCount"}),(0,s.jsx)(B,{title:"最低成交單價 (Min)",value:E.min.toLocaleString(void 0,{maximumFractionDigits:1}),unit:"萬/坪",sortKey:"minPrice"}),(0,s.jsx)(B,{title:"最高成交單價 (Max)",value:E.max.toLocaleString(void 0,{maximumFractionDigits:1}),unit:"萬/坪",sortKey:"maxPrice"}),(0,s.jsx)(B,{title:"平均中位數單價",value:E.median.toLocaleString(void 0,{maximumFractionDigits:1}),unit:"萬/坪",sortKey:"medianPrice"}),(0,s.jsx)(B,{title:"平均車位價格",value:E.parking.toLocaleString(void 0,{maximumFractionDigits:0}),unit:"萬",sortKey:"avgParkingPrice"})]})}),t.includes("chart")&&(0,s.jsxs)("div",{className:"space-y-4",children:[(0,s.jsx)("div",{className:"flex flex-wrap gap-2 justify-center",children:[{key:"saleAmountSum",label:"交易總價(萬)"},{key:"houseAreaSum",label:"房屋面積(坪)"},{key:"transactionCount",label:"資料筆數"},{key:"marketShare",label:"市場佔比(%)"},{key:"averagePrice",label:"平均單價"},{key:"minPrice",label:"最低單價"},{key:"maxPrice",label:"最高單價"},{key:"medianPrice",label:"中位數單價"},{key:"avgParkingPrice",label:"車位均價"}].map(e=>(0,s.jsx)("button",{onClick:()=>O(e.key),className:`px-3 py-1.5 text-xs font-medium rounded-full border transition-all duration-300 ${k.key===e.key?"bg-violet-600/20 border-violet-500/50 text-violet-300 shadow-[0_0_15px_rgba(139,92,246,0.2)]":"bg-zinc-800/50 border-white/5 text-zinc-400 hover:text-white hover:bg-zinc-800 hover:border-white/10"}`,children:e.label},e.key))}),(0,s.jsx)(a.c,{title:"建案分析圖表",description:"根據排序指標顯示建案排名",containerRef:F,headerAction:(0,s.jsxs)("div",{className:"flex flex-col sm:flex-row items-start sm:items-center gap-3 w-full sm:w-auto",children:[(0,s.jsxs)("div",{className:"flex bg-zinc-800 p-0.5 rounded-lg border border-white/5",children:[(0,s.jsx)("button",{onClick:()=>M("auto"),className:`p-1.5 rounded-md transition-all ${"auto"===A?"bg-violet-600 text-white shadow-lg shadow-violet-500/20":"text-zinc-400 hover:text-white hover:bg-white/5"}`,title:"自動選擇 (Auto)",children:(0,s.jsx)(o.A,{size:14})}),(0,s.jsx)("button",{onClick:()=>M("bar"),className:`p-1.5 rounded-md transition-all ${"bar"===A?"bg-violet-600 text-white shadow-lg shadow-violet-500/20":"text-zinc-400 hover:text-white hover:bg-white/5"}`,title:"長條圖 (Bar)",children:(0,s.jsx)(d.A,{size:14})}),(0,s.jsx)("button",{onClick:()=>M("treemap"),className:`p-1.5 rounded-md transition-all ${"treemap"===A?"bg-violet-600 text-white shadow-lg shadow-violet-500/20":"text-zinc-400 hover:text-white hover:bg-white/5"}`,title:"矩形樹圖 (Treemap)",children:(0,s.jsx)(x.A,{size:14})})]}),(0,s.jsx)("div",{className:"hidden sm:block w-px h-6 bg-white/10"}),(0,s.jsxs)("div",{className:"flex items-center gap-3 w-full sm:w-auto justify-between sm:justify-start",children:[(0,s.jsx)("div",{className:"flex bg-zinc-800 p-0.5 rounded-lg border border-white/5 overflow-x-auto max-w-[200px] sm:max-w-none scrollbar-hide",children:[10,30,50,100].map(e=>(0,s.jsxs)("button",{onClick:()=>P(e),className:`px-3 py-1 text-xs rounded-md transition-all whitespace-nowrap ${_===e?"bg-violet-600 text-white shadow-lg shadow-violet-500/20":"text-zinc-400 hover:text-white hover:bg-white/5"}`,children:["Top ",e]},e))}),(0,s.jsx)("div",{className:"hidden sm:block w-px h-6 bg-white/10"}),(0,s.jsx)(g.N,{data:D.slice(0,_),filename:"ranking_chart_data",label:"匯出",chartType:"ranking-chart",targetRef:F,snapshotData:D.slice(0,_),columns:{projectName:"建案名稱",county:"縣市",district:"行政區",saleAmountSum:"交易總價",houseAreaSum:"房屋面積",transactionCount:"資料筆數",marketShare:"市場佔比",averagePrice:"平均單價",minPrice:"最低單價",maxPrice:"最高單價",medianPrice:"中位數單價",avgParkingPrice:"車位均價"}})]})]}),children:(0,s.jsx)(r.l,{data:D,sortKey:k.key,limit:_,chartType:A})})]}),t.includes("table")&&(0,s.jsxs)(a.c,{title:"區域建案排行列表",description:"點擊表頭可進行排序",containerRef:$,headerAction:(0,s.jsx)(g.N,{data:D,filename:"ranking_table_data",label:"匯出",chartType:"ranking-table",targetRef:$,snapshotData:D,columns:{projectName:"建案名稱",county:"縣市",district:"行政區",saleAmountSum:"交易總價",houseAreaSum:"房屋面積",transactionCount:"資料筆數",marketShare:"市場佔比",averagePrice:"平均單價",minPrice:"最低單價",maxPrice:"最高單價",medianPrice:"中位數單價",avgParkingPrice:"車位均價"}}),children:[(0,s.jsx)("div",{className:"overflow-x-auto",children:(0,s.jsxs)("table",{className:"w-full text-sm text-left",children:[(0,s.jsx)("thead",{className:"bg-zinc-900/80 text-zinc-400 uppercase text-xs font-semibold",children:(0,s.jsxs)("tr",{children:[(0,s.jsx)("th",{className:"px-4 py-3 cursor-default",children:"排名"}),(0,s.jsx)("th",{className:"px-4 py-3 cursor-default",children:"建案名稱"}),[{key:"saleAmountSum",label:(0,s.jsxs)(s.Fragment,{children:["交易",(0,s.jsx)("br",{}),"總價(萬)"]})},{key:"houseAreaSum",label:(0,s.jsxs)(s.Fragment,{children:["房屋",(0,s.jsx)("br",{}),"面積(坪)"]})},{key:"transactionCount",label:(0,s.jsxs)(s.Fragment,{children:["資料",(0,s.jsx)("br",{}),"筆數"]})},{key:"marketShare",label:(0,s.jsxs)(s.Fragment,{children:["市場",(0,s.jsx)("br",{}),"佔比(%)"]})},{key:"averagePrice",label:(0,s.jsxs)(s.Fragment,{children:["平均",(0,s.jsx)("br",{}),"單價"]})},{key:"minPrice",label:(0,s.jsxs)(s.Fragment,{children:["最低",(0,s.jsx)("br",{}),"單價"]})},{key:"maxPrice",label:(0,s.jsxs)(s.Fragment,{children:["最高",(0,s.jsx)("br",{}),"單價"]})},{key:"medianPrice",label:(0,s.jsxs)(s.Fragment,{children:["中位數",(0,s.jsx)("br",{}),"單價"]})},{key:"avgParkingPrice",label:(0,s.jsxs)(s.Fragment,{children:["車位",(0,s.jsx)("br",{}),"均價"]})}].map(e=>(0,s.jsx)("th",{className:"px-3 py-3 cursor-pointer hover:text-white transition-colors text-center whitespace-nowrap",onClick:()=>O(e.key),children:(0,s.jsxs)("div",{className:"flex items-center justify-center gap-1.5 group/header",children:[(0,s.jsx)("span",{className:"leading-tight",children:e.label}),(0,s.jsx)("div",{className:"flex flex-col opacity-50 group-hover/header:opacity-100 transition-opacity",children:k.key===e.key?"desc"===k.order?(0,s.jsx)(m.A,{size:14,className:"text-violet-500"}):(0,s.jsx)(h.A,{size:14,className:"text-violet-500"}):(0,s.jsx)(p.A,{size:14,className:"text-zinc-600 group-hover/header:text-zinc-400"})})]})},e.key))]})}),(0,s.jsx)("tbody",{className:"divide-y divide-white/5",children:L.map((e,t)=>(0,s.jsxs)("tr",{className:"hover:bg-zinc-800/50 transition-colors",children:[(0,s.jsx)("td",{className:"px-4 py-3 text-zinc-500 font-mono",children:(y-1)*w+t+1}),(0,s.jsx)("td",{className:"px-4 py-3",children:(0,s.jsxs)("div",{className:"flex flex-col",children:[(0,s.jsx)("span",{className:"font-medium text-white",children:e.projectName}),(0,s.jsxs)("div",{className:"flex gap-1 mt-1",children:[e.county&&(0,s.jsx)("span",{className:"text-[10px] bg-zinc-800 text-zinc-400 px-1 py-0.5 rounded",children:e.county}),e.district&&(0,s.jsx)("span",{className:"text-[10px] bg-zinc-800 text-zinc-400 px-1 py-0.5 rounded",children:e.district})]})]})}),(0,s.jsx)("td",{className:"px-4 py-3 font-mono text-zinc-300",children:e.saleAmountSum.toLocaleString()}),(0,s.jsx)("td",{className:"px-4 py-3 font-mono text-zinc-300",children:e.houseAreaSum.toLocaleString()}),(0,s.jsx)("td",{className:"px-4 py-3 font-mono text-zinc-300",children:e.transactionCount.toLocaleString()}),(0,s.jsxs)("td",{className:"px-4 py-3 font-mono text-zinc-300",children:[e.marketShare.toFixed(2),"%"]}),(0,s.jsx)("td",{className:"px-4 py-3 font-mono text-cyan-400",children:e.averagePrice.toFixed(1)}),(0,s.jsx)("td",{className:"px-4 py-3 font-mono text-zinc-500",children:e.minPrice.toFixed(1)}),(0,s.jsx)("td",{className:"px-4 py-3 font-mono text-zinc-500",children:e.maxPrice.toFixed(1)}),(0,s.jsx)("td",{className:"px-4 py-3 font-mono text-zinc-400",children:e.medianPrice.toFixed(1)}),(0,s.jsx)("td",{className:"px-4 py-3 font-mono text-zinc-400",children:e.avgParkingPrice>0?e.avgParkingPrice.toLocaleString():"-"})]},t))}),(0,s.jsx)("tfoot",{className:"bg-zinc-900/80 font-bold border-t-2 border-zinc-700",children:(0,s.jsxs)("tr",{children:[(0,s.jsx)("td",{colSpan:2,className:"px-4 py-3 text-center text-zinc-300",children:"總計"}),(0,s.jsx)("td",{className:"px-4 py-3 text-zinc-300",children:R.totalSaleAmount.toLocaleString()}),(0,s.jsx)("td",{className:"px-4 py-3 text-zinc-300",children:R.totalHouseArea.toLocaleString()}),(0,s.jsx)("td",{className:"px-4 py-3 text-zinc-300",children:R.transactionCount.toLocaleString()}),(0,s.jsx)("td",{colSpan:6})]})})]})}),(0,s.jsxs)("div",{className:"flex items-center justify-between mt-4 border-t border-white/5 pt-4",children:[(0,s.jsxs)("div",{className:"text-sm text-zinc-500",children:["顯示 ",(y-1)*w+1," 到 ",Math.min(y*w,D.length)," 筆，共 ",D.length," 筆"]}),(0,s.jsxs)("div",{className:"flex items-center gap-2",children:[(0,s.jsx)(c.$,{variant:"outline",size:"sm",onClick:()=>N(e=>Math.max(1,e-1)),disabled:1===y,children:(0,s.jsx)(u.A,{size:16})}),(0,s.jsxs)("span",{className:"text-sm text-zinc-300",children:["Page ",y," of ",I]}),(0,s.jsx)(c.$,{variant:"outline",size:"sm",onClick:()=>N(e=>Math.min(I,e+1)),disabled:y===I,children:(0,s.jsx)(f.A,{size:16})})]})]})]})]})}},57662:(e,t,i)=>{i.d(t,{b:()=>ea});var s=i(95155),n=i(12115),a=i(34361),r=i(93398);class l{constructor(){this.knownPatterns=new Map,this.patternFrequency=new Map,this.initializeBasePatterns()}initializeBasePatterns(){[{id:"unit_slash_floorF_format",name:"戶號斜線樓層F格式",regex:/^([A-Z]\d+)\/(\d+)F[號号]?$/i,extract:(e,t)=>{let i=e[1],s=e[2];return t?.floor&&parseInt(s,10)===parseInt(t.floor,10)?i:i+s},confidence:100,priority:.01},{id:"building_unit_floor_combined",name:"棟別戶號樓層合併格式",regex:/^([A-Z])棟(\d+)-(\d+)[號号]?$/i,extract:(e,t)=>{let i=e[1],s=e[2],n=e[3];return t?.floor&&parseInt(n,10)===parseInt(t.floor,10)?i+s:i+s+n},confidence:100,priority:.02},{id:"building_unit_floorF_format_v2",name:"棟別戶號樓層F格式v2",regex:/^([A-Z])棟(\d+)-(\d+)F[號号]?$/i,extract:(e,t)=>{let i=e[1],s=e[2],n=e[3];return t?.floor&&parseInt(n,10)===parseInt(t.floor,10)?i+s:i+s+n},confidence:100,priority:.03},{id:"unit_building_zero_format",name:"戶號棟別0號格式",regex:/^([A-Z]\d+)棟0[號号]?$/i,extract:e=>e[1],confidence:100,priority:.04},{id:"single_letter_unit",name:"單字母戶號格式",regex:/^([A-Z])[號号]$/i,extract:e=>e[1],confidence:95,priority:.045},{id:"building_floor_unit_letter_format",name:"棟別樓層數字戶型字母格式",regex:/^([A-Z])棟(\d+)([A-Z])[號号]?$/i,extract:(e,t)=>{let i=e[1],s=parseInt(e[2],10),n=e[3];return t?.floor&&s===parseInt(t.floor,10)?n:`${i}${s}${n}`},confidence:99,priority:.05},{id:"building_floor_unit_format",name:"棟別樓層戶號格式",regex:/^([A-Z])棟(\d{1,2})F-(\d+)[號号]?$/,extract:(e,t)=>{let i=e[1],s=e[2],n=e[3];return t?.floor&&parseInt(s,10)===parseInt(t.floor,10)?i+n:i+s+n},confidence:99,priority:.1},{id:"letter_number_floor_format",name:"字母數字-樓層F格式",regex:/^([A-Z])0*(\d+)-(\d{1,2})F[號号]?$/,extract:(e,t)=>{let i=e[1],s=e[2],n=e[3];return t?.floor&&parseInt(n,10)===parseInt(t.floor,10)?i+s:i+s+n},confidence:99,priority:.15},{id:"identifier_building_floor_redundant",name:"識別碼棟與F樓層格式(贅余樓層)",regex:/^([A-Z]\d+)棟F(\d+)[號号]?$/i,extract:(e,t)=>{let i=e[1],s=e[2],n=i.match(/^[A-Z]+/)?.[0]||"",a=parseInt(i.match(/\d+/)?.[0]||"0",10),r=`${n}${a}`;return t?.floor&&parseInt(s,10)===parseInt(t.floor,10)?r:r+"F"+s},confidence:98,priority:.18},{id:"identifier_building_floorF_format",name:"識別碼棟與樓層F格式(贅余樓層)",regex:/^([A-Z]\d+)棟(\d{1,2})F[號号]?$/i,extract:(e,t)=>{let i=e[1],s=e[2];return t?.floor&&parseInt(s,10)===parseInt(t.floor,10)?i:i+s},confidence:98,priority:.19},{id:"unit_building_floor_format",name:"戶棟樓層格式",regex:/^([A-Z]\d+)戶棟(\d+)F[號号]?$/,extract:(e,t)=>{let i=e[1],s=e[2];return t?.floor&&parseInt(s,10)===parseInt(t.floor,10)?i:i+s},confidence:99,priority:.2},{id:"building_sub_unit_floor_format",name:"棟別子戶號樓層格式",regex:/^([A-Z])棟(\d+)-(\d+)F[號号]?$/,extract:(e,t)=>{let i=e[1],s=e[2],n=e[3];return t?.floor&&parseInt(n,10)===parseInt(t.floor,10)?i+s:i+s+n},confidence:99,priority:.3},{id:"building_unit_floor_format",name:"棟別戶別樓層格式",regex:/^([A-Z])棟([A-Z])-(\d{1,2})F[號号]?$/,extract:(e,t)=>{let i=e[2],s=e[3];return t?.floor&&parseInt(s,10)===parseInt(t.floor,10)?i:i+s},confidence:99,priority:.4},{id:"building_self_unit_floor_format",name:"棟別自身戶號樓層格式",regex:/^([A-Z])棟\1-(\d+)[號号]?$/,extract:(e,t)=>{let i=e[1],s=e[2];return t?.floor&&parseInt(s,10)===parseInt(t.floor,10)?i:i+s},confidence:98,priority:.45},{id:"building_unit_letter_floor_number",name:"棟別戶號字母樓層數字格式",regex:/^([A-Z])棟([A-Z])(\d{1,2})[號号]?$/,extract:(e,t)=>{let i=e[2],s=e[3];return t?.floor&&parseInt(s,10)===parseInt(t.floor,10)?i:i+s},confidence:98,priority:.46},{id:"redundant_building_format",name:"重複棟別格式",regex:/^([A-Z])棟\1-(\d{1,2})F[號号]?$/,extract:(e,t)=>{let i=e[1],s=e[2];return t?.floor&&parseInt(s,10)===parseInt(t.floor,10)?i:i+s},confidence:98,priority:.5},{id:"building_floor_letter_unit",name:"棟別樓層字母戶號格式",regex:/^[A-Z]棟(\d{1,2})F-([A-Z])[號号]?$/,extract:(e,t)=>{let i=e[1],s=e[2];return t?.floor&&parseInt(i,10)===parseInt(t.floor,10)?s:s+i},confidence:98,priority:.6},{id:"letter_leading_zero_unit",name:"字母與0開頭數字戶號",regex:/^([A-Z])0+(\d+)[號号]?$/,extract:e=>e[1]+e[2],confidence:97,priority:.7},{id:"floor_prefix_format",name:"樓層前綴格式",regex:/^(\d{1,2})([A-Z])[號号]?$/,extract:(e,t)=>{let i=e[1],s=e[2];return t?.floor&&parseInt(i,10)===parseInt(t.floor,10)?s:i+s},confidence:96,priority:.8},{id:"floorF_building_unit_format",name:"樓層F棟戶號格式",regex:/^(\d{1,2})F棟([A-Z])[號号]?$/,extract:(e,t)=>{let i=e[1],s=e[2];return t?.floor&&parseInt(i,10)===parseInt(t.floor,10)?s:i+s},confidence:98,priority:.85},{id:"numericBuilding_floor_unit_format",name:"數字棟別樓層戶號格式",regex:/^(\d+)棟(\d{1,2})([A-Z])[號号]?$/,extract:(e,t)=>{let i=e[2],s=e[3];return t?.floor&&parseInt(i,10)===parseInt(t.floor,10)?s:i+s},confidence:98,priority:.86},{id:"floor_first_detailed",name:"樓層優先詳細格式",regex:/(\d{1,2})F-([A-Z])(\d{2})/,extract:e=>e[2]+e[3],confidence:95,priority:1},{id:"floor_prefix_complex_unit",name:"樓層前綴複合戶號",regex:/^(\d{1,2})F-([A-Z]\d+)[號号]?$/,extract:(e,t)=>{let i=e[1],s=e[2];return t?.floor&&parseInt(i,10)===parseInt(t.floor,10)?s:i+s},confidence:94,priority:1.2},{id:"floor_first_simple_letter",name:"樓層優先簡單字母格式",regex:/^(\d{1,2})F-([A-Z])[號号]?$/,extract:(e,t)=>{let i=e[1],s=e[2];return t?.floor&&parseInt(i,10)===parseInt(t.floor,10)?s:i+s},confidence:90,priority:1.5},{id:"building_with_unit",name:"棟別完整戶號",regex:/([A-Z])棟([A-Z])(\d{1,2})(?:-(\d{1,2})F?[號号])?/,extract:e=>e[2]+e[3],confidence:90,priority:2,conditions:[{type:"building_match",validator:e=>{let t=e.rawUnit.match(/([A-Z])棟([A-Z])/);return!!t&&t[1]===t[2]}}]},{id:"building_simple_letter_unit",name:"棟別字母戶號格式",regex:/^[A-Z]棟([A-Z])[號号]?$/,extract:e=>e[1],confidence:92,priority:2.5},{id:"unit_floor_suffix",name:"戶號樓層後綴",regex:/([A-Z]\d{1,2})-(\d{1,2})F?[號号]?/,extract:e=>e[1],confidence:85,priority:3},{id:"building_floor_format",name:"棟別樓層格式",regex:/^([A-Z]\d{1,2})棟(\d{1,2})(?:F|樓)[號号]?$/,extract:(e,t)=>{let i=e[1],s=e[2];return t?.floor&&parseInt(s,10)===parseInt(t.floor,10)?i:i+s},confidence:88,priority:3.5},{id:"building_complex_number",name:"複合棟別編號",regex:/^([A-Z]\d+)棟(\d+)[號号]$/,extract:(e,t)=>{let i=e[1],s=e[2];return t?.floor&&parseInt(s,10)===parseInt(t.floor,10)?i:i+s},confidence:86,priority:3.8},{id:"building_floor_F_format",name:"棟別樓層F格式",regex:/^([A-Z])棟(\d{1,2})F[號号]?$/,extract:(e,t)=>{let i=e[1],s=e[2];return t?.floor&&parseInt(s,10)===parseInt(t.floor,10)?i:i+s},confidence:87,priority:3.9},{id:"building_zero_placeholder_unit",name:"棟別0號佔位符格式",regex:/^([A-Z])棟0[號号]?$/,extract:e=>e[1],confidence:95,priority:3.95},{id:"building_simple_number",name:"棟別簡單編號",regex:/([A-Z])棟(\d{1,2})[號号]/,extract:(e,t)=>{let i=e[1],s=e[2];return t?.floor&&parseInt(s,10)===parseInt(t.floor,10)?i:i+s},confidence:85,priority:4},{id:"unit_floor_concatenated",name:"複合戶號樓層格式",regex:/^([A-Z])(\d+)F[號号]?$/,extract:(e,t)=>{let i=e[1],s=e[2],n=t?.floor;if(n){let e=parseInt(n,10);if(!isNaN(e)){if(e<10){let e="0"+n;if(s.endsWith(e))return i+s.substring(0,s.length-2)}if(s.endsWith(n))return i+s.substring(0,s.length-n.length)}}return i+s},confidence:80,priority:4.5},{id:"letter_floor",name:"字母樓層格式",regex:/^([A-Z])-(\d{1,2})F?[號号]?$/,extract:(e,t)=>{let i=e[2];return t?.floor&&parseInt(i,10)===parseInt(t.floor,10)?e[1]:e[1]+i},confidence:70,priority:5}].forEach(e=>{this.knownPatterns.set(e.id,e)})}detectPattern(e,t){let i=this.normalizeText(e),s=null;for(let e of Array.from(this.knownPatterns.values()).sort((e,t)=>e.priority-t.priority)){let n=i.match(e.regex);if(n){if(e.conditions&&t&&!e.conditions.every(e=>e.validator(t)))continue;s={rule:e,match:n};break}}return s&&this.patternFrequency.set(s.rule.id,(this.patternFrequency.get(s.rule.id)||0)+1),s}normalizeText(e){return e?e.toUpperCase().replace(/[\uff01-\uff5e]/g,e=>String.fromCharCode(e.charCodeAt(0)-65248)).replace(/\s+/g,""):""}}class c{analyzeProject(e,t){let i={projectName:e,patterns:new Map,unitMappings:new Map,namingStyle:"unknown"},s=new l;for(let n of t){let t=n["戶別"],a=n["樓層"];if(!t)continue;let r={rawUnit:t,floor:a?String(a):void 0,projectName:e},l=s.detectPattern(t,r);if(l){let e=l.rule;i.patterns.has(e.id)||i.patterns.set(e.id,{patternId:e.id,count:0,examples:[],confidence:e.confidence});let s=i.patterns.get(e.id);s.count++,s.examples.length<10&&s.examples.push(t)}i.unitMappings.has(t)||i.unitMappings.set(t,{floors:new Set,rawVariations:new Set([t])});let c=i.unitMappings.get(t);a&&c.floors.add(String(a))}return this.determineNamingStyle(i),this.projectProfiles.set(e,i),i}determineNamingStyle(e){let t=e.patterns.size,i=Array.from(e.patterns.values()).reduce((e,t)=>e+t.count,0);if(0===t){e.namingStyle="unknown";return}let s=null,n=0;for(let t of e.patterns.values())t.count>n&&(n=t.count,s=t);s&&(e.dominantPattern=s.patternId,s.count/i>.8?e.namingStyle="consistent":e.namingStyle="mixed")}getProjectProfile(e){return this.projectProfiles.get(e)}isAmbiguousUnit(e,t){let i=this.projectProfiles.get(e);if(!i)return!1;let s=i.unitMappings.get(t);return!!s&&s.floors.size>1}constructor(){this.projectProfiles=new Map}}class o{constructor(e){this.customRules=new Map,this.detector=e,this.initializeCustomRules()}initializeCustomRules(){}applyRules(e){for(let[t,i]of this.customRules){let t=i(e);if(t)return t}let t=this.detector.detectPattern(e.rawUnit,e);if(t){let{rule:i,match:s}=t;return{identifier:i.extract(s,e),confidence:i.confidence,method:`pattern:${i.id}`}}return{identifier:this.simpleFallback(e.rawUnit),confidence:50,method:"fallback"}}simpleFallback(e){return e?e.toUpperCase().replace(/[\uff01-\uff5e]/g,e=>String.fromCharCode(e.charCodeAt(0)-65248)).replace(/\s+/g,"").replace(/[棟樓F室號\-]/g,""):""}}class d{constructor(e){this.resolveCache=new Map,console.log("[AdaptiveUnitResolver] 初始化，處理",e.length,"筆資料"),this.detector=new l,this.analyzer=new c,this.ruleEngine=new o(this.detector),this.buildKnowledgeBase(e)}buildKnowledgeBase(e){let t=new Map;for(let i of e){let e=i["建案名稱"];e&&(t.has(e)||t.set(e,[]),t.get(e).push(i))}for(let[e,i]of(console.log("[AdaptiveUnitResolver] 分析",t.size,"個建案"),t))this.analyzer.analyzeProject(e,i)}resolve(e){return this.resolveWithContext(e).identifier}resolveWithContext(e){let t=e["戶別"];t&&"string"==typeof t&&(t=t.trim());let i=e["樓層"],s=e["建案名稱"];if(!t)return{identifier:"",confidence:0,method:"no_input"};let n=`${s}|${t}|${i||""}`;if(this.resolveCache.has(n))return this.resolveCache.get(n);let a={rawUnit:t,floor:i?String(i):void 0,projectName:s},r=this.ruleEngine.applyRules(a);if(r)return this.resolveCache.set(n,r),r;let l={identifier:t,confidence:0,method:"fallback_null"};return this.resolveCache.set(n,l),l}}var x=i(80642),m=i(39430),h=i(86901),p=i(94514),u=i(21628);function f({transactions:e,currentPremium:t,onApply:i,onManualChange:a}){let[r,l]=(0,n.useState)(null),[c,o]=(0,n.useState)(!1),[f,g]=(0,n.useState)(String(t)),b=(0,n.useRef)(null),[j,v]=(0,n.useState)(null),[y,N]=(0,n.useState)(360),w=Math.max(160,y-28),z=(0,n.useMemo)(()=>(function(e){if(!e||0===e.length)return[];let t=[],i={},s=new d(e);e.forEach(e=>{let t=((e,t)=>{let i=e?.["戶型"];if("string"==typeof i&&i)return i;let s=t.resolve(e);if(s)return s;let n=e?.["戶別"]||e?.unit||e?.unitName;return"string"==typeof n&&n?n:""})(e,s),n=(e=>{if(!e)return 0;let t=String(e).match(/\d+/);return t?parseInt(t[0],10):0})(e["樓層"]||e.floor||""),a=parseFloat(e["房屋單價(萬)"]||e.unitPrice||0);t&&0!==n&&a>0&&(i[t]||(i[t]=[]),i[t].push({floor:n,price:a,original:e}))}),Object.entries(i).forEach(([e,i])=>{i.sort((e,t)=>e.floor-t.floor);for(let s=0;s<i.length;s++)for(let n=s+1;n<i.length;n++){let a=i[s],r=i[n],l=r.floor-a.floor;if(l>0&&l<=10){let i=Math.round(10*((r.price-a.price)/l))/10;i>=-2&&i<=2&&t.push({stack:e,floorLow:a.floor,floorHigh:r.floor,priceLow:a.price,priceHigh:r.price,diff:i,dateLow:a.original["交易年月日"]||a.original["交易日"]||a.original.transactionDate,dateHigh:r.original["交易年月日"]||r.original["交易日"]||r.original.transactionDate})}}});let n=new Map;t.forEach(e=>{let t=`${e.stack}-${e.floorLow}-${e.floorHigh}-${e.priceLow}-${e.priceHigh}`;n.has(t)||n.set(t,e)});let a=Array.from(n.values()),r={};a.forEach(e=>{r[e.diff]||(r[e.diff]={premium:e.diff,count:0,pairs:[]}),r[e.diff].count+=1,r[e.diff].pairs.push(e)});let l=Object.values(r);return l.sort((e,t)=>t.count!==e.count?t.count-e.count:e.premium-t.premium),l})(e),[e]),k=(0,n.useMemo)(()=>[...z.slice(0,5)].sort((e,t)=>e.premium-t.premium),[z]),S=(0,n.useMemo)(()=>[...z].sort((e,t)=>e.premium-t.premium),[z]),_=(0,n.useMemo)(()=>c?S:k,[c,S,k]),P=(0,n.useMemo)(()=>z.find(e=>1e-6>Math.abs(e.premium-t))||null,[z,t]),A=z.length>k.length;(0,n.useEffect)(()=>{l(null)},[P?.premium]),(0,n.useEffect)(()=>{g(String(t))},[t]),(0,n.useEffect)(()=>{if(!b.current)return;let e=()=>{if(!b.current)return;let e=Math.round(b.current.getBoundingClientRect().width);e>0&&v(e)};e();let t=new ResizeObserver(()=>e());return t.observe(b.current),window.addEventListener("resize",e),()=>{t.disconnect(),window.removeEventListener("resize",e)}},[]),(0,n.useEffect)(()=>{let e=()=>{N(Math.max(260,Math.min(520,Math.round(.55*window.innerHeight))))};return e(),window.addEventListener("resize",e),()=>window.removeEventListener("resize",e)},[]);let M=(0,n.useMemo)(()=>{let t=new Set,i=new Set,s=new d(e);e.forEach(e=>{if(!e)return;let n=(e=>{let t=e?.["戶型"];if("string"==typeof t&&t)return t;let i=s.resolve(e);if(i)return i;let n=e?.["戶別"]||e?.unit||e?.unitName;return"string"==typeof n&&n?n:""})(e),a=(e=>{if(!e)return 0;let t=String(e).match(/\d+/);return t?parseInt(t[0],10):0})(e["樓層"]||e.floor);n&&t.add(n),0!==a&&i.add(a)});let n=Array.from(i).sort((e,t)=>t-e),a=e=>{let t=String(e||"").trim().toUpperCase(),i=t.match(/^([A-Z]+)(\d+)?$/);return i?{alpha:i[1]||"",num:i[2]?parseInt(i[2],10):Number.MAX_SAFE_INTEGER,raw:t}:{alpha:t,num:Number.MAX_SAFE_INTEGER,raw:t}},r=Array.from(t).sort((e,t)=>{let i=a(e),s=a(t),n=i.alpha.localeCompare(s.alpha,"en");return 0!==n?n:i.num!==s.num?i.num-s.num:i.raw.localeCompare(s.raw,"en")}),l=new Set;P&&P.pairs.forEach(e=>{l.add(`${e.stack}-${e.floorLow}`),l.add(`${e.stack}-${e.floorHigh}`)});let c=n.length||1,o=r.length||1,x=(j||0)-32-16,m=y-24-4,h=Math.min(40,Math.max(8,Math.min(x>0?Math.floor(x/o):24,m>0?Math.floor(m/c):24)));return{sortedFloors:n,sortedStacks:r,highlightedCells:l,cellSize:h,gridHeight:c*h+24}},[e,P,j,y]);if(0===z.length)return null;let C=null!==r&&P?P.pairs[r]:null;return(0,s.jsxs)("div",{className:"bg-zinc-900/50 border border-white/10 rounded-xl p-4 mb-6",children:[(0,s.jsxs)("div",{className:"flex items-center gap-2 mb-3",children:[(0,s.jsx)(h.A,{className:"w-4 h-4 text-yellow-400"}),(0,s.jsx)("h3",{className:"text-sm font-bold text-zinc-100",children:"AI 樓層價差分析建議"})]}),(0,s.jsxs)("div",{className:"flex flex-wrap gap-2 mb-4 items-center",children:[_.map(e=>{let n=1e-6>Math.abs(t-e.premium);return(0,s.jsxs)("button",{onClick:()=>{i(e.premium)},className:`
                                relative px-3 py-1.5 rounded-lg border text-xs font-mono transition-all
                                flex items-center gap-2
                                ${n?"bg-cyan-500/20 border-cyan-500 text-cyan-300":"bg-zinc-800 border-white/5 text-zinc-400 hover:border-white/20 hover:text-zinc-200"}
                            `,children:[(0,s.jsxs)("span",{className:"text-base font-bold",children:[e.premium>0?"+":"",e.premium]}),(0,s.jsx)("span",{className:"opacity-50",children:"萬/坪"}),(0,s.jsxs)("span",{className:"ml-1 bg-black/20 px-1.5 rounded text-[10px]",children:[e.count," 組"]}),n&&(0,s.jsx)(p.A,{className:"w-3 h-3 text-green-400"})]},e.premium)}),a&&(0,s.jsxs)("div",{className:"flex items-center gap-2 px-3 py-1.5 rounded-lg border border-white/10 bg-zinc-900/60 text-xs text-zinc-300",children:[(0,s.jsx)("span",{className:"text-[10px] text-zinc-500",children:"手動"}),(0,s.jsx)("input",{type:"text",inputMode:"decimal",value:f,onChange:e=>g(e.target.value),onBlur:()=>{let e=Number(f);Number.isNaN(e)||a(Math.max(0,e))},onKeyDown:e=>{if("Enter"===e.key){let t=Number(f);Number.isNaN(t)||(a(Math.max(0,t)),e.target.blur())}},className:"w-16 bg-transparent text-right pr-1 outline-none text-zinc-200"}),(0,s.jsx)("span",{className:"text-[10px] text-violet-300",children:"萬/坪"})]}),A&&(0,s.jsx)("button",{onClick:()=>o(e=>!e),className:"px-3 py-1.5 rounded-lg border border-white/10 bg-zinc-800 text-[10px] text-zinc-400 hover:text-zinc-200 hover:border-white/30 transition",children:c?"收合標籤":"顯示全部"})]}),(0,s.jsx)(x.N,{children:P&&(0,s.jsx)(m.P.div,{initial:{opacity:0,height:0},animate:{opacity:1,height:"auto"},exit:{opacity:0,height:0},className:"overflow-hidden",children:(0,s.jsxs)("div",{className:"border-t border-white/10 pt-4 mt-2",children:[(0,s.jsxs)("div",{className:"flex justify-between items-end mb-3",children:[(0,s.jsxs)("div",{className:"text-xs text-zinc-400",children:[(0,s.jsx)("span",{className:"text-cyan-400 font-bold",children:P.count})," 組對比符合此規律。 點擊右側明細可連動網格顯示。"]}),(0,s.jsx)("div",{className:"text-[10px] text-zinc-500",children:"點擊上方標籤即可套用"})]}),(0,s.jsxs)("div",{className:"flex flex-col xl:flex-row gap-4 items-stretch",children:[(0,s.jsx)("div",{ref:b,className:"flex-1 bg-black/40 rounded border border-white/5 p-2 overflow-hidden relative",style:{height:y},children:(0,s.jsxs)("div",{className:"w-full",children:[(0,s.jsxs)("div",{className:"flex",children:[(0,s.jsx)("div",{className:"shrink-0",style:{width:32}}),M.sortedStacks.map(e=>(0,s.jsx)("div",{className:"text-center text-[10px] text-zinc-500 pb-1",style:{width:M.cellSize},children:e},e))]}),M.sortedFloors.map(e=>(0,s.jsxs)("div",{className:"flex items-center relative z-10",style:{height:M.cellSize},children:[(0,s.jsxs)("div",{className:"shrink-0 text-right text-[10px] text-zinc-600 pr-2",style:{width:32},children:[e,"F"]}),M.sortedStacks.map(t=>{let i=`${t}-${e}`,n=M.highlightedCells.has(i),a=C&&C.stack===t&&(e===C.floorLow||e===C.floorHigh),r=P.pairs.some(i=>i.stack===t&&e>i.floorLow&&e<i.floorHigh),l=C&&C.stack===t&&e>C.floorLow&&e<C.floorHigh;return(0,s.jsxs)("div",{className:"h-full flex items-center justify-center p-0.5 relative",style:{width:M.cellSize},children:[r&&(0,s.jsx)("div",{className:`
                                                                    absolute w-0.5 h-[140%] top-[-20%] transition-colors duration-200
                                                                    ${l?"bg-yellow-400 z-20":"bg-cyan-500/20"}
                                                                `}),(0,s.jsx)("div",{className:`
                                                                    w-full h-full rounded-sm transition-all duration-200 relative z-10
                                                                    ${a?"bg-yellow-400 shadow-[0_0_12px_rgba(250,204,21,0.8)] scale-100 ring-2 ring-white/50 z-30":n?"bg-cyan-500 shadow-[0_0_8px_rgba(6,182,212,0.6)] scale-90":"bg-zinc-800/30"}
                                                                `})]},i)})]},e))]})}),(0,s.jsxs)("div",{className:"w-full xl:w-[380px] flex flex-col gap-2",style:{height:y},children:[(0,s.jsxs)("div",{className:"text-[10px] uppercase tracking-wider text-zinc-500 font-bold mb-1",children:["對比明細 (共 ",P.pairs.length," 組)"]}),(0,s.jsx)("div",{className:"flex flex-col gap-2 overflow-y-auto pr-2 custom-scrollbar",style:{maxHeight:w},children:P.pairs.map((e,t)=>(0,s.jsxs)("div",{onMouseEnter:()=>l(t),onMouseLeave:()=>l(null),className:`
                                                    border rounded-lg p-2 flex items-center justify-between group transition-all cursor-crosshair
                                                    ${r===t?"bg-yellow-400/10 border-yellow-400/50 translate-x-1":"bg-white/5 border-white/5 hover:border-white/20"}
                                                `,children:[(0,s.jsxs)("div",{className:"flex items-center gap-3",children:[(0,s.jsx)("div",{className:`
                                                        w-8 h-8 rounded flex items-center justify-center font-bold text-xs border transition-colors
                                                        ${r===t?"bg-yellow-400/20 text-yellow-400 border-yellow-400/30":"bg-cyan-500/10 text-cyan-400 border-cyan-500/20"}
                                                    `,children:e.stack}),(0,s.jsxs)("div",{className:"flex flex-col",children:[(0,s.jsxs)("div",{className:"flex items-center gap-1.5 leading-none",children:[(0,s.jsxs)("span",{className:"text-xs text-zinc-300",children:[e.floorLow,"F"]}),(0,s.jsx)(u.A,{className:`w-3 h-3 ${r===t?"text-yellow-400":"text-zinc-600"}`}),(0,s.jsxs)("span",{className:"text-xs text-zinc-100 font-bold",children:[e.floorHigh,"F"]})]}),(0,s.jsxs)("div",{className:"text-[10px] text-zinc-500 mt-1 flex gap-1 items-center",children:[(0,s.jsx)("span",{className:"opacity-70",children:e.dateLow||"N/A"}),(0,s.jsx)("span",{className:"opacity-30",children:"|"}),(0,s.jsx)("span",{className:"opacity-70",children:e.dateHigh||"N/A"})]})]})]}),(0,s.jsxs)("div",{className:"text-right",children:[(0,s.jsxs)("div",{className:"text-xs font-mono text-zinc-200",children:[e.priceLow,(0,s.jsx)("span",{className:"text-[10px] opacity-40 mx-1",children:"→"}),e.priceHigh]}),(0,s.jsxs)("div",{className:`text-[10px] font-bold ${r===t?"text-yellow-400":"text-cyan-400/80"}`,children:["+",e.diff," 萬/層"]})]})]},t))})]})]})]})})})]})}function g(e){let t=(e["移轉層次"]||"").match(/^([+-]?\d+)/);return t?parseInt(t[1],10):0}function b(e){let t=new Set;return e.forEach(e=>{let i=g(e);0!==i&&t.add(i)}),Array.from(t).sort((e,t)=>e-t)}function j(e,t){let i=e.reduce((e,t)=>e+(t["單價元平方公尺"]||0),0)/e.length,s=e.map(e=>e["單價元平方公尺"]||0).sort((e,t)=>e-t),n=s.length%2==0?(s[s.length/2-1]+s[s.length/2])/2:s[Math.floor(s.length/2)];return{unitType:t,avgPrice:i,minPrice:Math.min(...s),maxPrice:Math.max(...s),medianPrice:n,count:e.length,transactions:e}}function v(e){let t=new d(e),i=new Map;return e.forEach(e=>{if(!e)return;let s=t.resolve(e);s&&(i.has(s)||i.set(s,[]),i.get(s).push(e))}),i}function y(e,t,i){return e.filter(e=>{let s=g(e);return s>=t&&s<=i})}function N(){return Math.random().toString(36).substring(2,9)}function w(e,t="預設配置",i){let s=b(e),n=i||{start:Math.min(...s),end:Math.max(...s)},a=function(e){if(0===e.length)return[];let t=new d(e),i=new Set;e.forEach(e=>{let s=t.resolve(e);s&&i.add(s)});let s=Array.from(i),n=Math.ceil(Math.sqrt(s.length)),a=Math.ceil(s.length/n),r=Math.floor((30-(4*n-1))/2),l=Math.floor((30-(4*a-1))/2);return s.map((e,t)=>{let i=Math.floor(t/n);return{unitType:e,x:r+t%n*4,y:l+4*i,facing:"",roadFacing:!1,roadFacingDirection:"",adjacentToUnits:!1,facingOpenSpace:!1,openSpaceType:"",openSpaceFacingDirection:""}})}(e);return{id:N(),name:t,floorRange:n,positions:a,envTiles:[],zoom:1,compassDirection:0,gridSize:30}}function z(e,t,i=0,s=1){if(!t||0===t.length)return e;let n=[];e.forEach(e=>{n.push({type:"unit",id:e.unitType,rect:{left:e.x,right:e.x+3,top:e.y,bottom:e.y+3},data:e})}),t.forEach(e=>{n.push({type:"env",id:e.id,rect:{left:e.x,right:e.x+e.width,top:e.y,bottom:e.y+e.height},data:e})});let a={0:{up:"N",down:"S",left:"W",right:"E"},90:{up:"E",down:"W",left:"N",right:"S"},180:{up:"S",down:"N",left:"E",right:"W"},270:{up:"W",down:"E",left:"S",right:"N"}}[i];return e.map(e=>{let t={left:e.x,right:e.x+3,top:e.y,bottom:e.y+3},i=new Set,s=[],r=!1,l=!1;return["up","down","left","right"].forEach(c=>{let o=a[c],d=n.filter(i=>{if("unit"===i.type&&i.id===e.unitType)return!1;let s=!1,n=!1,a=1/0;return"up"===c?(s=Math.max(0,Math.min(t.right,i.rect.right)-Math.max(t.left,i.rect.left))>0,(n=i.rect.bottom<=t.top)&&(a=t.top-i.rect.bottom)):"down"===c?(s=Math.max(0,Math.min(t.right,i.rect.right)-Math.max(t.left,i.rect.left))>0,(n=i.rect.top>=t.bottom)&&(a=i.rect.top-t.bottom)):"left"===c?(s=Math.max(0,Math.min(t.bottom,i.rect.bottom)-Math.max(t.top,i.rect.top))>0,(n=i.rect.right<=t.left)&&(a=t.left-i.rect.right)):"right"===c&&(s=Math.max(0,Math.min(t.bottom,i.rect.bottom)-Math.max(t.top,i.rect.top))>0,(n=i.rect.left>=t.right)&&(a=i.rect.left-t.right)),!!s&&!!n&&a<=15&&(i._dist=a,!0)});for(let e of(d.sort((e,t)=>e._dist-t._dist),d)){if("unit"===e.type)break;if("env"===e.type){let t=e.data;if("road"===t.type)l=!0,i.add(o);else if(["park","school","plaza","river","tower","grave"].includes(t.type)){r=!0,s.some(e=>e.type===t.type&&e.direction===o)||s.push({type:t.type,direction:o});continue}}}}),{...e,roadFacing:l,roadFacingDirection:Array.from(i)[0]||"",roadFacingDirections:Array.from(i),facingOpenSpace:r,openSpaceType:s[0]?.type||"",openSpaceFacingDirection:s[0]?.direction||"",openSpaceFacingDirections:s}})}var k=i(33210),S=i(33024),_=i(63888),P=i(44071),A=i(67514),M=i(82482),C=i(51914),F=i(89823),$=i(67635),R=i(68459),T=i(14403),E=i(9199),D=i(89123),I=i(24538);let L=3;function O(e,t){return{unitType:e.unitType,col:e.x,row:e.y,facing:e.facing,roadFacing:e.roadFacing,roadFacingDirection:e.roadFacingDirection,roadFacingDirections:e.roadFacingDirections,adjacentToUnits:e.adjacentToUnits,facingOpenSpace:e.facingOpenSpace,openSpaceType:e.openSpaceType,openSpaceFacingDirection:e.openSpaceFacingDirection,openSpaceFacingDirections:e.openSpaceFacingDirections}}function B({position:e,result:t,isSelected:i,isDragging:n,cellSize:a,compassDirection:r=0,onClick:l,onDragStart:c}){let o={left:e.col*a,top:e.row*a,width:L*a,height:L*a},d={top:[],right:[],bottom:[],left:[]},x=["N","E","S","W"],m=(r||0)/90%4,h={N:"top",E:"right",S:"bottom",W:"left"};["top","right","bottom","left"].forEach((e,t)=>{h[x[(m+t)%4]]=e});let p=(e,t,i)=>{e&&["N","S","E","W"].includes(e)&&d[h[e]].push({text:t,color:i})};if(e.facing&&p(e.facing[0],"朝","violet"),e.roadFacing&&(e.roadFacingDirections&&e.roadFacingDirections.length>0?e.roadFacingDirections.forEach(e=>p(e,"路","orange")):p(e.roadFacingDirection,"路","orange")),e.facingOpenSpace){let t={school:"校",plaza:"廣",park:"園",river:"河",tower:"塔",grave:"墓"},i={school:"green",plaza:"green",park:"green",river:"cyan",tower:"red",grave:"zinc"};if(e.openSpaceFacingDirections&&e.openSpaceFacingDirections.length>0)e.openSpaceFacingDirections.forEach(e=>{let s=e.type;p(e.direction,t[s]||"空",i[s]||"green")});else{let s=e.openSpaceType||"park";p(e.openSpaceFacingDirection,t[s]||"空",i[s]||"green")}}let u=(e,t)=>0===e.length?null:(0,s.jsx)("div",{className:`absolute flex gap-0.5 ${t}`,children:e.map((e,t)=>(0,s.jsx)("div",{className:`
                            text-white text-[9px] px-1 py-0.5 rounded shadow-sm font-bold min-w-[20px] text-center
                            ${"violet"===e.color?"bg-violet-500":""}
                            ${"orange"===e.color?"bg-orange-500":""}
                            ${"blue"===e.color?"bg-blue-500":""}
                            ${"blue"===e.color?"bg-blue-500":""}
                            ${"cyan"===e.color?"bg-cyan-600":""}
                            ${"red"===e.color?"bg-red-600":""}
                            ${"zinc"===e.color?"bg-zinc-600":""}
                            ${"green"===e.color?"bg-emerald-600":""}
                        `,children:e.text},t))});return(0,s.jsx)("div",{className:`
                absolute cursor-grab active:cursor-grabbing select-none transition-all duration-100 group
                ${n?"z-50 opacity-70 scale-105":"z-10"}
            `,style:o,onMouseDown:t=>c(e.unitType,t),onDragOver:e=>{e.preventDefault(),e.dataTransfer.dropEffect="copy"},children:(0,s.jsxs)("div",{className:`
                    relative w-full h-full rounded-lg border-2 transition-all flex flex-col items-center justify-center bg-zinc-900/90
                    ${i?"bg-cyan-900/30 border-cyan-400 shadow-[0_0_15px_rgba(34,211,238,0.3)]":t?"border-white/20 hover:border-cyan-400/50":"border-white/10 hover:border-white/30"}
                `,onClick:l,children:[u(d.top,"-top-2 left-1/2 -translate-x-1/2 -translate-y-full flex-row"),u(d.bottom,"-bottom-2 left-1/2 -translate-x-1/2 translate-y-full flex-row"),u(d.right,"-right-2 top-1/2 -translate-y-1/2 translate-x-full flex-col"),u(d.left,"-left-2 top-1/2 -translate-y-1/2 -translate-x-full flex-col"),(0,s.jsx)("div",{className:"text-sm font-bold text-zinc-100 z-10",children:e.unitType}),t&&(0,s.jsxs)(s.Fragment,{children:[(0,s.jsx)("div",{className:"text-xs font-mono text-cyan-400 mt-0.5",children:t.avgPrice.toFixed(1)}),(0,s.jsxs)("div",{className:"text-[10px] text-zinc-500",children:[t.count," 筆"]})]})]})})}function Z({tile:e,cellSize:t,isSelected:i,onMouseDown:n,onResizeStart:a,onRemove:r}){let l={left:e.x*t,top:e.y*t,width:e.width*t,height:e.height*t},c={road:"bg-zinc-600/50 border-zinc-500",park:"bg-emerald-600/30 border-emerald-500",school:"bg-indigo-600/30 border-indigo-500",plaza:"bg-amber-600/30 border-amber-500",river:"bg-cyan-600/30 border-cyan-500",tower:"bg-red-600/30 border-red-500",grave:"bg-zinc-600/30 border-zinc-500",custom:"bg-zinc-700/50 border-zinc-600"};return(0,s.jsxs)("div",{className:`
                absolute transition-all duration-75 group select-none
                ${c[e.type]||c.custom}
                ${i?"border-2 border-white z-20":"border border-dashed z-0 opacity-80 hover:opacity-100"}
            `,style:l,onMouseDown:n,children:[r&&(0,s.jsx)("button",{onMouseDown:e=>e.stopPropagation(),onClick:e=>{e.stopPropagation(),r()},className:"absolute -top-2 -right-2 w-4 h-4 rounded-full bg-black/70 border border-white/20 text-white/80 hover:text-white hover:border-white/60 flex items-center justify-center text-[10px]","aria-label":"移除元件",children:(0,s.jsx)(k.A,{className:"w-3 h-3"})}),(0,s.jsx)("div",{className:"w-full h-full flex items-center justify-center text-xs text-white/80 font-medium overflow-hidden",children:e.label||e.type}),(0,s.jsx)(s.Fragment,{children:(0,s.jsx)("div",{className:"absolute bottom-0 right-0 w-3 h-3 bg-white/50 cursor-se-resize hover:bg-white",onMouseDown:e=>{e.stopPropagation(),a(e,"se")}})})]})}function W({selectedUnits:e,positions:t,compassDirection:i=0,onBatchUpdate:a,onClear:r}){let l=0===e.length?"empty":1===e.length?"inspector":"batch",c="inspector"===l?t.find(t=>t.unitType===e[0]):null,o=(0,n.useMemo)(()=>{if(0===t.length)return null;let e=Math.min(...t.map(e=>e.col)),i=Math.max(...t.map(e=>e.col+L)),s=Math.min(...t.map(e=>e.row)),n=Math.max(...t.map(e=>e.row+L));return{minCol:e,maxCol:i,minRow:s,maxRow:n,centerX:(e+i)/2,centerY:(s+n)/2}},[t]),d=(0,n.useMemo)(()=>{if(!c||!o)return"";let e=c.col+L/2,t=c.row+L/2,s=e-o.centerX,n=t-o.centerY,a=.25>=Math.abs(s)?"":s>0?"E":"W",r=.25>=Math.abs(n)?"":n>0?"S":"N";if(!a&&!r)return"C";let l=`${r}${a}`,d={N:0,NE:45,E:90,SE:135,S:180,SW:225,W:270,NW:315},x=d[l];if(void 0===x)return l;let m=(x+i)%360;return Object.keys(d).find(e=>d[e]===m)||l},[c,o,i]),x=(0,n.useMemo)(()=>d?({N:"北",S:"南",E:"東",W:"西",NE:"東北",NW:"西北",SE:"東南",SW:"西南",C:"中央"})[d]||d:"—",[d]);return(0,s.jsxs)("div",{className:"bg-zinc-900/50 rounded-lg border border-white/10 p-4 h-full flex flex-col gap-4",children:[(0,s.jsxs)("div",{className:"flex items-center justify-between border-b border-white/5 pb-2",children:[(0,s.jsxs)("div",{className:"text-sm font-bold text-zinc-100",children:["empty"===l&&"環境標籤與設定","inspector"===l&&(0,s.jsxs)("span",{className:"text-cyan-400",children:["檢視戶型: ",c?.unitType]}),"batch"===l&&(0,s.jsxs)("span",{className:"text-violet-400",children:["批量設定 (",e.length,")"]})]}),"empty"!==l&&(0,s.jsx)("button",{onClick:r,className:"text-zinc-500 hover:text-zinc-300",children:(0,s.jsx)(k.A,{className:"w-4 h-4"})})]}),"inspector"===l&&c&&(0,s.jsxs)("div",{className:"space-y-4",children:[(0,s.jsxs)("div",{className:"text-xs text-zinc-400 space-y-1",children:[(0,s.jsxs)("div",{className:"flex justify-between",children:[(0,s.jsx)("span",{children:"座標:"}),(0,s.jsxs)("span",{className:"font-mono text-zinc-200",children:["(",c.col,", ",c.row,")"]})]}),(0,s.jsxs)("div",{className:"flex justify-between",children:[(0,s.jsx)("span",{children:"相對朝向:"}),(0,s.jsx)("span",{className:"font-medium text-zinc-200",children:x})]})]}),(0,s.jsxs)("div",{children:[(0,s.jsxs)("div",{className:"text-xs font-medium text-zinc-300 mb-2 flex justify-between",children:[(0,s.jsx)("span",{children:"臨路偵測 (Roads)"}),(0,s.jsx)("span",{className:"text-[10px] text-zinc-500",children:c.roadFacing?"Yes":"No"})]}),(0,s.jsx)("div",{className:"flex gap-2 flex-wrap",children:c.roadFacingDirections&&c.roadFacingDirections.length>0?c.roadFacingDirections.map(e=>(0,s.jsxs)("span",{className:"px-2 py-0.5 rounded bg-orange-500/20 text-orange-300 text-xs border border-orange-500/30",children:["N"===e?"北":"S"===e?"南":"E"===e?"東":"W"===e?"西":e,"側臨路"]},e)):(0,s.jsx)("span",{className:"text-xs text-zinc-600 px-2",children:"無臨路"})})]}),(0,s.jsxs)("div",{children:[(0,s.jsx)("div",{className:"text-xs font-medium text-zinc-300 mb-2",children:"周邊設施 (Amenities)"}),(0,s.jsx)("div",{className:"flex gap-2 flex-wrap",children:c.openSpaceFacingDirections&&c.openSpaceFacingDirections.length>0?c.openSpaceFacingDirections.map((e,t)=>(0,s.jsxs)("span",{className:"px-2 py-0.5 rounded bg-emerald-500/20 text-emerald-300 text-xs border border-emerald-500/30 flex items-center gap-1",children:[(0,s.jsx)("span",{children:"N"===e.direction?"北":"S"===e.direction?"南":"E"===e.direction?"東":"W"===e.direction?"西":e.direction}),(0,s.jsx)("span",{className:"opacity-50",children:"|"}),(0,s.jsx)("span",{className:"tower"===e.type?"text-red-400":"grave"===e.type?"text-zinc-400":"river"===e.type?"text-cyan-400":"park"===e.type?"text-emerald-400":"school"===e.type?"text-indigo-400":"plaza"===e.type?"text-amber-400":"",children:"park"===e.type?"公園":"school"===e.type?"學校":"plaza"===e.type?"廣場":"river"===e.type?"河景":"tower"===e.type?"電塔":"grave"===e.type?"墳墓":e.type})]},`${e.type}-${e.direction}-${t}`)):(0,s.jsx)("span",{className:"text-xs text-zinc-600 px-2",children:"無偵測到設施"})})]})]}),"batch"===l&&(0,s.jsxs)("div",{className:"space-y-4",children:[(0,s.jsxs)("div",{className:"p-2 bg-violet-900/20 border border-violet-500/30 rounded text-xs text-violet-200",children:["正在批量修改 ",e.length," 個單位"]}),(0,s.jsxs)("div",{children:[(0,s.jsx)("div",{className:"text-xs font-medium text-zinc-300 mb-2",children:"統一朝向"}),(0,s.jsx)("div",{className:"grid grid-cols-3 gap-1",children:[{value:"",label:"清除"},{value:"N",label:"北"},{value:"S",label:"南"},{value:"E",label:"東"},{value:"W",label:"西"},{value:"NE",label:"東北"},{value:"NW",label:"西北"},{value:"SE",label:"東南"},{value:"SW",label:"西南"}].map(e=>(0,s.jsx)("button",{onClick:()=>a({facing:e.value}),className:"text-xs py-1 rounded bg-zinc-800 text-zinc-400 hover:bg-violet-600 hover:text-white transition",children:e.label},e.value))})]})]}),(0,s.jsx)("div",{className:"h-px bg-white/10 my-2"}),(0,s.jsxs)("div",{className:"flex-1",children:[(0,s.jsxs)("div",{className:"text-xs font-bold text-zinc-400 mb-3 uppercase tracking-wider flex items-center gap-2",children:[(0,s.jsx)(S.A,{className:"w-3 h-3"}),"環境標籤 (拖曳使用)"]}),(0,s.jsx)("div",{className:"grid grid-cols-2 gap-2",children:[{id:"road",label:"臨路",color:"bg-zinc-700",border:"border-zinc-500"},{id:"park",label:"公園",color:"bg-green-800",border:"border-green-600"},{id:"school",label:"學校",color:"bg-blue-900",border:"border-blue-700"},{id:"plaza",label:"廣場",color:"bg-violet-900",border:"border-violet-700"},{id:"river",label:"河景",color:"bg-cyan-800",border:"border-cyan-600"},{id:"tower",label:"電塔",color:"bg-red-900",border:"border-red-700"},{id:"grave",label:"墳墓",color:"bg-zinc-800",border:"border-zinc-600"}].map(e=>(0,s.jsx)("div",{draggable:!0,onDragStart:t=>{var i;return i=e.id,void(t.dataTransfer.setData("env-type",i),t.dataTransfer.setData("application/json",JSON.stringify({type:"env",envType:i})),t.dataTransfer.effectAllowed="copy")},className:`
                                ${e.color} ${e.border}
                                text-white text-xs font-bold py-2 px-3 rounded cursor-grab active:cursor-grabbing
                                border shadow-sm hover:brightness-110 flex items-center justify-center
                            `,children:e.label},e.id))})]})]})}function U({direction:e,onChange:t}){return(0,s.jsxs)("div",{className:"absolute top-8 right-8 z-50 flex flex-col items-center",children:[(0,s.jsx)("div",{className:"relative",children:(0,s.jsx)("div",{className:"w-16 h-16 bg-zinc-900/90 rounded-full border-2 border-zinc-700 shadow-xl flex items-center justify-center cursor-pointer hover:border-zinc-500 transition-colors z-10 relative",onClick:()=>t((e+90)%360),children:(0,s.jsxs)(m.P.div,{animate:{rotate:-e},transition:{type:"spring",stiffness:150,damping:15},className:"w-full h-full flex items-center justify-center relative",children:[(0,s.jsx)("div",{className:"absolute -top-1 left-1/2 -translate-x-1/2 w-0 h-0 border-l-[5px] border-r-[5px] border-b-[7px] border-transparent border-b-red-500"}),(0,s.jsx)("div",{className:"absolute w-1 h-3/5 bg-gradient-to-b from-red-500 to-zinc-600 rounded-full"}),(0,s.jsx)("div",{className:"absolute w-3 h-3 bg-white rounded-full border-2 border-zinc-900 z-20"})]})})}),(0,s.jsx)("div",{className:"mt-2 flex gap-1 bg-black/50 p-1 rounded-full border border-white/10",children:[{label:"北",abbr:"N",value:0},{label:"東",abbr:"E",value:90},{label:"南",abbr:"S",value:180},{label:"西",abbr:"W",value:270}].map(i=>(0,s.jsx)("button",{onClick:e=>{e.stopPropagation(),t(i.value)},className:`
                            text-[10px] px-2.5 py-1 rounded-full font-bold transition-all min-w-[40px]
                            ${e===i.value?"bg-cyan-500 text-white":"bg-zinc-800 text-zinc-400 hover:bg-zinc-700 hover:text-white"}
                        `,children:(0,s.jsxs)("span",{className:"flex flex-col leading-none",children:[(0,s.jsx)("span",{children:i.label}),(0,s.jsx)("span",{className:"text-[9px] opacity-70",children:i.abbr})]})},i.value))}),(0,s.jsxs)("div",{className:"mt-6 text-[10px] text-zinc-500 font-mono bg-black/50 px-2 py-1 rounded",children:["上方為 ",0===e?"北":90===e?"東":180===e?"南":"西"]})]})}function H({positions:e,envTiles:t=[],results:i,selectedUnits:a,zoom:r,compassDirection:l=0,gridSize:c=30,onPositionsChange:o,onEnvTilesChange:d,onUnitClick:m,onZoomChange:h,onCompassChange:p,onGridSizeChange:u,isAnalyzeMode:f=!1}){let[g,b]=(0,n.useState)(null),[j,v]=(0,n.useState)(null),[y,N]=(0,n.useState)({x:0,y:0}),[w,z]=(0,n.useState)(null),[k,S]=(0,n.useState)(null),[_,P]=(0,n.useState)(null),[A,M]=(0,n.useState)(null),C=n.useRef(null),F=n.useRef(null),[$,R]=(0,n.useState)({width:0,height:0}),T=Math.min(Math.max(0,($.width||1e3)-80),Math.max(0,($.height||1e3)-80))/c,E=T>0?T:1e3/c,D=c*E,I=c*E;n.useLayoutEffect(()=>{if(!F.current)return;let e=F.current,t=()=>{let t=e.getBoundingClientRect();R({width:t.width,height:t.height})};t();let i=new ResizeObserver(t);return i.observe(e),()=>i.disconnect()},[]);let O=(0,n.useCallback)((t,i,s)=>e.find(e=>e.unitType!==s&&t>=e.col&&t<e.col+L&&i>=e.row&&i<e.row+L),[e]),W=(0,n.useCallback)((e,t,i=L,s=L)=>e>=0&&t>=0&&e+i<=c&&t+s<=c,[c,c]),H=(0,n.useCallback)((i,s,n)=>{if(f)return;n.preventDefault(),n.stopPropagation();let a="unit"===s?e.find(e=>e.unitType===i):t.find(e=>e.id===i);if(!a||!C.current)return;let r=C.current.getBoundingClientRect(),l="unit"===s?a.col:a.x,c="unit"===s?a.row:a.y,o=l*E,d=c*E;b(i),v(s),N({x:n.clientX-r.left-o,y:n.clientY-r.top-d}),z({col:l,row:c})},[e,t,f,E]),q=(0,n.useCallback)((e,i)=>{if(f)return;i.preventDefault(),i.stopPropagation();let s=t.find(t=>t.id===e);s&&(P(e),M({x:i.clientX,y:i.clientY,w:s.width,h:s.height}))},[t,f]),K=(0,n.useCallback)(i=>{if(C.current){if(_&&A&&d){let e=i.clientX-A.x,s=i.clientY-A.y,n=Math.round(e/E),a=Math.round(s/E),r=Math.max(1,A.w+n),l=Math.max(1,A.h+a),c=t?.find(e=>e.id===_);c&&(c.width!==r||c.height!==l)&&d(t.map(e=>e.id===_?{...e,width:r,height:l}:e));return}if(g&&y){let s=C.current.getBoundingClientRect(),n=i.clientX-s.left-y.x,a=i.clientY-s.top-y.y,r=Math.round(n/E),o=Math.round(a/E),d="unit"===j?L:t?.find(e=>e.id===g)?.width||1,x="unit"===j?L:t?.find(e=>e.id===g)?.height||1;if(z({col:r=Math.max(0,Math.min(r,c-d)),row:o=Math.max(0,Math.min(o,c-x))}),"env"===j&&void 0!==l){let i=t?.find(e=>e.id===g);if(i){let t=r,s=r+i.width,n=o,a=o+i.height,c=t+i.width/2,d=n+i.height/2,x=null;for(let r of e){let e=r.col,o=r.col+L,m=r.row,h=r.row+L,p=e+L/2,u=m+L/2,f=Math.max(0,m-a,n-h);if(1>=Math.max(0,e-s,t-o)&&f<=1){let s=function(e,t,i){let s,n=e.x,a=e.x+e.width,r=e.y,l=e.y+e.height,c=t.x,o=t.x+t.width,d=t.y,x=t.y+t.height,m=Math.max(0,Math.min(a,o)-Math.max(n,c)),h=Math.max(0,Math.min(l,x)-Math.max(r,d));if(m>h){let i=r+e.height/2;s=d+t.height/2<i?"up":"down"}else if(h>m){let i=n+e.width/2;s=c+t.width/2<i?"left":"right"}else{let i=n+e.width/2,a=r+e.height/2,l=c+t.width/2,o=d+t.height/2,x=l-i,m=o-a;s=Math.abs(x)>=Math.abs(m)?x>0?"right":"left":m>0?"down":"up"}return({0:{up:"N",down:"S",left:"W",right:"E"},90:{up:"E",down:"W",left:"N",right:"S"},180:{up:"S",down:"N",left:"E",right:"W"},270:{up:"W",down:"E",left:"S",right:"N"}})[i][s]}({x:e,y:m,width:L,height:L},{x:t,y:n,width:i.width,height:i.height},l);x={targetUnit:r.unitType,direction:s,sourceTileId:g,lineStart:{x:p*E,y:u*E},lineEnd:{x:c*E,y:d*E}};break}}S(x)}}else S(null)}else S(null)}},[g,j,y,E,_,A,d,o,t,c,c,l,e]),X=(0,n.useCallback)(()=>{if(_){P(null),M(null),S(null);return}if(g&&w&&j){if("unit"===j){let t=O(w.col,w.row,g);if(t){let i=e.find(e=>e.unitType===g);o(e.map(e=>e.unitType===g?{...e,col:t.col,row:t.row}:e.unitType===t.unitType?{...e,col:i.col,row:i.row}:e))}else W(w.col,w.row)&&o(e.map(e=>e.unitType===g?{...e,col:w.col,row:w.row}:e))}else if("env"===j&&d&&t){let e=t.find(e=>e.id===g);e&&W(w.col,w.row,e.width,e.height)&&d(t.map(e=>e.id===g?{...e,x:w.col,y:w.row}:e))}}b(null),v(null),z(null),S(null)},[g,w,j,O,W,o,e,d,t,_]),Y=(0,n.useCallback)(()=>{g&&(b(null),v(null),z(null),S(null))},[g]);w&&g&&"unit"===j&&O(w.col,w.row,g);let G=(0,n.useCallback)(e=>{e.preventDefault();let i=e.dataTransfer.getData("env-type");if(!i)try{let t=e.dataTransfer.getData("application/json");if(t){let e=JSON.parse(t);"env"===e.type&&(i=e.envType)}}catch(e){}if(i&&d&&C.current){let s=C.current.getBoundingClientRect(),n=e.clientX-s.left,a=e.clientY-s.top,r=Math.min(c-2,Math.max(0,Math.floor(n/E))),l=Math.min(c-2,Math.max(0,Math.floor(a/E)));d([...t,{id:`env-${Date.now()}`,type:i,x:r,y:l,width:"road"===i?4:3,height:2,label:{road:"臨路",park:"公園",school:"學校",plaza:"廣場",river:"河景",tower:"電塔",grave:"墳墓"}[i]||"設施"}])}},[d,E,t,c,c]),[V,Q]=(0,n.useState)(null),J=(0,n.useCallback)(e=>{if(!C.current||f||e.target.closest(".grid-unit"))return;let t=C.current.getBoundingClientRect(),i=e.clientX-t.left,s=e.clientY-t.top;Q({start:{x:i,y:s},end:{x:i,y:s}})},[f]),ee=(0,n.useCallback)(e=>{if((g||_)&&C.current)return void K(e);if(V&&C.current){let t=C.current.getBoundingClientRect(),i=e.clientX-t.left,s=e.clientY-t.top;Q(e=>e?{...e,end:{x:i,y:s}}:null)}},[g,_,K,V]),et=(0,n.useCallback)(t=>{if(g||_)return void X();if(V){let i=Math.min(V.start.x,V.end.x),s=Math.max(V.start.x,V.end.x),n=Math.min(V.start.y,V.end.y),r=Math.max(V.start.y,V.end.y);if(Math.abs(s-i)>5||Math.abs(r-n)>5){let l=e.filter(e=>{let t=e.col*E,a=e.row*E,l=t+L*E,c=a+L*E;return i<l&&s>t&&n<c&&r>a}).map(e=>e.unitType);t.shiftKey||t.ctrlKey||t.metaKey?m(null,{...t,type:"box-select",units:Array.from(new Set([...a,...l]))}):m(null,{...t,type:"box-select",units:l})}Q(null)}},[g,_,X,V,e,E,a,m]),ei=(0,n.useCallback)(()=>{Y(),Q(null)},[Y]);return(0,s.jsxs)("div",{className:"space-y-2 h-full flex flex-col",children:[(0,s.jsx)("div",{className:"flex items-center gap-2 justify-end px-2 pb-2 border-b border-white/5 bg-zinc-900/50 pt-2",children:u&&(0,s.jsxs)(s.Fragment,{children:[(0,s.jsxs)("span",{className:"text-xs text-zinc-500",children:["網格數: ",c]}),(0,s.jsx)("input",{type:"range",min:"20",max:"80",step:"5",value:c,onChange:e=>u(Number(e.target.value)),className:"w-24 accent-violet-500 cursor-pointer",title:"調整網格數量 (同時調整元件顯示大小)"})]})}),(0,s.jsxs)("div",{ref:F,className:"flex-1 overflow-hidden bg-zinc-950/80 rounded-lg border border-white/10 relative max-h-[600px]",children:[p&&(0,s.jsx)(U,{direction:l||0,onChange:p}),(0,s.jsx)("div",{className:"flex justify-center items-center min-w-full min-h-full p-10",onMouseDown:J,onMouseMove:ee,onMouseUp:et,onMouseLeave:ei,children:(0,s.jsxs)("div",{ref:C,className:"relative bg-zinc-900 border border-zinc-700 shadow-2xl transition-all duration-300",style:{width:D,height:I,backgroundSize:`${E}px ${E}px`,backgroundImage:`
                                linear-gradient(to right, rgba(255, 255, 255, 0.05) 1px, transparent 1px),
                                linear-gradient(to bottom, rgba(255, 255, 255, 0.05) 1px, transparent 1px)
                            `},onDragOver:e=>e.preventDefault(),onDrop:G,children:[k&&(0,s.jsxs)("svg",{className:"absolute inset-0 pointer-events-none z-50 overflow-visible",children:[(0,s.jsx)("line",{x1:k.lineStart.x,y1:k.lineStart.y,x2:k.lineEnd.x,y2:k.lineEnd.y,stroke:"#ec4899",strokeWidth:"2",strokeDasharray:"4",className:"animate-pulse"}),(0,s.jsx)("circle",{cx:k.lineStart.x,cy:k.lineStart.y,r:"4",fill:"#ec4899"}),(0,s.jsx)("text",{x:(k.lineStart.x+k.lineEnd.x)/2,y:(k.lineStart.y+k.lineEnd.y)/2-10,fill:"#ec4899",fontSize:"12",fontWeight:"bold",textAnchor:"middle",className:"drop-shadow-md",style:{textShadow:"0 1px 2px rgba(0,0,0,0.8)"},children:k.direction})]}),(0,s.jsxs)("div",{className:"absolute inset-0 pointer-events-none opacity-20",children:[Array.from({length:c+1}).map((e,t)=>(0,s.jsx)("div",{className:"absolute top-0 bottom-0 border-l border-white/10",style:{left:t*E}},`v-${t}`)),Array.from({length:c+1}).map((e,t)=>(0,s.jsx)("div",{className:"absolute left-0 right-0 border-t border-white/10",style:{top:t*E}},`h-${t}`))]}),V&&(0,s.jsx)("div",{className:"absolute bg-cyan-500/10 border border-cyan-400/50 pointer-events-none z-50",style:{left:Math.min(V.start.x,V.end.x),top:Math.min(V.start.y,V.end.y),width:Math.abs(V.end.x-V.start.x),height:Math.abs(V.end.y-V.start.y)}}),w&&g&&(0,s.jsx)("div",{className:"absolute bg-white/10 border border-white/30 z-40 transition-all duration-75",style:{left:w.col*E,top:w.row*E,width:("unit"===j?L:t?.find(e=>e.id===g)?.width||1)*E,height:("unit"===j?L:t?.find(e=>e.id===g)?.height||1)*E}}),(0,s.jsx)(x.N,{children:t?.map(e=>(0,s.jsx)(Z,{tile:e,cellSize:E,isSelected:!1,onMouseDown:t=>H(e.id,"env",t),onResizeStart:(t,i)=>q(e.id,t),onRemove:()=>{d&&t&&d(t.filter(t=>t.id!==e.id))}},e.id))}),(0,s.jsx)(x.N,{children:e.map(e=>{let t=i?.find(t=>t.unitType===e.unitType);return(0,s.jsx)(B,{position:e,result:t,isSelected:a.includes(e.unitType),isDragging:g===e.unitType,cellSize:E,compassDirection:l,onClick:t=>m(e.unitType,t),onDragStart:(e,t)=>H(e,"unit",t)},e.unitType)})})]})})]})]})}function q({comparison:e,onClose:t}){return(0,s.jsxs)(m.P.div,{initial:{opacity:0,y:20},animate:{opacity:1,y:0},exit:{opacity:0,y:20},className:"bg-zinc-900/70 border border-cyan-500/30 rounded-xl p-4 mb-4 backdrop-blur-sm",children:[(0,s.jsxs)("div",{className:"flex items-center justify-between mb-3",children:[(0,s.jsxs)("div",{className:"flex items-center gap-2",children:[(0,s.jsx)(_.A,{className:"w-4 h-4 text-cyan-400"}),(0,s.jsx)("h4",{className:"text-sm font-bold text-zinc-100",children:"戶型比對"})]}),(0,s.jsx)("button",{onClick:t,className:"w-6 h-6 rounded hover:bg-white/10 flex items-center justify-center transition",children:(0,s.jsx)(k.A,{className:"w-4 h-4 text-zinc-400"})})]}),(0,s.jsxs)("div",{className:"grid grid-cols-2 gap-4",children:[(0,s.jsxs)("div",{className:"bg-black/30 rounded-lg p-3 border border-white/5",children:[(0,s.jsx)("div",{className:"text-lg font-bold text-cyan-400 mb-2",children:e.unitType1}),(0,s.jsxs)("div",{className:"space-y-1 text-xs",children:[(0,s.jsxs)("div",{className:"flex justify-between",children:[(0,s.jsx)("span",{className:"text-zinc-500",children:"平均單價"}),(0,s.jsx)("span",{className:"text-zinc-200 font-mono",children:e.stats1.avgPrice.toFixed(2)})]}),(0,s.jsxs)("div",{className:"flex justify-between",children:[(0,s.jsx)("span",{className:"text-zinc-500",children:"最低價"}),(0,s.jsx)("span",{className:"text-zinc-200 font-mono",children:e.stats1.minPrice.toFixed(2)})]}),(0,s.jsxs)("div",{className:"flex justify-between",children:[(0,s.jsx)("span",{className:"text-zinc-500",children:"最高價"}),(0,s.jsx)("span",{className:"text-zinc-200 font-mono",children:e.stats1.maxPrice.toFixed(2)})]}),(0,s.jsxs)("div",{className:"flex justify-between",children:[(0,s.jsx)("span",{className:"text-zinc-500",children:"中位數"}),(0,s.jsx)("span",{className:"text-zinc-200 font-mono",children:e.stats1.medianPrice.toFixed(2)})]}),(0,s.jsxs)("div",{className:"flex justify-between",children:[(0,s.jsx)("span",{className:"text-zinc-500",children:"樣本數"}),(0,s.jsxs)("span",{className:"text-zinc-200",children:[e.stats1.count," 筆"]})]})]})]}),(0,s.jsxs)("div",{className:"bg-black/30 rounded-lg p-3 border border-white/5",children:[(0,s.jsx)("div",{className:"text-lg font-bold text-violet-400 mb-2",children:e.unitType2}),(0,s.jsxs)("div",{className:"space-y-1 text-xs",children:[(0,s.jsxs)("div",{className:"flex justify-between",children:[(0,s.jsx)("span",{className:"text-zinc-500",children:"平均單價"}),(0,s.jsx)("span",{className:"text-zinc-200 font-mono",children:e.stats2.avgPrice.toFixed(2)})]}),(0,s.jsxs)("div",{className:"flex justify-between",children:[(0,s.jsx)("span",{className:"text-zinc-500",children:"最低價"}),(0,s.jsx)("span",{className:"text-zinc-200 font-mono",children:e.stats2.minPrice.toFixed(2)})]}),(0,s.jsxs)("div",{className:"flex justify-between",children:[(0,s.jsx)("span",{className:"text-zinc-500",children:"最高價"}),(0,s.jsx)("span",{className:"text-zinc-200 font-mono",children:e.stats2.maxPrice.toFixed(2)})]}),(0,s.jsxs)("div",{className:"flex justify-between",children:[(0,s.jsx)("span",{className:"text-zinc-500",children:"中位數"}),(0,s.jsx)("span",{className:"text-zinc-200 font-mono",children:e.stats2.medianPrice.toFixed(2)})]}),(0,s.jsxs)("div",{className:"flex justify-between",children:[(0,s.jsx)("span",{className:"text-zinc-500",children:"樣本數"}),(0,s.jsxs)("span",{className:"text-zinc-200",children:[e.stats2.count," 筆"]})]})]})]})]}),(0,s.jsx)("div",{className:"mt-3 bg-gradient-to-r from-cyan-500/10 to-violet-500/10 rounded-lg p-3 border border-white/10",children:(0,s.jsxs)("div",{className:"flex items-center justify-between",children:[(0,s.jsx)("span",{className:"text-sm text-zinc-400",children:"價差"}),(0,s.jsxs)("div",{className:"flex items-center gap-2",children:[e.priceDiff>0?(0,s.jsx)(P.A,{className:"w-4 h-4 text-green-400"}):e.priceDiff<0?(0,s.jsx)(A.A,{className:"w-4 h-4 text-red-400"}):(0,s.jsx)(M.A,{className:"w-4 h-4 text-zinc-400"}),(0,s.jsxs)("span",{className:`text-lg font-bold font-mono ${e.priceDiff>0?"text-green-400":e.priceDiff<0?"text-red-400":"text-zinc-400"}`,children:[e.priceDiff>0?"+":"",e.priceDiff.toFixed(2)," 萬/坪"]}),(0,s.jsxs)("span",{className:"text-sm text-zinc-500",children:["(",e.diffPercent>0?"+":"",e.diffPercent.toFixed(1),"%)"]})]})]})})]})}function K({transactions:e,project:t}){let[i,a]=(0,n.useState)("config"),[r,l]=(0,n.useState)([]),[c,o]=(0,n.useState)(null),[p,u]=(0,n.useState)([]),[f,k]=(0,n.useState)("per-floor"),[S,_]=(0,n.useState)(null),[P,A]=(0,n.useState)(null),[M,B]=(0,n.useState)(null),Z=n.useRef(null),U=(0,n.useMemo)(()=>b(e),[e]);(0,n.useEffect)(()=>{if(0===r.length&&e.length>0&&U.length>0){let t=w(e,"預設配置（全部樓層）");l([t]),o(t.id)}},[e,U,r.length]),(0,n.useEffect)(()=>{U.length>0&&null===S&&_(U[0])},[U,S]);let K=r.find(e=>e.id===c),X=(0,n.useMemo)(()=>K?K.positions.map(e=>O(e,36)):[],[K]),Y=(0,n.useMemo)(()=>{if(!K||"analyze"!==i)return[];let t=K.positions;if("vertical-avg"===f)return function(e,t,i,s){let n=y(e,t,i);if(0===n.length)return[];let a=v(n),r=new d(n),l=new Map;n.forEach(e=>{let t=r.resolve(e);t&&(l.has(t)||l.set(t,new Set),l.get(t).add(g(e)))});let c=[];return s.forEach(e=>{let n=a.get(e.unitType)||[];if(0===n.length)return;let r=j(n,e.unitType),o=l.get(e.unitType)||new Set,d=[];s.forEach(t=>{if(t.unitType===e.unitType)return;let i=a.get(t.unitType)||[];if(0===i.length)return;let s=j(i,t.unitType),n=r.avgPrice-s.avgPrice,l=s.avgPrice>0?n/s.avgPrice*100:0;d.push({compareWith:t.unitType,diff:n,diffPercent:l})}),c.push({...r,floorRange:{start:t,end:i},floorCount:o.size,priceDiffs:d,position:e})}),c}(e,K.floorRange.start,K.floorRange.end,t);if(null!==S){let i=e.filter(e=>g(e)===S);if(0===i.length)return[];let s=v(i),n=[];return t.forEach(e=>{let i=s.get(e.unitType)||[];if(0===i.length)return;let a=j(i,e.unitType),r=[];t.forEach(t=>{if(t.unitType===e.unitType)return;let i=s.get(t.unitType)||[];if(0===i.length)return;let n=j(i,t.unitType),l=a.avgPrice-n.avgPrice,c=n.avgPrice>0?l/n.avgPrice*100:0;r.push({compareWith:t.unitType,diff:l,diffPercent:c})}),n.push({...a,floor:S,priceDiffs:r,position:e})}),n}return[]},[e,K,i,f,S]),G=e=>{if(!K)return;let t=z(e.map(e=>({unitType:e.unitType,x:e.col,y:e.row,facing:e.facing,roadFacing:e.roadFacing,roadFacingDirection:e.roadFacingDirection,adjacentToUnits:e.adjacentToUnits,facingOpenSpace:e.facingOpenSpace,openSpaceType:e.openSpaceType,openSpaceFacingDirection:e.openSpaceFacingDirection,openSpaceFacingDirections:e.openSpaceFacingDirections,roadFacingDirections:e.roadFacingDirections})),K.envTiles||[],K.compassDirection||0,1);l(r.map(e=>e.id===c?{...e,positions:t}:e))},V=e=>{},Q=e=>{if(!K)return;let t=function(e,t,i){if(0===e.length)return{positions:e,envTiles:t||[]};let s=Math.min(...e.map(e=>e.x)),n=Math.max(...e.map(e=>e.x+L)),a=Math.min(...e.map(e=>e.y)),r=Math.max(...e.map(e=>e.y+L)),l=Math.round(i/2-(s+n)/2),c=Math.round(i/2-(a+r)/2),o=e.map(e=>({...e,x:e.x+l,y:e.y+c})),d=(t||[]).map(e=>({...e,x:e.x+l,y:e.y+c})),x=[...o.map(e=>({start:e.x,end:e.x+L})),...d.map(e=>({start:e.x,end:e.x+e.width}))],m=[...o.map(e=>({start:e.y,end:e.y+L})),...d.map(e=>({start:e.y,end:e.y+e.height}))],h=Math.min(...x.map(e=>e.start)),p=Math.max(...x.map(e=>e.end)),u=Math.min(...m.map(e=>e.start)),f=Math.max(...m.map(e=>e.end)),g=0,b=0;return h<0?g=-h:p>i&&(g=i-p),u<0?b=-u:f>i&&(b=i-f),(0!==g||0!==b)&&(o=o.map(e=>({...e,x:e.x+g,y:e.y+b})),d=d.map(e=>({...e,x:e.x+g,y:e.y+b}))),{positions:o,envTiles:d}}(K.positions,K.envTiles,e);l(r.map(i=>i.id===c?{...i,gridSize:e,positions:t.positions,envTiles:t.envTiles}:i))},J=(t,s)=>{if("config"===i){if("box-select"===s.type&&s.units)return void u(s.units);s.shiftKey||s.ctrlKey||s.metaKey?u(e=>e.includes(t)?e.filter(e=>e!==t):[...e,t]):u([t])}else"analyze"===i&&u(i=>{let s=i.includes(t)?i.filter(e=>e!==t):i.length<2?[...i,t]:[i[1],t];if(2===s.length)A("vertical-avg"===f&&K?function(e,t,i,s,n){let a=v(y(e,t,i)),r=a.get(s)||[],l=a.get(n)||[];if(0===r.length||0===l.length)return null;let c=j(r,s),o=j(l,n),d=c.avgPrice-o.avgPrice,x=o.avgPrice>0?d/o.avgPrice*100:0;return{unitType1:s,unitType2:n,stats1:c,stats2:o,priceDiff:d,diffPercent:x,transactions1:r,transactions2:l}}(e,K.floorRange.start,K.floorRange.end,s[0],s[1]):null!==S?function(e,t,i,s){let n=v(e.filter(e=>g(e)===t)),a=n.get(i)||[],r=n.get(s)||[];if(0===a.length||0===r.length)return null;let l=j(a,i),c=j(r,s),o=l.avgPrice-c.avgPrice,d=c.avgPrice>0?o/c.avgPrice*100:0;return{unitType1:i,unitType2:s,stats1:l,stats2:c,priceDiff:o,diffPercent:d,transactions1:a,transactions2:r}}(e,S,s[0],s[1]):null);else A(null);return s})};return 0===e.length?null:(0,s.jsxs)("div",{ref:Z,className:"bg-zinc-900/50 border border-white/10 rounded-xl p-4 mb-6",children:[(0,s.jsxs)("div",{className:"flex items-center gap-2 mb-4",children:[(0,s.jsx)(h.A,{className:"w-4 h-4 text-violet-400"}),(0,s.jsx)("h3",{className:"text-sm font-bold text-zinc-100",children:"水平價差分析"}),(0,s.jsxs)("div",{className:"ml-auto flex items-center gap-1 text-xs",children:[(0,s.jsx)("button",{onClick:()=>a("config"),className:`px-3 py-1.5 rounded transition-all ${"config"===i?"bg-violet-500 text-white":"text-zinc-400 hover:text-zinc-200"}`,children:"樓層配置"}),(0,s.jsx)("button",{onClick:()=>r.length>0&&a("analyze"),disabled:0===r.length,className:`px-3 py-1.5 rounded transition-all ${"analyze"===i?"bg-violet-500 text-white":"text-zinc-400 hover:text-zinc-200 disabled:opacity-30"}`,children:"分析"})]})]}),"config"===i&&(0,s.jsxs)(m.P.div,{initial:{opacity:0},animate:{opacity:1},children:[(0,s.jsxs)("div",{className:"bg-black/40 rounded-lg border border-white/5 p-3 mb-3",children:[(0,s.jsxs)("div",{className:"flex items-center justify-between mb-2",children:[(0,s.jsx)("div",{className:"text-xs font-medium text-zinc-300",children:"樓層配置列表"}),(0,s.jsxs)("button",{onClick:()=>{let t=w(e,`配置 ${r.length+1}`);l([...r,t]),o(t.id)},className:"text-xs px-2 py-1 bg-violet-500 hover:bg-violet-400 text-white rounded flex items-center gap-1 transition",children:[(0,s.jsx)(C.A,{className:"w-3 h-3"}),"新增配置"]})]}),(0,s.jsx)("div",{className:"space-y-2",children:r.map(e=>(0,s.jsx)("div",{className:`
                                        p-2 rounded-lg border-2 transition-all cursor-pointer
                                        ${c===e.id?"bg-violet-500/20 border-violet-400":"bg-zinc-800/50 border-white/10 hover:border-white/20"}
                                    `,onClick:()=>o(e.id),children:(0,s.jsxs)("div",{className:"flex items-center justify-between",children:[(0,s.jsx)("div",{className:"flex-1",children:M?.id===e.id?(0,s.jsxs)("div",{className:"space-y-2",onClick:e=>e.stopPropagation(),children:[(0,s.jsx)("input",{type:"text",value:M.name,onChange:e=>B({...M,name:e.target.value}),className:"w-full bg-zinc-700 border border-white/10 text-zinc-200 text-xs rounded px-2 py-1",placeholder:"配置名稱"}),(0,s.jsxs)("div",{className:"flex items-center gap-2",onClick:e=>e.stopPropagation(),children:[(0,s.jsx)("input",{type:"number",value:M.range.start,onChange:e=>B({...M,range:{...M.range,start:e.target.value}}),onClick:e=>e.stopPropagation(),className:"flex-1 bg-zinc-700 border border-white/10 text-zinc-200 text-xs rounded px-2 py-1 w-16",placeholder:"起始"}),(0,s.jsx)("span",{className:"text-zinc-500",children:"~"}),(0,s.jsx)("input",{type:"number",value:M.range.end,onChange:e=>B({...M,range:{...M.range,end:e.target.value}}),onClick:e=>e.stopPropagation(),className:"flex-1 bg-zinc-700 border border-white/10 text-zinc-200 text-xs rounded px-2 py-1 w-16",placeholder:"結束"}),(0,s.jsx)("span",{className:"text-xs text-zinc-500",children:"F"})]}),(0,s.jsxs)("div",{className:"flex gap-2",children:[(0,s.jsx)("button",{onClick:()=>{var t,i,s;let n=Number(M.range.start),a=Number(M.range.end);Number.isNaN(n)||Number.isNaN(a)?alert("請輸入有效的樓層數字"):(t=e.id,(s=i={start:n,end:a},r.some(e=>(!t||e.id!==t)&&!(s.end<e.floorRange.start||s.start>e.floorRange.end)))?alert("樓層範圍與其他配置重疊！"):(l(r.map(e=>e.id===t?{...e,floorRange:i}:e)),B(null)))},className:"flex-1 text-xs px-2 py-1 bg-green-500 hover:bg-green-400 text-white rounded",children:"儲存"}),(0,s.jsx)("button",{onClick:()=>B(null),className:"flex-1 text-xs px-2 py-1 bg-zinc-700 hover:bg-zinc-600 text-white rounded",children:"取消"})]})]}):(0,s.jsxs)(s.Fragment,{children:[(0,s.jsx)("div",{className:"text-sm font-medium text-zinc-200",children:e.name}),(0,s.jsxs)("div",{className:"text-xs text-zinc-500",children:[e.floorRange.start,"F ~ ",e.floorRange.end,"F",(0,s.jsx)("span",{className:"mx-1",children:"•"}),e.positions.length," 個戶型"]})]})}),M?.id!==e.id&&(0,s.jsxs)("div",{className:"flex items-center gap-1",onClick:e=>e.stopPropagation(),children:[(0,s.jsx)("button",{onClick:()=>B({id:e.id,name:e.name,range:{start:String(e.floorRange.start),end:String(e.floorRange.end)}}),className:"p-1 rounded hover:bg-white/10 transition",children:(0,s.jsx)(F.A,{className:"w-3 h-3 text-zinc-400"})}),(0,s.jsx)("button",{onClick:()=>{var t;let i;return t=e.id,void(!(i=r.find(e=>e.id===t))||l([...r,{...i,id:N(),name:`${i.name} (複製)`,positions:i.positions.map(e=>({...e}))}]))},className:"p-1 rounded hover:bg-white/10 transition",children:(0,s.jsx)($.A,{className:"w-3 h-3 text-zinc-400"})}),r.length>1&&(0,s.jsx)("button",{onClick:()=>(e=>{if(r.length<=1)return;let t=r.filter(t=>t.id!==e);l(t),c===e&&o(t[0]?.id||null)})(e.id),className:"p-1 rounded hover:bg-red-500/20 transition",children:(0,s.jsx)(R.A,{className:"w-3 h-3 text-red-400"})})]})]})},e.id))})]}),K&&(0,s.jsxs)("div",{className:"grid grid-cols-[1fr_280px] gap-4 mb-3",children:[(0,s.jsxs)("div",{className:"bg-black/40 rounded-lg border border-white/5 p-4 min-w-0",children:[(0,s.jsxs)("div",{className:"flex items-center justify-between mb-3",children:[(0,s.jsxs)("div",{className:"text-xs text-zinc-400 flex items-center gap-2",children:[(0,s.jsx)(T.A,{className:"w-3 h-3"}),K.name]}),(0,s.jsxs)("button",{onClick:()=>{G(w(e).positions.map(e=>O(e,36))),u([])},className:"text-xs text-zinc-500 hover:text-zinc-300 flex items-center gap-1 transition",children:[(0,s.jsx)(E.A,{className:"w-3 h-3"}),"重置"]})]}),(0,s.jsx)(H,{positions:X,envTiles:K.envTiles,selectedUnits:p,zoom:K.zoom,compassDirection:K.compassDirection,gridSize:K.gridSize||30,onPositionsChange:G,onEnvTilesChange:e=>{if(!K)return;let t=z(K.positions,e,K.compassDirection||0,1);l(r.map(i=>i.id===c?{...i,envTiles:e,positions:t}:i))},onUnitClick:J,onZoomChange:V,onCompassChange:e=>{if(!K)return;let t=z(K.positions,K.envTiles||[],e,1);l(r.map(i=>i.id===c?{...i,compassDirection:e,positions:t}:i))},onGridSizeChange:Q})]}),(0,s.jsx)(W,{selectedUnits:p,positions:X,compassDirection:K.compassDirection,onBatchUpdate:e=>{K&&G(X.map(t=>p.includes(t.unitType)?{...t,...e}:t))},onClear:()=>u([])})]}),(0,s.jsx)("div",{className:"flex justify-end",children:(0,s.jsxs)("button",{onClick:()=>a("analyze"),disabled:0===r.length,className:"px-4 py-2 bg-violet-500 hover:bg-violet-400 disabled:opacity-30 text-white text-sm font-medium rounded-lg transition flex items-center gap-2",children:[(0,s.jsx)(D.A,{className:"w-4 h-4"}),"開始分析"]})})]}),"analyze"===i&&K&&(0,s.jsxs)(m.P.div,{initial:{opacity:0},animate:{opacity:1},children:[(0,s.jsxs)("div",{className:"flex items-center gap-3 mb-4 p-3 bg-zinc-800/50 rounded-lg",children:[(0,s.jsx)("span",{className:"text-sm text-zinc-400",children:"分析模式："}),(0,s.jsxs)("div",{className:"flex gap-2",children:[(0,s.jsx)("button",{onClick:()=>{k("per-floor"),u([]),A(null)},className:`px-3 py-1.5 text-xs rounded-lg transition-all ${"per-floor"===f?"bg-cyan-500 text-white":"bg-zinc-700 text-zinc-400 hover:bg-zinc-600"}`,children:"當層比較"}),(0,s.jsx)("button",{onClick:()=>{k("vertical-avg"),u([]),A(null)},className:`px-3 py-1.5 text-xs rounded-lg transition-all ${"vertical-avg"===f?"bg-violet-500 text-white":"bg-zinc-700 text-zinc-400 hover:bg-zinc-600"}`,children:"垂直平均比較"})]}),"per-floor"===f&&(0,s.jsxs)("div",{className:"ml-4 flex items-center gap-2",children:[(0,s.jsx)("span",{className:"text-sm text-zinc-400",children:"樓層："}),(0,s.jsx)("select",{value:S||"",onChange:e=>{_(Number(e.target.value)),u([]),A(null)},className:"bg-zinc-700 border border-white/10 text-zinc-200 text-sm rounded px-2 py-1",children:U.filter(e=>e>=K.floorRange.start&&e<=K.floorRange.end).map(e=>(0,s.jsx)("option",{value:e,children:e>0?`${e}F`:`B${Math.abs(e)}F`},e))})]}),"vertical-avg"===f&&(0,s.jsxs)("div",{className:"ml-4 text-xs text-zinc-500",children:["分析範圍：",K.floorRange.start,"F ~ ",K.floorRange.end,"F"]}),(0,s.jsx)("button",{onClick:()=>{a("config"),u([]),A(null)},className:"ml-auto text-xs text-zinc-500 hover:text-zinc-300 transition",children:"← 返回配置"})]}),(0,s.jsx)(x.N,{children:P&&(0,s.jsx)(q,{comparison:P,onClose:()=>{A(null),u([])}})}),(0,s.jsxs)("div",{className:"bg-black/40 rounded-lg border border-white/5 p-4 mb-3 min-w-0",children:[(0,s.jsx)(H,{positions:X,results:Y,selectedUnits:p,zoom:K.zoom,gridSize:K.gridSize||30,onPositionsChange:G,onUnitClick:J,onZoomChange:V,onGridSizeChange:Q,isAnalyzeMode:!0}),(0,s.jsx)("div",{className:"mt-2 text-[10px] text-zinc-500 flex items-center gap-3",children:(0,s.jsxs)("div",{className:"flex items-center gap-1",children:[(0,s.jsx)(I.A,{className:"w-3 h-3"}),(0,s.jsx)("span",{children:"點擊兩個戶型進行比對"})]})})]}),Y.length>0&&(0,s.jsx)("div",{className:"grid grid-cols-2 md:grid-cols-3 lg:grid-cols-4 xl:grid-cols-5 gap-2",children:Y.map(e=>(0,s.jsxs)("div",{className:`
                                        bg-zinc-800/50 border rounded-lg p-2 transition-all cursor-pointer
                                        ${p.includes(e.unitType)?"border-cyan-400 bg-cyan-500/10":"border-white/10 hover:border-white/20"}
                                    `,onClick:t=>J(e.unitType,t),children:[(0,s.jsxs)("div",{className:"flex items-center justify-between mb-1",children:[(0,s.jsx)("div",{className:"text-sm font-bold text-zinc-100",children:e.unitType}),"floorCount"in e&&(0,s.jsxs)("div",{className:"text-[10px] text-zinc-500",children:[e.floorCount," 層"]})]}),(0,s.jsxs)("div",{className:"text-xs space-y-0.5",children:[(0,s.jsxs)("div",{className:"flex justify-between",children:[(0,s.jsx)("span",{className:"text-zinc-500",children:"均價"}),(0,s.jsx)("span",{className:"text-cyan-400 font-mono",children:e.avgPrice.toFixed(1)})]}),(0,s.jsxs)("div",{className:"flex justify-between",children:[(0,s.jsx)("span",{className:"text-zinc-500",children:"最低"}),(0,s.jsx)("span",{className:"text-zinc-300 font-mono",children:e.minPrice.toFixed(1)})]}),(0,s.jsxs)("div",{className:"flex justify-between",children:[(0,s.jsx)("span",{className:"text-zinc-500",children:"最高"}),(0,s.jsx)("span",{className:"text-zinc-300 font-mono",children:e.maxPrice.toFixed(1)})]}),(0,s.jsxs)("div",{className:"flex justify-between",children:[(0,s.jsx)("span",{className:"text-zinc-500",children:"中位"}),(0,s.jsx)("span",{className:"text-violet-400 font-mono",children:e.medianPrice.toFixed(1)})]}),(0,s.jsxs)("div",{className:"text-[10px] text-zinc-600 mt-1",children:[e.count," 筆交易"]})]})]},e.unitType))})]})]})}var X=i(29991),Y=i(60529),G=i(89239),V=i(37618),Q=i(61878);let J=(e,t)=>{let i=e?.["戶型"];if("string"==typeof i&&i)return i;let s=t.resolve(e);if(s)return s;let n=e?.["戶別"]||e?.unit||e?.unitName;return"string"==typeof n&&n?n:"?"},ee=e=>{let t=String(e?.["樓層"]||e?.floor||e?.layer||""),i="1"===t||"001"===t||t.includes("一樓"),s=e?.["建物型態"]||e?.buildingType||"",n=e?.["主要用途"]||e?.mainPurpose||"",a=e?.["備註"]||e?.note||"",r=s.includes("店")||e.buildingType?.includes("店")||"商業用"===n||"商業用"===e.mainPurpose||a.includes("店")||e.note?.includes("店"),l=s.includes("辦公")||e.buildingType?.includes("辦公")||s.includes("廠辦")||e.buildingType?.includes("廠辦")||s.includes("事務所")||e.buildingType?.includes("事務所")||n.includes("辦公")||e.mainPurpose?.includes("辦公")||n.includes("事務所")||e.mainPurpose?.includes("事務所")||a.includes("辦公")||a.includes("事務所")||e.note?.includes("辦公")||e.note?.includes("事務所");return{buildingType:s,mainPurpose:n,note:a,isStorefront:r&&i,isOffice:l||r&&!i}},et=e=>{let{note:t,isStorefront:i,isOffice:s}=ee(e),n=t.includes("親友")||t.includes("員工")||t.includes("關係人")||t.includes("關係戶")||t.includes("員工關係");return{note:t,isStorefront:i,isOffice:s,isEmployeeRelated:n}};var ei=i(88743),es=i(78795);function en({transactions:e,project:t}){let[i,a]=(0,n.useState)(""),[r,l]=(0,n.useState)(""),[c,o]=(0,n.useState)(null);return(0,s.jsxs)("div",{className:"flex flex-col sm:flex-row flex-wrap items-start sm:items-center gap-3 sm:gap-4 bg-zinc-900/30 p-4 rounded-lg border border-white/5",children:[(0,s.jsxs)("div",{className:"flex flex-col sm:flex-row items-start sm:items-center gap-2 w-full sm:w-auto",children:[(0,s.jsx)("span",{className:"text-sm text-zinc-400 font-semibold whitespace-nowrap",children:"區間均價試算:"}),(0,s.jsxs)("div",{className:"flex items-center gap-2",children:[(0,s.jsx)(Y.p,{type:"number",placeholder:"起樓",className:"w-20 h-8 bg-zinc-950/50",value:i,onChange:e=>a(e.target.value)}),(0,s.jsx)("span",{className:"text-zinc-500",children:"~"}),(0,s.jsx)(Y.p,{type:"number",placeholder:"迄樓",className:"w-20 h-8 bg-zinc-950/50",value:r,onChange:e=>l(e.target.value)})]}),(0,s.jsx)(G.$,{size:"sm",variant:"secondary",onClick:()=>{if(!t||!e)return;let s=parseInt(i),n=parseInt(r);if(isNaN(s)||isNaN(n)||s>n)return void o(null);let a=e.filter(e=>{if(e["建案名稱"]!==t)return!1;let i=parseInt(String(e["樓層"]));return!isNaN(i)&&i>=s&&i<=n});if(0===a.length)return void o({avg:0,count:0});let l=a.reduce((e,t)=>e+(t["房屋總價(萬)"]||0),0),c=a.reduce((e,t)=>e+(t["房屋面積(坪)"]||0),0);o({avg:c>0?l/c:0,count:a.length})},className:"h-8 ml-2",children:"計算"})]}),c&&(0,s.jsxs)("div",{className:"flex items-center gap-4 ml-4 animate-in fade-in",children:[(0,s.jsxs)("div",{className:"flex flex-col",children:[(0,s.jsx)("span",{className:"text-xs text-zinc-500",children:"平均單價 (加權)"}),(0,s.jsxs)("span",{className:"text-lg font-bold text-violet-400",children:[c.avg.toFixed(2)," 萬/坪"]})]}),(0,s.jsxs)("div",{className:"flex flex-col",children:[(0,s.jsx)("span",{className:"text-xs text-zinc-500",children:"參考筆數"}),(0,s.jsxs)("span",{className:"text-sm text-zinc-300",children:[c.count," 筆"]})]})]})]})}function ea({data:e}){let[t,i]=(0,n.useState)(""),[l,c]=(0,n.useState)(!1),[o,x]=(0,n.useState)(.3),[m,h]=(0,n.useState)(14),[p,u]=(0,n.useState)(!1),[g,b]=(0,n.useState)(!1),j=(0,ei.P)(e=>e.excludeCommercial),v=n.useRef(null),y=n.useRef(null),N=n.useRef(null);if((0,n.useEffect)(()=>{!l&&e?.priceGridAnalysis?.projectNames?.length&&!t&&i(e.priceGridAnalysis.projectNames[0])},[e,t,l]),!e?.priceGridAnalysis)return null;let{projectNames:w,byProject:z}=e.priceGridAnalysis,k=n.useMemo(()=>t&&e.transactionDetails?e.transactionDetails.filter(e=>e["建案名稱"]===t):null,[t,e.transactionDetails]),S=n.useMemo(()=>{if(!k||0===k.length)return{hasOffice:!1,hasResidential:!1,isMixed:!1};let e=k.reduce((e,t)=>{let{isStorefront:i,isOffice:s}=ee(t);return s&&(e.hasOffice=!0),s||i||(e.hasResidential=!0),e},{hasOffice:!1,hasResidential:!1});return{...e,isMixed:e.hasOffice&&e.hasResidential}},[k]),_=n.useMemo(()=>!!k&&0!==k.length&&k.some(e=>{let t=e["備註"]||e.note||"";return t.includes("親友")||t.includes("員工")||t.includes("關係人")||t.includes("關係戶")||t.includes("員工關係")}),[k]);(0,n.useEffect)(()=>{t&&u(!S.isMixed&&S.hasOffice)},[t,S.isMixed,S.hasOffice]),(0,n.useEffect)(()=>{t&&b(!1)},[t]);let P=n.useMemo(()=>{if(!k)return null;let e=k;return j&&(e=e.filter(e=>{let{isStorefront:t,isOffice:i}=ee(e);return!t&&!i})),e},[k,j]),A=!j&&p,M=n.useMemo(()=>{if(!t)return null;if(P&&P.length>0)try{return function(e,t=.3,i=14,s={}){let n=e.reduce((e,t)=>{let{isStorefront:i,isOffice:s}=ee(t);return s&&(e.hasOffice=!0),s||i||(e.hasResidential=!0),e},{hasOffice:!1,hasResidential:!1}),a=!(n.hasOffice&&n.hasResidential)&&n.hasOffice,r="boolean"==typeof s.includeOfficePremium?s.includeOfficePremium:a,l="boolean"==typeof s.includeStorefrontPremium&&s.includeStorefrontPremium,c="boolean"==typeof s.includeEmployeePremium&&s.includeEmployeePremium,o=e=>{let{isStorefront:t,isOffice:i,isEmployeeRelated:s}=et(e);return(!!l||!t)&&(!!r||!i)&&(!!c||!s)},x={},m=new Set,h=new Set,p=new d(e);if(e.forEach(e=>{let t=e["樓層"]||e.floor||e.layer;if(null==t)return;"number"==typeof t&&(t=String(t)),"number"==typeof t&&(t=String(t));let i=J(e,p);m.add(t),h.add(i),x[t]||(x[t]={}),x[t][i]||(x[t][i]=[]);let s=parseFloat(e["房屋單價(萬)"]||e.unitPrice||0),n=parseFloat(e["交易總價(萬)"]||e.totalPrice||0),a=parseFloat(e["房屋總價(萬)"]||e.housePrice||0),r=parseFloat(e["車位總價(萬)"]||e.parkingPrice||0),l=parseFloat(e["房屋面積(坪)"]||e.houseArea||0),c=e["房數"]||e.rooms,o=e["車位類別"]||e.parkingType||"";"string"==typeof o&&o.includes("車位");let{note:d,isStorefront:u,isOffice:f,isEmployeeRelated:g}=et(e),b=e["交易日"]||e["交易年月日"]||e.transactionDate||"",j=b;if(b&&/^\d{6,7}$/.test(String(b))){let e=String(b),t=6===e.length?2:3;j=`${e.substring(0,t)}/${e.substring(t,t+2)}/${e.substring(t+2)}`}x[t][i].push({...e,unitPrice:s,floor:t,unit:i,transactionDate:j,remark:d,isStorefront:u,isOffice:f,isEmployeeRelated:g,hasParking:r>0,tooltipInfo:{totalPrice:n,housePrice:a,parkingPrice:r,houseArea:l,rooms:c}})}),0===m.size)return{horizontalGrid:{},sortedFloors:[],sortedUnits:[],unitColorMap:{},summary:{totalBaselineHousePrice:0,totalPricePremiumValue:0,totalSoldArea:0,transactionCount:0,calculationFlags:{includesOfficePremium:r,includesStorefrontPremium:l,includesEmployeePremium:c}},horizontalComparison:[]};let u=Array.from(m).sort((e,t)=>{let i=e=>e?e.startsWith("B")?-parseInt(e.substring(1)):parseInt(e)||0:0;return i(t)-i(e)}),f=e=>{let t=String(e||"").trim().toUpperCase(),i=t.match(/^([A-Z]+)(\d+)?$/);return i?{alpha:i[1]||"",num:i[2]?parseInt(i[2],10):Number.MAX_SAFE_INTEGER,raw:t}:{alpha:t,num:Number.MAX_SAFE_INTEGER,raw:t}},g=Array.from(h).sort((e,t)=>{let i=f(e),s=f(t),n=i.alpha.localeCompare(s.alpha,"en");return 0!==n?n:i.num!==s.num?i.num-s.num:i.raw.localeCompare(s.raw,"en")}),b={},j=e=>{if(!e)return null;let t=e.replace(/\//g,"");if(t.length<6)return null;let i=6===t.length?2:3,s=parseInt(t.substring(0,i)),n=parseInt(t.substring(i,i+2));return new Date(1911+s,n-1,parseInt(t.substring(i+2)))},v={};e.forEach(e=>{let t=J(e,p),{note:i}=et(e),s=parseFloat(e["房屋單價(萬)"]||e.unitPrice||0);!(!o(e)||i.includes("特殊")||i.includes("毛胚"))&&s>0&&(v[t]||(v[t]=[]),v[t].push(e))}),Object.keys(v).forEach(e=>{let s=v[e];if(s.sort((e,t)=>(j(e["交易年月日"]||e.transactionDate)?.getTime()||0x9184e729fff)-(j(t["交易年月日"]||t.transactionDate)?.getTime()||0x9184e729fff)),0===s.length)return;let n=j(s[0]["交易年月日"]||s[0].transactionDate);if(!n){b[e]=s.reduce((e,t)=>parseFloat(t["房屋單價(萬)"])<parseFloat(e["房屋單價(萬)"])?t:e,s[0]);return}let a=new Date(n);a.setDate(a.getDate()+i);let r=s.filter(e=>{let t=j(e["交易年月日"]||e.transactionDate);return t&&t<=a}),l=r[0]||s[0],c=1/0;r.forEach(e=>{let i,s=parseFloat(e["房屋單價(萬)"]||0)-((i=String(e["樓層"]))?i.startsWith("B")?-parseInt(i.substring(1)):parseInt(i):0)*t;s<c&&(c=s,l=e)}),b[e]=l});let y=0,N=0,w=0,z=0;Object.keys(x).forEach(e=>{Object.keys(x[e]).forEach(i=>{x[e][i].forEach((s,n)=>{let a=null,r=b[i];if(r&&o(s)){let e=e=>e?e.startsWith("B")?-parseInt(e.substring(1)):parseInt(e):0,i=String(r["樓層"]),n=String(s.floor),l=e(i),c=e(n),o=parseFloat(r["房屋單價(萬)"]||r.unitPrice||0)+(c-l)*t;if(o>0&&(a=(s["房屋單價(萬)"]-o)/o*100,(s===r||.1>Math.abs(s["房屋單價(萬)"]-o))&&(a=0)),s.tooltipInfo.housePrice&&s.tooltipInfo.houseArea){let e=o*s.tooltipInfo.houseArea;y+=e,N+=s.tooltipInfo.housePrice-e,w+=s.tooltipInfo.houseArea,z++}}else a=null;x[e][i][n].premium=a})})});let k={},S=["#f87171","#fb923c","#fbbf24","#a3e635","#34d399","#22d3ee","#818cf8","#c084fc","#f472b6"];g.forEach((e,t)=>{k[e]=S[t%S.length]});let _={};g.forEach(e=>{_[e]={totalOriginalPriceValue:0,totalActualPriceValue:0,totalSoldArea:0,count:0,anchorPrice:null,anchorFloor:null};let t=b[e];t&&(_[e].anchorPrice=parseFloat(t["房屋單價(萬)"]||0),_[e].anchorFloor=String(t["樓層"]))}),Object.keys(x).forEach(e=>{Object.keys(x[e]).forEach(i=>{x[e][i].forEach(e=>{let s=b[i];if(o(e)&&e.tooltipInfo.houseArea&&s){let n=e=>e?e.startsWith("B")?-parseInt(e.substring(1)):parseInt(e):0,a=n(String(s["樓層"])),r=n(e.floor),l=parseFloat(e["房屋單價(萬)"]||e.unitPrice||0),c=l-(r-a)*t,o=e.tooltipInfo.houseArea;Number.isFinite(c)&&Number.isFinite(l)&&o>0&&_[i]&&(_[i].totalOriginalPriceValue+=c*o,_[i].totalActualPriceValue+=l*o,_[i].totalSoldArea+=o,_[i].count++)}})})});let P=[],A=[],M=null,C=null,F=1/0,$=1/0;Object.keys(_).forEach(e=>{let t=_[e];if(t.totalSoldArea>0){let i=t.totalOriginalPriceValue/t.totalSoldArea,s=t.totalActualPriceValue/t.totalSoldArea;P.push(i),A.push(s),i<F&&(F=i,M=e),s<$&&($=s,C=e)}});let R=P.length?Math.min(...P):0,T=A.length?Math.min(...A):0,E=Object.keys(_).map(e=>{let t=_[e];if(0===t.count||0===t.totalSoldArea)return null;let i=t.totalOriginalPriceValue/t.totalSoldArea,s=t.totalActualPriceValue/t.totalSoldArea,n=s-i,a=n*t.totalSoldArea;return{unitType:e,anchorInfo:t.anchorPrice?`${t.anchorFloor}F / ${t.anchorPrice}萬`:"N/A",originalHorizontalDiff:i-R,actualHorizontalDiff:s-T,unitsSold:t.count,totalSoldArea:t.totalSoldArea,originalAvgPrice:i,actualAvgPrice:s,avgPremiumPerPing:n,timePremiumContribution:a}}).filter(Boolean),D=E.reduce((e,t)=>e+(t.timePremiumContribution||0),0);return E.forEach(e=>{e.contributionPercentage=D>0?e.timePremiumContribution/D*100:0}),{horizontalGrid:x,sortedFloors:u,sortedUnits:g,unitColorMap:k,summary:{totalBaselineHousePrice:y,totalPricePremiumValue:N,totalSoldArea:w,transactionCount:z,calculationFlags:{includesOfficePremium:r,includesStorefrontPremium:l,includesEmployeePremium:c}},horizontalComparison:E,comparisonMeta:{originalMinUnit:M,originalMinAvg:Number.isFinite(F)?F:null,actualMinUnit:C,actualMinAvg:Number.isFinite($)?$:null}}}(P,o,m,{includeOfficePremium:A,includeEmployeePremium:g})}catch(e){console.error("Heatmap generation error:",e)}return z[t]&&z[t].horizontalGrid?z[t]:null},[t,P,z,o,m,A,g]),C=n.useMemo(()=>{let e=M?.summary?.calculationFlags;if(!e)return"排除店舖/辦公室";let t=[];return e.includesStorefrontPremium||t.push("店舖"),e.includesOfficePremium||t.push("辦公室"),e.includesEmployeePremium||t.push("員工關係戶"),t.length?`排除${t.join("/")}`:"全部納入"},[M?.summary?.calculationFlags]);return(0,s.jsxs)("div",{className:"space-y-6 animate-in fade-in slide-in-from-bottom-4 duration-500",children:[(0,s.jsx)("div",{className:"flex flex-col gap-4 bg-zinc-900/30 p-4 rounded-lg border border-white/5",children:(0,s.jsx)("div",{className:"flex flex-col lg:flex-row flex-wrap items-start lg:items-center gap-4",children:(0,s.jsxs)("div",{className:"flex flex-col sm:flex-row items-start sm:items-center gap-2 w-full lg:w-auto",children:[(0,s.jsxs)("div",{className:"flex items-center gap-2",children:[(0,s.jsx)("span",{className:"text-sm text-zinc-400 whitespace-nowrap",children:"選擇建案:"}),(0,s.jsx)("button",{onClick:()=>c(!l),className:`p-1 rounded transition-colors ${l?"text-violet-400 bg-violet-400/10":"text-zinc-500 hover:text-zinc-300"}`,title:l?"切換回下拉選單":"切換手動輸入",children:(0,s.jsx)(V.A,{className:"w-3.5 h-3.5"})})]}),l?(0,s.jsxs)("div",{className:"relative w-full sm:w-[280px]",children:[(0,s.jsx)(Y.p,{value:t,onChange:e=>i(e.target.value),placeholder:"輸入建案名稱...",className:"w-full h-9 bg-zinc-950/50 pl-8 pr-4",list:"project-list",autoComplete:"off"}),(0,s.jsx)(Q.A,{className:"absolute left-2.5 top-1/2 -translate-y-1/2 w-4 h-4 text-zinc-500"}),(0,s.jsx)("datalist",{id:"project-list",children:w.map(e=>(0,s.jsx)("option",{value:e},e))})]}):(0,s.jsxs)(X.l,{value:t,onChange:e=>i(e.target.value),className:"w-full sm:w-[280px] bg-zinc-950/50",children:[(0,s.jsx)("option",{value:"",disabled:!0,children:"請選擇建案..."}),w.map(e=>(0,s.jsx)("option",{value:e,children:e},e))]})]})})}),t&&P&&P.length>0&&(0,s.jsx)(f,{transactions:P,currentPremium:o,onApply:e=>x(e),onManualChange:e=>x(e)}),t&&P&&P.length>0&&(0,s.jsx)(K,{transactions:P,project:t}),t&&P&&P.length>0&&(0,s.jsx)(en,{transactions:P,project:t}),(0,s.jsxs)("div",{className:"flex flex-wrap gap-4 p-4 bg-zinc-900/20 rounded-lg border border-white/5",children:[(0,s.jsxs)("div",{className:"flex items-center gap-2",children:[(0,s.jsx)("span",{className:"text-xs text-zinc-500",children:"溢價圖例:"}),(0,s.jsxs)("span",{className:"flex items-center gap-1",children:[(0,s.jsx)("span",{className:"w-4 h-4 rounded bg-red-500/80"}),(0,s.jsx)("span",{className:"text-xs text-zinc-400",children:"> 5%"})]}),(0,s.jsxs)("span",{className:"flex items-center gap-1",children:[(0,s.jsx)("span",{className:"w-4 h-4 rounded bg-orange-500/80"}),(0,s.jsx)("span",{className:"text-xs text-zinc-400",children:"2-5%"})]}),(0,s.jsxs)("span",{className:"flex items-center gap-1",children:[(0,s.jsx)("span",{className:"w-4 h-4 rounded bg-yellow-500/80"}),(0,s.jsx)("span",{className:"text-xs text-zinc-400",children:"0-2%"})]}),(0,s.jsxs)("span",{className:"flex items-center gap-1",children:[(0,s.jsx)("span",{className:"w-4 h-4 rounded bg-green-500/80"}),(0,s.jsx)("span",{className:"text-xs text-zinc-400",children:"< 0%"})]})]}),(0,s.jsx)("div",{className:"ml-auto"})]}),(0,s.jsx)(a.c,{title:"建案銷控表與調價熱力圖",description:"可視化建案各戶別的銷售狀況與價格調整幅度",containerRef:v,headerAction:(0,s.jsxs)("div",{className:"flex flex-wrap items-center gap-2",children:[!j&&S.hasOffice&&(0,s.jsxs)("div",{className:"flex items-center gap-2",children:[(0,s.jsx)("span",{className:"text-xs text-zinc-400 whitespace-nowrap",children:"事務所/商辦調價"}),(0,s.jsx)("button",{onClick:()=>u(e=>!e),className:`px-2 h-8 rounded border text-[11px] transition ${p?"border-cyan-400 text-cyan-300 bg-cyan-500/10":"border-white/10 text-zinc-400 hover:text-zinc-200 hover:border-white/30"}`,title:p?"已納入事務所/商辦調價":"排除事務所/商辦調價",children:p?"納入":"排除"}),S.isMixed&&(0,s.jsx)("span",{className:"text-[11px] text-zinc-500 whitespace-nowrap",children:"混合用途預設排除"})]}),_&&(0,s.jsxs)("div",{className:"flex items-center gap-2",children:[(0,s.jsx)("span",{className:"text-xs text-zinc-400 whitespace-nowrap",children:"員工關係戶調價"}),(0,s.jsx)("button",{onClick:()=>b(e=>!e),className:`px-2 h-8 rounded border text-[11px] transition ${g?"border-cyan-400 text-cyan-300 bg-cyan-500/10":"border-white/10 text-zinc-400 hover:text-zinc-200 hover:border-white/30"}`,title:g?"已納入員工關係戶調價":"排除員工關係戶調價",children:g?"納入":"排除"})]}),(0,s.jsxs)("div",{className:"flex items-center gap-2 bg-zinc-950/40 border border-white/10 rounded-lg px-2 py-1",children:[(0,s.jsx)("span",{className:"text-xs text-zinc-400",children:"基準天數"}),(0,s.jsx)(Y.p,{type:"number",min:"1",max:"365",value:m,onChange:e=>h(Number(e.target.value)||14),className:"w-16 h-8 bg-zinc-950/50 text-right pr-2"}),(0,s.jsx)("span",{className:"text-xs font-mono text-violet-400 whitespace-nowrap",children:"天"})]}),(0,s.jsx)(es.N,{data:P||[],filename:`heatmap_grid_${t}`,label:"匯出",chartType:"heatmap-grid",targetRef:v,snapshotData:{projectData:M,floorPremium:o,selectedProject:t}})]}),children:M?(0,s.jsx)(r.t,{data:M,floorPremium:o,showSummary:!1,showComparison:!1}):(0,s.jsx)("div",{className:"text-zinc-500 text-center p-12",children:"請選擇建案以查看銷控表"})}),M?.summary&&(0,s.jsx)(a.c,{title:`調價幅度統計摘要 (${C})`,containerRef:y,headerAction:(0,s.jsx)(es.N,{data:[M.summary],filename:`heatmap_stats_${t}`,label:"匯出",chartType:"heatmap-stats",targetRef:y,snapshotData:{summary:M.summary,selectedProject:t}}),children:(0,s.jsx)(r.t,{data:M,showGrid:!1,showSummary:!0,showComparison:!1})}),M?.horizontalComparison&&M.horizontalComparison.length>0&&(0,s.jsx)(a.c,{title:"戶型水平價差與溢價貢獻",containerRef:N,headerAction:(0,s.jsx)(es.N,{data:M.horizontalComparison,filename:`heatmap_comparison_${t}`,label:"匯出",chartType:"heatmap-comparison",targetRef:N,snapshotData:{horizontalComparison:M.horizontalComparison,selectedProject:t}}),children:(0,s.jsx)(r.t,{data:M,showGrid:!1,showSummary:!1,showComparison:!0})})]})}},75444:(e,t,i)=>{i.d(t,{P:()=>u});var s=i(95155),n=i(12115),a=i(34361),r=i(826),l=i(97085);function c({roomTypes:e,locations:t,crossTable:i,dimension:a}){let r=(0,n.useMemo)(()=>e&&t&&i?e.map(e=>{let s=t.map(t=>i[e]&&i[e][t]||0);return{name:e,data:s}}):[],[e,t,i]),c=(0,n.useMemo)(()=>{let e="county"===a?"縣市":"行政區";return{chart:{type:"bar",height:Math.max(350,35*t.length),stacked:!0,background:"transparent",toolbar:{show:!0},foreColor:"#e5e7eb"},plotOptions:{bar:{horizontal:!0,barHeight:"70%",borderRadius:4,dataLabels:{total:{enabled:!0,offsetX:5,style:{fontSize:"11px",fontWeight:600,color:"#e5e7eb"},formatter:function(e,t){let i=t.w.config.series,s=t.dataPointIndex,n=0;return i.forEach(e=>{n+=e.data[s]||0}),n>0?n.toString():""}}}}},colors:["#06b6d4","#8b5cf6","#10b981","#f59e0b","#ef4444","#3b82f6","#ec4899","#84cc16","#6366f1","#14b8a6"],dataLabels:{enabled:!1},xaxis:{categories:t,title:{text:"成交筆數",style:{color:"#9ca3af"}},labels:{style:{colors:"#9ca3af"}}},yaxis:{title:{text:e,style:{color:"#9ca3af"}},labels:{style:{colors:"#e5e7eb"},maxWidth:150}},legend:{position:"top",horizontalAlign:"center",labels:{colors:"#e5e7eb"}},tooltip:{theme:"dark",y:{formatter:function(e){return e+" 筆"}}},grid:{borderColor:"#374151"},title:{text:`各${e}房型成交筆數分佈`,align:"center",style:{fontSize:"16px",color:"#e5e7eb"}}}},[t,a]);return r&&0!==r.length?(0,s.jsx)(l.A,{type:"bar",series:r,options:c,height:c.chart?.height||350,className:"w-full"}):(0,s.jsx)("div",{className:"text-zinc-500 text-center p-8",children:"無區域分佈資料"})}var o=i(33210),d=i(40980);function x({isOpen:e,onClose:t,title:i,projects:a}){let r=(0,n.useRef)(null);return((0,n.useEffect)(()=>{let i=e=>{"Escape"===e.key&&t()};return e&&(document.addEventListener("keydown",i),document.body.style.overflow="hidden"),()=>{document.removeEventListener("keydown",i),document.body.style.overflow=""}},[e,t]),e)?(0,s.jsx)("div",{className:"fixed inset-0 z-50 flex items-center justify-center bg-black/60 backdrop-blur-sm animate-in fade-in duration-200",onClick:e=>{r.current&&!r.current.contains(e.target)&&t()},children:(0,s.jsxs)("div",{ref:r,className:"bg-zinc-900 border border-white/10 rounded-xl shadow-2xl max-w-md w-full mx-4 animate-in zoom-in-95 duration-200",children:[(0,s.jsxs)("div",{className:"flex items-center justify-between px-5 py-4 border-b border-white/5",children:[(0,s.jsx)("h3",{className:"text-lg font-semibold text-white",children:i}),(0,s.jsx)("button",{onClick:t,className:"p-1 rounded hover:bg-white/10 text-zinc-400 hover:text-white transition-colors",children:(0,s.jsx)(o.A,{size:20})})]}),(0,s.jsx)("div",{className:"px-5 py-4 max-h-[50vh] overflow-y-auto scrollbar-thin scrollbar-thumb-zinc-700",children:0===a.length?(0,s.jsx)("p",{className:"text-zinc-500 text-center py-4",children:"無建案資料"}):(0,s.jsx)("ul",{className:"space-y-2",children:a.map((e,t)=>(0,s.jsx)("li",{className:(0,d.cn)("px-3 py-2 rounded-lg text-zinc-200 text-sm","bg-zinc-800/50 hover:bg-zinc-800 transition-colors","border border-white/5"),children:e},t))})}),(0,s.jsxs)("div",{className:"px-5 py-3 border-t border-white/5 flex justify-between items-center",children:[(0,s.jsxs)("span",{className:"text-xs text-zinc-500",children:["共 ",a.length," 個建案"]}),(0,s.jsx)("button",{onClick:t,className:"px-4 py-1.5 text-sm rounded-lg bg-zinc-800 text-zinc-300 hover:bg-zinc-700 transition-colors",children:"關閉"})]})]})}):null}var m=i(78795),h=i(88743),p=i(48551);function u({data:e,visibleSections:t=["chart","table","location-table","location-chart"]}){let{selectedRoomTypes:i,setSelectedRoomTypes:l}=(0,h.P)(),o=["套房","1房","2房","3房","4房","毛胚"],u=n.useRef(null),f=n.useRef(null),g=n.useRef(null),b=n.useRef(null),[j,v]=(0,n.useState)("district"),[y,N]=(0,n.useState)(!1),[w,z]=(0,n.useState)(""),[k,S]=(0,n.useState)([]),[_,P]=(0,n.useState)(null),A=(0,n.useMemo)(()=>{if(!e?.transactionDetails)return[];let t=new Set;return e.transactionDetails.forEach(e=>{e["縣市"]&&t.add(e["縣市"])}),Array.from(t).sort()},[e?.transactionDetails]);n.useEffect(()=>{!_&&A.length>0&&P(A[0])},[A,_]);let M=(e,t,i)=>{z(`${e}${null!==t?` / ${t}衛`:""} 建案組成`),S(i),N(!0)};if(!e||!e.details||0===e.details.length)return null;let{details:C,locationCrossTable:F,allDistricts:$,transactionDetails:R}=e,T=(0,n.useMemo)(()=>C.filter(e=>i.includes(e.roomType)),[C,i]),[E,D]=(0,n.useState)(!0),I=(0,n.useMemo)(()=>{let e=C.filter(e=>i.includes(e.roomType));if(!E)return e;let t=new Map;return e.forEach(e=>{let i=e.roomType;t.has(i)||t.set(i,{...e,bathrooms:null,projectNames:e.projectNames?[...e.projectNames]:[],count:0,avgPrice:0});let s=t.get(i),n=s.avgPrice*s.count,a=e.avgPrice*e.count,r=s.count+e.count;s.count=r,s.avgPrice=r>0?(n+a)/r:0,s.minPrice=Math.min(s.minPrice,e.minPrice),s.maxPrice=Math.max(s.maxPrice,e.maxPrice);let l=s.count-e.count,c=e.count;if(s.medianPrice=(s.medianPrice*l+e.medianPrice*c)/r,s.q1Price=(s.q1Price*l+e.q1Price*c)/r,s.q3Price=(s.q3Price*l+e.q3Price*c)/r,e.projectNames){let t=new Set([...s.projectNames||[],...e.projectNames]);s.projectNames=Array.from(t)}}),Array.from(t.values()).sort((e,t)=>o.indexOf(e.roomType)-o.indexOf(t.roomType))},[C,i,E,o]),L=(0,n.useMemo)(()=>{if("county"===j&&R){let e={},t=new Set;R.forEach(i=>{let s=i["房型"]||i.roomType||i["戶型"];if(!s||"其他"===s){let e=Number(i["房數"]);s=!isNaN(e)&&e>0?`${e}房`:"其他"}let n="string"==typeof s?s.replace(/\s+/g,""):s;("number"==typeof n||"string"==typeof n&&/^\d+$/.test(n))&&(n=`${n}房`);let a=i["縣市"]||"未知";e[n]||(e[n]={}),e[n][a]=(e[n][a]||0)+1,t.add(a)});let s=Array.from(t).sort(),n={},a=0;s.forEach(e=>n[e]=0);let r=i.map(t=>{let i=e[t]||{},r=0,l=s.map(e=>{let t=i[e]||0;return r+=t,n[e]+=t,t});return a+=r,{roomType:t,cells:l,rowTotal:r}});return{locations:s,rows:r,locationTotals:n,grandTotal:a}}if("district"===j){let e={},t=new Set;if(R)R.forEach(i=>{let s=i["房型"]||i.roomType||i["戶型"];if(!s||"其他"===s){let e=Number(i["房數"]);s=!isNaN(e)&&e>0?`${e}房`:"其他"}let n="string"==typeof s?s.replace(/\s+/g,""):s;("number"==typeof n||"string"==typeof n&&/^\d+$/.test(n))&&(n=`${n}房`);let a=i["行政區"]||"未知",r=i["縣市"]||"未知";_&&r!==_||(e[n]||(e[n]={}),e[n][a]=(e[n][a]||0)+1,t.add(a))});else if(F){let s=new Set;i.forEach(e=>{let t=F[e];t&&Object.keys(t).forEach(e=>s.add(e))}),s.forEach(e=>t.add(e)),i.forEach(t=>{let i=F[t];i&&(e[t]=i)})}let s=Array.from(t).sort(),n={},a=0;s.forEach(e=>n[e]=0);let r=i.map(t=>{let i=e[t]||{},r=0,l=s.map(e=>{let t=i[e]||0;return r+=t,n[e]+=t,t});return a+=r,{roomType:t,cells:l,rowTotal:r}});return{locations:s,rows:r,locationTotals:n,grandTotal:a}}return null},[F,R,i,j,_]),[O,B]=(0,n.useState)(new Set),Z=(0,n.useMemo)(()=>L?L.rows.map(e=>{let t={房型:e.roomType};return L.locations.forEach((i,s)=>{t[i]=e.cells[s]}),t["總計"]=e.rowTotal,t}):[],[L]),W=e=>C.filter(t=>t.roomType===e).sort((e,t)=>(Number(e.bathrooms)||0)-(Number(t.bathrooms)||0)),U=(0,n.useMemo)(()=>{if(!E)return I;let e=[];return I.forEach(t=>{if(e.push(t),O.has(t.roomType)){let i=W(t.roomType);e.push(...i)}}),e},[I,E,O,C]);return(0,s.jsxs)("div",{className:"space-y-6 animate-in fade-in slide-in-from-bottom-4 duration-500",children:[(0,s.jsxs)("div",{id:"room-type-filter-anchor",className:"p-4 bg-zinc-900/30 border border-white/5 rounded-lg flex flex-col sm:flex-row sm:flex-wrap items-start sm:items-center justify-between gap-3 sm:gap-4 scroll-mt-24",children:[(0,s.jsxs)("div",{className:"w-full sm:w-auto flex flex-wrap items-center gap-2",children:[(0,s.jsx)("span",{className:"text-zinc-400 text-sm whitespace-nowrap shrink-0 mr-1",children:"分析房型:"}),(0,s.jsx)("div",{className:"flex flex-wrap gap-1.5 sm:gap-2",children:h.M.map(e=>(0,s.jsx)("button",{onClick:()=>{l(i.includes(e)?i.filter(t=>t!==e):[...i,e])},className:(0,d.cn)("px-3 py-1 rounded-full text-xs font-medium transition-colors border",i.includes(e)?"bg-violet-500/20 border-violet-500 text-violet-200":"bg-zinc-800 border-zinc-700 text-zinc-500 hover:bg-zinc-700"),children:e},e))})]}),(0,s.jsxs)("div",{className:"flex items-center gap-2 bg-zinc-800/50 p-1 rounded-lg border border-white/5 ml-auto sm:ml-0",children:[(0,s.jsx)("span",{className:"text-xs text-zinc-400 pl-2",children:"表格顯示:"}),(0,s.jsx)("button",{onClick:()=>D(!E),className:(0,d.cn)("px-3 py-1 text-xs font-medium rounded-md transition-all whitespace-nowrap",E?"bg-violet-500 text-white shadow-sm":"text-zinc-400 hover:text-white hover:bg-zinc-700"),children:E?"依房型合併":"顯示衛浴細節"})]})]}),t.includes("chart")&&(0,s.jsx)(a.c,{title:"各房型總價帶分佈箱型圖",description:"顯示各房型總價的中位數與四分位距",containerRef:u,headerAction:(0,s.jsx)(m.N,{data:I,filename:"price_band_chart_data",label:"匯出",chartType:"price-band-chart",targetRef:u,snapshotData:I,columns:{roomType:"房型",bathrooms:"衛浴",minPrice:"最低價",q1Price:"Q1",medianPrice:"中位數",q3Price:"Q3",maxPrice:"最高價",avgPrice:"平均價",count:"筆數"}}),children:(0,s.jsx)(r.B,{data:I})}),t.includes("table")&&(0,s.jsx)(a.c,{title:"總價帶詳細數據",description:E?"各房型合併統計 (點擊「全部」可展開細節)":"各房型詳細價格統計",containerRef:f,headerAction:(0,s.jsx)(m.N,{data:U,filename:"price_band_detail_data",label:"匯出",chartType:"price-band-table",targetRef:f,snapshotData:U,columns:{roomType:"房型",bathrooms:"衛浴",minPrice:"最低價",q1Price:"Q1",medianPrice:"中位數",q3Price:"Q3",maxPrice:"最高價",avgPrice:"平均價",count:"筆數"}}),children:(0,s.jsx)("div",{className:"overflow-x-auto",children:(0,s.jsxs)("table",{className:"w-full text-sm text-left",children:[(0,s.jsx)("thead",{className:"bg-zinc-900/80 text-zinc-400 uppercase text-xs font-semibold",children:(0,s.jsxs)("tr",{children:[(0,s.jsx)("th",{className:"px-4 py-3",children:"房型"}),(0,s.jsx)("th",{className:"px-4 py-3",children:"衛浴"}),(0,s.jsx)("th",{className:"px-4 py-3 whitespace-nowrap min-w-[100px]",children:"建案數"}),(0,s.jsx)("th",{className:"px-4 py-3 whitespace-nowrap",children:"筆數"}),(0,s.jsx)("th",{className:"px-4 py-3 whitespace-nowrap",children:"平均總價"}),(0,s.jsx)("th",{className:"px-4 py-3",children:"最低總價"}),(0,s.jsx)("th",{className:"px-4 py-3",children:"1/4位總價"}),(0,s.jsx)("th",{className:"px-4 py-3 text-violet-400",children:"中位數總價"}),(0,s.jsx)("th",{className:"px-4 py-3",children:"3/4位總價"}),(0,s.jsx)("th",{className:"px-4 py-3",children:"最高總價"})]})}),(0,s.jsxs)("tbody",{className:"divide-y divide-white/5",children:[I.map((e,t)=>{let i=E&&null===e.bathrooms,a=O.has(e.roomType),r=i&&a?W(e.roomType):[];return(0,s.jsxs)(n.Fragment,{children:[(0,s.jsxs)("tr",{className:(0,d.cn)("hover:bg-zinc-800/50 transition-colors",a&&"bg-zinc-800/30"),children:[(0,s.jsx)("td",{className:"px-4 py-3 font-medium text-white",children:e.roomType}),(0,s.jsx)("td",{className:"px-4 py-3 text-zinc-400",children:i?(0,s.jsxs)("button",{onClick:()=>{var t;return t=e.roomType,void B(e=>{let i=new Set(e);return i.has(t)?i.delete(t):i.add(t),i})},className:"flex items-center gap-1 text-xs px-2 py-0.5 rounded bg-zinc-700/50 hover:bg-zinc-600 hover:text-white transition-colors cursor-pointer",children:[(0,s.jsx)("span",{children:"全部"}),(0,s.jsx)("span",{className:(0,d.cn)("transform transition-transform text-[10px]",a?"rotate-180":""),children:"▼"})]}):e.bathrooms??"-"}),(0,s.jsx)("td",{className:"px-4 py-3",children:e.projectNames&&e.projectNames.length>0?(0,s.jsxs)("button",{onClick:()=>M(e.roomType,e.bathrooms,e.projectNames||[]),className:"px-2 py-1 text-xs font-medium rounded-full bg-violet-500/20 border border-violet-500/50 text-violet-300 hover:bg-violet-500/30 transition-colors cursor-pointer whitespace-nowrap",children:[e.projectNames.length," 建案"]}):(0,s.jsx)("span",{className:"text-zinc-500",children:"-"})}),(0,s.jsx)("td",{className:"px-4 py-3 text-zinc-300",children:e.count.toLocaleString()}),(0,s.jsx)("td",{className:"px-4 py-3 font-mono text-zinc-300",children:e.avgPrice.toLocaleString(void 0,{maximumFractionDigits:0})}),(0,s.jsx)("td",{className:"px-4 py-3 font-mono text-zinc-500",children:e.minPrice.toLocaleString()}),(0,s.jsx)("td",{className:"px-4 py-3 font-mono text-zinc-500",children:e.q1Price.toLocaleString()}),(0,s.jsx)("td",{className:"px-4 py-3 font-mono text-violet-400 font-bold",children:e.medianPrice.toLocaleString()}),(0,s.jsx)("td",{className:"px-4 py-3 font-mono text-zinc-500",children:e.q3Price.toLocaleString()}),(0,s.jsx)("td",{className:"px-4 py-3 font-mono text-zinc-500",children:e.maxPrice.toLocaleString()})]}),r.map((e,i)=>(0,s.jsxs)("tr",{className:"bg-zinc-900/50 hover:bg-zinc-900 border-l-2 border-l-violet-500/30",children:[(0,s.jsxs)("td",{className:"px-4 py-2 font-medium text-zinc-500 text-xs pl-8",children:["↳ ",e.roomType]}),(0,s.jsxs)("td",{className:"px-4 py-2 text-zinc-400 text-xs",children:[e.bathrooms," 衛"]}),(0,s.jsx)("td",{className:"px-4 py-2",children:e.projectNames&&e.projectNames.length>0?(0,s.jsxs)("button",{onClick:()=>M(e.roomType,e.bathrooms,e.projectNames||[]),className:"text-xs text-zinc-500 hover:text-zinc-300 underline decoration-zinc-700",children:[e.projectNames.length," 建案"]}):"-"}),(0,s.jsx)("td",{className:"px-4 py-2 text-zinc-500 text-xs",children:e.count.toLocaleString()}),(0,s.jsx)("td",{className:"px-4 py-2 font-mono text-zinc-500 text-xs",children:e.avgPrice.toLocaleString(void 0,{maximumFractionDigits:0})}),(0,s.jsx)("td",{className:"px-4 py-2 font-mono text-zinc-600 text-xs",children:e.minPrice.toLocaleString()}),(0,s.jsx)("td",{className:"px-4 py-2 font-mono text-zinc-600 text-xs",children:e.q1Price.toLocaleString()}),(0,s.jsx)("td",{className:"px-4 py-2 font-mono text-zinc-500 text-xs font-medium",children:e.medianPrice.toLocaleString()}),(0,s.jsx)("td",{className:"px-4 py-2 font-mono text-zinc-600 text-xs",children:e.q3Price.toLocaleString()}),(0,s.jsx)("td",{className:"px-4 py-2 font-mono text-zinc-600 text-xs",children:e.maxPrice.toLocaleString()})]},`${t}-sub-${i}`))]},t)}),0===T.length&&(0,s.jsx)("tr",{children:(0,s.jsx)("td",{colSpan:10,className:"p-8 text-center text-zinc-500",children:"請選擇房型顯示數據"})})]})]})})}),(L||R)&&(0,s.jsxs)("div",{className:"space-y-6 pt-4 border-t border-white/5",children:[(0,s.jsxs)("div",{className:"flex items-center justify-between",children:[(0,s.jsx)("h3",{className:"text-lg font-semibold text-white",children:"區域分組交叉分析"}),(0,s.jsxs)("div",{className:"flex bg-zinc-800 rounded-md p-0.5",children:[(0,s.jsx)("button",{onClick:()=>v("district"),className:(0,d.cn)("px-2 py-1 text-xs rounded transition-colors","district"===j?"bg-zinc-700 text-white":"text-zinc-400 hover:text-white"),children:"行政區"}),(0,s.jsx)("button",{onClick:()=>v("county"),className:(0,d.cn)("px-2 py-1 text-xs rounded transition-colors","county"===j?"bg-zinc-700 text-white":"text-zinc-400 hover:text-white"),children:"縣市"})]})]}),"district"===j&&A.length>1&&(0,s.jsxs)("div",{className:"flex items-center gap-2 pb-2",children:[(0,s.jsx)("span",{className:"text-sm text-zinc-500",children:"顯示縣市:"}),(0,s.jsx)("div",{className:"flex gap-1 bg-zinc-900 p-1 rounded-lg",children:A.map(e=>(0,s.jsx)("button",{onClick:()=>P(e),className:(0,d.cn)("px-3 py-1 text-xs font-medium rounded-md transition-all",_===e?"bg-violet-500/20 text-violet-300 shadow-sm border border-violet-500/50":"text-zinc-500 hover:text-zinc-300 hover:bg-zinc-800"),children:e},e))})]}),t.includes("location-table")&&(0,s.jsx)(a.c,{title:"區域房型成交分佈",description:"各區域不同房型的成交數量熱力分佈",containerRef:g,headerAction:(0,s.jsx)(m.N,{data:Z,filename:"price_band_location_cross_table",label:"匯出",chartType:"price-band-location-table",targetRef:g,snapshotData:L}),children:(0,s.jsx)("div",{className:"overflow-x-auto",children:L?(0,s.jsxs)("table",{className:"w-full text-sm text-left border-collapse",children:[(0,s.jsx)("thead",{className:"bg-zinc-900/80 text-zinc-400 font-semibold",children:(0,s.jsxs)("tr",{children:[(0,s.jsx)("th",{className:"px-3 py-2 sticky left-0 bg-zinc-900 z-10 border-r border-white/5",children:"房型"}),L.locations.map(e=>(0,s.jsx)("th",{className:"px-3 py-2 text-center min-w-[80px]",children:e},e)),(0,s.jsx)("th",{className:"px-3 py-2 text-center border-l border-white/5 bg-zinc-900 font-bold text-white",children:"總計"})]})}),(0,s.jsx)("tbody",{className:"divide-y divide-white/5",children:L.rows.map((e,t)=>(0,s.jsxs)("tr",{className:"hover:bg-zinc-800/30",children:[(0,s.jsx)("td",{className:"px-3 py-2 font-medium text-zinc-300 sticky left-0 bg-zinc-950/90 border-r border-white/5",children:e.roomType}),e.cells.map((e,t)=>{let i=e>0?Math.min(e/20,1):0,n=e>0?{backgroundColor:`rgba(6, 182, 212, ${.3*i})`}:{};return(0,s.jsx)("td",{className:"px-3 py-2 text-center text-zinc-400",style:n,children:e>0?e:"-"},t)}),(0,s.jsx)("td",{className:"px-3 py-2 text-center font-bold text-white border-l border-white/5 bg-zinc-900/50",children:e.rowTotal})]},t))}),(0,s.jsx)("tfoot",{className:"bg-zinc-900 font-bold border-t-2 border-zinc-700",children:(0,s.jsxs)("tr",{children:[(0,s.jsx)("td",{className:"px-3 py-2 sticky left-0 bg-zinc-900 border-r border-white/5 text-white",children:"總計"}),L.locations.map(e=>(0,s.jsx)("td",{className:"px-3 py-2 text-center text-white",children:L.locationTotals[e]},e)),(0,s.jsx)("td",{className:"px-3 py-2 text-center text-cyan-400 border-l border-white/5 bg-zinc-900",children:L.grandTotal})]})})]}):(0,s.jsx)("div",{className:"p-8 text-center text-zinc-500",children:"無區域分佈數據"})})}),t.includes("location-chart")&&(0,s.jsx)(a.c,{title:"區域成交佔比圖表",containerRef:b,headerAction:(0,s.jsx)(m.N,{data:Z,filename:"price_band_location_chart_data",label:"匯出",chartType:"price-band-location-chart",targetRef:b,snapshotData:L}),children:L&&(0,s.jsx)(c,{roomTypes:i,locations:L.locations,crossTable:L.rows.reduce((e,t)=>{let i={};return L.locations.forEach((e,s)=>{i[e]=t.cells[s]}),e[t.roomType]=i,e},{}),dimension:j})})]}),(0,s.jsx)(x,{isOpen:y,onClose:()=>N(!1),title:w,projects:k}),(0,s.jsx)(x,{isOpen:y,onClose:()=>N(!1),title:w,projects:k}),(0,s.jsx)(p.K,{})]})}},78795:(e,t,i)=>{i.d(t,{N:()=>k});var s=i(95155),n=i(98500),a=i.n(n),r=i(12115),l=i(73321),c=i(6296),o=i(25777),d=i(6962),x=i(66088),m=i(95057),h=i(89239),p=i(16385),u=i(96066),f=i(70872),g=i(61108),b=i(40980);function j({...e}){return(0,s.jsx)(g.bL,{"data-slot":"dropdown-menu",...e})}function v({...e}){return(0,s.jsx)(g.l9,{"data-slot":"dropdown-menu-trigger",...e})}function y({className:e,sideOffset:t=4,...i}){return(0,s.jsx)(g.ZL,{children:(0,s.jsx)(g.UC,{"data-slot":"dropdown-menu-content",sideOffset:t,className:(0,b.cn)("bg-popover text-popover-foreground data-[state=open]:animate-in data-[state=closed]:animate-out data-[state=closed]:fade-out-0 data-[state=open]:fade-in-0 data-[state=closed]:zoom-out-95 data-[state=open]:zoom-in-95 data-[side=bottom]:slide-in-from-top-2 data-[side=left]:slide-in-from-right-2 data-[side=right]:slide-in-from-left-2 data-[side=top]:slide-in-from-bottom-2 z-50 max-h-(--radix-dropdown-menu-content-available-height) min-w-[8rem] origin-(--radix-dropdown-menu-content-transform-origin) overflow-x-hidden overflow-y-auto rounded-md border p-1 shadow-md",e),...i})})}function N({className:e,inset:t,variant:i="default",...n}){return(0,s.jsx)(g.q7,{"data-slot":"dropdown-menu-item","data-inset":t,"data-variant":i,className:(0,b.cn)("focus:bg-accent focus:text-accent-foreground data-[variant=destructive]:text-destructive data-[variant=destructive]:focus:bg-destructive/10 dark:data-[variant=destructive]:focus:bg-destructive/20 data-[variant=destructive]:focus:text-destructive data-[variant=destructive]:*:[svg]:!text-destructive [&_svg:not([class*='text-'])]:text-muted-foreground relative flex cursor-default items-center gap-2 rounded-sm px-2 py-1.5 text-sm outline-hidden select-none data-[disabled]:pointer-events-none data-[disabled]:opacity-50 data-[inset]:pl-8 [&_svg]:pointer-events-none [&_svg]:shrink-0 [&_svg:not([class*='size-'])]:size-4",e),...n})}var w=i(66609),z=i(98028);function k({data:e,filename:t="export",label:i="匯出",className:n,disabled:g=!1,columns:k,chartType:S,snapshotData:_,targetRef:P}){let{role:A,isLoading:M}=function(){let[e,t]=(0,r.useState)(null),[i,s]=(0,r.useState)(!0);return(0,r.useEffect)(()=>{let e=!0,i=async()=>{try{let{data:{session:i}}=await p.N.auth.getSession();if(!i?.user){e&&(t(null),s(!1));return}let{data:n,error:a}=await p.N.from("profiles").select("role").eq("id",i.user.id).single();e&&(n?t(n.role):t("user"),s(!1))}catch(i){console.error("Error fetching user role:",i),e&&(t("user"),s(!1))}};i();let{data:{subscription:n}}=p.N.auth.onAuthStateChange((e,s)=>{s?i():t(null)});return()=>{e=!1,n.unsubscribe()}},[]),{role:e,isLoading:i}}(),C=(0,l.useRouter)(),F=(0,u.Q)(e=>e.addItem),$=["pro","pro_max","admin","super_admin"].includes(A||""),R=!M,T=()=>{if(R&&$){if(!e||0===e.length)return void alert("無數據可導出");try{let i=Object.keys(e[0]),s=[i.map(e=>k&&k[e]||e).join(","),...e.map(e=>i.map(t=>{let i=e[t];if(null==i)return"";if("number"==typeof i){let e=k&&k[t]||t;return/Area|坪|Rate|Ratio|Share|Percent|比|率/.test(t)||/Area|坪|Rate|Ratio|Share|Percent|比|率/.test(e)?i.toFixed(2):Math.round(i).toFixed(0)}if("object"==typeof i)try{return`"${JSON.stringify(i).replace(/"/g,'""')}"`}catch(e){return""}return"string"==typeof i?`"${i.replace(/"/g,'""').replace(/\n/g," ")}"`:i}).join(","))].join("\n"),n=new Blob(["\uFEFF"+s],{type:"text/csv;charset=utf-8;"}),a=URL.createObjectURL(n),r=document.createElement("a"),l=new Date().toISOString().split("T")[0],c=`${t}_${l}.csv`;r.href=a,r.setAttribute("download",c),document.body.appendChild(r),r.click(),document.body.removeChild(r),URL.revokeObjectURL(a)}catch(e){console.error("Export failed:",e),alert("匯出失敗，請查看控制台日誌")}}},E=async()=>{if($&&P?.current)try{let e=P.current,i=e.querySelectorAll('[data-export-footer="true"]');i.forEach(e=>{e.style.display="flex"});let s=await (0,z.domToPng)(e,{scale:2,backgroundColor:"#18181b",filter:e=>!(e instanceof HTMLElement&&e.getAttribute("data-html2canvas-ignore"))});i.forEach(e=>{e.style.display="none"});let n=document.createElement("a"),a=new Date().toISOString().split("T")[0];n.href=s,n.download=`${t}_${a}.png`,document.body.appendChild(n),n.click(),document.body.removeChild(n),w.o.success("已成功匯出圖片")}catch(t){console.error("PNG export failed:",t);let e=P.current;e&&e.querySelectorAll('[data-export-footer="true"]').forEach(e=>{e.style.display="none"}),w.o.error("匯出圖片失敗",{description:"請稍後再試或聯繫客服"})}};return M?(0,s.jsxs)(h.$,{variant:"outline",size:"sm",disabled:!0,className:`gap-2 border-dashed border-zinc-700 bg-zinc-900/50 text-zinc-600 ${n}`,children:[(0,s.jsx)(c.A,{className:"h-4 w-4 animate-spin"}),(0,s.jsx)("span",{className:"hidden sm:inline",children:"載入中..."})]}):S?(0,s.jsx)(f.Bc,{children:(0,s.jsxs)(f.m_,{delayDuration:0,children:[(0,s.jsx)(f.k$,{asChild:!0,children:(0,s.jsx)("span",{className:"inline-flex",tabIndex:$?-1:0,children:$?(0,s.jsxs)(j,{children:[(0,s.jsx)(v,{asChild:!0,children:(0,s.jsxs)(h.$,{variant:"outline",size:"sm",disabled:g||!e||0===e.length,className:(0,b.cn)("gap-1.5 border-dashed transition-all border-zinc-700 bg-zinc-900/50 hover:bg-zinc-800 text-zinc-400 hover:text-white",n),children:[(0,s.jsx)(d.A,{className:"h-4 w-4"}),(0,s.jsx)("span",{className:"hidden sm:inline",children:i}),(0,s.jsx)(x.A,{className:"h-3 w-3"})]})}),(0,s.jsxs)(y,{align:"start",className:"min-w-[180px] bg-zinc-900 border-zinc-700",children:[(0,s.jsxs)(N,{onClick:T,className:"flex items-center gap-2 text-zinc-300 hover:text-white focus:text-white cursor-pointer",children:[(0,s.jsx)(d.A,{className:"h-4 w-4 text-zinc-500"}),"匯出 CSV"]}),P&&(0,s.jsxs)(N,{onClick:E,className:"flex items-center gap-2 text-zinc-300 hover:text-white focus:text-white cursor-pointer",children:[(0,s.jsx)("div",{className:"h-4 w-4 flex items-center justify-center text-zinc-500 font-bold text-[10px] border border-zinc-600 rounded",children:"P"}),"匯出 PNG (圖片)"]}),(0,s.jsxs)(N,{onClick:()=>{$&&S&&(F(S,void 0!==_?_:e),w.o.success("已新增至報表編輯器",{description:"請點選左側「生成報告」繼續編輯",action:{label:"前往編輯",onClick:()=>C.push("/reports/builder")}}))},className:"flex items-center gap-2 text-zinc-300 hover:text-violet-300 focus:text-violet-300 hover:bg-violet-600/20 focus:bg-violet-600/20 cursor-pointer",children:[(0,s.jsx)(m.A,{className:"h-4 w-4 text-violet-500"}),"新增到報表編輯器"]})]})]}):(0,s.jsxs)(h.$,{variant:"outline",size:"sm",disabled:!0,className:(0,b.cn)("gap-1.5 border-dashed transition-all border-zinc-800 bg-zinc-900/30 text-zinc-600 cursor-not-allowed hover:bg-zinc-900/30",n),children:[(0,s.jsx)(o.A,{className:"h-3 w-3"}),(0,s.jsx)("span",{className:"hidden sm:inline",children:i})]})})}),!$&&(0,s.jsx)(f.ZI,{className:"bg-zinc-950 border border-zinc-800 p-0 overflow-hidden",children:(0,s.jsxs)("div",{className:"flex flex-col gap-1 items-center p-3",children:[(0,s.jsx)("p",{className:"font-medium text-zinc-200",children:"Pro 會員限定功能"}),(0,s.jsx)(a(),{href:"/pricing",className:"text-xs text-violet-400 hover:text-violet-300 underline underline-offset-2 transition-colors flex items-center gap-1",children:"查看升級方案 →"})]})})]})}):(0,s.jsx)(f.Bc,{children:(0,s.jsxs)(f.m_,{delayDuration:0,children:[(0,s.jsx)(f.k$,{asChild:!0,children:(0,s.jsx)("span",{className:"inline-flex",tabIndex:$?-1:0,children:(0,s.jsxs)(h.$,{variant:"outline",size:"sm",onClick:T,disabled:g||$&&(!e||0===e.length),className:(0,b.cn)("gap-1.5 border-dashed transition-all",$?"border-zinc-700 bg-zinc-900/50 hover:bg-zinc-800 text-zinc-400 hover:text-white":"border-zinc-800 bg-zinc-900/30 text-zinc-600 cursor-not-allowed hover:bg-zinc-900/30",n),children:[$?(0,s.jsx)(d.A,{className:"h-4 w-4"}):(0,s.jsx)(o.A,{className:"h-3 w-3"}),(0,s.jsx)("span",{className:"hidden sm:inline",children:i})]})})}),!$&&(0,s.jsx)(f.ZI,{className:"bg-zinc-950 border border-zinc-800 p-0 overflow-hidden",children:(0,s.jsxs)("div",{className:"flex flex-col gap-1 items-center p-3",children:[(0,s.jsx)("p",{className:"font-medium text-zinc-200",children:"Pro 會員限定功能"}),(0,s.jsx)(a(),{href:"/pricing",className:"text-xs text-violet-400 hover:text-violet-300 underline underline-offset-2 transition-colors flex items-center gap-1",children:"查看升級方案 →"})]})})]})})}},83632:(e,t,i)=>{i.d(t,{U:()=>x});var s=i(95155),n=i(12115),a=i(34361),r=i(88042),l=i(98563),c=i(40980);function o({data:e}){if(!e||0===e.length)return(0,s.jsx)("div",{className:"text-zinc-500 text-center p-8",children:"無符合條件的建案可進行類型比較"});let t=Math.max(...e.map(e=>e.shopMultiple),1),i=Math.max(...e.map(e=>e.officeMultiple),1);return(0,s.jsx)("div",{className:"overflow-x-auto max-h-[600px] overflow-y-auto relative scrollbar-thin scrollbar-thumb-zinc-700 scrollbar-track-transparent",children:(0,s.jsxs)("table",{className:"w-full text-sm text-left",children:[(0,s.jsx)("thead",{className:"sticky top-0 z-10 bg-zinc-900 text-zinc-400 font-semibold uppercase text-xs shadow-md",children:(0,s.jsxs)("tr",{children:[(0,s.jsx)("th",{className:"px-4 py-3 whitespace-nowrap",children:"建案名稱"}),(0,s.jsx)("th",{className:"px-4 py-3 text-right",children:"住宅均價"}),(0,s.jsxs)("th",{className:"px-4 py-3 text-right",children:["店舖均價 ",(0,s.jsx)("span",{className:"text-[10px] text-zinc-500 font-normal ml-1",children:"/ 倍數"})]}),(0,s.jsxs)("th",{className:"px-4 py-3 text-right",children:["事務所均價 ",(0,s.jsx)("span",{className:"text-[10px] text-zinc-500 font-normal ml-1",children:"/ 倍數"})]})]})}),(0,s.jsx)("tbody",{className:"divide-y divide-white/5",children:e.map((e,n)=>(0,s.jsxs)("tr",{className:"hover:bg-zinc-800/30 transition-colors",children:[(0,s.jsxs)("td",{className:"px-4 py-3 whitespace-nowrap",children:[(0,s.jsx)("div",{className:"font-medium text-white",children:e.projectName}),(0,s.jsxs)("div",{className:"text-xs text-zinc-500 flex gap-1 mt-0.5",children:[e.county&&(0,s.jsx)("span",{className:"bg-zinc-800 px-1 rounded",children:e.county}),e.district&&(0,s.jsx)("span",{className:"bg-zinc-800 px-1 rounded",children:e.district})]})]}),(0,s.jsx)("td",{className:"px-4 py-3 text-right font-mono text-zinc-300",children:e.residentialAvg>0?(0,c.Z)(e.residentialAvg):"-"}),(0,s.jsxs)("td",{className:"px-4 py-3 text-right",children:[(0,s.jsx)("div",{className:"font-mono text-zinc-300",children:e.shopAvg>0?(0,c.Z)(e.shopAvg):"-"}),e.shopMultiple>0&&(0,s.jsxs)("div",{className:"flex flex-col gap-1 mt-1.5 w-[80px] ml-auto",children:[(0,s.jsx)("div",{className:"h-1 bg-zinc-800 rounded-full overflow-hidden w-full",children:(0,s.jsx)("div",{className:"h-full bg-violet-600 rounded-full",style:{width:`${Math.min(e.shopMultiple/t*100,100)}%`}})}),(0,s.jsxs)("div",{className:"text-[10px] text-right text-violet-400 font-medium",children:[e.shopMultiple.toFixed(2),"x"]})]})]}),(0,s.jsxs)("td",{className:"px-4 py-3 text-right",children:[(0,s.jsx)("div",{className:"font-mono text-zinc-300",children:e.officeAvg>0?(0,c.Z)(e.officeAvg):"-"}),e.officeMultiple>0&&(0,s.jsxs)("div",{className:"flex flex-col gap-1 mt-1.5 w-[80px] ml-auto",children:[(0,s.jsx)("div",{className:"h-1 bg-zinc-800 rounded-full overflow-hidden w-full",children:(0,s.jsx)("div",{className:"h-full bg-cyan-600 rounded-full",style:{width:`${Math.min(e.officeMultiple/i*100,100)}%`}})}),(0,s.jsxs)("div",{className:"text-[10px] text-right text-cyan-400 font-medium",children:[e.officeMultiple.toFixed(2),"x"]})]})]})]},n))})]})})}var d=i(78795);function x({data:e,visibleSections:t=["stats","comparison","chart"]}){let[i,x]=(0,n.useState)("weighted"),[m,h]=(0,n.useState)(30),[p,u]=(0,n.useState)(150),[f,g]=(0,n.useState)(5),[b,j]=(0,n.useState)("count"),v=n.useRef(null),y=n.useRef(null),N=n.useRef(null),w=e?.transactionDetails||[],z=e?.unitPriceAnalysis,k=z?.residentialStats,S=z?.officeStats,_=z?.storeStats,P=z?.typeComparison;return e&&(w.length||z)?(0,s.jsxs)("div",{className:"space-y-8 animate-in fade-in slide-in-from-bottom-4 duration-500",children:[t.includes("stats")&&(0,s.jsx)(a.c,{title:"各用途單價統計",containerRef:v,headerAction:(0,s.jsxs)("div",{className:"flex items-center gap-4",children:[(0,s.jsxs)("div",{className:"flex items-center gap-2",children:[(0,s.jsx)("span",{className:"text-zinc-400 text-xs",children:"平均類型:"}),(0,s.jsxs)("div",{className:"flex bg-zinc-950/50 rounded-md p-1 border border-white/5",children:[(0,s.jsx)("button",{onClick:()=>x("arithmetic"),className:(0,c.cn)("px-2 py-0.5 text-[10px] rounded transition-colors","arithmetic"===i?"bg-violet-500 text-white":"text-zinc-500 hover:text-white"),children:"算術"}),(0,s.jsx)("button",{onClick:()=>x("weighted"),className:(0,c.cn)("px-2 py-0.5 text-[10px] rounded transition-colors","weighted"===i?"bg-violet-500 text-white":"text-zinc-500 hover:text-white"),children:"加權"})]})]}),(0,s.jsx)(d.N,{data:[k,S,_],filename:"unit_price_stats",label:"匯出",chartType:"unit-price-stats",targetRef:v,snapshotData:{residentialStats:k,officeStats:S,storeStats:_,averageType:i}})]}),children:(0,s.jsxs)("div",{className:"grid grid-cols-1 md:grid-cols-3 gap-6",children:[(0,s.jsx)(l.E,{title:"住宅建案統計",stats:k,noDataMessage:"無住宅交易數據",className:"border-violet-500/20",averageType:i}),(0,s.jsx)(l.E,{title:"一般事務所/辦公室統計",stats:S,noDataMessage:"無事務所/辦公室交易數據",className:"border-cyan-500/20",averageType:i}),(0,s.jsx)(l.E,{title:"店舖統計",stats:_,noDataMessage:"無店舖交易數據",className:"border-amber-500/20",averageType:i})]})}),(0,s.jsxs)("div",{className:"flex flex-col lg:flex-row gap-6 items-stretch",children:[t.includes("comparison")&&P&&P.length>0&&(0,s.jsx)("div",{className:"flex-1 min-w-0 flex flex-col",children:(0,s.jsx)(a.c,{title:"建案產品類型單價比較",description:"同一建案內不同用途（住宅/店面/事務所）的單價與倍數比較",containerRef:y,headerAction:(0,s.jsx)(d.N,{data:P,filename:"type_comparison_data",label:"匯出",chartType:"type-comparison-table",targetRef:y,snapshotData:P,columns:{projectName:"建案",residentialAvg:"住宅均價",officeAvg:"辦公均價",storeAvg:"店舖均價",officeRatio:"辦公倍數",storeRatio:"店舖倍數"}}),className:"h-full",children:(0,s.jsx)(o,{data:P})})}),t.includes("chart")&&(0,s.jsx)("div",{className:"flex-1 min-w-0 flex flex-col",children:(0,s.jsx)(a.c,{title:"單價分佈泡泡圖",description:"分析各單價區間的成交熱度與分佈密集區",containerRef:N,headerAction:(0,s.jsx)(d.N,{data:w,filename:"bubble_chart_source_data",label:"匯出",chartType:"unit-price-bubble",targetRef:N,snapshotData:w}),className:"h-full",children:(0,s.jsx)(r.$,{data:w,minPrice:m,maxPrice:p,interval:f,sizeMetric:b,onMinPriceChange:h,onMaxPriceChange:u,onIntervalChange:g,onSizeMetricChange:j})})})]})]}):null}}}]);