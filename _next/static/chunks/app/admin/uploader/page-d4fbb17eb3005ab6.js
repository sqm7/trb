(self.webpackChunk_N_E=self.webpackChunk_N_E||[]).push([[4885],{19246:(e,t,s)=>{Promise.resolve().then(s.bind(s,88640))},88640:(e,t,s)=>{"use strict";s.r(t),s.d(t,{default:()=>ep});var r=s(95155),a=s(39092),l=s.n(a),i=s(12115),n=s(16385),d=s(59386),c=s.n(d);let o={A:"臺北市",B:"臺中市",C:"基隆市",D:"臺南市",E:"高雄市",F:"新北市",G:"宜蘭縣",H:"桃園市",I:"嘉義市",J:"新竹縣",K:"苗栗縣",M:"南投縣",N:"彰化縣",O:"新竹市",P:"雲林縣",Q:"嘉義縣",T:"屏東縣",U:"花蓮縣",V:"臺東縣",W:"金門縣",X:"澎湖縣",Z:"連江縣"},f={a:{編號:"編號",鄉鎮市區:"行政區",交易標的:"交易標的",土地位置建物門牌:"地址",交易年月日:"交易日",交易筆棟數:"交易筆棟數",移轉層次:"樓層",建物型態:"建物型態",主要用途:"主要用途",建物移轉總面積平方公尺:"產權面積_房車","建物現況格局-房":"房數","建物現況格局-廳":"廳數","建物現況格局-衛":"衛浴數",總價元:"交易總價",車位類別:"車位類別",車位移轉總面積平方公尺:"車位總面積",車位總價元:"車位總價",備註:"備註",主建物面積:"主建物面積",附屬建物面積:"附屬建物面積",陽台面積:"陽台面積"},a_build:{編號:"編號",屋齡:"交易屋齡",主要建材:"結構",建築完成年月日:"完工日",建築完成日期:"完工日",總層數:"總樓層",移轉情形:"移轉情形"},a_land:{編號:"編號",土地位置:"地號_段",地號:"地號",土地移轉面積平方公尺:"土地持分面積",使用分區或編定:"使用分區",非都市土地使用分區:"使用分區",權利人持分分母:"持分分母",權利人持分分子:"持分分子"},a_park:{編號:"編號",車位類別:"車位類別",車位價格:"車位價格",車位面積平方公尺:"車位面積",車位所在樓層:"車位樓層"},b:{編號:"編號",鄉鎮市區:"行政區",交易標的:"交易標的",土地位置建物門牌:"地址","土地位置/建物門牌":"地址",交易年月日:"交易日",交易筆棟數:"交易筆棟數",移轉層次:"樓層",總層數:"總樓層",總樓層數:"總樓層",建物型態:"建物型態",主要用途:"主要用途",建物移轉總面積平方公尺:"產權面積_房車","建物移轉總面積(平方公尺)":"產權面積_房車","建物現況格局-房":"房數","建物現況格局-廳":"廳數","建物現況格局-衛":"衛浴數","建物現況格局-隔間":"建物現況格局-隔間",主要建材:"主要建材",建築完成年月:"建築完成年月",有無管理組織:"有無管理組織","有無備註欄(Y/N)":"有無備註欄",有無備註欄:"有無備註欄","土地移轉總面積(平方公尺)":"土地移轉總面積",都市土地使用分區:"都市土地使用分區",非都市土地使用分區:"非都市土地使用分區",非都市土地使用編定:"非都市土地使用編定",總價元:"交易總價","總價(元)":"交易總價","單價(元/平方公尺)":"單價(元/平方公尺)",車位類別:"車位類別",車位移轉總面積平方公尺:"車位總面積","車位移轉總面積(平方公尺)":"車位總面積",車位總價元:"車位總價","車位總價(元)":"車位總價",交易標的橫坐標:"交易標的橫坐標",交易標的縱坐標:"交易標的縱坐標",備註:"備註",建案名稱:"建案名稱",棟及號:"戶別",解約情形:"解約情形"},b_land:{編號:"編號",土地位置:"地號_段",地號:"地號",土地移轉面積平方公尺:"土地持分面積",使用分區或編定:"使用分區",非都市土地使用分區:"使用分區",權利人持分分母:"持分分母",權利人持分分子:"持分分子",移轉情形:"移轉情形"},b_park:{編號:"編號",車位類別:"車位類別",車位價格:"車位價格",車位面積平方公尺:"車位面積",車位所在樓層:"車位樓層"},c:{編號:"編號",鄉鎮市區:"行政區",交易標的:"交易標的",土地位置建物門牌:"地址",租賃年月日:"交易日",租賃筆棟數:"交易筆棟數",租賃層次:"樓層",建物型態:"建物型態",主要用途:"主要用途",建物總面積平方公尺:"租賃面積","建物現況格局-房":"房數","建物現況格局-廳":"廳數","建物現況格局-衛":"衛浴數",總額元:"交易總價",車位類別:"車位類別",車位面積平方公尺:"車位總面積",車位總額元:"車位總價",備註:"備註",出租型態:"出租型態",租賃期間:"租賃期間",附屬設備:"附屬設備",租賃住宅服務:"租賃住宅服務"},c_build:{編號:"編號",屋齡:"交易屋齡",主要建材:"結構",建築完成年月日:"完工日",建築完成日期:"完工日",總層數:"總樓層",移轉情形:"移轉情形"},c_land:{編號:"編號",土地位置:"地號_段",地號:"地號",土地移轉面積平方公尺:"土地租賃面積",使用分區或編定:"使用分區",非都市土地使用分區:"使用分區"},c_park:{編號:"編號",車位類別:"車位類別",車位價格:"車位價格",車位面積平方公尺:"車位面積",車位所在樓層:"車位樓層"}};function x(e){if("string"!=typeof e&&"number"!=typeof e)return null;let t=parseFloat(String(e).replace(/,/g,""));return isNaN(t)?null:t}function m(e){if(!e)return e;let t=e.replace(/\u0000/g,""),s="";for(let e=0;e<t.length;e+=1){let r=t.charCodeAt(e);if(r>=55296&&r<=56319){let r=t.charCodeAt(e+1);r>=56320&&r<=57343&&(s+=t[e]+t[e+1],e+=1);continue}r>=56320&&r<=57343||(s+=t[e])}return s}function u(e){if(null==e)return null;let t=String(e).trim();return t.length>0?t:null}function h(e){let t=Object.keys(e).sort();return JSON.stringify(e,t)}function g(e){let t=5381;for(let s=0;s<e.length;s+=1)t=(t<<5)+t+e.charCodeAt(s);return(t>>>0).toString(16)}function b(e){return"edit"===e?3:"list"===e?2:1}let p=null,j=new Map;async function y(){if(p)return p;let e=await Promise.all([s.e(3524),s.e(8436)]).then(s.bind(s,15967));return p=e?.default??e}async function w(e,t=""){let s=[];for await(let r of e.values()){let e=t?`${t}/${r.name}`:r.name;if("file"===r.kind){let t=r.name.toLowerCase();if(t.endsWith(".csv")){let t=/^([a-z])_lvr_land_([a-c](?:_build|_land|_park)?)\.csv$/i,a=r.name.match(t);a&&s.push({handle:r,name:r.name,fullPath:e,countyCode:a[1].toLowerCase(),tableType:a[2].toLowerCase(),isMain:!a[2].includes("_"),sourceType:"opendata",sourcePriority:b("opendata")})}else if(t.endsWith(".xls")||t.endsWith(".xlsx")){let t=/^(list|edit)_([a-z])\d+_\d+\.(xls|xlsx)$/i,a=r.name.match(t);if(a){let t=a[1].toLowerCase(),l=a[2].toLowerCase(),i=await r.getFile(),n=await i.arrayBuffer(),d=await y(),c=d.read(n,{type:"array"});for(let a of(j.set(r,c),c.SheetNames)){let i=c.Sheets[a],n=function(e,t){if(e.includes("預售"))return"b";if(e.includes("停車位"))return"b_park";if(e.startsWith("土地"))return"b_land";let s=new Set(t);return s.has("車位價格")&&s.has("車位面積平方公尺")?"b_park":s.has("土地位置")&&s.has("地號")?"b_land":s.has("建案名稱")&&s.has("總價(元)")?"b":null}(a,(d.utils.sheet_to_json(i,{header:1,raw:!0,defval:""})[0]||[]).map(e=>String(e).trim()).filter(e=>e));n&&s.push({handle:r,name:r.name,fullPath:`${e}#${a}`,countyCode:l,tableType:n,isMain:"b"===n,sourceType:t,sourcePriority:b(t),sheetName:a})}}}}else"directory"===r.kind&&s.push(...await w(r,e))}return s}async function N(e,t,s){let r=e.handle,a=await r.getFile(),l=[];if(a.name.toLowerCase().endsWith(".csv")){let t=await new Promise(e=>{c().parse(a,{header:!0,skipEmptyLines:!0,transformHeader:e=>e.trim(),complete:e})});if(t.errors&&t.errors.length>0){let r=["TooManyFields","TooFewFields","MissingQuotes"],a=t.errors.filter(e=>!r.includes(e.code));if(a.length>0)throw Error(`CSV 嚴重解析錯誤: ${a[0].message}`);s&&t.errors.forEach(t=>{s(`檔案 ${e.fullPath} 有解析警告 (已忽略): ${t.message} (行: ${(t.row||0)+2})`,"warning")})}if(!t.data||0===t.data.length)return[];l=t.data}else if(a.name.toLowerCase().endsWith(".xls")||a.name.toLowerCase().endsWith(".xlsx")){if(!e.sheetName)throw Error(`檔案 ${e.name} 缺少分頁資訊，無法解析。`);let t=await y(),s=j.get(r);if(!s){let e=await a.arrayBuffer();s=t.read(e,{type:"array"}),j.set(r,s)}let i=s.Sheets[e.sheetName];if(!i)throw Error(`檔案 ${e.name} 找不到分頁 ${e.sheetName}`);let n=t.utils.sheet_to_json(i,{header:1,raw:!0,defval:""}),d=(n[0]||[]).map(e=>String(e).trim());l=n.slice(1).map(e=>{let t={};return d.forEach((s,r)=>{s&&(t[s]=e[r])}),t}).filter(e=>!Object.values(e).every(e=>null==e||""===e))}else throw Error(`不支援的檔案格式: ${e.name}`);if(!l||0===l.length)return[];l[0]["編號"]?.toLowerCase?.().includes("serial number")&&l.shift();let i=f[e.tableType];if(!i)throw Error(`檔案 ${e.name} 找不到對應的欄位規則。`);let n=l.map(t=>{let s=function(e,t){let s={};Array.from(new Set(Object.values(t))).forEach(e=>s[e]=null);let r=null,a=null;for(let l in e){let i=t[l.trim()];if(i){let t=e[l];if(void 0===t||""===t||null===t)continue;"樓層"===i||"總樓層"===i?s[i]=function(e){if(null==e||""===e)return null;if("number"==typeof e&&Number.isFinite(e))return e;if("string"!=typeof e)return null;let t=String(e).trim().replace(/層|樓/g,"").replace(/[ＦF]$/g,"").replace(/[－–—]/g,"-").replace(/^負/,"-").replace(/^负/,"-"),s={一:1,二:2,三:3,四:4,五:5,六:6,七:7,八:8,九:9,十:10};if(/^-?\d+$/.test(t))return parseInt(t,10);if(/^b\d+$/i.test(t))return-parseInt(t.slice(1),10);if(t.includes("地下")){let e=t.replace("地下","");return/^\d+$/.test(e)?-parseInt(e,10):-(s[e.replace(/層|樓/g,"")]||1)}let r=0;if(t.startsWith("十"))r=10+(s[t[1]]||0);else if(t.includes("十")){let e=t.split("十");r=10*(s[e[0]]||1)+(s[e[1]]||0)}else r=s[t]||0;return r>0?r:null}(t):i.includes("日")?s[i]=function(e){if(!e)return null;let t=String(e).match(/(\d{2,3})[^\d]*(\d{1,2})[^\d]*(\d{1,2})/);if(!t)return null;try{let e=parseInt(t[1],10),s=parseInt(t[2],10),r=parseInt(t[3],10);if(isNaN(e)||isNaN(s)||isNaN(r))return null;let a=e+1911,l=String(s).padStart(2,"0"),i=String(r).padStart(2,"0"),n=new Date(`${a}-${l}-${i}`);if(isNaN(n.getTime())||n.getDate()!==r)return null;return`${a}-${l}-${i}`}catch(e){return null}}(String(t)):["交易總價","車位總價","房數","廳數","衛浴數","持分分母","持分分子","交易屋齡","車位價格","單價(元/平方公尺)"].includes(i)?s[i]=x(t):"交易標的橫坐標"===i?(r=x(t),s[i]=r):"交易標的縱坐標"===i?(a=x(t),s[i]=a):i.includes("面積")?s[i]=x(t):s[i]=m(String(t))}}if(null!==r&&null!==a){let e=function(e,t){if(!isFinite(e)||!isFinite(t))return null;let s=Math.sqrt(1-40408299984659.16/0x24ffb2985f71),r=s*s/(1-s*s),a=(t-0)/.9999/(6378137*(1-Math.pow(s,2)/4-3*Math.pow(s,4)/64-5*Math.pow(s,6)/256)),l=(1-Math.sqrt(1-s*s))/(1+Math.sqrt(1-s*s)),i=a+(3*l/2-27*Math.pow(l,3)/32)*Math.sin(2*a)+(21*Math.pow(l,2)/16-55*Math.pow(l,4)/32)*Math.sin(4*a)+151*Math.pow(l,3)/96*Math.sin(6*a)+1097*Math.pow(l,4)/512*Math.sin(8*a),n=Math.sin(i),d=Math.cos(i),c=Math.tan(i),o=r*d*d,f=c*c,x=6378137*(1-s*s)/Math.pow(1-s*s*n*n,1.5),m=6378137/Math.sqrt(1-s*s*n*n),u=(e-25e4)/(.9999*m);return{lat:180*(i-m*c/x*(u*u/2-(5+3*f+10*o-4*o*o-9*r)*Math.pow(u,4)/24+(61+90*f+298*o+45*f*f-252*r-3*o*o)*Math.pow(u,6)/720))/Math.PI,lng:180*(121*Math.PI/180+(u-(1+2*f+o)*Math.pow(u,3)/6+(5-2*o+28*f-3*o*o+8*r+24*f*f)*Math.pow(u,5)/120)/d)/Math.PI}}(r,a);e&&(s["交易標的經度"]=e.lng,s["交易標的緯度"]=e.lat)}return s}(t,i);return e.tableType.startsWith("b")&&(s.data_source=e.sourceType,s.source_priority=e.sourcePriority),s});if(t&&t.size>0){let e=0;n=n.map(s=>{let r=s["建案名稱"];if(r&&t.has(r)){let a=t.get(r);a&&(s["建案名稱"]=a,e++)}return s}),e>0&&s&&s(`已自動替換 ${e} 筆建案名稱`,"info")}let d=0;return n=n.map(e=>{let{record:t,changed:s}=function(e){let t=!1,s={};for(let[r,a]of Object.entries(e))if("string"==typeof a){let e=m(a);s[r]=e,e!==a&&(t=!0)}else s[r]=a;return{record:s,changed:t}}(e);return s&&(d+=1),t}),d>0&&s&&s(`檔案 ${e.fullPath} 發現不合法 Unicode 字元，已清理 ${d} 筆資料`,"warning"),n}let v=new Map,$=new Set,k=new Map,_=new Set,S=new Map,C=new Map,M=new Map,P=new Map,T=[],E=200,A={new:0,updated:0,identical:0,subAdded:0,errors:0,warnings:0,newRecords:[],updatedRecords:[],identicalRecords:[],subAddedRecords:[],errorFiles:[],warningRecords:[],auditSummary:{mismatches:[],missingMain:[],resolved:[],priceMatches:[]},priceMatchTotal:0,detailLimit:200,detailTruncated:{new:0,updated:0,identical:0,errors:0,warnings:0}};function z(){C=new Map,M=new Map,P=new Map}function L(e,t,s,r=E){e.length<r?e.push(t):A.detailTruncated[s]+=1}function R(e,t){A.errorFiles.length<E?A.errorFiles.push({file:e,message:t}):A.detailTruncated.errors+=1}function F(e,t,s){if(!t||!s)return;let r=e.get(t);r||(r=new Set,e.set(t,r)),r.add(s)}function O(e){let t=[e.file??"",e.table??"",e.id??"",e.message].join("|");_.has(t)||(_.add(t),A.warnings+=1,L(A.warningRecords,{...e,resolved:!1},"warnings")),"park_count_exceed"===e.issue&&F(S,e.table,e.id),("park_count_mismatch"===e.issue||"park_main_zero"===e.issue||"park_missing_main"===e.issue)&&("park_missing_main"===e.issue?F(M,e.table,e.id):F(C,e.table,e.id))}function I(e,t,s){let r=P.get(e);r||(r=new Map,P.set(e,r)),r.set(t,s)}function U(){let e=[];for(let[t,s]of P.entries())for(let[r,a]of s.entries())e.push({table:t,id:r,parkCount:a.parkCount,mainCount:a.mainCount,mainPrice:a.mainPrice,parkPriceSum:a.parkPriceSum});return e}async function W(e,t,s){let r=P.get(e)?.get(t);if(!r)return s(`${e} 編號 ${t}: 找不到可修正的價格一致紀錄`,"warning"),!1;let a=e.replace("_park",""),{error:l}=await n.N.from(a).update({車位數:r.parkCount}).eq("編號",t);return l?(s(`${a} 編號 ${t}: 修正失敗 (${l.message})`,"error"),!1):(s(`${a} 編號 ${t}: 已修正主表車位數 (${r.mainCount} → ${r.parkCount})`,"success"),!0)}async function D(e,t){let s=U();if(0===s.length)return e("沒有可批次修正的價格一致項目","info"),{total:0,success:0,failed:0};let r=0,a=0;t?.(0,s.length,"fix");for(let l=0;l<s.length;l+=1){let i=s[l];await W(i.table,i.id,e)?r+=1:a+=1,t?.(l+1,s.length,"fix")}return e(`批次修正完成：成功 ${r}，失敗 ${a}`,a>0?"warning":"success"),{total:s.length,success:r,failed:a}}async function B(e,t,s,r,a){let l=String(s||"").toLowerCase(),i={totalTargets:0,insertedTotal:0,deletedTotal:0,missingTotal:0,skippedLowPriorityTotal:0,skippedNoMainTotal:0,tables:[]},d=Array.isArray(e)?e:[],c=new Map;if(d.forEach(e=>{let t,s=u(e?.id);if(!s)return;let r=function(e,t){let s="string"==typeof e.table?e.table.toLowerCase():"",r=(e.countyCode||function(e){if(!e)return null;let t=String(e).toLowerCase().match(/^([a-z])_lvr_land_/);return t?t[1]:null}(s))?.toLowerCase()||null;if(s.endsWith("_park"))return{countyCode:r,mainTable:s.replace(/_park$/,""),parkTable:s};let a=s;return(!a&&r&&(a=`${r}_lvr_land_${t}`),a)?{countyCode:r,mainTable:a,parkTable:`${a}_park`}:null}(e,l);if(!r?.parkTable||!r?.mainTable)return;let a=(t=r.parkTable.toLowerCase().match(/_lvr_land_(.+)$/))?t[1]:null;if(!a)return;let i=r.parkTable;c.has(i)||c.set(i,{parkTable:r.parkTable,mainTable:r.mainTable,countyCode:r.countyCode,tableType:a,ids:new Set}),c.get(i).ids.add(s)}),0===c.size)return r("沒有可補登的車位附表項目","info"),i;for(let e of(i.totalTargets=Array.from(c.values()).reduce((e,t)=>e+t.ids.size,0),c.values())){let{parkTable:s,mainTable:l,countyCode:d,tableType:c}=e,o=Array.from(e.ids),f={parkTable:s,ids:o.length,inserted:0,deleted:0,missing:0,skippedLowPriority:0,skippedNoMain:0,usedSources:[]};try{let e=t.filter(e=>e.tableType===c&&(!d||e.countyCode===d));if(0===e.length){f.missing=o.length,i.missingTotal+=o.length,r(`${s}: 找不到可用的上傳檔案，略過 ${o.length} 筆`,"warning"),i.tables.push(f);continue}let x=new Set(o),m=new Map,b=new Set;for(let t of e){let e=[];try{e=await N(t,v,(e,t)=>r(e,t))}catch(e){r(`${t.fullPath} 解析失敗: ${e.message}`,"error");continue}if(e&&0!==e.length)for(let s of e){let e=u(s["編號"]);if(!e||!x.has(e))continue;s["編號"]=e;let r=t.sourcePriority??1,a=m.get(e);!a||r>a.priority?m.set(e,{priority:r,rows:[s],sources:new Set([t.sourceType])}):r===a.priority&&(a.rows.push(s),a.sources.add(t.sourceType))}}let p=new Map,j=new Set,y=Array.from(m.keys());for(let e=0;e<y.length;e+=500){let t=y.slice(e,e+500),{data:s,error:r}=await n.N.from(l).select("編號, source_priority").in("編號",t);if(r)throw r;(s||[]).forEach(e=>{let t=u(e["編號"]);t&&(j.add(t),p.set(t,Number(e.source_priority??0)))})}let w=[],$=[],_=[],S=[],C=[];if(o.forEach(e=>{let t=m.get(e);if(!t)return void _.push(e);if(!j.has(e))return void C.push(e);let s=p.get(e)??0;if(t.priority<s)return void S.push(e);let r=new Set;t.rows.forEach(e=>{let t=g(h(e));r.has(t)||(r.add(t),w.push(e))}),$.push(e),t.sources.forEach(e=>b.add(e))}),f.missing=_.length,f.skippedLowPriority=S.length,f.skippedNoMain=C.length,i.missingTotal+=_.length,i.skippedLowPriorityTotal+=S.length,i.skippedNoMainTotal+=C.length,_.length>0&&r(`${s}: 找不到附表資料 ${Q(_)}`,"warning"),S.length>0&&r(`${s}: 低優先權略過 ${Q(S)}`,"warning"),C.length>0&&r(`${s}: 主表缺失略過 ${Q(C)}`,"warning"),0===$.length||0===w.length){r(`${s}: 無可補登的附表資料`,"info"),i.tables.push({...f,usedSources:Array.from(b)});continue}for(let e=0;e<$.length;e+=1e3){let t=$.slice(e,e+1e3),{count:a,error:l}=await n.N.from(s).delete({count:"exact"}).in("編號",t);if(l){let e=l?.message||"",t=l?.code||"";if("42P01"===t||e.includes("does not exist")){r(`${s} 不存在，略過補登`,"warning"),w.length=0;break}throw l}f.deleted+=Number(a??0)}if(w.length>0){let e=a?.chunkSize??500;for(let t=0;t<w.length;t+=e){let r=w.slice(t,t+e),{error:a}=await n.N.from(s).insert(r);if(a)throw a;f.inserted+=r.length}let t=k.get(s);t||(t=new Set,k.set(s,t)),$.forEach(e=>t.add(e))}f.usedSources=Array.from(b),i.insertedTotal+=f.inserted,i.deletedTotal+=f.deleted;let M=f.usedSources.length>0?`來源 ${f.usedSources.join("/")}`:"無來源標記";r(`${s}: 補登完成，刪除 ${f.deleted} 筆、插入 ${f.inserted} 筆 (${M})`,f.inserted>0?"success":"info")}catch(e){r(`${s}: 補登失敗 (${e.message})`,"error")}i.tables.push(f)}return i}async function J(e){try{let{data:t,error:s}=await n.N.from("project_name_mappings").select("old_name, new_name");if(s)return e&&e(`載入建案名稱對應失敗: ${s.message}`,"warning"),new Map;let r=new Map;return t?.forEach(e=>{r.set(e.old_name,e.new_name)}),e&&e(`已載入 ${r.size} 筆建案名稱對應規則`,"info"),v=r,r}catch(t){return e&&e(`載入建案名稱對應時發生錯誤: ${t.message}`,"warning"),new Map}}async function V(e,t,s){try{let r=`${e.countyCode}_lvr_land_${e.tableType}`,a=await N(e,v,(e,s)=>t(e,s));if(!a||0===a.length)return void t(`${e.fullPath}: 檔案為空或無有效資料，已跳過`,"warning");let l=s?.chunkSize??500;for(let i=0;i<a.length;i+=l){let d=a.slice(i,i+l),c=d.map(e=>u(e["編號"])).filter(Boolean),{data:o,error:m}=await n.N.from(r).select("*").in("編號",c);if(m)throw m;let h=new Map((o||[]).map(e=>[e["編號"],e])),g=[],b=[],p=[],j=0,y=0,w=0,N=new Set,v=e.tableType.startsWith("b"),k=v?e.sourcePriority??1:0;for(let t of d){let a=u(t["編號"]);if(a&&(t["編號"]=a),a&&($.has(a)||N.has(a))){w++;let e=a?h.get(a):void 0;L(A.identicalRecords,e||t,"identical",s?.detailLimit);continue}let l=a?h.get(a):void 0;if(l){let i=v?Number(l.source_priority??0):0;if(v&&k<i){y++,L(A.identicalRecords,l,"identical",s?.detailLimit);continue}let n=v&&k>i;if(n||!function(e,t,s){let r=f[s];if(!r)return!1;for(let s of Object.values(r)){if("id"===s||"建案名稱"===s)continue;let r=e[s],a=t[s];if(null==r||""===r)continue;let l=null!=r?String(r):"",i=null!=a?String(a):"";if(s.includes("面積")){let e=x(r)||0;if(Math.abs(e-(x(a)||0))>.001)return!1}else if(l!==i)return!1}return!0}(t,l,e.tableType)){let i=function(e,t,s){let r=f[s];if(!r)return[];let a=[];for(let s of Object.values(r)){if("id"===s||"建案名稱"===s)continue;let r=e[s],l=t[s];if(null!=r&&""!==r)if(s.includes("面積")){let e=x(r)||0;Math.abs(e-(x(l)||0))>.001&&a.push({field:s,oldValue:l,newValue:r})}else(null!=r?String(r):"")!==(null!=l?String(l):"")&&a.push({field:s,oldValue:l,newValue:r})}return a}(t,l,e.tableType),d=n&&0===i.length?"priority":"diff";p.push(a||t["編號"]),b.push(t),a&&N.add(a),L(A.updatedRecords,{id:a||t["編號"],file:e.fullPath,table:r,reason:d,diffFields:i,oldData:l,newData:t},"updated",s?.detailLimit)}else j++,L(A.identicalRecords,l,"identical",s?.detailLimit)}else g.push(t),a&&N.add(a),L(A.newRecords,t,"new",s?.detailLimit)}let _=j+y+w,S=[`${e.fullPath} (區塊 ${Math.floor(i/l)+1}): 新增 ${g.length}, 更新 ${b.length}, 跳過 ${_}`];if(y>0&&S.push(`(低優先權略過 ${y})`),w>0&&S.push(`(已處理略過 ${w})`),t(S.join(" "),"info"),A.new+=g.length,A.updated+=b.length,A.identical+=_,[...g.map(e=>u(e["編號"])||e["編號"]),...b.map(e=>u(e["編號"])||e["編號"])].forEach(e=>$.add(e)),p.length>0){await K(e.countyCode,e.tableType,p,t);let{error:s}=await n.N.from(r).delete().in("編號",p);if(s)throw s}let C=[...g,...b];if(C.length>0){let{error:e}=await n.N.from(r).insert(C);if(e)throw e}await el(r,c,t)}}catch(s){t(`${e.fullPath} 上傳失敗: ${s.message}`,"error"),A.errors++,R(e.fullPath,s.message)}}async function q(e,t,s){try{let r=`${e.countyCode}_lvr_land_${e.tableType}`,a=await N(e,v,(e,s)=>t(e,s));if(!a||0===a.length)return void t(`${e.fullPath}: 檔案為空或無有效資料，已跳過`,"warning");if(e.tableType.startsWith("b_")){let l=`${e.countyCode}_lvr_land_b`,i=new Map;a.forEach(e=>{let t=u(e["編號"]);t&&(i.has(t)||i.set(t,[]),i.get(t).push(e))});let d=Array.from(i.keys()),c=s?.chunkSize??500,o=0,f=0,x=0,m=0;for(let a=0;a<d.length;a+=c){let b=d.slice(a,a+c),{data:p,error:j}=await n.N.from(l).select("編號, source_priority, 車位數").in("編號",b);if(j)throw j;let y=new Map((p||[]).map(e=>[e["編號"],e])),w=[],N=[];for(let t of b){let s=i.get(t)||[],a=y.get(t);if(!a){f+=s.length,s.forEach(t=>{let s=u(t["編號"]);s&&(t["編號"]=s),N.push(function(e,t,s,r){let a=u(s["編號"]);a&&(s["編號"]=a);let l=g(h(s));return{table_name:e,main_table:t,record_id:a||s["編號"],record_fingerprint:l,record_data:s,source_type:r.sourceType??null,source_priority:r.sourcePriority??null,file_path:r.fullPath}}(r,l,t,e))}),m+=s.length;continue}let n=e.sourcePriority??1,d=Number(a.source_priority??0);if(n<d||!$.has(t)){x+=s.length;continue}s.forEach(e=>{let t=u(e["編號"]);t&&(e["編號"]=t)}),w.push(...s)}if(w.length>0){let a=Array.from(new Set(w.map(e=>u(e["編號"])||e["編號"]).filter(Boolean)));if(a.length>0){let{error:e}=await n.N.from(r).delete().in("編號",a);if(e){let t=e?.message||"",s=e?.code||"";if("42P01"!==s&&!t.includes("does not exist"))throw e}}let{error:l}=await n.N.from(r).insert(w);if(l)throw l;if(o+=w.length,w.forEach(e=>{L(A.subAddedRecords,e,"new",s?.detailLimit)}),"b_park"===e.tableType){let s=Array.from(new Set(w.map(e=>u(e["編號"])).filter(Boolean)));if(s.length>0){let e=k.get(r);e||(e=new Set,k.set(r,e)),s.forEach(t=>e.add(t))}await ei(r,s,y,e.fullPath,t)}}N.length>0&&T.push(...N)}if(o>0){A.subAdded+=o;let s=[`${e.fullPath}: 成功新增 ${o} 筆關聯的附表紀錄`];f>0&&s.push(`(找不到主表 ${f})`),x>0&&s.push(`(低優先權略過 ${x})`),m>0&&s.push(`(待最終檢查 ${m})`),t(s.join(" "),"success")}else{let s=[`${e.fullPath}: 無可插入的附表資料`];f>0&&s.push(`(找不到主表 ${f})`),x>0&&s.push(`(低優先權略過 ${x})`),m>0&&s.push(`(待最終檢查 ${m})`),t(s.join(" "),"info")}}else{let l=a.filter(e=>{let t=u(e["編號"]);return t&&(e["編號"]=t),!!t&&$.has(t)});if(l.length>0){let{error:a}=await n.N.from(r).insert(l);if(a)throw a;A.subAdded+=l.length,l.forEach(e=>{L(A.subAddedRecords,e,"new",s?.detailLimit)}),t(`${e.fullPath}: 成功新增 ${l.length} 筆關聯的附表紀錄`,"success")}else t(`${e.fullPath}: 無對應的主表變更，已跳過`,"info")}}catch(s){t(`${e.fullPath} 上傳失敗: ${s.message}`,"error"),A.errors++,R(e.fullPath,s.message)}}async function K(e,t,s,r){if(0!==s.length)for(let a of["_park","_land"]){let l=`${e}_lvr_land_${t}${a}`,{error:i}=await n.N.from(l).delete().in("編號",s);if(i){let e=i?.message||"";if("42P01"===(i?.code||"")||e.includes("does not exist")){r(`${l} 不存在，略過刪除`,"warning");continue}throw i}r(`${l}: 已清除對應附表資料 (${s.length} 筆主表編號)`,"warning")}}async function H(e,t,s){if(z(),"recent"===e){if(0===k.size)return t("本次上傳沒有可檢查的車位附表資料","info"),A;t("開始檢查本次上傳的車位數量是否與主表一致...","info");let e=Array.from(k.entries()),r=e.length;s?.(0,r,"recent");for(let a=0;a<e.length;a+=1){let[l,i]=e[a],n=Array.from(i);await ee(l,n,`本次上傳檢查`,t),s?.(a+1,r,"recent")}return X(t),t("本次上傳車位數量檢查完成","success"),A}t("開始全庫車位數量檢查（可能需較久時間）...","warning");let r="abcdefghijklmnopqrstuvwxyz".split(""),a=r.length;s?.(0,a,"all");for(let e=0;e<r.length;e+=1){let l=r[e],i=`${l}_lvr_land_b_park`,n=await Z(i,t);0!==n.length&&(await ee(i,n,`全庫檢查`,t),s?.(e+1,a,"all"))}return t("全庫車位數量檢查完成","success"),A}async function G(e,t,s){z();let r=new Map,a=new Set(["park_count_exceed","park_count_mismatch","park_main_zero","park_missing_main","pending_main_missing"]);if((e||[]).forEach(e=>{if(!e?.table||!e?.id||!String(e.table).endsWith("_park")||e.issue&&!a.has(e.issue))return;let t=r.get(e.table);t||(t=new Set,r.set(e.table,t)),t.add(e.id)}),0===r.size)return t("本次沒有可重新檢查的警告項目","info"),A;t("開始針對本次警告內容進行檢查...","info");let l=Array.from(r.entries()),i=l.length;s?.(0,i,"warnings");for(let e=0;e<l.length;e+=1){let[r,a]=l[e],n=Array.from(a);await ee(r,n,"警告檢查",t),s?.(e+1,i,"warnings")}return X(t),t("本次警告內容檢查完成","success"),A}function Q(e,t=6){return e.length<=t?e.join(", "):`${e.slice(0,t).join(", ")} ...(+${e.length-t})`}function X(e){let t=new Map;for(let[e,s]of S.entries()){let r=C.get(e)||new Set,a=new Set;s.forEach(e=>{r.has(e)||a.add(e)}),a.size>0&&t.set(e,a)}let s=Array.from(C.values()).reduce((e,t)=>e+t.size,0),r=Array.from(M.values()).reduce((e,t)=>e+t.size,0),a=Array.from(t.values()).reduce((e,t)=>e+t.size,0),l=Array.from(P.values()).reduce((e,t)=>e+t.size,0);if(e(`本次上傳檢查結果（車位數量）：不一致 ${s} 筆，主表缺失 ${r} 筆，已消失 ${a} 筆${l>0?`，價格一致可修正 ${l} 筆`:""}`,"info"),s>0)for(let[t,s]of C.entries())0!==s.size&&e(`不一致清單 ${t}: ${Q(Array.from(s))}`,"warning");if(r>0)for(let[t,s]of M.entries())0!==s.size&&e(`主表缺失 ${t}: ${Q(Array.from(s))}`,"warning");if(a>0)for(let[s,r]of t.entries())0!==r.size&&e(`已消失 ${s}: ${Q(Array.from(r))}`,"info");(function(){if(!A.warningRecords.length)return;let e=new Set,t=new Set;for(let[t,s]of C.entries())s.forEach(s=>e.add(`${t}|${s}`));for(let[e,s]of M.entries())s.forEach(s=>t.add(`${e}|${s}`));A.warningRecords=A.warningRecords.map(s=>{if(!s.table||!s.id)return s;let r=`${s.table}|${s.id}`;if("park_count_exceed"===s.issue){let a=!e.has(r)&&!t.has(r);return{...s,resolved:a}}if("park_count_mismatch"===s.issue||"park_main_zero"===s.issue){let t=!e.has(r);return{...s,resolved:t}}if("park_missing_main"===s.issue||"pending_main_missing"===s.issue){let e=!t.has(r);return{...s,resolved:e}}return s})})(),A.auditSummary={mismatches:Y(C),missingMain:Y(M),resolved:Y(t),priceMatches:Y(new Map(Array.from(P.entries()).map(([e,t])=>[e,new Set(t.keys())])))},A.priceMatchTotal=l}function Y(e){let t=Math.max(1,Math.min(E,500)),s=[];for(let[r,a]of e.entries()){let e=Array.from(a),l=Math.max(0,e.length-t);s.push({table:r,count:e.length,ids:e.slice(0,t),truncated:l})}return s.sort((e,t)=>t.count-e.count)}async function Z(e,t){let s=0,r=new Set;for(;;){let{data:a,error:l}=await n.N.from(e).select("編號").range(s,s+1e4-1);if(l){let s=l?.message||"";if("42P01"===(l?.code||"")||s.includes("does not exist"))return t(`${e} 不存在，略過全庫檢查`,"warning"),[];throw l}if(!a||0===a.length||(a.forEach(e=>{let t=u(e["編號"]);t&&r.add(t)}),a.length<1e4))break;s+=1e4}return Array.from(r)}async function ee(e,t,s,r){if(0===t.length)return;let a=e.replace("_park",""),l=new Map,i=new Map,d=e=>{if(null==e||""===e)return null;if("number"==typeof e&&Number.isFinite(e))return e;let t=Number(String(e).replace(/,/g,""));return Number.isFinite(t)?t:null};for(let s=0;s<t.length;s+=1e3){let r=t.slice(s,s+1e3),{data:a,error:c}=await n.N.from(e).select('編號, 車位價格, "車位價格(萬)"').in("編號",r);if(c)throw c;a?.forEach(e=>{let t=u(e["編號"]);if(!t)return;l.set(t,(l.get(t)||0)+1);let s=d(e["車位價格(萬)"]),r=null!==s?s:d(e["車位價格"]);if(null!==r){let e=null!==s?r:r/1e4;i.set(t,(i.get(t)||0)+e)}})}let c=new Map;for(let e=0;e<t.length;e+=1e3){let s=t.slice(e,e+1e3),{data:r,error:l}=await n.N.from(a).select('編號, 車位數, 車位總價, "車位總價(萬)"').in("編號",s);if(l)throw l;r?.forEach(e=>{let t=u(e["編號"]);t&&c.set(t,e)})}for(let a of t){let t=u(a)||a,n=l.get(t)||0,o=c.get(t);if(!o){let a=`${e} 編號 ${t}: 找不到主表資料 (${s})`;r(a,"warning"),O({file:s,table:e,id:t,message:a,stage:"audit",issue:"park_missing_main"});continue}let f=Number(o["車位數"]??0),x=d(o["車位總價(萬)"]),m=null!==x?x:d(o["車位總價"]),h=null!==m?null!==x?m:m/1e4:null,g=i.get(t)||0,b=null!==h&&h>0&&g>0&&.1>=Math.abs(h-g);if(0===n&&f>0){let s=await et(e,t);s>0&&(n=s)}if(0===f&&n>0){let a=b?`${e} 編號 ${t}: 主表車位數為 0，但附表有 ${n} 筆，且車位總價一致 (${s})`:`${e} 編號 ${t}: 主表車位數為 0，但附表有 ${n} 筆 (${s})`;r(a,"warning"),b&&I(e,t,{parkCount:n,mainCount:f,mainPrice:h??0,parkPriceSum:g}),O({file:s,table:e,id:t,message:a,stage:"audit",issue:"park_main_zero",mainCount:f,parkCount:n,mainPrice:h??void 0,parkPriceSum:g||void 0,suggestedCount:n,fixable:b});continue}if(f>0&&n!==f){let a=b?`${e} 編號 ${t}: 車位筆數 ${n} 與主表車位數 ${f} 不一致，且車位總價一致 (${s})`:`${e} 編號 ${t}: 車位筆數 ${n} 與主表車位數 ${f} 不一致 (${s})`;r(a,"warning"),b&&I(e,t,{parkCount:n,mainCount:f,mainPrice:h??0,parkPriceSum:g}),O({file:s,table:e,id:t,message:a,stage:"audit",issue:"park_count_mismatch",mainCount:f,parkCount:n,mainPrice:h??void 0,parkPriceSum:g||void 0,suggestedCount:n,fixable:b})}}}async function et(e,t){let{count:s,error:r}=await n.N.from(e).select("id",{count:"exact",head:!0}).eq("編號",t);if(r)throw r;return Number(s??0)}async function es(e,t){if(0===e.length)return;let{error:s}=await n.N.from("pending_subtables").upsert(e,{onConflict:"table_name,record_id,record_fingerprint"});if(s){let e=s?.message||"";if("42P01"===(s?.code||"")||e.includes("does not exist"))return void t("pending_subtables 不存在，無法暫存附表，請先建立資料表","warning");throw s}e.forEach(e=>{O({file:e.file_path,table:e.table_name,id:e.record_id,message:`${e.table_name} 編號 ${e.record_id}: 找不到主表，已暫存待補插`,stage:"audit",issue:"pending_main_missing"})})}async function er(e){if(!T.length)return;e(`開始最終檢查缺主表的附表（${T.length} 筆）...`,"info");let t=new Map;for(let[s,r]of(T.forEach(e=>{t.has(e.main_table)||t.set(e.main_table,[]),t.get(e.main_table).push(e)}),t.entries())){let t=Array.from(new Set(r.map(e=>u(e.record_id)).filter(Boolean)));if(0===t.length)continue;let{data:a,error:l}=await n.N.from(s).select("編號").in("編號",t);if(l)throw l;let i=new Set((a||[]).map(e=>u(e["編號"])||e["編號"])),d=r.filter(e=>{let t=u(e.record_id)||e.record_id;return!i.has(t)});d.length>0&&await es(d,e);let c=r.filter(e=>{let t=u(e.record_id)||e.record_id;return i.has(t)});c.length>0&&await ea(s,c,e)}T=[],e("最終檢查缺主表的附表完成","success")}async function ea(e,t,s){let r=new Map;t.forEach(e=>{let t=e.table_name,s=u(e.record_id)||e.record_id;r.has(t)||r.set(t,new Map);let a=r.get(t);a.has(s)||a.set(s,[]),a.get(s).push(e)});let a=new Map,l=[],i=0;for(let[e,t]of r.entries()){let r=Array.from(t.keys());if(0===r.length)continue;let d=new Set,c=new Map,{data:o,error:f}=await n.N.from(e).select("編號, source_priority").in("編號",r);if(f){let t=f?.message||"";if("42P01"===(f?.code||"")||t.includes("does not exist")){s(`${e} 不存在，略過暫存補插`,"warning");continue}throw f}(o||[]).forEach(e=>{let t=u(e["編號"]);if(t){d.add(t);let s=c.get(t),r=Number(e.source_priority??0);(void 0===s||r>s)&&c.set(t,r)}});let x=[],m=[];for(let s of r){let r=t.get(s)||[];if(0===r.length)continue;let a=Math.max(...r.map(e=>Number(e.source_priority??0))),n=c.get(s);if(d.has(s)&&void 0!==n&&a<=n){r.forEach(e=>l.push(e.id)),i+=r.length;continue}if(d.has(s)&&void 0!==n&&a>n&&m.push(s),r.filter(e=>Number(e.source_priority??0)===a).forEach(e=>{e.record_data&&e.record_data["編號"]&&(e.record_data["編號"]=s),x.push(e.record_data)}),r.forEach(e=>l.push(e.id)),e.endsWith("_park")){let t=k.get(e);t||(t=new Set,k.set(e,t)),t.add(s)}}if(m.length>0){let{error:t}=await n.N.from(e).delete().in("編號",m);if(t)throw t}x.length>0&&(a.has(e)||a.set(e,[]),a.get(e).push(...x))}for(let[e,t]of a.entries()){if(0===t.length)continue;let{error:s}=await n.N.from(e).insert(t);if(s)throw s}if(l.length>0){let{error:e}=await n.N.from("pending_subtables").delete().in("id",l);if(e)throw e}let d=Array.from(a.values()).reduce((e,t)=>e+t.length,0);d>0&&s(`${e}: 已補插 ${d} 筆暫存附表`,"info"),i>0&&s(`${e}: ${i} 筆暫存附表因已有附表而略過`,"warning")}async function el(e,t,s){if(!t||0===t.length)return;let r=Array.from(new Set(t.map(e=>u(e)).filter(Boolean)));if(0!==r.length)for(let t=0;t<r.length;t+=500){let a=r.slice(t,t+500),{data:l,error:i}=await n.N.from("pending_subtables").select("id, table_name, main_table, record_id, record_data, source_priority").eq("main_table",e).in("record_id",a);if(i){let e=i?.message||"";if("42P01"===(i?.code||"")||e.includes("does not exist"))return;throw i}if(!l||0===l.length)continue;let{data:d,error:c}=await n.N.from(e).select("編號").in("編號",a);if(c)throw c;let o=new Set((d||[]).map(e=>u(e["編號"])||e["編號"])),f=new Map;l.forEach(e=>{let t=u(e.record_id)||e.record_id;f.has(e.table_name)||f.set(e.table_name,new Map);let s=f.get(e.table_name);s.has(t)||s.set(t,[]),s.get(t).push(e)});let x=new Map,m=[],h=0;for(let[e,t]of f.entries()){let r=Array.from(t.keys()).filter(e=>o.has(e));if(0===r.length)continue;let a=new Set,l=new Map,{data:i,error:d}=await n.N.from(e).select("編號, source_priority").in("編號",r);if(d){let t=d?.message||"";if("42P01"===(d?.code||"")||t.includes("does not exist")){s(`${e} 不存在，略過暫存補插`,"warning");continue}throw d}(i||[]).forEach(e=>{let t=u(e["編號"]);if(t){a.add(t);let s=l.get(t),r=Number(e.source_priority??0);(void 0===s||r>s)&&l.set(t,r)}});let c=[],f=[];for(let s of r){let r=t.get(s)||[];if(0===r.length)continue;let i=Math.max(...r.map(e=>Number(e.source_priority??0))),n=l.get(s);if(a.has(s)&&void 0!==n&&i<=n){r.forEach(e=>m.push(e.id)),h+=r.length;continue}if(a.has(s)&&void 0!==n&&i>n&&f.push(s),r.filter(e=>Number(e.source_priority??0)===i).forEach(e=>{e.record_data&&e.record_data["編號"]&&(e.record_data["編號"]=s),c.push(e.record_data)}),r.forEach(e=>m.push(e.id)),e.endsWith("_park")){let t=k.get(e);t||(t=new Set,k.set(e,t)),t.add(s)}}if(f.length>0){let{error:t}=await n.N.from(e).delete().in("編號",f);if(t)throw t}c.length>0&&(x.has(e)||x.set(e,[]),x.get(e).push(...c))}for(let[e,t]of x.entries()){if(0===t.length)continue;let{error:s}=await n.N.from(e).insert(t);if(s)throw s}if(m.length>0){let{error:e}=await n.N.from("pending_subtables").delete().in("id",m);if(e)throw e}let g=Array.from(x.values()).reduce((e,t)=>e+t.length,0);g>0&&s(`${e}: 已補插 ${g} 筆暫存附表`,"info"),h>0&&s(`${e}: ${h} 筆暫存附表因已有附表而略過`,"warning")}}async function ei(e,t,s,r,a){if(0===t.length)return;let{data:l,error:i}=await n.N.from(e).select("id, 編號").in("編號",t);if(i)throw i;let d=new Map;for(let[t,i]of((l||[]).forEach(e=>{let t=u(e["編號"]);t&&(d.has(t)||d.set(t,[]),d.get(t).push(e))}),d.entries())){let l=i.length,n=Number(s.get(t)?.["車位數"]??0);if(n>0&&l>n){let s=`${e} 編號 ${t}: 車位筆數 ${l} 超過主表車位數 ${n} (未刪除)`;a(s,"warning"),O({file:r,table:e,id:t,message:s,stage:"upload",issue:"park_count_exceed"})}}}var en=s(73321),ed=s(36228);function ec(e,t){if(!e||!t)throw Error("請提供完整的 Supabase URL 和 Service Role Key");return(0,ed.UU)(e,t,{auth:{persistSession:!1}})}async function eo(e,t,s,r,a){try{let l=ec(a.url,a.key),i=`${e.toLowerCase()}_lvr_land_${t}`;console.log(`[AdminService] Searching ${i} for ${s} like %${r}%`);let{data:n,error:d}=await l.from(i).select("*").ilike(s,`%${r}%`).limit(100);if(d)throw d;return{success:!0,data:n,tableName:i}}catch(e){return console.error("Search error:",e),{success:!1,error:e.message}}}async function ef(e,t,s,r,a,l,i,n){try{let d=ec(n.url,n.key);if(!t||0===t.length)throw Error("沒有選擇任何要更新的資料");console.log(`[AdminService] Batch updating ${e}, Count: ${t.length}, Field: ${s}`);let{error:c}=await d.from(e).update({[s]:""===r?null:r}).in("編號",t);if(c)throw c;let o=a&&a.includes("?");return"建案名稱"===s&&a&&r&&a!==r&&o&&(console.log(`[AdminService] Detected encoding fix (old: ${a}, new: ${r}). Saving mapping.`),await ex(a,r,l,i,d)),{success:!0,count:t.length}}catch(e){return console.error("Batch update error:",e),{success:!1,error:e.message}}}async function ex(e,t,s,r,a){try{let l={old_name:e,new_name:t,updated_at:new Date().toISOString()};s&&(l.district=s),r&&(l.city=r);let{error:i}=await a.from("project_name_mappings").upsert(l,{onConflict:"old_name"});i&&console.error("Failed to save mapping:",i)}catch(e){console.error("Error saving mapping:",e)}}var em=s(14670),eu=s(80723),eh=s(8195),eg=s(14931),eb=s(13545);function ep(){let e,t,s,a,d,c,x=(0,en.useRouter)(),{guard:m}=(0,em.X)("upload_tools"),[u,h]=(0,i.useState)([]),[g,b]=(0,i.useState)(!1),[p,j]=(0,i.useState)([]),[y,N]=(0,i.useState)("all"),[v,z]=(0,i.useState)(""),[L,R]=(0,i.useState)(0),[F,O]=(0,i.useState)(0),[I,K]=(0,i.useState)(""),[Q,X]=(0,i.useState)(null),[Y,Z]=(0,i.useState)("500"),[ee,et]=(0,i.useState)("200"),[es,ea]=(0,i.useState)("50"),[el,ei]=(0,i.useState)(null),[ed,ec]=(0,i.useState)(1),[ex,ep]=(0,i.useState)("active"),[ej,ey]=(0,i.useState)("count"),[ew,eN]=(0,i.useState)(!1),[ev,e$]=(0,i.useState)(!1),[ek,e_]=(0,i.useState)(!1),[eS,eC]=(0,i.useState)(0),[eM,eP]=(0,i.useState)(""),[eT,eE]=(0,i.useState)(""),[eA,ez]=(0,i.useState)(""),[eL,eR]=(0,i.useState)(!1),[eF,eO]=(0,i.useState)("f"),[eI,eU]=(0,i.useState)("b"),[eW,eD]=(0,i.useState)("建案名稱"),[eB,eJ]=(0,i.useState)(""),[eV,eq]=(0,i.useState)([]),[eK,eH]=(0,i.useState)(!1),[eG,eQ]=(0,i.useState)(new Set),[eX,eY]=(0,i.useState)("建案名稱"),[eZ,e0]=(0,i.useState)(""),[e4,e7]=(0,i.useState)(!1),[e8,e9]=(0,i.useState)(!1),[e1,e2]=(0,i.useState)(null),[e5,e3]=(0,i.useState)(new Set),[e6,te]=(0,i.useState)(!1),[tt,ts]=(0,i.useState)("f"),[tr,ta]=(0,i.useState)("b"),[tl,ti]=(0,i.useState)(!1),[tn,td]=(0,i.useState)(null),[tc,to]=(0,i.useState)(null),[tf,tx]=(0,i.useState)(!1),[tm,tu]=(0,i.useState)(!1),[th,tg]=(0,i.useState)(0),[tb,tp]=(0,i.useState)(1),[tj,ty]=(0,i.useState)({current:0,total:0}),[tw,tN]=(0,i.useState)(""),[tv,t$]=(0,i.useState)(!1),tk=e=>e?.__key||`${e?.countyCode||""}|${e?.table||""}|${e?.id||""}`,t_=e=>e.map((e,t)=>!e||e.__key?e:{...e,__key:`${e?.countyCode||""}|${e?.table||""}|${e?.id||""}|${t}`}),tS=(e,t)=>{let s=new Date().toLocaleTimeString();h(r=>[...r,{id:Date.now()+Math.random(),text:e,type:t,time:s}])},tC=async()=>{if(!eT||!eA)return void tS("請填寫完整的 Supabase URL 和 Service Role Key。","error");tS("正在測試連線...","info");try{let{error:e}=await n.N.from("county_codes").select("code",{count:"exact",head:!0});if(e&&"42P01"!==e.code)throw e;tS("連線成功！","success"),eR(!0),J((e,t)=>tS(e,t))}catch(e){tS(`連線失敗: ${e.message}`,"error"),eR(!1)}},tM=async()=>{h([]),j([]),X(null);try{if(!window.showDirectoryPicker)return void tS("您的瀏覽器不支援資料夾選擇功能，請使用 Chrome 或 Edge。","error");tS("正在掃描資料夾...","info");let e=await window.showDirectoryPicker(),t=await w(e);if(0===t.length)return void tS("在選擇的資料夾中沒有找到符合命名規則的檔案。","warning");j(t),tS(`掃描完成！找到 ${t.length} 個有效檔案。`,"success")}catch(e){"AbortError"!==e.name&&tS(`選擇資料夾時發生錯誤: ${e.message}`,"error")}},tP=async()=>{var e;if(0===p.length)return;if(!eL)return void tS("請先確認資料庫連線成功。","error");b(!0);let t=sc(Y,500,1,5e3),s=sc(ee,200,1,5e3);e={detailLimit:s},e?.detailLimit!==void 0&&(E=Math.max(1,Math.min(e.detailLimit,5e3))),$=new Set,k=new Map,_=new Set,S=new Map,C=new Map,M=new Map,P=new Map,T=[],A={new:0,updated:0,identical:0,subAdded:0,errors:0,warnings:0,newRecords:[],updatedRecords:[],identicalRecords:[],subAddedRecords:[],errorFiles:[],warningRecords:[],auditSummary:{mismatches:[],missingMain:[],resolved:[],priceMatches:[]},priceMatchTotal:0,detailLimit:E,detailTruncated:{new:0,updated:0,identical:0,errors:0,warnings:0}},h([]),X(null),tS("開始上傳任務...","info");let r={chunkSize:t,detailLimit:s},a=p;if("all"!==y&&(a=p.filter(e=>e.tableType.startsWith(y))),0===a.length){tS(`找不到符合「${{all:"全選",a:"中古",b:"預售",c:"租賃"}[y]}」類型的檔案...`,"warning"),b(!1);return}let l=[...a.filter(e=>e.isMain)].sort((e,t)=>(t.sourcePriority||0)-(e.sourcePriority||0)),i=[...a.filter(e=>!e.isMain)].sort((e,t)=>(t.sourcePriority||0)-(e.sourcePriority||0));tS(`--- 階段 1: 主表 (智慧更新) ---`,"info");for(let e=0;e<l.length;e++){let t=l[e];z(t.fullPath),R(Math.round(e/l.length*100)),await V(t,tS,r)}tS(`--- 階段 2: 附表 (智慧連動) ---`,"info");for(let e=0;e<i.length;e++){let t=i[e];z(t.fullPath),R(Math.round(e/i.length*100)),await q(t,tS,r)}z(""),R(100),await er(tS);let n=A;X(n),tS(`所有檔案處理完成！新增: ${n.new}, 更新: ${n.updated}, 錯誤: ${n.errors}`,"success"),tS("本次上傳尚未執行最終檢查，請手動執行。","info"),b(!1)},tT=async()=>{if(!ew){eN(!0),K("本次上傳全數內容檢查"),O(0);try{await H("recent",tS,(e,t)=>{let s=t>0?Math.round(e/t*100):0;O(s)});let e=A;X({...e})}catch(e){tS(`本次上傳全數內容檢查失敗: ${e.message}`,"error")}finally{eN(!1)}}},tE=async()=>{if(!ev){e$(!0),K("本次警告內容檢查"),O(0);try{await G(Q?.warningRecords,tS,(e,t)=>{let s=t>0?Math.round(e/t*100):0;O(s)});let e=A;X({...e})}catch(e){tS(`本次警告內容檢查失敗: ${e.message}`,"error")}finally{e$(!1)}}},tA=async()=>{if(!ek){e_(!0),eP("批次修正（價格一致）"),eC(0);try{await D(tS,(e,t)=>{let s=0===t?0:Math.round(e/t*100);eC(s)}),tS("批次修正完成，請重新執行檢查確認結果。","info")}catch(e){tS(`批次修正失敗: ${e.message}`,"error")}finally{e_(!1)}}},tz=async(e,t)=>{if(e&&t&&!ek){e_(!0),eP(`修正編號 ${t}`),eC(0);try{await W(e,t,tS)&&tS("單筆修正完成，請重新執行檢查確認結果。","info")}catch(e){tS(`單筆修正失敗: ${e.message}`,"error")}finally{e_(!1)}}},tL=async()=>{ti(!0),td(null),to(null),tx(!0),tp(1),ty({current:0,total:0}),tN("");try{let e=await tR(),t=async t=>{let s=await fetch("https://zxbmbbfrzbtuueysicoc.supabase.co/functions/v1/audit-database",{method:"POST",headers:{"Content-Type":"application/json",Authorization:`Bearer ${e}`},body:JSON.stringify({countyCode:t,mainType:tr})});if(!s.ok){let e=await s.json().catch(()=>({}));throw Error(e.error||`伺服器回應錯誤 (${s.status})`)}return s.json()};if("all"===tt){let e=Object.keys(o).map(e=>e.toLowerCase()),s=[],r=[];ty({current:0,total:e.length});for(let a=0;a<e.length;a+=1){let l=e[a],i=o[l.toUpperCase()]||l.toUpperCase();tN(i),ty({current:a,total:e.length});try{let e=await t(l),r=e?.warnings||[];r.length>0&&s.push(...r)}catch(e){r.push(i),tS(`全表稽核掃描失敗：${i} (${e.message})`,"error")}ty({current:a+1,total:e.length})}tN(""),0===s.length&&r.length>0?to(`全部縣市掃描失敗：${r.join("、")}`):(r.length>0&&tS(`全表稽核部分縣市失敗：${r.join("、")}`,"warning"),td(t_(s)))}else{let e=await t(tt),s=t_(e.warnings||[]);td(s)}}catch(e){to(e.message||"發生未知錯誤")}finally{ti(!1),tN("")}},tR=async()=>{let{data:e}=await n.N.auth.getSession(),t=e?.session?.access_token;if(!t)throw Error("未授權訪問：請重新登入");return t},tF=async e=>{let t=await tR(),s=await fetch("https://zxbmbbfrzbtuueysicoc.supabase.co/functions/v1/audit-database",{method:"POST",headers:{"Content-Type":"application/json",Authorization:`Bearer ${t}`},body:JSON.stringify({action:"fix",mainType:tr,items:e})});if(!s.ok)throw Error((await s.json().catch(()=>({}))).error||`伺服器回應錯誤 (${s.status})`);return s.json()},tO=async()=>{if(tm||!tn)return;let e=tn.filter(e=>e.fixable);if(0===e.length)return void tS("全表稽核：沒有可修正的價格一致項目","info");tu(!0),tg(0);let t=0,s=0,r=new Set;for(let a=0;a<e.length;a+=100){let l=e.slice(a,a+100);try{let e=await tF(l),a=Array.isArray(e?.results)?e.results:[];l.forEach((e,l)=>{Number(a[l]?.updated??0)>0?t+=1:(s+=1,r.add(tk(e)))})}catch(e){s+=l.length,l.forEach(e=>r.add(tk(e))),tS(`全表稽核修正失敗：${e.message}`,"error")}tg(Math.round(Math.min(a+l.length,e.length)/e.length*100))}td(e=>e?t_(e).filter(e=>!e.fixable||r.has(tk(e))):e),tS(`全表稽核修正完成：成功 ${t}，失敗 ${s}`,s>0?"warning":"success"),tu(!1)},tI=async e=>{if(e&&!tm){tu(!0),tg(0);try{let t=await tF([e]),s=t?.results?.[0];if(Number(s?.updated??0)>0)tS(`全表稽核已修正 ${e.id}：車位數 → ${e.actual}${s?.debug?` (before=${s.debug.before}, after=${s.debug.after})`:""}`,"success"),td(t=>{if(!t)return t;let s=t_(t),r=tk(e);return s.filter(e=>tk(e)!==r)});else{let t=s?.error||"未更新資料",r=s?.debug?` | debug: ${JSON.stringify(s.debug)}`:"";tS(`全表稽核修正失敗 (${e.id}): ${t}${r}`,"error")}}catch(t){tS(`全表稽核修正失敗 (${e.id}): ${t.message}`,"error")}tu(!1)}},tU=async()=>{if(tv||!tn||0===tn.length)return;if(!eL)return void tS("請先確認資料庫連線成功。","error");if(0===p.length)return void tS("請先載入資料檔案（opendata/list/edit）。","error");let e=tn.filter(e=>{let t=Number(e?.expected??0),s=Number(e?.actual??0);return Number.isFinite(t)&&Number.isFinite(s)&&s<t});if(0===e.length)return void tS("全表稽核：沒有「附表 < 主表」的資料可補登","info");t$(!0);try{tS(`開始整批補登車位附表（${e.length} 筆）...`,"info");let t=await B(e,p,tr,tS,{chunkSize:sc(Y,500,1,5e3)});tS(`整批補登完成：刪除 ${t.deletedTotal}，新增 ${t.insertedTotal}，缺少 ${t.missingTotal}，低優先權略過 ${t.skippedLowPriorityTotal}，主表缺失 ${t.skippedNoMainTotal}`,t.insertedTotal>0?"success":"warning"),tS("請重新執行全表稽核確認結果。","info")}catch(e){tS(`整批補登失敗: ${e.message}`,"error")}finally{t$(!1)}},tW=async e=>{if(tv||!e)return;if(!eL)return void tS("請先確認資料庫連線成功。","error");if(0===p.length)return void tS("請先載入資料檔案（opendata/list/edit）。","error");let t=Number(e?.expected??0),s=Number(e?.actual??0);if(!(Number.isFinite(t)&&Number.isFinite(s)&&s<t))return void tS(`編號 ${e?.id||""} 不符合「附表 < 主表」條件，略過補登`,"info");t$(!0);try{tS(`開始補登編號 ${e?.id||""} 的車位附表...`,"info");let t=await B([e],p,tr,tS,{chunkSize:sc(Y,500,1,5e3)});tS(`編號 ${e?.id||""} 補登完成：刪除 ${t.deletedTotal}，新增 ${t.insertedTotal}，缺少 ${t.missingTotal}`,t.insertedTotal>0?"success":"warning"),tS("請重新執行全表稽核確認結果。","info")}catch(t){tS(`編號 ${e?.id||""} 補登失敗: ${t.message}`,"error")}finally{t$(!1)}};(0,i.useEffect)(()=>{if(!tn||0===tn.length){1!==tb&&tp(1);return}let e=Math.max(1,Math.ceil(tn.length/50));tb>e&&tp(e)},[tn,tb,50]);let tD=async()=>{if(!eT||!eA)return void tS("請先填寫資料庫連線資訊 (URL & Key)","error");if(!eB.trim())return void tS("請輸入搜尋關鍵字","warning");e7(!0),h([]),tS(`正在搜尋: ${o[eF.toUpperCase()]} ${eI} ${eW} containing "${eB}"...`,"info");try{let e=await eo(eF,eI,eW,eB.trim(),{url:eT,key:eA});e.success&&e.data?(eq(e.data),e2({tableName:e.tableName,city:o[eF.toUpperCase()]}),eH(!0),eQ(new Set),tS(`搜尋完成，找到 ${e.data.length} 筆資料`,"success")):tS(`搜尋失敗: ${e.error}`,"error")}catch(e){tS(`搜尋發生錯誤: ${e.message}`,"error")}finally{e7(!1)}},tB=async()=>{if(!e1||0===eG.size)return;let e=null,t=null;if("建案名稱"===eX){let s=Array.from(eG)[0],r=eV.find(e=>e["編號"]===s);r&&(e=r["建案名稱"],t=r["行政區"])}e9(!0),tS(`開始批次更新 ${eG.size} 筆資料...`,"info");try{let s=await ef(e1.tableName,Array.from(eG),eX,eZ,e,t,e1.city,{url:eT,key:eA});s.success?(tS(`成功更新 ${s.count} 筆資料！`,"success"),eH(!1)):tS(`批次更新失敗: ${s.error}`,"error")}catch(e){tS(`批次更新發生錯誤: ${e.message}`,"error")}finally{e9(!1)}},tJ=e=>{let t=new Set(eG);t.has(e)?t.delete(e):t.add(e),eQ(t)},tV=()=>{eG.size===eV.length?eQ(new Set):eQ(new Set(eV.map(e=>e["編號"])))},tq=e=>{let t=new Set(e5);t.has(e)?t.delete(e):t.add(e),e3(t)};(0,i.useEffect)(()=>{el&&ec(1)},[el,es]);let tK=Q?.auditSummary,tH=new Set,tG=new Set;tK?.mismatches?.forEach(e=>{(e.ids||[]).forEach(t=>{tH.add(`${e.table}|${t}`)})}),tK?.missingMain?.forEach(e=>{(e.ids||[]).forEach(t=>{tG.add(`${e.table}|${t}`)})});let tQ=[],tX=new Set,tY=e=>{let t=`${e.table||""}|${e.id||""}|${e.issue||e.message}`;tX.has(t)||(tX.add(t),tQ.push(e))};tH.forEach(e=>{let[t,s]=e.split("|");tY({stage:"audit",table:t,id:s,issue:"park_count_mismatch",message:`${t} 編號 ${s}: 最終檢查不一致`,status:"unresolved",category:"count"})}),tG.forEach(e=>{let[t,s]=e.split("|");tY({stage:"audit",table:t,id:s,issue:"park_missing_main",message:`${t} 編號 ${s}: 最終檢查找不到主表`,status:"unresolved",category:"missing_main"})}),(Q?.warningRecords||[]).forEach(e=>{if(e?.resolved)return;let t=e.table||"",s=e.id||"",r="unresolved";if("park_count_exceed"===e.issue||"pending_main_missing"===e.issue){let e=`${t}|${s}`;r=tH.has(e)||tG.has(e)?"unresolved":"resolved"}let a="count";("park_missing_main"===e.issue||"pending_main_missing"===e.issue)&&(a="missing_main"),"park_main_zero"===e.issue&&(a="count"),"park_count_exceed"===e.issue&&(a="count"),tY({...e,status:r,category:a})});let tZ=Q?.detailLimit??200,t0="active"===ex?tQ.filter(e=>"resolved"!==e.status):tQ,t4="all"===ej?t0:t0.filter(e=>e.category===ej),t7=t4.slice(0,tZ),t8=Math.max(0,t4.length-t7.length),t9=tQ.filter(e=>"resolved"!==e.status).length,t1={count:t0.filter(e=>"count"===e.category).length,missing_main:t0.filter(e=>"missing_main"===e.category).length},t2=Q?U():[],t5=new Map(t2.map(e=>[`${e.table}|${e.id}`,e])),t3=t2.length,t6=tn?tn.filter(e=>e.fixable).length:0,se=(tn?tn.filter(e=>{let t=Number(e?.expected??0),s=Number(e?.actual??0);return Number.isFinite(t)&&Number.isFinite(s)&&s<t}):[]).length,st=tn?tn.length:0,ss=Math.max(1,Math.ceil(st/50)),sr=Math.min(tb,ss),sa=(sr-1)*50,sl=Math.min(sa+50,st),si=tn?tn.slice(sa,sl):[],sn=(Q?.newRecords?.length||0)+(Q?.subAddedRecords?.length||0),sd=Q&&el?"new"===el?{title:"新增明細",items:[...(Q.newRecords||[]).map(e=>({...e,__source:"main"})),...(Q.subAddedRecords||[]).map(e=>({...e,__source:"sub"}))],truncated:Q.detailTruncated.new}:"updated"===el?{title:"更新/搜尋明細",items:Q.updatedRecords,truncated:Q.detailTruncated.updated}:"identical"===el?{title:"跳過明細",items:Q.identicalRecords,truncated:Q.detailTruncated.identical}:"warnings"===el?{title:"問題清單",items:t7,truncated:t8}:{title:"錯誤檔案",items:Q.errorFiles,truncated:Q.detailTruncated.errors}:null,sc=(e,t,s,r)=>{let a="number"==typeof e?e:parseInt(e,10);return Number.isFinite(a)?Math.max(s,Math.min(a,r)):t},so=sc(es,50,1,5e3),sf=sd?(e=sd.items.length,c=Math.min((d=((a=Math.min(ed,s=Math.max(1,Math.ceil(e/(t=Math.max(1,Math.min(so,Q?.detailLimit||so)))))))-1)*t)+t,e),{total:e,pageSize:t,totalPages:s,currentPage:a,startIndex:d,endIndex:c}):null;if(m)return m;let sx=ew||ev,sm=g||sx||ek,su=g?L:sx?F:ek?eS:0,sh=g?"上傳進度":sx?"檢查進度":ek?"修正進度":"執行進度",sg=g?v?`正在處理: ${v}`:"":sx?I?`正在檢查: ${I}`:"正在檢查...":ek?eM?`正在修正: ${eM}`:"正在修正...":"";return(0,r.jsxs)("div",{className:"jsx-4f044084e7cd90f7 min-h-screen bg-dark-bg text-gray-100 p-8 font-sans",children:[(0,r.jsxs)("div",{className:"jsx-4f044084e7cd90f7 max-w-7xl mx-auto space-y-8",children:[(0,r.jsx)("div",{className:"jsx-4f044084e7cd90f7 flex justify-between items-center bg-dark-card p-6 rounded-xl border border-gray-700 shadow-lg",children:(0,r.jsxs)("div",{className:"jsx-4f044084e7cd90f7 flex items-center gap-4",children:[(0,r.jsx)("button",{onClick:()=>x.push("/dashboard"),className:"jsx-4f044084e7cd90f7 text-zinc-400 hover:text-white transition-colors",children:(0,r.jsx)(eu.A,{className:"h-5 w-5"})}),(0,r.jsxs)("div",{className:"jsx-4f044084e7cd90f7",children:[(0,r.jsxs)("h1",{className:"jsx-4f044084e7cd90f7 text-3xl font-extrabold text-white tracking-tight",children:["平米內參 ",(0,r.jsx)("span",{className:"jsx-4f044084e7cd90f7 text-amber-400",children:"資料上傳工具"})]}),(0,r.jsx)("p",{className:"jsx-4f044084e7cd90f7 text-gray-400 mt-2 text-sm",children:"高效能、智慧化的實價登錄資料批次處理系統 v2.0 (Next.js)"})]})]})}),(0,r.jsxs)("div",{className:"jsx-4f044084e7cd90f7 grid grid-cols-1 lg:grid-cols-3 gap-8",children:[(0,r.jsxs)("div",{className:"jsx-4f044084e7cd90f7 space-y-6",children:[(0,r.jsxs)("div",{className:"jsx-4f044084e7cd90f7 bg-dark-card p-6 rounded-xl border border-gray-700 shadow-lg",children:[(0,r.jsxs)("h2",{className:"jsx-4f044084e7cd90f7 text-xl font-bold text-white mb-4 flex items-center",children:[(0,r.jsx)("span",{className:"jsx-4f044084e7cd90f7 bg-amber-900 text-amber-400 w-8 h-8 rounded-full flex items-center justify-center mr-3 text-sm",children:"1"}),"資料庫連線"]}),(0,r.jsxs)("div",{className:"jsx-4f044084e7cd90f7 space-y-4",children:[(0,r.jsxs)("div",{className:"jsx-4f044084e7cd90f7",children:[(0,r.jsx)("label",{className:"jsx-4f044084e7cd90f7 block text-sm font-medium text-gray-400 mb-1",children:"Supabase URL"}),(0,r.jsx)("input",{type:"text",value:eT,onChange:e=>eE(e.target.value),placeholder:"https://xyz.supabase.co",className:"jsx-4f044084e7cd90f7 w-full bg-gray-800 border-gray-600 rounded-lg px-3 py-2 text-white focus:ring-amber-500 focus:border-amber-500 placeholder-gray-600"})]}),(0,r.jsxs)("div",{className:"jsx-4f044084e7cd90f7",children:[(0,r.jsx)("label",{className:"jsx-4f044084e7cd90f7 block text-sm font-medium text-gray-400 mb-1",children:"Service Role Key"}),(0,r.jsx)("input",{type:"password",value:eA,onChange:e=>ez(e.target.value),placeholder:"eyJhhGciOiJIUzI1NiIsInR5cCI...",className:"jsx-4f044084e7cd90f7 w-full bg-gray-800 border-gray-600 rounded-lg px-3 py-2 text-white focus:ring-amber-500 focus:border-amber-500 placeholder-gray-600"})]}),(0,r.jsx)("button",{onClick:tC,className:`jsx-4f044084e7cd90f7 w-full font-bold py-2 px-4 rounded-lg transition-colors flex items-center justify-center gap-2 ${eL?"bg-green-600 hover:bg-green-500 text-white cursor-default":"bg-gray-700 hover:bg-gray-600 text-white"}`,children:eL?(0,r.jsxs)(r.Fragment,{children:[(0,r.jsx)("i",{className:"jsx-4f044084e7cd90f7 fas fa-check"})," 連線成功"]}):"測試連線"})]})]}),(0,r.jsxs)("div",{className:"jsx-4f044084e7cd90f7 bg-dark-card p-6 rounded-xl border border-gray-700 shadow-lg",children:[(0,r.jsxs)("h2",{className:"jsx-4f044084e7cd90f7 text-xl font-bold text-white mb-4 flex items-center",children:[(0,r.jsx)("span",{className:"jsx-4f044084e7cd90f7 bg-amber-900 text-amber-400 w-8 h-8 rounded-full flex items-center justify-center mr-3 text-sm",children:"2"}),"選擇資料來源"]}),(0,r.jsxs)("button",{onClick:tM,disabled:g||ek,className:"jsx-4f044084e7cd90f7 w-full bg-gray-700 hover:bg-gray-600 text-white font-bold py-3 px-4 rounded-lg transition-colors flex items-center justify-center gap-2 disabled:opacity-50",children:[(0,r.jsx)("i",{className:"jsx-4f044084e7cd90f7 fas fa-folder-open text-xl"})," 選擇 lvr_land 資料夾"]}),p.length>0&&(0,r.jsxs)("div",{className:"jsx-4f044084e7cd90f7 mt-4 p-3 bg-gray-800/50 rounded-lg text-sm",children:[(0,r.jsxs)("div",{className:"jsx-4f044084e7cd90f7 flex justify-between text-gray-300 mb-1",children:[(0,r.jsx)("span",{className:"jsx-4f044084e7cd90f7",children:"已找到檔案:"}),(0,r.jsxs)("span",{className:"jsx-4f044084e7cd90f7 font-bold text-white",children:[p.length," 個"]})]}),(0,r.jsxs)("div",{className:"jsx-4f044084e7cd90f7 flex justify-between text-gray-400 text-xs",children:[(0,r.jsx)("span",{className:"jsx-4f044084e7cd90f7",children:"主表 (Main):"}),(0,r.jsx)("span",{className:"jsx-4f044084e7cd90f7",children:p.filter(e=>e.isMain).length})]}),(0,r.jsxs)("div",{className:"jsx-4f044084e7cd90f7 flex justify-between text-gray-400 text-xs",children:[(0,r.jsx)("span",{className:"jsx-4f044084e7cd90f7",children:"附表 (Sub):"}),(0,r.jsx)("span",{className:"jsx-4f044084e7cd90f7",children:p.filter(e=>!e.isMain).length})]})]})]}),(0,r.jsxs)("div",{className:"jsx-4f044084e7cd90f7 bg-dark-card p-6 rounded-xl border border-gray-700 shadow-lg",children:[(0,r.jsxs)("h2",{className:"jsx-4f044084e7cd90f7 text-xl font-bold text-white mb-4 flex items-center",children:[(0,r.jsx)("span",{className:"jsx-4f044084e7cd90f7 bg-amber-900 text-amber-400 w-8 h-8 rounded-full flex items-center justify-center mr-3 text-sm",children:"3"}),"開始處理"]}),(0,r.jsxs)("div",{className:"jsx-4f044084e7cd90f7 space-y-4",children:[(0,r.jsxs)("div",{className:"jsx-4f044084e7cd90f7 grid grid-cols-1 md:grid-cols-2 gap-3",children:[(0,r.jsxs)("div",{className:"jsx-4f044084e7cd90f7",children:[(0,r.jsx)("label",{className:"jsx-4f044084e7cd90f7 block text-sm font-medium text-gray-400 mb-1",children:"上傳批次筆數"}),(0,r.jsx)("input",{type:"number",min:1,max:5e3,value:Y,onChange:e=>Z(e.target.value),className:"jsx-4f044084e7cd90f7 w-full bg-gray-800 border-gray-600 rounded-lg px-3 py-2 text-white focus:ring-amber-500 focus:border-amber-500"})]}),(0,r.jsxs)("div",{className:"jsx-4f044084e7cd90f7",children:[(0,r.jsx)("label",{className:"jsx-4f044084e7cd90f7 block text-sm font-medium text-gray-400 mb-1",children:"明細保留筆數"}),(0,r.jsx)("input",{type:"number",min:1,max:5e3,value:ee,onChange:e=>et(e.target.value),className:"jsx-4f044084e7cd90f7 w-full bg-gray-800 border-gray-600 rounded-lg px-3 py-2 text-white focus:ring-amber-500 focus:border-amber-500"})]}),(0,r.jsxs)("div",{className:"jsx-4f044084e7cd90f7",children:[(0,r.jsx)("label",{className:"jsx-4f044084e7cd90f7 block text-sm font-medium text-gray-400 mb-1",children:"明細每頁筆數"}),(0,r.jsx)("input",{type:"number",min:1,max:5e3,value:es,onChange:e=>ea(e.target.value),className:"jsx-4f044084e7cd90f7 w-full bg-gray-800 border-gray-600 rounded-lg px-3 py-2 text-white focus:ring-amber-500 focus:border-amber-500"})]}),(0,r.jsx)("div",{className:"jsx-4f044084e7cd90f7 md:col-span-2 text-xs text-gray-500",children:"上傳批次預設 500；明細保留筆數預設 200；每頁顯示預設 50，上限 5000。"})]}),(0,r.jsxs)("div",{className:"jsx-4f044084e7cd90f7",children:[(0,r.jsx)("label",{className:"jsx-4f044084e7cd90f7 block text-sm font-medium text-gray-400 mb-2",children:"上傳類型"}),(0,r.jsx)("div",{className:"jsx-4f044084e7cd90f7 grid grid-cols-2 gap-2",children:["all","a","b","c"].map(e=>(0,r.jsxs)("label",{className:`jsx-4f044084e7cd90f7 cursor-pointer border rounded-lg p-2 text-center transition-all ${y===e?"bg-amber-900/30 border-amber-500 text-amber-400":"bg-gray-800 border-gray-700 text-gray-400 hover:border-gray-500"}`,children:[(0,r.jsx)("input",{type:"radio",name:"uploadType",value:e,checked:y===e,onChange:e=>N(e.target.value),disabled:g||ek,className:"jsx-4f044084e7cd90f7 sr-only"}),(0,r.jsx)("span",{className:"jsx-4f044084e7cd90f7 font-bold",children:"all"===e?"全部":"a"===e?"中古":"b"===e?"預售":"租賃"})]},e))})]}),(0,r.jsxs)("button",{onClick:tP,disabled:!eL||0===p.length||g||ek,className:"jsx-4f044084e7cd90f7 w-full bg-gradient-to-r from-amber-600 to-blue-600 hover:from-amber-500 hover:to-blue-500 text-white font-bold py-3 px-4 rounded-lg shadow-lg transition-all disabled:opacity-50 disabled:cursor-not-allowed flex items-center justify-center gap-2",children:[g?(0,r.jsx)("i",{className:"jsx-4f044084e7cd90f7 fas fa-spinner fa-spin"}):(0,r.jsx)("i",{className:"jsx-4f044084e7cd90f7 fas fa-rocket"}),g?"處理中...":"開始上傳"]})]})]}),(0,r.jsxs)("div",{className:"jsx-4f044084e7cd90f7 bg-dark-card p-6 rounded-xl border border-gray-700 shadow-lg",children:[(0,r.jsxs)("h2",{className:"jsx-4f044084e7cd90f7 text-xl font-bold text-white mb-4 flex items-center",children:[(0,r.jsx)("span",{className:"jsx-4f044084e7cd90f7 bg-amber-900 text-amber-400 w-8 h-8 rounded-full flex items-center justify-center mr-3 text-sm",children:"4"}),"資料批次修改 (獨立功能)"]}),(0,r.jsxs)("div",{className:"jsx-4f044084e7cd90f7 space-y-4",children:[(0,r.jsxs)("div",{className:"jsx-4f044084e7cd90f7",children:[(0,r.jsx)("label",{className:"jsx-4f044084e7cd90f7 block text-sm font-medium text-gray-400 mb-1",children:"選擇縣市"}),(0,r.jsx)("select",{value:eF,onChange:e=>eO(e.target.value),className:"jsx-4f044084e7cd90f7 w-full bg-gray-800 border-gray-600 rounded-lg px-3 py-2 text-white focus:ring-amber-500 focus:border-amber-500",children:Object.entries(o).map(([e,t])=>(0,r.jsx)("option",{value:e.toLowerCase(),className:"jsx-4f044084e7cd90f7",children:t},e))})]}),(0,r.jsxs)("div",{className:"jsx-4f044084e7cd90f7",children:[(0,r.jsx)("label",{className:"jsx-4f044084e7cd90f7 block text-sm font-medium text-gray-400 mb-2",children:"交易類型"}),(0,r.jsx)("div",{className:"jsx-4f044084e7cd90f7 grid grid-cols-2 gap-2",children:["a","b","c"].map(e=>(0,r.jsxs)("label",{className:`jsx-4f044084e7cd90f7 cursor-pointer border rounded-lg p-2 text-center transition-all ${eI===e?"bg-amber-900/30 border-amber-500 text-amber-400":"bg-gray-800 border-gray-700 text-gray-400 hover:border-gray-500"}`,children:[(0,r.jsx)("input",{type:"radio",name:"updateType",value:e,checked:eI===e,onChange:e=>eU(e.target.value),disabled:e4,className:"jsx-4f044084e7cd90f7 sr-only"}),(0,r.jsx)("span",{className:"jsx-4f044084e7cd90f7 font-bold",children:"a"===e?"中古":"b"===e?"預售":"租賃"})]},e))})]}),(0,r.jsxs)("div",{className:"jsx-4f044084e7cd90f7",children:[(0,r.jsx)("label",{className:"jsx-4f044084e7cd90f7 block text-sm font-medium text-gray-400 mb-1",children:"搜尋欄位"}),(0,r.jsxs)("select",{value:eW,onChange:e=>eD(e.target.value),className:"jsx-4f044084e7cd90f7 w-full bg-gray-800 border-gray-600 rounded-lg px-3 py-2 text-white focus:ring-amber-500 focus:border-amber-500",children:[Array.from(new Set(Object.values(f[eI]||{}))).filter(e=>!["編號","id"].includes(e)).sort().map(e=>(0,r.jsx)("option",{value:e,className:"jsx-4f044084e7cd90f7",children:e},e)),(0,r.jsx)("option",{value:"編號",className:"jsx-4f044084e7cd90f7",children:"編號"})]})]}),(0,r.jsxs)("div",{className:"jsx-4f044084e7cd90f7",children:[(0,r.jsx)("label",{className:"jsx-4f044084e7cd90f7 block text-sm font-medium text-gray-400 mb-1",children:"關鍵字"}),(0,r.jsx)("input",{type:"text",value:eB,onChange:e=>eJ(e.target.value),placeholder:"輸入關鍵字...",autoComplete:"off",className:"jsx-4f044084e7cd90f7 w-full bg-gray-800 border-gray-600 rounded-lg px-3 py-2 text-white focus:ring-amber-500 focus:border-amber-500 placeholder-gray-600"})]}),(0,r.jsxs)("button",{onClick:tD,disabled:!eL||e4,className:"jsx-4f044084e7cd90f7 w-full bg-gray-700 hover:bg-gray-600 text-white font-bold py-3 px-4 rounded-lg transition-colors flex items-center justify-center gap-2 disabled:opacity-50",children:[e4?(0,r.jsx)("i",{className:"jsx-4f044084e7cd90f7 fas fa-spinner fa-spin"}):(0,r.jsx)("i",{className:"jsx-4f044084e7cd90f7 fas fa-search"}),e4?"搜尋中...":"搜尋資料"]})]})]}),(0,r.jsxs)("div",{className:"jsx-4f044084e7cd90f7 bg-dark-card p-6 rounded-xl border border-gray-700 shadow-lg",children:[(0,r.jsxs)("h2",{className:"jsx-4f044084e7cd90f7 text-xl font-bold text-white mb-4 flex items-center",children:[(0,r.jsx)("span",{className:"jsx-4f044084e7cd90f7 bg-amber-900 text-amber-400 w-8 h-8 rounded-full flex items-center justify-center mr-3 text-sm",children:"5"}),"資料庫全表稽核"]}),(0,r.jsxs)("div",{className:"jsx-4f044084e7cd90f7 space-y-4",children:[(0,r.jsxs)("div",{className:"jsx-4f044084e7cd90f7",children:[(0,r.jsx)("label",{className:"jsx-4f044084e7cd90f7 block text-sm font-medium text-gray-400 mb-1",children:"目標縣市"}),(0,r.jsxs)("select",{value:tt,onChange:e=>ts(e.target.value),disabled:tl||tm,className:"jsx-4f044084e7cd90f7 w-full bg-gray-800 border-gray-600 rounded-lg px-3 py-2 text-white focus:ring-amber-500 focus:border-amber-500",children:[(0,r.jsx)("option",{value:"all",className:"jsx-4f044084e7cd90f7",children:"\uD83D\uDD0D 全部縣市"}),Object.entries(o).map(([e,t])=>(0,r.jsx)("option",{value:e.toLowerCase(),className:"jsx-4f044084e7cd90f7",children:t},e))]})]}),(0,r.jsxs)("div",{className:"jsx-4f044084e7cd90f7",children:[(0,r.jsx)("label",{className:"jsx-4f044084e7cd90f7 block text-sm font-medium text-gray-400 mb-2",children:"交易類型"}),(0,r.jsx)("div",{className:"jsx-4f044084e7cd90f7 grid grid-cols-2 gap-2",children:["a","b","c"].map(e=>(0,r.jsxs)("label",{className:`jsx-4f044084e7cd90f7 cursor-pointer border rounded-lg p-2 text-center transition-all ${tr===e?"bg-amber-900/30 border-amber-500 text-amber-400":"bg-gray-800 border-gray-700 text-gray-400 hover:border-gray-500"}`,children:[(0,r.jsx)("input",{type:"radio",name:"auditType",value:e,checked:tr===e,onChange:e=>ta(e.target.value),disabled:tl||tm,className:"jsx-4f044084e7cd90f7 sr-only"}),(0,r.jsx)("span",{className:"jsx-4f044084e7cd90f7 font-bold",children:"a"===e?"中古":"b"===e?"預售":"租賃"})]},e))})]}),(0,r.jsxs)("button",{onClick:tL,disabled:tl||tm||tv,className:"jsx-4f044084e7cd90f7 w-full bg-indigo-700 hover:bg-indigo-600 text-white font-bold py-3 px-4 rounded-lg shadow-lg transition-all disabled:opacity-50 disabled:cursor-not-allowed flex items-center justify-center gap-2",children:[tl?(0,r.jsx)("i",{className:"jsx-4f044084e7cd90f7 fas fa-spinner fa-spin"}):(0,r.jsx)(eh.A,{className:"w-5 h-5"}),tl?"掃描中...":"執行全表稽核"]}),(0,r.jsx)("div",{className:"jsx-4f044084e7cd90f7 text-xs text-gray-500",children:"提示：全表稽核會執行 Edge Function，掃描指定縣市與類型的所有資料，比對主附表車位數量。"})]})]})]}),(0,r.jsxs)("div",{className:"jsx-4f044084e7cd90f7 lg:col-span-2 space-y-6",children:[(0,r.jsxs)("div",{className:"jsx-4f044084e7cd90f7 bg-dark-card p-6 rounded-xl border border-gray-700 shadow-lg",children:[(0,r.jsxs)("h3",{className:"jsx-4f044084e7cd90f7 text-gray-300 font-bold mb-4 flex justify-between items-center",children:[(0,r.jsxs)("span",{className:"jsx-4f044084e7cd90f7",children:[(0,r.jsx)("i",{className:"jsx-4f044084e7cd90f7 fas fa-tasks mr-2 text-purple-400"}),sh]}),sm&&(0,r.jsxs)("span",{className:"jsx-4f044084e7cd90f7 text-amber-400",children:[su,"%"]})]}),(0,r.jsx)("div",{className:"jsx-4f044084e7cd90f7 w-full bg-gray-700 rounded-full h-4 mb-2 overflow-hidden",children:(0,r.jsx)("div",{style:{width:`${su}%`},className:"jsx-4f044084e7cd90f7 bg-gradient-to-r from-amber-500 to-purple-500 h-4 rounded-full transition-all duration-300 relative",children:sm&&(0,r.jsx)("div",{className:"jsx-4f044084e7cd90f7 absolute inset-0 bg-white/20 animate-pulse"})})}),(0,r.jsx)("div",{className:"jsx-4f044084e7cd90f7 text-xs text-gray-500 h-5",children:sg})]}),(0,r.jsxs)("div",{className:"jsx-4f044084e7cd90f7 bg-black/60 p-4 rounded-xl border border-gray-800 h-[500px] overflow-hidden flex flex-col font-mono text-sm shadow-inner",children:[(0,r.jsxs)("div",{className:"jsx-4f044084e7cd90f7 flex justify-between items-center mb-2 border-b border-gray-800 pb-2",children:[(0,r.jsxs)("span",{className:"jsx-4f044084e7cd90f7 text-gray-400 font-bold",children:[(0,r.jsx)("i",{className:"jsx-4f044084e7cd90f7 fas fa-terminal mr-2"}),"系統日誌"]}),(0,r.jsx)("button",{onClick:()=>h([]),className:"jsx-4f044084e7cd90f7 text-xs text-gray-600 hover:text-gray-300 transition-colors",children:"清除"})]}),(0,r.jsxs)("div",{ref:e=>{e&&(e.scrollTop=e.scrollHeight)},className:"jsx-4f044084e7cd90f7 flex-1 overflow-y-auto space-y-1 p-2 custom-scrollbar",children:[u.map(e=>(0,r.jsxs)("div",{className:`jsx-4f044084e7cd90f7 flex gap-3 leading-relaxed border-b border-white/5 pb-1 ${"error"===e.type?"text-red-400 bg-red-900/10":"warning"===e.type?"text-yellow-400":"success"===e.type?"text-emerald-400":"text-gray-300"}`,children:[(0,r.jsxs)("span",{className:"jsx-4f044084e7cd90f7 text-gray-600 select-none",children:["[",e.time,"]"]}),(0,r.jsx)("span",{className:"jsx-4f044084e7cd90f7 break-all",children:e.text})]},e.id)),0===u.length&&(0,r.jsx)("div",{className:"jsx-4f044084e7cd90f7 text-gray-700 italic text-center mt-20",children:"等待任務啟動..."})]})]}),Q&&(0,r.jsxs)("div",{className:"jsx-4f044084e7cd90f7 grid grid-cols-2 md:grid-cols-4 gap-4",children:[(0,r.jsxs)("div",{className:"jsx-4f044084e7cd90f7 bg-emerald-900/20 border border-emerald-800 p-4 rounded-xl text-center",children:[(0,r.jsx)("div",{className:"jsx-4f044084e7cd90f7 text-3xl font-bold text-emerald-400",children:Q.new}),(0,r.jsx)("div",{className:"jsx-4f044084e7cd90f7 text-sm text-emerald-200/70 uppercase tracking-wider mt-1",children:"New"})]}),(0,r.jsxs)("div",{className:"jsx-4f044084e7cd90f7 bg-yellow-900/20 border border-yellow-800 p-4 rounded-xl text-center",children:[(0,r.jsx)("div",{className:"jsx-4f044084e7cd90f7 text-3xl font-bold text-yellow-400",children:Q.updated}),(0,r.jsx)("div",{className:"jsx-4f044084e7cd90f7 text-sm text-yellow-200/70 uppercase tracking-wider mt-1",children:"Updated"})]}),(0,r.jsxs)("div",{className:"jsx-4f044084e7cd90f7 bg-gray-800/40 border border-gray-700 p-4 rounded-xl text-center",children:[(0,r.jsx)("div",{className:"jsx-4f044084e7cd90f7 text-3xl font-bold text-gray-400",children:Q.identical}),(0,r.jsx)("div",{className:"jsx-4f044084e7cd90f7 text-sm text-gray-500 uppercase tracking-wider mt-1",children:"Skipped"})]}),(0,r.jsxs)("div",{className:"jsx-4f044084e7cd90f7 bg-red-900/20 border border-red-800 p-4 rounded-xl text-center",children:[(0,r.jsx)("div",{className:"jsx-4f044084e7cd90f7 text-3xl font-bold text-red-400",children:Q.errors}),(0,r.jsx)("div",{className:"jsx-4f044084e7cd90f7 text-sm text-red-200/70 uppercase tracking-wider mt-1",children:"Errors"})]})]}),Q&&(0,r.jsxs)("div",{className:"jsx-4f044084e7cd90f7 flex flex-wrap gap-2",children:[(0,r.jsxs)("button",{onClick:()=>ei("new"),className:"jsx-4f044084e7cd90f7 px-3 py-2 rounded-lg border border-emerald-700 text-emerald-300 hover:bg-emerald-900/30 transition-colors text-sm",children:["新增明細 (",sn,")"]}),(0,r.jsxs)("button",{onClick:()=>ei("updated"),className:"jsx-4f044084e7cd90f7 px-3 py-2 rounded-lg border border-yellow-700 text-yellow-300 hover:bg-yellow-900/30 transition-colors text-sm",children:["更新/搜尋明細 (",Q.updatedRecords.length,")"]}),(0,r.jsxs)("button",{onClick:()=>ei("identical"),className:"jsx-4f044084e7cd90f7 px-3 py-2 rounded-lg border border-gray-700 text-gray-300 hover:bg-gray-800/60 transition-colors text-sm",children:["跳過明細 (",Q.identicalRecords.length,")"]}),(0,r.jsxs)("button",{onClick:()=>ei("errors"),className:"jsx-4f044084e7cd90f7 px-3 py-2 rounded-lg border border-red-700 text-red-300 hover:bg-red-900/30 transition-colors text-sm",children:["錯誤檔案 (",Q.errorFiles.length,")"]}),(0,r.jsxs)("button",{onClick:()=>ei("warnings"),className:"jsx-4f044084e7cd90f7 px-3 py-2 rounded-lg border border-amber-700 text-amber-300 hover:bg-amber-900/30 transition-colors text-sm",children:["問題清單 (",t9,")"]}),(0,r.jsx)("button",{onClick:tT,disabled:ew||g||ek,className:"jsx-4f044084e7cd90f7 px-3 py-2 rounded-lg border border-teal-700 text-teal-300 hover:bg-teal-900/30 transition-colors text-sm disabled:opacity-50",children:ew?"檢查中...":"本次上傳全數內容檢查"}),(0,r.jsx)("button",{onClick:tE,disabled:ev||g||ek,className:"jsx-4f044084e7cd90f7 px-3 py-2 rounded-lg border border-amber-700 text-amber-300 hover:bg-amber-900/30 transition-colors text-sm disabled:opacity-50",children:ev?"警告檢查中...":"本次警告內容檢查"}),(0,r.jsxs)("div",{className:"jsx-4f044084e7cd90f7 text-xs text-gray-500 flex items-center",children:["明細上限 ",Q.detailLimit," 筆"]})]})]})]})]}),sd&&(0,r.jsx)("div",{onClick:()=>ei(null),className:"jsx-4f044084e7cd90f7 fixed inset-0 z-50 flex items-center justify-center bg-black/80 p-4",children:(0,r.jsxs)("div",{onClick:e=>e.stopPropagation(),className:"jsx-4f044084e7cd90f7 bg-dark-bg border border-gray-700 rounded-xl w-full max-w-6xl max-h-[90vh] flex flex-col shadow-2xl",children:[(0,r.jsxs)("div",{className:"jsx-4f044084e7cd90f7 p-4 border-b border-gray-700 flex justify-between items-center bg-dark-card rounded-t-xl",children:[(0,r.jsxs)("div",{className:"jsx-4f044084e7cd90f7",children:[(0,r.jsx)("h3",{className:"jsx-4f044084e7cd90f7 text-xl font-bold text-white",children:sd.title}),(0,r.jsxs)("p",{className:"jsx-4f044084e7cd90f7 text-sm text-gray-400 mt-1",children:["顯示 ",sf?.startIndex!==void 0?`${sf.startIndex+1}-${sf.endIndex}`:sd.items.length," / ",sd.items.length," 筆",Q&&`（保留上限 ${Q.detailLimit}）`,sd.truncated>0&&`，超出未顯示 ${sd.truncated} 筆`]})]}),(0,r.jsx)("button",{onClick:()=>ei(null),className:"jsx-4f044084e7cd90f7 text-gray-400 hover:text-white transition-colors",children:(0,r.jsx)("i",{className:"jsx-4f044084e7cd90f7 fas fa-times text-xl"})})]}),(0,r.jsxs)("div",{className:"jsx-4f044084e7cd90f7 p-4 border-b border-gray-700 flex items-center justify-between text-sm text-gray-400",children:[(0,r.jsxs)("div",{className:"jsx-4f044084e7cd90f7 flex items-center gap-3 flex-wrap",children:[(0,r.jsxs)("div",{className:"jsx-4f044084e7cd90f7",children:["每頁 ",sf?.pageSize??so," 筆"]}),"new"===el&&(0,r.jsxs)("div",{className:"jsx-4f044084e7cd90f7 flex items-center gap-3 text-xs text-gray-400",children:[(0,r.jsxs)("span",{className:"jsx-4f044084e7cd90f7",children:["主表: ",(Q?.newRecords||[]).length]}),(0,r.jsxs)("span",{className:"jsx-4f044084e7cd90f7",children:["附表: ",(Q?.subAddedRecords||[]).length]})]}),"warnings"===el&&(0,r.jsxs)("div",{className:"jsx-4f044084e7cd90f7 flex items-center gap-2 text-xs flex-wrap",children:[(0,r.jsx)("span",{className:"jsx-4f044084e7cd90f7 text-gray-500",children:"篩選:"}),(0,r.jsx)("button",{onClick:()=>ep("active"),className:`jsx-4f044084e7cd90f7 px-2 py-1 rounded border ${"active"===ex?"border-amber-500 text-amber-300":"border-gray-700 text-gray-400 hover:text-gray-200"}`,children:"未解決"}),(0,r.jsx)("button",{onClick:()=>ep("all"),className:`jsx-4f044084e7cd90f7 px-2 py-1 rounded border ${"all"===ex?"border-amber-500 text-amber-300":"border-gray-700 text-gray-400 hover:text-gray-200"}`,children:"全部"}),(0,r.jsx)("span",{className:"jsx-4f044084e7cd90f7 text-gray-500 ml-2",children:"類型:"}),(0,r.jsx)("button",{onClick:()=>ey("all"),className:`jsx-4f044084e7cd90f7 px-2 py-1 rounded border ${"all"===ej?"border-amber-500 text-amber-300":"border-gray-700 text-gray-400 hover:text-gray-200"}`,children:"全部"}),(0,r.jsxs)("button",{onClick:()=>ey("count"),className:`jsx-4f044084e7cd90f7 px-2 py-1 rounded border ${"count"===ej?"border-amber-500 text-amber-300":"border-gray-700 text-gray-400 hover:text-gray-200"}`,children:["車位數不一致 (",t1.count,")"]}),(0,r.jsxs)("button",{onClick:()=>ey("missing_main"),className:`jsx-4f044084e7cd90f7 px-2 py-1 rounded border ${"missing_main"===ej?"border-amber-500 text-amber-300":"border-gray-700 text-gray-400 hover:text-gray-200"}`,children:["主表缺失 (",t1.missing_main,")"]}),t3>0&&(0,r.jsxs)("button",{onClick:tA,disabled:ek||g||sx,className:`jsx-4f044084e7cd90f7 px-2 py-1 rounded border ${ek?"border-amber-700 text-amber-500":"border-emerald-500 text-emerald-300 hover:text-emerald-200"}`,children:["全部修正(價格一致 ",t3,")"]})]})]}),(0,r.jsxs)("div",{className:"jsx-4f044084e7cd90f7 flex items-center gap-2",children:[(0,r.jsx)("button",{onClick:()=>ec(Math.max(1,(sf?.currentPage||1)-1)),disabled:1>=(sf?.currentPage||1),className:"jsx-4f044084e7cd90f7 px-2 py-1 rounded border border-gray-700 text-gray-300 hover:bg-gray-800 disabled:opacity-40",children:"上一頁"}),(0,r.jsxs)("span",{className:"jsx-4f044084e7cd90f7",children:[sf?.currentPage||1," / ",sf?.totalPages||1]}),(0,r.jsx)("button",{onClick:()=>ec(Math.min(sf?.totalPages||1,(sf?.currentPage||1)+1)),disabled:(sf?.currentPage||1)>=(sf?.totalPages||1),className:"jsx-4f044084e7cd90f7 px-2 py-1 rounded border border-gray-700 text-gray-300 hover:bg-gray-800 disabled:opacity-40",children:"下一頁"})]})]}),(0,r.jsxs)("div",{className:"jsx-4f044084e7cd90f7 p-4 overflow-y-auto space-y-3",children:["updated"===el&&sd.items.slice(sf?.startIndex||0,sf?.endIndex||sd.items.length).map((e,t)=>(0,r.jsxs)("div",{className:"jsx-4f044084e7cd90f7 bg-gray-900/60 border border-gray-700 rounded-lg p-4 space-y-3",children:[(0,r.jsxs)("div",{className:"jsx-4f044084e7cd90f7 flex flex-wrap items-center justify-between gap-2",children:[(0,r.jsxs)("div",{className:"jsx-4f044084e7cd90f7 text-sm text-gray-200",children:[(0,r.jsx)("span",{className:"jsx-4f044084e7cd90f7 text-gray-400",children:"編號:"})," ",e.id||e?.newData?.["編號"]||"-"]}),(0,r.jsx)("div",{className:"jsx-4f044084e7cd90f7 text-xs text-gray-500 break-all",children:e.file})]}),(0,r.jsx)("div",{className:"jsx-4f044084e7cd90f7 text-xs text-amber-300",children:"priority"===e.reason?"更新原因：來源優先級較高 (edit > list > opendata)":"更新原因：欄位內容不同"}),(0,r.jsxs)("div",{className:"jsx-4f044084e7cd90f7 space-y-2",children:[(0,r.jsx)("div",{className:"jsx-4f044084e7cd90f7 text-xs uppercase tracking-wider text-gray-400",children:"欄位差異"}),e.diffFields&&e.diffFields.length>0?(0,r.jsx)("div",{className:"jsx-4f044084e7cd90f7 space-y-2",children:e.diffFields.map((e,t)=>(0,r.jsxs)("div",{className:"jsx-4f044084e7cd90f7 text-xs text-gray-200 grid grid-cols-1 md:grid-cols-3 gap-2 bg-gray-800/60 p-2 rounded",children:[(0,r.jsx)("div",{className:"jsx-4f044084e7cd90f7 text-gray-300",children:e.field}),(0,r.jsxs)("div",{className:"jsx-4f044084e7cd90f7 text-red-300 break-all",children:["舊: ",String(e.oldValue??"")]}),(0,r.jsxs)("div",{className:"jsx-4f044084e7cd90f7 text-emerald-300 break-all",children:["新: ",String(e.newValue??"")]})]},t))}):(0,r.jsx)("div",{className:"jsx-4f044084e7cd90f7 text-xs text-gray-500",children:"沒有可比對的欄位差異"})]}),(0,r.jsxs)("details",{className:"jsx-4f044084e7cd90f7 text-xs text-gray-400",children:[(0,r.jsx)("summary",{className:"jsx-4f044084e7cd90f7 cursor-pointer select-none",children:"查看完整舊/新資料"}),(0,r.jsxs)("div",{className:"jsx-4f044084e7cd90f7 grid grid-cols-1 md:grid-cols-2 gap-4 mt-3",children:[(0,r.jsxs)("div",{className:"jsx-4f044084e7cd90f7",children:[(0,r.jsx)("div",{className:"jsx-4f044084e7cd90f7 text-xs uppercase tracking-wider text-gray-400 mb-2",children:"舊資料"}),(0,r.jsx)("pre",{className:"jsx-4f044084e7cd90f7 text-xs text-gray-200 whitespace-pre-wrap break-all",children:JSON.stringify(e.oldData,null,2)})]}),(0,r.jsxs)("div",{className:"jsx-4f044084e7cd90f7",children:[(0,r.jsx)("div",{className:"jsx-4f044084e7cd90f7 text-xs uppercase tracking-wider text-gray-400 mb-2",children:"新資料"}),(0,r.jsx)("pre",{className:"jsx-4f044084e7cd90f7 text-xs text-gray-200 whitespace-pre-wrap break-all",children:JSON.stringify(e.newData,null,2)})]})]})]})]},t)),"new"===el&&sd.items.slice(sf?.startIndex||0,sf?.endIndex||sd.items.length).map((e,t)=>(0,r.jsx)("div",{className:"jsx-4f044084e7cd90f7 bg-gray-900/60 border border-gray-700 rounded-lg p-4",children:(0,r.jsx)("pre",{className:"jsx-4f044084e7cd90f7 text-xs text-gray-200 whitespace-pre-wrap break-all",children:JSON.stringify(e,null,2)})},t)),"identical"===el&&sd.items.slice(sf?.startIndex||0,sf?.endIndex||sd.items.length).map((e,t)=>(0,r.jsx)("div",{className:"jsx-4f044084e7cd90f7 bg-gray-900/60 border border-gray-700 rounded-lg p-4",children:(0,r.jsx)("pre",{className:"jsx-4f044084e7cd90f7 text-xs text-gray-200 whitespace-pre-wrap break-all",children:JSON.stringify(e,null,2)})},t)),"errors"===el&&sd.items.slice(sf?.startIndex||0,sf?.endIndex||sd.items.length).map((e,t)=>(0,r.jsxs)("div",{className:"jsx-4f044084e7cd90f7 bg-red-900/20 border border-red-800 rounded-lg p-4",children:[(0,r.jsx)("div",{className:"jsx-4f044084e7cd90f7 text-sm text-red-200 font-semibold",children:e.file}),(0,r.jsx)("div",{className:"jsx-4f044084e7cd90f7 text-xs text-red-300 mt-1 break-all",children:e.message})]},t)),"warnings"===el&&sd.items.slice(sf?.startIndex||0,sf?.endIndex||sd.items.length).map((e,t)=>{let s=e.table&&e.id?`${e.table}|${e.id}`:"",a=s?t5.get(s):null;return(0,r.jsxs)("div",{className:"jsx-4f044084e7cd90f7 bg-amber-900/20 border border-amber-800 rounded-lg p-4 space-y-2",children:[(0,r.jsxs)("div",{className:"jsx-4f044084e7cd90f7 text-[11px] text-amber-300/70",children:["來源: ","audit"===e.stage?"最終檢查":"上傳警告"," | 狀態: ","resolved"===e.status?"已解決":"review"===e.status?"待確認":"未解決"]}),e.file&&(0,r.jsx)("div",{className:"jsx-4f044084e7cd90f7 text-xs text-amber-200 break-all",children:e.file}),(0,r.jsxs)("div",{className:"jsx-4f044084e7cd90f7 text-sm text-amber-100 font-semibold",children:["編號: ",e.id||"-"]}),"audit"===e.stage&&(void 0!==e.mainCount||void 0!==e.parkCount)&&(0,r.jsxs)("div",{className:"jsx-4f044084e7cd90f7 text-xs text-amber-200",children:["主表車位數: ",e.mainCount??"-","，附表筆數: ",e.parkCount??"-"]}),a&&(0,r.jsxs)("div",{className:"jsx-4f044084e7cd90f7 text-xs text-emerald-200 space-y-1",children:[(0,r.jsxs)("div",{className:"jsx-4f044084e7cd90f7",children:["主表車位總價(萬): ",a.mainPrice,"｜附表車位價格合計(萬): ",a.parkPriceSum]}),(0,r.jsxs)("div",{className:"jsx-4f044084e7cd90f7",children:["可修正主表車位數為 ",a.parkCount]})]}),(0,r.jsx)("div",{className:"jsx-4f044084e7cd90f7 text-xs text-amber-200 break-all",children:e.message}),e.table&&(0,r.jsx)("div",{className:"jsx-4f044084e7cd90f7 text-[11px] text-amber-300/70",children:e.table}),a&&(0,r.jsx)("div",{className:"jsx-4f044084e7cd90f7 pt-2",children:(0,r.jsx)("button",{onClick:()=>tz(e.table,e.id),disabled:ek||g||sx,className:"jsx-4f044084e7cd90f7 px-3 py-1 rounded border border-emerald-500 text-emerald-300 hover:text-emerald-200",children:"修正這筆"})})]},t)}),0===sd.items.length&&(0,r.jsx)("div",{className:"jsx-4f044084e7cd90f7 text-sm text-gray-500 text-center py-10",children:"目前沒有可顯示的明細"})]}),(0,r.jsx)("div",{className:"jsx-4f044084e7cd90f7 p-4 border-t border-gray-700 flex justify-end bg-dark-card rounded-b-xl",children:(0,r.jsx)("button",{onClick:()=>ei(null),className:"jsx-4f044084e7cd90f7 px-4 py-2 rounded-lg border border-gray-700 text-gray-300 hover:bg-gray-800 transition-colors",children:"關閉"})})]})}),eK&&(0,r.jsx)("div",{className:"jsx-4f044084e7cd90f7 fixed inset-0 z-50 flex items-center justify-center bg-black/80 p-4",children:(0,r.jsxs)("div",{className:"jsx-4f044084e7cd90f7 bg-dark-bg border border-gray-700 rounded-xl w-full max-w-6xl max-h-[90vh] flex flex-col shadow-2xl",children:[(0,r.jsxs)("div",{className:"jsx-4f044084e7cd90f7 p-4 border-b border-gray-700 flex justify-between items-center bg-dark-card rounded-t-xl",children:[(0,r.jsxs)("div",{className:"jsx-4f044084e7cd90f7",children:[(0,r.jsx)("h3",{className:"jsx-4f044084e7cd90f7 text-xl font-bold text-white",children:"批次修改搜尋結果"}),(0,r.jsxs)("p",{className:"jsx-4f044084e7cd90f7 text-sm text-gray-400 mt-1",children:["資料表: ",e1?.tableName," | 搜尋條件: ",o[eF.toUpperCase()]," ",eW," like '%",eB,"%' | 共 ",eV.length," 筆"]})]}),(0,r.jsx)("button",{onClick:()=>eH(!1),className:"jsx-4f044084e7cd90f7 text-gray-400 hover:text-white transition-colors",children:(0,r.jsx)("i",{className:"jsx-4f044084e7cd90f7 fas fa-times text-xl"})})]}),(0,r.jsxs)("div",{className:"jsx-4f044084e7cd90f7 p-4 border-b border-gray-700 bg-gray-800/50 flex gap-4 items-end flex-wrap",children:[(0,r.jsxs)("div",{className:"jsx-4f044084e7cd90f7 flex items-center gap-2 text-sm text-gray-300",children:[(0,r.jsx)("input",{type:"checkbox",checked:eG.size>0&&eG.size===eV.length,onChange:tV,className:"jsx-4f044084e7cd90f7 form-checkbox h-5 w-5 text-amber-600 bg-gray-700 border-gray-600 rounded"}),(0,r.jsxs)("span",{className:"jsx-4f044084e7cd90f7",children:["全選 (",eG.size," 筆)"]})]}),(0,r.jsx)("div",{className:"jsx-4f044084e7cd90f7 flex-1"}),(0,r.jsxs)("div",{className:"jsx-4f044084e7cd90f7 flex gap-2 items-center",children:[(0,r.jsxs)("div",{className:"jsx-4f044084e7cd90f7",children:[(0,r.jsx)("label",{className:"jsx-4f044084e7cd90f7 block text-xs text-gray-400 mb-1",children:"欲修改欄位"}),(0,r.jsx)("select",{value:eX,onChange:e=>eY(e.target.value),className:"jsx-4f044084e7cd90f7 bg-gray-800 border-gray-600 rounded px-3 py-1.5 text-sm text-white focus:ring-amber-500",children:Array.from(new Set(Object.values(f[eI]||{}))).filter(e=>!["編號","id"].includes(e)).sort().map(e=>(0,r.jsx)("option",{value:e,className:"jsx-4f044084e7cd90f7",children:e},e))})]}),(0,r.jsxs)("div",{className:"jsx-4f044084e7cd90f7",children:[(0,r.jsx)("label",{className:"jsx-4f044084e7cd90f7 block text-xs text-gray-400 mb-1",children:"新數值"}),(0,r.jsx)("input",{type:"text",value:eZ,onChange:e=>e0(e.target.value),placeholder:"輸入新內容...",className:"jsx-4f044084e7cd90f7 bg-gray-800 border-gray-600 rounded px-3 py-1.5 text-sm text-white w-48 focus:ring-amber-500"})]}),(0,r.jsx)("div",{className:"jsx-4f044084e7cd90f7 pb-0.5",children:(0,r.jsx)("button",{onClick:tB,disabled:0===eG.size||e8,className:"jsx-4f044084e7cd90f7 bg-red-600 hover:bg-red-500 text-white font-bold py-1.5 px-4 rounded transition-colors text-sm disabled:opacity-50 disabled:cursor-not-allowed h-[34px]",children:e8?"更新中...":"執行批次更新"})})]})]}),(0,r.jsxs)("div",{className:"jsx-4f044084e7cd90f7 flex-1 overflow-auto px-0 pb-4 pt-0 custom-scrollbar",children:[(0,r.jsxs)("table",{className:"jsx-4f044084e7cd90f7 w-full text-left border-collapse table-fixed",children:[(0,r.jsxs)("colgroup",{className:"jsx-4f044084e7cd90f7",children:[(0,r.jsx)("col",{className:"jsx-4f044084e7cd90f7 w-12"}),(0,r.jsx)("col",{className:"jsx-4f044084e7cd90f7 w-64"}),(0,r.jsx)("col",{className:"jsx-4f044084e7cd90f7 w-24"}),(0,r.jsx)("col",{className:"jsx-4f044084e7cd90f7 w-56"}),(0,r.jsx)("col",{className:"jsx-4f044084e7cd90f7"}),(0,r.jsx)("col",{className:"jsx-4f044084e7cd90f7 w-16"})]}),(0,r.jsx)("thead",{className:"jsx-4f044084e7cd90f7 bg-gray-900 sticky top-0 z-10 backdrop-blur",children:(0,r.jsxs)("tr",{className:"jsx-4f044084e7cd90f7",children:[(0,r.jsx)("th",{className:"jsx-4f044084e7cd90f7 p-3 text-xs font-bold text-gray-400 border-b border-gray-700 whitespace-nowrap",children:"選取"}),(0,r.jsx)("th",{className:"jsx-4f044084e7cd90f7 p-3 text-xs font-bold text-gray-400 border-b border-gray-700 whitespace-nowrap",children:"編號"}),(0,r.jsx)("th",{className:"jsx-4f044084e7cd90f7 p-3 text-xs font-bold text-gray-400 border-b border-gray-700 whitespace-nowrap",children:"行政區"}),(0,r.jsx)("th",{className:"jsx-4f044084e7cd90f7 p-3 text-xs font-bold text-gray-400 border-b border-gray-700 whitespace-nowrap",children:"建案名稱"}),(0,r.jsx)("th",{className:"jsx-4f044084e7cd90f7 p-3 text-xs font-bold text-gray-400 border-b border-gray-700 whitespace-nowrap",children:"地址/位置"}),(0,r.jsx)("th",{className:"jsx-4f044084e7cd90f7 p-3 text-xs font-bold text-gray-400 border-b border-gray-700 whitespace-nowrap",children:"操作"})]})}),(0,r.jsx)("tbody",{className:"jsx-4f044084e7cd90f7 text-sm",children:eV.map((e,t)=>(0,r.jsxs)(r.Fragment,{children:[(0,r.jsxs)("tr",{className:"jsx-4f044084e7cd90f7 hover:bg-white/5 border-b border-gray-800",children:[(0,r.jsx)("td",{className:"jsx-4f044084e7cd90f7 p-3",children:(0,r.jsx)("input",{type:"checkbox",checked:eG.has(e["編號"]),onChange:()=>tJ(e["編號"]),className:"jsx-4f044084e7cd90f7 form-checkbox h-4 w-4 text-amber-600 bg-gray-700 border-gray-600 rounded"})}),(0,r.jsx)("td",{className:"jsx-4f044084e7cd90f7 p-3 font-mono text-xs text-gray-400 break-all",children:e["編號"]}),(0,r.jsx)("td",{className:"jsx-4f044084e7cd90f7 p-3 whitespace-nowrap",children:e["行政區"]}),(0,r.jsx)("td",{className:"jsx-4f044084e7cd90f7 p-3 text-amber-300 truncate",children:e["建案名稱"]}),(0,r.jsx)("td",{className:"jsx-4f044084e7cd90f7 p-3 text-gray-400 truncate",children:e["其他門牌"]||e["地址"]||e["土地位置建物門牌"]}),(0,r.jsx)("td",{className:"jsx-4f044084e7cd90f7 p-3",children:(0,r.jsx)("button",{onClick:()=>tq(t),className:"jsx-4f044084e7cd90f7 text-gray-500 hover:text-white text-xs underline",children:e5.has(t)?"收合":"明細"})})]},e["編號"]),e5.has(t)&&(0,r.jsx)("tr",{className:"jsx-4f044084e7cd90f7 bg-gray-900/50",children:(0,r.jsx)("td",{colSpan:6,className:"jsx-4f044084e7cd90f7 p-4 border-b border-gray-800",children:(0,r.jsx)("div",{className:"jsx-4f044084e7cd90f7 grid grid-cols-2 md:grid-cols-4 gap-4 text-xs",children:Object.entries(e).filter(([e])=>"id"!==e).map(([e,t])=>(0,r.jsxs)("div",{className:"jsx-4f044084e7cd90f7",children:[(0,r.jsx)("div",{className:"jsx-4f044084e7cd90f7 text-gray-500 mb-1",children:e}),(0,r.jsx)("div",{className:"jsx-4f044084e7cd90f7 text-gray-300 break-all",children:String(t)})]},e))})})})]}))})]}),0===eV.length&&(0,r.jsx)("div",{className:"jsx-4f044084e7cd90f7 text-center py-20 text-gray-500",children:"無符合資料"})]})]})}),eK&&(0,r.jsx)("div",{onClick:()=>eH(!1),className:"jsx-4f044084e7cd90f7 fixed inset-0 z-50 flex items-center justify-center bg-black/80 p-4 transition-opacity animate-in fade-in duration-200",children:(0,r.jsxs)("div",{onClick:e=>e.stopPropagation(),className:"jsx-4f044084e7cd90f7 bg-dark-bg border border-gray-700 rounded-xl w-full max-w-6xl max-h-[90vh] flex flex-col shadow-2xl relative",children:[(0,r.jsxs)("div",{className:"jsx-4f044084e7cd90f7 p-4 border-b border-gray-700 flex justify-between items-center bg-dark-card rounded-t-xl",children:[(0,r.jsxs)("div",{className:"jsx-4f044084e7cd90f7",children:[(0,r.jsx)("h3",{className:"jsx-4f044084e7cd90f7 text-xl font-bold text-white",children:"批次修改搜尋結果"}),(0,r.jsxs)("p",{className:"jsx-4f044084e7cd90f7 text-sm text-gray-400 mt-1",children:["資料表: ",e1?.tableName," | 搜尋條件: ",o[eF.toUpperCase()]," ",eW," like '%",eB,"%' | 共 ",eV.length," 筆"]})]}),(0,r.jsx)("button",{onClick:()=>eH(!1),title:"關閉視窗 (Esc)",className:"jsx-4f044084e7cd90f7 text-gray-400 hover:text-white hover:bg-gray-700/50 p-2 rounded-full transition-colors flex items-center justify-center w-8 h-8",children:(0,r.jsx)("i",{className:"jsx-4f044084e7cd90f7 fas fa-times text-xl"})})]}),(0,r.jsxs)("div",{className:"jsx-4f044084e7cd90f7 bg-dark-card border-b border-gray-700",children:[(0,r.jsxs)("button",{onClick:()=>te(!e6),className:"jsx-4f044084e7cd90f7 w-full text-center py-2 text-xs text-gray-500 hover:text-white hover:bg-gray-700/50 transition-colors flex items-center justify-center gap-2",children:[(0,r.jsx)("i",{className:`jsx-4f044084e7cd90f7 fas fa-search ${e6?"text-amber-400":""}`}),e6?"收合搜尋條件":"再次搜尋 / 修改條件"]}),e6&&(0,r.jsxs)("div",{className:"jsx-4f044084e7cd90f7 p-4 grid grid-cols-1 md:grid-cols-5 gap-4 animate-in slide-in-from-top-2 duration-200",children:[(0,r.jsxs)("div",{className:"jsx-4f044084e7cd90f7",children:[(0,r.jsx)("label",{className:"jsx-4f044084e7cd90f7 block text-xs text-gray-400 mb-1",children:"縣市"}),(0,r.jsx)("select",{value:eF,onChange:e=>eO(e.target.value),className:"jsx-4f044084e7cd90f7 w-full bg-gray-800 border-gray-600 rounded px-2 py-1.5 text-sm text-white focus:ring-amber-500",children:Object.entries(o).map(([e,t])=>(0,r.jsx)("option",{value:e.toLowerCase(),className:"jsx-4f044084e7cd90f7",children:t},e))})]}),(0,r.jsxs)("div",{className:"jsx-4f044084e7cd90f7",children:[(0,r.jsx)("label",{className:"jsx-4f044084e7cd90f7 block text-xs text-gray-400 mb-1",children:"類型"}),(0,r.jsx)("div",{className:"jsx-4f044084e7cd90f7 flex bg-gray-800 rounded border border-gray-600 p-0.5",children:["a","b","c"].map(e=>(0,r.jsx)("button",{onClick:()=>eU(e),className:`jsx-4f044084e7cd90f7 flex-1 text-xs py-1 rounded transition-colors ${eI===e?"bg-amber-900 text-amber-400":"text-gray-400 hover:text-white"}`,children:"a"===e?"中古":"b"===e?"預售":"租賃"},e))})]}),(0,r.jsxs)("div",{className:"jsx-4f044084e7cd90f7",children:[(0,r.jsx)("label",{className:"jsx-4f044084e7cd90f7 block text-xs text-gray-400 mb-1",children:"欄位"}),(0,r.jsxs)("select",{value:eW,onChange:e=>eD(e.target.value),className:"jsx-4f044084e7cd90f7 w-full bg-gray-800 border-gray-600 rounded px-2 py-1.5 text-sm text-white focus:ring-amber-500",children:[Array.from(new Set(Object.values(f[eI]||{}))).filter(e=>!["編號","id"].includes(e)).sort().map(e=>(0,r.jsx)("option",{value:e,className:"jsx-4f044084e7cd90f7",children:e},e)),(0,r.jsx)("option",{value:"編號",className:"jsx-4f044084e7cd90f7",children:"編號"})]})]}),(0,r.jsxs)("div",{className:"jsx-4f044084e7cd90f7",children:[(0,r.jsx)("label",{className:"jsx-4f044084e7cd90f7 block text-xs text-gray-400 mb-1",children:"關鍵字"}),(0,r.jsx)("input",{type:"text",value:eB,onChange:e=>eJ(e.target.value),placeholder:"關鍵字...",autoComplete:"off",className:"jsx-4f044084e7cd90f7 w-full bg-gray-800 border-gray-600 rounded px-2 py-1.5 text-sm text-white focus:ring-amber-500"})]}),(0,r.jsx)("div",{className:"jsx-4f044084e7cd90f7 flex items-end",children:(0,r.jsxs)("button",{onClick:tD,disabled:e4,className:"jsx-4f044084e7cd90f7 w-full bg-amber-600 hover:bg-amber-500 text-white font-bold py-1.5 px-4 rounded transition-colors text-sm h-[34px] flex items-center justify-center gap-2 disabled:opacity-50",children:[e4?(0,r.jsx)("i",{className:"jsx-4f044084e7cd90f7 fas fa-spinner fa-spin"}):(0,r.jsx)("i",{className:"jsx-4f044084e7cd90f7 fas fa-search"}),"搜尋"]})})]})]}),(0,r.jsxs)("div",{className:"jsx-4f044084e7cd90f7 p-4 border-b border-gray-700 bg-gray-800/50 flex gap-4 items-end flex-wrap",children:[(0,r.jsxs)("div",{className:"jsx-4f044084e7cd90f7 flex items-center gap-2 text-sm text-gray-300",children:[(0,r.jsx)("input",{type:"checkbox",checked:eG.size>0&&eG.size===eV.length,onChange:tV,className:"jsx-4f044084e7cd90f7 form-checkbox h-5 w-5 text-amber-600 bg-gray-700 border-gray-600 rounded"}),(0,r.jsxs)("span",{className:"jsx-4f044084e7cd90f7",children:["全選 (",eG.size," 筆)"]})]}),(0,r.jsx)("div",{className:"jsx-4f044084e7cd90f7 flex-1"}),(0,r.jsxs)("div",{className:"jsx-4f044084e7cd90f7 flex gap-2 items-center",children:[(0,r.jsxs)("div",{className:"jsx-4f044084e7cd90f7",children:[(0,r.jsx)("label",{className:"jsx-4f044084e7cd90f7 block text-xs text-gray-400 mb-1",children:"欲修改欄位"}),(0,r.jsx)("select",{value:eX,onChange:e=>eY(e.target.value),className:"jsx-4f044084e7cd90f7 bg-gray-800 border-gray-600 rounded px-3 py-1.5 text-sm text-white focus:ring-amber-500",children:Array.from(new Set(Object.values(f[eI]||{}))).filter(e=>!["編號","id"].includes(e)).sort().map(e=>(0,r.jsx)("option",{value:e,className:"jsx-4f044084e7cd90f7",children:e},e))})]}),(0,r.jsxs)("div",{className:"jsx-4f044084e7cd90f7",children:[(0,r.jsx)("label",{className:"jsx-4f044084e7cd90f7 block text-xs text-gray-400 mb-1",children:"新數值"}),(0,r.jsx)("input",{type:"text",value:eZ,onChange:e=>e0(e.target.value),placeholder:"輸入新內容...",className:"jsx-4f044084e7cd90f7 bg-gray-800 border-gray-600 rounded px-3 py-1.5 text-sm text-white w-48 focus:ring-amber-500"})]}),(0,r.jsx)("div",{className:"jsx-4f044084e7cd90f7 pb-0.5",children:(0,r.jsx)("button",{onClick:tB,disabled:0===eG.size||e8,className:"jsx-4f044084e7cd90f7 bg-red-600 hover:bg-red-500 text-white font-bold py-1.5 px-4 rounded transition-colors text-sm disabled:opacity-50 disabled:cursor-not-allowed h-[34px]",children:e8?"更新中...":"執行批次更新"})})]})]}),(0,r.jsxs)("div",{className:"jsx-4f044084e7cd90f7 flex-1 overflow-auto px-0 pb-4 pt-0 custom-scrollbar",children:[(0,r.jsxs)("table",{className:"jsx-4f044084e7cd90f7 w-full text-left border-collapse table-fixed",children:[(0,r.jsxs)("colgroup",{className:"jsx-4f044084e7cd90f7",children:[(0,r.jsx)("col",{className:"jsx-4f044084e7cd90f7 w-12"}),(0,r.jsx)("col",{className:"jsx-4f044084e7cd90f7 w-64"}),(0,r.jsx)("col",{className:"jsx-4f044084e7cd90f7 w-24"}),(0,r.jsx)("col",{className:"jsx-4f044084e7cd90f7 w-56"}),(0,r.jsx)("col",{className:"jsx-4f044084e7cd90f7"}),(0,r.jsx)("col",{className:"jsx-4f044084e7cd90f7 w-16"})]}),(0,r.jsx)("thead",{className:"jsx-4f044084e7cd90f7 bg-gray-900 sticky top-0 z-10 backdrop-blur",children:(0,r.jsxs)("tr",{className:"jsx-4f044084e7cd90f7",children:[(0,r.jsx)("th",{className:"jsx-4f044084e7cd90f7 p-3 text-xs font-bold text-gray-400 border-b border-gray-700 whitespace-nowrap",children:"選取"}),(0,r.jsx)("th",{className:"jsx-4f044084e7cd90f7 p-3 text-xs font-bold text-gray-400 border-b border-gray-700 whitespace-nowrap",children:"編號"}),(0,r.jsx)("th",{className:"jsx-4f044084e7cd90f7 p-3 text-xs font-bold text-gray-400 border-b border-gray-700 whitespace-nowrap",children:"行政區"}),(0,r.jsx)("th",{className:"jsx-4f044084e7cd90f7 p-3 text-xs font-bold text-gray-400 border-b border-gray-700 whitespace-nowrap",children:"建案名稱"}),(0,r.jsx)("th",{className:"jsx-4f044084e7cd90f7 p-3 text-xs font-bold text-gray-400 border-b border-gray-700 whitespace-nowrap",children:"地址/位置"}),(0,r.jsx)("th",{className:"jsx-4f044084e7cd90f7 p-3 text-xs font-bold text-gray-400 border-b border-gray-700 whitespace-nowrap",children:"操作"})]})}),(0,r.jsx)("tbody",{className:"jsx-4f044084e7cd90f7 text-sm",children:eV.map((e,t)=>(0,r.jsxs)(r.Fragment,{children:[(0,r.jsxs)("tr",{className:"jsx-4f044084e7cd90f7 hover:bg-white/5 border-b border-gray-800",children:[(0,r.jsx)("td",{className:"jsx-4f044084e7cd90f7 p-3",children:(0,r.jsx)("input",{type:"checkbox",checked:eG.has(e["編號"]),onChange:()=>tJ(e["編號"]),className:"jsx-4f044084e7cd90f7 form-checkbox h-4 w-4 text-amber-600 bg-gray-700 border-gray-600 rounded"})}),(0,r.jsx)("td",{className:"jsx-4f044084e7cd90f7 p-3 font-mono text-xs text-gray-400 break-all",children:e["編號"]}),(0,r.jsx)("td",{className:"jsx-4f044084e7cd90f7 p-3 whitespace-nowrap",children:e["行政區"]}),(0,r.jsx)("td",{className:"jsx-4f044084e7cd90f7 p-3 text-amber-300 truncate",children:e["建案名稱"]}),(0,r.jsx)("td",{className:"jsx-4f044084e7cd90f7 p-3 text-gray-400 truncate",children:e["其他門牌"]||e["地址"]||e["土地位置建物門牌"]}),(0,r.jsx)("td",{className:"jsx-4f044084e7cd90f7 p-3",children:(0,r.jsx)("button",{onClick:()=>tq(t),className:"jsx-4f044084e7cd90f7 text-gray-500 hover:text-white text-xs underline",children:e5.has(t)?"收合":"明細"})})]},e["編號"]),e5.has(t)&&(0,r.jsx)("tr",{className:"jsx-4f044084e7cd90f7 bg-gray-900/50",children:(0,r.jsx)("td",{colSpan:6,className:"jsx-4f044084e7cd90f7 p-4 border-b border-gray-800",children:(0,r.jsx)("div",{className:"jsx-4f044084e7cd90f7 grid grid-cols-2 md:grid-cols-4 gap-4 text-xs",children:Object.entries(e).filter(([e])=>"id"!==e).map(([e,t])=>(0,r.jsxs)("div",{className:"jsx-4f044084e7cd90f7",children:[(0,r.jsx)("div",{className:"jsx-4f044084e7cd90f7 text-gray-500 mb-1",children:e}),(0,r.jsx)("div",{className:"jsx-4f044084e7cd90f7 text-gray-300 break-all",children:String(t)})]},e))})})})]}))})]}),0===eV.length&&(0,r.jsx)("div",{className:"jsx-4f044084e7cd90f7 text-center py-20 text-gray-500",children:"無符合資料"})]})]})}),tf&&(0,r.jsx)("div",{onClick:()=>!tl&&tx(!1),className:"jsx-4f044084e7cd90f7 fixed inset-0 z-50 flex items-center justify-center bg-black/80 p-4 transition-opacity animate-in fade-in duration-200",children:(0,r.jsxs)("div",{onClick:e=>e.stopPropagation(),className:"jsx-4f044084e7cd90f7 bg-dark-bg border border-gray-700 rounded-xl w-full max-w-4xl max-h-[90vh] flex flex-col shadow-2xl relative",children:[(0,r.jsxs)("div",{className:"jsx-4f044084e7cd90f7 p-4 border-b border-gray-700 flex justify-between items-center bg-dark-card rounded-t-xl",children:[(0,r.jsxs)("div",{className:"jsx-4f044084e7cd90f7",children:[(0,r.jsxs)("h3",{className:"jsx-4f044084e7cd90f7 text-xl font-bold text-white flex items-center gap-2",children:[(0,r.jsx)(eh.A,{className:"text-amber-500 w-5 h-5"})," 全表稽核結果"]}),(0,r.jsxs)("p",{className:"jsx-4f044084e7cd90f7 text-sm text-gray-400 mt-1",children:["目標：","all"===tt?"全部縣市":o[tt.toUpperCase()]," - TYPE ",tr.toUpperCase()]})]}),(0,r.jsx)("button",{onClick:()=>tx(!1),disabled:tl,className:"jsx-4f044084e7cd90f7 text-gray-400 hover:text-white hover:bg-gray-700/50 p-2 rounded-full transition-colors flex items-center justify-center w-8 h-8 disabled:opacity-50",children:(0,r.jsx)("i",{className:"jsx-4f044084e7cd90f7 fas fa-times text-xl"})})]}),(0,r.jsx)("div",{className:"jsx-4f044084e7cd90f7 flex-1 overflow-y-auto p-6 bg-gray-900/50 custom-scrollbar",children:tc?(0,r.jsxs)("div",{className:"jsx-4f044084e7cd90f7 bg-red-900/20 border border-red-800 p-6 rounded-xl flex items-start gap-4",children:[(0,r.jsx)(eg.A,{className:"w-6 h-6 text-red-500 flex-shrink-0 mt-1"}),(0,r.jsxs)("div",{className:"jsx-4f044084e7cd90f7",children:[(0,r.jsx)("h3",{className:"jsx-4f044084e7cd90f7 text-red-400 font-bold mb-1",children:"稽核任務失敗"}),(0,r.jsx)("p",{className:"jsx-4f044084e7cd90f7 text-red-200/80 text-sm whitespace-pre-wrap",children:tc})]})]}):tl?(0,r.jsxs)("div",{className:"jsx-4f044084e7cd90f7 h-[300px] flex flex-col items-center justify-center",children:[(0,r.jsx)("div",{className:"jsx-4f044084e7cd90f7 w-16 h-16 border-4 border-amber-500/20 border-t-amber-500 rounded-full animate-spin mb-6"}),(0,r.jsx)("h3",{className:"jsx-4f044084e7cd90f7 text-lg font-bold text-amber-400 mb-2 animate-pulse",children:"正在進行深度掃描..."}),(0,r.jsx)("p",{className:"jsx-4f044084e7cd90f7 text-sm text-gray-500",children:tj.total>0?`正在掃描 ${tw||"縣市"} (${tj.current}/${tj.total})`:"Edge Function 正在比對交易資料"})]}):tn&&0===tn.length?(0,r.jsxs)("div",{className:"jsx-4f044084e7cd90f7 bg-emerald-900/10 border border-emerald-800/50 rounded-xl h-[300px] flex flex-col items-center justify-center p-8 text-center ring-1 ring-inset ring-emerald-500/20",children:[(0,r.jsx)("h3",{className:"jsx-4f044084e7cd90f7 text-2xl font-bold text-emerald-400 mb-2",children:"資料庫結構完美"}),(0,r.jsx)("p",{className:"jsx-4f044084e7cd90f7 text-gray-400 max-w-md mx-auto",children:"系統中的主表車位數量宣告與附表實體筆數 100% 吻合，無任何遺漏或異常筆數。"})]}):tn&&tn.length>0?(0,r.jsxs)("div",{className:"jsx-4f044084e7cd90f7 space-y-4",children:[(0,r.jsxs)("div",{className:"jsx-4f044084e7cd90f7 bg-red-900/20 text-red-400 border border-red-800 px-4 py-3 rounded-lg flex items-center gap-3",children:[(0,r.jsx)(eb.A,{className:"w-5 h-5 flex-shrink-0"}),(0,r.jsxs)("span",{className:"jsx-4f044084e7cd90f7",children:["共攔截 ",(0,r.jsx)("strong",{className:"jsx-4f044084e7cd90f7",children:tn.length})," 筆資料結構衝突"]})]}),(0,r.jsxs)("div",{className:"jsx-4f044084e7cd90f7 flex flex-wrap items-center justify-between gap-3 text-xs text-gray-400",children:[(0,r.jsxs)("span",{className:"jsx-4f044084e7cd90f7",children:["顯示 ",0===st?0:sa+1,"-",sl," / ",st,"（每頁 ",50," 筆）"]}),(0,r.jsxs)("div",{className:"jsx-4f044084e7cd90f7 flex items-center gap-2",children:[(0,r.jsx)("button",{onClick:()=>tp(Math.max(1,sr-1)),disabled:sr<=1,className:"jsx-4f044084e7cd90f7 px-2 py-1 rounded border border-gray-700 text-gray-300 hover:bg-gray-800 disabled:opacity-40",children:"上一頁"}),(0,r.jsxs)("span",{className:"jsx-4f044084e7cd90f7",children:[sr," / ",ss]}),(0,r.jsx)("button",{onClick:()=>tp(Math.min(ss,sr+1)),disabled:sr>=ss,className:"jsx-4f044084e7cd90f7 px-2 py-1 rounded border border-gray-700 text-gray-300 hover:bg-gray-800 disabled:opacity-40",children:"下一頁"})]})]}),t6>0&&(0,r.jsxs)("div",{className:"jsx-4f044084e7cd90f7 bg-emerald-900/10 border border-emerald-800/50 px-4 py-3 rounded-lg flex flex-wrap items-center justify-between gap-3",children:[(0,r.jsxs)("div",{className:"jsx-4f044084e7cd90f7 text-emerald-300 text-sm",children:["價格一致可修正 ",(0,r.jsx)("strong",{className:"jsx-4f044084e7cd90f7",children:t6})," 筆",tm&&(0,r.jsxs)("span",{className:"jsx-4f044084e7cd90f7 ml-2 text-emerald-400",children:["修正進度 ",th,"%"]})]}),(0,r.jsx)("button",{onClick:tO,disabled:tm||tl||tv,className:"jsx-4f044084e7cd90f7 px-3 py-1.5 rounded border border-emerald-500 text-emerald-300 hover:text-emerald-200 disabled:opacity-50",children:"全部修正(價格一致)"})]}),se>0&&(0,r.jsxs)("div",{className:"jsx-4f044084e7cd90f7 bg-amber-900/10 border border-amber-800/50 px-4 py-3 rounded-lg flex flex-wrap items-center justify-between gap-3",children:[(0,r.jsxs)("div",{className:"jsx-4f044084e7cd90f7 text-amber-300 text-sm",children:["附表少於主表 ",(0,r.jsx)("strong",{className:"jsx-4f044084e7cd90f7",children:se})," 筆，可整批補登車位附表",!eL&&(0,r.jsx)("span",{className:"jsx-4f044084e7cd90f7 ml-2 text-amber-400/70",children:"（需先連線）"}),0===p.length&&(0,r.jsx)("span",{className:"jsx-4f044084e7cd90f7 ml-2 text-amber-400/70",children:"（需先載入檔案）"})]}),(0,r.jsx)("button",{onClick:tU,disabled:tv||tl||tm||!eL||0===p.length,className:"jsx-4f044084e7cd90f7 px-3 py-1.5 rounded border border-amber-500 text-amber-300 hover:text-amber-200 disabled:opacity-50",children:tv?"補登中...":"整批重新上傳車位附表"})]}),tv&&(0,r.jsx)("div",{className:"jsx-4f044084e7cd90f7 bg-amber-900/10 border border-amber-800/50 px-4 py-3 rounded-lg text-amber-200 text-sm",children:"補登進行中，請稍候…（完成後請重新執行全表稽核）"}),(0,r.jsx)("div",{className:"jsx-4f044084e7cd90f7 grid grid-cols-1 gap-3",children:si.map((e,t)=>{let s=Number(e?.expected??0),a=Number(e?.actual??0),l=Number.isFinite(s)&&Number.isFinite(a)&&a<s;return(0,r.jsxs)("div",{className:"jsx-4f044084e7cd90f7 bg-dark-card border border-gray-700 p-4 rounded-lg flex flex-col gap-3",children:[(0,r.jsxs)("div",{className:"jsx-4f044084e7cd90f7 flex flex-col sm:flex-row sm:items-center justify-between gap-4",children:[(0,r.jsxs)("div",{className:"jsx-4f044084e7cd90f7 flex-1",children:[(0,r.jsxs)("div",{className:"jsx-4f044084e7cd90f7 flex items-center gap-2 mb-1",children:[e.county&&(0,r.jsx)("span",{className:"jsx-4f044084e7cd90f7 bg-amber-900/50 text-amber-300 text-[10px] px-2 py-0.5 rounded font-bold",children:e.county}),(0,r.jsx)("span",{className:"jsx-4f044084e7cd90f7 font-mono text-sm text-gray-300",children:e.id})]}),(0,r.jsx)("p",{className:"jsx-4f044084e7cd90f7 text-sm text-gray-400",children:e.message})]}),(0,r.jsxs)("div",{className:"jsx-4f044084e7cd90f7 flex items-center gap-4 bg-black/40 px-4 py-2 rounded-lg border border-gray-800",children:[(0,r.jsxs)("div",{className:"jsx-4f044084e7cd90f7 text-center",children:[(0,r.jsx)("div",{className:"jsx-4f044084e7cd90f7 text-[10px] text-gray-500 uppercase tracking-widest mb-1",children:"主表"}),(0,r.jsx)("div",{className:"jsx-4f044084e7cd90f7 text-lg font-mono font-bold text-gray-300",children:e.expected})]}),(0,r.jsx)("div",{className:"jsx-4f044084e7cd90f7 text-gray-600 font-bold text-xs",children:"VS"}),(0,r.jsxs)("div",{className:"jsx-4f044084e7cd90f7 text-center",children:[(0,r.jsx)("div",{className:"jsx-4f044084e7cd90f7 text-[10px] text-gray-500 uppercase tracking-widest mb-1",children:"附表"}),(0,r.jsx)("div",{className:"jsx-4f044084e7cd90f7 text-lg font-mono font-bold text-red-400",children:e.actual})]})]})]}),(void 0!==e.mainPrice||void 0!==e.parkPriceSum)&&(0,r.jsxs)("div",{className:"jsx-4f044084e7cd90f7 text-xs text-emerald-200 flex flex-wrap gap-3",children:[(0,r.jsxs)("span",{className:"jsx-4f044084e7cd90f7",children:["主表車位總價(萬): ",e.mainPrice??"-"]}),(0,r.jsxs)("span",{className:"jsx-4f044084e7cd90f7",children:["附表車位價格合計(萬): ",e.parkPriceSum??"-"]})]}),e.fixable&&(0,r.jsxs)("div",{className:"jsx-4f044084e7cd90f7 flex items-center justify-between",children:[(0,r.jsxs)("div",{className:"jsx-4f044084e7cd90f7 text-xs text-emerald-300",children:["價格一致，可修正主表車位數為 ",e.actual]}),(0,r.jsx)("button",{onClick:()=>tI(e),disabled:tm||tl||tv,className:"jsx-4f044084e7cd90f7 px-3 py-1 rounded border border-emerald-500 text-emerald-300 hover:text-emerald-200 disabled:opacity-50",children:"修正這筆"})]}),l&&(0,r.jsxs)("div",{className:"jsx-4f044084e7cd90f7 flex items-center justify-between",children:[(0,r.jsx)("div",{className:"jsx-4f044084e7cd90f7 text-xs text-amber-300",children:"附表不足，可重新上傳車位附表"}),(0,r.jsx)("button",{onClick:()=>tW(e),disabled:tv||tl||tm||!eL||0===p.length,className:"jsx-4f044084e7cd90f7 px-3 py-1 rounded border border-amber-500 text-amber-300 hover:text-amber-200 disabled:opacity-50",children:"補登這筆"})]})]},e?.__key||`${e?.countyCode||""}|${e?.table||""}|${e?.id||""}|${t}`)})})]}):null})]})}),(0,r.jsx)(l(),{id:"4f044084e7cd90f7",children:".custom-scrollbar::-webkit-scrollbar{width:8px}.custom-scrollbar::-webkit-scrollbar-track{background:rgba(0,0,0,.2)}.custom-scrollbar::-webkit-scrollbar-thumb{background:rgba(255,255,255,.1);border-radius:4px}.custom-scrollbar::-webkit-scrollbar-thumb:hover{background:rgba(255,255,255,.2)}"})]})}}},e=>{e.O(0,[4764,5969,947,8962,4670,8441,3794,7358],()=>e(e.s=19246)),_N_E=e.O()}]);