(self.webpackChunk_N_E=self.webpackChunk_N_E||[]).push([[5105],{34198:(e,s,t)=>{"use strict";t.d(s,{K:()=>c});var a=t(95155),l=t(12115),i=t(40980),n=t(33210),r=t(94514);let c=(0,l.forwardRef)(({options:e,value:s,onChange:t,placeholder:c="Select...",maxItems:o,disabled:d=!1,className:x,onSearch:m,loading:u=!1,onFocus:h},p)=>{let[f,b]=(0,l.useState)(""),[v,g]=(0,l.useState)(!1),j=(0,l.useRef)(null),N=(0,l.useRef)(null),y=m?e:e.filter(e=>e.label.toLowerCase().includes(f.toLowerCase()));return s.map(s=>{let t=e.find(e=>e.value===s);return t?t.label:s}),(0,l.useEffect)(()=>{let e=e=>{j.current&&!j.current.contains(e.target)&&g(!1)};return document.addEventListener("mousedown",e),()=>document.removeEventListener("mousedown",e)},[]),(0,l.useEffect)(()=>{m&&m(f)},[f,m]),(0,a.jsxs)("div",{className:(0,i.cn)("relative w-full",x),ref:j,children:[(0,a.jsxs)("div",{className:(0,i.cn)("flex items-center gap-2 bg-zinc-950/50 border border-input rounded-md px-2 py-1.5 h-[42px] overflow-x-auto custom-scrollbar cursor-text transition-all",v&&"ring-2 ring-ring ring-offset-0 border-ring",d&&"bg-zinc-900/50 cursor-not-allowed opacity-50"),onClick:()=>!d&&N.current?.focus(),children:[s.map(l=>{let i=e.find(e=>e.value===l),r=i?i.label:l,c=i?.renderLabel??r;return(0,a.jsxs)("span",{className:"bg-violet-500/20 text-violet-200 border border-violet-500/30 text-xs rounded-full px-2 py-0.5 flex items-center gap-1 animate-in fade-in zoom-in-95 duration-100 whitespace-nowrap shrink-0",children:[c,!d&&(0,a.jsx)(n.A,{size:12,className:"cursor-pointer hover:text-white transition-colors",onClick:e=>{e.stopPropagation(),t(s.filter(e=>e!==l))}})]},l)}),(0,a.jsx)("input",{ref:N,type:"text",value:f,onChange:e=>b(e.target.value),onFocus:()=>{g(!0),h?.()},onKeyDown:e=>{"Backspace"===e.key&&""===f&&s.length>0&&t(s.slice(0,-1))},placeholder:0===s.length?c:"",className:(0,i.cn)("bg-transparent outline-none flex-grow min-w-[60px] text-zinc-100 placeholder:text-zinc-500 text-sm",d&&"cursor-not-allowed"),disabled:d})]}),v&&!d&&(0,a.jsx)("div",{className:"absolute z-[110] w-full mt-1 bg-zinc-900 border border-zinc-700 rounded-md shadow-xl max-h-60 overflow-y-auto custom-scrollbar animate-in fade-in slide-in-from-top-2 duration-100",children:u?(0,a.jsx)("div",{className:"p-2 text-center text-zinc-500 text-sm",children:"Loading..."}):0===y.length?(0,a.jsx)("div",{className:"p-2 text-center text-zinc-500 text-sm",children:"No options found"}):y.map((e,n)=>{if(!e)return null;let c=0===n||e.group!==y[n-1]?.group;return(0,a.jsxs)(l.Fragment,{children:[c&&e.group&&(0,a.jsx)("div",{className:"px-2 py-1 bg-zinc-800/50 text-xs font-semibold text-zinc-400 sticky top-0 backdrop-blur-sm z-10",children:e.group}),(0,a.jsxs)("div",{className:(0,i.cn)("px-3 py-2 cursor-pointer text-sm flex items-start justify-between hover:bg-zinc-800 transition-colors",s.includes(e.value)&&"bg-violet-500/10 text-violet-400"),onClick:()=>(e=>{if(s.includes(e))t(s.filter(s=>s!==e));else{if(o&&s.length>=o)return;t([...s,e])}b("")})(e.value),children:[(0,a.jsxs)("div",{className:"flex flex-col",children:[(0,a.jsx)("span",{className:"font-medium",children:e.renderLabel??e.label}),e.details&&(0,a.jsxs)("div",{className:"flex items-center gap-2 mt-0.5",children:[(e.details.county||e.details.district)&&(0,a.jsxs)("span",{className:"text-xs text-zinc-500 bg-zinc-800/80 px-1.5 rounded border border-zinc-700",children:[e.details.county,e.details.district]}),e.details.date&&(0,a.jsx)("span",{className:"text-xs text-zinc-600 font-mono",children:e.details.date.substring(0,7)})]})]}),s.includes(e.value)&&(0,a.jsx)(r.A,{size:16,className:"mt-1"})]})]},e.value)})})]})});c.displayName="MultiSelect"},42763:(e,s,t)=>{"use strict";t.d(s,{Cf:()=>m,Es:()=>h,L3:()=>p,c7:()=>u,lG:()=>c,rr:()=>f,zM:()=>o});var a=t(95155),l=t(12115),i=t(29483),n=t(33210),r=t(40980);let c=i.bL,o=i.l9,d=i.ZL;i.bm;let x=l.forwardRef(({className:e,...s},t)=>(0,a.jsx)(i.hJ,{ref:t,className:(0,r.cn)("fixed inset-0 z-50 bg-black/80  data-[state=open]:animate-in data-[state=closed]:animate-out data-[state=closed]:fade-out-0 data-[state=open]:fade-in-0",e),...s}));x.displayName=i.hJ.displayName;let m=l.forwardRef(({className:e,children:s,...t},l)=>(0,a.jsxs)(d,{children:[(0,a.jsx)(x,{}),(0,a.jsxs)(i.UC,{ref:l,className:(0,r.cn)("fixed left-[50%] top-[50%] z-50 grid w-full max-w-lg translate-x-[-50%] translate-y-[-50%] gap-4 border bg-background p-6 shadow-lg duration-200 data-[state=open]:animate-in data-[state=closed]:animate-out data-[state=closed]:zoom-out-95 data-[state=open]:zoom-in-95 data-[state=closed]:slide-out-to-left-1/2 data-[state=closed]:slide-out-to-top-1/2 data-[state=open]:slide-in-from-left-1/2 data-[state=open]:slide-in-from-top-1/2 sm:rounded-lg",e),...t,children:[s,(0,a.jsxs)(i.bm,{className:"absolute right-4 top-4 rounded-sm opacity-70 ring-offset-background transition-opacity hover:opacity-100 focus:outline-none focus:ring-2 focus:ring-ring focus:ring-offset-2 disabled:pointer-events-none data-[state=open]:bg-accent data-[state=open]:text-muted-foreground",children:[(0,a.jsx)(n.A,{className:"h-4 w-4"}),(0,a.jsx)("span",{className:"sr-only",children:"Close"})]})]})]}));m.displayName=i.UC.displayName;let u=({className:e,...s})=>(0,a.jsx)("div",{className:(0,r.cn)("flex flex-col space-y-1.5 text-center sm:text-left",e),...s});u.displayName="DialogHeader";let h=({className:e,...s})=>(0,a.jsx)("div",{className:(0,r.cn)("flex flex-col-reverse sm:flex-row sm:justify-end sm:space-x-2",e),...s});h.displayName="DialogFooter";let p=l.forwardRef(({className:e,...s},t)=>(0,a.jsx)(i.hE,{ref:t,className:(0,r.cn)("text-lg font-semibold leading-none tracking-tight",e),...s}));p.displayName=i.hE.displayName;let f=l.forwardRef(({className:e,...s},t)=>(0,a.jsx)(i.VY,{ref:t,className:(0,r.cn)("text-sm text-muted-foreground",e),...s}));f.displayName=i.VY.displayName},53682:(e,s,t)=>{Promise.resolve().then(t.bind(t,62347))},62347:(e,s,t)=>{"use strict";t.r(s),t.d(s,{default:()=>Z});var a=t(95155),l=t(12115),i=t(39430),n=t(68041),r=t(88743),c=t(34198),o=t(29991),d=t(89239),x=t(60529),m=t(40980),u=t(92622),h=t(33210),p=t(26179),f=t(80642),b=t(55873),v=t(27529),g=t(98883),j=t(29026),N=t(16385);let y=[{value:"ranking",label:"核心指標與排名"},{value:"price-band",label:"總價帶分析"},{value:"unit-price",label:"單價分析"},{value:"heatmap",label:"調價熱力圖"},{value:"timeline",label:"政策時光機"},{value:"velocity",label:"銷售速度與房型"},{value:"parking",label:"車位分析"},{value:"data-list",label:"交易明細列表"}];function w({onAnalyze:e,isLoading:s,analysisData:t,analysisProgress:n}){let w,{counties:z,districts:k,transactionType:C,buildingType:_,projectNames:A,dateRange:S,startDate:$,endDate:E,excludeCommercial:D,activeTab:P,setCounties:R,setDistricts:L,setTransactionType:T,setBuildingType:F,setProjectNames:M,setDateRange:G,setCustomDate:O,setExcludeCommercial:B,setActiveTab:I,resetFilters:q,isFilterBarCompact:K,setIsFilterBarCompact:U}=(0,r.P)(),H=(0,l.useMemo)(()=>[{label:"住宅大樓",value:"住宅大樓(11層含以上有電梯)"},{label:"華廈",value:"華廈(10層含以下有電梯)"},{label:"公寓",value:"公寓(5層含以下無電梯)"},{label:"套房",value:"套房(1房(1廳)1衛)"},{label:"透天厝",value:"透天厝"},{label:"店面（排除停車空間）",value:"店面(排除停車空間)",renderLabel:(0,a.jsxs)("span",{children:["店面",(0,a.jsx)("span",{className:"text-[10px] text-zinc-400 ml-1",children:"（排除停車空間）"})]})},{label:"停車空間",value:"停車空間"},{label:"辦公商業大樓",value:"辦公商業大樓"},{label:"工廠/廠辦",value:"工廠"},{label:"其他",value:"其他"}],[]),[J,V]=(0,l.useState)(!1),[Y,Q]=(0,l.useState)([]),[W,Z]=(0,l.useState)(!1),X=(0,l.useCallback)(e=>{if(!e)return null;let s=String(e).trim();if(!s)return null;if(/^\d{8}$/.test(s)){let e=s.slice(0,4),t=s.slice(4,6),a=s.slice(6,8),l=new Date(`${e}-${t}-${a}`);return Number.isNaN(l.getTime())?null:l}if(/^\d{3}\/\d{1,2}\/\d{1,2}$/.test(s)){let[e,t,a]=s.split("/"),l=parseInt(e,10)+1911,i=new Date(`${l}-${t}-${a}`);return Number.isNaN(i.getTime())?null:i}let t=new Date(s.replace(/\./g,"-").replace(/\//g,"-"));return Number.isNaN(t.getTime())?null:t},[]),[ee,es]=(0,l.useState)(null),[et,ea]=(0,l.useState)("idle"),el=(0,l.useMemo)(()=>{let e=t?.transactionDetails;if(!e||!Array.isArray(e)||0===e.length)return null;let s=1/0,a=-1/0;if(e.forEach(e=>{let t=X(e?.["交易日"]??e?.["交易日期"]??e?.date??e?.date_str);if(!t)return;let l=t.getTime();l<s&&(s=l),l>a&&(a=l)}),!Number.isFinite(s)||!Number.isFinite(a))return null;let l=new Date(s).toISOString().split("T")[0],i=new Date(a).toISOString().split("T")[0];return`資料期間：${l} ~ ${i}`},[t,X]);(0,l.useEffect)(()=>{let e=!0;return(async()=>{ea("loading");try{let[s,t]=await Promise.all([N.N.from("all_transactions_view").select("交易日期").eq("交易類型",C).order("交易日期",{ascending:!0}).limit(1),N.N.from("all_transactions_view").select("交易日期").eq("交易類型",C).order("交易日期",{ascending:!1}).limit(1)]);if(!e)return;if(s.error||t.error)throw s.error||t.error;let a=s.data?.[0]?.["交易日期"]||null,l=t.data?.[0]?.["交易日期"]||null;a&&l?(es({start:String(a),end:String(l)}),ea("ready")):(es(null),ea("empty"))}catch(s){if(!e)return;console.warn("Failed to fetch default data range:",s),es(null),ea("error")}})(),()=>{e=!1}},[C]);let ei=(0,l.useMemo)(()=>"loading"===et?"資料期間：讀取中...":"empty"===et?"資料期間：無資料":"error"===et?"資料期間：—":"ready"===et&&ee?`資料期間：${ee.start} ~ ${ee.end}`:"資料期間：—",[et,ee]),en=el??ei,er=(0,l.useMemo)(()=>!n||n.total<=0?0:Math.min(100,Math.round(n.completed/n.total*100)),[n]),ec=Object.keys(b.WG).map(e=>({label:e,value:e})),eo=l.useMemo(()=>0===z.length?[]:z.flatMap(e=>(b.Ib[e]||[]).map(s=>({label:s,value:s,group:e}))),[z]);(0,l.useEffect)(()=>{if("custom"!==S&&(!$||!E)){let{startDate:e,endDate:s}=(0,g.P)(S);e&&s&&G(S,e,s)}},[S,$,E,G]);let ed=(0,l.useRef)(null),[ex,em]=(0,l.useState)(null),eu=(0,l.useCallback)(async e=>{if(0===z.length)return void Q([]);Z(!0),em(null);try{let s=z.map(async s=>{let t=b.WG[s],a=k.filter(e=>b.Ib[s]?.includes(e));return v.FH.fetchProjectNameSuggestions(t,e,a).then(e=>{let t=[];return Array.isArray(e)?t=e:e&&e.data&&Array.isArray(e.data)?t=e.data:e&&e.names&&Array.isArray(e.names)&&(t=e.names),t.map(e=>{let t="string"==typeof e,a=t?e:e.name||e.建案名稱||String(e);return{label:a,value:a,group:s,details:t?void 0:{county:s,district:e.district||e.行政區,date:e.earliestDate||e.交易日}}})}).catch(e=>(console.error(`Failed to fetch projects for ${s}:`,e),[]))}),t=(await Promise.all(s)).flat(),a=Array.from(new Map(t.map(e=>[e.value,e])).values());Q(a),0===a.length&&e.length>=2&&console.log(`No projects found for query "${e}" in counties: ${z.join(", ")}`)}catch(e){console.error("Project search error:",e),em("搜尋失敗，請稍後再試")}finally{Z(!1)}},[z,k]),eh=(0,l.useCallback)(e=>{ed.current&&clearTimeout(ed.current),ed.current=setTimeout(()=>{eu(e)},300)},[eu]);(0,l.useEffect)(()=>()=>{ed.current&&clearTimeout(ed.current)},[]);let ep=(0,l.useRef)(null),[ef,eb]=(0,l.useState)(0);return(0,l.useEffect)(()=>{if(!ep.current)return;let e=new ResizeObserver(e=>{for(let s of e)eb(s.contentRect.height)});return e.observe(ep.current),()=>e.disconnect()},[K]),(0,l.useEffect)(()=>{let e=()=>{let e=window.scrollY;e>250?K||U(!0):e<120&&K&&U(!1)};return window.addEventListener("scroll",e,{passive:!0}),()=>window.removeEventListener("scroll",e)},[K,U]),(0,a.jsxs)("div",{className:"relative",children:[(0,a.jsx)(f.N,{children:K&&(0,a.jsxs)(i.P.div,{initial:{opacity:0,y:-20,x:"-50%",scale:.95},animate:{opacity:1,y:0,x:"-50%",scale:1},exit:{opacity:0,y:-20,x:"-50%",scale:.95},transition:{duration:.2,ease:"easeOut"},className:"fixed top-3 left-1/2 z-[100] p-1 glass-card rounded-full shadow-2xl flex items-center justify-between gap-1 transition-all mx-auto max-w-[95vw] md:max-w-7xl backdrop-blur-2xl border border-white/20 origin-top",children:[(0,a.jsxs)("div",{className:"flex items-center gap-2 pl-2 pr-2 py-1.5 hover:bg-white/5 rounded-full transition-colors cursor-pointer shrink-0",onClick:()=>{U(!1),window.scrollTo({top:0,behavior:"smooth"})},children:[(0,a.jsx)("div",{className:"h-7 w-7 rounded-full bg-violet-600/30 text-violet-300 flex items-center justify-center shrink-0 border border-violet-500/30",children:(0,a.jsx)(u.A,{className:"h-3.5 w-3.5"})}),(0,a.jsxs)("div",{className:"flex flex-col leading-none overflow-hidden max-w-[100px] xs:max-w-[140px]",children:[(0,a.jsxs)("span",{className:"text-[10px] text-zinc-400 font-medium truncate",children:[(w=[],z.length>0&&w.push(`${z.length} 縣市`),C&&w.push(C.replace("交易","")),"custom"!==S?w.push({"3m":"近3個月","6m":"近6個月","9m":"近9個月","12m":"近12個月","15m":"近15個月","18m":"近18個月","21m":"近21個月","24m":"近24個月","36m":"近36個月","48m":"近48個月"}[S]||S):w.push("自訂期間"),w.join(" • ")||"請選擇篩選條件").split("•")[0],"..."]}),(0,a.jsx)("span",{className:"text-[9px] text-zinc-600 font-mono mt-0.5",children:"點擊展開"})]})]}),(0,a.jsx)("div",{className:"flex-1 min-w-0 flex items-center gap-1 px-1 border-l border-white/10 overflow-x-auto mask-fade-right pb-2 pr-8",children:y.map(e=>(0,a.jsx)("button",{onClick:s=>{s.stopPropagation(),I(e.value)},className:(0,m.cn)("px-2.5 py-1 rounded-full text-[10px] font-bold transition-all whitespace-nowrap active:scale-95 touch-manipulation",P===e.value?"bg-violet-600 text-white shadow-lg shadow-violet-500/20":"text-zinc-500 hover:text-zinc-300 bg-zinc-800/20"),children:e.label.replace("分析","").replace("指標與","").replace("交易","")},e.value))}),(0,a.jsx)("div",{className:"pr-2 pl-1 hidden sm:block",children:(0,a.jsx)("div",{className:"h-1.5 w-1.5 rounded-full bg-cyan-500/50 animate-pulse",title:"操作中"})})]},"compact-pill")}),(0,a.jsxs)("div",{ref:ep,className:`p-4 md:p-6 glass-card rounded-xl shadow-lg transition-opacity duration-200 ${K?"opacity-0 pointer-events-none":"opacity-100"}`,children:[(0,a.jsxs)("div",{className:"flex md:hidden items-center justify-between mb-4",children:[(0,a.jsxs)("h2",{className:"text-lg font-bold text-white flex items-center gap-2",children:[(0,a.jsx)(u.A,{className:"h-5 w-5 text-violet-500"}),"篩選條件"]}),(0,a.jsxs)("div",{className:"flex gap-2",children:[(0,a.jsxs)(d.$,{variant:"outline",size:"sm",onClick:()=>V(!J),className:"border-zinc-700 text-zinc-300",children:[J?(0,a.jsx)(h.A,{className:"h-4 w-4"}):(0,a.jsx)(u.A,{className:"h-4 w-4"}),J?"收起":"展開"]}),(0,a.jsx)(d.$,{variant:"default",size:"sm",className:"bg-violet-600 text-white",disabled:0===z.length||s,onClick:()=>{(0,j.M)({action:"search",route:"/dashboard",metadata:{counties:z,districts:k,transactionType:C}}),e?.()},children:s?"...":"分析"})]})]}),(0,a.jsx)("div",{className:"md:hidden text-[11px] text-zinc-400 mb-3 text-right",children:en}),(0,a.jsx)("div",{className:"hidden md:flex justify-end mb-2 text-[11px] text-zinc-400",children:en}),(0,a.jsxs)("div",{className:`grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 xl:grid-cols-7 gap-4 items-end ${J?"block":"hidden md:grid"}`,children:[(0,a.jsxs)("div",{className:"xl:col-span-1",children:[(0,a.jsxs)("div",{className:"flex justify-between items-center mb-1",children:[(0,a.jsxs)("div",{className:"flex items-center gap-2",children:[(0,a.jsx)("label",{className:"text-sm font-medium text-zinc-300",children:"縣市"}),z.length>3&&(0,a.jsxs)("span",{className:"text-xs text-amber-500 font-normal animate-in fade-in",children:["(已選 ",z.length,"/6)"]})]}),z.length>0&&(0,a.jsx)("button",{onClick:()=>R([]),className:"text-xs text-cyan-400 hover:text-cyan-300",children:"清除"})]}),(0,a.jsx)(c.K,{options:ec,value:z,onChange:e=>{e.length>6||R(e)},placeholder:"請選擇縣市...",maxItems:6})]}),(0,a.jsxs)("div",{className:"xl:col-span-1",children:[(0,a.jsxs)("div",{className:"flex justify-between items-center mb-1",children:[(0,a.jsx)("label",{className:"text-sm font-medium text-zinc-300",children:"行政區"}),k.length>0&&(0,a.jsx)("button",{onClick:()=>L([]),className:"text-xs text-cyan-400 hover:text-cyan-300",children:"清除"})]}),(0,a.jsx)(c.K,{options:eo,value:k,onChange:e=>{L(e)},placeholder:z.length>0?"請選擇行政區...":"請先選縣市",disabled:0===z.length})]}),(0,a.jsxs)("div",{children:[(0,a.jsx)("label",{className:"block text-sm font-medium text-zinc-300 mb-1",children:"交易類型"}),(0,a.jsxs)(o.l,{value:C,onChange:e=>T(e.target.value),children:[(0,a.jsx)("option",{value:"預售交易",children:"預售交易"}),(0,a.jsx)("option",{value:"中古交易",disabled:!0,children:"中古交易 (開發中)"})]})]}),(0,a.jsxs)("div",{children:[(0,a.jsxs)("div",{className:"flex justify-between items-center mb-1",children:[(0,a.jsx)("label",{className:"text-sm font-medium text-zinc-300",children:"建物型態"}),_&&(0,a.jsx)("button",{onClick:()=>F(""),className:"text-xs text-cyan-400 hover:text-cyan-300",children:"清除"})]}),(0,a.jsx)(c.K,{options:H,value:_?[_]:[],onChange:e=>F(e[e.length-1]??""),placeholder:"搜尋或選擇建物型態..."})]}),(0,a.jsxs)("div",{className:"xl:col-span-3",children:[(0,a.jsxs)("div",{className:"flex justify-between items-center mb-1",children:[(0,a.jsx)("label",{className:"text-sm font-medium text-zinc-300",children:"建案名稱"}),A.length>0&&(0,a.jsx)("button",{onClick:()=>M([]),className:"text-xs text-cyan-400 hover:text-cyan-300",children:"清除"})]}),(0,a.jsx)(c.K,{options:Y,value:A,onChange:M,placeholder:z.length>0?"輸入建案名稱搜尋...":"請先選縣市",disabled:0===z.length,onSearch:eh,loading:W,onFocus:()=>{0===A.length&&0===Y.length&&eu("")}}),ex&&(0,a.jsx)("span",{className:"text-xs text-red-400 mt-1",children:ex})]}),(0,a.jsxs)("div",{className:"xl:col-span-3 sm:col-span-2 grid grid-cols-1 sm:grid-cols-3 gap-4",children:[(0,a.jsxs)("div",{children:[(0,a.jsx)("label",{className:"block text-sm font-medium text-zinc-300 mb-1",children:"快捷時間"}),(0,a.jsxs)(o.l,{value:S,onChange:e=>{let s=e.target.value;if("custom"===s)G("custom",$,E);else{let{startDate:e,endDate:t}=(0,g.P)(s);e&&t&&G(s,e,t)}},children:[(0,a.jsx)("option",{value:"48m",children:"近48個月"}),(0,a.jsx)("option",{value:"36m",children:"近36個月（預設）"}),(0,a.jsx)("option",{value:"24m",children:"近24個月"}),(0,a.jsx)("option",{value:"21m",children:"近21個月"}),(0,a.jsx)("option",{value:"18m",children:"近18個月"}),(0,a.jsx)("option",{value:"15m",children:"近15個月"}),(0,a.jsx)("option",{value:"12m",children:"近12個月"}),(0,a.jsx)("option",{value:"9m",children:"近9個月"}),(0,a.jsx)("option",{value:"6m",children:"近6個月"}),(0,a.jsx)("option",{value:"3m",children:"近3個月"}),(0,a.jsx)("option",{value:"custom",children:"自訂範圍"})]})]}),(0,a.jsxs)("div",{children:[(0,a.jsx)("label",{className:"block text-sm font-medium text-zinc-300 mb-1",children:"起始日期"}),(0,a.jsx)(x.p,{type:"date",value:$,onChange:e=>O(e.target.value,E),className:"bg-zinc-950/50 border-input text-zinc-100"})]}),(0,a.jsxs)("div",{children:[(0,a.jsx)("div",{className:"flex justify-between items-center mb-1",children:(0,a.jsx)("label",{className:"block text-sm font-medium text-zinc-300",children:"結束日期"})}),(0,a.jsx)(x.p,{type:"date",value:E,onChange:e=>O($,e.target.value),className:"bg-zinc-950/50 border-input text-zinc-100"})]})]}),(0,a.jsxs)("div",{className:"xl:col-span-4 sm:col-span-2 flex items-end gap-4 justify-end mt-4 md:mt-0",children:[(0,a.jsx)("div",{className:"flex items-center gap-4 mr-auto",children:(0,a.jsxs)("label",{className:"flex items-center gap-2 text-sm text-zinc-300 cursor-pointer",children:[(0,a.jsx)("input",{type:"checkbox",checked:D,onChange:e=>B(e.target.checked),className:"rounded border-zinc-600 bg-zinc-800 text-violet-500 focus:ring-violet-500 accent-violet-500"}),(0,a.jsx)("span",{children:"排除商辦/店面"})]})}),(0,a.jsxs)(d.$,{variant:"default",className:"bg-violet-600 hover:bg-violet-500 text-white min-w-[120px] hidden md:flex",disabled:0===z.length||s,onClick:()=>{localStorage.setItem("reportReady","true"),window.dispatchEvent(new Event("reportReady")),(0,j.M)({action:"search",route:"/dashboard",metadata:{counties:z,districts:k,transactionType:C}}),e?.()},children:[s?(0,a.jsx)("span",{className:"animate-spin mr-2",children:"⟳"}):(0,a.jsx)(p.A,{className:"mr-2 h-4 w-4"}),s?"分析中...":"分析報表"]})]})]})]}),s&&n&&(0,a.jsxs)("div",{className:"mt-4 rounded-2xl border border-white/5 bg-zinc-950/40 px-5 py-4 shadow-[0_0_30px_rgba(139,92,246,0.15)]",children:[(0,a.jsxs)("div",{className:"flex items-center justify-between text-xs text-zinc-400 mb-3",children:[(0,a.jsx)("span",{className:"uppercase tracking-[0.2em]",children:"分析進度"}),(0,a.jsxs)("span",{className:"text-zinc-300 font-medium",children:[n.completed,"/",n.total]})]}),(0,a.jsx)("div",{className:"h-2.5 w-full rounded-full bg-zinc-900/80 overflow-hidden border border-white/5",children:(0,a.jsx)(i.P.div,{className:"h-full rounded-full bg-gradient-to-r from-violet-500 via-fuchsia-500 to-cyan-400 shadow-[0_0_16px_rgba(139,92,246,0.6)]",initial:{width:0},animate:{width:`${er}%`},transition:{duration:.4,ease:"easeOut"}})}),(0,a.jsxs)("div",{className:"mt-3 flex flex-wrap items-center gap-2 text-xs text-zinc-500",children:[n.currentCounty&&(0,a.jsx)("span",{className:"rounded-full bg-white/5 px-2 py-1 text-zinc-300",children:n.currentCounty}),n.currentRange&&(0,a.jsx)("span",{className:"rounded-full bg-white/5 px-2 py-1",children:n.currentRange}),(0,a.jsxs)("span",{className:"ml-auto text-zinc-400",children:[er,"%"]})]})]})]})}var z=t(68305),k=t(38734),C=t(99133),_=t(37847),A=t(59603),S=t(16348),$=t(31840),E=t(30327),D=t(53810),P=t(13545),R=t(6296),L=t(57518);let T=L.bL,F=l.forwardRef(({className:e,...s},t)=>(0,a.jsx)(L.B8,{ref:t,className:(0,m.cn)("inline-flex h-10 items-center justify-center rounded-md bg-zinc-800 p-1 text-zinc-400",e),...s}));F.displayName=L.B8.displayName;let M=l.forwardRef(({className:e,...s},t)=>(0,a.jsx)(L.l9,{ref:t,className:(0,m.cn)("inline-flex items-center justify-center whitespace-nowrap rounded-sm px-3 py-1.5 text-sm font-medium ring-offset-background transition-all focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2 disabled:pointer-events-none disabled:opacity-50 data-[state=active]:bg-zinc-950 data-[state=active]:text-white data-[state=active]:shadow-sm",e),...s}));M.displayName=L.l9.displayName;let G=l.forwardRef(({className:e,...s},t)=>(0,a.jsx)(L.UC,{ref:t,className:(0,m.cn)("mt-2 ring-offset-background focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2",e),...s}));G.displayName=L.UC.displayName;var O=t(39734),B=t(92451),I=t(84980),q=t(94514),K=t(67635),U=t(42763);function H({trigger:e,analysisData:s}){let[t,i]=(0,l.useState)(!1),[n,c]=(0,l.useState)(!1),[o,m]=(0,l.useState)(null),[u,h]=(0,l.useState)(null),[p,f]=(0,l.useState)(""),[b,v]=(0,l.useState)(!1),g=(0,r.P)(e=>e),j=async()=>{c(!0);try{let e={filters:{counties:g.counties,districts:g.districts,projectNames:g.projectNames,selectedRoomTypes:g.selectedRoomTypes},activeTab:g.activeTab,view:"default"},t=s?{...s,transactionDetails:s.transactionDetails?s.transactionDetails.slice(0,100):[],priceBandAnalysis:s.priceBandAnalysis?{...s.priceBandAnalysis,transactionDetails:void 0}:void 0}:null,{data:a,error:l}=await N.N.functions.invoke("create-snapshot",{body:{title:p||`Market Report - ${new Date().toLocaleDateString()}`,config_json:{...e,data:t},duration_hours:24}});if(l)throw console.error("Edge Function Error:",l),Error(l.message||`Status: ${l.context?.response?.status||"Unknown"}`);let i=window.location.origin,n=`${i}/trb/share?id=${a.snapshot_id}`;m(n),h({expiresAt:a.expires_at})}catch(e){console.error(e),alert("Error creating link: "+(e instanceof Error?e.message:JSON.stringify(e)))}finally{c(!1)}};return(0,a.jsxs)(U.lG,{open:t,onOpenChange:e=>!e&&void(m(null),h(null),f(""),i(!1)),children:[(0,a.jsx)(U.zM,{asChild:!0,onClick:()=>i(!0),children:e||(0,a.jsxs)(d.$,{variant:"outline",size:"sm",className:"gap-2 bg-zinc-900/50 border-white/10 hover:bg-zinc-800 text-cyan-400",children:[(0,a.jsx)(D.A,{className:"w-4 h-4"}),(0,a.jsx)("span",{className:"hidden sm:inline",children:"分享報表"})]})}),(0,a.jsxs)(U.Cf,{className:"bg-zinc-950 border-zinc-800 text-white sm:max-w-md",children:[(0,a.jsx)(U.c7,{children:(0,a.jsxs)(U.L3,{className:"text-xl font-bold flex items-center gap-2",children:[(0,a.jsx)(B.A,{className:"w-5 h-5 text-cyan-400"}),n?"生成報表連結中...":"生成報表分享連結"]})}),o?(0,a.jsxs)("div",{className:"space-y-6 py-4 animate-in fade-in zoom-in-95",children:[(0,a.jsxs)("div",{className:"text-center space-y-2",children:[(0,a.jsx)("div",{className:"w-12 h-12 bg-green-500/10 rounded-full flex items-center justify-center mx-auto mb-2 text-green-500",children:(0,a.jsx)(q.A,{className:"w-6 h-6"})}),(0,a.jsx)("h3",{className:"text-lg font-bold text-white",children:"連結建立成功！"}),(0,a.jsxs)("p",{className:"text-xs text-zinc-500",children:["有效期至：",new Date(u?.expiresAt||"").toLocaleString()]})]}),(0,a.jsxs)("div",{className:"flex items-center gap-2 p-3 bg-zinc-900 rounded-lg border border-zinc-700",children:[(0,a.jsx)("code",{className:"flex-1 text-xs text-zinc-300 break-all line-clamp-2",children:o}),(0,a.jsx)(d.$,{size:"icon",variant:"ghost",onClick:()=>{o&&(navigator.clipboard.writeText(o),v(!0),setTimeout(()=>v(!1),2e3))},className:b?"text-green-400":"text-zinc-400 hover:text-white",children:b?(0,a.jsx)(q.A,{className:"w-4 h-4"}):(0,a.jsx)(K.A,{className:"w-4 h-4"})})]}),(0,a.jsx)(d.$,{variant:"secondary",onClick:()=>i(!1),className:"w-full",children:"完成"})]}):(0,a.jsx)("div",{className:"space-y-6 py-4",children:n?(0,a.jsxs)("div",{className:"space-y-4 animate-in fade-in zoom-in-95",children:[(0,a.jsxs)("div",{className:"space-y-2",children:[(0,a.jsxs)("div",{className:"flex justify-between text-xs text-zinc-400",children:[(0,a.jsx)("span",{children:"正在加密分析數據..."}),(0,a.jsx)("span",{className:"animate-pulse",children:"請稍候"})]}),(0,a.jsx)("div",{className:"h-2 w-full bg-zinc-800 rounded-full overflow-hidden",children:(0,a.jsx)("div",{className:"h-full bg-cyan-500 animate-[progress_2s_ease-in-out_infinite] w-[60%] rounded-full shadow-[0_0_10px_rgba(6,182,212,0.5)]"})})]}),(0,a.jsx)("div",{className:"p-4 bg-cyan-500/5 border border-cyan-500/10 rounded-lg",children:(0,a.jsxs)("p",{className:"text-xs text-cyan-300 flex items-center gap-2",children:[(0,a.jsx)(R.A,{className:"w-3.5 h-3.5 animate-spin"}),"系統正在為您建立專屬的快照頁面"]})})]}):(0,a.jsxs)(a.Fragment,{children:[(0,a.jsxs)("div",{className:"space-y-2",children:[(0,a.jsx)("label",{className:"text-sm font-medium text-zinc-400",children:"報告標題 (選填)"}),(0,a.jsx)(x.p,{placeholder:"例如：信義區 Q1 市場分析...",value:p,onChange:e=>f(e.target.value),className:"bg-zinc-900 border-zinc-700 focus:border-cyan-500"})]}),(0,a.jsxs)("div",{className:"bg-blue-500/10 border border-blue-500/20 rounded-lg p-4 space-y-3",children:[(0,a.jsxs)("h4",{className:"text-sm font-semibold text-blue-400 flex items-center gap-2",children:[(0,a.jsx)(I.A,{className:"w-4 h-4"}),"分享規則說明"]}),(0,a.jsxs)("ul",{className:"text-xs text-zinc-400 space-y-1 list-disc list-inside",children:[(0,a.jsx)("li",{children:"此連結將鎖定您目前的「所有篩選條件」。"}),(0,a.jsx)("li",{children:"接收者看到的數據是**即時**的，但**無法修改**篩選條件。"}),(0,a.jsxs)("li",{children:["連結有效期為 ",(0,a.jsx)("strong",{children:"24 小時"}),"，過期自動失效。"]})]})]}),(0,a.jsx)(d.$,{onClick:j,className:"w-full bg-cyan-600 hover:bg-cyan-500 text-white font-semibold",children:"建立分享連結"})]})})]})]})}var J=t(25777);let V=({children:e,isGuest:s,blur:t=!0})=>{if(!s)return(0,a.jsx)(a.Fragment,{children:e});let l=async()=>{window.location.href="/trb/"};return(0,a.jsxs)("div",{className:"relative w-full h-full min-h-[400px]",children:[(0,a.jsx)("div",{className:`${t?"filter blur-md opacity-30 select-none pointer-events-none overflow-hidden h-[400px]":""}`,children:e}),(0,a.jsx)("div",{className:"absolute inset-0 z-10 flex items-center justify-center p-6",children:(0,a.jsxs)("div",{className:"bg-zinc-900/90 backdrop-blur-xl border border-white/10 p-8 rounded-2xl shadow-2xl max-w-md w-full text-center space-y-6 animate-in fade-in zoom-in duration-500",children:[(0,a.jsx)("div",{className:"w-16 h-16 bg-zinc-800 rounded-full flex items-center justify-center mx-auto mb-4 border border-white/5 shadow-inner",children:(0,a.jsx)(J.A,{className:"w-8 h-8 text-violet-400"})}),(0,a.jsxs)("div",{className:"space-y-2",children:[(0,a.jsx)("h3",{className:"text-xl font-bold text-white",children:"會員專屬權限"}),(0,a.jsxs)("p",{className:"text-zinc-400 text-sm leading-relaxed",children:["您目前處於訪客模式，僅能查看核心指標數據。",(0,a.jsx)("br",{}),"解鎖完整圖表分析，請登入會員。"]})]}),(0,a.jsxs)("div",{className:"pt-2",children:[(0,a.jsx)("button",{onClick:l,className:"w-full py-3 px-4 bg-[#06C755] hover:bg-[#05b34c] text-white rounded-xl shadow-lg shadow-green-900/20 transition-all font-bold flex items-center justify-center gap-2 transform hover:-translate-y-1",children:(0,a.jsx)("span",{className:"font-bold text-lg",children:"LINE 一鍵登入"})}),(0,a.jsxs)("p",{className:"text-xs text-zinc-600 mt-4",children:["登入即刻享有封測期間 ",(0,a.jsx)("span",{className:"text-violet-400",children:"Pro 進階權限"})]})]})]})})]})};var Y=t(69261),Q=t(38346),W=t(85993);function Z(){let e=(0,r.P)(),{loading:s,error:t,analysisData:c,analysisProgress:o,handleAnalyze:x,setError:m}=(0,O.g)(),{role:u,isLoading:h}=(0,Q.h)(),{checkAccess:p,fetchFlags:f,isLoading:b}=(0,W.T)(),[g,j]=(0,l.useState)(!1),y=p("dashboard_metrics",u),[L,B]=(0,l.useState)(!1),[I,q]=(0,l.useState)(!1);(0,l.useEffect)(()=>{(async()=>{let{data:{session:e}}=await N.N.auth.getSession();e?B(!1):B(!0),q(!0)})()},[]),(0,l.useEffect)(()=>{f()},[f]);let K=()=>{var s;let t;return(0,a.jsxs)("div",{className:"flex flex-col sm:flex-row sm:items-center justify-between gap-4 mb-6 p-4 rounded-xl bg-zinc-900/30 border border-white/5 backdrop-blur-sm",children:[(0,a.jsxs)("div",{children:[(0,a.jsxs)("h3",{className:"text-lg font-bold text-white flex items-center gap-2",children:[(0,a.jsx)("span",{className:"w-1 h-5 bg-violet-500 rounded-full"}),(s=e.activeTab,t=[{value:"ranking",label:"核心指標與排名"},{value:"price-band",label:"總價帶分析"},{value:"unit-price",label:"單價分析"},{value:"heatmap",label:"調價熱力圖"},{value:"timeline",label:"政策時光機"},{value:"velocity",label:"銷售速度與房型"},{value:"parking",label:"車位分析"},{value:"data-list",label:"交易明細列表"}].find(e=>e.value===s),t?.label||"")]}),(0,a.jsx)("p",{className:"text-xs text-zinc-500 mt-1",children:"針對目前篩選條件下的市場數據深度分析"})]}),!L&&(0,a.jsx)(H,{analysisData:c,trigger:(0,a.jsxs)(d.$,{className:"bg-cyan-600/10 hover:bg-cyan-600/20 text-cyan-400 border border-cyan-500/30 gap-2 shrink-0",children:[(0,a.jsx)(D.A,{className:"w-4 h-4"}),"分享報表"]})})]})},U=(0,l.useCallback)(async()=>{if(!h&&!b){if(u&&"user"!==u)return void await x();if(!u)return void m("請先登入後再進行分析。");j(!0);try{let e=await v.FH.consumeReferralFeature("dashboard","check");if(!e?.allowed){let s=e?.reason;if("no_referral"===s){if(y.allowed)return void await x();m("此功能未對一般會員開放。");return}m({no_referral:"需要有效推薦碼才能使用總儀表板分析。",not_granted:"此推薦碼未開通總儀表板功能。",quota_exceeded:"總儀表板使用次數已用完。",time_limited_quota_exceeded:"限時開放體驗次數已用完。",expired:"推薦碼已過期。",not_started:"推薦碼尚未生效。",inactive:"推薦碼已停用。",unauthorized:"請先登入後再進行分析。",not_allowed:"此功能未對一般會員開放。"}[s]||"無法使用總儀表板分析，請確認推薦碼狀態。");return}if(await x()){let e=await v.FH.consumeReferralFeature("dashboard","consume");e?.allowed||m({no_referral:"需要有效推薦碼才能使用總儀表板分析。",not_granted:"此推薦碼未開通總儀表板功能。",quota_exceeded:"總儀表板使用次數已用完。",time_limited_quota_exceeded:"限時開放體驗次數已用完。",expired:"推薦碼已過期。",not_started:"推薦碼尚未生效。",inactive:"推薦碼已停用。",unauthorized:"請先登入後再進行分析。",not_allowed:"此功能未對一般會員開放。"}[e?.reason]||"扣次失敗，請稍後再試。")}}catch(e){console.error("Consume dashboard feature failed:",e),m(e?.message||"扣次失敗，請稍後再試。")}finally{j(!1)}}},[u,h,b,y,x,m]);return I?L?(0,a.jsx)(Y.A,{reason:"unauthorized"}):(0,a.jsxs)(n.e,{children:[(0,a.jsx)("section",{className:"mb-6 relative z-50",children:(0,a.jsx)(w,{onAnalyze:U,isLoading:s||g,analysisData:c,analysisProgress:o})}),t&&(0,a.jsxs)("div",{className:"bg-red-500/10 border border-red-500/50 text-red-500 p-4 rounded-lg mb-6 flex items-center gap-2",children:[(0,a.jsx)(P.A,{size:20}),t]}),s&&(0,a.jsxs)("div",{className:"flex flex-col items-center justify-center py-20",children:[(0,a.jsx)(R.A,{className:"h-10 w-10 animate-spin text-violet-500 mb-4"}),(0,a.jsx)("p",{className:"text-zinc-400",children:"正在分析數據，請稍候..."})]}),!s&&!c&&!t&&(0,a.jsxs)("div",{className:"flex flex-col items-center justify-center py-20 glass-panel border-dashed border-2 border-zinc-800 rounded-xl",children:[(0,a.jsx)("div",{className:"text-zinc-500 mb-2",children:"尚未進行分析"}),(0,a.jsx)("p",{className:"text-zinc-600 text-sm",children:"請選擇篩選條件並點擊「開始分析」"})]}),!s&&c&&(0,a.jsx)("div",{className:"space-y-8 pb-20",children:(0,a.jsxs)(T,{value:e.activeTab,onValueChange:e.setActiveTab,className:"w-full",children:[(0,a.jsx)("div",{className:"overflow-x-auto pb-2 mask-fade-right pr-8",children:(0,a.jsxs)(F,{className:"bg-zinc-900/50 border border-white/5 p-1 mb-6 inline-flex min-w-max",children:[(0,a.jsx)(M,{value:"ranking",className:"whitespace-nowrap",children:"核心指標與排名"}),(0,a.jsx)(M,{value:"price-band",className:"whitespace-nowrap",children:"總價帶分析"}),(0,a.jsx)(M,{value:"unit-price",className:"whitespace-nowrap",children:"單價分析"}),(0,a.jsx)(M,{value:"heatmap",className:"whitespace-nowrap",children:"調價熱力圖"}),(0,a.jsx)(M,{value:"timeline",className:"whitespace-nowrap",children:"政策時光機"}),(0,a.jsx)(M,{value:"velocity",className:"whitespace-nowrap",children:"銷售速度與房型"}),(0,a.jsx)(M,{value:"parking",className:"whitespace-nowrap",children:"車位分析"}),(0,a.jsx)(M,{value:"data-list",className:"whitespace-nowrap",children:"交易明細列表"})]})}),(0,a.jsxs)(G,{value:"ranking",className:"focus-visible:outline-none focus-visible:ring-0",children:[K(),(0,a.jsx)(i.P.div,{initial:{opacity:0,y:20},animate:{opacity:1,y:0},transition:{duration:.5},children:(0,a.jsx)(z.p,{data:c})})]}),(0,a.jsxs)(G,{value:"price-band",className:"focus-visible:outline-none focus-visible:ring-0",children:[K(),(0,a.jsx)(V,{isGuest:L,children:(0,a.jsx)(i.P.div,{initial:{opacity:0,y:20},animate:{opacity:1,y:0},transition:{duration:.5},children:(0,a.jsx)(k.P,{data:c.priceBandAnalysis?{...c.priceBandAnalysis,transactionDetails:c.transactionDetails}:null})})})]}),(0,a.jsxs)(G,{value:"unit-price",className:"focus-visible:outline-none focus-visible:ring-0",children:[K(),(0,a.jsx)(V,{isGuest:L,children:(0,a.jsx)(i.P.div,{initial:{opacity:0,y:20},animate:{opacity:1,y:0},transition:{duration:.5},children:(0,a.jsx)(A.U,{data:c})})})]}),(0,a.jsxs)(G,{value:"heatmap",className:"focus-visible:outline-none focus-visible:ring-0",children:[K(),(0,a.jsx)(V,{isGuest:L,children:(0,a.jsx)(i.P.div,{initial:{opacity:0,y:20},animate:{opacity:1,y:0},transition:{duration:.5},children:(0,a.jsx)(S.b,{data:c.priceGridAnalysis?c:null})})})]}),(0,a.jsxs)(G,{value:"timeline",className:"focus-visible:outline-none focus-visible:ring-0",children:[K(),(0,a.jsx)(V,{isGuest:L,children:(0,a.jsx)(i.P.div,{initial:{opacity:0,y:20},animate:{opacity:1,y:0},transition:{duration:.5},children:(0,a.jsx)(E.A,{data:c.transactionDetails})})})]}),(0,a.jsxs)(G,{value:"velocity",className:"focus-visible:outline-none focus-visible:ring-0",children:[K(),(0,a.jsx)(V,{isGuest:L,children:(0,a.jsx)(i.P.div,{initial:{opacity:0,y:20},animate:{opacity:1,y:0},transition:{duration:.5},children:(0,a.jsx)(C.Q,{data:c})})})]}),(0,a.jsxs)(G,{value:"parking",className:"focus-visible:outline-none focus-visible:ring-0",children:[K(),(0,a.jsx)(V,{isGuest:L,children:(0,a.jsx)(i.P.div,{initial:{opacity:0,y:20},animate:{opacity:1,y:0},transition:{duration:.5},children:(0,a.jsx)(_.v,{data:c.parkingAnalysis?.parkingRatio?c:null})})})]}),(0,a.jsxs)(G,{value:"data-list",className:"focus-visible:outline-none focus-visible:ring-0",children:[K(),(0,a.jsx)(V,{isGuest:L,children:(0,a.jsx)(i.P.div,{initial:{opacity:0,y:20},animate:{opacity:1,y:0},transition:{duration:.5},children:(0,a.jsx)($.p,{trigger:c.transactionDetails?.length?c:null})})})]})]})})]}):(0,a.jsx)("div",{className:"min-h-screen bg-zinc-950 flex items-center justify-center",children:(0,a.jsx)("div",{className:"h-8 w-8 border-2 border-cyan-500/30 border-t-cyan-500 rounded-full animate-spin"})})}}},e=>{e.O(0,[4764,5969,3242,8500,5772,8044,8378,6609,7908,8435,8261,8962,8041,8875,5098,674,7534,6182,9486,5514,8441,3794,7358],()=>e(e.s=53682)),_N_E=e.O()}]);