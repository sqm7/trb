(self.webpackChunk_N_E=self.webpackChunk_N_E||[]).push([[7101],{27529:(e,t,r)=>{"use strict";r.d(t,{FH:()=>o});var a=r(16385),i=r(55873);async function n(){let{data:{session:e}}=await a.N.auth.getSession();return{"Content-Type":"application/json",apikey:i.m5,Authorization:`Bearer ${e?.access_token||i.m5}`}}async function s(e){let t=await n(),r=await fetch(i.Sn.RANKING_ANALYSIS,{method:"POST",headers:t,body:JSON.stringify({filters:e})});if(!r.ok)throw Error((await r.json().catch(()=>({error:`Analysis request failed: ${r.status}`}))).error||"Analyze data failed");return r.json()}let o={checkAuth:async function(){let{data:{session:e}}=await a.N.auth.getSession();e||console.log("User not logged in, but allowing access.")},getUser:async function(){let{data:{user:e}}=await a.N.auth.getUser();return e},signOut:async function(){let{error:e}=await a.N.auth.signOut();if(e)throw console.error("Sign out failed:",e),e},fetchData:async function(e,t){let r=await n(),a=await fetch(i.Sn.QUERY_DATA,{method:"POST",headers:r,body:JSON.stringify({filters:e,pagination:t})});if(!a.ok)throw Error((await a.json().catch(()=>({error:"Failed to parse server response"}))).error||"Fetch data failed");return a.json()},analyzeData:s,analyzeProjectRanking:s,fetchSubData:async function(e,t,r){if(!e||!t||!r)throw Error(`Insufficient parameters: ${e}, ${t}, ${r}`);let a=await n(),s=await fetch(i.Sn.SUB_DATA,{method:"POST",headers:a,body:JSON.stringify({id:e,type:t,county:r})});if(!s.ok)throw Error((await s.json().catch(()=>({error:"Failed to fetch sub data"}))).error||"Fetch sub data failed");return s.json()},fetchProjectNameSuggestions:async function(e,t,r=[]){let a=await n(),s=t.replace(/\u3127/g,"一"),o=await fetch(i.Sn.PROJECT_NAMES,{method:"POST",headers:a,body:JSON.stringify({countyCode:e,query:s,districts:r,detailed:!0})});if(!o.ok)throw Error(`Server error: ${o.status}`);return o.json()},getAdminUsers:async function(){let e=await n(),t=await fetch(i.Sn.GET_USERS,{method:"POST",headers:e,body:JSON.stringify({})});if(!t.ok)throw Error((await t.json().catch(()=>({error:"Failed to fetch users"}))).error||"Fetch users failed");return t.json()},getUserActivity:async function(e,t=200,r=0){let a=await n(),s=await fetch(i.Sn.GET_USER_ACTIVITY,{method:"POST",headers:a,body:JSON.stringify({userId:e,limit:t,offset:r})});if(!s.ok)throw Error((await s.json().catch(()=>({error:"Failed to fetch user activity"}))).error||"Fetch user activity failed");return s.json()},getActivityStats:async function(){let e=await n(),t=await fetch(i.Sn.GET_ACTIVITY_STATS,{method:"POST",headers:e,body:JSON.stringify({})});if(!t.ok)throw Error((await t.json().catch(()=>({error:"Failed to fetch activity stats"}))).error||"Fetch activity stats failed");return t.json()},validateReferralCode:async function(e){let t=await n();return(await fetch(i.Sn.VALIDATE_REFERRAL_CODE,{method:"POST",headers:t,body:JSON.stringify({code:e})})).json()},activateSubscription:async function(e){let t=await n(),r=await fetch(i.Sn.ACTIVATE_SUBSCRIPTION,{method:"POST",headers:t,body:JSON.stringify(e)});if(!r.ok)throw Error((await r.json().catch(()=>({error:"Activation failed"}))).error||"Activation failed");return r.json()},bindReferralCode:async function(e){let t=await n(),r=await fetch(i.Sn.BIND_REFERRAL_CODE,{method:"POST",headers:t,body:JSON.stringify({code:e})});if(!r.ok)throw Error((await r.json().catch(()=>({error:"Failed to bind referral code"}))).error||"Failed to bind referral code");return r.json()},getReferralDashboard:async function(){let e=await n(),t=await fetch(i.Sn.GET_REFERRAL_DASHBOARD,{method:"POST",headers:e,body:JSON.stringify({})});if(!t.ok)throw Error((await t.json().catch(()=>({error:"Failed to fetch referral data"}))).error||"Fetch referral dashboard failed");return t.json()},consumeReferralFeature:async function(e,t="consume"){let r=await n(),a=await fetch(i.Sn.CONSUME_REFERRAL_FEATURE,{method:"POST",headers:r,body:JSON.stringify({feature:e,mode:t})});if(!a.ok){let e=await a.json().catch(()=>({error:"Failed to consume feature"}));throw Error(e.error||e.reason||"Failed to consume feature")}return a.json()}}},38346:(e,t,r)=>{"use strict";r.d(t,{h:()=>n});var a=r(12115),i=r(16385);function n(){let[e,t]=(0,a.useState)(null),[r,n]=(0,a.useState)(!0);return(0,a.useEffect)(()=>{let e=!0,r=async()=>{try{let{data:{session:r}}=await i.N.auth.getSession();if(!r?.user){e&&(t(null),n(!1));return}let{data:a,error:s}=await i.N.from("profiles").select("role").eq("id",r.user.id).single();e&&(a?t(a.role):t("user"),n(!1))}catch(r){console.error("Error fetching user role:",r),e&&(t("user"),n(!1))}};r();let{data:{subscription:a}}=i.N.auth.onAuthStateChange((e,a)=>{a?r():t(null)});return()=>{e=!1,a.unsubscribe()}},[]),{role:e,isLoading:r}}},38965:(e,t,r)=>{"use strict";r.r(t),r.d(t,{default:()=>m});var a=r(95155),i=r(12115),n=r(68041),s=r(37206),o=r(38346),l=r(27529),d=r(69261),c=r(85993);let u=(0,s.default)(()=>r.e(2047).then(r.bind(r,82047)),{loadableGenerated:{webpack:()=>[82047]},ssr:!1,loading:()=>(0,a.jsx)("div",{className:"w-full h-full flex flex-col items-center justify-center bg-zinc-900 border border-white/5 rounded-xl",children:(0,a.jsxs)("div",{className:"animate-pulse flex flex-col items-center gap-4",children:[(0,a.jsx)("div",{className:"h-10 w-10 border-2 border-cyan-500 border-t-transparent rounded-full animate-spin"}),(0,a.jsx)("p",{className:"text-zinc-500 text-sm",children:"Loading Measurement Engine..."})]})})});function m(){let[e]=(0,i.useState)(!0),{role:t,isLoading:r}=(0,o.h)(),{checkAccess:s,fetchFlags:m,isLoading:f}=(0,c.T)(),[_,h]=(0,i.useState)("idle"),[w,g]=(0,i.useState)(void 0),p=s("floor_plan",t);(0,i.useEffect)(()=>{m()},[m]),(0,i.useEffect)(()=>{if(!r&&!f){if(t&&"user"!==t)return void h("allowed");if(!t){h("denied"),g("unauthorized");return}p.allowed&&"beta"===p.reason?h("allowed"):"idle"===_&&(h("checking"),l.FH.consumeReferralFeature("floor_plan","check").then(e=>{e?.allowed?h("allowed"):e?.reason==="no_referral"?p.allowed?h("allowed"):(h("denied"),g("not_allowed")):(h("denied"),g(e?.reason||"not_allowed"))}).catch(e=>{console.error("Consume floor_plan feature failed:",e),h("denied"),g("error")}))}},[t,r,f,_,p]);let y=(0,i.useCallback)(async()=>{if(!r&&!f&&t&&"user"===t&&(!p.allowed||"beta"!==p.reason))try{let e=await l.FH.consumeReferralFeature("floor_plan","consume");e?.allowed||(h("denied"),g(e?.reason||"not_allowed"))}catch(e){console.error("Consume floor_plan feature failed:",e),h("denied"),g("error")}},[t,r,f,p]);return r||f||"checking"===_?(0,a.jsx)("div",{className:"min-h-screen bg-zinc-950 flex items-center justify-center",children:(0,a.jsx)("div",{className:"h-8 w-8 border-2 border-cyan-500/30 border-t-cyan-500 rounded-full animate-spin"})}):"denied"===_?(0,a.jsx)(d.A,{reason:w}):(0,a.jsx)(n.e,{children:(0,a.jsxs)("div",{className:e?"fixed inset-y-0 left-0 right-0 lg:left-20 z-50 flex flex-col gap-4 bg-zinc-950 p-4":"flex flex-col h-[calc(100vh-8rem)] gap-6 animate-in fade-in zoom-in-95 duration-500",children:[(0,a.jsx)("div",{className:"flex items-center justify-between",children:(0,a.jsxs)("div",{children:[(0,a.jsx)("h1",{className:"text-2xl font-bold text-white tracking-tight",children:"平面圖測量工具"}),(0,a.jsx)("p",{className:"text-zinc-400 text-sm",children:"上傳圖檔、設定比例尺，精準計算空間坪數。"})]})}),(0,a.jsx)("div",{className:e?"flex-1 bg-zinc-900/50 rounded-2xl border border-white/5 p-1 relative overflow-hidden":"flex-1 bg-zinc-900/50 rounded-2xl border border-white/5 p-1 relative overflow-hidden shadow-2xl",children:(0,a.jsx)(u,{onUploadSuccess:y})})]})})}},69261:(e,t,r)=>{"use strict";r.d(t,{A:()=>c});var a=r(95155),i=r(39430),n=r(17758),s=r(41585),o=r(80723),l=r(73321);let d={no_referral:{title:"需要推薦碼授權",description:"此功能需要有效推薦碼才能使用，請至系統設定輸入或更換推薦碼。"},not_granted:{title:"未開通此功能",description:"此推薦碼未授權該功能，請確認推薦碼權限或聯絡管理員。"},quota_exceeded:{title:"使用次數已用完",description:"此功能的使用次數已達上限，請更換推薦碼或升級方案。"},expired:{title:"推薦碼已過期",description:"此推薦碼已超過有效期間，請更換推薦碼。"},not_started:{title:"推薦碼尚未生效",description:"此推薦碼尚未到啟用時間，請稍後再試。"},inactive:{title:"推薦碼已停用",description:"此推薦碼已被停用，請更換推薦碼或聯絡管理員。"},unauthorized:{title:"請先登入",description:"需要登入後才能使用此功能。"},error:{title:"暫時無法使用",description:"系統發生錯誤，請稍後再試。"},not_allowed:{title:"目前未開放",description:"此功能未對一般會員開放，請升級或等待開放。"}};function c({reason:e}){let t=(0,l.useRouter)(),r=d[e||"error"]||d.error;return(0,a.jsxs)("div",{className:"min-h-screen bg-black flex items-center justify-center p-4 relative overflow-hidden",children:[(0,a.jsx)("div",{className:"absolute top-0 left-1/3 w-96 h-96 bg-amber-500/10 rounded-full blur-[128px] pointer-events-none"}),(0,a.jsx)("div",{className:"absolute bottom-0 right-1/4 w-96 h-96 bg-cyan-500/10 rounded-full blur-[128px] pointer-events-none"}),(0,a.jsx)("div",{className:"relative z-10 max-w-md w-full",children:(0,a.jsxs)(i.P.div,{initial:{opacity:0,scale:.95},animate:{opacity:1,scale:1},transition:{duration:.5},className:"bg-zinc-900/60 backdrop-blur-xl border border-amber-500/20 rounded-3xl p-8 shadow-2xl",children:[(0,a.jsxs)(i.P.div,{className:"w-20 h-20 bg-gradient-to-tr from-amber-500/20 to-cyan-500/20 rounded-full flex items-center justify-center mx-auto mb-6 border border-amber-500/30 relative",initial:{rotate:-180,opacity:0},animate:{rotate:0,opacity:1},transition:{delay:.2,type:"spring"},children:["quota_exceeded"===e?(0,a.jsx)(n.A,{className:"w-10 h-10 text-amber-400"}):(0,a.jsx)(s.A,{className:"w-10 h-10 text-amber-400"}),(0,a.jsx)(i.P.div,{className:"absolute inset-0 bg-amber-500/10 rounded-full",animate:{scale:[1,1.15,1]},transition:{duration:2.2,repeat:1/0}})]}),(0,a.jsxs)("div",{className:"text-center space-y-3 mb-8",children:[(0,a.jsx)("h1",{className:"text-2xl font-bold text-white tracking-tight",children:r.title}),(0,a.jsx)("p",{className:"text-zinc-400 text-sm leading-relaxed",children:r.description})]}),(0,a.jsxs)("div",{className:"space-y-3",children:[(0,a.jsxs)("button",{onClick:()=>t.push("/settings"),className:"w-full flex items-center justify-center gap-2 bg-gradient-to-r from-amber-500 to-cyan-500 hover:from-amber-400 hover:to-cyan-400 text-black font-bold py-3.5 px-4 rounded-xl transition-all active:scale-[0.98] shadow-lg shadow-amber-900/20",children:[(0,a.jsx)(n.A,{className:"w-4 h-4"}),"查看推薦碼"]}),(0,a.jsxs)("button",{onClick:()=>t.back(),className:"w-full flex items-center justify-center gap-2 bg-transparent hover:bg-white/5 text-zinc-400 hover:text-white font-medium py-3.5 px-4 rounded-xl border border-white/5 hover:border-white/10 transition-all active:scale-[0.98]",children:[(0,a.jsx)(o.A,{className:"w-4 h-4"}),"回上一頁"]})]}),(0,a.jsx)(i.P.div,{className:"mt-8 pt-6 border-t border-white/5 text-center",initial:{opacity:0},animate:{opacity:1},transition:{delay:.8},children:(0,a.jsx)("p",{className:"text-[10px] text-zinc-600 font-mono uppercase tracking-widest",children:"PLAN: REFERRAL_LIMIT"})})]})})]})}},80318:(e,t,r)=>{Promise.resolve().then(r.bind(r,38965))},85993:(e,t,r)=>{"use strict";r.d(t,{T:()=>s});var a=r(1934),i=r(16385);let n={map_mode:{key:"map_mode",is_active:!0,default_min_role:"user",overrides:{}},floor_plan:{key:"floor_plan",is_active:!0,default_min_role:"user",overrides:{}},report_builder:{key:"report_builder",is_active:!0,default_min_role:"pro",overrides:{}},export_report:{key:"export_report",is_active:!0,default_min_role:"pro",overrides:{}},market_heatmap:{key:"market_heatmap",is_active:!0,default_min_role:"pro",overrides:{user:{access:"time_limited",start_time:new Date().toISOString(),end_time:new Date(Date.now()+2592e6).toISOString(),is_manual_override:!0}}},price_analysis:{key:"price_analysis",is_active:!0,default_min_role:"pro",overrides:{user:{access:"time_limited",start_time:new Date().toISOString(),end_time:new Date(Date.now()+2592e6).toISOString(),is_manual_override:!0}}},total_price_analysis:{key:"total_price_analysis",is_active:!0,default_min_role:"pro",overrides:{user:{access:"time_limited",start_time:new Date().toISOString(),end_time:new Date(Date.now()+2592e6).toISOString(),is_manual_override:!0}}},policy_timeline:{key:"policy_timeline",is_active:!0,default_min_role:"pro",overrides:{user:{access:"time_limited",start_time:new Date().toISOString(),end_time:new Date(Date.now()+2592e6).toISOString(),is_manual_override:!0}}},sales_velocity:{key:"sales_velocity",is_active:!0,default_min_role:"pro",overrides:{user:{access:"time_limited",start_time:new Date().toISOString(),end_time:new Date(Date.now()+2592e6).toISOString(),is_manual_override:!0}}},parking_analysis:{key:"parking_analysis",is_active:!0,default_min_role:"pro",overrides:{user:{access:"time_limited",start_time:new Date().toISOString(),end_time:new Date(Date.now()+2592e6).toISOString(),is_manual_override:!0}}},transaction_list:{key:"transaction_list",is_active:!0,default_min_role:"pro",overrides:{user:{access:"time_limited",start_time:new Date().toISOString(),end_time:new Date(Date.now()+2592e6).toISOString(),is_manual_override:!0}}},share_report:{key:"share_report",is_active:!0,default_min_role:"pro",overrides:{user:{access:"time_limited",start_time:new Date().toISOString(),end_time:new Date(Date.now()+2592e6).toISOString(),is_manual_override:!0}}},system_settings:{key:"system_settings",is_active:!0,default_min_role:"user",overrides:{}},system_announcement:{key:"system_announcement",is_active:!0,default_min_role:"user",overrides:{}},admin_panel:{key:"admin_panel",is_active:!0,default_min_role:"admin",overrides:{}},manage_members:{key:"manage_members",is_active:!0,default_min_role:"admin",overrides:{}},delete_members:{key:"delete_members",is_active:!0,default_min_role:"super_admin",overrides:{}},manage_projects:{key:"manage_projects",is_active:!0,default_min_role:"admin",overrides:{}},post_annoucement:{key:"post_annoucement",is_active:!0,default_min_role:"admin",overrides:{}},upload_tools:{key:"upload_tools",is_active:!0,default_min_role:"admin",overrides:{}},edit_permissions:{key:"edit_permissions",is_active:!0,default_min_role:"super_admin",overrides:{}},manage_plans:{key:"manage_plans",is_active:!0,default_min_role:"admin",overrides:{}},dashboard_metrics:{key:"dashboard_metrics",is_active:!0,default_min_role:"user",overrides:{}}},s=(0,a.v)((e,t)=>({flags:n,isLoading:!0,error:null,fetchFlags:async()=>{e({isLoading:!0,error:null});try{let{data:t,error:r}=await i.N.from("feature_flags").select("*");if(r){console.warn("Failed to fetch feature flags (using defaults):",r.message),e({isLoading:!1});return}if(t&&t.length>0){let r={...n};t.forEach(e=>{r[e.key]&&(r[e.key]={...r[e.key],...e,overrides:e.overrides||{}})}),e({flags:r,isLoading:!1})}else e({isLoading:!1})}catch(t){console.error("Feature flag fetch error:",t),e({isLoading:!1,error:t.message})}},updateFlag:async(r,a)=>{let n=t().flags,s=n[r],o={...s,...a};e({flags:{...n,[r]:o}});try{let{error:e}=await i.N.from("feature_flags").upsert({key:r,is_active:o.is_active,default_min_role:o.default_min_role,overrides:o.overrides,updated_at:new Date().toISOString()});if(e)throw e}catch(t){throw console.error("Failed to update feature flag:",t),e({flags:{...n,[r]:s}}),t}},checkAccess:(e,r)=>{let a=t().flags[e];if(!a||!a.is_active)return{allowed:!1,reason:"default"};let i=r||"user",n=a.overrides[i];if(n){if("granted"===n.access)return{allowed:!0,reason:"override"};if("denied"===n.access)return{allowed:!1,reason:"override"};if("time_limited"===n.access){let e=new Date().getTime(),t=n.start_time?new Date(n.start_time).getTime():0,r=n.end_time?new Date(n.end_time).getTime():1/0;return e>=t&&e<=r?{allowed:!0,reason:"beta",remainingTime:r-e}:{allowed:!1,reason:"override"}}}let s=["user","pro","pro_max","admin","super_admin"];return s.indexOf(i)>=s.indexOf(a.default_min_role||"user")?{allowed:!0,reason:"default"}:{allowed:!1,reason:"default"}}}))}},e=>{e.O(0,[4764,5969,3242,8500,5772,436,8041,8441,3794,7358],()=>e(e.s=80318)),_N_E=e.O()}]);