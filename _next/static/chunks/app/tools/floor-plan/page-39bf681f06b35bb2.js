(self.webpackChunk_N_E=self.webpackChunk_N_E||[]).push([[7101],{27529:(e,r,t)=>{"use strict";t.d(r,{FH:()=>s});var a=t(16385),o=t(55873);async function n(){let{data:{session:e}}=await a.N.auth.getSession();return{"Content-Type":"application/json",apikey:o.m5,Authorization:`Bearer ${e?.access_token||o.m5}`}}async function i(e){let r=await n(),t=await fetch(o.Sn.RANKING_ANALYSIS,{method:"POST",headers:r,body:JSON.stringify({filters:e})});if(!t.ok)throw Error((await t.json().catch(()=>({error:`Analysis request failed: ${t.status}`}))).error||"Analyze data failed");return t.json()}let s={checkAuth:async function(){let{data:{session:e}}=await a.N.auth.getSession();e||console.log("User not logged in, but allowing access.")},getUser:async function(){let{data:{user:e}}=await a.N.auth.getUser();return e},signOut:async function(){let{error:e}=await a.N.auth.signOut();if(e)throw console.error("Sign out failed:",e),e},fetchData:async function(e,r){let t=await n(),a=await fetch(o.Sn.QUERY_DATA,{method:"POST",headers:t,body:JSON.stringify({filters:e,pagination:r})});if(!a.ok)throw Error((await a.json().catch(()=>({error:"Failed to parse server response"}))).error||"Fetch data failed");return a.json()},analyzeData:i,analyzeProjectRanking:i,fetchSubData:async function(e,r,t){if(!e||!r||!t)throw Error(`Insufficient parameters: ${e}, ${r}, ${t}`);let a=await n(),i=await fetch(o.Sn.SUB_DATA,{method:"POST",headers:a,body:JSON.stringify({id:e,type:r,county:t})});if(!i.ok)throw Error((await i.json().catch(()=>({error:"Failed to fetch sub data"}))).error||"Fetch sub data failed");return i.json()},fetchProjectNameSuggestions:async function(e,r,t=[]){let a=await n(),i=r.replace(/\u3127/g,"一"),s=await fetch(o.Sn.PROJECT_NAMES,{method:"POST",headers:a,body:JSON.stringify({countyCode:e,query:i,districts:t,detailed:!0})});if(!s.ok)throw Error(`Server error: ${s.status}`);return s.json()},getAdminUsers:async function(){let e=await n(),r=await fetch(o.Sn.GET_USERS,{method:"POST",headers:e,body:JSON.stringify({})});if(!r.ok)throw Error((await r.json().catch(()=>({error:"Failed to fetch users"}))).error||"Fetch users failed");return r.json()},getUserActivity:async function(e,r=200,t=0){let a=await n(),i=await fetch(o.Sn.GET_USER_ACTIVITY,{method:"POST",headers:a,body:JSON.stringify({userId:e,limit:r,offset:t})});if(!i.ok)throw Error((await i.json().catch(()=>({error:"Failed to fetch user activity"}))).error||"Fetch user activity failed");return i.json()},getActivityStats:async function(){let e=await n(),r=await fetch(o.Sn.GET_ACTIVITY_STATS,{method:"POST",headers:e,body:JSON.stringify({})});if(!r.ok)throw Error((await r.json().catch(()=>({error:"Failed to fetch activity stats"}))).error||"Fetch activity stats failed");return r.json()},validateReferralCode:async function(e){let r=await n();return(await fetch(o.Sn.VALIDATE_REFERRAL_CODE,{method:"POST",headers:r,body:JSON.stringify({code:e})})).json()},activateSubscription:async function(e){let r=await n(),t=await fetch(o.Sn.ACTIVATE_SUBSCRIPTION,{method:"POST",headers:r,body:JSON.stringify(e)});if(!t.ok)throw Error((await t.json().catch(()=>({error:"Activation failed"}))).error||"Activation failed");return t.json()},bindReferralCode:async function(e){let r=await n(),t=await fetch(o.Sn.BIND_REFERRAL_CODE,{method:"POST",headers:r,body:JSON.stringify("string"==typeof e?{code:e}:e)});if(!t.ok)throw Error((await t.json().catch(()=>({error:"Failed to bind referral code"}))).error||"Failed to bind referral code");return t.json()},clearReferralCode:async function(){let e=await n(),r=await fetch(o.Sn.BIND_REFERRAL_CODE,{method:"POST",headers:e,body:JSON.stringify({action:"clear"})});if(!r.ok)throw Error((await r.json().catch(()=>({error:"Failed to clear referral code"}))).error||"Failed to clear referral code");return r.json()},getReferralDashboard:async function(){let e=await n(),r=await fetch(o.Sn.GET_REFERRAL_DASHBOARD,{method:"POST",headers:e,body:JSON.stringify({})});if(!r.ok)throw Error((await r.json().catch(()=>({error:"Failed to fetch referral data"}))).error||"Fetch referral dashboard failed");return r.json()},consumeReferralFeature:async function(e,r="consume"){let t=await n(),a=await fetch(o.Sn.CONSUME_REFERRAL_FEATURE,{method:"POST",headers:t,body:JSON.stringify({feature:e,mode:r})});if(!a.ok){let e=await a.json().catch(()=>({error:"Failed to consume feature"}));throw Error(e.error||e.reason||"Failed to consume feature")}return a.json()}}},38346:(e,r,t)=>{"use strict";t.d(r,{h:()=>n});var a=t(12115),o=t(16385);function n(){let[e,r]=(0,a.useState)(null),[t,n]=(0,a.useState)(!0);return(0,a.useEffect)(()=>{let e=!0,t=async()=>{try{let{data:{session:t}}=await o.N.auth.getSession();if(!t?.user){e&&(r(null),n(!1));return}let{data:a,error:i}=await o.N.from("profiles").select("role").eq("id",t.user.id).single();e&&(a?r(a.role):r("user"),n(!1))}catch(t){console.error("Error fetching user role:",t),e&&(r("user"),n(!1))}};t();let{data:{subscription:a}}=o.N.auth.onAuthStateChange((e,a)=>{a?t():r(null)});return()=>{e=!1,a.unsubscribe()}},[]),{role:e,isLoading:t}}},38965:(e,r,t)=>{"use strict";t.r(r),t.d(r,{default:()=>u});var a=t(95155),o=t(12115),n=t(68041),i=t(37206),s=t(38346),c=t(27529),l=t(69261),d=t(85993);let f=(0,i.default)(()=>t.e(2047).then(t.bind(t,82047)),{loadableGenerated:{webpack:()=>[82047]},ssr:!1,loading:()=>(0,a.jsx)("div",{className:"w-full h-full flex flex-col items-center justify-center bg-zinc-900 border border-white/5 rounded-xl",children:(0,a.jsxs)("div",{className:"animate-pulse flex flex-col items-center gap-4",children:[(0,a.jsx)("div",{className:"h-10 w-10 border-2 border-cyan-500 border-t-transparent rounded-full animate-spin"}),(0,a.jsx)("p",{className:"text-zinc-500 text-sm",children:"Loading Measurement Engine..."})]})})});function u(){let[e]=(0,o.useState)(!0),{role:r,isLoading:t}=(0,s.h)(),{checkAccess:i,fetchFlags:u,isLoading:h}=(0,d.T)(),[w,S]=(0,o.useState)("idle"),[y,g]=(0,o.useState)(void 0),m=i("floor_plan",r);(0,o.useEffect)(()=>{u()},[u]),(0,o.useEffect)(()=>{if(!t&&!h){if(r&&"user"!==r)return void S("allowed");if(!r){S("denied"),g("unauthorized");return}"idle"===w&&(S("checking"),c.FH.consumeReferralFeature("floor_plan","check").then(e=>{e?.allowed?S("allowed"):e?.reason==="no_referral"?m.allowed?S("allowed"):(S("denied"),g("not_allowed")):(S("denied"),g(e?.reason||"not_allowed"))}).catch(e=>{console.error("Consume floor_plan feature failed:",e),S("denied"),g("error")}))}},[r,t,h,w,m]);let b=(0,o.useCallback)(async()=>{if(!t&&!h&&r&&"user"===r)try{let e=await c.FH.consumeReferralFeature("floor_plan","consume");e?.allowed||(S("denied"),g(e?.reason||"not_allowed"))}catch(e){console.error("Consume floor_plan feature failed:",e),S("denied"),g("error")}},[r,t,h,m]);return t||h||"checking"===w?(0,a.jsx)("div",{className:"min-h-screen bg-zinc-950 flex items-center justify-center",children:(0,a.jsx)("div",{className:"h-8 w-8 border-2 border-cyan-500/30 border-t-cyan-500 rounded-full animate-spin"})}):"denied"===w?(0,a.jsx)(l.A,{reason:y}):(0,a.jsx)(n.e,{children:(0,a.jsxs)("div",{className:e?"fixed inset-y-0 left-0 right-0 lg:left-20 z-50 flex flex-col gap-4 bg-zinc-950 p-4":"flex flex-col h-[calc(100vh-8rem)] gap-6 animate-in fade-in zoom-in-95 duration-500",children:[(0,a.jsx)("div",{className:"flex items-center justify-between",children:(0,a.jsxs)("div",{children:[(0,a.jsx)("h1",{className:"text-2xl font-bold text-white tracking-tight",children:"平面圖測量工具"}),(0,a.jsx)("p",{className:"text-zinc-400 text-sm",children:"上傳圖檔、設定比例尺，精準計算空間坪數。"})]})}),(0,a.jsx)("div",{className:e?"flex-1 bg-zinc-900/50 rounded-2xl border border-white/5 p-1 relative overflow-hidden":"flex-1 bg-zinc-900/50 rounded-2xl border border-white/5 p-1 relative overflow-hidden shadow-2xl",children:(0,a.jsx)(f,{onUploadSuccess:b})})]})})}},80318:(e,r,t)=>{Promise.resolve().then(t.bind(t,38965))}},e=>{e.O(0,[4764,5969,3242,8500,5772,436,8041,6765,8441,3794,7358],()=>e(e.s=80318)),_N_E=e.O()}]);