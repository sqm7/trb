"use strict";(self.webpackChunk_N_E=self.webpackChunk_N_E||[]).push([[2560],{27529:(e,t,a)=>{a.d(t,{FH:()=>i});var r=a(16385),s=a(55873);async function n(){let{data:{session:e}}=await r.N.auth.getSession();return{"Content-Type":"application/json",apikey:s.m5,Authorization:`Bearer ${e?.access_token||s.m5}`}}async function l(e){let t=await n(),a=await fetch(s.Sn.RANKING_ANALYSIS,{method:"POST",headers:t,body:JSON.stringify({filters:e})});if(!a.ok)throw Error((await a.json().catch(()=>({error:`Analysis request failed: ${a.status}`}))).error||"Analyze data failed");return a.json()}let i={checkAuth:async function(){let{data:{session:e}}=await r.N.auth.getSession();e||console.log("User not logged in, but allowing access.")},getUser:async function(){let{data:{user:e}}=await r.N.auth.getUser();return e},signOut:async function(){let{error:e}=await r.N.auth.signOut();if(e)throw console.error("Sign out failed:",e),e},fetchData:async function(e,t){let a=await n(),r=await fetch(s.Sn.QUERY_DATA,{method:"POST",headers:a,body:JSON.stringify({filters:e,pagination:t})});if(!r.ok)throw Error((await r.json().catch(()=>({error:"Failed to parse server response"}))).error||"Fetch data failed");return r.json()},analyzeData:l,analyzeProjectRanking:l,fetchSubData:async function(e,t,a){if(!e||!t||!a)throw Error(`Insufficient parameters: ${e}, ${t}, ${a}`);let r=await n(),l=await fetch(s.Sn.SUB_DATA,{method:"POST",headers:r,body:JSON.stringify({id:e,type:t,county:a})});if(!l.ok)throw Error((await l.json().catch(()=>({error:"Failed to fetch sub data"}))).error||"Fetch sub data failed");return l.json()},fetchProjectNameSuggestions:async function(e,t,a=[]){let r=await n(),l=t.replace(/\u3127/g,"一"),i=await fetch(s.Sn.PROJECT_NAMES,{method:"POST",headers:r,body:JSON.stringify({countyCode:e,query:l,districts:a,detailed:!0})});if(!i.ok)throw Error(`Server error: ${i.status}`);return i.json()},getAdminUsers:async function(){let e=await n(),t=await fetch(s.Sn.GET_USERS,{method:"POST",headers:e,body:JSON.stringify({})});if(!t.ok)throw Error((await t.json().catch(()=>({error:"Failed to fetch users"}))).error||"Fetch users failed");return t.json()},getUserActivity:async function(e,t=200,a=0){let r=await n(),l=await fetch(s.Sn.GET_USER_ACTIVITY,{method:"POST",headers:r,body:JSON.stringify({userId:e,limit:t,offset:a})});if(!l.ok)throw Error((await l.json().catch(()=>({error:"Failed to fetch user activity"}))).error||"Fetch user activity failed");return l.json()},getActivityStats:async function(){let e=await n(),t=await fetch(s.Sn.GET_ACTIVITY_STATS,{method:"POST",headers:e,body:JSON.stringify({})});if(!t.ok)throw Error((await t.json().catch(()=>({error:"Failed to fetch activity stats"}))).error||"Fetch activity stats failed");return t.json()},validateReferralCode:async function(e){let t=await n();return(await fetch(s.Sn.VALIDATE_REFERRAL_CODE,{method:"POST",headers:t,body:JSON.stringify({code:e})})).json()},activateSubscription:async function(e){let t=await n(),a=await fetch(s.Sn.ACTIVATE_SUBSCRIPTION,{method:"POST",headers:t,body:JSON.stringify(e)});if(!a.ok)throw Error((await a.json().catch(()=>({error:"Activation failed"}))).error||"Activation failed");return a.json()},bindReferralCode:async function(e){let t=await n(),a=await fetch(s.Sn.BIND_REFERRAL_CODE,{method:"POST",headers:t,body:JSON.stringify("string"==typeof e?{code:e}:e)});if(!a.ok)throw Error((await a.json().catch(()=>({error:"Failed to bind referral code"}))).error||"Failed to bind referral code");return a.json()},clearReferralCode:async function(){let e=await n(),t=await fetch(s.Sn.BIND_REFERRAL_CODE,{method:"POST",headers:e,body:JSON.stringify({action:"clear"})});if(!t.ok)throw Error((await t.json().catch(()=>({error:"Failed to clear referral code"}))).error||"Failed to clear referral code");return t.json()},getReferralDashboard:async function(){let e=await n(),t=await fetch(s.Sn.GET_REFERRAL_DASHBOARD,{method:"POST",headers:e,body:JSON.stringify({})});if(!t.ok)throw Error((await t.json().catch(()=>({error:"Failed to fetch referral data"}))).error||"Fetch referral dashboard failed");return t.json()},consumeReferralFeature:async function(e,t="consume"){let a=await n(),r=await fetch(s.Sn.CONSUME_REFERRAL_FEATURE,{method:"POST",headers:a,body:JSON.stringify({feature:e,mode:t})});if(!r.ok){let e=await r.json().catch(()=>({error:"Failed to consume feature"}));throw Error(e.error||e.reason||"Failed to consume feature")}return r.json()}}},34198:(e,t,a)=>{a.d(t,{K:()=>o});var r=a(95155),s=a(12115),n=a(40980),l=a(33210),i=a(94514);let o=(0,s.forwardRef)(({options:e,value:t,onChange:a,placeholder:o="Select...",maxItems:c,disabled:d=!1,className:u,onSearch:h,loading:x=!1,onFocus:m},p)=>{let[f,g]=(0,s.useState)(""),[b,y]=(0,s.useState)(!1),j=(0,s.useRef)(null),w=(0,s.useRef)(null),N=h?e:e.filter(e=>e.label.toLowerCase().includes(f.toLowerCase()));return t.map(t=>{let a=e.find(e=>e.value===t);return a?a.label:t}),(0,s.useEffect)(()=>{let e=e=>{j.current&&!j.current.contains(e.target)&&y(!1)};return document.addEventListener("mousedown",e),()=>document.removeEventListener("mousedown",e)},[]),(0,s.useEffect)(()=>{h&&h(f)},[f,h]),(0,r.jsxs)("div",{className:(0,n.cn)("relative w-full",u),ref:j,children:[(0,r.jsxs)("div",{className:(0,n.cn)("flex items-center gap-2 bg-zinc-950/50 border border-input rounded-md px-2 py-1.5 h-[42px] overflow-x-auto custom-scrollbar cursor-text transition-all",b&&"ring-2 ring-ring ring-offset-0 border-ring",d&&"bg-zinc-900/50 cursor-not-allowed opacity-50"),onClick:()=>!d&&w.current?.focus(),children:[t.map(s=>{let n=e.find(e=>e.value===s),i=n?n.label:s,o=n?.renderLabel??i;return(0,r.jsxs)("span",{className:"bg-violet-500/20 text-violet-200 border border-violet-500/30 text-xs rounded-full px-2 py-0.5 flex items-center gap-1 animate-in fade-in zoom-in-95 duration-100 whitespace-nowrap shrink-0",children:[o,!d&&(0,r.jsx)(l.A,{size:12,className:"cursor-pointer hover:text-white transition-colors",onClick:e=>{e.stopPropagation(),a(t.filter(e=>e!==s))}})]},s)}),(0,r.jsx)("input",{ref:w,type:"text",value:f,onChange:e=>g(e.target.value),onFocus:()=>{y(!0),m?.()},onKeyDown:e=>{"Backspace"===e.key&&""===f&&t.length>0&&a(t.slice(0,-1))},placeholder:0===t.length?o:"",className:(0,n.cn)("bg-transparent outline-none flex-grow min-w-[60px] text-zinc-100 placeholder:text-zinc-500 text-sm",d&&"cursor-not-allowed"),disabled:d})]}),b&&!d&&(0,r.jsx)("div",{className:"absolute z-[110] w-full mt-1 bg-zinc-900 border border-zinc-700 rounded-md shadow-xl max-h-60 overflow-y-auto custom-scrollbar animate-in fade-in slide-in-from-top-2 duration-100",children:x?(0,r.jsx)("div",{className:"p-2 text-center text-zinc-500 text-sm",children:"Loading..."}):0===N.length?(0,r.jsx)("div",{className:"p-2 text-center text-zinc-500 text-sm",children:"No options found"}):N.map((e,l)=>{if(!e)return null;let o=0===l||e.group!==N[l-1]?.group;return(0,r.jsxs)(s.Fragment,{children:[o&&e.group&&(0,r.jsx)("div",{className:"px-2 py-1 bg-zinc-800/50 text-xs font-semibold text-zinc-400 sticky top-0 backdrop-blur-sm z-10",children:e.group}),(0,r.jsxs)("div",{className:(0,n.cn)("px-3 py-2 cursor-pointer text-sm flex items-start justify-between hover:bg-zinc-800 transition-colors",t.includes(e.value)&&"bg-violet-500/10 text-violet-400"),onClick:()=>(e=>{if(t.includes(e))a(t.filter(t=>t!==e));else{if(c&&t.length>=c)return;a([...t,e])}g("")})(e.value),children:[(0,r.jsxs)("div",{className:"flex flex-col",children:[(0,r.jsx)("span",{className:"font-medium",children:e.renderLabel??e.label}),e.details&&(0,r.jsxs)("div",{className:"flex items-center gap-2 mt-0.5",children:[(e.details.county||e.details.district)&&(0,r.jsxs)("span",{className:"text-xs text-zinc-500 bg-zinc-800/80 px-1.5 rounded border border-zinc-700",children:[e.details.county,e.details.district]}),e.details.date&&(0,r.jsx)("span",{className:"text-xs text-zinc-600 font-mono",children:e.details.date.substring(0,7)})]})]}),t.includes(e.value)&&(0,r.jsx)(i.A,{size:16,className:"mt-1"})]})]},e.value)})})]})});o.displayName="MultiSelect"},62560:(e,t,a)=>{a.r(t),a.d(t,{default:()=>$});var r=a(95155),s=a(12115),n=a(59481),l=a(15378),i=a(47684),o=a(5677),c=a(86765),d=a(68055),u=a(56634),h=a(69722),x=a.n(h);a(90737);var m=a(83097),p=a.n(m),f=a(36999),g=a(56572),b=a(19231),y=a(21362),j=a(41641),w=a(61878),N=a(6296),v=a(33024),S=a(21975),z=a(1610),k=a(45687),A=a(16385),E=a(34198),C=a(55873),O=a(27529);let _=x().icon({iconUrl:"https://unpkg.com/leaflet@1.7.1/dist/images/marker-icon.png",shadowUrl:"https://unpkg.com/leaflet@1.7.1/dist/images/marker-shadow.png",iconSize:[25,41],iconAnchor:[12,41]});x().Marker.prototype.options.icon=_;let T={cartoDark:{name:"暗色風格 (CartoDB)",url:"https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png",attribution:'&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> &copy; <a href="https://carto.com/attributions">CARTO</a>'},osmDefault:{name:"標準地圖 (OSM)",url:"https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png",attribution:'&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a>'},googleHybrid:{name:"衛星影像 (Google)",url:"https://mt1.google.com/vt/lyrs=y&x={x}&y={y}&z={z}",attribution:"&copy; Google"}};function F({onMoveEnd:e}){return(0,n.Po)({moveend:()=>e()}),null}function R({onReady:e}){let t=(0,n.ko)();return(0,s.useEffect)(()=>{t&&e(t)},[t,e]),null}function $({projects:e=[],refreshToken:t,onMetaChange:a}){let[n,u]=(0,s.useState)("cartoDark"),[m,_]=(0,s.useState)(""),[$,I]=(0,s.useState)(!1),[D,L]=(0,s.useState)([]),[M,J]=(0,s.useState)(!1),[B,G]=(0,s.useState)(!1),[U,K]=(0,s.useState)(null),[W,H]=(0,s.useState)(!1),[V,q]=(0,s.useState)(e),[Y,Z]=(0,s.useState)(!1),[Q,X]=(0,s.useState)(null),[ee,et]=(0,s.useState)("idle"),[ea,er]=(0,s.useState)(null),[es,en]=(0,s.useState)(12),[el,ei]=(0,s.useState)(18),[eo,ec]=(0,s.useState)([]),[ed,eu]=(0,s.useState)([]),[eh,ex]=(0,s.useState)([]),[em,ep]=(0,s.useState)([]),[ef,eg]=(0,s.useState)(!1),[eb,ey]=(0,s.useState)(null),[ej,ew]=(0,s.useState)([]),[eN,ev]=(0,s.useState)(!1),[eS,ez]=(0,s.useState)(null),[ek,eA]=(0,s.useState)([]),[eE,eC]=(0,s.useState)(!1),[eO,e_]=(0,s.useState)(null),[eT,eF]=(0,s.useState)(!1),[eR,e$]=(0,s.useState)(.7),eP=(0,s.useRef)(null),eI=(0,s.useRef)(null),eD=(0,s.useRef)(null),eL=(0,s.useRef)(0),eM=(0,s.useCallback)(()=>{a?.({count:V.length,isLoading:Y,error:Q,status:ee,hasMore:!!ea})},[V.length,Y,Q,ee,ea,a]);(0,s.useEffect)(()=>{eM()},[eM]);let eJ=(0,s.useMemo)(()=>Object.keys(C.WG).map(e=>({label:e,value:e})),[]),eB=(0,s.useMemo)(()=>0===eo.length?[]:eo.flatMap(e=>(C.Ib[e]||[]).map(t=>({label:t,value:t,group:e}))),[eo]),eG=(0,s.useCallback)(e=>{e.length>6||(ec(e),eu(t=>t.filter(t=>e.some(e=>(C.Ib[e]||[]).includes(t)))),ep([]),ex([]),ew([]),ez(null))},[]),eU=(0,s.useCallback)(e=>{eu(e),ep([]),ex([]),ew([]),ez(null)},[]),eK=(0,s.useCallback)(async e=>{let t=e.trim();if(0===eo.length||t.length<2)return void ex([]);eg(!0),ey(null);try{let e=eo.map(async e=>{let a=C.WG[e],r=ed.filter(t=>(C.Ib[e]||[]).includes(t));return O.FH.fetchProjectNameSuggestions(a,t,r).then(t=>{let a=[];return Array.isArray(t)?a=t:t&&t.data&&Array.isArray(t.data)?a=t.data:t&&t.names&&Array.isArray(t.names)&&(a=t.names),a.map(t=>{let a="string"==typeof t,r=a?t:t.name||t.建案名稱||String(t);return{label:r,value:r,group:e,details:a?void 0:{county:e,district:t.district||t.行政區,date:t.earliestDate||t.交易日}}})}).catch(t=>(console.error(`Failed to fetch projects for ${e}:`,t),[]))}),a=(await Promise.all(e)).flat(),r=Array.from(new Map(a.map(e=>[e.value,e])).values());ex(r)}catch(e){console.error("Project search error:",e),ey("搜尋失敗，請稍後再試")}finally{eg(!1)}},[eo,ed]),eW=(0,s.useCallback)(e=>{eP.current&&clearTimeout(eP.current),eP.current=setTimeout(()=>{eK(e)},300)},[eK]);(0,s.useEffect)(()=>()=>{eP.current&&clearTimeout(eP.current)},[]);let eH=(0,s.useCallback)(e=>{ep(e),0===e.length&&(ew([]),ez(null))},[]),eV=(0,s.useCallback)(async()=>{if(0===ed.length||0===eo.length){eA([]),e_(null);return}eC(!0),e_(null);try{let e=eo.map(async e=>{let t=C.WG[e],a=ed.filter(t=>(C.Ib[e]||[]).includes(t));return a.length?O.FH.fetchProjectNameSuggestions(t,"",a).then(e=>{let t=[];return Array.isArray(e)?t=e:e&&e.data&&Array.isArray(e.data)?t=e.data:e&&e.names&&Array.isArray(e.names)&&(t=e.names),t.map(e=>"string"==typeof e?e:e.name||e.建案名稱||String(e)).filter(Boolean)}).catch(t=>(console.error(`Failed to fetch district projects for ${e}:`,t),[])):[]}),t=(await Promise.all(e)).flat(),a=Array.from(new Set(t));eA(a)}catch(e){console.error("District project list error:",e),e_("行政區建案清單載入失敗"),eA([])}finally{eC(!1)}},[eo,ed]);(0,s.useEffect)(()=>{eV()},[eV]);let eq=(0,s.useCallback)(async e=>{if(0!==e.length){ev(!0),ez(null);try{let{data:t}=await A.N.auth.getSession(),a=t?.session?.access_token;if(!a)throw Error("無效的授權金鑰");let r=eo.length>0?eo.map(e=>C.WG[e]).filter(Boolean).map(e=>e.toLowerCase()):"all",s=await fetch("https://zxbmbbfrzbtuueysicoc.supabase.co/functions/v1/map-projects",{method:"POST",headers:{"Content-Type":"application/json",Authorization:`Bearer ${a}`},body:JSON.stringify({countyCode:r,projectNames:e,limit:Math.max(200,20*e.length)})});if(!s.ok){let e=await s.json();throw Error(e.error||`HTTP Error: ${s.status}`)}let n=await s.json(),l=(Array.isArray(n?.projects)?n.projects:[]).map(e=>{let t=Number(e.latitude),a=Number(e.longitude);return Number.isFinite(t)&&Number.isFinite(a)?{lat:t,lng:a,name:e.project_name||"建案"}:null}).filter(Boolean);if(ew(l),0===l.length)return void ez("找不到建案座標");let i=eI.current;if(i)if(1===l.length)i.flyTo([l[0].lat,l[0].lng],Math.max(es,16));else{let e=x().latLngBounds(l.map(e=>[e.lat,e.lng]));i.fitBounds(e,{padding:[80,80],maxZoom:Math.max(es,16)})}}catch(e){console.error("Locate projects error:",e),ez(e.message||"定位失敗")}finally{ev(!1)}}},[eo,es]);(0,s.useEffect)(()=>{0!==em.length&&eq(em)},[em,eq]);let eY=(0,s.useCallback)(()=>{let e=eI.current;if(!e)return null;let t=e.getBounds(),a=e.getZoom(),r={south:t.getSouth(),west:t.getWest(),north:t.getNorth(),east:t.getEast()},s=t.getCenter(),n=Math.abs(r.north-r.south),l=Math.abs(r.east-r.west);return{bbox:r,zoom:a,maxSpanKm:Math.max(111*n,111*l*Math.cos(s.lat*Math.PI/180))}},[]),eZ=(0,s.useCallback)((e,t)=>{let a=new Map;return e.forEach(e=>a.set(`${e.county_code}-${e.id}`,e)),t.forEach(e=>a.set(`${e.county_code}-${e.id}`,e)),Array.from(a.values())},[]),eQ=(0,s.useCallback)(async({append:e=!1,cursor:t}={})=>{let a=eY();if(!a)return;if(a.zoom<es){et("zoom"),X(null),e||(q([]),er(null));return}if(el>0&&a.maxSpanKm>el){et("range"),X(null),e||(q([]),er(null));return}if(ed.length>0){if(eE)return void et("loading");if(0===ek.length){q([]),er(null),et("ready");return}}let r=[a.bbox.south.toFixed(5),a.bbox.west.toFixed(5),a.bbox.north.toFixed(5),a.bbox.east.toFixed(5),a.zoom,es,el].join("|");if(e){if(eD.current?.key&&eD.current.key!==r)return eQ({append:!1})}else eD.current={key:r,bbox:a.bbox,zoom:a.zoom},er(null);let s=eL.current+1;eL.current=s,Z(!0),X(null),et("loading");try{let{data:r}=await A.N.auth.getSession(),n=r?.session?.access_token;if(!n)throw Error("無效的授權金鑰");let l=eo.length>0?eo.map(e=>C.WG[e]).filter(Boolean).map(e=>e.toLowerCase()):"all",i=ed.length>0?ek:null,o=await fetch("https://zxbmbbfrzbtuueysicoc.supabase.co/functions/v1/map-projects",{method:"POST",headers:{"Content-Type":"application/json",Authorization:`Bearer ${n}`},body:JSON.stringify({countyCode:l,projectNames:i&&i.length>0?i:void 0,bbox:a.bbox,zoom:a.zoom,limit:800,cursor:e?t:null})});if(!o.ok){let e=await o.json();throw Error(e.error||`HTTP Error: ${o.status}`)}let c=await o.json();if(eL.current!==s)return;let d=Array.isArray(c?.projects)?c.projects:[];q(t=>e?eZ(t,d):d),er(c?.nextCursor??null),et("ready")}catch(e){if(eL.current!==s)return;console.error("Failed to fetch map projects:",e),X(e.message||"載入建案資料失敗"),et("error")}finally{eL.current===s&&Z(!1)}},[eY,eZ,es,el,eo,ed,ek,eE]),eX=(0,s.useCallback)(()=>{eQ({append:!1})},[eQ]);(0,s.useEffect)(()=>{void 0!==t&&eQ({append:!1})},[t,eQ]),(0,s.useEffect)(()=>{eQ({append:!1})},[es,el,eo,ed,ek,eQ]);let e0=async()=>{if(!eI.current||!M)return;let e=eI.current;if(15>e.getZoom())return;G(!0);let t=e.getBounds(),a=`${t.getSouth()},${t.getWest()},${t.getNorth()},${t.getEast()}`,r=`[out:json][timeout:25];(way["building"](${a});relation["building"](${a}););out body;>;out skel qt;`;try{let e=await fetch(`https://overpass-api.de/api/interpreter?data=${encodeURIComponent(r)}`),t=await e.json(),a=p()(t);K(a)}catch(e){console.error("Failed to load buildings",e)}finally{G(!1)}},e1=async()=>{if(m){I(!0);try{let e=await fetch(`https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(m)}&limit=1`),t=await e.json();if(t&&t.length>0){let{lat:e,lon:a,display_name:r}=t[0],s={lat:parseFloat(e),lng:parseFloat(a)};L([{...s,name:r}]),eI.current?.flyTo([s.lat,s.lng],17)}}catch(e){console.error("Search failed",e)}finally{I(!1)}}},e5={cartoDark:f.A,osmDefault:g.A,googleHybrid:b.A};return(0,r.jsxs)("div",{className:"relative w-full h-full rounded-xl overflow-hidden border border-white/10 shadow-2xl",children:[W?(0,r.jsxs)("button",{onClick:()=>H(!1),className:"absolute top-4 left-4 z-[500] flex items-center gap-2 rounded-full border border-white/10 bg-zinc-900/80 px-3 py-2 text-xs text-zinc-200 shadow-lg backdrop-blur hover:border-white/30",children:[(0,r.jsx)(y.A,{className:"h-3.5 w-3.5"}),"工具面板"]}):(0,r.jsxs)("div",{className:"absolute top-4 left-4 z-[500] w-80 flex flex-col gap-4 max-h-[calc(100vh-2rem)] overflow-y-auto pr-1",children:[(0,r.jsx)("div",{className:"flex justify-end",children:(0,r.jsxs)("button",{onClick:()=>H(!0),className:"flex items-center gap-1 rounded-full border border-white/10 bg-zinc-900/80 px-2 py-1 text-[11px] text-zinc-400 hover:border-white/30",children:[(0,r.jsx)(j.A,{className:"h-3.5 w-3.5"}),"收合"]})}),(0,r.jsxs)("div",{className:"bg-zinc-900/90 backdrop-blur-md p-4 rounded-xl border border-white/10 shadow-lg",children:[(0,r.jsxs)("div",{className:"flex gap-2 mb-4",children:[(0,r.jsxs)("div",{className:"relative flex-1",children:[(0,r.jsx)(w.A,{className:"absolute left-3 top-2.5 h-4 w-4 text-zinc-400"}),(0,r.jsx)("input",{type:"text",value:m,onChange:e=>_(e.target.value),onKeyDown:e=>"Enter"===e.key&&e1(),placeholder:"輸入地址或地標...",className:"w-full bg-zinc-800/50 border border-zinc-700 rounded-lg pl-9 pr-3 py-2 text-sm text-white focus:ring-1 focus:ring-cyan-500 outline-none"})]}),(0,r.jsx)("button",{onClick:e1,disabled:$,className:"bg-cyan-600 hover:bg-cyan-500 text-white px-3 py-2 rounded-lg transition-colors disabled:opacity-50",children:$?(0,r.jsx)(N.A,{className:"animate-spin h-4 w-4"}):"Go"})]}),(0,r.jsxs)("div",{className:"space-y-2",children:[(0,r.jsxs)("label",{className:"text-xs font-bold text-zinc-500 uppercase flex items-center gap-2",children:[(0,r.jsx)(g.A,{className:"h-3 w-3"})," 地圖風格"]}),(0,r.jsx)("div",{className:"grid grid-cols-3 gap-2",children:Object.entries(T).map(([e,t])=>{let a=e5[e]||g.A,s=n===e;return(0,r.jsx)("button",{onClick:()=>u(e),title:t.name,"aria-label":t.name,className:`h-10 w-10 flex items-center justify-center rounded-lg border transition-all ${s?"bg-cyan-500/20 border-cyan-500 text-cyan-300":"bg-zinc-800/50 border-transparent text-zinc-400 hover:bg-zinc-800"}`,children:(0,r.jsx)(a,{className:"h-4 w-4"})},e)})})]})]}),(0,r.jsxs)("div",{className:"bg-zinc-900/90 backdrop-blur-md p-4 rounded-xl border border-white/10 shadow-lg space-y-3",children:[(0,r.jsxs)("div",{className:"flex items-center justify-between",children:[(0,r.jsxs)("div",{className:"text-xs font-bold text-zinc-400 uppercase flex items-center gap-2",children:[(0,r.jsx)(v.A,{className:"h-3 w-3"})," 建案搜尋"]}),eN&&(0,r.jsx)("span",{className:"text-[10px] text-cyan-300",children:"定位中..."})]}),(0,r.jsxs)("div",{className:"space-y-3",children:[(0,r.jsxs)("div",{className:"space-y-1",children:[(0,r.jsx)("label",{className:"text-[11px] text-zinc-500",children:"縣市"}),(0,r.jsx)(E.K,{options:eJ,value:eo,onChange:eG,placeholder:"選擇縣市..."})]}),(0,r.jsxs)("div",{className:"space-y-1",children:[(0,r.jsx)("label",{className:"text-[11px] text-zinc-500",children:"行政區"}),(0,r.jsx)(E.K,{options:eB,value:ed,onChange:eU,placeholder:eo.length>0?"選擇行政區...":"請先選縣市",disabled:0===eo.length})]}),(0,r.jsxs)("div",{className:"space-y-1",children:[(0,r.jsx)("label",{className:"text-[11px] text-zinc-500",children:"建案名稱"}),(0,r.jsx)(E.K,{options:eh,value:em,onChange:eH,placeholder:eo.length>0?"輸入建案名稱搜尋...":"請先選縣市",onSearch:eW,loading:ef,disabled:0===eo.length})]}),(0,r.jsxs)("div",{className:"flex items-center justify-between pt-1",children:[(0,r.jsxs)("div",{className:"text-[11px] text-zinc-500 flex items-center gap-2",children:[(0,r.jsx)(v.A,{className:"h-3 w-3 text-cyan-400"}),"村里界線（NLSC）"]}),(0,r.jsxs)("label",{className:"relative inline-flex items-center cursor-pointer",children:[(0,r.jsx)("input",{type:"checkbox",checked:eT,onChange:e=>eF(e.target.checked),className:"sr-only peer"}),(0,r.jsx)("div",{className:"w-9 h-5 bg-zinc-700 peer-focus:outline-none rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-4 after:w-4 after:transition-all peer-checked:bg-cyan-600"})]})]}),(0,r.jsxs)("label",{className:"space-y-1 text-[10px] text-zinc-500 block",children:[(0,r.jsx)("span",{children:"界線透明度"}),(0,r.jsx)("input",{type:"range",min:.2,max:1,step:.05,value:eR,onChange:e=>e$(parseFloat(e.target.value)),className:"w-full",disabled:!eT})]}),(0,r.jsx)("div",{className:"text-[10px] text-zinc-600",children:"縮放到 z13+ 才會顯示細部里界"})]}),eb&&(0,r.jsx)("div",{className:"text-[11px] text-rose-300",children:eb}),eO&&(0,r.jsx)("div",{className:"text-[11px] text-rose-300",children:eO}),eS&&(0,r.jsx)("div",{className:"text-[11px] text-rose-300",children:eS}),eE&&(0,r.jsxs)("div",{className:"text-[10px] text-cyan-300 flex items-center gap-2",children:[(0,r.jsx)(N.A,{className:"h-3 w-3 animate-spin"})," 讀取行政區建案清單..."]}),(0,r.jsxs)("div",{className:"text-[10px] text-zinc-600 leading-relaxed",children:["縣市會限制載入範圍；行政區用於搜尋候選與界線顯示；選定建案將以 ",(0,r.jsx)("span",{className:"text-amber-300",children:"琥珀色"})," 高亮並定位。"]})]}),(0,r.jsxs)("div",{className:"bg-zinc-900/90 backdrop-blur-md p-4 rounded-xl border border-white/10 shadow-lg space-y-4",children:[(0,r.jsxs)("div",{className:"pt-4 border-t border-white/10",children:[(0,r.jsxs)("div",{className:"flex items-center gap-2 text-sm text-zinc-400 mb-2",children:[(0,r.jsx)(S.A,{className:"h-4 w-4"}),(0,r.jsx)("span",{children:"手動上傳 GeoJSON"})]}),(0,r.jsx)("input",{type:"file",accept:".geojson,.json",onChange:e=>{let t=e.target.files?.[0];if(t){let e=new FileReader;e.onload=e=>{try{K(JSON.parse(e.target?.result))}catch(e){alert("Invalid GeoJSON")}},e.readAsText(t)}},className:"block w-full text-xs text-zinc-500 file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-xs file:font-semibold file:bg-zinc-800 file:text-cyan-400 hover:file:bg-zinc-700"})]}),(0,r.jsxs)("div",{className:"pt-4 border-t border-white/10 space-y-3",children:[(0,r.jsxs)("div",{className:"flex items-center justify-between text-sm text-zinc-200",children:[(0,r.jsxs)("div",{className:"flex items-center gap-2",children:[(0,r.jsx)(v.A,{className:"h-4 w-4 text-cyan-400"}),(0,r.jsx)("span",{children:"建案載入"})]}),(0,r.jsxs)("span",{className:"text-xs text-zinc-500",children:[V.length.toLocaleString()," 筆"]})]}),(0,r.jsxs)("label",{className:"space-y-1 text-[10px] text-zinc-500 block",children:[(0,r.jsxs)("span",{children:["最小縮放層級：",es]}),(0,r.jsx)("input",{type:"range",min:10,max:18,step:1,value:es,onChange:e=>en(parseInt(e.target.value,10)),className:"w-full"})]}),(0,r.jsxs)("label",{className:"space-y-1 text-[10px] text-zinc-500 block",children:[(0,r.jsxs)("span",{children:["最大可視範圍：",el," km"]}),(0,r.jsx)("input",{type:"range",min:4,max:60,step:1,value:el,onChange:e=>ei(parseInt(e.target.value,10)),className:"w-full"})]}),"zoom"===ee&&(0,r.jsxs)("div",{className:"text-[11px] text-amber-300",children:["請放大到 ",es,"+ 才會載入建案"]}),"range"===ee&&(0,r.jsxs)("div",{className:"text-[11px] text-amber-300",children:["範圍過大，請縮小到 ",el," km 內"]}),"loading"===ee&&(0,r.jsxs)("div",{className:"text-[11px] text-cyan-300 flex items-center gap-2",children:[(0,r.jsx)(N.A,{className:"h-3 w-3 animate-spin"})," 載入建案中..."]}),"error"===ee&&(0,r.jsx)("div",{className:"text-[11px] text-rose-300",children:"建案載入失敗，請稍後再試"}),ea&&(0,r.jsx)("button",{onClick:()=>eQ({append:!0,cursor:ea}),disabled:Y,className:"w-full rounded-lg border border-white/10 px-2 py-1.5 text-[11px] text-zinc-200 hover:border-white/30 disabled:opacity-50",children:"載入更多"})]})]})]}),(0,r.jsxs)(l.W,{center:[25.0478,121.5318],zoom:13,style:{height:"100%",width:"100%"},zoomControl:!1,children:[(0,r.jsx)(R,{onReady:e=>{eI.current=e,eQ({append:!1})}}),(0,r.jsx)(i.e,{url:T[n].url,attribution:T[n].attribution}),(0,r.jsx)(o.p,{position:"topright"}),(0,r.jsx)(F,{onMoveEnd:()=>{M&&e0(),eX()}}),eT&&(0,r.jsx)(i.e,{url:"https://wmts.nlsc.gov.tw/wmts/VILLAGE/default/GoogleMapsCompatible/{z}/{y}/{x}",opacity:eR,zIndex:400,minZoom:13}),D.map((e,t)=>(0,r.jsx)(c.p,{position:[e.lat,e.lng],children:(0,r.jsx)(d.z,{children:e.name})},t)),ej.map((e,t)=>(0,r.jsx)(c.p,{position:[e.lat,e.lng],children:(0,r.jsx)(d.z,{children:e.name})},`project-search-${t}`)),V.map(e=>{let t=em.includes(e.project_name),a=eo.length>0||ed.length>0,s=em.length>0&&!t,n=(0,k.F0)((0,r.jsxs)("div",{className:`flex flex-col items-center justify-center transform -translate-x-1/2 -translate-y-full ${s?"opacity-40":""}`,children:[(0,r.jsx)("div",{className:`rounded-full flex items-center justify-center ${t?"h-9 w-9 border-amber-400 shadow-[0_0_18px_rgba(251,191,36,0.65)]":`h-8 w-8 ${a?"border-teal-400":"border-cyan-500"} ${a?"shadow-[0_0_15px_rgba(45,212,191,0.45)]":"shadow-[0_0_15px_rgba(6,182,212,0.5)]"}`} border-2 bg-zinc-950`,children:(0,r.jsx)(z.A,{className:`h-4 w-4 ${t?"text-amber-300":a?"text-teal-300":"text-cyan-400"}`})}),(0,r.jsx)("div",{className:`w-0.5 h-3 ${t?"bg-amber-400":a?"bg-teal-400":"bg-cyan-500"}`})]})),l=(0,h.divIcon)({html:n,className:"custom-leaflet-marker",iconSize:[32,44],iconAnchor:[16,44],popupAnchor:[0,-44]});return(0,r.jsx)(c.p,{position:[e.latitude,e.longitude],icon:l,children:(0,r.jsx)(d.z,{className:"project-popup",minWidth:300,children:(0,r.jsxs)("div",{className:"p-1 min-w-[280px]",children:[(0,r.jsxs)("div",{className:"flex items-start justify-between mb-3 border-b border-zinc-200 pb-2",children:[(0,r.jsxs)("div",{children:[(0,r.jsx)("h3",{className:"text-lg font-bold text-zinc-900 m-0 leading-tight",children:e.project_name}),(0,r.jsx)("p",{className:"text-sm text-zinc-500 mt-1 mb-0",children:e.developer||"未知建商"})]}),"done"===e.enrichment_status&&(0,r.jsx)("span",{className:"bg-emerald-100 text-emerald-700 text-[10px] px-2 py-0.5 rounded-full font-bold whitespace-nowrap",children:"資料完備"})]}),(0,r.jsxs)("div",{className:"grid grid-cols-2 gap-y-2 gap-x-4 text-sm mt-3",children:[(0,r.jsxs)("div",{className:"flex flex-col",children:[(0,r.jsx)("span",{className:"text-zinc-500 text-xs",children:"總戶數"}),(0,r.jsxs)("span",{className:"font-medium text-zinc-800",children:[e.total_households||"-"," 戶"]})]}),(0,r.jsxs)("div",{className:"flex flex-col",children:[(0,r.jsx)("span",{className:"text-zinc-500 text-xs",children:"樓層"}),(0,r.jsx)("span",{className:"font-medium text-zinc-800",children:e.total_floors||"-"})]}),(0,r.jsxs)("div",{className:"flex flex-col",children:[(0,r.jsx)("span",{className:"text-zinc-500 text-xs",children:"公設比"}),(0,r.jsx)("span",{className:"font-medium text-zinc-800",children:e.public_ratio||"-"})]}),(0,r.jsxs)("div",{className:"flex flex-col",children:[(0,r.jsx)("span",{className:"text-zinc-500 text-xs",children:"基地面積"}),(0,r.jsx)("span",{className:"font-medium text-zinc-800",children:e.site_area||"-"})]}),(0,r.jsxs)("div",{className:"flex flex-col col-span-2 mt-1",children:[(0,r.jsx)("span",{className:"text-zinc-500 text-xs",children:"結構"}),(0,r.jsx)("span",{className:"font-medium text-zinc-800 truncate",title:e.structure||"",children:e.structure||"-"})]})]})]})})},`project-${e.county_code}-${e.id}`)}),U&&(0,r.jsx)(P,{data:U})]}),(0,r.jsx)("div",{className:"absolute top-1/2 right-4 -translate-y-1/2 z-[500] w-56",children:(0,r.jsxs)("div",{className:"bg-zinc-900/85 backdrop-blur-md rounded-xl border border-white/10 shadow-lg p-3 space-y-2",children:[(0,r.jsxs)("div",{className:"flex items-center justify-between",children:[(0,r.jsxs)("div",{className:"flex items-center gap-2 text-sm text-zinc-200",children:[(0,r.jsx)(z.A,{className:"h-4 w-4 text-orange-400"}),(0,r.jsx)("span",{children:"3D 建物模型"})]}),(0,r.jsxs)("label",{className:"relative inline-flex items-center cursor-pointer",children:[(0,r.jsx)("input",{type:"checkbox",checked:M,onChange:e=>{J(e.target.checked),e.target.checked?e0():K(null)},className:"sr-only peer"}),(0,r.jsx)("div",{className:"w-9 h-5 bg-zinc-700 peer-focus:outline-none rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-4 after:w-4 after:transition-all peer-checked:bg-cyan-600"})]})]}),(0,r.jsx)("div",{className:"text-[10px] text-zinc-500",children:"放大到 15+ 才會載入"}),B&&(0,r.jsxs)("div",{className:"text-[10px] text-orange-300 flex items-center gap-2",children:[(0,r.jsx)(N.A,{className:"h-3 w-3 animate-spin"}),"載入周邊建物資訊..."]})]})})]})}function P({data:e}){return(0,r.jsx)(u.k,{data:e,style:{color:"#f97316",weight:1,opacity:.7,fillColor:"#fdba74",fillOpacity:.2}},JSON.stringify(e).slice(0,100))}}}]);