(self.webpackChunk_N_E=self.webpackChunk_N_E||[]).push([[3724],{6296:(e,t,r)=>{"use strict";r.d(t,{A:()=>a});let a=(0,r(78340).A)("loader-circle",[["path",{d:"M21 12a9 9 0 1 1-6.219-8.56",key:"13zald"}]])},13545:(e,t,r)=>{"use strict";r.d(t,{A:()=>a});let a=(0,r(78340).A)("circle-alert",[["circle",{cx:"12",cy:"12",r:"10",key:"1mglay"}],["line",{x1:"12",x2:"12",y1:"8",y2:"12",key:"1pkeuh"}],["line",{x1:"12",x2:"12.01",y1:"16",y2:"16",key:"4dfq90"}]])},13724:(e,t,r)=>{"use strict";r.r(t),r.d(t,{default:()=>K});var a=r(95155),n=r(12115),l=r(37206),i=r(36379),s=r.n(i);r(23879);var o=r(56572),c=r(33024),u=r(6296),d=r(16385),p=r(34198),m=r(51806),f=r(55873),h=r(27529),y=r(88743);let g=(e,t)=>{let r=e instanceof Map?e:new Map(e.entries()),a=t instanceof Map?t:new Map(t.entries());if(r.size!==a.size)return!1;for(let[e,t]of r)if(!a.has(e)||!Object.is(t,a.get(e)))return!1;return!0};var x=r(73321),b=r(98883),v=r(81789),j=r(40980),w=r(41463);let N=(0,l.default)(()=>Promise.all([r.e(7534),r.e(2159)]).then(r.bind(r,17709)).then(e=>e.MapPriceBandReport),{loadableGenerated:{webpack:()=>[17709]},ssr:!1}),S=(0,l.default)(()=>Promise.all([r.e(674),r.e(3146)]).then(r.bind(r,33908)).then(e=>e.MapUnitPriceAnalysisReport),{loadableGenerated:{webpack:()=>[33908]},ssr:!1}),k=(0,l.default)(()=>Promise.all([r.e(8044),r.e(8875),r.e(5098),r.e(179)]).then(r.bind(r,84367)).then(e=>e.MapHeatmapReport),{loadableGenerated:{webpack:()=>[84367]},ssr:!1}),C=(0,l.default)(()=>Promise.all([r.e(6182),r.e(9034)]).then(r.bind(r,98230)).then(e=>e.MapSalesVelocityReport),{loadableGenerated:{webpack:()=>[98230]},ssr:!1}),z=[121.5318,25.0478],_="https://zxbmbbfrzbtuueysicoc.supabase.co/functions/v1",E=[_?`${_}/geojson-proxy?type=district`:"",w.env.NEXT_PUBLIC_DISTRICT_GEOJSON_URL,"https://raw.githubusercontent.com/g0v/twgeojson/master/json/twTown1982.geo.json","https://cdn.jsdelivr.net/gh/g0v/twgeojson@master/json/twTown1982.geo.json"].filter(Boolean),L=[_?`${_}/geojson-proxy?type=village`:"",w.env.NEXT_PUBLIC_VILLAGE_GEOJSON_URL,"https://raw.githubusercontent.com/g0v/twgeojson/master/json/twVillage1982.geo.json","https://cdn.jsdelivr.net/gh/g0v/twgeojson@master/json/twVillage1982.geo.json"].filter(Boolean),T=w.env.NEXT_PUBLIC_VILLAGE_WMTS_URL,A=w.env.NEXT_PUBLIC_METRO_GEOJSON_URL,R=["https://overpass-api.de/api/interpreter","https://overpass.kumi.systems/api/interpreter","https://overpass.nchc.org.tw/api/interpreter"],F=e=>e.replace(/台/g,"臺").replace(/\s/g,"").trim(),M=(e,t)=>{if(!e||"FeatureCollection"!==e.type||!Array.isArray(e.features)||!t||0===t.length)return e;let r=t.map(e=>F(e)).filter(Boolean);if(0===r.length)return e;let a=["COUNTYNAME","countyname","COUNTY","COUNTY_N","CountyName","city","county"],n=e.features.filter(e=>{if(!e||"Feature"!==e.type)return!1;let t=I(e.properties||{},a);if(!t)return!1;let n=F(String(t));return r.includes(n)});return{...e,features:n}},O=e=>e*Math.PI/180,P=(e,t)=>{let r=O(t[1]-e[1]),a=O(t[0]-e[0]);return 12742*Math.asin(Math.sqrt(Math.sin(r/2)**2+Math.cos(O(e[1]))*Math.cos(O(t[1]))*Math.sin(a/2)**2))},$=e=>e.replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/"/g,"&quot;").replace(/'/g,"&#039;"),D=e=>null==e||""===e?"-":String(e),I=(e,t)=>{if(e){for(let r of t)if(e[r])return e[r]}},U=(e,t)=>{if(!e||"FeatureCollection"!==e.type||!Array.isArray(e.features))return e;let r=e.features.map((e,r)=>{if(!e||"Feature"!==e.type||void 0!==e.id&&null!==e.id)return e;let a=I(e.properties||{},t);return{...e,id:a??`${r}`}});return{...e,features:r}},B=e=>{if(!e?.geometry)return null;let{type:t,coordinates:r}=e.geometry,a=[],n=e=>{if(e){if("number"==typeof e[0]&&"number"==typeof e[1])return void a.push([e[0],e[1]]);e.forEach(e=>n(e))}};if("Polygon"===t||"MultiPolygon"===t||"LineString"===t||"MultiLineString"===t?n(r):"Point"===t&&a.push(r),0===a.length)return null;let l=a[0][0],i=a[0][0],s=a[0][1],o=a[0][1];return a.forEach(([e,t])=>{l=Math.min(l,e),i=Math.max(i,e),s=Math.min(s,t),o=Math.max(o,t)}),{minLng:l,minLat:s,maxLng:i,maxLat:o}},W=e=>{if(!e)return[];let t=String(e).trim();if(!t)return[];let r=new Set([t]);return t.includes("台")&&r.add(t.replace(/台/g,"臺")),t.includes("臺")&&r.add(t.replace(/臺/g,"台")),Array.from(r)},G=(e,t)=>{if(!t.length)return null;let r=t.flatMap(t=>e.flatMap(e=>[["==",["get",e],t],["in",t,["to-string",["get",e]]]]));return r.length>0?["any",...r]:null},J=(e,t)=>{let r=G(["COUNTYNAME","countyname","COUNTY","COUNTY_N","CountyName","city","county"],e),a=G(["TOWNNAME","townname","TOWN","TOWN_N","TownName","district","town"],t);return r&&a?["all",r,a]:r||a||null},Y=e=>{if(f.m5&&(e.startsWith(`${f.VI}/functions/v1`)||e.includes(".supabase.co/functions/v1")))return{apikey:f.m5,Authorization:`Bearer ${f.m5}`,Accept:"application/json"}},V=async(e,t,r=1e4)=>{let a=null;for(let n of e){let e=!1;try{let a=new AbortController,l=()=>a.abort();t?.addEventListener("abort",l);let i=window.setTimeout(()=>{e=!0,a.abort()},r);try{let e=Y(n),t=await fetch(n,{signal:a.signal,cache:"no-store",headers:e});if(!t.ok)throw Error(`GeoJSON fetch failed: ${t.status}`);return await t.json()}finally{window.clearTimeout(i),t?.removeEventListener("abort",l)}}catch(r){if(r?.name==="AbortError"){if(t?.aborted)throw r;if(e){a=r;continue}}a=r}}throw a||Error("GeoJSON fetch failed")},q=(e,t)=>{if(!t)return e;let r=[],a=[];return(e.forEach(e=>{if(e.includes("geojson-proxy")){let a=e.includes("?")?"&":"?";r.push(`${e}${a}county=${encodeURIComponent(t)}`)}else a.push(e)}),0===r.length)?e:[...r,...a]},H=e=>e.filter(e=>e.includes("geojson-proxy"));function K({projects:e=[],refreshToken:t,onMetaChange:r,panelCollapsed:l=!1}){var i;let w,_=(0,n.useRef)(null),F=(0,n.useRef)(null),O=(0,x.useRouter)(),G=(0,y.P)(e=>e.hydrateFilters),Y=(0,y.P)((i=e=>({excludeCommercial:e.excludeCommercial,floorPremium:e.floorPremium,buildingType:e.buildingType,dateRange:e.dateRange,startDate:e.startDate,endDate:e.endDate}),w=n.useRef(void 0),e=>{let t=i(e);return!function(e,t){if(Object.is(e,t))return!0;if("object"!=typeof e||null===e||"object"!=typeof t||null===t||Object.getPrototypeOf(e)!==Object.getPrototypeOf(t))return!1;if(Symbol.iterator in e&&Symbol.iterator in t){if("entries"in e&&"entries"in t)return g(e,t);let r=e[Symbol.iterator](),a=t[Symbol.iterator](),n=r.next(),l=a.next();for(;!n.done&&!l.done;){if(!Object.is(n.value,l.value))return!1;n=r.next(),l=a.next()}return!!n.done&&!!l.done}return g({entries:()=>Object.entries(e)},{entries:()=>Object.entries(t)})}(w.current,t)?w.current=t:w.current})),[K,Z]=(0,n.useState)(!1),X="1GYoblfxWX2uc8edFcbq",[Q,ee]=(0,n.useState)("dark"),[et,er]=(0,n.useState)(!0),[ea,en]=(0,n.useState)(!1),[el,ei]=(0,n.useState)("idle"),[es,eo]=(0,n.useState)(""),[ec,eu]=(0,n.useState)("project"),[ed,ep]=(0,n.useState)([]),[em,ef]=(0,n.useState)(!1),[eh,ey]=(0,n.useState)(!1),[eg,ex]=(0,n.useState)([]),[eb,ev]=(0,n.useState)("idle"),[ej,ew]=(0,n.useState)(null),[eN,eS]=(0,n.useState)(null),[ek,eC]=(0,n.useState)(0),[ez,e_]=(0,n.useState)(null),[eE,eL]=(0,n.useState)({zoning:{visible:!1,opacity:.6},cadastral:{visible:!1,opacity:.6}}),[eT,eA]=(0,n.useState)(e),[eR,eF]=(0,n.useState)(!1),[eM,eO]=(0,n.useState)(null),[eP,e$]=(0,n.useState)("idle"),[eD,eI]=(0,n.useState)(null),[eU,eB]=(0,n.useState)(12),[eW,eG]=(0,n.useState)(18),[eJ,eY]=(0,n.useState)([]),[eV,eq]=(0,n.useState)([]),[eH,eK]=(0,n.useState)([]),[eZ,eX]=(0,n.useState)([]),[eQ,e0]=(0,n.useState)(!1),[e1,e2]=(0,n.useState)(null),[e3,e5]=(0,n.useState)([]),[e8,e6]=(0,n.useState)(!1),[e4,e9]=(0,n.useState)(null),[e7,te]=(0,n.useState)(null),[tt,tr]=(0,n.useState)([]),ta=(0,n.useRef)(null),tn=(0,n.useRef)(null),[tl,ti]=(0,n.useState)(!1),[ts,to]=(0,n.useState)(null),[tc,tu]=(0,n.useState)(!1),[td,tp]=(0,n.useState)(null),[tm,tf]=(0,n.useState)([]),[th,ty]=(0,n.useState)(!1),[tg,tx]=(0,n.useState)(null),[tb,tv]=(0,n.useState)(1),[tj,tw]=(0,n.useState)(null),[tN,tS]=(0,n.useState)(!1),[tk,tC]=(0,n.useState)(null),[tz,t_]=(0,n.useState)("price-band"),[tE,tL]=(0,n.useState)(!1),[tT,tA]=(0,n.useState)(.9),[tR,tF]=(0,n.useState)("idle"),[tM,tO]=(0,n.useState)(null),[tP,t$]=(0,n.useState)(null),[tD,tI]=(0,n.useState)(null),[tU,tB]=(0,n.useState)(!1),[tW,tG]=(0,n.useState)(.8),[tJ,tY]=(0,n.useState)("idle"),[tV,tq]=(0,n.useState)(null),[tH,tK]=(0,n.useState)(!1),[tZ,tX]=(0,n.useState)(.8),[tQ,t0]=(0,n.useState)("idle"),[t1,t2]=(0,n.useState)(null),t3=(0,n.useRef)(eE),t5=(0,n.useRef)(et),t8=(0,n.useRef)(Q),t6=(0,n.useRef)(ea),t4=(0,n.useRef)(null),t9=(0,n.useRef)(null),t7=(0,n.useRef)(null),re=(0,n.useRef)(new Map),rt=(0,n.useRef)(null),rr=(0,n.useRef)(null),ra=(0,n.useRef)(null),rn=(0,n.useRef)(null),rl=(0,n.useRef)(null),ri=(0,n.useRef)(null),rs=(0,n.useRef)(!1),ro=(0,n.useRef)(null),rc=(0,n.useRef)(null),ru=(0,n.useRef)(0),rd=(0,n.useRef)(null),rp=(0,n.useRef)(null),rm=(0,n.useRef)(null),rf=(0,n.useRef)(null),rh=(0,n.useRef)([]),ry=(0,n.useRef)([]),rg=(0,n.useRef)(!1),rx=(0,n.useRef)([]),rb=(0,n.useRef)({visible:!1,opacity:.9}),rv=(0,n.useRef)({visible:!1,opacity:.8}),rj=(0,n.useRef)({visible:!1,opacity:.8}),rw=(0,n.useRef)(null),rN=(0,n.useRef)(null),rS=(0,n.useRef)(null),rk=(0,n.useRef)(!1),rC=(0,n.useRef)(null),rz=(0,n.useRef)(null),r_=(0,n.useRef)(null),rE=(0,n.useRef)(null),rL=(0,n.useRef)(null),rT=(0,n.useRef)(null),rA=(0,n.useRef)(0),rR=(0,n.useRef)(0),rF=(0,n.useRef)(null),rM=(0,n.useRef)("idle"),rO=(0,n.useRef)(null),rP=(0,n.useRef)(null),r$=(0,n.useRef)(null),rD=(0,n.useRef)(null),rI=(0,n.useRef)(!1),rU=(0,n.useRef)(null),rB=(0,n.useRef)(null),rW=(0,n.useRef)(null),rG=(0,n.useRef)(0),rJ=(0,n.useCallback)(()=>{r?.({count:eT.length,isLoading:eR,error:eM,status:eP,hasMore:!!eD})},[eT.length,eR,eM,eP,eD,r]);(0,n.useEffect)(()=>{rJ()},[rJ]);let rY=(0,n.useMemo)(()=>Object.keys(f.WG).map(e=>({label:e,value:e})),[]),rV=(0,n.useMemo)(()=>0===eJ.length?[]:eJ.flatMap(e=>(f.Ib[e]||[]).map(t=>({label:t,value:t,group:e}))),[eJ]),rq=(0,n.useMemo)(()=>Object.keys(f.WG),[]),rH=(0,n.useMemo)(()=>Object.entries(f.WG).reduce((e,[t,r])=>(e[r.toUpperCase()]=t,e),{}),[]),rK=(0,n.useMemo)(()=>Math.max(1,Math.ceil(tm.length/20)),[tm.length]),rZ=(0,n.useMemo)(()=>{let e=(tb-1)*20;return tm.slice(e,e+20)},[tm,tb]),rX=(0,n.useMemo)(()=>{let e=tm.map(e=>Number(e["房屋單價(萬)"])).filter(e=>Number.isFinite(e));if(0===e.length)return{max:null,min:null,avg:null,median:null};let t=[...e].sort((e,t)=>e-t),r=t[0],a=t[t.length-1],n=e.reduce((e,t)=>e+t,0)/e.length,l=Math.floor(t.length/2);return{max:a,min:r,avg:n,median:t.length%2==0?(t[l-1]+t[l])/2:t[l]}},[tm]),rQ=(0,n.useCallback)(e=>e.replace(/台/g,"臺").replace(/\s/g,"").trim(),[]),r0=(0,n.useCallback)(e=>{let t,r=[],a=e=>{if("string"!=typeof e)return;let t=e.trim();t&&r.push(t)};a(e?.text),a(e?.place_name),e?.properties&&(a(e.properties.county),a(e.properties.city),a(e.properties.region),a(e.properties.state),a(e.properties.district),a(e.properties.locality)),Array.isArray(e?.context)&&e.context.forEach(e=>{a(e?.text),a(e?.name)});let n=r.map(rQ),l=rq.find(e=>n.some(t=>t.includes(rQ(e))));return l&&(t=(f.Ib[l]||[]).find(e=>n.some(t=>t.includes(rQ(e))))),{county:l,district:t}},[rq,rQ]),r1=(0,n.useCallback)(e=>{let t,r=I(e,["COUNTYNAME","countyname","COUNTY","COUNTY_N","CountyName"])||I(e,["city","county"]),a=I(e,["TOWNNAME","townname","TOWN","TOWN_N","TownName"])||I(e,["district","town"]),n=r?rq.find(e=>rQ(e)===rQ(String(r))):void 0;return n&&a&&(t=(f.Ib[n]||[]).find(e=>rQ(e)===rQ(String(a)))),{county:n,district:t,countyRaw:r,districtRaw:a}},[rq,rQ]),r2=(0,n.useCallback)(e=>{let t,r=I(e,["COUNTYNAME","countyname","COUNTY","COUNTY_N","CountyName"])||I(e,["city","county"]),a=I(e,["TOWNNAME","townname","TOWN","TOWN_N","TownName"])||I(e,["district","town"]),n=I(e,["VILLNAME","villname","VILL","VILL_N","VillageName","name"]),l=r?rq.find(e=>rQ(e)===rQ(String(r))):void 0;return l&&a&&(t=(f.Ib[l]||[]).find(e=>rQ(e)===rQ(String(a)))),{county:l,district:t,countyRaw:r,districtRaw:a,villageRaw:n}},[rq,rQ]),r3=(0,n.useCallback)(e=>{if(!e?.center)return;let[t,r]=e.center,a=[t,r];e_(a);let n=r0(e);if(n.county&&eJ.includes(n.county)){let e=f.Ib[n.county]||[],t=n.district&&e.includes(n.district)?[n.district]:[];t.length>0&&eq(t)}eS({lng:t,lat:r,label:e.text||e.place_name||"地址"});let l=F.current;l&&l.flyTo({center:a,zoom:Math.max(l.getZoom(),16),speed:1.4})},[r0,eJ]),r5=(0,n.useCallback)(async e=>{let t=Number(e.latitude),r=Number(e.longitude);tp({id:D(e.id),project_name:D(e.project_name),latitude:Number.isFinite(t)?t:0,longitude:Number.isFinite(r)?r:0,county_code:D(e.county_code),developer:D(e.developer),contractor:D(e.contractor),architect:D(e.architect),sales_agent:D(e.sales_agent),affiliated_companies:D(e.affiliated_companies),construction_license:D(e.construction_license),total_households:D(e.total_households),community_unit_count:D(e.community_unit_count),total_floors:D(e.total_floors),basement_floors:D(e.basement_floors),structure:D(e.structure),public_ratio:D(e.public_ratio),site_area:D(e.site_area),land_use_zoning:D(e.land_use_zoning),land_plot_number:D(e.land_plot_number),parking_type:D(e.parking_type),parking_count:D(e.parking_count),enrichment_status:D(e.enrichment_status)}),tu(!0),tf([]),tx(null),ty(!0),tv(1),tw(null),tC(null),tS(!0);try{let t=String(e.county_code||"").toUpperCase()||(eJ[0]?f.WG[eJ[0]]:"");if(!t)throw Error("缺少縣市代碼");let r={countyCode:t,type:"預售交易",projectNames:[String(e.project_name||"")]},a=await h.FH.fetchData(r,{page:1,limit:1e3});tf(Array.isArray(a?.data)?a.data:[])}catch(e){tx(e?.message||"讀取交易明細失敗")}finally{ty(!1)}let a=rG.current+1;rG.current=a;try{let t=String(e.county_code||"").toUpperCase()||(eJ[0]?f.WG[eJ[0]]:"");if(!t)throw Error("缺少縣市代碼");let r=Y.startDate,n=Y.endDate;if("custom"!==Y.dateRange&&(!r||!n)){let e=(0,b.P)(Y.dateRange);r=e.startDate||r,n=e.endDate||n}let l={countyCode:t,type:"預售交易",transactionType:"預售交易",projectNames:[String(e.project_name||"")],buildingType:Y.buildingType,excludeCommercial:Y.excludeCommercial,floorPremium:Y.floorPremium,dateRange:Y.dateRange,dateStart:r,dateEnd:n},i=await h.FH.analyzeProjectRanking(l);if(!i?.projectRanking||!i?.coreMetrics)throw Error(i?.message||"找不到可用的分析資料");rG.current===a&&tw(i)}catch(e){if(rG.current===a){let t=e?.message||"";tC((/401|unauthorized|認證|登入|token/i.test(t)?"分析報表需要登入權限，請先登入後再試。":null)||t||"讀取分析資料失敗")}}finally{rG.current===a&&tS(!1)}},[eJ,Y]),r8=(0,n.useCallback)(()=>{if(!td)return;let e=rH[String(td.county_code||"").toUpperCase()],t=tm[0]?.["行政區"],r=eV[0]||t||"";G({counties:e?[e]:[],districts:r?[r]:[],transactionType:"預售交易",projectNames:td.project_name?[td.project_name]:[],activeTab:"data-list"}),O.push("/dashboard")},[td,tm,eV,rH,G,O]),r6=(0,n.useCallback)((e,t)=>{e&&eY([e]),t?eq([t]):e&&eq([]),eX([]),eK([]),e5([]),eo(""),eu("project"),ep([]),e_(null),eS(null),ex([]),ev("idle"),ew(null),e9(null)},[]);(0,n.useEffect)(()=>{if(!X)return;if("address"!==ec){ep([]),eS(null),ef(!1),ex([]),ev("idle"),ew(null);return}if(0===eJ.length){ep([]),eS(null),ef(!1);return}let e=es.trim();if(e.length<2){ep([]),eS(null),ef(!1),ex([]),ev("idle"),ew(null);return}return t7.current&&window.clearTimeout(t7.current),t9.current&&t9.current.abort(),ef(!0),t7.current=window.setTimeout(async()=>{let t=new AbortController;t9.current=t;try{let r=F.current,a=r?r.getCenter():{lng:z[0],lat:z[1]},n=`https://api.maptiler.com/geocoding/${encodeURIComponent(e)}.json?key=${X}&language=zh&limit=6&proximity=${a.lng},${a.lat}`,l=await fetch(n,{signal:t.signal});if(!l.ok)throw Error(`Geocoding error ${l.status}`);let i=await l.json(),s=(Array.isArray(i?.features)?i.features:[]).filter(e=>{let t=r0(e);return t.county&&eJ.includes(t.county)});if(ep(s),s[0]?.center){let[e,t]=s[0].center;eS({lng:e,lat:t,label:s[0].text||s[0].place_name||"地址"})}else eS(null)}catch(e){if(e?.name==="AbortError")return;ep([])}finally{ef(!1)}},320),()=>{t7.current&&window.clearTimeout(t7.current),t9.current&&t9.current.abort()}},[es,X,eJ,r0,ec]);let r4=(0,n.useCallback)(e=>{e.length>6||(eY(e),eq(t=>t.filter(t=>e.some(e=>(f.Ib[e]||[]).includes(t)))),eX([]),eK([]),e5([]),eo(""),eu("project"),ep([]),e_(null),eS(null),ex([]),ev("idle"),ew(null),e9(null))},[]),r9=(0,n.useCallback)(e=>{eq(e),eX([]),eK([]),e5([]),e9(null)},[]),r7=(0,n.useCallback)(async e=>{let t=e.trim();if(0===eJ.length||t.length<2)return void eK([]);e0(!0),e2(null);try{let e=eJ.map(async e=>{let r=f.WG[e],a=eV.filter(t=>(f.Ib[e]||[]).includes(t));return h.FH.fetchProjectNameSuggestions(r,t,a).then(t=>{let r=[];return Array.isArray(t)?r=t:t&&t.data&&Array.isArray(t.data)?r=t.data:t&&t.names&&Array.isArray(t.names)&&(r=t.names),r.map(t=>{let r="string"==typeof t,a=r?t:t.name||t.建案名稱||String(t);return{label:a,value:a,group:e,details:r?void 0:{county:e,district:t.district||t.行政區,date:t.earliestDate||t.交易日}}})}).catch(t=>(console.error(`Failed to fetch projects for ${e}:`,t),[]))}),r=(await Promise.all(e)).flat(),a=Array.from(new Map(r.map(e=>[e.value,e])).values());eK(a)}catch(e){console.error("Project search error:",e),e2("搜尋失敗，請稍後再試")}finally{e0(!1)}},[eJ,eV]),ae=(0,n.useCallback)(e=>{ro.current&&clearTimeout(ro.current),ro.current=setTimeout(()=>{r7(e)},300)},[r7]),at=(0,n.useCallback)(e=>{eo(e),"address"===ec?(e2(null),eK([]),ae("")):ae(e)},[ae,ec]);(0,n.useEffect)(()=>()=>{ro.current&&clearTimeout(ro.current)},[]),(0,n.useEffect)(()=>{if(!eh)return;let e=e=>{ra.current&&!ra.current.contains(e.target)&&ey(!1)};return document.addEventListener("mousedown",e),()=>document.removeEventListener("mousedown",e)},[eh]);let ar=(0,n.useMemo)(()=>{let e=new Map,t=ed.map((t,r)=>{let a=t?.id?String(t.id):`${t?.center?.[0]}-${t?.center?.[1]}-${r}`,n=`addr:${a}`;e.set(n,t);let l=r0(t);return{label:t.text||t.place_name||"地址",value:n,group:"地址搜尋",details:l.county||l.district?{county:l.county,district:l.district}:void 0}});return re.current=e,t},[ed,r0]),aa=(0,n.useMemo)(()=>"address"===ec?Array.from(new Map([...ar,...eg].map(e=>[e.value,e])).values()):eH,[ar,eg,eH,ec]),an=(0,n.useCallback)(e=>{let t=e.filter(e=>e.startsWith("addr:")),r=e.filter(e=>!e.startsWith("addr:"));t.length>0&&t.forEach(e=>{let t=re.current.get(e);t&&r3(t)}),eX(r),0===r.length&&(e5([]),e9(null))},[r3]),al=(0,n.useCallback)(async()=>{if(0===eV.length||0===eJ.length){tr([]),to(null);return}ti(!0),to(null);try{let e=eJ.map(async e=>{let t=f.WG[e],r=eV.filter(t=>(f.Ib[e]||[]).includes(t));return r.length?h.FH.fetchProjectNameSuggestions(t,"",r).then(e=>{let t=[];return Array.isArray(e)?t=e:e&&e.data&&Array.isArray(e.data)?t=e.data:e&&e.names&&Array.isArray(e.names)&&(t=e.names),t.map(e=>"string"==typeof e?e:e.name||e.建案名稱||String(e)).filter(Boolean)}).catch(t=>(console.error(`Failed to fetch district projects for ${e}:`,t),[])):[]}),t=(await Promise.all(e)).flat(),r=Array.from(new Set(t));tr(r)}catch(e){console.error("District project list error:",e),to("行政區建案清單載入失敗"),tr([])}finally{ti(!1)}},[eJ,eV]);(0,n.useEffect)(()=>{al()},[al]);let ai=(0,n.useCallback)(async e=>{if(0!==e.length){e6(!0),e9(null);try{let{data:t}=await d.N.auth.getSession(),r=t?.session?.access_token;if(!r)throw Error("無效的授權金鑰");let a=eJ.length>0?eJ.map(e=>f.WG[e]).filter(Boolean).map(e=>e.toLowerCase()):"all",n=await fetch("https://zxbmbbfrzbtuueysicoc.supabase.co/functions/v1/map-projects",{method:"POST",headers:{"Content-Type":"application/json",Authorization:`Bearer ${r}`},body:JSON.stringify({countyCode:a,projectNames:e,limit:Math.max(200,20*e.length)})});if(!n.ok){let e=await n.json();throw Error(e.error||`HTTP Error: ${n.status}`)}let l=await n.json(),i=(Array.isArray(l?.projects)?l.projects:[]).map(e=>{let t=Number(e.latitude),r=Number(e.longitude);return Number.isFinite(t)&&Number.isFinite(r)?{lat:t,lng:r,name:e.project_name||"建案"}:null}).filter(Boolean);if(e5(i),0===i.length)return void e9("找不到建案座標");let o=F.current;if(o)if(1===i.length)o.flyTo({center:[i[0].lng,i[0].lat],zoom:Math.max(eU,16),speed:1.4});else{let e=new(s()).LngLatBounds;i.forEach(t=>e.extend([t.lng,t.lat])),o.fitBounds(e,{padding:80,maxZoom:Math.max(eU,16)})}}catch(e){console.error("Locate projects error:",e),e9(e.message||"定位失敗")}finally{e6(!1)}}},[eJ,eU]);(0,n.useEffect)(()=>{0!==eZ.length&&ai(eZ)},[eZ,ai]);let as=(0,n.useCallback)(()=>{let e=F.current;if(!e)return null;let t=e.getBounds(),r=e.getZoom(),a={south:t.getSouth(),west:t.getWest(),north:t.getNorth(),east:t.getEast()},n=e.getCenter(),l=Math.abs(a.north-a.south),i=Math.abs(a.east-a.west);return{bbox:a,zoom:r,maxSpanKm:Math.max(111*l,111*i*Math.cos(n.lat*Math.PI/180))}},[]),ao=(0,n.useCallback)((e,t)=>{let r=new Map;return e.forEach(e=>r.set(`${e.county_code}-${e.id}`,e)),t.forEach(e=>r.set(`${e.county_code}-${e.id}`,e)),Array.from(r.values())},[]),ac=(0,n.useCallback)(async({append:e=!1,cursor:t}={})=>{let r=as();if(!r)return;if(r.zoom<eU){e$("zoom"),eO(null),e||(eA([]),eI(null));return}if(eW>0&&r.maxSpanKm>eW){e$("range"),eO(null),e||(eA([]),eI(null));return}if(eV.length>0){if(tl)return void e$("loading");if(0===tt.length){eA([]),eI(null),e$("ready");return}}let a=[r.bbox.south.toFixed(5),r.bbox.west.toFixed(5),r.bbox.north.toFixed(5),r.bbox.east.toFixed(5),r.zoom,eU,eW].join("|");if(e){if(rc.current?.key&&rc.current.key!==a)return ac({append:!1})}else rc.current={key:a,bbox:r.bbox,zoom:r.zoom},eI(null);let n=ru.current+1;ru.current=n,eF(!0),eO(null),e$("loading");try{let{data:a}=await d.N.auth.getSession(),l=a?.session?.access_token;if(!l)throw Error("無效的授權金鑰");let i=eJ.length>0?eJ.map(e=>f.WG[e]).filter(Boolean).map(e=>e.toLowerCase()):"all",s=eV.length>0?tt:null,o=await fetch("https://zxbmbbfrzbtuueysicoc.supabase.co/functions/v1/map-projects",{method:"POST",headers:{"Content-Type":"application/json",Authorization:`Bearer ${l}`},body:JSON.stringify({countyCode:i,projectNames:s&&s.length>0?s:void 0,bbox:r.bbox,zoom:r.zoom,limit:800,cursor:e?t:null})});if(!o.ok){let e=await o.json();throw Error(e.error||`HTTP Error: ${o.status}`)}let c=await o.json();if(ru.current!==n)return;let u=Array.isArray(c?.projects)?c.projects:[];eA(t=>e?ao(t,u):u),eI(c?.nextCursor??null),e$("ready")}catch(e){if(ru.current!==n)return;console.error("Failed to fetch map projects:",e),eO(e.message||"載入建案資料失敗"),e$("error")}finally{ru.current===n&&eF(!1)}},[as,ao,eU,eW,eJ,eV,tt,tl]);(0,n.useEffect)(()=>{void 0!==t&&ac({append:!1})},[t,ac]),(0,n.useEffect)(()=>{ac({append:!1})},[eU,eW,eJ,eV,tt,ac]);let au=(0,n.useMemo)(()=>[{id:"zoning",label:"國土利用現況調查成果圖",tiles:"https://wmts.nlsc.gov.tw/wmts/LUIMAP/default/GoogleMapsCompatible/{z}/{y}/{x}"},{id:"cadastral",label:"段籍圖（地籍）",tiles:"https://wmts.nlsc.gov.tw/wmts/LANDSECT/default/GoogleMapsCompatible/{z}/{y}/{x}"}],[]),ad=(0,n.useMemo)(()=>{let e={id:"osm",label:"OSM 標準",supportsTheme:!1,style:{version:8,name:"OpenStreetMap Standard",glyphs:"https://fonts.openmaptiles.org/{fontstack}/{range}.pbf",sources:{"osm-tiles":{type:"raster",tiles:["https://tile.openstreetmap.org/{z}/{x}/{y}.png"],tileSize:256,attribution:"\xa9 OpenStreetMap contributors"}},layers:[{id:"osm-tiles",type:"raster",source:"osm-tiles",minzoom:0,maxzoom:19}]}},t={id:"dark",label:"黑底",supportsTheme:!1,style:{version:8,name:"Dark Matter",glyphs:"https://fonts.openmaptiles.org/{fontstack}/{range}.pbf",sources:{"carto-dark":{type:"raster",tiles:["https://basemaps.cartocdn.com/dark_all/{z}/{x}/{y}.png"],tileSize:256,attribution:"\xa9 OpenStreetMap contributors \xa9 CARTO"}},layers:[{id:"carto-dark",type:"raster",source:"carto-dark",minzoom:0,maxzoom:19}]}},r=X?[{id:"topo-v2",label:"地形",url:`https://api.maptiler.com/maps/topo-v2/style.json?key=${X}`,supportsTheme:!1}]:[];return X?[e,t,...r]:[e,t,{id:"demo",label:"開源預設",url:"https://demotiles.maplibre.org/style.json"}]},[X]),ap={dark:o.A,"topo-v2":c.A,osm:o.A,demo:o.A},am=(0,n.useCallback)(e=>{let t=e.getStyle();t?.layers&&t.layers.forEach(t=>{"symbol"!==t.type||t.layout?.["text-field"]&&e.setLayoutProperty(t.id,"text-field",["coalesce",["get","name:zh-Hant"],["get","name:zh"],["get","name"],["get","name:en"]])})},[]),af=(0,n.useCallback)(e=>{let t=!!e.getStyle()?.glyphs,r=e.getLayer("project-points-layer")?"project-points-layer":void 0;e.getSource("osm-levels")||e.addSource("osm-levels",{type:"geojson",data:{type:"FeatureCollection",features:[]}}),e.getSource("osm-buildings")||e.addSource("osm-buildings",{type:"geojson",data:{type:"FeatureCollection",features:[]}}),e.getLayer("osm-buildings-fill")||e.addLayer({id:"osm-buildings-fill",type:"fill",source:"osm-buildings",minzoom:16,layout:{visibility:"none"},paint:{"fill-color":"#38bdf8","fill-opacity":.08}},r),e.getLayer("osm-buildings-line")||e.addLayer({id:"osm-buildings-line",type:"line",source:"osm-buildings",minzoom:16,layout:{visibility:"none"},paint:{"line-color":"#22d3ee","line-width":1.1,"line-opacity":.6}},r),e.getLayer("osm-levels-points")||e.addLayer({id:"osm-levels-points",type:"circle",source:"osm-levels",minzoom:16,paint:{"circle-color":"#38bdf8","circle-radius":["interpolate",["linear"],["zoom"],16,2.2,18,3.6],"circle-opacity":.55,"circle-stroke-color":"#22d3ee","circle-stroke-width":1}},r),t&&!e.getLayer("osm-levels-label")&&e.addLayer({id:"osm-levels-label",type:"symbol",source:"osm-levels",minzoom:16,layout:{"text-field":["get","levelsLabel"],"text-size":11,"text-anchor":"center","text-allow-overlap":!0},paint:{"text-color":"#e2e8f0","text-halo-color":"#0b0d13","text-halo-width":1.1}},r)},[]),ah=(0,n.useCallback)((e,t)=>{let r=t?"visible":"none";e.getLayer("osm-buildings-fill")&&e.setLayoutProperty("osm-buildings-fill","visibility",r),e.getLayer("osm-buildings-line")&&e.setLayoutProperty("osm-buildings-line","visibility",r),e.getLayer("osm-levels-points")&&e.setLayoutProperty("osm-levels-points","visibility",r),e.getLayer("osm-levels-label")&&e.setLayoutProperty("osm-levels-label","visibility",r)},[]),ay=(0,n.useCallback)(e=>{e.getSource("search-point")||e.addSource("search-point",{type:"geojson",data:{type:"FeatureCollection",features:[]}}),e.getLayer("search-point-layer")||e.addLayer({id:"search-point-layer",type:"circle",source:"search-point",paint:{"circle-color":"#22d3ee","circle-radius":6,"circle-stroke-color":"#0ea5e9","circle-stroke-width":2,"circle-opacity":.9}})},[]),ag=(0,n.useCallback)(e=>{let t=!!e.getStyle()?.glyphs;e.getSource("project-distance")||e.addSource("project-distance",{type:"geojson",data:{type:"FeatureCollection",features:[]}}),e.getLayer("project-distance-line")||e.addLayer({id:"project-distance-line",type:"line",source:"project-distance",filter:["==","$type","LineString"],paint:{"line-color":"#f59e0b","line-width":2,"line-opacity":.85}}),t&&!e.getLayer("project-distance-label")&&e.addLayer({id:"project-distance-label",type:"symbol",source:"project-distance",filter:["==","$type","Point"],layout:{"text-field":["get","label"],"text-size":12,"text-anchor":"center","text-allow-overlap":!0},paint:{"text-color":"#fde68a","text-halo-color":"#111827","text-halo-width":1.2}})},[]),ax=(0,n.useCallback)(e=>{let t=e.getSource("project-distance");if(!t)return;let r=rf.current;if(!r)return void t.setData({type:"FeatureCollection",features:[]});let a=r.coordinates,n=Math.floor(a.length/2),l=a[n]||a[0];t.setData({type:"FeatureCollection",features:[{type:"Feature",properties:{label:r.label},geometry:{type:"LineString",coordinates:a}},{type:"Feature",properties:{label:r.label},geometry:{type:"Point",coordinates:l}}]})},[]),ab=(0,n.useCallback)(e=>{e.getSource("project-points")||e.addSource("project-points",{type:"geojson",data:{type:"FeatureCollection",features:[]}}),e.getLayer("project-points-layer")||e.addLayer({id:"project-points-layer",type:"circle",source:"project-points",paint:{"circle-color":["case",["boolean",["get","isSelected"],!1],"#f59e0b",["boolean",["get","filterActive"],!1],"#2dd4bf","#22d3ee"],"circle-radius":["case",["boolean",["get","isSelected"],!1],7,5],"circle-opacity":["case",["boolean",["get","dim"],!1],.35,.9],"circle-stroke-color":["case",["boolean",["get","isSelected"],!1],"#fcd34d",["boolean",["get","filterActive"],!1],"#99f6e4","#67e8f9"],"circle-stroke-width":["case",["boolean",["get","isSelected"],!1],2,1.2]}}),e.getSource("project-locate")||e.addSource("project-locate",{type:"geojson",data:{type:"FeatureCollection",features:[]}}),e.getLayer("project-locate-layer")||e.addLayer({id:"project-locate-layer",type:"circle",source:"project-locate",paint:{"circle-color":"#f59e0b","circle-radius":8,"circle-opacity":.85,"circle-stroke-color":"#fef3c7","circle-stroke-width":2}})},[]),av=(0,n.useCallback)(e=>{let t=e.getSource("project-points");if(t){let e=new Set(ry.current),r=ry.current.length>0,a=rg.current,n=rh.current.map(t=>{let n=Number(t.latitude),l=Number(t.longitude);if(!Number.isFinite(n)||!Number.isFinite(l))return null;let i=e.has(t.project_name);return{type:"Feature",properties:{id:t.id,project_name:t.project_name,county_code:t.county_code,developer:t.developer,contractor:t.contractor,architect:t.architect,sales_agent:t.sales_agent,affiliated_companies:t.affiliated_companies,construction_license:t.construction_license,total_households:t.total_households,community_unit_count:t.community_unit_count,total_floors:t.total_floors,basement_floors:t.basement_floors,structure:t.structure,public_ratio:t.public_ratio,site_area:t.site_area,land_use_zoning:t.land_use_zoning,land_plot_number:t.land_plot_number,parking_type:t.parking_type,parking_count:t.parking_count,enrichment_status:t.enrichment_status,isSelected:i,dim:r&&!i,filterActive:a},geometry:{type:"Point",coordinates:[l,n]}}}).filter(Boolean);t.setData({type:"FeatureCollection",features:n})}let r=e.getSource("project-locate");if(r){let e=rx.current.map(e=>({type:"Feature",properties:{name:e.name},geometry:{type:"Point",coordinates:[e.lng,e.lat]}}));r.setData({type:"FeatureCollection",features:e})}},[]),aj=(0,n.useCallback)(e=>{if(e.getSource("village-boundary")||e.addSource("village-boundary",{type:"geojson",data:{type:"FeatureCollection",features:[]}}),T&&!e.getSource("village-boundary-wmts")&&e.addSource("village-boundary-wmts",{type:"raster",tiles:[T],tileSize:256}),!e.getLayer("village-boundary-line")){let t=e.getLayer("project-points-layer")?"project-points-layer":void 0;e.addLayer({id:"village-boundary-line",type:"line",source:"village-boundary",layout:{visibility:"none"},minzoom:12,paint:{"line-color":["case",["boolean",["feature-state","hover"],!1],"#fbbf24","#f8fafc"],"line-width":["interpolate",["linear"],["zoom"],12,["case",["boolean",["feature-state","hover"],!1],2,.9],15,["case",["boolean",["feature-state","hover"],!1],3,1.6]],"line-opacity":rb.current.opacity}},t)}if(!e.getLayer("village-boundary-label")&&e.getStyle()?.glyphs){let t=e.getLayer("project-points-layer")?"project-points-layer":void 0;e.addLayer({id:"village-boundary-label",type:"symbol",source:"village-boundary",layout:{"text-field":["coalesce",["get","VILLNAME"],["get","villname"],["get","VILL"],["get","VILL_N"],["get","VillageName"],["get","name"]],"text-size":["interpolate",["linear"],["zoom"],12,10,15,12],"text-anchor":"center","text-allow-overlap":!1},paint:{"text-color":"#e2e8f0","text-halo-color":"#0b0d13","text-halo-width":1.2}},t)}if(T&&!e.getLayer("village-boundary-wmts-layer")){let t=e.getLayer("project-points-layer")?"project-points-layer":void 0;e.addLayer({id:"village-boundary-wmts-layer",type:"raster",source:"village-boundary-wmts",layout:{visibility:"none"},minzoom:12,paint:{"raster-opacity":rb.current.opacity}},t)}},[]),aw=(0,n.useCallback)(e=>{if(!e.getLayer("village-boundary-line"))return;let t=rb.current.visible,r=!!T&&t&&"error"===rM.current;e.setLayoutProperty("village-boundary-line","visibility",t?"visible":"none"),e.getLayer("village-boundary-label")&&e.setLayoutProperty("village-boundary-label","visibility",t?"visible":"none"),e.getLayer("village-boundary-wmts-layer")&&e.setLayoutProperty("village-boundary-wmts-layer","visibility",r?"visible":"none"),e.setPaintProperty("village-boundary-line","line-opacity",rb.current.opacity),e.getLayer("village-boundary-wmts-layer")&&e.setPaintProperty("village-boundary-wmts-layer","raster-opacity",rb.current.opacity)},[]),aN=(0,n.useCallback)((e,t)=>{e.getLayer("village-boundary-line")&&(e.setFilter("village-boundary-line",t??null),e.getLayer("village-boundary-label")&&e.setFilter("village-boundary-label",t??null))},[]),aS=(0,n.useCallback)(e=>{if(e.getSource("district-boundary")||e.addSource("district-boundary",{type:"geojson",data:{type:"FeatureCollection",features:[]}}),!e.getLayer("district-boundary-fill")){let t=e.getLayer("project-points-layer")?"project-points-layer":void 0;e.addLayer({id:"district-boundary-fill",type:"fill",source:"district-boundary",layout:{visibility:"none"},minzoom:8,paint:{"fill-color":"#38bdf8","fill-opacity":["case",["boolean",["feature-state","hover"],!1],Math.min(rv.current.opacity,.35),.01]}},t)}if(!e.getLayer("district-boundary-line")){let t=e.getLayer("project-points-layer")?"project-points-layer":void 0;e.addLayer({id:"district-boundary-line",type:"line",source:"district-boundary",layout:{visibility:"none"},minzoom:8,paint:{"line-color":"#67e8f9","line-width":["interpolate",["linear"],["zoom"],8,.8,12.5,1.6,15,2.2],"line-opacity":rv.current.opacity}},t)}},[]),ak=(0,n.useCallback)(e=>{if(!e.getLayer("district-boundary-line")||!e.getLayer("district-boundary-fill"))return;let t=rv.current.visible?"visible":"none";e.setLayoutProperty("district-boundary-line","visibility",t),e.setLayoutProperty("district-boundary-fill","visibility",t),e.setPaintProperty("district-boundary-line","line-opacity",rv.current.opacity),e.setPaintProperty("district-boundary-fill","fill-opacity",["case",["boolean",["feature-state","hover"],!1],Math.min(rv.current.opacity,.35),.01])},[]),aC=(0,n.useCallback)(async e=>{if(0===eJ.length){tY("idle"),tq(null),te("請先選縣市後才能載入行政區界線");return}te(null);let t=eJ.join(",");if(rL.current&&ta.current===t){let t=e.getSource("district-boundary");t&&t.setData(rL.current),tq(null),tY("ready");return}r_.current&&(window.clearTimeout(r_.current),r_.current=null),rC.current&&rC.current.abort();let r=new AbortController;rC.current=r;let a=++rA.current;tY("loading"),tq(null),r_.current=window.setTimeout(()=>{rC.current&&(rC.current.abort(),rC.current=null),rA.current===a&&(tY("error"),tq("行政區界線載入逾時"))},2e4);try{let n,l=eJ.join(","),i=q(E,l);try{n=await V(i,r.signal,6e3)}catch(t){let e=H(E);if(0===e.length)throw t;n=await V(e,r.signal,6e3)}if(rA.current!==a)return;let s=M(n,eJ),o=U(s,["TOWNCODE","TOWNID","id"]);rL.current=o,ta.current=t;let c=e.getSource("district-boundary");c&&c.setData(o),tY("ready")}catch(e){if(rA.current!==a)return;if(e?.name==="AbortError"){if(!rv.current.visible){tY("idle"),tq(null);return}tY("error"),tq("行政區界線載入逾時");return}tY("error"),tq("行政區界線載入失敗")}finally{rA.current===a&&r_.current&&(window.clearTimeout(r_.current),r_.current=null)}},[eJ]),az=(0,n.useCallback)(async e=>{if(0===eJ.length){tF("idle"),tO(null),te("請先選縣市後才能載入村里界線");return}if(0===eV.length){tF("idle"),tO(null);return}te(null);let t=eJ.join(",");if(rT.current&&tn.current===t){let t=e.getSource("village-boundary");t&&t.setData(rT.current),tF("ready");return}rE.current&&(window.clearTimeout(rE.current),rE.current=null),rz.current&&rz.current.abort();let r=new AbortController;rz.current=r;let a=++rR.current;tF("loading"),tO(null),rE.current=window.setTimeout(()=>{rz.current&&(rz.current.abort(),rz.current=null),rR.current===a&&(tF("error"),tO("村里界線載入逾時"))},2e4);try{let n,l=eJ.join(","),i=q(L,l);try{n=await V(i,r.signal,6e3)}catch(t){let e=H(L);if(0===e.length)throw t;n=await V(e,r.signal,6e3)}if(rR.current!==a)return;let s=M(n,eJ),o=U(s,["VILLCODE","VILLID","id"]);rT.current=o,tn.current=t;let c=e.getSource("village-boundary");c&&c.setData(o),tF("ready")}catch(e){if(rR.current!==a)return;if(e?.name==="AbortError"){if(!rb.current.visible){tF("idle"),tO(null);return}tF("error"),tO("村里界線載入逾時");return}tF("error"),tO("村里界線載入失敗")}finally{rR.current===a&&rE.current&&(window.clearTimeout(rE.current),rE.current=null)}},[eJ]),a_=(0,n.useCallback)(e=>{e.getSource("metro-lines")||e.addSource("metro-lines",{type:"geojson",data:{type:"FeatureCollection",features:[]}}),e.getLayer("metro-lines-layer")||e.addLayer({id:"metro-lines-layer",type:"line",source:"metro-lines",layout:{"line-join":"round","line-cap":"round",visibility:"none"},paint:{"line-color":"#f97316","line-width":["interpolate",["linear"],["zoom"],9,1.2,14,3.2],"line-opacity":rj.current.opacity}})},[]),aE=(0,n.useCallback)(e=>{e.getLayer("metro-lines-layer")&&(e.setLayoutProperty("metro-lines-layer","visibility",rj.current.visible?"visible":"none"),e.setPaintProperty("metro-lines-layer","line-opacity",rj.current.opacity))},[]),aL=(0,n.useCallback)(async e=>{let t=()=>{let t=e.getSource("osm-levels");t&&t.setData({type:"FeatureCollection",features:[]});let r=e.getSource("osm-buildings");r&&r.setData({type:"FeatureCollection",features:[]})};if(16>e.getZoom()){ei("zoom"),t();return}let r=e.getBounds(),a=Math.abs(r.getNorth()-r.getSouth()),n=Math.abs(r.getEast()-r.getWest());if(a>.12||n>.12){ei("zoom"),t();return}let l=`${r.getSouth()},${r.getWest()},${r.getNorth()},${r.getEast()}`;if(l===ri.current)return;ri.current=l,rn.current&&rn.current.abort();let i=new AbortController;rn.current=i,ei("loading");let s=`[out:json][timeout:25];
(
  way["building"](${l});
);
out geom;`,o=null;for(let e of["https://overpass-api.de/api/interpreter","https://overpass.kumi.systems/api/interpreter","https://overpass.nchc.org.tw/api/interpreter"])try{let t=await fetch(e,{method:"POST",body:s,signal:i.signal,headers:{"Content-Type":"text/plain"}});if(!t.ok)throw Error(`OSM fetch failed: ${t.status}`);o=await t.json();break}catch(e){if(e?.name==="AbortError")return;o=null}if(!o)return void ei("error");let c=[],u=[];(o?.elements||[]).filter(e=>"way"===e.type&&Array.isArray(e.geometry)).forEach(e=>{let t=e.geometry.map(e=>[e.lon,e.lat]).filter(([e,t])=>Number.isFinite(e)&&Number.isFinite(t));if(t.length<3)return;let r=t[0],a=t[t.length-1];a&&r[0]===a[0]&&r[1]===a[1]||t.push([...r]),c.push({type:"Feature",properties:{id:e.id},geometry:{type:"Polygon",coordinates:[t]}});let n=e.tags||{},l=Number.parseInt(n["building:levels"]||n.levels,10);if(!l)return;let i=(e=>{if(!e.length)return null;let t=0,r=0;return e.forEach(([e,a])=>{t+=e,r+=a}),[t/e.length,r/e.length]})(t);i&&u.push({type:"Feature",id:e.id,properties:{id:e.id,levels:l,levelsLabel:`${l}F`},geometry:{type:"Point",coordinates:i}})}),e.getSource("osm-levels").setData({type:"FeatureCollection",features:u});let d=e.getSource("osm-buildings");d&&d.setData({type:"FeatureCollection",features:c}),ei("ready")},[]),aT=(0,n.useCallback)(async e=>{if(A){if(rk.current)return void t0("ready");rw.current&&rw.current.abort();let t=new AbortController;rw.current=t,t0("loading"),t2(null);try{let r=await fetch(A,{signal:t.signal});if(!r.ok)throw Error(`Metro GeoJSON fetch failed: ${r.status}`);let a=await r.json(),n=e.getSource("metro-lines");a?.type==="FeatureCollection"?n.setData(a):n.setData({type:"FeatureCollection",features:[]}),rk.current=!0,t0("ready")}catch(e){if(e?.name==="AbortError")return;t0("error"),t2("捷運路線載入失敗")}return}if(10>e.getZoom())return void t0("zoom");let t=e.getBounds(),r=`${t.getSouth()},${t.getWest()},${t.getNorth()},${t.getEast()}`;if(r===rS.current)return;rS.current=r,rw.current&&rw.current.abort();let a=new AbortController;rw.current=a,t0("loading"),t2(null);let n=`[out:json][timeout:25];
(
  way["railway"="subway"](${r});
  way["railway"="light_rail"](${r});
);
out geom;`,l=null;for(let e of R)try{let t=await fetch(e,{method:"POST",body:n,signal:a.signal,headers:{"Content-Type":"text/plain"}});if(!t.ok)throw Error(`Metro fetch failed: ${t.status}`);l=await t.json();break}catch(e){if(e?.name==="AbortError")return;l=null}if(!l){t0("error"),t2("捷運路線載入失敗");return}let i=(l?.elements||[]).filter(e=>"way"===e.type&&Array.isArray(e.geometry)).map(e=>{let t=(e.geometry||[]).map(e=>[e.lon,e.lat]);return t.length<2?null:{type:"Feature",properties:{id:e.id,name:e.tags?.name||"",ref:e.tags?.ref||""},geometry:{type:"LineString",coordinates:t}}}).filter(Boolean);e.getSource("metro-lines").setData({type:"FeatureCollection",features:i}),t0("ready")},[]),aA=(0,n.useCallback)(e=>{if(!t5.current)return;let t=e.getStyle();if(!t?.layers)return;let r=t.layers.find(e=>"symbol"===e.type&&e.layout?.["text-field"])?.id,a=e.getSource("openmaptiles")?"openmaptiles":e.getSource("maptiler")?"maptiler":null;!a||e.getLayer("3d-buildings")||e.addLayer({id:"3d-buildings",source:a,"source-layer":"building",type:"fill-extrusion",minzoom:15,paint:{"fill-extrusion-color":["interpolate",["linear"],["coalesce",["get","render_height"],["get","height"],6],0,"#1f2937",20,"#334155",50,"#38bdf8",100,"#f97316",200,"#ef4444"],"fill-extrusion-height":["coalesce",["get","render_height"],["get","height"],6],"fill-extrusion-base":["coalesce",["get","render_min_height"],["get","min_height"],0],"fill-extrusion-opacity":.85}},r)},[]);(0,n.useEffect)(()=>{if(!_.current||F.current)return;let e=ad.find(e=>e.id===Q),t=e?.url??e?.style??"https://demotiles.maplibre.org/style.json",r=new(s()).Map({container:_.current,style:t,center:z,zoom:14,pitch:45,bearing:-15,antialias:!0,attributionControl:!1});r.addControl(new(s()).NavigationControl({showCompass:!0}),"top-right"),r.addControl(new(s()).AttributionControl({compact:!0}),"bottom-left"),r.on("style.load",()=>{if(aA(r),au.forEach(e=>{if(!e.tiles)return;let t=`gov-${e.id}`,a=`gov-${e.id}-layer`;r.getSource(t)||r.addSource(t,{type:"raster",tiles:[e.tiles],tileSize:256}),r.getLayer(a)||r.addLayer({id:a,type:"raster",source:t,layout:{visibility:"none"},paint:{"raster-opacity":t3.current[e.id]?.opacity??.6}})}),au.forEach(e=>{if(!e.tiles)return;let t=`gov-${e.id}-layer`;if(!r.getLayer(t))return;let a=t3.current[e.id];a&&(r.setLayoutProperty(t,"visibility",a.visible?"visible":"none"),r.setPaintProperty(t,"raster-opacity",a.opacity))}),ay(r),af(r),ah(r,t6.current),ab(r),ag(r),av(r),ax(r),aj(r),aw(r),aN(r,rb.current.visible?rO.current:null),aS(r),ak(r),a_(r),aE(r),rv.current.visible&&aC(r),rb.current.visible&&az(r),rj.current.visible&&(rS.current=null,rk.current=!1,aT(r)),t6.current&&aL(r),t4.current){let e=r.getSource("search-point");e&&e.setData({type:"FeatureCollection",features:[{type:"Feature",properties:{},geometry:{type:"Point",coordinates:t4.current}}]})}am(r),rs.current||(rs.current=!0,Z(!0))}),F.current=r;let a=new ResizeObserver(()=>r.resize());return a.observe(_.current),()=>{a.disconnect(),r.remove(),F.current=null}},[]),(0,n.useEffect)(()=>{t5.current=et,t6.current=ea,t4.current=ez,t3.current=eE;let e=F.current;if(e&&(au.forEach(t=>{if(!t.tiles)return;let r=`gov-${t.id}-layer`;if(!e.getLayer(r))return;let a=eE[t.id];a&&(e.setLayoutProperty(r,"visibility",a.visible?"visible":"none"),e.setPaintProperty(r,"raster-opacity",a.opacity))}),ez)){let t=e.getSource("search-point");t&&t.setData({type:"FeatureCollection",features:[{type:"Feature",properties:{},geometry:{type:"Point",coordinates:ez}}]})}},[eE,au,ez,ea,et]),(0,n.useEffect)(()=>{let e=F.current;e&&K&&(aj(e),rM.current=tR,aw(e),aS(e),ak(e),a_(e),aE(e))},[K,tE,tT,tR,tU,tW,tH,tZ,aj,aw,aS,ak,a_,aE]),(0,n.useEffect)(()=>{let e=F.current;if(e&&K){if(!tU){rC.current&&(rC.current.abort(),rC.current=null),r_.current&&(window.clearTimeout(r_.current),r_.current=null),null!==rF.current&&(e.setFeatureState({source:"district-boundary",id:rF.current},{hover:!1}),rF.current=null),tq(null),tY("idle");return}aC(e)}},[tU,K,aC]),(0,n.useEffect)(()=>{let e=F.current;if(e&&K){if(!tE){rz.current&&(rz.current.abort(),rz.current=null),rE.current&&(window.clearTimeout(rE.current),rE.current=null),tO(null),tF("idle");return}az(e)}},[tE,K,az]),(0,n.useEffect)(()=>{(tU||tE)&&eJ.length>0&&te(null)},[eJ,tU,tE]),(0,n.useEffect)(()=>{tE&&(0===eJ.length?tI(null):tI(J(eJ.flatMap(e=>W(e)),eV.flatMap(e=>W(e)))))},[eJ,eV,tE]),(0,n.useEffect)(()=>{tE&&eJ.length>0&&0===eV.length?t$("請點選行政區以顯示鄰里界線"):t$(null)},[tE,eJ,eV]),(0,n.useEffect)(()=>{!(eJ.length>0)&&(tU&&tB(!1),tE&&tL(!1))},[eJ,tU,tE]),(0,n.useEffect)(()=>{!tU&&tE&&tL(!1)},[tU,tE]),(0,n.useEffect)(()=>{if(!tE)return;let e=F.current;if(!e||!K)return;if(eV.length>0)return void az(e);let t=e.getSource("village-boundary");t&&t.setData({type:"FeatureCollection",features:[]}),tF("idle"),tO(null)},[eV,tE,K,az]),(0,n.useEffect)(()=>{let e=F.current;if(e&&K){if(!tE)return void aN(e,null);aN(e,tD)}},[tE,tD,K,aN]),(0,n.useEffect)(()=>{let e=F.current;if(e){if(!et){e.getLayer("3d-buildings")&&e.removeLayer("3d-buildings"),e.easeTo({pitch:0,bearing:0,duration:450});return}aA(e),e.easeTo({pitch:45,bearing:-15,duration:450})}},[et,aA]),(0,n.useEffect)(()=>{let e=F.current;if(!e)return;let t=ad.find(e=>e.id===Q);if(!t)return;let r=t.url??t.style;r&&e.setStyle(r,{diff:!1})},[Q,ad]),(0,n.useEffect)(()=>{let e=F.current;if(e&&K){if(t8.current!==Q){let t=ad.find(e=>e.id===Q),r=t?.url??t?.style;r&&e.setStyle(r,{diff:!1})}t8.current=Q}},[Q,K,ad]),(0,n.useEffect)(()=>{let e=F.current;e&&K&&am(e)},[K,am]),(0,n.useEffect)(()=>{let e=F.current;e&&K&&eC(e.getZoom())},[K]),(0,n.useEffect)(()=>{tb>rK&&tv(1)},[tb,rK]);let aR=(0,n.useCallback)(async e=>{if(!e||0===eJ.length){ex([]),ev("idle");return}rt.current&&rt.current.abort();let t=new AbortController;rt.current=t,ev("loading"),ew(null);try{let r=[{label:"鄰近 0.5km",maxKm:.5},{label:"鄰近 0.75km",maxKm:.75},{label:"鄰近 1km",maxKm:1}],a=r[r.length-1].maxKm,n=a/111,l=a/(111*Math.cos(e.lat*Math.PI/180)),i={south:e.lat-n,north:e.lat+n,west:e.lng-l,east:e.lng+l},{data:s}=await d.N.auth.getSession(),o=s?.session?.access_token;if(!o)throw Error("無效的授權金鑰");let c=eJ.map(e=>f.WG[e]).filter(Boolean).map(e=>e.toLowerCase()),u=await fetch("https://zxbmbbfrzbtuueysicoc.supabase.co/functions/v1/map-projects",{method:"POST",headers:{"Content-Type":"application/json",Authorization:`Bearer ${o}`},body:JSON.stringify({countyCode:c.length>0?c:"all",bbox:i,zoom:16,limit:800}),signal:t.signal});if(!u.ok){let e=await u.json();throw Error(e.error||`HTTP Error: ${u.status}`)}let p=await u.json(),m=Array.isArray(p?.projects)?p.projects:[],h=[],y=new Set;m.forEach(t=>{let a=Number(t.latitude),n=Number(t.longitude);if(!Number.isFinite(a)||!Number.isFinite(n))return;let l=P([n,a],[e.lng,e.lat]),i=r.find(e=>l<=e.maxKm);if(!i)return;let s=t.project_name||"建案",o=`${i.label}-${s}`;y.has(o)||(y.add(o),h.push({label:s,value:s,group:i.label}))});let g=new Map(r.map((e,t)=>[e.label,t]));h.sort((e,t)=>{let r=g.get(e.group||"")??99,a=g.get(t.group||"")??99;return r!==a?r-a:e.label.localeCompare(t.label)}),ex(h),ev("ready")}catch(e){if(e?.name==="AbortError")return;ex([]),ev("error"),ew(e?.message||"鄰近建案載入失敗")}},[eJ]);(0,n.useEffect)(()=>{if(!eN||0===eJ.length){ex([]),ev("idle"),ew(null);return}return rr.current&&window.clearTimeout(rr.current),rr.current=window.setTimeout(()=>{aR(eN)},280),()=>{rr.current&&window.clearTimeout(rr.current),rt.current&&rt.current.abort()}},[eN,eJ,aR]),(0,n.useEffect)(()=>{let e=F.current;if(!e||!K)return;af(e),ah(e,ea),ea?aL(e):ei("idle");let t=()=>{eC(e.getZoom()),t6.current&&(rl.current&&window.clearTimeout(rl.current),rl.current=window.setTimeout(()=>{aL(e)},400)),rj.current.visible&&(rN.current&&window.clearTimeout(rN.current),rN.current=window.setTimeout(()=>{aT(e)},450)),rd.current&&window.clearTimeout(rd.current),rd.current=window.setTimeout(()=>{ac({append:!1})},250)};return e.on("moveend",t),()=>{e.off("moveend",t),rl.current&&window.clearTimeout(rl.current),rN.current&&window.clearTimeout(rN.current),rd.current&&window.clearTimeout(rd.current)}},[K,ea,af,ah,aL,aT,ac]),(0,n.useEffect)(()=>{let e=F.current;e&&K&&(a_(e),aE(e),tH?aT(e):(rw.current&&(rw.current.abort(),rw.current=null),rk.current=!1,rS.current=null,t0("idle"),t2(null)))},[K,tH,tZ,a_,aE,aT]),(0,n.useEffect)(()=>{K&&ac({append:!1})},[K,ac]),(0,n.useEffect)(()=>{rh.current=eT,ry.current=eZ,rg.current=eJ.length>0||eV.length>0,rx.current=e3,rb.current={visible:tE,opacity:tT},rv.current={visible:tU,opacity:tW},rj.current={visible:tH,opacity:tZ},rM.current=tR,rO.current=tD;let e=F.current;e&&(av(e),ax(e),aw(e),ak(e),aE(e))},[eT,eZ,eJ,eV,e3,tE,tT,tD,tU,tW,tH,tZ,av,aw,ak,aE]);let aF=(0,n.useCallback)(async e=>{if(2!==e.length){rf.current=null;let e=F.current;e&&ax(e);return}try{let[t,r]=e,a=`https://router.project-osrm.org/route/v1/driving/${t.lng},${t.lat};${r.lng},${r.lat}?overview=full&geometries=geojson`,n=await fetch(a);if(!n.ok)throw Error(`OSRM ${n.status}`);let l=await n.json(),i=l?.routes?.[0],s=i?.geometry?.coordinates;if(!s||s.length<2)throw Error("Route geometry missing");let o=i?.distance?i.distance/1e3:P([t.lng,t.lat],[r.lng,r.lat]);rf.current={coordinates:s,label:`${o.toFixed(2)} km`}}catch{let[t,r]=e,a=P([t.lng,t.lat],[r.lng,r.lat]);rf.current={coordinates:[[t.lng,t.lat],[r.lng,r.lat]],label:`${a.toFixed(2)} km`}}let t=F.current;t&&ax(t)},[ax]);return(0,n.useEffect)(()=>{if(2!==e3.length){rf.current=null;let e=F.current;e&&ax(e);return}aF(e3)},[e3,aF,ax]),(0,n.useEffect)(()=>{let e=F.current;if(!e||!K)return;let t=t=>{let r=e.queryRenderedFeatures(t.point,{layers:["project-points-layer"]}),a=r?.[0];if(!a||"Point"!==a.geometry.type)return;let n=a.properties||{},l=a.geometry.coordinates;r5({...n,longitude:l?.[0],latitude:l?.[1]})},r=t=>{let r=t.features?.[0];if(!r||"Point"!==r.geometry.type)return;let a=$(r.properties?.project_name||"建案"),n=r.geometry.coordinates;rp.current||(rp.current=new(s()).Popup({closeButton:!1,closeOnClick:!1,className:"sqm-map-tooltip",offset:12})),rm.current!==a&&(rp.current.setHTML(`<div class="text-[11px] font-medium">${a}</div>`),rm.current=a),rp.current.setLngLat(n).addTo(e),e.getCanvas().style.cursor="pointer"},a=()=>{e.getCanvas().style.cursor="",rm.current=null,rp.current&&(rp.current.remove(),rp.current=null)};return e.on("click",t),e.on("mousemove","project-points-layer",r),e.on("mouseleave","project-points-layer",a),()=>{e.off("click",t),e.off("mousemove","project-points-layer",r),e.off("mouseleave","project-points-layer",a),rp.current&&(rp.current.remove(),rp.current=null)}},[K,r5]),(0,n.useEffect)(()=>{let e=F.current;if(!e||!K||!tU)return;let t=t=>{let r=t.features?.[0];if(!r)return;let a=r.id;if(null==a)return;null!==rF.current&&rF.current!==a&&e.setFeatureState({source:"district-boundary",id:rF.current},{hover:!1}),rF.current=a,e.setFeatureState({source:"district-boundary",id:a},{hover:!0});let n=r1(r.properties),l=n.district||String(n.districtRaw||"").trim()||"行政區",i=n.county||String(n.countyRaw||"").trim();r$.current||(r$.current=new(s()).Popup({closeButton:!1,closeOnClick:!1,className:"sqm-map-tooltip",offset:10}));let o=i||"",c=`
        <div style="font-size:12px;font-weight:600;">${$(l)}</div>
        ${o?`<div style="font-size:10px;color:#94a3b8;margin-top:2px;">${$(o)}</div>`:""}
      `;r$.current.setLngLat(t.lngLat).setHTML(c).addTo(e),e.getCanvas().style.cursor="pointer"},r=()=>{null!==rF.current&&(e.setFeatureState({source:"district-boundary",id:rF.current},{hover:!1}),rF.current=null),e.getCanvas().style.cursor="",r$.current&&(r$.current.remove(),r$.current=null)},a=t=>{let r=t.features?.[0];if(!r)return;let a=r1(r.properties);a.county&&(eY([a.county]),a.district?eq([a.district]):eq([]));let n=B(r);n&&e.fitBounds([[n.minLng,n.minLat],[n.maxLng,n.maxLat]],{padding:48,duration:600}),r$.current&&(r$.current.remove(),r$.current=null),rD.current||(rD.current=new(s()).Popup({closeButton:!1,closeOnClick:!1,className:"sqm-map-tooltip",offset:10}));let l=a.district||String(a.districtRaw||"").trim()||"行政區",i=a.county||String(a.countyRaw||"").trim(),o=a.district||String(a.districtRaw||"").trim(),c=a.county||String(a.countyRaw||"").trim(),u=document.createElement("div"),d=document.createElement("div");if(d.style.fontSize="12px",d.style.fontWeight="600",d.textContent=l,u.appendChild(d),i){let e=document.createElement("div");e.style.fontSize="10px",e.style.color="#94a3b8",e.style.marginTop="2px",e.textContent=i,u.appendChild(e)}if(tE&&o){c&&eY([c]),eq([o]),tI(J(W(c),W(o))),az(e);let t=B(r),a=()=>{12>e.getZoom()&&e.easeTo({zoom:12,duration:450})};t?(e.fitBounds([[t.minLng,t.minLat],[t.maxLng,t.maxLat]],{padding:48,duration:600}),e.once("moveend",a)):a()}u.addEventListener("click",e=>{e.stopPropagation()}),rI.current=!0,rD.current.setLngLat(t.lngLat).setDOMContent(u).addTo(e)},n=t=>{let r=["district-boundary-fill","district-boundary-line","project-points-layer","village-boundary-line"].filter(t=>e.getLayer(t));e.queryRenderedFeatures(t.point,{layers:r}).length>0||(rD.current&&(rD.current.remove(),rD.current=null),rI.current=!1)};return e.on("mousemove","district-boundary-fill",t),e.on("mouseleave","district-boundary-fill",r),e.on("click","district-boundary-fill",a),e.on("click","district-boundary-line",a),e.on("click",n),()=>{e.off("mousemove","district-boundary-fill",t),e.off("mouseleave","district-boundary-fill",r),e.off("click","district-boundary-fill",a),e.off("click","district-boundary-line",a),e.off("click",n),null!==rF.current&&(e.setFeatureState({source:"district-boundary",id:rF.current},{hover:!1}),rF.current=null),r$.current&&(r$.current.remove(),r$.current=null),rD.current&&(rD.current.remove(),rD.current=null),rI.current=!1,e.getCanvas().style.cursor=""}},[tU,K,r1,az]),(0,n.useEffect)(()=>{let e=F.current;if(!e||!K||!tE)return;let t=t=>{let r=t.features?.[0];if(!r)return;let a=r.id;if(null==a)return;null!==rP.current&&rP.current!==a&&e.setFeatureState({source:"village-boundary",id:rP.current},{hover:!1}),rP.current=a,e.setFeatureState({source:"village-boundary",id:a},{hover:!0});let n=r2(r.properties),l=String(n.villageRaw||"").trim()||"里",i=n.district||String(n.districtRaw||"").trim(),o=n.county||String(n.countyRaw||"").trim();rU.current||(rU.current=new(s()).Popup({closeButton:!1,closeOnClick:!1,className:"sqm-map-tooltip",offset:10}));let c=[i,o].filter(Boolean).join(" \xb7 "),u=`
        <div style="font-size:12px;font-weight:600;">${$(l)}</div>
        ${c?`<div style="font-size:10px;color:#94a3b8;margin-top:2px;">${$(c)}</div>`:""}
      `;rU.current.setLngLat(t.lngLat).setHTML(u).addTo(e),e.getCanvas().style.cursor="pointer"},r=()=>{null!==rP.current&&(e.setFeatureState({source:"village-boundary",id:rP.current},{hover:!1}),rP.current=null),rU.current&&(rU.current.remove(),rU.current=null),e.getCanvas().style.cursor=""};return e.on("mousemove","village-boundary-line",t),e.on("mouseleave","village-boundary-line",r),()=>{e.off("mousemove","village-boundary-line",t),e.off("mouseleave","village-boundary-line",r),null!==rP.current&&(e.setFeatureState({source:"village-boundary",id:rP.current},{hover:!1}),rP.current=null),rU.current&&(rU.current.remove(),rU.current=null),e.getCanvas().style.cursor=""}},[tE,K,r2]),(0,n.useEffect)(()=>{let e=F.current;if(!e||!K||!ea)return;let t=t=>{let r=t.features?.[0];if(!r)return;let a=r.id??r.properties?.id;null!=a&&(null!==rW.current&&rW.current!==a&&(rW.current=null),rW.current=a);let n=r.properties?.levels,l=n?`${n}F`:"樓層";rB.current||(rB.current=new(s()).Popup({closeButton:!1,closeOnClick:!1,className:"sqm-map-tooltip",offset:10})),rB.current.setLngLat(t.lngLat).setHTML(`<div class="text-[11px] font-medium">${l}</div>`).addTo(e),e.getCanvas().style.cursor="pointer"},r=()=>{rW.current=null,rB.current&&(rB.current.remove(),rB.current=null),e.getCanvas().style.cursor=""};return e.on("mousemove","osm-levels-points",t),e.on("mouseleave","osm-levels-points",r),()=>{e.off("mousemove","osm-levels-points",t),e.off("mouseleave","osm-levels-points",r),rB.current&&(rB.current.remove(),rB.current=null),rW.current=null,e.getCanvas().style.cursor=""}},[K,ea]),(0,a.jsxs)("div",{className:"flex flex-col w-full h-full gap-2",children:[!l&&(0,a.jsx)("div",{className:"flex flex-col gap-3 bg-zinc-900/90 backdrop-blur-md p-3 rounded-xl border border-white/10 shadow-lg flex-shrink-0 z-10 relative",children:(0,a.jsxs)("div",{className:"flex flex-wrap items-center gap-4",children:[(0,a.jsx)("div",{className:"w-32",children:(0,a.jsx)(p.K,{options:rY,value:eJ,onChange:r4,placeholder:"選擇縣市..."})}),(0,a.jsx)("div",{className:"w-32",children:(0,a.jsx)(p.K,{options:rV,value:eV,onChange:r9,placeholder:eJ.length>0?"選擇行政區...":"請先選縣市",disabled:0===eJ.length})}),(0,a.jsx)("div",{className:"flex-1 min-w-[260px]",children:(0,a.jsx)(p.K,{options:aa,value:eZ,onChange:an,placeholder:eJ.length>0?"address"===ec?"輸入地址...":"輸入建案名稱...":"請先選縣市",onSearch:at,loading:eQ||em||"loading"===eb,disabled:0===eJ.length})}),(0,a.jsx)("button",{type:"button",onClick:()=>{let e="address"===ec?"project":"address";eu(e),eo(""),eX([]),e5([]),"address"===e?(eK([]),e2(null)):(ep([]),ex([]),ev("idle"),ew(null))},className:"rounded-md border border-white/10 px-2.5 py-1 text-[11px] text-zinc-300 hover:border-white/30 hover:text-zinc-100",disabled:0===eJ.length,children:"address"===ec?"切換建案":"切換地址"}),(0,a.jsxs)("div",{className:"flex items-center gap-4 border-l border-white/10 pl-4",children:[(0,a.jsxs)("div",{className:"flex items-center gap-2",children:[(0,a.jsx)("span",{className:"text-[11px] text-zinc-300 whitespace-nowrap",children:"行政區界線"}),(0,a.jsxs)("label",{className:`relative inline-flex items-center cursor-pointer ${0===eJ.length?"opacity-50 cursor-not-allowed":""}`,children:[(0,a.jsx)("input",{type:"checkbox",checked:tU,onChange:e=>{0===eJ.length?te("請先選縣市後才能載入行政區界線"):tB(e.target.checked)},disabled:0===eJ.length,className:"sr-only peer"}),(0,a.jsx)("div",{className:"w-8 h-4 bg-zinc-700 peer-focus:outline-none rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-3 after:w-3 after:transition-all peer-checked:bg-cyan-600 peer-disabled:cursor-not-allowed peer-disabled:opacity-60"})]}),tU&&(0,a.jsx)("input",{type:"range",min:.2,max:1,step:.05,value:tW,onChange:e=>tG(parseFloat(e.target.value)),className:"w-16 h-1 ml-1"})]}),(0,a.jsxs)("div",{className:"flex items-center gap-2",children:[(0,a.jsx)("span",{className:"text-[11px] text-zinc-300 whitespace-nowrap",children:"鄰里界線"}),(0,a.jsxs)("label",{className:`relative inline-flex items-center cursor-pointer ${0===eJ.length||!tU?"opacity-50 cursor-not-allowed":""}`,children:[(0,a.jsx)("input",{type:"checkbox",checked:tE,onChange:e=>{0===eJ.length?te("請先選縣市後才能載入鄰里界線"):tU?tL(e.target.checked):te("請先開啟行政區界線")},disabled:0===eJ.length||!tU,className:"sr-only peer"}),(0,a.jsx)("div",{className:"w-8 h-4 bg-zinc-700 peer-focus:outline-none rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-3 after:w-3 after:transition-all peer-checked:bg-cyan-600 peer-disabled:cursor-not-allowed peer-disabled:opacity-60"})]}),tE&&(0,a.jsx)("input",{type:"range",min:.2,max:1,step:.05,value:tT,onChange:e=>tA(parseFloat(e.target.value)),className:"w-16 h-1 ml-1"})]}),(0,a.jsxs)("div",{className:"flex items-center gap-2",children:[(0,a.jsx)("span",{className:"text-[11px] text-zinc-300 whitespace-nowrap",children:"捷運路線"}),(0,a.jsxs)("label",{className:"relative inline-flex items-center cursor-pointer",children:[(0,a.jsx)("input",{type:"checkbox",checked:tH,onChange:e=>tK(e.target.checked),className:"sr-only peer"}),(0,a.jsx)("div",{className:"w-8 h-4 bg-zinc-700 peer-focus:outline-none rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-3 after:w-3 after:transition-all peer-checked:bg-cyan-600"})]}),tH&&(0,a.jsx)("input",{type:"range",min:.2,max:1,step:.05,value:tZ,onChange:e=>tX(parseFloat(e.target.value)),className:"w-16 h-1 ml-1"})]})]}),(0,a.jsxs)("div",{className:"flex items-center gap-3 border-l border-white/10 pl-4",children:[(0,a.jsxs)("label",{className:"flex items-center gap-2 text-[11px] text-zinc-300 whitespace-nowrap cursor-pointer",children:[(0,a.jsx)("input",{type:"checkbox",checked:ea,onChange:e=>en(e.target.checked),className:"h-3.5 w-3.5 accent-cyan-500 rounded border-zinc-700"}),"OSM 樓層"]}),(0,a.jsxs)("label",{className:"flex items-center gap-2 text-[11px] text-zinc-300 whitespace-nowrap cursor-pointer",children:[(0,a.jsx)("input",{type:"checkbox",checked:et,onChange:e=>er(e.target.checked),className:"h-3.5 w-3.5 accent-cyan-500 rounded border-zinc-700"}),"3D 建物"]})]}),(0,a.jsx)("div",{className:"flex items-center gap-1 border-l border-white/10 pl-4",children:ad.map(e=>{let t=ap[e.id]||o.A,r=Q===e.id;return(0,a.jsx)("button",{onClick:()=>ee(e.id),title:e.label,"aria-label":e.label,className:`h-7 w-7 flex items-center justify-center rounded-md border transition-all ${r?"bg-cyan-500/20 border-cyan-500 text-cyan-200":"bg-zinc-800/60 border-white/10 text-zinc-400 hover:border-white/30"}`,children:(0,a.jsx)(t,{className:"h-3.5 w-3.5"})},e.id)})}),(0,a.jsxs)("div",{className:"flex flex-wrap items-center gap-3 ml-auto",children:[(0,a.jsxs)("div",{className:"flex flex-wrap items-center gap-3 text-[10px] text-zinc-500",children:[e1&&(0,a.jsx)("span",{className:"text-rose-300",children:e1}),ts&&(0,a.jsx)("span",{className:"text-rose-300",children:ts}),e4&&(0,a.jsx)("span",{className:"text-rose-300",children:e4}),e7&&(0,a.jsx)("span",{className:"text-amber-300",children:e7}),tP&&(0,a.jsx)("span",{className:"text-amber-300",children:tP}),tU&&"error"===tJ&&tV&&(0,a.jsx)("span",{className:"text-rose-300",children:tV}),tE&&"error"===tR&&tM&&(0,a.jsx)("span",{className:"text-rose-300",children:tM}),"address"===ec&&em&&(0,a.jsx)("span",{className:"text-cyan-300",children:"地址搜尋中..."}),"address"===ec&&"loading"===eb&&(0,a.jsx)("span",{className:"text-cyan-300",children:"鄰近建案載入中..."}),ej&&(0,a.jsx)("span",{className:"text-rose-300",children:ej}),t1&&(0,a.jsx)("span",{className:"text-rose-300",children:t1}),e8&&(0,a.jsx)("span",{className:"text-cyan-300",children:"定位中..."}),tl&&(0,a.jsxs)("span",{className:"text-cyan-300 flex items-center gap-1",children:[(0,a.jsx)(u.A,{className:"h-2.5 w-2.5 animate-spin"})," 讀取行政區清單"]}),"zoom"===eP&&(0,a.jsxs)("span",{className:"text-amber-300",children:["請放大至 z",eU,"+"]}),"range"===eP&&(0,a.jsxs)("span",{className:"text-amber-300",children:["範圍內縮至 ",eW,"km"]}),tU&&"loading"===tJ&&(0,a.jsx)("span",{className:"text-cyan-300",children:"載入行政區界線..."}),tE&&"loading"===tR&&(0,a.jsx)("span",{className:"text-cyan-300",children:"載入村里界線..."}),tE&&ek>0&&ek<12&&(0,a.jsx)("span",{className:"text-amber-300",children:"村里界線需放大至 z12+"}),tH&&"zoom"===tQ&&(0,a.jsx)("span",{className:"text-amber-300",children:"捷運路線需放大至 z10+"}),"loading"===eP&&(0,a.jsxs)("span",{className:"text-cyan-300 flex items-center gap-1",children:[(0,a.jsx)(u.A,{className:"h-2.5 w-2.5 animate-spin"})," 建案載入中"]}),"error"===eP&&(0,a.jsx)("span",{className:"text-rose-300",children:"建案載入失敗"}),ea&&"loading"===el&&(0,a.jsx)("span",{className:"text-cyan-300",children:"載入 OSM 建物中"}),ea&&"zoom"===el&&(0,a.jsx)("span",{children:"OSM 建物需放大至 16+"}),ea&&"error"===el&&(0,a.jsx)("span",{className:"text-rose-300",children:"OSM 載入失敗"}),tH&&"loading"===tQ&&(0,a.jsx)("span",{className:"text-cyan-300",children:"載入捷運路線中"}),ek>0&&(0,a.jsxs)("span",{className:"text-zinc-400",children:["縮放 z",ek.toFixed(1)]})]}),(0,a.jsxs)("div",{className:"flex flex-wrap items-center gap-3 border-l border-white/10 pl-4",children:[(0,a.jsx)("span",{className:"text-zinc-400 font-semibold",children:"圖層控制:"}),eT.length>0&&(0,a.jsxs)("span",{className:"text-[10px] text-zinc-400 whitespace-nowrap",children:["共載入 ",eT.length.toLocaleString()," 個建案"]}),au.map(e=>{let t=eE[e.id];return e.tiles?(0,a.jsxs)("div",{className:"flex items-center gap-2",children:[(0,a.jsxs)("label",{className:"flex items-center gap-1 cursor-pointer text-zinc-300",children:[(0,a.jsx)("input",{type:"checkbox",checked:t?.visible||!1,onChange:t=>eL(r=>({...r,[e.id]:{...r[e.id]||{opacity:.6,visible:!1},visible:t.target.checked}})),className:"h-3 w-3 accent-cyan-500 rounded border-zinc-700"}),e.label]}),t?.visible&&(0,a.jsx)("input",{type:"range",min:0,max:1,step:.05,value:t.opacity??.6,onChange:t=>eL(r=>({...r,[e.id]:{...r[e.id]||{visible:!1,opacity:.6},opacity:parseFloat(t.target.value)}})),className:"w-12 h-1"})]},e.id):null})]}),(0,a.jsxs)("div",{ref:ra,className:"relative flex items-center gap-3 border-l border-white/10 pl-4",children:[(0,a.jsxs)("button",{onClick:()=>ey(e=>!e),className:"rounded-lg bg-zinc-800/70 border border-white/10 px-2.5 py-1.5 text-[11px] text-zinc-200 hover:border-white/30 whitespace-nowrap",children:["載入設定 z",eU," / ",eW,"k"]}),eh&&(0,a.jsxs)("div",{className:"absolute right-0 top-full mt-2 w-52 bg-zinc-950/95 border border-white/10 rounded-xl p-3 shadow-xl z-[120]",children:[(0,a.jsxs)("div",{className:"flex items-center gap-2 text-[10px] text-zinc-400 justify-between",children:[(0,a.jsxs)("span",{children:["載入敏感度 (z",eU,")"]}),(0,a.jsx)("input",{type:"range",min:10,max:18,step:1,value:eU,onChange:e=>eB(parseInt(e.target.value,10)),className:"w-16 h-1"})]}),(0,a.jsxs)("div",{className:"flex items-center gap-2 text-[10px] text-zinc-400 justify-between mt-2",children:[(0,a.jsxs)("span",{children:["最大範圍 (",eW,"k)"]}),(0,a.jsx)("input",{type:"range",min:4,max:60,step:1,value:eW,onChange:e=>eG(parseInt(e.target.value,10)),className:"w-16 h-1"})]})]}),eD&&(0,a.jsx)("button",{onClick:()=>ac({append:!0,cursor:eD}),disabled:eR,className:"hidden xl:block rounded bg-zinc-800 border border-white/10 px-2 py-1 text-[10px] text-zinc-200 hover:border-white/30 disabled:opacity-50 whitespace-nowrap",children:"分頁載入"})]})]})]})}),(0,a.jsxs)("div",{className:"relative flex-1 rounded-xl overflow-hidden border border-white/10 shadow-inner",children:[!K&&(0,a.jsx)("div",{className:"absolute inset-0 flex items-center justify-center bg-zinc-950/70 z-20",children:(0,a.jsxs)("div",{className:"flex flex-col items-center gap-3",children:[(0,a.jsx)(u.A,{className:"h-8 w-8 text-cyan-500 animate-spin"}),(0,a.jsx)("div",{className:"text-sm text-zinc-400",children:"正在載入地圖引擎..."})]})}),(0,a.jsx)("div",{ref:_,className:"w-full h-full"})]}),(0,a.jsx)(m.a,{isOpen:tc,onClose:()=>{tu(!1),tp(null),tw(null),tC(null),tS(!1)},title:(0,a.jsxs)("div",{className:"flex flex-wrap items-center gap-2",children:[(0,a.jsx)("span",{children:td?.project_name||"建案詳細資料"}),td?.county_code&&rH[String(td.county_code).toUpperCase()]&&(0,a.jsx)("button",{type:"button",onClick:()=>r6(rH[String(td.county_code).toUpperCase()]),className:"rounded-full border border-cyan-400/30 px-2 py-0.5 text-[10px] text-cyan-200 hover:border-cyan-300 hover:bg-cyan-500/10",children:rH[String(td.county_code).toUpperCase()]}),tm[0]?.["行政區"]&&(0,a.jsx)("button",{type:"button",onClick:()=>r6(rH[String(td?.county_code||"").toUpperCase()],tm[0]?.["行政區"]),className:"rounded-full border border-white/20 px-2 py-0.5 text-[10px] text-zinc-200 hover:border-white/40 hover:bg-white/10",children:tm[0]?.["行政區"]})]}),maxWidth:"max-w-6xl",children:(0,a.jsxs)("div",{className:"space-y-6 text-sm text-zinc-300",children:[(0,a.jsx)("div",{className:"flex flex-wrap items-center justify-between gap-3",children:(0,a.jsx)("div",{className:"text-[12px] text-zinc-400",children:td?.developer&&(0,a.jsx)("span",{children:td.developer})})}),(0,a.jsxs)("div",{className:"grid grid-cols-2 gap-4 text-[13px]",children:[(0,a.jsxs)("div",{children:[(0,a.jsx)("div",{className:"text-zinc-500 text-[11px]",children:"建商"}),(0,a.jsx)("div",{className:"text-zinc-100",children:D(td?.developer)})]}),(0,a.jsxs)("div",{children:[(0,a.jsx)("div",{className:"text-zinc-500 text-[11px]",children:"營造"}),(0,a.jsx)("div",{className:"text-zinc-100",children:D(td?.contractor)})]}),(0,a.jsxs)("div",{children:[(0,a.jsx)("div",{className:"text-zinc-500 text-[11px]",children:"建築設計"}),(0,a.jsx)("div",{className:"text-zinc-100",children:D(td?.architect)})]}),(0,a.jsxs)("div",{children:[(0,a.jsx)("div",{className:"text-zinc-500 text-[11px]",children:"代銷企劃"}),(0,a.jsx)("div",{className:"text-zinc-100",children:D(td?.sales_agent)})]}),(0,a.jsxs)("div",{children:[(0,a.jsx)("div",{className:"text-zinc-500 text-[11px]",children:"總戶數"}),(0,a.jsx)("div",{className:"text-zinc-100",children:D(td?.total_households)})]}),(0,a.jsxs)("div",{children:[(0,a.jsx)("div",{className:"text-zinc-500 text-[11px]",children:"社區戶數"}),(0,a.jsx)("div",{className:"text-zinc-100",children:D(td?.community_unit_count)})]}),(0,a.jsxs)("div",{children:[(0,a.jsx)("div",{className:"text-zinc-500 text-[11px]",children:"總樓層"}),(0,a.jsx)("div",{className:"text-zinc-100",children:D(td?.total_floors)})]}),(0,a.jsxs)("div",{children:[(0,a.jsx)("div",{className:"text-zinc-500 text-[11px]",children:"地下層"}),(0,a.jsx)("div",{className:"text-zinc-100",children:D(td?.basement_floors)})]}),(0,a.jsxs)("div",{children:[(0,a.jsx)("div",{className:"text-zinc-500 text-[11px]",children:"公設比"}),(0,a.jsx)("div",{className:"text-zinc-100",children:D(td?.public_ratio)})]}),(0,a.jsxs)("div",{children:[(0,a.jsx)("div",{className:"text-zinc-500 text-[11px]",children:"基地面積"}),(0,a.jsx)("div",{className:"text-zinc-100",children:D(td?.site_area)})]}),(0,a.jsxs)("div",{children:[(0,a.jsx)("div",{className:"text-zinc-500 text-[11px]",children:"土地分區"}),(0,a.jsx)("div",{className:"text-zinc-100",children:D(td?.land_use_zoning)})]}),(0,a.jsxs)("div",{children:[(0,a.jsx)("div",{className:"text-zinc-500 text-[11px]",children:"地號"}),(0,a.jsx)("div",{className:"text-zinc-100",children:D(td?.land_plot_number)})]}),(0,a.jsxs)("div",{children:[(0,a.jsx)("div",{className:"text-zinc-500 text-[11px]",children:"車位"}),(0,a.jsx)("div",{className:"text-zinc-100",children:D(td?.parking_count)})]}),(0,a.jsxs)("div",{children:[(0,a.jsx)("div",{className:"text-zinc-500 text-[11px]",children:"車位型式"}),(0,a.jsx)("div",{className:"text-zinc-100",children:D(td?.parking_type)})]}),(0,a.jsxs)("div",{className:"col-span-2",children:[(0,a.jsx)("div",{className:"text-zinc-500 text-[11px]",children:"關係企業"}),(0,a.jsx)("div",{className:"text-zinc-100",children:D(td?.affiliated_companies)})]}),(0,a.jsxs)("div",{className:"col-span-2",children:[(0,a.jsx)("div",{className:"text-zinc-500 text-[11px]",children:"建造號碼"}),(0,a.jsx)("div",{className:"text-zinc-100",children:D(td?.construction_license)})]})]}),(0,a.jsxs)("div",{className:"space-y-3",children:[(0,a.jsx)("div",{className:"flex flex-wrap items-center justify-between gap-2",children:(0,a.jsx)("div",{className:"text-sm font-semibold text-zinc-100",children:"分析報表"})}),(0,a.jsxs)("div",{className:"flex flex-wrap items-center gap-2 text-[11px] text-zinc-500",children:[(0,a.jsx)("span",{children:"更多複合式分析請前往總儀表板"}),(0,a.jsx)("button",{onClick:r8,className:"rounded-md border border-cyan-400/40 px-2.5 py-1 text-[11px] text-cyan-200 hover:bg-cyan-500/15",children:"前往儀表板"})]}),(0,a.jsx)("div",{className:"flex flex-wrap gap-2 text-[11px]",children:[{key:"price-band",label:"總價帶分析"},{key:"unit-price",label:"單價分析"},{key:"heatmap",label:"銷控表"},{key:"velocity",label:"面積分佈熱力圖"}].map(e=>(0,a.jsx)("button",{onClick:()=>t_(e.key),className:(0,j.cn)("rounded-md border px-2.5 py-1 transition-colors",tz===e.key?"border-cyan-400/60 bg-cyan-500/15 text-cyan-200":"border-white/10 text-zinc-400 hover:text-zinc-200 hover:border-white/20"),children:e.label},e.key))}),tN&&(0,a.jsxs)("div",{className:"text-[12px] text-cyan-300 flex items-center gap-2",children:[(0,a.jsx)(u.A,{className:"h-3 w-3 animate-spin"}),"讀取分析資料中..."]}),!tN&&tk&&(0,a.jsx)("div",{className:"text-[12px] text-rose-300",children:tk}),!tN&&!tk&&(tj?(0,a.jsx)(v.t,{componentName:"MapProjectAnalysis",fallbackTitle:"分析模組載入失敗",children:(0,a.jsxs)("div",{className:"space-y-8",children:["price-band"===tz&&(0,a.jsx)(N,{data:tj.priceBandAnalysis?{...tj.priceBandAnalysis,transactionDetails:tj.transactionDetails}:null,visibleSections:["table"]}),"unit-price"===tz&&(0,a.jsx)(S,{data:tj,visibleSections:["stats"]}),"heatmap"===tz&&(0,a.jsx)(k,{data:tj.priceGridAnalysis?tj:null,visibleSections:["grid"],simpleMode:!0}),"velocity"===tz&&(0,a.jsx)(C,{data:tj,visibleSections:["heatmap"]})]})}):(0,a.jsx)("div",{className:"text-[12px] text-zinc-500 py-4 text-center",children:"尚未載入分析資料"}))]}),(0,a.jsxs)("div",{children:[(0,a.jsxs)("div",{className:"flex flex-wrap items-center justify-between gap-3 mb-3",children:[(0,a.jsx)("div",{className:"text-sm font-semibold text-zinc-100",children:"預售交易明細"}),(0,a.jsxs)("div",{className:"text-[11px] text-zinc-500",children:["共 ",tm.length.toLocaleString()," 筆"]})]}),(0,a.jsxs)("div",{className:"grid grid-cols-2 md:grid-cols-4 gap-3 mb-4 text-[12px]",children:[(0,a.jsxs)("div",{className:"rounded-lg border border-white/10 bg-zinc-900/60 px-3 py-2",children:[(0,a.jsx)("div",{className:"text-zinc-500 text-[10px]",children:"最高單價(萬)"}),(0,a.jsx)("div",{className:"text-zinc-100",children:null!==rX.max?rX.max.toFixed(2):"-"})]}),(0,a.jsxs)("div",{className:"rounded-lg border border-white/10 bg-zinc-900/60 px-3 py-2",children:[(0,a.jsx)("div",{className:"text-zinc-500 text-[10px]",children:"最低單價(萬)"}),(0,a.jsx)("div",{className:"text-zinc-100",children:null!==rX.min?rX.min.toFixed(2):"-"})]}),(0,a.jsxs)("div",{className:"rounded-lg border border-white/10 bg-zinc-900/60 px-3 py-2",children:[(0,a.jsx)("div",{className:"text-zinc-500 text-[10px]",children:"平均單價(萬)"}),(0,a.jsx)("div",{className:"text-zinc-100",children:null!==rX.avg?rX.avg.toFixed(2):"-"})]}),(0,a.jsxs)("div",{className:"rounded-lg border border-white/10 bg-zinc-900/60 px-3 py-2",children:[(0,a.jsx)("div",{className:"text-zinc-500 text-[10px]",children:"中位數(萬)"}),(0,a.jsx)("div",{className:"text-zinc-100",children:null!==rX.median?rX.median.toFixed(2):"-"})]})]}),th&&(0,a.jsxs)("div",{className:"text-[12px] text-cyan-300 flex items-center gap-2",children:[(0,a.jsx)(u.A,{className:"h-3 w-3 animate-spin"}),"讀取交易明細中..."]}),tg&&(0,a.jsx)("div",{className:"text-[12px] text-rose-300",children:tg}),!th&&!tg&&(0,a.jsxs)(a.Fragment,{children:[(0,a.jsx)("div",{className:"overflow-x-auto border border-white/10 rounded-lg",children:(0,a.jsxs)("table",{className:"min-w-[900px] w-full text-[12px]",children:[(0,a.jsx)("thead",{className:"bg-zinc-900/80 text-zinc-400",children:(0,a.jsxs)("tr",{children:[(0,a.jsx)("th",{className:"px-3 py-2 text-left",children:"交易日"}),(0,a.jsx)("th",{className:"px-3 py-2 text-left",children:"戶型"}),(0,a.jsx)("th",{className:"px-3 py-2 text-left",children:"樓層"}),(0,a.jsx)("th",{className:"px-3 py-2 text-right",children:"房屋面積(坪)"}),(0,a.jsx)("th",{className:"px-3 py-2 text-right",children:"房屋單價(萬)"}),(0,a.jsx)("th",{className:"px-3 py-2 text-right",children:"房屋總價(萬)"}),(0,a.jsx)("th",{className:"px-3 py-2 text-right",children:"交易總價(萬)"}),(0,a.jsx)("th",{className:"px-3 py-2 text-right",children:"車位總價(萬)"}),(0,a.jsx)("th",{className:"px-3 py-2 text-left",children:"備註"})]})}),(0,a.jsxs)("tbody",{className:"text-zinc-200",children:[0===rZ.length&&(0,a.jsx)("tr",{children:(0,a.jsx)("td",{colSpan:9,className:"px-3 py-4 text-center text-zinc-500",children:"尚無交易明細"})}),rZ.map((e,t)=>(0,a.jsxs)("tr",{className:"border-t border-white/5",children:[(0,a.jsx)("td",{className:"px-3 py-2 whitespace-nowrap",children:D(e["交易日"])}),(0,a.jsx)("td",{className:"px-3 py-2",children:D(e["戶型"]||e["戶別"])}),(0,a.jsx)("td",{className:"px-3 py-2",children:D(e["樓層"])}),(0,a.jsx)("td",{className:"px-3 py-2 text-right",children:D(e["房屋面積(坪)"])}),(0,a.jsx)("td",{className:"px-3 py-2 text-right",children:D(e["房屋單價(萬)"])}),(0,a.jsx)("td",{className:"px-3 py-2 text-right",children:D(e["房屋總價(萬)"])}),(0,a.jsx)("td",{className:"px-3 py-2 text-right",children:D(e["交易總價(萬)"])}),(0,a.jsx)("td",{className:"px-3 py-2 text-right",children:D(e["車位總價(萬)"])}),(0,a.jsx)("td",{className:"px-3 py-2",children:D(e["備註"])})]},e["編號"]||t))]})]})}),rK>1&&(0,a.jsxs)("div",{className:"flex items-center justify-end gap-2 mt-3 text-[11px] text-zinc-400",children:[(0,a.jsx)("button",{onClick:()=>tv(e=>Math.max(1,e-1)),disabled:1===tb,className:"px-2 py-1 rounded border border-white/10 disabled:opacity-50",children:"上一頁"}),(0,a.jsxs)("span",{children:[tb," / ",rK]}),(0,a.jsx)("button",{onClick:()=>tv(e=>Math.min(rK,e+1)),disabled:tb>=rK,className:"px-2 py-1 rounded border border-white/10 disabled:opacity-50",children:"下一頁"})]})]})]})]})})]})}},23879:()=>{},27529:(e,t,r)=>{"use strict";r.d(t,{FH:()=>s});var a=r(16385),n=r(55873);async function l(){let{data:{session:e}}=await a.N.auth.getSession();return{"Content-Type":"application/json",apikey:n.m5,Authorization:`Bearer ${e?.access_token||n.m5}`}}async function i(e){let t=await l(),r=await fetch(n.Sn.RANKING_ANALYSIS,{method:"POST",headers:t,body:JSON.stringify({filters:e})});if(!r.ok)throw Error((await r.json().catch(()=>({error:`Analysis request failed: ${r.status}`}))).error||"Analyze data failed");return r.json()}let s={checkAuth:async function(){let{data:{session:e}}=await a.N.auth.getSession();e||console.log("User not logged in, but allowing access.")},getUser:async function(){let{data:{user:e}}=await a.N.auth.getUser();return e},signOut:async function(){let{error:e}=await a.N.auth.signOut();if(e)throw console.error("Sign out failed:",e),e},fetchData:async function(e,t){let r=await l(),a=await fetch(n.Sn.QUERY_DATA,{method:"POST",headers:r,body:JSON.stringify({filters:e,pagination:t})});if(!a.ok)throw Error((await a.json().catch(()=>({error:"Failed to parse server response"}))).error||"Fetch data failed");return a.json()},analyzeData:i,analyzeProjectRanking:i,fetchSubData:async function(e,t,r){if(!e||!t||!r)throw Error(`Insufficient parameters: ${e}, ${t}, ${r}`);let a=await l(),i=await fetch(n.Sn.SUB_DATA,{method:"POST",headers:a,body:JSON.stringify({id:e,type:t,county:r})});if(!i.ok)throw Error((await i.json().catch(()=>({error:"Failed to fetch sub data"}))).error||"Fetch sub data failed");return i.json()},fetchProjectNameSuggestions:async function(e,t,r=[]){let a=await l(),i=t.replace(/\u3127/g,"一"),s=await fetch(n.Sn.PROJECT_NAMES,{method:"POST",headers:a,body:JSON.stringify({countyCode:e,query:i,districts:r,detailed:!0})});if(!s.ok)throw Error(`Server error: ${s.status}`);return s.json()},getAdminUsers:async function(){let e=await l(),t=await fetch(n.Sn.GET_USERS,{method:"POST",headers:e,body:JSON.stringify({})});if(!t.ok)throw Error((await t.json().catch(()=>({error:"Failed to fetch users"}))).error||"Fetch users failed");return t.json()},getUserActivity:async function(e,t=200,r=0){let a=await l(),i=await fetch(n.Sn.GET_USER_ACTIVITY,{method:"POST",headers:a,body:JSON.stringify({userId:e,limit:t,offset:r})});if(!i.ok)throw Error((await i.json().catch(()=>({error:"Failed to fetch user activity"}))).error||"Fetch user activity failed");return i.json()},getActivityStats:async function(){let e=await l(),t=await fetch(n.Sn.GET_ACTIVITY_STATS,{method:"POST",headers:e,body:JSON.stringify({})});if(!t.ok)throw Error((await t.json().catch(()=>({error:"Failed to fetch activity stats"}))).error||"Fetch activity stats failed");return t.json()},validateReferralCode:async function(e){let t=await l();return(await fetch(n.Sn.VALIDATE_REFERRAL_CODE,{method:"POST",headers:t,body:JSON.stringify({code:e})})).json()},activateSubscription:async function(e){let t=await l(),r=await fetch(n.Sn.ACTIVATE_SUBSCRIPTION,{method:"POST",headers:t,body:JSON.stringify(e)});if(!r.ok)throw Error((await r.json().catch(()=>({error:"Activation failed"}))).error||"Activation failed");return r.json()},bindReferralCode:async function(e){let t=await l(),r=await fetch(n.Sn.BIND_REFERRAL_CODE,{method:"POST",headers:t,body:JSON.stringify("string"==typeof e?{code:e}:e)});if(!r.ok)throw Error((await r.json().catch(()=>({error:"Failed to bind referral code"}))).error||"Failed to bind referral code");return r.json()},clearReferralCode:async function(){let e=await l(),t=await fetch(n.Sn.BIND_REFERRAL_CODE,{method:"POST",headers:e,body:JSON.stringify({action:"clear"})});if(!t.ok)throw Error((await t.json().catch(()=>({error:"Failed to clear referral code"}))).error||"Failed to clear referral code");return t.json()},getReferralDashboard:async function(){let e=await l(),t=await fetch(n.Sn.GET_REFERRAL_DASHBOARD,{method:"POST",headers:e,body:JSON.stringify({})});if(!t.ok)throw Error((await t.json().catch(()=>({error:"Failed to fetch referral data"}))).error||"Fetch referral dashboard failed");return t.json()},consumeReferralFeature:async function(e,t="consume"){let r=await l(),a=await fetch(n.Sn.CONSUME_REFERRAL_FEATURE,{method:"POST",headers:r,body:JSON.stringify({feature:e,mode:t})});if(!a.ok){let e=await a.json().catch(()=>({error:"Failed to consume feature"}));throw Error(e.error||e.reason||"Failed to consume feature")}return a.json()}}},33024:(e,t,r)=>{"use strict";r.d(t,{A:()=>a});let a=(0,r(78340).A)("layers",[["path",{d:"M12.83 2.18a2 2 0 0 0-1.66 0L2.6 6.08a1 1 0 0 0 0 1.83l8.58 3.91a2 2 0 0 0 1.66 0l8.58-3.9a1 1 0 0 0 0-1.83z",key:"zw3jo"}],["path",{d:"M2 12a1 1 0 0 0 .58.91l8.6 3.91a2 2 0 0 0 1.65 0l8.58-3.9A1 1 0 0 0 22 12",key:"1wduqc"}],["path",{d:"M2 17a1 1 0 0 0 .58.91l8.6 3.91a2 2 0 0 0 1.65 0l8.58-3.9A1 1 0 0 0 22 17",key:"kqbvx6"}]])},33210:(e,t,r)=>{"use strict";r.d(t,{A:()=>a});let a=(0,r(78340).A)("x",[["path",{d:"M18 6 6 18",key:"1bl5f8"}],["path",{d:"m6 6 12 12",key:"d8bk6v"}]])},34198:(e,t,r)=>{"use strict";r.d(t,{K:()=>o});var a=r(95155),n=r(12115),l=r(40980),i=r(33210),s=r(94514);let o=(0,n.forwardRef)(({options:e,value:t,onChange:r,placeholder:o="Select...",maxItems:c,disabled:u=!1,className:d,onSearch:p,loading:m=!1,onFocus:f},h)=>{let[y,g]=(0,n.useState)(""),[x,b]=(0,n.useState)(!1),v=(0,n.useRef)(null),j=(0,n.useRef)(null),w=p?e:e.filter(e=>e.label.toLowerCase().includes(y.toLowerCase()));return t.map(t=>{let r=e.find(e=>e.value===t);return r?r.label:t}),(0,n.useEffect)(()=>{let e=e=>{v.current&&!v.current.contains(e.target)&&b(!1)};return document.addEventListener("mousedown",e),()=>document.removeEventListener("mousedown",e)},[]),(0,n.useEffect)(()=>{p&&p(y)},[y,p]),(0,a.jsxs)("div",{className:(0,l.cn)("relative w-full",d),ref:v,children:[(0,a.jsxs)("div",{className:(0,l.cn)("flex items-center gap-2 bg-zinc-950/50 border border-input rounded-md px-2 py-1.5 h-[42px] overflow-x-auto custom-scrollbar cursor-text transition-all",x&&"ring-2 ring-ring ring-offset-0 border-ring",u&&"bg-zinc-900/50 cursor-not-allowed opacity-50"),onClick:()=>!u&&j.current?.focus(),children:[t.map(n=>{let l=e.find(e=>e.value===n),s=l?l.label:n,o=l?.renderLabel??s;return(0,a.jsxs)("span",{className:"bg-violet-500/20 text-violet-200 border border-violet-500/30 text-xs rounded-full px-2 py-0.5 flex items-center gap-1 animate-in fade-in zoom-in-95 duration-100 whitespace-nowrap shrink-0",children:[o,!u&&(0,a.jsx)(i.A,{size:12,className:"cursor-pointer hover:text-white transition-colors",onClick:e=>{e.stopPropagation(),r(t.filter(e=>e!==n))}})]},n)}),(0,a.jsx)("input",{ref:j,type:"text",value:y,onChange:e=>g(e.target.value),onFocus:()=>{b(!0),f?.()},onKeyDown:e=>{"Backspace"===e.key&&""===y&&t.length>0&&r(t.slice(0,-1))},placeholder:0===t.length?o:"",className:(0,l.cn)("bg-transparent outline-none flex-grow min-w-[60px] text-zinc-100 placeholder:text-zinc-500 text-sm",u&&"cursor-not-allowed"),disabled:u})]}),x&&!u&&(0,a.jsx)("div",{className:"absolute z-[110] w-full mt-1 bg-zinc-900 border border-zinc-700 rounded-md shadow-xl max-h-60 overflow-y-auto custom-scrollbar animate-in fade-in slide-in-from-top-2 duration-100",children:m?(0,a.jsx)("div",{className:"p-2 text-center text-zinc-500 text-sm",children:"Loading..."}):0===w.length?(0,a.jsx)("div",{className:"p-2 text-center text-zinc-500 text-sm",children:"No options found"}):w.map((e,i)=>{if(!e)return null;let o=0===i||e.group!==w[i-1]?.group;return(0,a.jsxs)(n.Fragment,{children:[o&&e.group&&(0,a.jsx)("div",{className:"px-2 py-1 bg-zinc-800/50 text-xs font-semibold text-zinc-400 sticky top-0 backdrop-blur-sm z-10",children:e.group}),(0,a.jsxs)("div",{className:(0,l.cn)("px-3 py-2 cursor-pointer text-sm flex items-start justify-between hover:bg-zinc-800 transition-colors",t.includes(e.value)&&"bg-violet-500/10 text-violet-400"),onClick:()=>(e=>{if(t.includes(e))r(t.filter(t=>t!==e));else{if(c&&t.length>=c)return;r([...t,e])}g("")})(e.value),children:[(0,a.jsxs)("div",{className:"flex flex-col",children:[(0,a.jsx)("span",{className:"font-medium",children:e.renderLabel??e.label}),e.details&&(0,a.jsxs)("div",{className:"flex items-center gap-2 mt-0.5",children:[(e.details.county||e.details.district)&&(0,a.jsxs)("span",{className:"text-xs text-zinc-500 bg-zinc-800/80 px-1.5 rounded border border-zinc-700",children:[e.details.county,e.details.district]}),e.details.date&&(0,a.jsx)("span",{className:"text-xs text-zinc-600 font-mono",children:e.details.date.substring(0,7)})]})]}),t.includes(e.value)&&(0,a.jsx)(s.A,{size:16,className:"mt-1"})]})]},e.value)})})]})});o.displayName="MultiSelect"},51806:(e,t,r)=>{"use strict";r.d(t,{a:()=>s});var a=r(95155);r(12115);var n=r(33210),l=r(40980),i=r(81477);function s({isOpen:e,onClose:t,title:r,children:s,className:o,maxWidth:c="max-w-4xl"}){return e?(0,a.jsxs)("div",{className:"fixed inset-0 z-50 flex items-center justify-center p-4 bg-black/70 backdrop-blur-sm animate-in fade-in duration-200",children:[(0,a.jsx)("div",{className:"absolute inset-0",onClick:t}),(0,a.jsxs)(i.Zp,{className:(0,l.cn)("relative w-full max-h-[90vh] flex flex-col overflow-hidden animate-in zoom-in-95 duration-200",c,o),"data-report-control":"allow",onClick:e=>e.stopPropagation(),children:[(0,a.jsxs)("div",{className:"flex items-center justify-between p-6 border-b border-border",children:[r&&(0,a.jsx)("h2",{className:"text-2xl font-bold text-white",children:r}),(0,a.jsx)("button",{onClick:t,className:"p-1 rounded-full hover:bg-white/10 transition-colors text-gray-400 hover:text-white",children:(0,a.jsx)(n.A,{size:24})})]}),(0,a.jsx)("div",{className:"p-6 overflow-y-auto custom-scrollbar",children:s})]})]}):null}},81477:(e,t,r)=>{"use strict";r.d(t,{BT:()=>c,Wu:()=>u,ZB:()=>o,Zp:()=>i,aR:()=>s});var a=r(95155),n=r(12115),l=r(40980);let i=n.forwardRef(({className:e,...t},r)=>(0,a.jsx)("div",{ref:r,className:(0,l.cn)("glass-panel rounded-xl text-card-foreground",e),...t}));i.displayName="Card";let s=n.forwardRef(({className:e,...t},r)=>(0,a.jsx)("div",{ref:r,className:(0,l.cn)("flex flex-col space-y-1.5 p-6",e),...t}));s.displayName="CardHeader";let o=n.forwardRef(({className:e,...t},r)=>(0,a.jsx)("h3",{ref:r,className:(0,l.cn)("text-lg font-semibold leading-none tracking-tight text-white",e),...t}));o.displayName="CardTitle";let c=n.forwardRef(({className:e,...t},r)=>(0,a.jsx)("p",{ref:r,className:(0,l.cn)("text-sm text-zinc-400",e),...t}));c.displayName="CardDescription";let u=n.forwardRef(({className:e,...t},r)=>(0,a.jsx)("div",{ref:r,className:(0,l.cn)("p-6 pt-0",e),...t}));u.displayName="CardContent",n.forwardRef(({className:e,...t},r)=>(0,a.jsx)("div",{ref:r,className:(0,l.cn)("flex items-center p-6 pt-0",e),...t})).displayName="CardFooter"},81789:(e,t,r)=>{"use strict";r.d(t,{t:()=>i});var a=r(95155),n=r(12115),l=r(13545);class i extends n.Component{static getDerivedStateFromError(e){return{hasError:!0,error:e,errorInfo:null}}componentDidCatch(e,t){console.error("Uncaught error:",e,t),this.setState({error:e,errorInfo:t})}render(){return this.state.hasError?(0,a.jsxs)("div",{className:"p-6 bg-red-950/20 border border-red-500/30 rounded-lg flex flex-col items-center justify-center text-center gap-4 min-h-[200px]",children:[(0,a.jsx)("div",{className:"bg-red-500/10 p-3 rounded-full",children:(0,a.jsx)(l.A,{className:"w-8 h-8 text-red-400"})}),(0,a.jsxs)("div",{children:[(0,a.jsx)("h2",{className:"text-lg font-bold text-red-200 mb-1",children:this.props.fallbackTitle||"Something went wrong"}),this.props.componentName&&(0,a.jsxs)("p",{className:"text-xs text-red-400/80 font-mono mb-2",children:["Component: ",this.props.componentName]}),(0,a.jsx)("div",{className:"max-w-md bg-black/50 p-3 rounded text-left overflow-auto max-h-[150px] border border-red-500/20",children:(0,a.jsx)("p",{className:"text-xs font-mono text-red-300 break-all",children:this.state.error?.toString()})}),(0,a.jsx)("button",{className:"mt-4 px-4 py-2 bg-red-900/40 hover:bg-red-900/60 text-red-200 text-xs rounded transition-colors",onClick:()=>this.setState({hasError:!1,error:null,errorInfo:null}),children:"Try to Recover"})]})]}):this.props.children}constructor(...e){super(...e),this.state={hasError:!1,error:null,errorInfo:null}}}},94514:(e,t,r)=>{"use strict";r.d(t,{A:()=>a});let a=(0,r(78340).A)("check",[["path",{d:"M20 6 9 17l-5-5",key:"1gmf2c"}]])},98883:(e,t,r)=>{"use strict";r.d(t,{P:()=>a});let a=e=>{let t=new Date,r=new Date,a=e.match(/^(\d+)m$/);if(a){let e=parseInt(a[1],10);if(Number.isFinite(e))return r.setMonth(t.getMonth()-e),{startDate:r.toISOString().split("T")[0],endDate:t.toISOString().split("T")[0]}}switch(e){case"1q":r.setMonth(t.getMonth()-3);break;case"2q":r.setMonth(t.getMonth()-6);break;case"3q":r.setMonth(t.getMonth()-9);break;case"1y":r.setFullYear(t.getFullYear()-1);break;case"this_year":r=new Date(t.getFullYear(),0,1);break;case"last_2_years":r=new Date(t.getFullYear()-1,0,1);break;case"last_3_years":r=new Date(t.getFullYear()-2,0,1);break;default:return{startDate:"",endDate:""}}return{startDate:r.toISOString().split("T")[0],endDate:t.toISOString().split("T")[0]}}}}]);