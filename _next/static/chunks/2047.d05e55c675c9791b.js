"use strict";(self.webpackChunk_N_E=self.webpackChunk_N_E||[]).push([[2047],{19835:(e,t,n)=>{n.d(t,{A:()=>l});let l=(0,n(78340).A)("move",[["path",{d:"M12 2v20",key:"t6zp3m"}],["path",{d:"m15 19-3 3-3-3",key:"11eu04"}],["path",{d:"m19 9 3 3-3 3",key:"1mg7y2"}],["path",{d:"M2 12h20",key:"9i4pu4"}],["path",{d:"m5 9-3 3 3 3",key:"j64kie"}],["path",{d:"m9 5 3-3 3 3",key:"l8vdw6"}]])},22651:(e,t,n)=>{n.d(t,{A:()=>l});let l=(0,n(78340).A)("zoom-in",[["circle",{cx:"11",cy:"11",r:"8",key:"4ej97u"}],["line",{x1:"21",x2:"16.65",y1:"21",y2:"16.65",key:"13gj7c"}],["line",{x1:"11",x2:"11",y1:"8",y2:"14",key:"1vmskp"}],["line",{x1:"8",x2:"14",y1:"11",y2:"11",key:"durymu"}]])},68459:(e,t,n)=>{n.d(t,{A:()=>l});let l=(0,n(78340).A)("trash-2",[["path",{d:"M10 11v6",key:"nco0om"}],["path",{d:"M14 11v6",key:"outv1u"}],["path",{d:"M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6",key:"miytrc"}],["path",{d:"M3 6h18",key:"d0wm0j"}],["path",{d:"M8 6V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2",key:"e791ji"}]])},69220:(e,t,n)=>{n.d(t,{A:()=>l});let l=(0,n(78340).A)("zoom-out",[["circle",{cx:"11",cy:"11",r:"8",key:"4ej97u"}],["line",{x1:"21",x2:"16.65",y1:"21",y2:"16.65",key:"13gj7c"}],["line",{x1:"8",x2:"14",y1:"11",y2:"11",key:"durymu"}]])},82047:(e,t,n)=>{n.r(t),n.d(t,{default:()=>w});var l=n(95155),i=n(12115),a=n(21975),r=n(19835),s=n(22390),o=n(78340);let d=(0,o.A)("spline",[["circle",{cx:"19",cy:"5",r:"2",key:"mhkx31"}],["circle",{cx:"5",cy:"19",r:"2",key:"v8kfzx"}],["path",{d:"M5 17A12 12 0 0 1 17 5",key:"1okkup"}]]),c=(0,o.A)("square",[["rect",{width:"18",height:"18",x:"3",y:"3",rx:"2",key:"afitv7"}]]),u=(0,o.A)("app-window",[["rect",{x:"2",y:"4",width:"20",height:"16",rx:"2",key:"izxlao"}],["path",{d:"M10 4v4",key:"pp8u80"}],["path",{d:"M2 8h20",key:"d11cs7"}],["path",{d:"M6 4v4",key:"1svtjw"}]]);var m=n(22651),x=n(69220),h=n(68459),p=n(40980);let g={wall:"#60a5fa",window:"#38bdf8",pillar:"#f97316"},f=[{type:"wardrobe",label:"衣櫃",size:{w:80,h:40}},{type:"cabinet",label:"櫃體",size:{w:60,h:30}},{type:"bed",label:"床",size:{w:120,h:80}},{type:"sofa",label:"沙發",size:{w:110,h:50}},{type:"diningTable",label:"餐桌",size:{w:90,h:60}},{type:"desk",label:"書桌",size:{w:80,h:45}},{type:"chair",label:"椅子",size:{w:30,h:30}},{type:"sink",label:"洗手台",size:{w:50,h:35}},{type:"toilet",label:"馬桶",size:{w:35,h:45}},{type:"kitchen",label:"流理台",size:{w:120,h:40}},{type:"fridge",label:"冰箱",size:{w:40,h:35}}],y=()=>Math.random().toString(36).slice(2,10);function w(){let e=(0,i.useRef)(null),t=(0,i.useRef)(null),n=(0,i.useRef)(null),o=(0,i.useRef)({zoomLevel:1,panOffset:{x:0,y:0},isPanning:!1,panStart:{x:0,y:0},drawing:!1,startPoint:{x:0,y:0},endPoint:{x:0,y:0},drawingPoints:[],measureLines:[],wallPaths:[],rooms:[],columns:[],windows:[],furniture:[],scale:null,selected:null,draggingFurnitureId:null,draggingWindowId:null,draggingWindowHandle:null,draggingWallPathId:null,draggingRoomId:null,draggingColumnId:null,draggingColumnResize:null,dragStartMouse:{x:0,y:0},dragStartFurniturePos:{x:0,y:0},dragStartRoomPoints:[],dragStartColumnPoints:[],dragStartWallMouse:{x:0,y:0},dragStartWallPoints:[],dragStartWindow:null,snappedPoint:null,snappedType:null,pointerWorld:null,activeMeasureMode:null,measureFinalizePending:!1,isAltPressed:!1,isSpacePressed:!1,isShiftPressed:!1,isOrthoMode:!1,usedOrthoDuringDraw:!1,history:[],historyIndex:-1,clipboard:null}),[w,b]=(0,i.useState)({mode:null,hasImage:!1,scaleSet:!1,infoText:"請上傳平面圖開始",fillColor:"#4ade80",fillOpacity:.2,imageOpacity:.7,boundaryFillColor:"#22c55e",boundaryFillOpacity:.15,boundaryLineScale:1,innerLineScale:1,wallLineScale:1,zoomDisplay:100,isOrtho:!1,selectedFurnitureType:"wardrobe",wallThicknessDefault:15,windowWidthCm:120,windowType:"sliding",planType:"indoor",planNote:""}),v=(0,i.useRef)(w.wallThicknessDefault),[k,P]=(0,i.useState)(null),j=e=>({x:(e.x-o.current.panOffset.x)/o.current.zoomLevel,y:(e.y-o.current.panOffset.y)/o.current.zoomLevel}),z=(e,t)=>Math.sqrt((t.x-e.x)**2+(t.y-e.y)**2),N=e=>e.map(e=>({...e})),S=(0,i.useCallback)(()=>{let e,t=o.current,n={wallPaths:(e=o.current).wallPaths.map(e=>({...e,points:N(e.points),segments:e.segments.map(e=>({...e}))})),rooms:e.rooms.map(e=>({...e,points:N(e.points)})),columns:e.columns.map(e=>({...e,points:N(e.points)})),windows:e.windows.map(e=>({...e})),furniture:e.furniture.map(e=>({...e,position:{...e.position}})),measureLines:e.measureLines.map(e=>({...e,pixelStart:{...e.pixelStart},pixelEnd:{...e.pixelEnd}})),scale:e.scale};t.history=t.history.slice(0,t.historyIndex+1),t.history.push(n),t.historyIndex=t.history.length-1},[]),C=(0,i.useCallback)(()=>{let e,t=o.current;if(t.historyIndex<=0)return;t.historyIndex-=1;let n=t.history[t.historyIndex];n&&((e=o.current).wallPaths=n.wallPaths.map(e=>({...e,points:N(e.points),segments:e.segments.map(e=>({...e}))})),e.rooms=n.rooms.map(e=>({...e,points:N(e.points)})),e.columns=n.columns.map(e=>({...e,points:N(e.points)})),e.windows=n.windows.map(e=>({...e})),e.furniture=n.furniture.map(e=>({...e,position:{...e.position}})),e.measureLines=n.measureLines.map(e=>({...e,pixelStart:{...e.pixelStart},pixelEnd:{...e.pixelEnd}})),e.scale=n.scale,Z(null),b(e=>({...e,scaleSet:!!n.scale,infoText:"已復原"})),G())},[]),M=(0,i.useCallback)(()=>{let e=o.current;if(k){if("room"===k.kind){let t=e.rooms.find(e=>e.id===k.id);t&&(e.clipboard={kind:"room",data:{...t,points:N(t.points)}})}else if("column"===k.kind){let t=e.columns.find(e=>e.id===k.id);t&&(e.clipboard={kind:"column",data:{...t,points:N(t.points)}})}else if("furniture"===k.kind){let t=e.furniture.find(e=>e.id===k.id);t&&(e.clipboard={kind:"furniture",data:{...t,position:{...t.position}}})}else if("window"===k.kind){let t=e.windows.find(e=>e.id===k.id);t&&(e.clipboard={kind:"window",data:{...t}})}else if("wall"===k.kind){let t=e.wallPaths.find(e=>e.id===k.pathId);t&&!t.isBoundary&&(e.clipboard={kind:"wall",data:{...t,points:N(t.points),segments:t.segments.map(e=>({...e}))}})}e.clipboard&&b(e=>({...e,infoText:"已複製"}))}},[k]),T=(0,i.useCallback)(()=>{let e=o.current;if(!e.clipboard)return;let t=20/e.zoomLevel;if("room"===e.clipboard.kind){let n=e.clipboard.data,l={...n,id:y(),name:`${n.name} (複製)`,points:n.points.map(e=>({x:e.x+t,y:e.y+t}))};e.rooms.push(l),Z({kind:"room",id:l.id})}else if("column"===e.clipboard.kind){let n=e.clipboard.data,l={id:y(),points:n.points.map(e=>({x:e.x+t,y:e.y+t}))};e.columns.push(l),Z({kind:"column",id:l.id})}else if("furniture"===e.clipboard.kind){let n=e.clipboard.data,l={...n,id:y(),position:{x:n.position.x+t,y:n.position.y+t}};e.furniture.push(l),Z({kind:"furniture",id:l.id})}else if("window"===e.clipboard.kind){let t=e.clipboard.data;if(K()){let n={...t,id:y(),t:Math.min(.95,Math.max(.05,t.t+.05))};es(n),e.windows.push(n),Z({kind:"window",id:n.id})}}else if("wall"===e.clipboard.kind){let n=e.clipboard.data,l={...n,id:y(),points:n.points.map(e=>({x:e.x+t,y:e.y+t})),segments:n.segments.map(e=>({...e}))};e.wallPaths.push(l),Z({kind:"wall",pathId:l.id,segmentIndex:0})}S(),G()},[S]),L=e=>{let t=0;for(let n=0,l=e.length;n<l;n++)t+=e[n].x*e[n===l-1?0:n+1].y-e[n===l-1?0:n+1].x*e[n].y;return Math.abs(t/2)},I=e=>{let t=0;for(let n=0,l=e.length;n<l;n++){let i=e[n],a=e[n===l-1?0:n+1];t+=i.x*a.y-a.x*i.y}return t/2},F=e=>{if(0===e.length)return{x:0,y:0};let t=0,n=0,l=0;for(let i=0;i<e.length;i++){let a=e[i],r=e[(i+1)%e.length],s=a.x*r.y-r.x*a.y;l+=s,t+=(a.x+r.x)*s,n+=(a.y+r.y)*s}let i=3*l;return 0===i?e[0]:{x:t/i,y:n/i}},W=(e,t)=>{let n=parseInt(e.slice(1,3),16),l=parseInt(e.slice(3,5),16),i=parseInt(e.slice(5,7),16);return`rgba(${n}, ${l}, ${i}, ${t})`},E=(e,t,n)=>{let l=n.x-t.x,i=n.y-t.y,a=e.x-t.x,r=e.y-t.y,s=l*l+i*i;if(0===s)return z(e,t);let o=Math.max(0,Math.min(1,(a*l+r*i)/s));return z(e,{x:t.x+l*o,y:t.y+i*o})},R=(e,t,n)=>{let l=n.x-t.x,i=n.y-t.y,a=e.x-t.x,r=e.y-t.y,s=l*l+i*i;if(0===s)return{point:t,t:0};let o=Math.max(0,Math.min(1,(a*l+r*i)/s));return{point:{x:t.x+l*o,y:t.y+i*o},t:o}},D=e=>{let t=e.map(e=>e.x),n=e.map(e=>e.y);return{minX:Math.min(...t),maxX:Math.max(...t),minY:Math.min(...n),maxY:Math.max(...n)}},O=(e,t)=>{let n=!1;for(let l=0,i=t.length-1;l<t.length;i=l++){let a=t[l].x,r=t[l].y,s=t[i].x,o=t[i].y;r>e.y!=o>e.y&&e.x<(s-a)*(e.y-r)/(o-r+1e-5)+a&&(n=!n)}return n},A=(e,t,n,l)=>{let i={x:l.x-t.x,y:l.y-t.y},a={x:n.x-t.x,y:n.y-t.y},r={x:e.x-t.x,y:e.y-t.y},s=i.x*i.x+i.y*i.y,o=i.x*a.x+i.y*a.y,d=i.x*r.x+i.y*r.y,c=a.x*a.x+a.y*a.y,u=a.x*r.x+a.y*r.y,m=s*c-o*o;if(0===m)return!1;let x=1/m,h=(c*d-o*u)*x,p=(s*u-o*d)*x;return h>=-1e-4&&p>=-1e-4&&h+p<=1.0001},B=e=>f.find(t=>t.type===e)||f[0],X=e=>{let t=B(e.type),n=t.size.w*e.scale/2,l=t.size.h*e.scale/2,i=Math.cos(e.rotation),a=Math.sin(e.rotation),r=[{x:-n,y:-l},{x:n,y:-l},{x:n,y:l},{x:-n,y:l}].map(t=>({x:e.position.x+t.x*i-t.y*a,y:e.position.y+t.x*a+t.y*i})),s=r.map(e=>e.x),o=r.map(e=>e.y);return{minX:Math.min(...s),maxX:Math.max(...s),minY:Math.min(...o),maxY:Math.max(...o)}},$=(e,t,n,l,i)=>{e.save();let a=13/i;e.font=`bold ${a}px sans-serif`,e.fillStyle="rgba(0,0,0,0.7)";let r=e.measureText(t).width;e.fillRect(n.x-r/2-2/i,n.y-a-2/i,r+4/i,a+4/i),e.fillStyle=l,e.textAlign="center",e.fillText(t,n.x,n.y-4/i),e.restore()},Y=(e,t)=>Math.abs(t.x-e.x)>Math.abs(t.y-e.y)?{x:t.x,y:e.y}:{x:e.x,y:t.y},H=e=>{if(e.length<2)return e;let t=e[0],n=e[1],l=e[e.length-1];return Math.abs(n.x-t.x)>=Math.abs(n.y-t.y)?[{x:l.x,y:t.y},...e.slice(1)]:[{x:t.x,y:l.y},...e.slice(1)]},U=e=>{if(e.length<2)return e;let t=[{...e[0]}];for(let n=1;n<e.length;n++){let l=t[n-1],i={...e[n]};Math.abs(i.x-l.x)>=Math.abs(i.y-l.y)?i.y=l.y:i.x=l.x,t.push(i)}return t},K=()=>o.current.wallPaths.find(e=>e.isBoundary)||null,_=(e,t=!0)=>{let n=o.current,l=18/n.zoomLevel,i=e;n.wallPaths.forEach(n=>{if(!t&&n.isBoundary)return;let a=n.isBoundary?n.points.length:n.points.length-1;for(let t=0;t<a;t++){let a=n.points[t],r=n.points[(t+1)%n.points.length],s=E(e,a,r);s<l&&(l=s,i=R(e,a,r).point)}});let a=V()?.polygon;if(a&&a.length>=2)for(let t=0;t<a.length;t++){let n=a[t],r=a[(t+1)%a.length],s=E(e,n,r);s<l&&(l=s,i=R(e,n,r).point)}return i},q=e=>K()?e.map(e=>_(e,!0)):e,V=()=>{let e=o.current;if(!e.scale)return null;let t=K();if(!t||t.points.length<3)return null;let n=[],l=t.segments,i=t.points.length;for(let t=0;t<i;t++){let i=l[t]?.thicknessCm??w.wallThicknessDefault;n.push(i*e.scale)}let a=((e,t)=>{if(e.length<3)return[];let n=I(e)>0,l=(e,t)=>{let l=t.x-e.x,i=t.y-e.y,a=Math.sqrt(l*l+i*i)||1,r=-i/a,s=l/a;return n?{x:r,y:s}:{x:-r,y:-s}},i=[],a=e.length;for(let n=0;n<a;n++){let r=e[(n-1+a)%a],s=e[n],o=e[(n+1)%a],d=t[(n-1+a)%a],c=t[n],u=l(r,s),m=l(s,o),x={x:r.x+u.x*d,y:r.y+u.y*d},h={x:s.x+u.x*d,y:s.y+u.y*d},p={x:s.x+m.x*c,y:s.y+m.y*c},g={x:o.x+m.x*c,y:o.y+m.y*c},f=(x.x-h.x)*(p.y-g.y)-(x.y-h.y)*(p.x-g.x);if(1e-5>Math.abs(f)){i.push({x:s.x+u.x*d,y:s.y+u.y*d});continue}let y=((x.x*h.y-x.y*h.x)*(p.x-g.x)-(x.x-h.x)*(p.x*g.y-p.y*g.x))/f,w=((x.x*h.y-x.y*h.x)*(p.y-g.y)-(x.y-h.y)*(p.x*g.y-p.y*g.x))/f;i.push({x:y,y:w})}return i})(t.points,n.map(e=>e));if(((e,t=.5)=>{if(e.length<2)return!1;for(let n=0;n<e.length;n++){let l=e[n],i=e[(n+1)%e.length],a=Math.abs(l.x-i.x),r=Math.abs(l.y-i.y);if(a>t&&r>t)return!1}return!0})(t.points)&&(a=U(a)),a.length<3)return null;let r=L(a)/(e.scale*e.scale);return{areaCm2:r,areaM2:r/1e4,areaPing:r/33057.9,polygon:a}},G=(0,i.useCallback)(()=>{let t=e.current,l=t?.getContext("2d");if(!t||!l)return;let i=o.current,{width:a,height:r}=t;if(l.clearRect(0,0,a,r),l.save(),l.translate(i.panOffset.x,i.panOffset.y),l.scale(i.zoomLevel,i.zoomLevel),n.current){let e=n.current;l.save(),l.globalAlpha=w.imageOpacity,l.drawImage(e,-e.naturalWidth/2,-e.naturalHeight/2),l.restore()}let s=K(),d=V()?.polygon||null;if(s&&s.points.length>=3){l.beginPath(),l.moveTo(s.points[0].x,s.points[0].y);for(let e=1;e<s.points.length;e++)l.lineTo(s.points[e].x,s.points[e].y);l.closePath(),l.fillStyle=W(w.boundaryFillColor,w.boundaryFillOpacity),l.fill()}if(i.wallPaths.forEach(e=>{if(!(e.points.length<2))for(let t=0;t<e.points.length;t++){let n=e.points[t],a=e.points[(t+1)%e.points.length];if(!e.isBoundary&&t===e.points.length-1)break;let r=e.segments[t%e.segments.length],s=k?.kind==="wall"&&k.pathId===e.id&&k.segmentIndex===t,o=e.isBoundary?"#a855f7":g[r.wallType],d=i.scale?(r.thicknessCm||w.wallThicknessDefault)*i.scale:6,c=Math.max(2,d/12)/i.zoomLevel*(e.isBoundary?w.boundaryLineScale:w.wallLineScale);if(e.isBoundary)l.beginPath(),l.moveTo(n.x,n.y),l.lineTo(a.x,a.y),"window"===r.wallType?l.setLineDash([8/i.zoomLevel,6/i.zoomLevel]):l.setLineDash([]),l.strokeStyle=s?"#facc15":o,l.lineWidth=s?1.6*c:c,l.stroke(),l.setLineDash([]);else{let t=a.x-n.x,i=a.y-n.y,r=Math.sqrt(t*t+i*i)||1,u={x:-i/r,y:t/r},m=(e.offsetSide??1)*d,x=u.x*m,h=u.y*m;l.beginPath(),l.moveTo(n.x,n.y),l.lineTo(a.x,a.y),l.lineTo(a.x+x,a.y+h),l.lineTo(n.x+x,n.y+h),l.closePath(),l.fillStyle="rgba(96,165,250,0.2)",l.fill(),l.strokeStyle=s?"#facc15":o,l.lineWidth=s?1.4*c:c,l.stroke()}}}),i.windows.forEach(e=>{let t=er(e);if(!t)return;let n=k?.kind==="window"&&k.id===e.id,a=Math.atan2(t.uy,t.ux);l.save(),l.translate(t.center.x,t.center.y),l.rotate(a),l.fillStyle="rgba(56,189,248,0.2)",l.strokeStyle=n?"#facc15":"#38bdf8",l.lineWidth=2/i.zoomLevel,l.fillRect(-t.widthPx/2,-t.thicknessPx/2,t.widthPx,t.thicknessPx),l.strokeRect(-t.widthPx/2,-t.thicknessPx/2,t.widthPx,t.thicknessPx),"sliding"===e.type?(l.beginPath(),l.moveTo(-t.widthPx/2,0),l.lineTo(t.widthPx/2,0),l.moveTo(-t.widthPx/2,-(.25*t.thicknessPx)),l.lineTo(0,-(.25*t.thicknessPx)),l.moveTo(0,.25*t.thicknessPx),l.lineTo(t.widthPx/2,.25*t.thicknessPx)):(l.beginPath(),l.moveTo(-t.widthPx/2,0),l.lineTo(t.widthPx/2,0),l.stroke(),l.beginPath(),l.arc(-t.widthPx/2,0,Math.min(.35*t.widthPx,24/i.zoomLevel),-Math.PI/2,Math.PI/2)),l.stroke(),l.fillStyle=n?"#facc15":"#38bdf8",l.beginPath(),l.arc(-t.widthPx/2,0,3/i.zoomLevel,0,2*Math.PI),l.arc(t.widthPx/2,0,3/i.zoomLevel,0,2*Math.PI),l.fill(),l.restore()}),d&&d.length>=3){l.beginPath(),l.moveTo(d[0].x,d[0].y);for(let e=1;e<d.length;e++)l.lineTo(d[e].x,d[e].y);l.closePath(),l.strokeStyle="#a78bfa",l.lineWidth=1.6*w.innerLineScale/i.zoomLevel,l.setLineDash([6/i.zoomLevel,6/i.zoomLevel]),l.stroke(),l.setLineDash([])}if(("drawWall"===w.mode||i.draggingWallPathId)&&d&&d.length>=2&&i.pointerWorld){let e=((e,t,n)=>{let l=n,i=null;for(let n=0;n<e.length;n++){let a=e[n],r=e[(n+1)%e.length],s=E(t,a,r);s<l&&(l=s,i={a,b:r})}return i})(d,i.pointerWorld,12/i.zoomLevel);e&&(l.beginPath(),l.moveTo(e.a.x,e.a.y),l.lineTo(e.b.x,e.b.y),l.strokeStyle="rgba(56,189,248,0.9)",l.lineWidth=3/i.zoomLevel,l.setLineDash([]),l.stroke())}if(i.rooms.forEach(e=>{if(e.points.length<3)return;let t=k?.kind==="room"&&k.id===e.id;l.beginPath(),l.moveTo(e.points[0].x,e.points[0].y);for(let t=1;t<e.points.length;t++)l.lineTo(e.points[t].x,e.points[t].y);if(l.closePath(),l.fillStyle=W(e.fillColor,e.fillOpacity),l.fill(),l.strokeStyle=t?"#facc15":"#34d399",l.lineWidth=(t?3:2)/i.zoomLevel,l.stroke(),i.scale){let t=L(e.points)/(i.scale*i.scale),n=F(e.points);$(l,`${e.name} ${(t/33057.9).toFixed(2)} 坪`,n,"#fbbf24",i.zoomLevel)}}),i.columns.forEach(e=>{if(e.points.length<3)return;let t=k?.kind==="column"&&k.id===e.id;l.beginPath(),l.moveTo(e.points[0].x,e.points[0].y);for(let t=1;t<e.points.length;t++)l.lineTo(e.points[t].x,e.points[t].y);if(l.closePath(),l.fillStyle="rgba(148,163,184,0.35)",l.fill(),l.strokeStyle=t?"#facc15":"#94a3b8",l.lineWidth=(t?2.5:1.5)/i.zoomLevel,l.stroke(),t){let t=D(e.points);l.strokeStyle="rgba(250,204,21,0.8)",l.lineWidth=1.2/i.zoomLevel,l.strokeRect(t.minX,t.minY,t.maxX-t.minX,t.maxY-t.minY);let n=5/i.zoomLevel,a=[{x:t.minX,y:t.minY},{x:t.maxX,y:t.minY},{x:t.maxX,y:t.maxY},{x:t.minX,y:t.maxY}];l.fillStyle="#facc15",a.forEach(e=>{l.fillRect(e.x-n,e.y-n,2*n,2*n)})}}),i.measureLines.forEach(e=>{l.beginPath(),l.moveTo(e.pixelStart.x,e.pixelStart.y),l.lineTo(e.pixelEnd.x,e.pixelEnd.y),l.strokeStyle=e.color,l.lineWidth=2/i.zoomLevel,l.stroke();let t={x:(e.pixelStart.x+e.pixelEnd.x)/2,y:(e.pixelStart.y+e.pixelEnd.y)/2};if(i.scale){let n=z(e.pixelStart,e.pixelEnd)/i.scale;$(l,`${n.toFixed(1)} cm`,t,"#f87171",i.zoomLevel)}else{let n=z(e.pixelStart,e.pixelEnd);$(l,`${n.toFixed(0)} px`,t,"#f87171",i.zoomLevel)}}),i.furniture.forEach(e=>{let t=k?.kind==="furniture"&&k.id===e.id;((e,t,n,l)=>{let i=B(t.type),a=i.size.w*t.scale,r=i.size.h*t.scale;e.save(),e.translate(t.position.x,t.position.y),e.rotate(t.rotation),e.lineWidth=2/l,e.strokeStyle=n?"#facc15":"#e5e7eb";let s=(t,n,l,i)=>e.strokeRect(t,n,l,i),o=(t,n,l)=>{e.beginPath(),e.arc(t,n,l,0,2*Math.PI),e.stroke()};switch(t.type){case"bed":s(-a/2,-r/2,a,r),s(-a/2,-r/2,a,.25*r),s(-a/2+.08*a,-r/2+.06*r,.28*a,.14*r),s(a/2-.36*a,-r/2+.06*r,.28*a,.14*r),e.beginPath(),e.moveTo(-a/2,-(.05*r)),e.lineTo(a/2,-(.05*r)),e.stroke();break;case"sofa":s(-a/2,-r/2,a,r),s(-a/2,-r/2,a,.25*r),s(-a/2,-r/2,.15*a,r),s(a/2-.15*a,-r/2,.15*a,r),s(-a/2+.2*a,-r/2+.35*r,.6*a,.45*r);break;case"wardrobe":s(-a/2,-r/2,a,r),e.beginPath(),e.moveTo(0,-r/2),e.lineTo(0,r/2),e.stroke(),o(-(.15*a),0,Math.max(2,.03*a)),o(.15*a,0,Math.max(2,.03*a));break;case"cabinet":s(-a/2,-r/2,a,r),e.beginPath(),e.moveTo(-a/2,-r/6),e.lineTo(a/2,-r/6),e.moveTo(-a/2,r/6),e.lineTo(a/2,r/6),e.stroke();break;case"diningTable":{s(-a/2,-r/2,a,r);let e=.18*a,t=.28*r;s(-a/2-.9*e,-t/2,e,t),s(a/2-.1*e,-t/2,e,t),s(-e/2,-r/2-.9*t,e,t),s(-e/2,r/2-.1*t,e,t);break}case"desk":s(-a/2,-r/2,a,r),e.beginPath(),e.moveTo(-a/2,-r/6),e.lineTo(a/2,-r/6),e.stroke(),s(a/2-.22*a,-r/2,.2*a,.45*r),e.beginPath(),e.moveTo(a/2-.22*a,-r/2+.22*r),e.lineTo(a/2-.02*a,-r/2+.22*r),e.stroke();break;case"chair":s(-a/2,-r/6,a,r/2),s(-a/2,-r/2,a,r/3);break;case"sink":s(-a/2,-r/2,a,r),o(0,0,.25*Math.min(a,r));break;case"toilet":s(-a/2,-r/2,a,.35*r),e.beginPath(),e.ellipse(0,.1*r,.4*a,.35*r,0,0,2*Math.PI),e.stroke(),e.beginPath(),e.ellipse(0,.1*r,.2*a,.18*r,0,0,2*Math.PI),e.stroke();break;case"kitchen":s(-a/2,-r/2,a,r),o(-(.2*a),0,.18*Math.min(a,r)),o(.2*a,0,.18*Math.min(a,r)),s(-a/2+.05*a,-r/2+.05*r,.35*a,.4*r);break;case"fridge":s(-a/2,-r/2,a,r),e.beginPath(),e.moveTo(-a/2,-r/2+.45*r),e.lineTo(a/2,-r/2+.45*r),e.stroke(),e.beginPath(),e.moveTo(a/2-.15*a,-r/2+.1*r),e.lineTo(a/2-.15*a,-r/2+.4*r),e.moveTo(a/2-.15*a,-r/2+.55*r),e.lineTo(a/2-.15*a,-r/2+.85*r),e.stroke();break;default:s(-a/2,-r/2,a,r)}e.restore()})(l,e,t,i.zoomLevel)}),i.drawing){if("setScale"===w.mode||"measureLine"===w.mode)l.beginPath(),l.moveTo(i.startPoint.x,i.startPoint.y),l.lineTo(i.endPoint.x,i.endPoint.y),l.strokeStyle="#ef4444",l.lineWidth=2/i.zoomLevel,l.stroke();else if(("drawBoundary"===w.mode||"drawRoom"===w.mode||"drawWall"===w.mode||"drawColumn"===w.mode)&&i.drawingPoints.length>0){l.beginPath(),l.moveTo(i.drawingPoints[0].x,i.drawingPoints[0].y);for(let e=1;e<i.drawingPoints.length;e++)l.lineTo(i.drawingPoints[e].x,i.drawingPoints[e].y);l.lineTo(i.endPoint.x,i.endPoint.y),l.strokeStyle="#38bdf8",l.lineWidth=2/i.zoomLevel,l.stroke()}else if("drawColumnRect"===w.mode){let e=Math.min(i.startPoint.x,i.endPoint.x),t=Math.max(i.startPoint.x,i.endPoint.x),n=Math.min(i.startPoint.y,i.endPoint.y),a=Math.max(i.startPoint.y,i.endPoint.y);l.strokeStyle="#94a3b8",l.lineWidth=2/i.zoomLevel,l.strokeRect(e,n,t-e,a-n)}}if(i.snappedPoint){let e=6/i.zoomLevel,t=i.snappedPoint;"boundary"===i.snappedType?(l.strokeStyle="#38bdf8",l.lineWidth=2/i.zoomLevel,l.strokeRect(t.x-e,t.y-e,2*e,2*e)):("inner"===i.snappedType?(l.strokeStyle="#a78bfa",l.lineWidth=2/i.zoomLevel,l.beginPath(),l.moveTo(t.x,t.y-1.3*e),l.lineTo(t.x+1.3*e,t.y),l.lineTo(t.x,t.y+1.3*e),l.lineTo(t.x-1.3*e,t.y),l.closePath()):"wall"===i.snappedType?(l.strokeStyle="#60a5fa",l.lineWidth=2/i.zoomLevel,l.beginPath(),l.moveTo(t.x,t.y-1.3*e),l.lineTo(t.x+1.3*e,t.y+1.3*e),l.lineTo(t.x-1.3*e,t.y+1.3*e),l.closePath()):(l.beginPath(),l.arc(t.x,t.y,1.1*e,0,2*Math.PI),l.strokeStyle="#facc15",l.lineWidth=2/i.zoomLevel),l.stroke())}l.restore()},[k,w]);(0,i.useEffect)(()=>{o.current.isOrthoMode=w.isOrtho,G()},[w.isOrtho,G]),(0,i.useEffect)(()=>{S()},[S]),(0,i.useEffect)(()=>{let e=K(),t=v.current;e&&(e.segments.forEach(e=>{e.thicknessCm&&e.thicknessCm!==t||(e.thicknessCm=w.wallThicknessDefault)}),G()),v.current=w.wallThicknessDefault},[w.wallThicknessDefault,G]),(0,i.useEffect)(()=>{G()},[w.imageOpacity,w.fillColor,w.fillOpacity,w.boundaryFillColor,w.boundaryFillOpacity,w.boundaryLineScale,w.innerLineScale,w.wallLineScale,w.mode,w.wallThicknessDefault,k,G]);let Z=e=>{o.current.selected=e,P(e)},J=(0,i.useCallback)(()=>{let e=o.current;if(e.drawingPoints.length>=3){let t=e.isOrthoMode||e.usedOrthoDuringDraw?U(H(e.drawingPoints)):[...e.drawingPoints];if(t.length>2){let n=t[0],l=t[t.length-1],i=8/e.zoomLevel;z(n,l)<i&&t.pop()}let n={id:y(),points:t,segments:Array.from({length:t.length},()=>({wallType:"wall",thicknessCm:w.wallThicknessDefault})),isBoundary:!0};e.wallPaths=e.wallPaths.filter(e=>!e.isBoundary),e.wallPaths.push(n),e.windows=[],b(e=>({...e,infoText:`外框建立完成。`})),S()}e.drawingPoints=[],e.drawing=!1,G()},[G,w.wallThicknessDefault,S]),Q=(0,i.useCallback)(()=>{let e=o.current;if(e.drawingPoints.length>=2){let t=prompt("請輸入內牆厚度 (cm)","10"),n=t?parseFloat(t):w.wallThicknessDefault,l=Number.isFinite(n)&&n>0?n:w.wallThicknessDefault,i=(e.isOrthoMode||e.usedOrthoDuringDraw?U(e.drawingPoints):[...e.drawingPoints]).map(e=>_(e,!0)),a=K(),r=1;if(a&&i.length>=2){let e=i[0],t=i[1],n=t.x-e.x,l=t.y-e.y,s=Math.sqrt(n*n+l*l)||1,o={x:-l/s,y:n/s},d={x:(e.x+t.x)/2,y:(e.y+t.y)/2};r=O({x:d.x+6*o.x,y:d.y+6*o.y},a.points)?1:-1}let s={id:y(),points:i,segments:Array.from({length:i.length-1},()=>({wallType:"wall",thicknessCm:l})),offsetSide:r};e.wallPaths.push(s),b(e=>({...e,infoText:`內牆已新增。`})),S()}e.drawingPoints=[],e.drawing=!1,G()},[G,w.wallThicknessDefault,S]),ee=(0,i.useCallback)(()=>{let e=o.current;if(e.drawingPoints.length>=3){let t=e.isOrthoMode||e.usedOrthoDuringDraw?U(H(e.drawingPoints)):[...e.drawingPoints],n={id:y(),name:`空間 ${e.rooms.length+1}`,points:t,fillColor:w.fillColor,fillOpacity:w.fillOpacity};e.rooms.push(n),b(e=>({...e,infoText:`空間已新增。`})),S()}e.drawingPoints=[],e.drawing=!1,G()},[G,w.fillColor,w.fillOpacity,S]),et=(0,i.useCallback)(()=>{let e=o.current;if(e.drawingPoints.length>=3){let t=q(e.isOrthoMode||e.usedOrthoDuringDraw?U(H(e.drawingPoints)):[...e.drawingPoints]),n={id:y(),points:t};e.columns.push(n),b(e=>({...e,infoText:`柱子已新增。`})),S()}e.drawingPoints=[],e.drawing=!1,G()},[G,S]),en=(0,i.useCallback)(()=>{let e,t,n,l,i=o.current,a=i.startPoint,r=i.endPoint,s=Math.abs(r.x-a.x),d=Math.abs(r.y-a.y);if(s<1||d<1){let r=i.scale?20*i.scale:40;s=r,d=r,e=a.x-s/2,t=a.x+s/2,n=a.y-d/2,l=a.y+d/2}else e=Math.min(a.x,r.x),t=Math.max(a.x,r.x),n=Math.min(a.y,r.y),l=Math.max(a.y,r.y);let c=q([{x:e,y:n},{x:t,y:n},{x:t,y:l},{x:e,y:l}]);i.columns.push({id:y(),points:c}),b(e=>({...e,infoText:`矩形柱子已新增。`})),S(),i.drawing=!1,G()},[G,S]),el=(0,i.useCallback)(()=>{let e=o.current;if(k){if("furniture"===k.kind)e.furniture=e.furniture.filter(e=>e.id!==k.id);else if("window"===k.kind)e.windows=e.windows.filter(e=>e.id!==k.id);else if("room"===k.kind)e.rooms=e.rooms.filter(e=>e.id!==k.id);else if("column"===k.kind)e.columns=e.columns.filter(e=>e.id!==k.id);else if("wall"===k.kind){let t=e.wallPaths.find(e=>e.id===k.pathId);t?.isBoundary?(e.wallPaths=e.wallPaths.filter(e=>e.id!==t.id),e.windows=[]):e.wallPaths=e.wallPaths.filter(e=>e.id!==k.pathId)}Z(null),S(),G()}},[k,G,S]),ei=(0,i.useCallback)((e,t)=>{if(!k||"wall"!==k.kind)return;let n=o.current.wallPaths.find(e=>e.id===k.pathId);if(!n||!n.isBoundary)return;let l=n.points,i=l.length,a=k.segmentIndex%i,r=e=>.5>Math.abs(l[e].y-l[(e+1)%i].y),s=e=>.5>Math.abs(l[e].x-l[(e+1)%i].x),d=s(a),c=(e,t,n)=>{e>t?n.min=Math.max(n.min,t):e<t&&(n.max=Math.min(n.max,t))},u=(e,t,n,a)=>{let r=n,s=0;for(;s<i&&(l[r][e]=t,r!==a);)r=(r+1)%i,s++};if(d&&("left"===e||"right"===e)){let n=a,r=0;for(;r<i&&s((n-1+i)%i);)n=(n-1+i)%i,r++;let o=a;for(r=0;r<i&&s((o+1)%i);)o=(o+1)%i,r++;let d=n,m=(o+1)%i,x=l[d].x,h=l[(d-1+i)%i],p=l[(m+1)%i],g=x+("left"===e?-t:t),f={min:-1/0,max:1/0};c(x,h.x,f),c(x,p.x,f),g<f.min&&(g=f.min),g>f.max&&(g=f.max);let y=g-x;if(!Number.isFinite(y)||1e-4>Math.abs(y))return;u("x",g,d,m)}else{if(d||"up"!==e&&"down"!==e)return;let n=a,s=0;for(;s<i&&r((n-1+i)%i);)n=(n-1+i)%i,s++;let o=a;for(s=0;s<i&&r((o+1)%i);)o=(o+1)%i,s++;let m=n,x=(o+1)%i,h=l[m].y,p=l[(m-1+i)%i],g=l[(x+1)%i],f=h+("up"===e?-t:t),y={min:-1/0,max:1/0};c(h,p.y,y),c(h,g.y,y),f<y.min&&(f=y.min),f>y.max&&(f=y.max);let w=f-h;if(!Number.isFinite(w)||1e-4>Math.abs(w))return;u("y",f,m,x)}G()},[k,G]);(0,i.useEffect)(()=>{let e=e=>{if(!(document.activeElement?.tagName==="INPUT"||document.activeElement?.tagName==="TEXTAREA"||document.activeElement?.isContentEditable)){if("Shift"===e.key&&(o.current.isShiftPressed=!0),"Alt"===e.key&&(o.current.isAltPressed=!0),"Space"===e.code&&(o.current.isSpacePressed=!0),(e.ctrlKey||e.metaKey)&&"z"===e.key.toLowerCase()){C(),e.preventDefault();return}if((e.ctrlKey||e.metaKey)&&"c"===e.key.toLowerCase()){M(),e.preventDefault();return}if((e.ctrlKey||e.metaKey)&&"v"===e.key.toLowerCase()){T(),e.preventDefault();return}if("Escape"===e.key){let e=o.current;(e.drawing||e.drawingPoints.length>0)&&(e.drawingPoints=[],e.drawing=!1),b(e=>({...e,mode:"select",infoText:"已進入選取模式"})),G();return}if("Delete"===e.key||"Backspace"===e.key){el(),e.preventDefault();return}if("Enter"===e.code&&("drawBoundary"===w.mode&&J(),"drawWall"===w.mode&&Q(),"drawRoom"===w.mode&&ee(),"drawColumn"===w.mode&&et(),"drawColumnRect"===w.mode&&en()),e.key.startsWith("Arrow")){let t=(e.shiftKey?3:.5)/o.current.zoomLevel;"ArrowLeft"===e.key&&ei("left",t),"ArrowRight"===e.key&&ei("right",t),"ArrowUp"===e.key&&ei("up",t),"ArrowDown"===e.key&&ei("down",t),e.preventDefault()}}},t=e=>{"Shift"===e.key&&(o.current.isShiftPressed=!1),"Alt"===e.key&&(o.current.isAltPressed=!1),"Space"===e.code&&(o.current.isSpacePressed=!1)};return window.addEventListener("keydown",e),window.addEventListener("keyup",t),()=>{window.removeEventListener("keydown",e),window.removeEventListener("keyup",t)}},[J,Q,ee,et,en,w.mode,G,el,ei,C,M,T]);let ea=e=>{let t=o.current,n="measureLine"===w.mode||"setScale"===w.mode,l=(n?26:20)/t.zoomLevel,i=null,a=null,r=t=>{let n=z(e,t);n<l&&(l=n,i=t,a="vertex")};if(n){if(!t.isAltPressed){t.snappedPoint=null,t.snappedType=null;return}let n=K();if(n)for(let t=0;t<n.points.length;t++){let r=n.points[t],s=n.points[(t+1)%n.points.length],o=E(e,r,s);o<l&&(l=o,i=R(e,r,s).point,a="boundary")}let s=V()?.polygon;if(s&&s.length>=2)for(let t=0;t<s.length;t++){let n=s[t],r=s[(t+1)%s.length],o=E(e,n,r);o<l&&(l=o,i=R(e,n,r).point,a="inner")}if(t.wallPaths.forEach(t=>{if(t.isBoundary)return;let n=Math.max(0,t.points.length-1);for(let r=0;r<n;r++){let n=t.points[r],s=t.points[r+1],o=E(e,n,s);o<l&&(l=o,i=R(e,n,s).point,a="wall")}}),!i){t.wallPaths.forEach(e=>e.points.forEach(e=>r(e))),t.rooms.forEach(e=>e.points.forEach(e=>r(e))),t.columns.forEach(e=>e.points.forEach(e=>r(e))),t.drawingPoints.forEach(e=>r(e));let e=V()?.polygon;e&&e.forEach(e=>r(e))}}else{t.wallPaths.forEach(e=>e.points.forEach(e=>r(e))),t.rooms.forEach(e=>e.points.forEach(e=>r(e))),t.columns.forEach(e=>e.points.forEach(e=>r(e))),t.drawingPoints.forEach(e=>r(e));let e=V()?.polygon;e&&e.forEach(e=>r(e))}t.snappedPoint=i,t.snappedType=i?a:null},er=e=>{let t=o.current,n=K();if(!n||n.points.length<2)return null;let l=n.points;if(e.segmentIndex>=l.length)return null;let i=l[e.segmentIndex],a=l[(e.segmentIndex+1)%l.length],r=a.x-i.x,s=a.y-i.y,d=Math.sqrt(r*r+s*s)||1,c=r/d,u=s/d,m={x:-u,y:c},x={x:i.x+r*e.t,y:i.y+s*e.t},h=O({x:x.x+2*m.x,y:x.y+2*m.y},n.points)?m:{x:-m.x,y:-m.y},p=t.scale?(n.segments[e.segmentIndex]?.thicknessCm??w.wallThicknessDefault)*t.scale:12,g=t.scale?e.widthCm*t.scale:e.widthCm,f={x:x.x+h.x*(p/2),y:x.y+h.y*(p/2)},y={x:x.x-g/2*c,y:x.y-g/2*u},b={x:x.x+g/2*c,y:x.y+g/2*u};return{center:f,ux:c,uy:u,inward:h,widthPx:g,thicknessPx:p,start:y,end:b,segmentLength:d}},es=e=>{let t=K();if(!t||t.points.length<2)return;let n=t.points;if(e.segmentIndex>=n.length)return;let l=z(n[e.segmentIndex],n[(e.segmentIndex+1)%n.length])||1,i=o.current.scale??1,a=Math.max(30,l/i*.95);e.widthCm>a&&(e.widthCm=a),e.widthCm<30&&(e.widthCm=30);let r=e.widthCm*i/(2*l);r>=.5?e.t=.5:e.t=Math.min(1-r,Math.max(r,e.t))};(0,i.useEffect)(()=>{let l=()=>{if(t.current&&e.current){e.current.width=t.current.clientWidth,e.current.height=t.current.clientHeight;let l=document;if((l.fullscreenElement||l.webkitFullscreenElement)&&n.current){let t=n.current,l=e.current.width/t.naturalWidth,i=e.current.height/t.naturalHeight;o.current.zoomLevel=.9*Math.min(l,i),o.current.panOffset={x:(e.current.width||0)/2,y:(e.current.height||0)/2},b(e=>({...e,zoomDisplay:Math.round(100*o.current.zoomLevel)}))}G()}},i=()=>l(),a=new ResizeObserver(()=>l());t.current&&a.observe(t.current),window.addEventListener("resize",l),document.addEventListener("fullscreenchange",i),document.addEventListener("webkitfullscreenchange",i),l();let r=e=>{"Space"===e.code&&(o.current.isSpacePressed=!0)},s=e=>{"Space"===e.code&&(o.current.isSpacePressed=!1)};return window.addEventListener("keydown",r),window.addEventListener("keyup",s),()=>{a.disconnect(),window.removeEventListener("resize",l),document.removeEventListener("fullscreenchange",i),document.removeEventListener("webkitfullscreenchange",i),window.removeEventListener("keydown",r),window.removeEventListener("keyup",s)}},[G]);let eo=(()=>{if(!k||"wall"!==k.kind)return null;let e=o.current.wallPaths.find(e=>e.id===k.pathId);if(!e)return null;let t=e.segments[k.segmentIndex];return{path:e,segment:t,segmentIndex:k.segmentIndex}})(),ed=k&&"furniture"===k.kind&&o.current.furniture.find(e=>e.id===k.id)||null,ec=k&&"window"===k.kind&&o.current.windows.find(e=>e.id===k.id)||null,eu=k&&"column"===k.kind&&o.current.columns.find(e=>e.id===k.id)||null,em=V(),ex=K(),eh=o.current.scale,ep=!!eh,eg=ex&&ep?L(ex.points)/(eh*eh):null,ef=o.current.rooms.map(e=>{let t=ep?L(e.points)/(eh*eh):null;return{room:e,areaCm2:t}}),ey=(()=>{let e=o.current;if(null===e.scale)return null;let t=e.scale,n=0;return e.columns.forEach(e=>{if(e.points.length<3)return;let l=L(e.points);n+=l/(t*t)}),n})(),ew=(e=>{let t=o.current;if(!e||e.length<3||null===t.scale)return null;let n=t.scale,l=0,i=(e=>{let t=[];if(e.length<3)return t;let n=e.map((e,t)=>t),l=I(e)>0,i=(e,t,n)=>{let i=(t.x-e.x)*(n.y-e.y)-(t.y-e.y)*(n.x-e.x);return l?i>0:i<0},a=0;for(;n.length>2&&a<1e4;){a++;let l=!1;for(let a=0;a<n.length;a++){let r=n[(a-1+n.length)%n.length],s=n[a],o=n[(a+1)%n.length],d=e[r],c=e[s],u=e[o];if(!i(d,c,u))continue;let m=!1;for(let t=0;t<n.length;t++){let l=n[t];if(l!==r&&l!==s&&l!==o&&A(e[l],d,c,u)){m=!0;break}}if(!m){t.push([d,c,u]),n.splice(a,1),l=!0;break}}if(!l)break}return t})(e),a=i.length>0;return t.columns.forEach(t=>{if(t.points.length<3)return;if(!a){if(!O(F(t.points),e))return;let i=L(t.points);l+=i/(n*n);return}let r=0;i.forEach(e=>{let n=((e,t)=>{if(0===e.length)return[];let n=[...e],l=I(t)>0,i=(e,t,n)=>{let i=(n.x-t.x)*(e.y-t.y)-(n.y-t.y)*(e.x-t.x);return l?i>=-1e-4:i<=1e-4},a=(e,t,n,l)=>{let i=t.y-e.y,a=e.x-t.x,r=i*e.x+a*e.y,s=l.y-n.y,o=n.x-l.x,d=s*n.x+o*n.y,c=i*o-s*a;return 1e-5>Math.abs(c)?t:{x:(o*r-a*d)/c,y:(i*d-s*r)/c}};for(let e=0;e<t.length;e++){let l=t[e],r=t[(e+1)%t.length],s=n;if(n=[],0===s.length)break;let o=s[s.length-1];for(let e of s){let t=i(e,l,r),s=i(o,l,r);t?(s||n.push(a(o,e,l,r)),n.push(e)):s&&n.push(a(o,e,l,r)),o=e}}return n})(t.points,e);n.length>=3&&(r+=L(n))}),l+=r/(n*n)}),l})(em?.polygon??null),eb=em&&null!==ew?Math.max(0,em.areaCm2-ew):em?.areaCm2??null,ev=(()=>{let e=o.current;if(null===e.scale)return null;let t=e.scale,n=0;return e.wallPaths.forEach(e=>{if(e.isBoundary)return;let l=Math.max(0,e.points.length-1);for(let i=0;i<l;i++){let l=z(e.points[i],e.points[i+1])/t,a=e.segments[i]?.thicknessCm??w.wallThicknessDefault;n+=l*a}}),n})(),ek=em&&ep?Math.max(0,em.areaCm2-(ey||0)-(ev||0)):null,eP=e=>null!==e&&ep?`${(e/1e4).toFixed(2)} ㎡ / ${(e/33057.9).toFixed(2)} 坪`:"-",ej=(e,t)=>{b(n=>({...n,mode:e,infoText:t}))},ez=[{id:"upload",label:"Step 1 上傳平面圖",done:w.hasImage,action:"upload"},{id:"scale",label:"Step 2 設定比例尺",done:w.scaleSet,action:()=>ej("setScale","Step 2：請標出已知距離並輸入實際公分")},{id:"boundary",label:"Step 3 繪製外框",done:!!ex&&ex.points.length>=3,action:()=>ej("drawBoundary","Step 3：繪製外框（右鍵或 Enter 結束）")},{id:"rooms",label:"Step 4 繪製空間",done:o.current.rooms.length>0,action:()=>ej("drawRoom","Step 4：繪製各空間範圍")},{id:"walls",label:"Step 5 內牆（可選）",done:o.current.wallPaths.some(e=>!e.isBoundary),action:()=>ej("drawWall","Step 5：繪製內牆，可拖曳移動")},{id:"columns",label:"Step 6 柱子（可選）",done:o.current.columns.length>0,action:()=>ej("drawColumnRect","Step 6：拖拉建立矩形柱子")},{id:"windows",label:"Step 7 窗戶（可選）",done:o.current.windows.length>0,action:()=>ej("placeWindow","Step 7：點外框新增窗戶並可拖曳")},{id:"furniture",label:"Step 8 家具配置（可選）",done:o.current.furniture.length>0,action:()=>ej("placeFurniture","Step 8：拖放家具並可旋轉/縮放")}],eN="drawColumnRect"===w.mode||"drawColumn"===w.mode||!!eu,eS="placeWindow"===w.mode||!!ec,eC="placeFurniture"===w.mode||!!ed,eM=eN||eS||eC;return(0,l.jsxs)("div",{className:"flex h-full w-full gap-4",children:[(0,l.jsxs)("div",{className:"relative flex-1 min-w-0",ref:t,children:[(0,l.jsxs)("div",{className:"flex flex-wrap items-center gap-2 p-2 bg-zinc-900/80 backdrop-blur border border-white/5 rounded-xl z-10 w-full lg:absolute lg:top-4 lg:left-4 lg:right-4 shadow-xl",children:[(0,l.jsx)("input",{type:"file",id:"fp-upload",className:"hidden",accept:"image/*",onChange:t=>{let l=t.target.files?.[0];if(!l)return;let i=new FileReader;i.onload=t=>{let l=new Image;l.onload=()=>{n.current=l,o.current.panOffset={x:(e.current?.width||0)/2,y:(e.current?.height||0)/2};let t=e.current;if(t){let e=t.width/l.naturalWidth,n=t.height/l.naturalHeight;o.current.zoomLevel=.9*Math.min(e,n),b(e=>({...e,zoomDisplay:Math.round(100*o.current.zoomLevel)}))}b(e=>({...e,hasImage:!0,infoText:"圖片已載入。請設定比例尺 (Step 1)。"})),G()},l.src=t.target?.result},i.readAsDataURL(l)}}),(0,l.jsx)("label",{htmlFor:"fp-upload",className:"p-2 hover:bg-zinc-800 rounded-lg cursor-pointer text-zinc-400 hover:text-white transition-colors",title:"上傳圖片",children:(0,l.jsx)(a.A,{className:"h-5 w-5"})}),(0,l.jsx)("div",{className:"h-6 w-px bg-white/10 mx-1"}),(0,l.jsxs)("button",{onClick:()=>b(e=>({...e,mode:"setScale"})),className:(0,p.cn)("p-2 rounded-lg transition-colors flex items-center gap-2","setScale"===w.mode?"bg-cyan-600 text-white":"text-zinc-400 hover:bg-zinc-800"),disabled:!w.hasImage,title:"1. 設定比例尺（按住 Alt 吸附）",children:[(0,l.jsx)(r.A,{className:"h-5 w-5 rotate-45"}),(0,l.jsx)("span",{className:"text-xs font-bold hidden lg:block",children:"比例尺"})]}),(0,l.jsxs)("button",{onClick:()=>b(e=>({...e,mode:"measureLine"})),className:(0,p.cn)("p-2 rounded-lg transition-colors flex items-center gap-2","measureLine"===w.mode?"bg-cyan-600 text-white":"text-zinc-400 hover:bg-zinc-800"),disabled:!w.scaleSet,title:"測量長度（按住 Alt 吸附）",children:[(0,l.jsx)(s.A,{className:"h-5 w-5"}),(0,l.jsx)("span",{className:"text-xs font-bold hidden lg:block",children:"測距"})]}),(0,l.jsxs)("button",{onClick:()=>b(e=>({...e,mode:"drawBoundary"})),className:(0,p.cn)("p-2 rounded-lg transition-colors flex items-center gap-2","drawBoundary"===w.mode?"bg-violet-600 text-white":"text-zinc-400 hover:bg-zinc-800"),title:"外框（牆）",children:[(0,l.jsx)(d,{className:"h-5 w-5"}),(0,l.jsx)("span",{className:"text-xs font-bold hidden lg:block",children:"外框"})]}),(0,l.jsxs)("button",{onClick:()=>b(e=>({...e,mode:"drawRoom"})),className:(0,p.cn)("p-2 rounded-lg transition-colors flex items-center gap-2","drawRoom"===w.mode?"bg-emerald-600 text-white":"text-zinc-400 hover:bg-zinc-800"),title:"空間範圍",children:[(0,l.jsx)(d,{className:"h-5 w-5"}),(0,l.jsx)("span",{className:"text-xs font-bold hidden lg:block",children:"空間"})]}),(0,l.jsxs)("button",{onClick:()=>b(e=>({...e,mode:"drawWall"})),className:(0,p.cn)("p-2 rounded-lg transition-colors flex items-center gap-2","drawWall"===w.mode?"bg-sky-600 text-white":"text-zinc-400 hover:bg-zinc-800"),title:"內牆",children:[(0,l.jsx)(d,{className:"h-5 w-5"}),(0,l.jsx)("span",{className:"text-xs font-bold hidden lg:block",children:"內牆"})]}),(0,l.jsxs)("button",{onClick:()=>b(e=>({...e,mode:"drawColumnRect"})),className:(0,p.cn)("p-2 rounded-lg transition-colors flex items-center gap-2","drawColumn"===w.mode||"drawColumnRect"===w.mode?"bg-slate-500 text-white":"text-zinc-400 hover:bg-zinc-800"),title:"柱子（矩形）",children:[(0,l.jsx)(c,{className:"h-5 w-5"}),(0,l.jsx)("span",{className:"text-xs font-bold hidden lg:block",children:"柱子"})]}),(0,l.jsxs)("button",{onClick:()=>b(e=>({...e,mode:"placeWindow"})),className:(0,p.cn)("p-2 rounded-lg transition-colors flex items-center gap-2","placeWindow"===w.mode?"bg-cyan-600 text-white":"text-zinc-400 hover:bg-zinc-800"),title:"窗戶",children:[(0,l.jsx)(u,{className:"h-5 w-5"}),(0,l.jsx)("span",{className:"text-xs font-bold hidden lg:block",children:"窗戶"})]}),(0,l.jsxs)("button",{onClick:()=>b(e=>({...e,mode:"placeFurniture"})),className:(0,p.cn)("p-2 rounded-lg transition-colors flex items-center gap-2","placeFurniture"===w.mode?"bg-amber-600 text-white":"text-zinc-400 hover:bg-zinc-800"),title:"放置家具",children:[(0,l.jsx)("span",{className:"text-xs font-bold hidden lg:block",children:"家具"}),(0,l.jsx)("span",{className:"text-xs font-bold",children:"+F"})]}),(0,l.jsxs)("button",{onClick:()=>b(e=>({...e,mode:"select"})),className:(0,p.cn)("p-2 rounded-lg transition-colors flex items-center gap-2","select"===w.mode?"bg-slate-600 text-white":"text-zinc-400 hover:bg-zinc-800"),title:"選取/編輯",children:[(0,l.jsx)(r.A,{className:"h-5 w-5"}),(0,l.jsx)("span",{className:"text-xs font-bold hidden lg:block",children:"選取"})]}),(0,l.jsx)("div",{className:"h-6 w-px bg-white/10 mx-1"}),(0,l.jsxs)("button",{onClick:()=>b(e=>({...e,isOrtho:!e.isOrtho})),className:(0,p.cn)("p-2 rounded-lg transition-colors flex items-center gap-2",w.isOrtho?"bg-purple-600 text-white":"text-zinc-400 hover:bg-zinc-800"),title:"垂直/水平鎖定 (Shift)",children:[(0,l.jsx)(r.A,{className:"h-5 w-5"}),(0,l.jsx)("span",{className:"text-xs font-bold hidden lg:block",children:"正交"})]}),(0,l.jsx)("div",{className:"h-6 w-px bg-white/10 mx-1"}),(0,l.jsx)("button",{onClick:()=>{o.current.zoomLevel=Math.min(1.1*o.current.zoomLevel,5),b(e=>({...e,zoomDisplay:Math.round(100*o.current.zoomLevel)})),G()},className:"p-2 text-zinc-400 hover:bg-zinc-800 rounded-lg transition-colors",title:"放大",children:(0,l.jsx)(m.A,{className:"h-5 w-5"})}),(0,l.jsx)("button",{onClick:()=>{o.current.zoomLevel=Math.max(o.current.zoomLevel/1.1,.2),b(e=>({...e,zoomDisplay:Math.round(100*o.current.zoomLevel)})),G()},className:"p-2 text-zinc-400 hover:bg-zinc-800 rounded-lg transition-colors",title:"縮小",children:(0,l.jsx)(x.A,{className:"h-5 w-5"})}),(0,l.jsx)("div",{className:"h-6 w-px bg-white/10 mx-1"}),(0,l.jsx)("button",{onClick:()=>{confirm("清除所有繪製？")&&(o.current.measureLines=[],o.current.wallPaths=[],o.current.rooms=[],o.current.columns=[],o.current.windows=[],o.current.furniture=[],o.current.scale=null,Z(null),b(e=>({...e,scaleSet:!1,infoText:"已清除，請重新設定比例尺"})),S(),G())},className:"p-2 text-red-400 hover:bg-red-500/10 rounded-lg transition-colors",title:"全部清除",children:(0,l.jsx)(h.A,{className:"h-5 w-5"})}),(0,l.jsxs)("div",{className:"flex items-center gap-2 pl-2",children:[(0,l.jsx)("span",{className:"text-xs text-zinc-400",children:"圖片透明度"}),(0,l.jsx)("input",{type:"range",min:.1,max:1,step:.05,value:w.imageOpacity,onChange:e=>b(t=>({...t,imageOpacity:parseFloat(e.target.value)})),className:"w-24"})]}),(0,l.jsx)("div",{className:"ml-auto flex items-center",children:(0,l.jsx)("span",{className:"text-[11px] text-zinc-300 bg-black/40 border border-white/10 rounded-full px-3 py-1 max-w-[320px] truncate",children:w.infoText})})]}),eM&&(0,l.jsxs)("div",{className:"absolute top-16 left-4 right-4 z-10 bg-zinc-900/90 border border-white/10 rounded-xl shadow-xl px-3 py-2 flex flex-nowrap items-center gap-6 overflow-x-auto overflow-y-hidden",children:[eN&&(0,l.jsxs)("div",{className:"flex items-center gap-3 shrink-0 text-xs whitespace-nowrap",children:[(0,l.jsx)("span",{className:"text-white font-semibold",children:"柱子"}),(0,l.jsx)("button",{type:"button",onClick:()=>b(e=>({...e,mode:"drawColumnRect"})),className:(0,p.cn)("rounded-lg border px-2 py-1","drawColumnRect"===w.mode?"border-slate-400/40 bg-slate-500/20 text-slate-100":"border-white/10 text-zinc-300 hover:border-white/20"),children:"矩形"}),(0,l.jsx)("button",{type:"button",onClick:()=>b(e=>({...e,mode:"drawColumn"})),className:(0,p.cn)("rounded-lg border px-2 py-1","drawColumn"===w.mode?"border-slate-400/40 bg-slate-500/20 text-slate-100":"border-white/10 text-zinc-300 hover:border-white/20"),children:"手繪"}),eu&&ep&&(0,l.jsxs)(l.Fragment,{children:[(0,l.jsxs)("label",{className:"flex items-center gap-2",children:[(0,l.jsx)("span",{className:"text-zinc-400",children:"寬"}),(0,l.jsx)("input",{type:"number",min:10,value:Number(((Math.max(...eu.points.map(e=>e.x))-Math.min(...eu.points.map(e=>e.x)))/(eh||1)).toFixed(1)),onChange:e=>{let t=parseFloat(e.target.value||"");if(!Number.isFinite(t)||!eh)return;let n=eu.points.map(e=>e.x),l=eu.points.map(e=>e.y),i=Math.min(...l),a=Math.max(...l),r=(Math.min(...n)+Math.max(...n))/2,s=t*eh;eu.points=[{x:r-s/2,y:i},{x:r+s/2,y:i},{x:r+s/2,y:a},{x:r-s/2,y:a}],G(),P(e=>e?{...e}:e)},className:"w-16 bg-zinc-900 border border-white/10 rounded px-2 py-1 text-white"})]}),(0,l.jsxs)("label",{className:"flex items-center gap-2",children:[(0,l.jsx)("span",{className:"text-zinc-400",children:"高"}),(0,l.jsx)("input",{type:"number",min:10,value:Number(((Math.max(...eu.points.map(e=>e.y))-Math.min(...eu.points.map(e=>e.y)))/(eh||1)).toFixed(1)),onChange:e=>{let t=parseFloat(e.target.value||"");if(!Number.isFinite(t)||!eh)return;let n=eu.points.map(e=>e.x),l=eu.points.map(e=>e.y),i=Math.min(...n),a=Math.max(...n),r=(Math.min(...l)+Math.max(...l))/2,s=t*eh;eu.points=[{x:i,y:r-s/2},{x:a,y:r-s/2},{x:a,y:r+s/2},{x:i,y:r+s/2}],G(),P(e=>e?{...e}:e)},className:"w-16 bg-zinc-900 border border-white/10 rounded px-2 py-1 text-white"})]}),(0,l.jsx)("button",{type:"button",onClick:()=>{o.current.columns=o.current.columns.filter(e=>e.id!==eu.id),Z(null),G()},className:"rounded-lg border border-red-500/30 text-red-200 hover:bg-red-500/10 px-2 py-1",children:"刪除"})]})]}),eS&&(0,l.jsxs)("div",{className:"flex items-center gap-3 shrink-0 text-xs whitespace-nowrap",children:[(0,l.jsx)("span",{className:"text-white font-semibold",children:"窗戶"}),(0,l.jsxs)("select",{value:w.windowType,onChange:e=>b(t=>({...t,windowType:e.target.value})),className:"bg-zinc-900 border border-white/10 rounded px-2 py-1 text-white",children:[(0,l.jsx)("option",{value:"sliding",children:"橫拉窗"}),(0,l.jsx)("option",{value:"casement",children:"推窗"})]}),(0,l.jsxs)("label",{className:"flex items-center gap-2",children:[(0,l.jsx)("span",{className:"text-zinc-400",children:"預設寬"}),(0,l.jsx)("input",{type:"number",min:30,value:w.windowWidthCm,onChange:e=>b(t=>({...t,windowWidthCm:parseFloat(e.target.value||"0")})),className:"w-16 bg-zinc-900 border border-white/10 rounded px-2 py-1 text-white"})]}),ec&&(0,l.jsxs)(l.Fragment,{children:[(0,l.jsxs)("label",{className:"flex items-center gap-2",children:[(0,l.jsx)("span",{className:"text-zinc-400",children:"選取寬"}),(0,l.jsx)("input",{type:"number",min:30,value:ec.widthInput??String(ec.widthCm),onChange:e=>{let t=e.target.value;ec.widthInput=t;let n=parseFloat(t);Number.isFinite(n)&&(ec.widthCm=n,G()),P(e=>e?{...e}:e)},onBlur:()=>{if(void 0!==ec.widthInput){let e=parseFloat(ec.widthInput);Number.isFinite(e)&&(ec.widthCm=e,es(ec)),ec.widthInput=void 0,G(),P(e=>e?{...e}:e)}},onKeyDown:e=>{"Enter"===e.key&&e.target.blur()},className:"w-16 bg-zinc-900 border border-white/10 rounded px-2 py-1 text-white"})]}),(0,l.jsx)("button",{type:"button",onClick:()=>{o.current.windows=o.current.windows.filter(e=>e.id!==ec.id),Z(null),G()},className:"rounded-lg border border-red-500/30 text-red-200 hover:bg-red-500/10 px-2 py-1",children:"刪除"})]})]}),eC&&(0,l.jsxs)("div",{className:"flex items-center gap-3 shrink-0 text-xs whitespace-nowrap",children:[(0,l.jsx)("span",{className:"text-white font-semibold",children:"家具"}),(0,l.jsx)("div",{className:"flex items-center gap-2",children:f.map(e=>(0,l.jsx)("button",{onClick:()=>b(t=>({...t,mode:"placeFurniture",selectedFurnitureType:e.type})),className:(0,p.cn)("rounded-lg border px-2 py-1",w.selectedFurnitureType===e.type&&"placeFurniture"===w.mode?"border-amber-400 bg-amber-500/10 text-amber-200":"border-white/10 text-zinc-400 hover:border-white/20"),children:e.label},e.type))}),ed&&(0,l.jsxs)("label",{className:"flex items-center gap-2",children:[(0,l.jsx)("span",{className:"text-zinc-400",children:"縮放"}),(0,l.jsx)("input",{type:"range",min:.4,max:2,step:.05,value:ed.scale,onChange:e=>{ed.scale=parseFloat(e.target.value),G(),P(e=>e?{...e}:e)},className:"w-24"})]})]})]}),(0,l.jsx)("canvas",{ref:e,className:(0,p.cn)("w-full h-full bg-zinc-950 cursor-crosshair touch-none",o.current.isPanning?"cursor-grab active:cursor-grabbing":""),onMouseDown:t=>{let n=o.current,l=e.current?.getBoundingClientRect();if(!l)return;let i=j({x:t.clientX-l.left,y:t.clientY-l.top});if(n.pointerWorld=i,0!==t.button)return;if(n.isSpacePressed){n.isPanning=!0,n.panStart={x:t.clientX,y:t.clientY};return}ea(i);let a=n.snappedPoint?{...n.snappedPoint}:i;if(("measureLine"===w.mode||"setScale"===w.mode)&&n.drawing){n.endPoint={...a},n.measureFinalizePending=!0,G();return}let r=a;if("drawWall"===w.mode&&(r=_(r,!0)),("drawBoundary"===w.mode||"drawWall"===w.mode||"drawRoom"===w.mode||"drawColumn"===w.mode)&&(n.isShiftPressed||n.isOrthoMode)&&n.drawingPoints.length>0){let e=n.drawingPoints[n.drawingPoints.length-1];n.startPoint=Y(e,r)}else n.startPoint=r;if("select"===w.mode||"placeFurniture"===w.mode||"placeWindow"===w.mode){if(((e,t)=>{let n,l,i,a,r=o.current,s=(e=>{let t=o.current,n=12/t.zoomLevel;for(let l of t.windows){let t=er(l);if(!t)continue;let i=z(e,t.start),a=z(e,t.end);if(i<n)return{window:l,handle:"start"};if(a<n)return{window:l,handle:"end"}}return null})(e);if(s){let{window:e,handle:t}=s,n=K();if(n){let l=z(n.points[e.segmentIndex],n.points[(e.segmentIndex+1)%n.points.length])||1,i=o.current.scale??1,a=e.widthCm*i/(2*l);return r.dragStartWindow={startT:e.t-a,endT:e.t+a,segmentIndex:e.segmentIndex},r.draggingWindowId=e.id,r.draggingWindowHandle=t,Z({kind:"window",id:e.id}),G(),!0}}let d=(e=>{let t=o.current,n=6/t.zoomLevel;for(let l of t.windows){let t=er(l);if(!t)continue;let i=e.x-t.center.x,a=e.y-t.center.y,r=i*t.ux+a*t.uy,s=i*t.inward.x+a*t.inward.y;if(Math.abs(r)<=t.widthPx/2+n&&Math.abs(s)<=t.thicknessPx/2+n)return l}return null})(e);if(d)return Z({kind:"window",id:d.id}),r.draggingWindowId=d.id,r.draggingWindowHandle=null,G(),!0;let c=(e=>{for(let t of o.current.furniture){let n=X(t);if(e.x>=n.minX&&e.x<=n.maxX&&e.y>=n.minY&&e.y<=n.maxY)return t}return null})(e);if(c)return Z({kind:"furniture",id:c.id}),r.draggingFurnitureId=c.id,r.dragStartMouse={x:e.x,y:e.y},r.dragStartFurniturePos={...c.position},G(),!0;let u=(e=>{let t=o.current;if(!k||"column"!==k.kind)return null;let n=t.columns.find(e=>e.id===k.id);if(!n)return null;let l=D(n.points),i=8/t.zoomLevel;for(let t of[{handle:"nw",x:l.minX,y:l.minY},{handle:"ne",x:l.maxX,y:l.minY},{handle:"se",x:l.maxX,y:l.maxY},{handle:"sw",x:l.minX,y:l.maxY}])if(z(e,{x:t.x,y:t.y})<=i)return{column:n,handle:t.handle,bounds:l};return null})(e);if(u){let{column:t,handle:n,bounds:l}=u;return Z({kind:"column",id:t.id}),r.draggingColumnResize={id:t.id,handle:n,startBounds:l,startPoints:t.points.map(e=>({...e})),startMouse:{x:e.x,y:e.y}},G(),!0}let m=(e=>{for(let t of o.current.columns)if(O(e,t.points))return t;return null})(e);if(m)return Z({kind:"column",id:m.id}),r.draggingColumnId=m.id,r.dragStartMouse={x:e.x,y:e.y},r.dragStartColumnPoints=m.points.map(e=>({...e})),G(),!0;let x=(l=10/(n=o.current).zoomLevel,i=null,a=l,n.wallPaths.forEach(t=>{let n=t.isBoundary?t.points.length:t.points.length-1;for(let l=0;l<n;l++){let n=t.points[l],r=t.points[(l+1)%t.points.length],s=E(e,n,r);if(s<a){a=s;let o=R(e,n,r);i={pathId:t.id,segmentIndex:l,point:o.point}}}}),i);if(x){Z({kind:"wall",pathId:x.pathId,segmentIndex:x.segmentIndex});let t=r.wallPaths.find(e=>e.id===x.pathId);return t&&!t.isBoundary&&(r.draggingWallPathId=t.id,r.dragStartWallMouse={x:e.x,y:e.y},r.dragStartWallPoints=t.points.map(e=>({...e}))),G(),!0}let h=(e=>{for(let t of o.current.rooms)if(O(e,t.points))return t;return null})(e);return!!h&&(Z({kind:"room",id:h.id}),r.draggingRoomId=h.id,r.dragStartMouse={x:e.x,y:e.y},r.dragStartRoomPoints=h.points.map(e=>({...e})),G(),!0)})(i,0))return;if("select"===w.mode){Z(null),G();return}}if("drawWall"===w.mode){n.drawing=!0,0===n.drawingPoints.length&&(n.usedOrthoDuringDraw=!1),n.drawingPoints.push(n.startPoint),n.endPoint={...n.startPoint},n.drawingPoints.length>=2?Q():G();return}if("drawBoundary"===w.mode||"drawRoom"===w.mode||"drawColumn"===w.mode){n.drawing=!0,0===n.drawingPoints.length&&(n.usedOrthoDuringDraw=!1),n.drawingPoints.push(n.startPoint),n.endPoint={...n.startPoint},G();return}if("drawColumnRect"===w.mode){n.drawing=!0,n.usedOrthoDuringDraw=!1,n.endPoint={...n.startPoint},G();return}if("placeWindow"===w.mode){let e=(e=>{let t=o.current,n=K();if(!n)return null;let l=1/0,i=null,a=n.points.length,r=V()?.polygon,s=r&&r.length===a;for(let o=0;o<a;o++){let d=n.points[o],c=n.points[(o+1)%a],u=E(e,d,c),m=u,x=t.scale?(n.segments[o]?.thicknessCm??w.wallThicknessDefault)*t.scale:12,h=Math.max(12/t.zoomLevel,1.2*x);if(s&&(m=Math.min(u,E(e,r[o],r[(o+1)%a]))),m<=h&&m<l){l=m;let t=R(e,d,c);i={segmentIndex:o,point:t.point,t:t.t}}}return i})(i),t=K();if(!t)return void b(e=>({...e,infoText:"請先繪製外框再放置窗戶"}));if(e){let l={id:y(),pathId:t.id,segmentIndex:e.segmentIndex,t:e.t,widthCm:w.windowWidthCm,type:w.windowType};es(l),n.windows.push(l),Z({kind:"window",id:l.id}),G()}return}if("placeFurniture"===w.mode){let e={id:y(),type:w.selectedFurnitureType,position:n.startPoint,rotation:0,scale:1};n.furniture.push(e),Z({kind:"furniture",id:e.id}),G();return}("measureLine"===w.mode||"setScale"===w.mode)&&(n.activeMeasureMode=w.mode,n.drawing=!0,n.measureFinalizePending=!1,n.endPoint={...n.startPoint},G())},onMouseMove:t=>{let n=o.current,l=e.current?.getBoundingClientRect();if(!l)return;let i=t.clientX-l.left,a=t.clientY-l.top;if(n.isPanning){let e=t.clientX-n.panStart.x,l=t.clientY-n.panStart.y;n.panOffset.x+=e,n.panOffset.y+=l,n.panStart={x:t.clientX,y:t.clientY},G();return}let r=j({x:i,y:a});if("select"===w.mode){if(n.draggingFurnitureId){let e=n.furniture.find(e=>e.id===n.draggingFurnitureId);e&&(e.position={x:n.dragStartFurniturePos.x+(r.x-n.dragStartMouse.x),y:n.dragStartFurniturePos.y+(r.y-n.dragStartMouse.y)},G());return}if(n.draggingWindowId){let e=n.windows.find(e=>e.id===n.draggingWindowId),t=K();if(e&&t){let l=t.points[e.segmentIndex],i=t.points[(e.segmentIndex+1)%t.points.length],a=R(r,l,i);if(n.draggingWindowHandle&&n.dragStartWindow){let t=n.dragStartWindow.startT,r=n.dragStartWindow.endT;if("start"===n.draggingWindowHandle?t=a.t:r=a.t,t>r){let e=t;t=r,r=e}let s=z(l,i)||1,o=n.scale??1;r-t<.02&&(r=t+.02),e.t=(t+r)/2,e.widthCm=(r-t)*s/o}else if(n.isShiftPressed){let t=z(l,i)||1,r=n.scale??1,s=Math.max(.02,Math.abs(a.t-e.t));e.widthCm=2*s*t/r}else e.t=a.t;es(e),G()}return}if(n.draggingRoomId){let e=n.rooms.find(e=>e.id===n.draggingRoomId);if(e){let t=r.x-n.dragStartMouse.x,l=r.y-n.dragStartMouse.y;e.points=n.dragStartRoomPoints.map(e=>({x:e.x+t,y:e.y+l})),G()}return}if(n.draggingColumnResize){let e=n.columns.find(e=>e.id===n.draggingColumnResize?.id);if(e){let{handle:t,startBounds:l,startPoints:i,startMouse:a}=n.draggingColumnResize,s=r.x-a.x,o=r.y-a.y,d=l.minX,c=l.maxX,u=l.minY,m=l.maxY;t.includes("w")&&(d+=s),t.includes("e")&&(c+=s),t.includes("n")&&(u+=o),t.includes("s")&&(m+=o);let x=10/n.zoomLevel;c-d<x&&(t.includes("w")&&(d=c-x),t.includes("e")&&(c=d+x)),m-u<x&&(t.includes("n")&&(u=m-x),t.includes("s")&&(m=u+x));let h=(c-d)/(l.maxX-l.minX||1),p=(m-u)/(l.maxY-l.minY||1);e.points=i.map(e=>({x:d+(e.x-l.minX)*h,y:u+(e.y-l.minY)*p})),G()}return}if(n.draggingColumnId){let e=n.columns.find(e=>e.id===n.draggingColumnId);if(e){let t=r.x-n.dragStartMouse.x,l=r.y-n.dragStartMouse.y;e.points=n.dragStartColumnPoints.map(e=>({x:e.x+t,y:e.y+l})),G()}return}if(n.draggingWallPathId){let e=n.wallPaths.find(e=>e.id===n.draggingWallPathId);if(e){let t=r.x-n.dragStartWallMouse.x,l=r.y-n.dragStartWallMouse.y;e.points=n.dragStartWallPoints.map(e=>({x:e.x+t,y:e.y+l})),G()}return}}ea(r);let s=n.snappedPoint?{...n.snappedPoint}:r;if(n.drawing&&(n.isShiftPressed||n.isOrthoMode)){n.usedOrthoDuringDraw=!0;let e=n.startPoint;("drawBoundary"===w.mode||"drawWall"===w.mode||"drawRoom"===w.mode||"drawColumn"===w.mode)&&n.drawingPoints.length>0&&(e=n.drawingPoints[n.drawingPoints.length-1]),s=Y(e,s)}n.endPoint=s,G()},onMouseUp:()=>{let e=o.current;if(e.isPanning){e.isPanning=!1;return}if(e.draggingFurnitureId){e.draggingFurnitureId=null,S();return}if(e.draggingWindowId){e.draggingWindowId=null,e.draggingWindowHandle=null,e.dragStartWindow=null,S();return}if(e.draggingRoomId){e.draggingRoomId=null,e.dragStartRoomPoints=[],S();return}if(e.draggingColumnResize){let t=e.columns.find(t=>t.id===e.draggingColumnResize?.id);t&&(t.points=q(t.points)),e.draggingColumnResize=null,S();return}if(e.draggingColumnId){let t=e.columns.find(t=>t.id===e.draggingColumnId);t&&(t.points=q(t.points)),e.draggingColumnId=null,e.dragStartColumnPoints=[],S();return}if(e.draggingWallPathId){let t=e.wallPaths.find(t=>t.id===e.draggingWallPathId);t&&(t.points=t.points.map(e=>_(e,!0))),e.draggingWallPathId=null,e.dragStartWallPoints=[],S();return}if(!e.drawing)return;if("drawBoundary"===w.mode){if(e.drawingPoints.length>=2){let t=e.drawingPoints[0],n=15/e.zoomLevel;z(e.endPoint,t)<n&&J()}return}if("drawRoom"===w.mode){if(e.drawingPoints.length>=2){let t=e.drawingPoints[0],n=15/e.zoomLevel;z(e.endPoint,t)<n&&ee()}return}if("drawColumn"===w.mode){if(e.drawingPoints.length>=2){let t=e.drawingPoints[0],n=15/e.zoomLevel;z(e.endPoint,t)<n&&et()}return}if("drawColumnRect"===w.mode)return void en();if("drawWall"===w.mode){1===e.drawingPoints.length&&z(e.startPoint,e.endPoint)>1/e.zoomLevel&&(e.drawingPoints.push(e.endPoint),Q());return}let t=z(e.startPoint,e.endPoint);if("measureLine"===w.mode||"setScale"===w.mode){let n=3/e.zoomLevel;if(!e.measureFinalizePending&&t<n){e.drawing=!0,G();return}}else if(t<1/e.zoomLevel)return;let n=e.activeMeasureMode||w.mode,l={...e.startPoint},i={...e.endPoint};if("setScale"===n){let n=parseFloat(prompt("請輸入這段距離的實際長度(公分) e.g. 100","100")||"");n>0&&(e.scale=t/n,e.measureLines.push({type:"line",pixelStart:l,pixelEnd:i,color:"#06b6d4"}),b(t=>({...t,scaleSet:!0,mode:null,infoText:`比例尺已設定: ${(e.scale||0).toFixed(2)} px/cm`})))}else"measureLine"===n&&e.measureLines.push({type:"line",pixelStart:l,pixelEnd:i,color:"#facc15"});e.drawing=!1,e.activeMeasureMode=null,e.measureFinalizePending=!1,G()},onContextMenu:e=>{e.preventDefault();let t=o.current;"drawBoundary"===w.mode?J():"drawWall"===w.mode?Q():"drawRoom"===w.mode?ee():"drawColumn"===w.mode?et():"drawColumnRect"===w.mode?en():(t.drawingPoints=[],t.drawing=!1,G())}}),(0,l.jsx)("div",{className:"absolute bottom-4 left-4 text-[10px] text-zinc-500 pointer-events-none bg-black/40 p-2 rounded-lg backdrop-blur-sm border border-white/5",children:(0,l.jsx)("p",{children:"Esc: 選取 | Delete: 刪除 | 左鍵: 繪圖 | 右鍵/Enter: 結束 | Shift: 正交/調整窗寬 | 方向鍵: 微調外牆段 | Shift+方向鍵: 快速微調 | 空白鍵: 平移 | Alt(量測時): 吸附 | Ctrl/Cmd+Z: 復原 | Ctrl/Cmd+C/V: 複製/貼上 | 拖曳: 內牆/窗戶/空間/柱子"})})]}),(0,l.jsxs)("div",{className:"w-80 shrink-0 h-full overflow-y-auto bg-zinc-900/80 border border-white/5 rounded-xl shadow-xl p-4 space-y-4",children:[(0,l.jsxs)("div",{children:[(0,l.jsx)("h3",{className:"text-sm font-semibold text-white",children:"使用流程"}),(0,l.jsx)("div",{className:"mt-2 space-y-2 text-xs",children:ez.map(e=>(0,l.jsxs)("div",{className:"flex items-center justify-between gap-2",children:[(0,l.jsxs)("div",{className:"flex items-center gap-2",children:[(0,l.jsx)("span",{className:(0,p.cn)("h-2.5 w-2.5 rounded-full",e.done?"bg-emerald-400":"bg-zinc-600")}),(0,l.jsx)("span",{className:e.done?"text-emerald-200":"text-zinc-300",children:e.label})]}),"upload"===e.action?(0,l.jsx)("label",{htmlFor:"fp-upload",className:"cursor-pointer rounded-full border border-white/10 px-2 py-0.5 text-[11px] text-zinc-300 hover:border-white/20",children:"上傳"}):(0,l.jsx)("button",{type:"button",onClick:e.action,className:"rounded-full border border-white/10 px-2 py-0.5 text-[11px] text-zinc-300 hover:border-white/20",children:"前往"})]},e.id))})]}),(0,l.jsxs)("div",{children:[(0,l.jsx)("h3",{className:"text-sm font-semibold text-white",children:"圖面備註"}),(0,l.jsxs)("div",{className:"mt-2 space-y-2 text-xs",children:[(0,l.jsxs)("label",{className:"flex items-center justify-between gap-2",children:[(0,l.jsx)("span",{className:"text-zinc-400",children:"圖面類型"}),(0,l.jsxs)("select",{value:w.planType,onChange:e=>b(t=>({...t,planType:e.target.value})),className:"bg-zinc-900 border border-white/10 rounded px-2 py-1 text-white",children:[(0,l.jsx)("option",{value:"indoor",children:"家配圖（室內）"}),(0,l.jsx)("option",{value:"public",children:"公設圖"})]})]}),(0,l.jsxs)("div",{children:[(0,l.jsx)("span",{className:"text-zinc-400",children:"備註"}),(0,l.jsx)("textarea",{value:w.planNote,onChange:e=>b(t=>({...t,planNote:e.target.value})),rows:2,className:"mt-1 w-full bg-zinc-900 border border-white/10 rounded px-2 py-1 text-white text-xs",placeholder:"例如：客變版本 / 家配圖"})]})]})]}),(0,l.jsxs)("div",{children:[(0,l.jsx)("h3",{className:"text-sm font-semibold text-white",children:"外框 / 淨面積"}),(0,l.jsx)("p",{className:"text-xs text-zinc-400",children:"外框牆厚可在選取牆段後調整"}),(0,l.jsxs)("div",{className:"mt-2 flex items-center justify-between text-xs",children:[(0,l.jsx)("span",{className:"text-zinc-400",children:"預設牆厚 (cm)"}),(0,l.jsx)("input",{type:"number",min:1,value:w.wallThicknessDefault,onChange:e=>b(t=>({...t,wallThicknessDefault:parseFloat(e.target.value||"0")})),className:"w-20 bg-zinc-900 border border-white/10 rounded px-2 py-1 text-white"})]}),(0,l.jsxs)("div",{className:"mt-2 flex items-center justify-between text-xs",children:[(0,l.jsx)("span",{className:"text-zinc-400",children:"外框填色"}),(0,l.jsx)("input",{type:"color",value:w.boundaryFillColor,onChange:e=>b(t=>({...t,boundaryFillColor:e.target.value})),className:"h-6 w-10 bg-transparent border border-white/10 rounded"})]}),(0,l.jsxs)("div",{className:"mt-2 flex items-center justify-between text-xs",children:[(0,l.jsx)("span",{className:"text-zinc-400",children:"外框透明度"}),(0,l.jsx)("input",{type:"range",min:0,max:.6,step:.05,value:w.boundaryFillOpacity,onChange:e=>b(t=>({...t,boundaryFillOpacity:parseFloat(e.target.value)})),className:"w-24"})]}),(0,l.jsxs)("div",{className:"mt-3 space-y-2 text-xs",children:[(0,l.jsxs)("div",{className:"flex items-center justify-between",children:[(0,l.jsx)("span",{className:"text-zinc-400",children:"外牆線粗細"}),(0,l.jsx)("input",{type:"range",min:.1,max:1.3,step:.05,value:w.boundaryLineScale,onChange:e=>b(t=>({...t,boundaryLineScale:parseFloat(e.target.value)})),className:"w-24"})]}),(0,l.jsxs)("div",{className:"flex items-center justify-between",children:[(0,l.jsx)("span",{className:"text-zinc-400",children:"內測線粗細"}),(0,l.jsx)("input",{type:"range",min:.1,max:1.3,step:.05,value:w.innerLineScale,onChange:e=>b(t=>({...t,innerLineScale:parseFloat(e.target.value)})),className:"w-24"})]}),(0,l.jsxs)("div",{className:"flex items-center justify-between",children:[(0,l.jsx)("span",{className:"text-zinc-400",children:"內牆線粗細"}),(0,l.jsx)("input",{type:"range",min:.1,max:1.3,step:.05,value:w.wallLineScale,onChange:e=>b(t=>({...t,wallLineScale:parseFloat(e.target.value)})),className:"w-24"})]})]}),ep?(0,l.jsxs)("div",{className:"mt-2 space-y-1 text-xs text-zinc-200",children:[(0,l.jsxs)("div",{children:["外框淨面積：",eP(eg)]}),(0,l.jsxs)("div",{children:["內框淨面積：",eP(eb)]}),(0,l.jsxs)("div",{children:["柱子面積：",eP(ew)]})]}):(0,l.jsx)("p",{className:"mt-2 text-xs text-zinc-500",children:"尚未設定外框或比例尺"})]}),(0,l.jsxs)("div",{children:[(0,l.jsx)("h3",{className:"text-sm font-semibold text-white",children:"房間列表"}),(0,l.jsx)("div",{className:"mt-2 space-y-2 max-h-48 overflow-auto",children:0===o.current.rooms.length?(0,l.jsx)("p",{className:"text-xs text-zinc-500",children:"尚未新增空間"}):o.current.rooms.map(e=>{let t=o.current.scale?L(e.points)/(o.current.scale*o.current.scale):null,n=null!==t?t/1e4:null,i=null!==t?t/33057.9:null;return(0,l.jsxs)("div",{className:"rounded-lg border border-white/10 bg-zinc-950/40 p-2",children:[(0,l.jsx)("input",{value:e.name,onChange:t=>{e.name=t.target.value,G(),P(t=>t&&"room"===t.kind&&t.id===e.id?{...t}:t)},className:"w-full bg-transparent text-xs text-white mb-1 outline-none border-b border-white/10"}),(0,l.jsxs)("div",{className:"text-[11px] text-zinc-400 flex flex-col gap-0.5",children:[(0,l.jsxs)("span",{children:["坪數：",null!==i?i.toFixed(2):"-"]}),(0,l.jsxs)("span",{children:["平方公尺：",null!==n?n.toFixed(2):"-"]}),(0,l.jsxs)("span",{children:["面積：",null!==t?t.toFixed(0):"-"]})]})]},e.id)})})]}),(0,l.jsxs)("div",{children:[(0,l.jsx)("h3",{className:"text-sm font-semibold text-white",children:"報表輸出"}),(0,l.jsxs)("div",{className:"mt-2 flex flex-wrap gap-2",children:[(0,l.jsx)("button",{type:"button",onClick:()=>{var t,n;let l,i=e.current;if(!i)return;let a=ef.slice(0,10),r=Math.max(0,ef.length-a.length),s=190+18*a.length+18*!!r,o=document.createElement("canvas");o.width=i.width+64,o.height=i.height+64+48+s;let d=o.getContext("2d");if(!d)return;d.fillStyle="#0b0c10",d.fillRect(0,0,o.width,o.height),d.fillStyle="#e5e7eb",d.font="bold 20px sans-serif",d.fillText("平面圖測量報表",32,52),d.font="12px sans-serif",d.fillStyle="#94a3b8",d.fillText(new Date().toLocaleString("zh-TW"),32,68),d.fillText(`圖面類型：${"public"===w.planType?"公設圖":"家配圖(室內)"}`,32,84),w.planNote.trim()&&d.fillText(`備註：${w.planNote.trim()}`,32,100),d.strokeStyle="#1f2937",d.lineWidth=2,d.strokeRect(32,80,i.width,i.height),d.drawImage(i,32,80);let c=80+i.height+28;d.fillStyle="#e5e7eb",d.font="bold 14px sans-serif",d.fillText("面積統計",32,c),c+=18,d.font="12px sans-serif";let u=e=>null==e?"-":`${(e/33057.9).toFixed(2)} 坪 / ${(e/1e4).toFixed(2)} ㎡`;d.fillStyle="#cbd5f5",d.fillText(`外框淨面積：${u(em?.areaCm2??null)}`,32,c),c+=16,d.fillText(`柱子面積：${u(ey)}`,32,c),c+=16,d.fillText(`內牆面積：${u(ev)}`,32,c),c+=16,d.fillText(`可用面積：${u(ek)}`,32,c),c+=22,d.fillStyle="#e5e7eb",d.font="bold 14px sans-serif",d.fillText("空間明細",32,c),c+=18,d.font="12px sans-serif",d.fillStyle="#cbd5f5",a.forEach(e=>{let t=e.areaCm2,n=null!==t?t/1e4:null,l=null!==t?t/33057.9:null;d.fillText(`${e.room.name} - ${null!==l?l.toFixed(2):"-"} 坪 / ${null!==n?n.toFixed(2):"-"} ㎡`,32,c),c+=16}),r&&(d.fillStyle="#94a3b8",d.fillText(`... 另有 ${r} 個空間`,32,c)),t=o.toDataURL("image/png"),n=`平面圖_報表_${Date.now()}.png`,(l=document.createElement("a")).href=t,l.download=n,l.click()},className:"rounded-lg border border-emerald-400/30 bg-emerald-500/10 px-3 py-1.5 text-xs text-emerald-200 hover:bg-emerald-500/20",children:"匯出報表 PNG"}),(0,l.jsx)("button",{type:"button",onClick:()=>{var e,t;let n,l;0!==o.current.rooms.length&&(e=new Blob(["\uFEFF"+[["名稱","坪數","平方公尺","面積cm2"],...ef.map(e=>{let t=e.room,n=e.areaCm2,l=null!==n?n/1e4:null,i=null!==n?n/33057.9:null;return[t.name,null!==i?i.toFixed(2):"",null!==l?l.toFixed(2):"",null!==n?n.toFixed(0):""]})].map(e=>e.join(",")).join("\n")],{type:"text/csv;charset=utf-8;"}),t=`平面圖_房間表_${Date.now()}.csv`,n=URL.createObjectURL(e),(l=document.createElement("a")).href=n,l.download=t,l.click(),URL.revokeObjectURL(n))},className:"rounded-lg border border-white/10 px-3 py-1.5 text-xs text-zinc-200 hover:border-white/20",children:"匯出房間表 CSV"})]})]}),eo&&(0,l.jsxs)("div",{children:[(0,l.jsx)("h3",{className:"text-sm font-semibold text-white",children:"牆段設定"}),(0,l.jsxs)("div",{className:"mt-2 space-y-2 text-xs",children:[(0,l.jsxs)("label",{className:"flex items-center justify-between gap-2",children:[(0,l.jsx)("span",{className:"text-zinc-400",children:"類型"}),(0,l.jsxs)("select",{value:eo.segment.wallType,onChange:e=>{eo.segment.wallType=e.target.value,G(),S()},className:"bg-zinc-900 border border-white/10 rounded px-2 py-1 text-white",children:[(0,l.jsx)("option",{value:"wall",children:"牆"}),(0,l.jsx)("option",{value:"window",children:"窗"}),(0,l.jsx)("option",{value:"pillar",children:"柱"})]})]}),(0,l.jsxs)("label",{className:"flex items-center justify-between gap-2",children:[(0,l.jsx)("span",{className:"text-zinc-400",children:"牆厚 (cm)"}),(0,l.jsx)("input",{type:"number",min:1,value:eo.segment.thicknessCm,onChange:e=>{let t=parseFloat(e.target.value||"0");if(eo.path.isBoundary){let e=Number.isFinite(t)&&t>0?t:eo.segment.thicknessCm;eo.segment.thicknessCm=e}else eo.segment.thicknessCm=parseFloat(e.target.value||"0");G(),S()},className:"w-20 bg-zinc-900 border border-white/10 rounded px-2 py-1 text-white"})]}),!eo.path.isBoundary&&(0,l.jsx)("button",{type:"button",onClick:()=>{eo.path.offsetSide=-((eo.path.offsetSide??1)*1),G(),S()},className:"w-full rounded-lg border border-white/10 text-zinc-200 hover:border-white/20 px-2 py-1.5",children:"翻轉內牆方向"})]})]}),ed&&(0,l.jsxs)("div",{children:[(0,l.jsx)("h3",{className:"text-sm font-semibold text-white",children:"家具設定"}),(0,l.jsxs)("div",{className:"mt-2 space-y-2 text-xs",children:[(0,l.jsxs)("label",{className:"flex items-center justify-between gap-2",children:[(0,l.jsx)("span",{className:"text-zinc-400",children:"旋轉"}),(0,l.jsx)("input",{type:"range",min:0,max:360,value:180*ed.rotation/Math.PI,onChange:e=>{ed.rotation=parseFloat(e.target.value)*Math.PI/180,G()},className:"w-32"})]}),(0,l.jsxs)("label",{className:"flex items-center justify-between gap-2",children:[(0,l.jsx)("span",{className:"text-zinc-400",children:"縮放"}),(0,l.jsx)("input",{type:"range",min:.4,max:2,step:.05,value:ed.scale,onChange:e=>{ed.scale=parseFloat(e.target.value),G()},className:"w-32"})]})]})]})]})]})}}}]);