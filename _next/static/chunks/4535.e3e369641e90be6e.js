(self.webpackChunk_N_E=self.webpackChunk_N_E||[]).push([[4535],{6296:(e,t,r)=>{"use strict";r.d(t,{A:()=>l});let l=(0,r(78340).A)("loader-circle",[["path",{d:"M21 12a9 9 0 1 1-6.219-8.56",key:"13zald"}]])},14535:(e,t,r)=>{"use strict";r.r(t),r.d(t,{default:()=>I});var l=r(95155),a=r(12115),n=r(36379),i=r.n(n);r(23879);var s=r(56572),o=r(33024),c=r(6296),u=r(16385),d=r(34198),p=r(51806),m=r(55873),x=r(27529),h=r(88743),y=r(73321),f=r(4439),g=r(41463);let b=[121.5318,25.0478],v="https://zxbmbbfrzbtuueysicoc.supabase.co/functions/v1",j=[g.env.NEXT_PUBLIC_DISTRICT_GEOJSON_URL,v?`${v}/geojson-proxy?type=district`:"","https://raw.githubusercontent.com/g0v/twgeojson/master/json/twTown1982.geo.json","https://cdn.jsdelivr.net/gh/g0v/twgeojson@master/json/twTown1982.geo.json"].filter(Boolean),N=[g.env.NEXT_PUBLIC_VILLAGE_GEOJSON_URL,v?`${v}/geojson-proxy?type=village`:"","https://raw.githubusercontent.com/g0v/twgeojson/master/json/twVillage1982.geo.json","https://cdn.jsdelivr.net/gh/g0v/twgeojson@master/json/twVillage1982.geo.json"].filter(Boolean),w=g.env.NEXT_PUBLIC_VILLAGE_WMTS_URL,z=g.env.NEXT_PUBLIC_METRO_GEOJSON_URL,S=["https://overpass-api.de/api/interpreter","https://overpass.kumi.systems/api/interpreter","https://overpass.nchc.org.tw/api/interpreter"],C=e=>e*Math.PI/180,k=(e,t)=>{let r=C(t[1]-e[1]),l=C(t[0]-e[0]);return 12742*Math.asin(Math.sqrt(Math.sin(r/2)**2+Math.cos(C(e[1]))*Math.cos(C(t[1]))*Math.sin(l/2)**2))},_=e=>e.replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/"/g,"&quot;").replace(/'/g,"&#039;"),L=e=>null==e||""===e?"-":String(e),M=e=>{if(null==e||""===e)return null;if("number"==typeof e)return Number.isFinite(e)?e:null;if("string"==typeof e){let t=e.replace(/,/g,"").trim();if(!t)return null;let r=Number(t);return Number.isFinite(r)?r:null}return null},E=(e,t)=>{for(let r of t){let t=M(e?.[r]);if(null!==t)return t}return null},A=e=>{let t=e["戶型"]||e["房型"]||e["戶別"],r=t?String(t).replace(/\s+/g,""):"";if(!r){let t=M(e["房數"]);t&&t>0&&(r=`${t}房`)}return r?/^\d+$/.test(r)?`${r}房`:r:"其他"},T=(e,t)=>{if(e){for(let r of t)if(e[r])return e[r]}},F=(e,t)=>{if(!e||"FeatureCollection"!==e.type||!Array.isArray(e.features))return e;let r=e.features.map((e,r)=>{if(!e||"Feature"!==e.type||void 0!==e.id&&null!==e.id)return e;let l=T(e.properties||{},t);return{...e,id:l??`${r}`}});return{...e,features:r}},R=e=>{if(!e?.geometry)return null;let{type:t,coordinates:r}=e.geometry,l=[],a=e=>{if(e){if("number"==typeof e[0]&&"number"==typeof e[1])return void l.push([e[0],e[1]]);e.forEach(e=>a(e))}};if("Polygon"===t||"MultiPolygon"===t||"LineString"===t||"MultiLineString"===t?a(r):"Point"===t&&l.push(r),0===l.length)return null;let n=l[0][0],i=l[0][0],s=l[0][1],o=l[0][1];return l.forEach(([e,t])=>{n=Math.min(n,e),i=Math.max(i,e),s=Math.min(s,t),o=Math.max(o,t)}),{minLng:n,minLat:s,maxLng:i,maxLat:o}},P=e=>{if(!e)return[];let t=String(e).trim();if(!t)return[];let r=new Set([t]);return t.includes("台")&&r.add(t.replace(/台/g,"臺")),t.includes("臺")&&r.add(t.replace(/臺/g,"台")),Array.from(r)},$=(e,t)=>{if(!t.length)return null;let r=t.flatMap(t=>e.flatMap(e=>[["==",["get",e],t],["in",t,["to-string",["get",e]]]]));return r.length>0?["any",...r]:null},O=async(e,t,r=8e3)=>{let l=null;for(let a of e){let e=!1;try{let l=new AbortController,n=()=>l.abort();t?.addEventListener("abort",n);let i=window.setTimeout(()=>{e=!0,l.abort()},r);try{let e=await fetch(a,{signal:l.signal,cache:"no-store"});if(!e.ok)throw Error(`GeoJSON fetch failed: ${e.status}`);return await e.json()}finally{window.clearTimeout(i),t?.removeEventListener("abort",n)}}catch(r){if(r?.name==="AbortError"){if(t?.aborted)throw r;if(e){l=r;continue}}l=r}}throw l||Error("GeoJSON fetch failed")};function I({projects:e=[],refreshToken:t,onMetaChange:r,panelCollapsed:n=!1}){let g=(0,a.useRef)(null),v=(0,a.useRef)(null),C=(0,y.useRouter)(),I=(0,h.P)(e=>e.hydrateFilters),[B,W]=(0,a.useState)(!1),D="1GYoblfxWX2uc8edFcbq",[V,U]=(0,a.useState)(D?"topo-v2":"demo"),[G,q]=(0,a.useState)(!0),[K,Y]=(0,a.useState)(!1),[H,J]=(0,a.useState)("idle"),[Z,X]=(0,a.useState)(""),[Q,ee]=(0,a.useState)([]),[et,er]=(0,a.useState)(!1),[el,ea]=(0,a.useState)(!1),[en,ei]=(0,a.useState)([]),[es,eo]=(0,a.useState)("idle"),[ec,eu]=(0,a.useState)(null),[ed,ep]=(0,a.useState)(null),[em,ex]=(0,a.useState)(0),[eh,ey]=(0,a.useState)(null),[ef,eg]=(0,a.useState)({zoning:{visible:!1,opacity:.6},cadastral:{visible:!1,opacity:.6}}),[eb,ev]=(0,a.useState)(e),[ej,eN]=(0,a.useState)(!1),[ew,ez]=(0,a.useState)(null),[eS,eC]=(0,a.useState)("idle"),[ek,e_]=(0,a.useState)(null),[eL,eM]=(0,a.useState)(12),[eE,eA]=(0,a.useState)(18),[eT,eF]=(0,a.useState)([]),[eR,eP]=(0,a.useState)([]),[e$,eO]=(0,a.useState)([]),[eI,eB]=(0,a.useState)([]),[eW,eD]=(0,a.useState)(!1),[eV,eU]=(0,a.useState)(null),[eG,eq]=(0,a.useState)([]),[eK,eY]=(0,a.useState)(!1),[eH,eJ]=(0,a.useState)(null),[eZ,eX]=(0,a.useState)([]),[eQ,e0]=(0,a.useState)(!1),[e1,e2]=(0,a.useState)(null),[e3,e5]=(0,a.useState)(!1),[e8,e4]=(0,a.useState)(null),[e6,e9]=(0,a.useState)([]),[e7,te]=(0,a.useState)(!1),[tt,tr]=(0,a.useState)(null),[tl,ta]=(0,a.useState)(1),[tn,ti]=(0,a.useState)(!1),[ts,to]=(0,a.useState)(.9),[tc,tu]=(0,a.useState)("idle"),[td,tp]=(0,a.useState)(null),[tm,tx]=(0,a.useState)(null),[th,ty]=(0,a.useState)(!1),[tf,tg]=(0,a.useState)(.8),[tb,tv]=(0,a.useState)("idle"),[tj,tN]=(0,a.useState)(null),[tw,tz]=(0,a.useState)(!1),[tS,tC]=(0,a.useState)(.8),[tk,t_]=(0,a.useState)("idle"),[tL,tM]=(0,a.useState)(null),tE=(0,a.useRef)(ef),tA=(0,a.useRef)(G),tT=(0,a.useRef)(V),tF=(0,a.useRef)(K),tR=(0,a.useRef)(null),tP=(0,a.useRef)(null),t$=(0,a.useRef)(null),tO=(0,a.useRef)(new Map),tI=(0,a.useRef)(null),tB=(0,a.useRef)(null),tW=(0,a.useRef)(null),tD=(0,a.useRef)(null),tV=(0,a.useRef)(null),tU=(0,a.useRef)(null),tG=(0,a.useRef)(!1),tq=(0,a.useRef)(null),tK=(0,a.useRef)(null),tY=(0,a.useRef)(0),tH=(0,a.useRef)(null),tJ=(0,a.useRef)(null),tZ=(0,a.useRef)(null),tX=(0,a.useRef)(null),tQ=(0,a.useRef)([]),t0=(0,a.useRef)([]),t1=(0,a.useRef)(!1),t2=(0,a.useRef)([]),t3=(0,a.useRef)({visible:!1,opacity:.9}),t5=(0,a.useRef)({visible:!1,opacity:.8}),t8=(0,a.useRef)({visible:!1,opacity:.8}),t4=(0,a.useRef)(null),t6=(0,a.useRef)(null),t9=(0,a.useRef)(null),t7=(0,a.useRef)(!1),re=(0,a.useRef)(null),rt=(0,a.useRef)(null),rr=(0,a.useRef)(null),rl=(0,a.useRef)(null),ra=(0,a.useRef)(null),rn=(0,a.useRef)(null),ri=(0,a.useRef)(null),rs=(0,a.useRef)("idle"),ro=(0,a.useRef)(null),rc=(0,a.useRef)(null),ru=(0,a.useRef)(null),rd=(0,a.useRef)(null),rp=(0,a.useRef)(!1),rm=(0,a.useRef)(null),rx=(0,a.useRef)(`map-area-heatmap-${Math.random().toString(36).slice(2,8)}`),rh=(0,a.useCallback)(()=>{r?.({count:eb.length,isLoading:ej,error:ew,status:eS,hasMore:!!ek})},[eb.length,ej,ew,eS,ek,r]);(0,a.useEffect)(()=>{rh()},[rh]);let ry=(0,a.useMemo)(()=>Object.keys(m.WG).map(e=>({label:e,value:e})),[]),rf=(0,a.useMemo)(()=>0===eT.length?[]:eT.flatMap(e=>(m.Ib[e]||[]).map(t=>({label:t,value:t,group:e}))),[eT]),rg=(0,a.useMemo)(()=>Object.keys(m.WG),[]),rb=(0,a.useMemo)(()=>Object.entries(m.WG).reduce((e,[t,r])=>(e[r.toUpperCase()]=t,e),{}),[]),rv=(0,a.useMemo)(()=>Math.max(1,Math.ceil(e6.length/20)),[e6.length]),rj=(0,a.useMemo)(()=>{let e=(tl-1)*20;return e6.slice(e,e+20)},[e6,tl]),rN=(0,a.useMemo)(()=>{let e=e6.map(e=>Number(e["房屋單價(萬)"])).filter(e=>Number.isFinite(e));if(0===e.length)return{max:null,min:null,avg:null,median:null};let t=[...e].sort((e,t)=>e-t),r=t[0],l=t[t.length-1],a=e.reduce((e,t)=>e+t,0)/e.length,n=Math.floor(t.length/2);return{max:l,min:r,avg:a,median:t.length%2==0?(t[n-1]+t[n])/2:t[n]}},[e6]),rw=(0,a.useMemo)(()=>{let e=[{min:0,max:1e3,label:"0-1000"},{min:1e3,max:2e3,label:"1000-2000"},{min:2e3,max:3e3,label:"2000-3000"},{min:3e3,max:4e3,label:"3000-4000"},{min:4e3,max:5e3,label:"4000-5000"},{min:5e3,max:1/0,label:"5000+"}].map(e=>({...e,count:0,sum:0,minValue:null,maxValue:null}));return e6.forEach(t=>{let r=E(t,["房屋總價(萬)","交易總價(萬)","交易總價","總價"]);if(null===r||r<=0)return;let l=e.find(e=>r>=e.min&&r<e.max);l&&(l.count+=1,l.sum+=r,l.minValue=null===l.minValue?r:Math.min(l.minValue,r),l.maxValue=null===l.maxValue?r:Math.max(l.maxValue,r))}),e.map(e=>({label:e.label,count:e.count,avg:e.count>0?e.sum/e.count:null,min:e.minValue,max:e.maxValue}))},[e6]),rz=(0,a.useMemo)(()=>{let e=new Map;return e6.forEach(t=>{let r,l=E(t,["房屋單價(萬)","房屋單價","unitPrice"]);if(null===l||l<=0)return;let a=(r=t["主要用途"]||t["用途"]||t["建物型態"])&&String(r).replace(/見其他登記事項/g,"其他").trim()||"未填";e.has(a)||e.set(a,[]),e.get(a).push(l)}),Array.from(e.entries()).map(([e,t])=>{let r=[...t].sort((e,t)=>e-t),l=t.length,a=r[0],n=r[r.length-1],i=t.reduce((e,t)=>e+t,0)/l,s=Math.floor(r.length/2);return{usage:e,count:l,min:a,max:n,avg:i,median:r.length%2==0?(r[s-1]+r[s])/2:r[s]}}).sort((e,t)=>t.count-e.count)},[e6]),rS=(0,a.useMemo)(()=>{let e=["地下/其他","1-5F","6-10F","11-15F","16-20F","21F+"],t=new Map,r=new Map;e6.forEach(e=>{var l;let a=A(e),n=null===(l=(e=>{let t=e["樓層"]||e["交易樓層"]||e["樓層別"];if(!t)return null;let r=String(t),l=/地下|B/i.test(r),a=r.match(/-?\d+/);if(!a)return null;let n=M(a[0]);return null===n?null:l?-Math.abs(n):n})(e))||l<=0?"地下/其他":l<=5?"1-5F":l<=10?"6-10F":l<=15?"11-15F":l<=20?"16-20F":"21F+";r.set(a,(r.get(a)||0)+1),t.has(n)||t.set(n,new Map);let i=t.get(n);i.set(a,(i.get(a)||0)+1)});let l=Array.from(r.entries()).sort((e,t)=>t[1]-e[1]).map(([e])=>e),a=l.slice(0,4),n=l.slice(4),i=n.length>0?[...a,"其他"]:a,s=e.map(e=>{let r=t.get(e)||new Map;return i.map(e=>"其他"!==e?r.get(e)||0:n.reduce((e,t)=>e+(r.get(t)||0),0))}),o=Math.max(1,...s.flat());return{rows:e,columns:i,matrix:s,maxValue:o}},[e6]),rC=(0,a.useMemo)(()=>{let e={};e6.forEach(t=>{let r=E(t,["房屋面積(坪)","建物面積(坪)","建物面積","總面積(坪)"]);if(null===r||r<=0)return;let l=A(t);e[l]||(e[l]=[]),e[l].push(r)});let t=Object.entries(e).sort((e,t)=>t[1].length-e[1].length).slice(0,5).map(([e])=>e),r=t.flatMap(t=>e[t]||[]);if(0===r.length)return{data:e,selectedRooms:[],minArea:0,maxArea:0,interval:5};let l=Math.min(...r),a=Math.max(...r),n=a-l,i=n>80?10:n>40?5:2,s=Math.max(0,Math.floor(l/i)*i),o=Math.ceil(a/i)*i;return{data:e,selectedRooms:t,minArea:s,maxArea:o>s?o:s+i,interval:i}},[e6]),rk=(0,a.useCallback)(e=>e.replace(/台/g,"臺").replace(/\s/g,"").trim(),[]),r_=(0,a.useCallback)(e=>{let t,r=[],l=e=>{if("string"!=typeof e)return;let t=e.trim();t&&r.push(t)};l(e?.text),l(e?.place_name),e?.properties&&(l(e.properties.county),l(e.properties.city),l(e.properties.region),l(e.properties.state),l(e.properties.district),l(e.properties.locality)),Array.isArray(e?.context)&&e.context.forEach(e=>{l(e?.text),l(e?.name)});let a=r.map(rk),n=rg.find(e=>a.some(t=>t.includes(rk(e))));return n&&(t=(m.Ib[n]||[]).find(e=>a.some(t=>t.includes(rk(e))))),{county:n,district:t}},[rg,rk]),rL=(0,a.useCallback)(e=>{let t,r=T(e,["COUNTYNAME","countyname","COUNTY","COUNTY_N","CountyName"])||T(e,["city","county"]),l=T(e,["TOWNNAME","townname","TOWN","TOWN_N","TownName"])||T(e,["district","town"]),a=r?rg.find(e=>rk(e)===rk(String(r))):void 0;return a&&l&&(t=(m.Ib[a]||[]).find(e=>rk(e)===rk(String(l)))),{county:a,district:t,countyRaw:r,districtRaw:l}},[rg,rk]),rM=(0,a.useCallback)(e=>{let t,r=T(e,["COUNTYNAME","countyname","COUNTY","COUNTY_N","CountyName"])||T(e,["city","county"]),l=T(e,["TOWNNAME","townname","TOWN","TOWN_N","TownName"])||T(e,["district","town"]),a=T(e,["VILLNAME","villname","VILL","VILL_N","VillageName","name"]),n=r?rg.find(e=>rk(e)===rk(String(r))):void 0;return n&&l&&(t=(m.Ib[n]||[]).find(e=>rk(e)===rk(String(l)))),{county:n,district:t,countyRaw:r,districtRaw:l,villageRaw:a}},[rg,rk]),rE=(0,a.useCallback)(e=>{if(!e?.center)return;let[t,r]=e.center,l=[t,r];ey(l);let a=r_(e);if(a.county&&eT.includes(a.county)){let e=m.Ib[a.county]||[],t=a.district&&e.includes(a.district)?[a.district]:[];t.length>0&&eP(t)}ep({lng:t,lat:r,label:e.text||e.place_name||"地址"});let n=v.current;n&&n.flyTo({center:l,zoom:Math.max(n.getZoom(),16),speed:1.4})},[r_,eT]),rA=(0,a.useCallback)(async e=>{let t=Number(e.latitude),r=Number(e.longitude);e4({id:L(e.id),project_name:L(e.project_name),latitude:Number.isFinite(t)?t:0,longitude:Number.isFinite(r)?r:0,county_code:L(e.county_code),developer:L(e.developer),contractor:L(e.contractor),architect:L(e.architect),sales_agent:L(e.sales_agent),affiliated_companies:L(e.affiliated_companies),construction_license:L(e.construction_license),total_households:L(e.total_households),community_unit_count:L(e.community_unit_count),total_floors:L(e.total_floors),basement_floors:L(e.basement_floors),structure:L(e.structure),public_ratio:L(e.public_ratio),site_area:L(e.site_area),land_use_zoning:L(e.land_use_zoning),land_plot_number:L(e.land_plot_number),parking_type:L(e.parking_type),parking_count:L(e.parking_count),enrichment_status:L(e.enrichment_status)}),e5(!0),e9([]),tr(null),te(!0),ta(1);try{let t=String(e.county_code||"").toUpperCase()||(eT[0]?m.WG[eT[0]]:"");if(!t)throw Error("缺少縣市代碼");let r={countyCode:t,type:"預售交易",projectNames:[String(e.project_name||"")]},l=await x.FH.fetchData(r,{page:1,limit:1e3});e9(Array.isArray(l?.data)?l.data:[])}catch(e){tr(e?.message||"讀取交易明細失敗")}finally{te(!1)}},[eT]),rT=(0,a.useCallback)(()=>{if(!e8)return;let e=rb[String(e8.county_code||"").toUpperCase()],t=e6[0]?.["行政區"],r=eR[0]||t||"";I({counties:e?[e]:[],districts:r?[r]:[],transactionType:"預售交易",projectNames:e8.project_name?[e8.project_name]:[],activeTab:"data-list"}),C.push("/dashboard")},[e8,e6,eR,rb,I,C]);(0,a.useEffect)(()=>{if(!D)return;if(0===eT.length){ee([]),ep(null),er(!1);return}let e=Z.trim();if(e.length<2){ee([]),ep(null),er(!1),ei([]),eo("idle"),eu(null);return}return t$.current&&window.clearTimeout(t$.current),tP.current&&tP.current.abort(),er(!0),t$.current=window.setTimeout(async()=>{let t=new AbortController;tP.current=t;try{let r=v.current,l=r?r.getCenter():{lng:b[0],lat:b[1]},a=`https://api.maptiler.com/geocoding/${encodeURIComponent(e)}.json?key=${D}&language=zh&limit=6&proximity=${l.lng},${l.lat}`,n=await fetch(a,{signal:t.signal});if(!n.ok)throw Error(`Geocoding error ${n.status}`);let i=await n.json(),s=(Array.isArray(i?.features)?i.features:[]).filter(e=>{let t=r_(e);return t.county&&eT.includes(t.county)});if(ee(s),s[0]?.center){let[e,t]=s[0].center;ep({lng:e,lat:t,label:s[0].text||s[0].place_name||"地址"})}else ep(null)}catch(e){if(e?.name==="AbortError")return;ee([])}finally{er(!1)}},320),()=>{t$.current&&window.clearTimeout(t$.current),tP.current&&tP.current.abort()}},[Z,D,eT,r_]);let rF=(0,a.useCallback)(e=>{e.length>6||(eF(e),eP(t=>t.filter(t=>e.some(e=>(m.Ib[e]||[]).includes(t)))),eB([]),eO([]),eq([]),X(""),ee([]),ey(null),ep(null),ei([]),eo("idle"),eu(null),eJ(null))},[]),rR=(0,a.useCallback)(e=>{eP(e),eB([]),eO([]),eq([]),eJ(null)},[]),rP=(0,a.useCallback)(async e=>{let t=e.trim();if(0===eT.length||t.length<2)return void eO([]);eD(!0),eU(null);try{let e=eT.map(async e=>{let r=m.WG[e],l=eR.filter(t=>(m.Ib[e]||[]).includes(t));return x.FH.fetchProjectNameSuggestions(r,t,l).then(t=>{let r=[];return Array.isArray(t)?r=t:t&&t.data&&Array.isArray(t.data)?r=t.data:t&&t.names&&Array.isArray(t.names)&&(r=t.names),r.map(t=>{let r="string"==typeof t,l=r?t:t.name||t.建案名稱||String(t);return{label:l,value:l,group:e,details:r?void 0:{county:e,district:t.district||t.行政區,date:t.earliestDate||t.交易日}}})}).catch(t=>(console.error(`Failed to fetch projects for ${e}:`,t),[]))}),r=(await Promise.all(e)).flat(),l=Array.from(new Map(r.map(e=>[e.value,e])).values());eO(l)}catch(e){console.error("Project search error:",e),eU("搜尋失敗，請稍後再試")}finally{eD(!1)}},[eT,eR]),r$=(0,a.useCallback)(e=>{tq.current&&clearTimeout(tq.current),tq.current=setTimeout(()=>{rP(e)},300)},[rP]),rO=(0,a.useCallback)(e=>{X(e),r$(e)},[r$]);(0,a.useEffect)(()=>()=>{tq.current&&clearTimeout(tq.current)},[]),(0,a.useEffect)(()=>{if(!el)return;let e=e=>{tW.current&&!tW.current.contains(e.target)&&ea(!1)};return document.addEventListener("mousedown",e),()=>document.removeEventListener("mousedown",e)},[el]);let rI=(0,a.useMemo)(()=>{let e=new Map,t=Q.map((t,r)=>{let l=t?.id?String(t.id):`${t?.center?.[0]}-${t?.center?.[1]}-${r}`,a=`addr:${l}`;e.set(a,t);let n=r_(t);return{label:t.text||t.place_name||"地址",value:a,group:"地址搜尋",details:n.county||n.district?{county:n.county,district:n.district}:void 0}});return tO.current=e,t},[Q,r_]),rB=(0,a.useMemo)(()=>Array.from(new Map([...rI,...en,...e$].map(e=>[e.value,e])).values()),[rI,en,e$]),rW=(0,a.useCallback)(e=>{let t=e.filter(e=>e.startsWith("addr:")),r=e.filter(e=>!e.startsWith("addr:"));t.length>0&&t.forEach(e=>{let t=tO.current.get(e);t&&rE(t)}),eB(r),0===r.length&&(eq([]),eJ(null))},[rE]),rD=(0,a.useCallback)(async()=>{if(0===eR.length||0===eT.length){eX([]),e2(null);return}e0(!0),e2(null);try{let e=eT.map(async e=>{let t=m.WG[e],r=eR.filter(t=>(m.Ib[e]||[]).includes(t));return r.length?x.FH.fetchProjectNameSuggestions(t,"",r).then(e=>{let t=[];return Array.isArray(e)?t=e:e&&e.data&&Array.isArray(e.data)?t=e.data:e&&e.names&&Array.isArray(e.names)&&(t=e.names),t.map(e=>"string"==typeof e?e:e.name||e.建案名稱||String(e)).filter(Boolean)}).catch(t=>(console.error(`Failed to fetch district projects for ${e}:`,t),[])):[]}),t=(await Promise.all(e)).flat(),r=Array.from(new Set(t));eX(r)}catch(e){console.error("District project list error:",e),e2("行政區建案清單載入失敗"),eX([])}finally{e0(!1)}},[eT,eR]);(0,a.useEffect)(()=>{rD()},[rD]);let rV=(0,a.useCallback)(async e=>{if(0!==e.length){eY(!0),eJ(null);try{let{data:t}=await u.N.auth.getSession(),r=t?.session?.access_token;if(!r)throw Error("無效的授權金鑰");let l=eT.length>0?eT.map(e=>m.WG[e]).filter(Boolean).map(e=>e.toLowerCase()):"all",a=await fetch("https://zxbmbbfrzbtuueysicoc.supabase.co/functions/v1/map-projects",{method:"POST",headers:{"Content-Type":"application/json",Authorization:`Bearer ${r}`},body:JSON.stringify({countyCode:l,projectNames:e,limit:Math.max(200,20*e.length)})});if(!a.ok){let e=await a.json();throw Error(e.error||`HTTP Error: ${a.status}`)}let n=await a.json(),s=(Array.isArray(n?.projects)?n.projects:[]).map(e=>{let t=Number(e.latitude),r=Number(e.longitude);return Number.isFinite(t)&&Number.isFinite(r)?{lat:t,lng:r,name:e.project_name||"建案"}:null}).filter(Boolean);if(eq(s),0===s.length)return void eJ("找不到建案座標");let o=v.current;if(o)if(1===s.length)o.flyTo({center:[s[0].lng,s[0].lat],zoom:Math.max(eL,16),speed:1.4});else{let e=new(i()).LngLatBounds;s.forEach(t=>e.extend([t.lng,t.lat])),o.fitBounds(e,{padding:80,maxZoom:Math.max(eL,16)})}}catch(e){console.error("Locate projects error:",e),eJ(e.message||"定位失敗")}finally{eY(!1)}}},[eT,eL]);(0,a.useEffect)(()=>{0!==eI.length&&rV(eI)},[eI,rV]);let rU=(0,a.useCallback)(()=>{let e=v.current;if(!e)return null;let t=e.getBounds(),r=e.getZoom(),l={south:t.getSouth(),west:t.getWest(),north:t.getNorth(),east:t.getEast()},a=e.getCenter(),n=Math.abs(l.north-l.south),i=Math.abs(l.east-l.west);return{bbox:l,zoom:r,maxSpanKm:Math.max(111*n,111*i*Math.cos(a.lat*Math.PI/180))}},[]),rG=(0,a.useCallback)((e,t)=>{let r=new Map;return e.forEach(e=>r.set(`${e.county_code}-${e.id}`,e)),t.forEach(e=>r.set(`${e.county_code}-${e.id}`,e)),Array.from(r.values())},[]),rq=(0,a.useCallback)(async({append:e=!1,cursor:t}={})=>{let r=rU();if(!r)return;if(r.zoom<eL){eC("zoom"),ez(null),e||(ev([]),e_(null));return}if(eE>0&&r.maxSpanKm>eE){eC("range"),ez(null),e||(ev([]),e_(null));return}if(eR.length>0){if(eQ)return void eC("loading");if(0===eZ.length){ev([]),e_(null),eC("ready");return}}let l=[r.bbox.south.toFixed(5),r.bbox.west.toFixed(5),r.bbox.north.toFixed(5),r.bbox.east.toFixed(5),r.zoom,eL,eE].join("|");if(e){if(tK.current?.key&&tK.current.key!==l)return rq({append:!1})}else tK.current={key:l,bbox:r.bbox,zoom:r.zoom},e_(null);let a=tY.current+1;tY.current=a,eN(!0),ez(null),eC("loading");try{let{data:l}=await u.N.auth.getSession(),n=l?.session?.access_token;if(!n)throw Error("無效的授權金鑰");let i=eT.length>0?eT.map(e=>m.WG[e]).filter(Boolean).map(e=>e.toLowerCase()):"all",s=eR.length>0?eZ:null,o=await fetch("https://zxbmbbfrzbtuueysicoc.supabase.co/functions/v1/map-projects",{method:"POST",headers:{"Content-Type":"application/json",Authorization:`Bearer ${n}`},body:JSON.stringify({countyCode:i,projectNames:s&&s.length>0?s:void 0,bbox:r.bbox,zoom:r.zoom,limit:800,cursor:e?t:null})});if(!o.ok){let e=await o.json();throw Error(e.error||`HTTP Error: ${o.status}`)}let c=await o.json();if(tY.current!==a)return;let d=Array.isArray(c?.projects)?c.projects:[];ev(t=>e?rG(t,d):d),e_(c?.nextCursor??null),eC("ready")}catch(e){if(tY.current!==a)return;console.error("Failed to fetch map projects:",e),ez(e.message||"載入建案資料失敗"),eC("error")}finally{tY.current===a&&eN(!1)}},[rU,rG,eL,eE,eT,eR,eZ,eQ]);(0,a.useEffect)(()=>{void 0!==t&&rq({append:!1})},[t,rq]),(0,a.useEffect)(()=>{rq({append:!1})},[eL,eE,eT,eR,eZ,rq]);let rK=(0,a.useMemo)(()=>[{id:"zoning",label:"國土利用現況調查成果圖",tiles:"https://wmts.nlsc.gov.tw/wmts/LUIMAP/default/GoogleMapsCompatible/{z}/{y}/{x}"},{id:"cadastral",label:"段籍圖（地籍）",tiles:"https://wmts.nlsc.gov.tw/wmts/LANDSECT/default/GoogleMapsCompatible/{z}/{y}/{x}"}],[]),rY=(0,a.useMemo)(()=>{let e={id:"osm",label:"OSM 標準",supportsTheme:!1,style:{version:8,name:"OpenStreetMap Standard",sources:{"osm-tiles":{type:"raster",tiles:["https://tile.openstreetmap.org/{z}/{x}/{y}.png"],tileSize:256,attribution:"\xa9 OpenStreetMap contributors"}},layers:[{id:"osm-tiles",type:"raster",source:"osm-tiles",minzoom:0,maxzoom:19}]}},t={id:"dark",label:"黑底",supportsTheme:!1,style:{version:8,name:"Dark Matter",sources:{"carto-dark":{type:"raster",tiles:["https://basemaps.cartocdn.com/dark_all/{z}/{x}/{y}.png"],tileSize:256,attribution:"\xa9 OpenStreetMap contributors \xa9 CARTO"}},layers:[{id:"carto-dark",type:"raster",source:"carto-dark",minzoom:0,maxzoom:19}]}},r=D?[{id:"topo-v2",label:"地形",url:`https://api.maptiler.com/maps/topo-v2/style.json?key=${D}`,supportsTheme:!1}]:[];return D?[e,t,...r]:[e,t,{id:"demo",label:"開源預設",url:"https://demotiles.maplibre.org/style.json"}]},[D]),rH={dark:s.A,"topo-v2":o.A,osm:s.A,demo:s.A},rJ=(0,a.useCallback)(e=>{let t=e.getStyle();t?.layers&&t.layers.forEach(t=>{"symbol"!==t.type||t.layout?.["text-field"]&&e.setLayoutProperty(t.id,"text-field",["coalesce",["get","name:zh-Hant"],["get","name:zh"],["get","name"],["get","name:en"]])})},[]),rZ=(0,a.useCallback)(e=>{let t=!!e.getStyle()?.glyphs;e.getSource("osm-levels")||e.addSource("osm-levels",{type:"geojson",data:{type:"FeatureCollection",features:[]}}),e.getLayer("osm-levels-points")||e.addLayer({id:"osm-levels-points",type:"circle",source:"osm-levels",paint:{"circle-color":"#38bdf8","circle-radius":4,"circle-opacity":.7,"circle-stroke-color":"#22d3ee","circle-stroke-width":1}}),t&&!e.getLayer("osm-levels-label")&&e.addLayer({id:"osm-levels-label",type:"symbol",source:"osm-levels",layout:{"text-field":["get","levelsLabel"],"text-size":11,"text-anchor":"center","text-allow-overlap":!0},paint:{"text-color":"#e2e8f0","text-halo-color":"#0b0d13","text-halo-width":1.1}})},[]),rX=(0,a.useCallback)((e,t)=>{let r=t?"visible":"none";e.getLayer("osm-levels-points")&&e.setLayoutProperty("osm-levels-points","visibility",r),e.getLayer("osm-levels-label")&&e.setLayoutProperty("osm-levels-label","visibility",r)},[]),rQ=(0,a.useCallback)(e=>{e.getSource("search-point")||e.addSource("search-point",{type:"geojson",data:{type:"FeatureCollection",features:[]}}),e.getLayer("search-point-layer")||e.addLayer({id:"search-point-layer",type:"circle",source:"search-point",paint:{"circle-color":"#22d3ee","circle-radius":6,"circle-stroke-color":"#0ea5e9","circle-stroke-width":2,"circle-opacity":.9}})},[]),r0=(0,a.useCallback)(e=>{let t=!!e.getStyle()?.glyphs;e.getSource("project-distance")||e.addSource("project-distance",{type:"geojson",data:{type:"FeatureCollection",features:[]}}),e.getLayer("project-distance-line")||e.addLayer({id:"project-distance-line",type:"line",source:"project-distance",filter:["==","$type","LineString"],paint:{"line-color":"#f59e0b","line-width":2,"line-opacity":.85}}),t&&!e.getLayer("project-distance-label")&&e.addLayer({id:"project-distance-label",type:"symbol",source:"project-distance",filter:["==","$type","Point"],layout:{"text-field":["get","label"],"text-size":12,"text-anchor":"center","text-allow-overlap":!0},paint:{"text-color":"#fde68a","text-halo-color":"#111827","text-halo-width":1.2}})},[]),r1=(0,a.useCallback)(e=>{let t=e.getSource("project-distance");if(!t)return;let r=tX.current;if(!r)return void t.setData({type:"FeatureCollection",features:[]});let l=r.coordinates,a=[(l[0][0]+l[1][0])/2,(l[0][1]+l[1][1])/2];t.setData({type:"FeatureCollection",features:[{type:"Feature",properties:{label:r.label},geometry:{type:"LineString",coordinates:l}},{type:"Feature",properties:{label:r.label},geometry:{type:"Point",coordinates:a}}]})},[]),r2=(0,a.useCallback)(e=>{e.getSource("project-points")||e.addSource("project-points",{type:"geojson",data:{type:"FeatureCollection",features:[]}}),e.getLayer("project-points-layer")||e.addLayer({id:"project-points-layer",type:"circle",source:"project-points",paint:{"circle-color":["case",["boolean",["get","isSelected"],!1],"#f59e0b",["boolean",["get","filterActive"],!1],"#2dd4bf","#22d3ee"],"circle-radius":["case",["boolean",["get","isSelected"],!1],7,5],"circle-opacity":["case",["boolean",["get","dim"],!1],.35,.9],"circle-stroke-color":["case",["boolean",["get","isSelected"],!1],"#fcd34d",["boolean",["get","filterActive"],!1],"#99f6e4","#67e8f9"],"circle-stroke-width":["case",["boolean",["get","isSelected"],!1],2,1.2]}}),e.getSource("project-locate")||e.addSource("project-locate",{type:"geojson",data:{type:"FeatureCollection",features:[]}}),e.getLayer("project-locate-layer")||e.addLayer({id:"project-locate-layer",type:"circle",source:"project-locate",paint:{"circle-color":"#f59e0b","circle-radius":8,"circle-opacity":.85,"circle-stroke-color":"#fef3c7","circle-stroke-width":2}})},[]),r3=(0,a.useCallback)(e=>{let t=e.getSource("project-points");if(t){let e=new Set(t0.current),r=t0.current.length>0,l=t1.current,a=tQ.current.map(t=>{let a=Number(t.latitude),n=Number(t.longitude);if(!Number.isFinite(a)||!Number.isFinite(n))return null;let i=e.has(t.project_name);return{type:"Feature",properties:{id:t.id,project_name:t.project_name,county_code:t.county_code,developer:t.developer,contractor:t.contractor,architect:t.architect,sales_agent:t.sales_agent,affiliated_companies:t.affiliated_companies,construction_license:t.construction_license,total_households:t.total_households,community_unit_count:t.community_unit_count,total_floors:t.total_floors,basement_floors:t.basement_floors,structure:t.structure,public_ratio:t.public_ratio,site_area:t.site_area,land_use_zoning:t.land_use_zoning,land_plot_number:t.land_plot_number,parking_type:t.parking_type,parking_count:t.parking_count,enrichment_status:t.enrichment_status,isSelected:i,dim:r&&!i,filterActive:l},geometry:{type:"Point",coordinates:[n,a]}}}).filter(Boolean);t.setData({type:"FeatureCollection",features:a})}let r=e.getSource("project-locate");if(r){let e=t2.current.map(e=>({type:"Feature",properties:{name:e.name},geometry:{type:"Point",coordinates:[e.lng,e.lat]}}));r.setData({type:"FeatureCollection",features:e})}},[]),r5=(0,a.useCallback)(e=>{if(e.getSource("village-boundary")||e.addSource("village-boundary",{type:"geojson",data:{type:"FeatureCollection",features:[]}}),w&&!e.getSource("village-boundary-wmts")&&e.addSource("village-boundary-wmts",{type:"raster",tiles:[w],tileSize:256}),!e.getLayer("village-boundary-line")){let t=e.getLayer("project-points-layer")?"project-points-layer":void 0;e.addLayer({id:"village-boundary-line",type:"line",source:"village-boundary",layout:{visibility:"none"},minzoom:12,paint:{"line-color":["case",["boolean",["feature-state","hover"],!1],"#fbbf24","#f8fafc"],"line-width":["interpolate",["linear"],["zoom"],12,["case",["boolean",["feature-state","hover"],!1],2,.9],15,["case",["boolean",["feature-state","hover"],!1],3,1.6]],"line-opacity":t3.current.opacity}},t)}if(!e.getLayer("village-boundary-label")&&e.getStyle()?.glyphs){let t=e.getLayer("project-points-layer")?"project-points-layer":void 0;e.addLayer({id:"village-boundary-label",type:"symbol",source:"village-boundary",layout:{"text-field":["coalesce",["get","VILLNAME"],["get","villname"],["get","VILL"],["get","VILL_N"],["get","VillageName"],["get","name"]],"text-size":["interpolate",["linear"],["zoom"],12,10,15,12],"text-anchor":"center","text-allow-overlap":!1},paint:{"text-color":"#e2e8f0","text-halo-color":"#0b0d13","text-halo-width":1.2}},t)}if(w&&!e.getLayer("village-boundary-wmts-layer")){let t=e.getLayer("project-points-layer")?"project-points-layer":void 0;e.addLayer({id:"village-boundary-wmts-layer",type:"raster",source:"village-boundary-wmts",layout:{visibility:"none"},minzoom:12,paint:{"raster-opacity":t3.current.opacity}},t)}},[]),r8=(0,a.useCallback)(e=>{if(!e.getLayer("village-boundary-line"))return;let t=t3.current.visible,r=!!w&&t&&"error"===rs.current;e.setLayoutProperty("village-boundary-line","visibility",t?"visible":"none"),e.getLayer("village-boundary-label")&&e.setLayoutProperty("village-boundary-label","visibility",t?"visible":"none"),e.getLayer("village-boundary-wmts-layer")&&e.setLayoutProperty("village-boundary-wmts-layer","visibility",r?"visible":"none"),e.setPaintProperty("village-boundary-line","line-opacity",t3.current.opacity),e.getLayer("village-boundary-wmts-layer")&&e.setPaintProperty("village-boundary-wmts-layer","raster-opacity",t3.current.opacity)},[]),r4=(0,a.useCallback)((e,t)=>{e.getLayer("village-boundary-line")&&(e.setFilter("village-boundary-line",t??null),e.getLayer("village-boundary-label")&&e.setFilter("village-boundary-label",t??null))},[]),r6=(0,a.useCallback)(e=>{if(e.getSource("district-boundary")||e.addSource("district-boundary",{type:"geojson",data:{type:"FeatureCollection",features:[]}}),!e.getLayer("district-boundary-fill")){let t=e.getLayer("project-points-layer")?"project-points-layer":void 0;e.addLayer({id:"district-boundary-fill",type:"fill",source:"district-boundary",layout:{visibility:"none"},minzoom:8,paint:{"fill-color":"#38bdf8","fill-opacity":["case",["boolean",["feature-state","hover"],!1],Math.min(t5.current.opacity,.35),0]}},t)}if(!e.getLayer("district-boundary-line")){let t=e.getLayer("project-points-layer")?"project-points-layer":void 0;e.addLayer({id:"district-boundary-line",type:"line",source:"district-boundary",layout:{visibility:"none"},minzoom:8,paint:{"line-color":"#67e8f9","line-width":["interpolate",["linear"],["zoom"],8,.8,12.5,1.6,15,2.2],"line-opacity":t5.current.opacity}},t)}},[]),r9=(0,a.useCallback)(e=>{if(!e.getLayer("district-boundary-line")||!e.getLayer("district-boundary-fill"))return;let t=t5.current.visible?"visible":"none";e.setLayoutProperty("district-boundary-line","visibility",t),e.setLayoutProperty("district-boundary-fill","visibility",t),e.setPaintProperty("district-boundary-line","line-opacity",t5.current.opacity),e.setPaintProperty("district-boundary-fill","fill-opacity",["case",["boolean",["feature-state","hover"],!1],Math.min(t5.current.opacity,.35),0])},[]),r7=(0,a.useCallback)(async e=>{if(ra.current){let t=e.getSource("district-boundary");t&&t.setData(ra.current),tv("ready");return}rr.current&&(window.clearTimeout(rr.current),rr.current=null),re.current&&re.current.abort();let t=new AbortController;re.current=t,tv("loading"),tN(null),rr.current=window.setTimeout(()=>{re.current&&(re.current.abort(),re.current=null),tv("error"),tN("行政區界線載入逾時")},12e3);try{let r=await O(j,t.signal),l=F(r,["TOWNCODE","TOWNID","id"]);ra.current=l;let a=e.getSource("district-boundary");a&&a.setData(l),tv("ready")}catch(e){if(e?.name==="AbortError")return;tv("error"),tN("行政區界線載入失敗")}finally{rr.current&&(window.clearTimeout(rr.current),rr.current=null)}},[]),le=(0,a.useCallback)(async e=>{if(rn.current){let t=e.getSource("village-boundary");t&&t.setData(rn.current),tu("ready");return}rl.current&&(window.clearTimeout(rl.current),rl.current=null),rt.current&&rt.current.abort();let t=new AbortController;rt.current=t,tu("loading"),tp(null),rl.current=window.setTimeout(()=>{rt.current&&(rt.current.abort(),rt.current=null),tu("error"),tp("村里界線載入逾時")},12e3);try{let r=await O(N,t.signal),l=F(r,["VILLCODE","VILLID","id"]);rn.current=l;let a=e.getSource("village-boundary");a&&a.setData(l),tu("ready")}catch(e){if(e?.name==="AbortError")return;tu("error"),tp("村里界線載入失敗")}finally{rl.current&&(window.clearTimeout(rl.current),rl.current=null)}},[]),lt=(0,a.useCallback)(e=>{e.getSource("metro-lines")||e.addSource("metro-lines",{type:"geojson",data:{type:"FeatureCollection",features:[]}}),e.getLayer("metro-lines-layer")||e.addLayer({id:"metro-lines-layer",type:"line",source:"metro-lines",layout:{"line-join":"round","line-cap":"round",visibility:"none"},paint:{"line-color":"#f97316","line-width":["interpolate",["linear"],["zoom"],9,1.2,14,3.2],"line-opacity":t8.current.opacity}})},[]),lr=(0,a.useCallback)(e=>{e.getLayer("metro-lines-layer")&&(e.setLayoutProperty("metro-lines-layer","visibility",t8.current.visible?"visible":"none"),e.setPaintProperty("metro-lines-layer","line-opacity",t8.current.opacity))},[]),ll=(0,a.useCallback)(async e=>{if(16>e.getZoom())return void J("zoom");let t=e.getBounds(),r=Math.abs(t.getNorth()-t.getSouth()),l=Math.abs(t.getEast()-t.getWest());if(r>.12||l>.12)return void J("zoom");let a=`${t.getSouth()},${t.getWest()},${t.getNorth()},${t.getEast()}`;if(a===tU.current)return;tU.current=a,tD.current&&tD.current.abort();let n=new AbortController;tD.current=n,J("loading");let i=`[out:json][timeout:25];
(
  way["building"]["building:levels"](${a});
  way["building"]["levels"](${a});
);
out center;`,s=null;for(let e of["https://overpass-api.de/api/interpreter","https://overpass.kumi.systems/api/interpreter","https://overpass.nchc.org.tw/api/interpreter"])try{let t=await fetch(e,{method:"POST",body:i,signal:n.signal,headers:{"Content-Type":"text/plain"}});if(!t.ok)throw Error(`OSM fetch failed: ${t.status}`);s=await t.json();break}catch(e){if(e?.name==="AbortError")return;s=null}if(!s)return void J("error");let o=(s?.elements||[]).filter(e=>"way"===e.type&&e.center).map(e=>{let t=e.tags||{},r=Number.parseInt(t["building:levels"]||t.levels,10);return r&&e.center?{type:"Feature",properties:{id:e.id,levels:r,levelsLabel:`${r}F`},geometry:{type:"Point",coordinates:[e.center.lon,e.center.lat]}}:null}).filter(Boolean);e.getSource("osm-levels").setData({type:"FeatureCollection",features:o}),J("ready")},[]),la=(0,a.useCallback)(async e=>{if(z){if(t7.current)return void t_("ready");t4.current&&t4.current.abort();let t=new AbortController;t4.current=t,t_("loading"),tM(null);try{let r=await fetch(z,{signal:t.signal});if(!r.ok)throw Error(`Metro GeoJSON fetch failed: ${r.status}`);let l=await r.json(),a=e.getSource("metro-lines");l?.type==="FeatureCollection"?a.setData(l):a.setData({type:"FeatureCollection",features:[]}),t7.current=!0,t_("ready")}catch(e){if(e?.name==="AbortError")return;t_("error"),tM("捷運路線載入失敗")}return}if(10>e.getZoom())return void t_("zoom");let t=e.getBounds(),r=`${t.getSouth()},${t.getWest()},${t.getNorth()},${t.getEast()}`;if(r===t9.current)return;t9.current=r,t4.current&&t4.current.abort();let l=new AbortController;t4.current=l,t_("loading"),tM(null);let a=`[out:json][timeout:25];
(
  way["railway"="subway"](${r});
  way["railway"="light_rail"](${r});
);
out geom;`,n=null;for(let e of S)try{let t=await fetch(e,{method:"POST",body:a,signal:l.signal,headers:{"Content-Type":"text/plain"}});if(!t.ok)throw Error(`Metro fetch failed: ${t.status}`);n=await t.json();break}catch(e){if(e?.name==="AbortError")return;n=null}if(!n){t_("error"),tM("捷運路線載入失敗");return}let i=(n?.elements||[]).filter(e=>"way"===e.type&&Array.isArray(e.geometry)).map(e=>{let t=(e.geometry||[]).map(e=>[e.lon,e.lat]);return t.length<2?null:{type:"Feature",properties:{id:e.id,name:e.tags?.name||"",ref:e.tags?.ref||""},geometry:{type:"LineString",coordinates:t}}}).filter(Boolean);e.getSource("metro-lines").setData({type:"FeatureCollection",features:i}),t_("ready")},[]),ln=(0,a.useCallback)(e=>{if(!tA.current)return;let t=e.getStyle();if(!t?.layers)return;let r=t.layers.find(e=>"symbol"===e.type&&e.layout?.["text-field"])?.id,l=e.getSource("openmaptiles")?"openmaptiles":e.getSource("maptiler")?"maptiler":null;!l||e.getLayer("3d-buildings")||e.addLayer({id:"3d-buildings",source:l,"source-layer":"building",type:"fill-extrusion",minzoom:15,paint:{"fill-extrusion-color":["interpolate",["linear"],["coalesce",["get","render_height"],["get","height"],6],0,"#1f2937",20,"#334155",50,"#38bdf8",100,"#f97316",200,"#ef4444"],"fill-extrusion-height":["coalesce",["get","render_height"],["get","height"],6],"fill-extrusion-base":["coalesce",["get","render_min_height"],["get","min_height"],0],"fill-extrusion-opacity":.85}},r)},[]);(0,a.useEffect)(()=>{if(!g.current||v.current)return;let e=rY.find(e=>e.id===V),t=e?.url??e?.style??"https://demotiles.maplibre.org/style.json",r=new(i()).Map({container:g.current,style:t,center:b,zoom:14,pitch:45,bearing:-15,antialias:!0,attributionControl:!1});r.addControl(new(i()).NavigationControl({showCompass:!0}),"top-right"),r.addControl(new(i()).AttributionControl({compact:!0}),"bottom-left"),r.on("style.load",()=>{if(ln(r),rK.forEach(e=>{if(!e.tiles)return;let t=`gov-${e.id}`,l=`gov-${e.id}-layer`;r.getSource(t)||r.addSource(t,{type:"raster",tiles:[e.tiles],tileSize:256}),r.getLayer(l)||r.addLayer({id:l,type:"raster",source:t,layout:{visibility:"none"},paint:{"raster-opacity":tE.current[e.id]?.opacity??.6}})}),rK.forEach(e=>{if(!e.tiles)return;let t=`gov-${e.id}-layer`;if(!r.getLayer(t))return;let l=tE.current[e.id];l&&(r.setLayoutProperty(t,"visibility",l.visible?"visible":"none"),r.setPaintProperty(t,"raster-opacity",l.opacity))}),rQ(r),rZ(r),rX(r,tF.current),r2(r),r0(r),r3(r),r1(r),r5(r),r8(r),r4(r,t3.current.visible?ro.current:null),r6(r),r9(r),lt(r),lr(r),t5.current.visible&&r7(r),t3.current.visible&&le(r),t8.current.visible&&(t9.current=null,t7.current=!1,la(r)),tF.current&&ll(r),tR.current){let e=r.getSource("search-point");e&&e.setData({type:"FeatureCollection",features:[{type:"Feature",properties:{},geometry:{type:"Point",coordinates:tR.current}}]})}rJ(r),tG.current||(tG.current=!0,W(!0))}),v.current=r;let l=new ResizeObserver(()=>r.resize());return l.observe(g.current),()=>{l.disconnect(),r.remove(),v.current=null}},[]),(0,a.useEffect)(()=>{tA.current=G,tF.current=K,tR.current=eh,tE.current=ef;let e=v.current;if(e&&(rK.forEach(t=>{if(!t.tiles)return;let r=`gov-${t.id}-layer`;if(!e.getLayer(r))return;let l=ef[t.id];l&&(e.setLayoutProperty(r,"visibility",l.visible?"visible":"none"),e.setPaintProperty(r,"raster-opacity",l.opacity))}),eh)){let t=e.getSource("search-point");t&&t.setData({type:"FeatureCollection",features:[{type:"Feature",properties:{},geometry:{type:"Point",coordinates:eh}}]})}},[ef,rK,eh]),(0,a.useEffect)(()=>{let e=v.current;e&&B&&(r5(e),rs.current=tc,r8(e),r6(e),r9(e),lt(e),lr(e))},[B,tn,ts,tc,th,tf,tw,tS,r5,r8,r6,r9,lt,lr]),(0,a.useEffect)(()=>{let e=v.current;if(e&&B){if(!th){re.current&&(re.current.abort(),re.current=null),rr.current&&(window.clearTimeout(rr.current),rr.current=null),null!==ri.current&&(e.setFeatureState({source:"district-boundary",id:ri.current},{hover:!1}),ri.current=null),tN(null),tv("idle");return}r7(e)}},[th,B,r7]),(0,a.useEffect)(()=>{let e=v.current;if(e&&B){if(!tn){rt.current&&(rt.current.abort(),rt.current=null),rl.current&&(window.clearTimeout(rl.current),rl.current=null),tp(null),tu("idle");return}le(e)}},[tn,B,le]),(0,a.useEffect)(()=>{let e=v.current;if(e&&B){if(!tn)return void r4(e,null);r4(e,tm)}},[tn,tm,B,r4]),(0,a.useEffect)(()=>{let e=v.current;if(e){if(!G){e.getLayer("3d-buildings")&&e.removeLayer("3d-buildings"),e.easeTo({pitch:0,bearing:0,duration:450});return}ln(e),e.easeTo({pitch:45,bearing:-15,duration:450})}},[G,ln]),(0,a.useEffect)(()=>{let e=v.current;if(!e)return;let t=rY.find(e=>e.id===V);if(!t)return;let r=t.url??t.style;r&&e.setStyle(r,{diff:!1})},[V,rY]),(0,a.useEffect)(()=>{let e=v.current;if(e&&B){if(tT.current!==V){let t=rY.find(e=>e.id===V),r=t?.url??t?.style;r&&e.setStyle(r,{diff:!1})}tT.current=V}},[V,B,rY]),(0,a.useEffect)(()=>{let e=v.current;e&&B&&rJ(e)},[B,rJ]),(0,a.useEffect)(()=>{let e=v.current;e&&B&&ex(e.getZoom())},[B]),(0,a.useEffect)(()=>{tl>rv&&ta(1)},[tl,rv]);let li=(0,a.useCallback)(async e=>{if(!e||0===eT.length){ei([]),eo("idle");return}tI.current&&tI.current.abort();let t=new AbortController;tI.current=t,eo("loading"),eu(null);try{let r=[{label:"鄰近 0.5km",maxKm:.5},{label:"鄰近 0.75km",maxKm:.75},{label:"鄰近 1km",maxKm:1}],l=r[r.length-1].maxKm,a=l/111,n=l/(111*Math.cos(e.lat*Math.PI/180)),i={south:e.lat-a,north:e.lat+a,west:e.lng-n,east:e.lng+n},{data:s}=await u.N.auth.getSession(),o=s?.session?.access_token;if(!o)throw Error("無效的授權金鑰");let c=eT.map(e=>m.WG[e]).filter(Boolean).map(e=>e.toLowerCase()),d=await fetch("https://zxbmbbfrzbtuueysicoc.supabase.co/functions/v1/map-projects",{method:"POST",headers:{"Content-Type":"application/json",Authorization:`Bearer ${o}`},body:JSON.stringify({countyCode:c.length>0?c:"all",bbox:i,zoom:16,limit:800}),signal:t.signal});if(!d.ok){let e=await d.json();throw Error(e.error||`HTTP Error: ${d.status}`)}let p=await d.json(),x=Array.isArray(p?.projects)?p.projects:[],h=[],y=new Set;x.forEach(t=>{let l=Number(t.latitude),a=Number(t.longitude);if(!Number.isFinite(l)||!Number.isFinite(a))return;let n=k([a,l],[e.lng,e.lat]),i=r.find(e=>n<=e.maxKm);if(!i)return;let s=t.project_name||"建案",o=`${i.label}-${s}`;y.has(o)||(y.add(o),h.push({label:s,value:s,group:i.label}))});let f=new Map(r.map((e,t)=>[e.label,t]));h.sort((e,t)=>{let r=f.get(e.group||"")??99,l=f.get(t.group||"")??99;return r!==l?r-l:e.label.localeCompare(t.label)}),ei(h),eo("ready")}catch(e){if(e?.name==="AbortError")return;ei([]),eo("error"),eu(e?.message||"鄰近建案載入失敗")}},[eT]);return(0,a.useEffect)(()=>{if(!ed||0===eT.length){ei([]),eo("idle"),eu(null);return}return tB.current&&window.clearTimeout(tB.current),tB.current=window.setTimeout(()=>{li(ed)},280),()=>{tB.current&&window.clearTimeout(tB.current),tI.current&&tI.current.abort()}},[ed,eT,li]),(0,a.useEffect)(()=>{let e=v.current;if(!e||!B)return;rZ(e),rX(e,K),K?ll(e):J("idle");let t=()=>{ex(e.getZoom()),tF.current&&(tV.current&&window.clearTimeout(tV.current),tV.current=window.setTimeout(()=>{ll(e)},400)),t8.current.visible&&(t6.current&&window.clearTimeout(t6.current),t6.current=window.setTimeout(()=>{la(e)},450)),tH.current&&window.clearTimeout(tH.current),tH.current=window.setTimeout(()=>{rq({append:!1})},250)};return e.on("moveend",t),()=>{e.off("moveend",t),tV.current&&window.clearTimeout(tV.current),t6.current&&window.clearTimeout(t6.current),tH.current&&window.clearTimeout(tH.current)}},[B,K,rZ,rX,ll,la,rq]),(0,a.useEffect)(()=>{let e=v.current;e&&B&&(lt(e),lr(e),tw?la(e):(t4.current&&(t4.current.abort(),t4.current=null),t7.current=!1,t9.current=null,t_("idle"),tM(null)))},[B,tw,tS,lt,lr,la]),(0,a.useEffect)(()=>{B&&rq({append:!1})},[B,rq]),(0,a.useEffect)(()=>{if(2===eG.length){let e=eG[0],t=eG[1],r=k([e.lng,e.lat],[t.lng,t.lat]);tX.current={coordinates:[[e.lng,e.lat],[t.lng,t.lat]],label:`${r.toFixed(2)} km`}}else tX.current=null;tQ.current=eb,t0.current=eI,t1.current=eT.length>0||eR.length>0,t2.current=eG,t3.current={visible:tn,opacity:ts},t5.current={visible:th,opacity:tf},t8.current={visible:tw,opacity:tS},rs.current=tc,ro.current=tm;let e=v.current;e&&(r3(e),r1(e),r8(e),r9(e),lr(e))},[eb,eI,eT,eR,eG,tn,ts,tm,th,tf,tw,tS,r3,r1,r8,r9,lr]),(0,a.useEffect)(()=>{let e=v.current;if(!e||!B)return;let t=t=>{let r=e.queryRenderedFeatures(t.point,{layers:["project-points-layer"]}),l=r?.[0];if(!l||"Point"!==l.geometry.type)return;let a=l.properties||{},n=l.geometry.coordinates;rA({...a,longitude:n?.[0],latitude:n?.[1]})},r=t=>{let r=t.features?.[0];if(!r||"Point"!==r.geometry.type)return;let l=_(r.properties?.project_name||"建案"),a=r.geometry.coordinates;tJ.current||(tJ.current=new(i()).Popup({closeButton:!1,closeOnClick:!1,className:"sqm-map-tooltip",offset:12})),tZ.current!==l&&(tJ.current.setHTML(`<div class="text-[11px] font-medium">${l}</div>`),tZ.current=l),tJ.current.setLngLat(a).addTo(e),e.getCanvas().style.cursor="pointer"},l=()=>{e.getCanvas().style.cursor="",tZ.current=null,tJ.current&&(tJ.current.remove(),tJ.current=null)};return e.on("click",t),e.on("mousemove","project-points-layer",r),e.on("mouseleave","project-points-layer",l),()=>{e.off("click",t),e.off("mousemove","project-points-layer",r),e.off("mouseleave","project-points-layer",l),tJ.current&&(tJ.current.remove(),tJ.current=null)}},[B,rA]),(0,a.useEffect)(()=>{let e=v.current;if(!e||!B||!th)return;let t=t=>{let r=t.features?.[0];if(!r)return;let l=r.id;null!=l&&(null!==ri.current&&ri.current!==l&&e.setFeatureState({source:"district-boundary",id:ri.current},{hover:!1}),ri.current=l,e.setFeatureState({source:"district-boundary",id:l},{hover:!0}),e.getCanvas().style.cursor="pointer")},r=()=>{null!==ri.current&&(e.setFeatureState({source:"district-boundary",id:ri.current},{hover:!1}),ri.current=null),e.getCanvas().style.cursor="",ru.current&&(ru.current.remove(),ru.current=null)},l=t=>{let r=t.features?.[0];if(!r)return;let l=rL(r.properties);l.county&&(eF([l.county]),l.district?eP([l.district]):eP([]));let a=R(r);a&&e.fitBounds([[a.minLng,a.minLat],[a.maxLng,a.maxLat]],{padding:48,duration:600}),ru.current&&(ru.current.remove(),ru.current=null),rd.current||(rd.current=new(i()).Popup({closeButton:!1,closeOnClick:!1,className:"sqm-map-tooltip sqm-map-tooltip-action",offset:10}));let n=l.district||String(l.districtRaw||"").trim()||"行政區",s=l.county||String(l.countyRaw||"").trim(),o=l.district||String(l.districtRaw||"").trim(),c=l.county||String(l.countyRaw||"").trim(),u=document.createElement("div"),d=document.createElement("div");if(d.style.fontSize="12px",d.style.fontWeight="600",d.textContent=n,u.appendChild(d),s){let e=document.createElement("div");e.style.fontSize="10px",e.style.color="#94a3b8",e.style.marginTop="2px",e.textContent=s,u.appendChild(e)}let p=document.createElement("button");p.type="button",p.className="sqm-map-tooltip-action-btn",p.textContent="鄰里",o||(p.disabled=!0),p.addEventListener("click",t=>{var l,a;let n,i;if(t.preventDefault(),t.stopPropagation(),!o)return;c&&eF([c]),eP([o]),tx((l=P(c),a=P(o),n=$(["COUNTYNAME","countyname","COUNTY","COUNTY_N","CountyName","city","county"],l),i=$(["TOWNNAME","townname","TOWN","TOWN_N","TownName","district","town"],a),n&&i?["all",n,i]:n||i||null)),ti(!0),le(e);let s=R(r),u=()=>{12>e.getZoom()&&e.easeTo({zoom:12,duration:450})};s?(e.fitBounds([[s.minLng,s.minLat],[s.maxLng,s.maxLat]],{padding:48,duration:600}),e.once("moveend",u)):u()}),u.appendChild(p),u.addEventListener("click",e=>{e.stopPropagation()}),rp.current=!0,rd.current.setLngLat(t.lngLat).setDOMContent(u).addTo(e)},a=t=>{let r=["district-boundary-fill","project-points-layer","village-boundary-line"].filter(t=>e.getLayer(t));e.queryRenderedFeatures(t.point,{layers:r}).length>0||(rd.current&&(rd.current.remove(),rd.current=null),rp.current=!1)};return e.on("mousemove","district-boundary-fill",t),e.on("mouseleave","district-boundary-fill",r),e.on("click","district-boundary-fill",l),e.on("click",a),()=>{e.off("mousemove","district-boundary-fill",t),e.off("mouseleave","district-boundary-fill",r),e.off("click","district-boundary-fill",l),e.off("click",a),null!==ri.current&&(e.setFeatureState({source:"district-boundary",id:ri.current},{hover:!1}),ri.current=null),ru.current&&(ru.current.remove(),ru.current=null),rd.current&&(rd.current.remove(),rd.current=null),rp.current=!1,e.getCanvas().style.cursor=""}},[th,B,rL,le]),(0,a.useEffect)(()=>{let e=v.current;if(!e||!B||!tn)return;let t=t=>{let r=t.features?.[0];if(!r)return;let l=r.id;if(null==l)return;null!==rc.current&&rc.current!==l&&e.setFeatureState({source:"village-boundary",id:rc.current},{hover:!1}),rc.current=l,e.setFeatureState({source:"village-boundary",id:l},{hover:!0});let a=rM(r.properties),n=String(a.villageRaw||"").trim()||"里",s=a.district||String(a.districtRaw||"").trim(),o=a.county||String(a.countyRaw||"").trim();rm.current||(rm.current=new(i()).Popup({closeButton:!1,closeOnClick:!1,className:"sqm-map-tooltip",offset:10}));let c=[s,o].filter(Boolean).join(" \xb7 "),u=`
        <div style="font-size:12px;font-weight:600;">${_(n)}</div>
        ${c?`<div style="font-size:10px;color:#94a3b8;margin-top:2px;">${_(c)}</div>`:""}
      `;rm.current.setLngLat(t.lngLat).setHTML(u).addTo(e),e.getCanvas().style.cursor="pointer"},r=()=>{null!==rc.current&&(e.setFeatureState({source:"village-boundary",id:rc.current},{hover:!1}),rc.current=null),rm.current&&(rm.current.remove(),rm.current=null),e.getCanvas().style.cursor=""};return e.on("mousemove","village-boundary-line",t),e.on("mouseleave","village-boundary-line",r),()=>{e.off("mousemove","village-boundary-line",t),e.off("mouseleave","village-boundary-line",r),null!==rc.current&&(e.setFeatureState({source:"village-boundary",id:rc.current},{hover:!1}),rc.current=null),rm.current&&(rm.current.remove(),rm.current=null),e.getCanvas().style.cursor=""}},[tn,B,rM]),(0,l.jsxs)("div",{className:"flex flex-col w-full h-full gap-2",children:[!n&&(0,l.jsx)("div",{className:"flex flex-col gap-3 bg-zinc-900/90 backdrop-blur-md p-3 rounded-xl border border-white/10 shadow-lg flex-shrink-0 z-10 relative",children:(0,l.jsxs)("div",{className:"flex flex-wrap items-center gap-4",children:[(0,l.jsx)("div",{className:"w-32",children:(0,l.jsx)(d.K,{options:ry,value:eT,onChange:rF,placeholder:"選擇縣市..."})}),(0,l.jsx)("div",{className:"w-32",children:(0,l.jsx)(d.K,{options:rf,value:eR,onChange:rR,placeholder:eT.length>0?"選擇行政區...":"請先選縣市",disabled:0===eT.length})}),(0,l.jsx)("div",{className:"flex-1 min-w-[260px]",children:(0,l.jsx)(d.K,{options:rB,value:eI,onChange:rW,placeholder:eT.length>0?"輸入地址或建案名稱...":"請先選縣市",onSearch:rO,loading:eW||et||"loading"===es,disabled:0===eT.length})}),(0,l.jsxs)("div",{className:"flex items-center gap-4 border-l border-white/10 pl-4",children:[(0,l.jsxs)("div",{className:"flex items-center gap-2",children:[(0,l.jsx)("span",{className:"text-[11px] text-zinc-300 whitespace-nowrap",children:"行政區界線"}),(0,l.jsxs)("label",{className:"relative inline-flex items-center cursor-pointer",children:[(0,l.jsx)("input",{type:"checkbox",checked:th,onChange:e=>ty(e.target.checked),className:"sr-only peer"}),(0,l.jsx)("div",{className:"w-8 h-4 bg-zinc-700 peer-focus:outline-none rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-3 after:w-3 after:transition-all peer-checked:bg-cyan-600"})]}),th&&(0,l.jsx)("input",{type:"range",min:.2,max:1,step:.05,value:tf,onChange:e=>tg(parseFloat(e.target.value)),className:"w-16 h-1 ml-1"})]}),(0,l.jsxs)("div",{className:"flex items-center gap-2",children:[(0,l.jsx)("span",{className:"text-[11px] text-zinc-300 whitespace-nowrap",children:"捷運路線"}),(0,l.jsxs)("label",{className:"relative inline-flex items-center cursor-pointer",children:[(0,l.jsx)("input",{type:"checkbox",checked:tw,onChange:e=>tz(e.target.checked),className:"sr-only peer"}),(0,l.jsx)("div",{className:"w-8 h-4 bg-zinc-700 peer-focus:outline-none rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-3 after:w-3 after:transition-all peer-checked:bg-cyan-600"})]}),tw&&(0,l.jsx)("input",{type:"range",min:.2,max:1,step:.05,value:tS,onChange:e=>tC(parseFloat(e.target.value)),className:"w-16 h-1 ml-1"})]})]}),(0,l.jsxs)("div",{className:"flex items-center gap-3 border-l border-white/10 pl-4",children:[(0,l.jsxs)("label",{className:"flex items-center gap-2 text-[11px] text-zinc-300 whitespace-nowrap cursor-pointer",children:[(0,l.jsx)("input",{type:"checkbox",checked:K,onChange:e=>Y(e.target.checked),className:"h-3.5 w-3.5 accent-cyan-500 rounded border-zinc-700"}),"OSM 樓層"]}),(0,l.jsxs)("label",{className:"flex items-center gap-2 text-[11px] text-zinc-300 whitespace-nowrap cursor-pointer",children:[(0,l.jsx)("input",{type:"checkbox",checked:G,onChange:e=>q(e.target.checked),className:"h-3.5 w-3.5 accent-cyan-500 rounded border-zinc-700"}),"3D 建物"]})]}),(0,l.jsx)("div",{className:"flex items-center gap-1 border-l border-white/10 pl-4",children:rY.map(e=>{let t=rH[e.id]||s.A,r=V===e.id;return(0,l.jsx)("button",{onClick:()=>U(e.id),title:e.label,"aria-label":e.label,className:`h-7 w-7 flex items-center justify-center rounded-md border transition-all ${r?"bg-cyan-500/20 border-cyan-500 text-cyan-200":"bg-zinc-800/60 border-white/10 text-zinc-400 hover:border-white/30"}`,children:(0,l.jsx)(t,{className:"h-3.5 w-3.5"})},e.id)})}),(0,l.jsxs)("div",{className:"flex flex-wrap items-center gap-3 ml-auto",children:[(0,l.jsxs)("div",{className:"flex flex-wrap items-center gap-3 text-[10px] text-zinc-500",children:[eV&&(0,l.jsx)("span",{className:"text-rose-300",children:eV}),e1&&(0,l.jsx)("span",{className:"text-rose-300",children:e1}),eH&&(0,l.jsx)("span",{className:"text-rose-300",children:eH}),tj&&(0,l.jsx)("span",{className:"text-rose-300",children:tj}),td&&(0,l.jsx)("span",{className:"text-rose-300",children:td}),et&&(0,l.jsx)("span",{className:"text-cyan-300",children:"地址搜尋中..."}),"loading"===es&&(0,l.jsx)("span",{className:"text-cyan-300",children:"鄰近建案載入中..."}),ec&&(0,l.jsx)("span",{className:"text-rose-300",children:ec}),tL&&(0,l.jsx)("span",{className:"text-rose-300",children:tL}),eK&&(0,l.jsx)("span",{className:"text-cyan-300",children:"定位中..."}),eQ&&(0,l.jsxs)("span",{className:"text-cyan-300 flex items-center gap-1",children:[(0,l.jsx)(c.A,{className:"h-2.5 w-2.5 animate-spin"})," 讀取行政區清單"]}),"zoom"===eS&&(0,l.jsxs)("span",{className:"text-amber-300",children:["請放大至 z",eL,"+"]}),"range"===eS&&(0,l.jsxs)("span",{className:"text-amber-300",children:["範圍內縮至 ",eE,"km"]}),th&&"loading"===tb&&(0,l.jsx)("span",{className:"text-cyan-300",children:"載入行政區界線..."}),tn&&"loading"===tc&&(0,l.jsx)("span",{className:"text-cyan-300",children:"載入村里界線..."}),tn&&em>0&&em<12&&(0,l.jsx)("span",{className:"text-amber-300",children:"村里界線需放大至 z12+"}),tw&&"zoom"===tk&&(0,l.jsx)("span",{className:"text-amber-300",children:"捷運路線需放大至 z10+"}),"loading"===eS&&(0,l.jsxs)("span",{className:"text-cyan-300 flex items-center gap-1",children:[(0,l.jsx)(c.A,{className:"h-2.5 w-2.5 animate-spin"})," 建案載入中"]}),"error"===eS&&(0,l.jsx)("span",{className:"text-rose-300",children:"建案載入失敗"}),K&&"loading"===H&&(0,l.jsx)("span",{className:"text-cyan-300",children:"載入 OSM 建物中"}),K&&"zoom"===H&&(0,l.jsx)("span",{children:"OSM 建物需放大至 16+"}),K&&"error"===H&&(0,l.jsx)("span",{className:"text-rose-300",children:"OSM 載入失敗"}),tw&&"loading"===tk&&(0,l.jsx)("span",{className:"text-cyan-300",children:"載入捷運路線中"}),em>0&&(0,l.jsxs)("span",{className:"text-zinc-400",children:["縮放 z",em.toFixed(1)]})]}),(0,l.jsxs)("div",{className:"flex flex-wrap items-center gap-3 border-l border-white/10 pl-4",children:[(0,l.jsx)("span",{className:"text-zinc-400 font-semibold",children:"圖層控制:"}),eb.length>0&&(0,l.jsxs)("span",{className:"text-[10px] text-zinc-400 whitespace-nowrap",children:["共載入 ",eb.length.toLocaleString()," 個建案"]}),rK.map(e=>{let t=ef[e.id];return e.tiles?(0,l.jsxs)("div",{className:"flex items-center gap-2",children:[(0,l.jsxs)("label",{className:"flex items-center gap-1 cursor-pointer text-zinc-300",children:[(0,l.jsx)("input",{type:"checkbox",checked:t?.visible||!1,onChange:t=>eg(r=>({...r,[e.id]:{...r[e.id]||{opacity:.6,visible:!1},visible:t.target.checked}})),className:"h-3 w-3 accent-cyan-500 rounded border-zinc-700"}),e.label]}),t?.visible&&(0,l.jsx)("input",{type:"range",min:0,max:1,step:.05,value:t.opacity??.6,onChange:t=>eg(r=>({...r,[e.id]:{...r[e.id]||{visible:!1,opacity:.6},opacity:parseFloat(t.target.value)}})),className:"w-12 h-1"})]},e.id):null})]}),(0,l.jsxs)("div",{ref:tW,className:"relative flex items-center gap-3 border-l border-white/10 pl-4",children:[(0,l.jsxs)("button",{onClick:()=>ea(e=>!e),className:"rounded-lg bg-zinc-800/70 border border-white/10 px-2.5 py-1.5 text-[11px] text-zinc-200 hover:border-white/30 whitespace-nowrap",children:["載入設定 z",eL," / ",eE,"k"]}),el&&(0,l.jsxs)("div",{className:"absolute right-0 top-full mt-2 w-52 bg-zinc-950/95 border border-white/10 rounded-xl p-3 shadow-xl z-[120]",children:[(0,l.jsxs)("div",{className:"flex items-center gap-2 text-[10px] text-zinc-400 justify-between",children:[(0,l.jsxs)("span",{children:["載入敏感度 (z",eL,")"]}),(0,l.jsx)("input",{type:"range",min:10,max:18,step:1,value:eL,onChange:e=>eM(parseInt(e.target.value,10)),className:"w-16 h-1"})]}),(0,l.jsxs)("div",{className:"flex items-center gap-2 text-[10px] text-zinc-400 justify-between mt-2",children:[(0,l.jsxs)("span",{children:["最大範圍 (",eE,"k)"]}),(0,l.jsx)("input",{type:"range",min:4,max:60,step:1,value:eE,onChange:e=>eA(parseInt(e.target.value,10)),className:"w-16 h-1"})]})]}),ek&&(0,l.jsx)("button",{onClick:()=>rq({append:!0,cursor:ek}),disabled:ej,className:"hidden xl:block rounded bg-zinc-800 border border-white/10 px-2 py-1 text-[10px] text-zinc-200 hover:border-white/30 disabled:opacity-50 whitespace-nowrap",children:"分頁載入"})]})]})]})}),(0,l.jsxs)("div",{className:"relative flex-1 rounded-xl overflow-hidden border border-white/10 shadow-inner",children:[!B&&(0,l.jsx)("div",{className:"absolute inset-0 flex items-center justify-center bg-zinc-950/70 z-20",children:(0,l.jsxs)("div",{className:"flex flex-col items-center gap-3",children:[(0,l.jsx)(c.A,{className:"h-8 w-8 text-cyan-500 animate-spin"}),(0,l.jsx)("div",{className:"text-sm text-zinc-400",children:"正在載入地圖引擎..."})]})}),(0,l.jsx)("div",{ref:g,className:"w-full h-full"})]}),(0,l.jsx)(p.a,{isOpen:e3,onClose:()=>{e5(!1),e4(null)},title:e8?.project_name||"建案詳細資料",maxWidth:"max-w-6xl",children:(0,l.jsxs)("div",{className:"space-y-6 text-sm text-zinc-300",children:[(0,l.jsxs)("div",{className:"flex flex-wrap items-center justify-between gap-3",children:[(0,l.jsx)("div",{className:"text-[12px] text-zinc-400",children:e8?.developer&&(0,l.jsx)("span",{children:e8.developer})}),(0,l.jsx)("button",{onClick:rT,className:"rounded-lg bg-cyan-500/15 border border-cyan-400/40 px-3 py-1.5 text-[12px] text-cyan-200 hover:bg-cyan-500/25",children:"前往總儀表板（帶入建案條件）"})]}),(0,l.jsxs)("div",{className:"grid grid-cols-2 gap-4 text-[13px]",children:[(0,l.jsxs)("div",{children:[(0,l.jsx)("div",{className:"text-zinc-500 text-[11px]",children:"建商"}),(0,l.jsx)("div",{className:"text-zinc-100",children:L(e8?.developer)})]}),(0,l.jsxs)("div",{children:[(0,l.jsx)("div",{className:"text-zinc-500 text-[11px]",children:"營造"}),(0,l.jsx)("div",{className:"text-zinc-100",children:L(e8?.contractor)})]}),(0,l.jsxs)("div",{children:[(0,l.jsx)("div",{className:"text-zinc-500 text-[11px]",children:"建築設計"}),(0,l.jsx)("div",{className:"text-zinc-100",children:L(e8?.architect)})]}),(0,l.jsxs)("div",{children:[(0,l.jsx)("div",{className:"text-zinc-500 text-[11px]",children:"代銷企劃"}),(0,l.jsx)("div",{className:"text-zinc-100",children:L(e8?.sales_agent)})]}),(0,l.jsxs)("div",{children:[(0,l.jsx)("div",{className:"text-zinc-500 text-[11px]",children:"總戶數"}),(0,l.jsx)("div",{className:"text-zinc-100",children:L(e8?.total_households)})]}),(0,l.jsxs)("div",{children:[(0,l.jsx)("div",{className:"text-zinc-500 text-[11px]",children:"社區戶數"}),(0,l.jsx)("div",{className:"text-zinc-100",children:L(e8?.community_unit_count)})]}),(0,l.jsxs)("div",{children:[(0,l.jsx)("div",{className:"text-zinc-500 text-[11px]",children:"總樓層"}),(0,l.jsx)("div",{className:"text-zinc-100",children:L(e8?.total_floors)})]}),(0,l.jsxs)("div",{children:[(0,l.jsx)("div",{className:"text-zinc-500 text-[11px]",children:"地下層"}),(0,l.jsx)("div",{className:"text-zinc-100",children:L(e8?.basement_floors)})]}),(0,l.jsxs)("div",{children:[(0,l.jsx)("div",{className:"text-zinc-500 text-[11px]",children:"公設比"}),(0,l.jsx)("div",{className:"text-zinc-100",children:L(e8?.public_ratio)})]}),(0,l.jsxs)("div",{children:[(0,l.jsx)("div",{className:"text-zinc-500 text-[11px]",children:"基地面積"}),(0,l.jsx)("div",{className:"text-zinc-100",children:L(e8?.site_area)})]}),(0,l.jsxs)("div",{children:[(0,l.jsx)("div",{className:"text-zinc-500 text-[11px]",children:"土地分區"}),(0,l.jsx)("div",{className:"text-zinc-100",children:L(e8?.land_use_zoning)})]}),(0,l.jsxs)("div",{children:[(0,l.jsx)("div",{className:"text-zinc-500 text-[11px]",children:"地號"}),(0,l.jsx)("div",{className:"text-zinc-100",children:L(e8?.land_plot_number)})]}),(0,l.jsxs)("div",{children:[(0,l.jsx)("div",{className:"text-zinc-500 text-[11px]",children:"車位"}),(0,l.jsx)("div",{className:"text-zinc-100",children:L(e8?.parking_count)})]}),(0,l.jsxs)("div",{children:[(0,l.jsx)("div",{className:"text-zinc-500 text-[11px]",children:"車位型式"}),(0,l.jsx)("div",{className:"text-zinc-100",children:L(e8?.parking_type)})]}),(0,l.jsxs)("div",{className:"col-span-2",children:[(0,l.jsx)("div",{className:"text-zinc-500 text-[11px]",children:"關係企業"}),(0,l.jsx)("div",{className:"text-zinc-100",children:L(e8?.affiliated_companies)})]}),(0,l.jsxs)("div",{className:"col-span-2",children:[(0,l.jsx)("div",{className:"text-zinc-500 text-[11px]",children:"建造號碼"}),(0,l.jsx)("div",{className:"text-zinc-100",children:L(e8?.construction_license)})]})]}),(0,l.jsxs)("div",{className:"space-y-3",children:[(0,l.jsxs)("div",{className:"flex flex-wrap items-center justify-between gap-2",children:[(0,l.jsx)("div",{className:"text-sm font-semibold text-zinc-100",children:"精簡分析"}),(0,l.jsx)("div",{className:"text-[11px] text-zinc-500",children:"僅針對該建案交易明細"})]}),e7&&(0,l.jsxs)("div",{className:"text-[12px] text-cyan-300 flex items-center gap-2",children:[(0,l.jsx)(c.A,{className:"h-3 w-3 animate-spin"}),"讀取交易明細中..."]}),!e7&&tt&&(0,l.jsx)("div",{className:"text-[12px] text-rose-300",children:tt}),!e7&&!tt&&(0,l.jsxs)("div",{className:"space-y-4",children:[(0,l.jsxs)("div",{className:"grid grid-cols-1 lg:grid-cols-2 gap-4",children:[(0,l.jsxs)("div",{className:"rounded-lg border border-white/10 bg-zinc-900/60 p-3",children:[(0,l.jsx)("div",{className:"text-[13px] font-semibold text-zinc-100 mb-2",children:"總價帶詳細數據"}),rw.every(e=>0===e.count)?(0,l.jsx)("div",{className:"text-[12px] text-zinc-500 py-4 text-center",children:"無總價帶資料"}):(0,l.jsx)("div",{className:"overflow-x-auto",children:(0,l.jsxs)("table",{className:"min-w-[320px] w-full text-[11px]",children:[(0,l.jsx)("thead",{className:"text-zinc-400",children:(0,l.jsxs)("tr",{children:[(0,l.jsx)("th",{className:"py-1 text-left",children:"總價帶(萬)"}),(0,l.jsx)("th",{className:"py-1 text-right",children:"筆數"}),(0,l.jsx)("th",{className:"py-1 text-right",children:"平均"}),(0,l.jsx)("th",{className:"py-1 text-right",children:"區間"})]})}),(0,l.jsx)("tbody",{className:"text-zinc-200",children:rw.map(e=>(0,l.jsxs)("tr",{className:"border-t border-white/5",children:[(0,l.jsx)("td",{className:"py-1",children:e.label}),(0,l.jsx)("td",{className:"py-1 text-right",children:e.count}),(0,l.jsx)("td",{className:"py-1 text-right",children:null!==e.avg?e.avg.toFixed(0):"-"}),(0,l.jsx)("td",{className:"py-1 text-right",children:null!==e.min&&null!==e.max?`${e.min.toFixed(0)}~${e.max.toFixed(0)}`:"-"})]},e.label))})]})})]}),(0,l.jsxs)("div",{className:"rounded-lg border border-white/10 bg-zinc-900/60 p-3",children:[(0,l.jsx)("div",{className:"text-[13px] font-semibold text-zinc-100 mb-2",children:"各用途單價統計"}),0===rz.length?(0,l.jsx)("div",{className:"text-[12px] text-zinc-500 py-4 text-center",children:"無用途單價資料"}):(0,l.jsx)("div",{className:"overflow-x-auto",children:(0,l.jsxs)("table",{className:"min-w-[320px] w-full text-[11px]",children:[(0,l.jsx)("thead",{className:"text-zinc-400",children:(0,l.jsxs)("tr",{children:[(0,l.jsx)("th",{className:"py-1 text-left",children:"用途"}),(0,l.jsx)("th",{className:"py-1 text-right",children:"筆數"}),(0,l.jsx)("th",{className:"py-1 text-right",children:"平均單價"}),(0,l.jsx)("th",{className:"py-1 text-right",children:"最低"}),(0,l.jsx)("th",{className:"py-1 text-right",children:"最高"})]})}),(0,l.jsx)("tbody",{className:"text-zinc-200",children:rz.slice(0,6).map(e=>(0,l.jsxs)("tr",{className:"border-t border-white/5",children:[(0,l.jsx)("td",{className:"py-1",children:e.usage}),(0,l.jsx)("td",{className:"py-1 text-right",children:e.count}),(0,l.jsx)("td",{className:"py-1 text-right",children:e.avg.toFixed(2)}),(0,l.jsx)("td",{className:"py-1 text-right",children:e.min.toFixed(2)}),(0,l.jsx)("td",{className:"py-1 text-right",children:e.max.toFixed(2)})]},e.usage))})]})})]})]}),(0,l.jsxs)("div",{className:"grid grid-cols-1 lg:grid-cols-2 gap-4",children:[(0,l.jsxs)("div",{className:"rounded-lg border border-white/10 bg-zinc-900/60 p-3",children:[(0,l.jsx)("div",{className:"text-[13px] font-semibold text-zinc-100 mb-2",children:"簡化建案銷控表"}),0===rS.columns.length?(0,l.jsx)("div",{className:"text-[12px] text-zinc-500 py-4 text-center",children:"無銷控資料"}):(0,l.jsx)("div",{className:"overflow-x-auto",children:(0,l.jsxs)("table",{className:"min-w-[360px] w-full text-[11px]",children:[(0,l.jsx)("thead",{className:"text-zinc-400",children:(0,l.jsxs)("tr",{children:[(0,l.jsx)("th",{className:"py-1 text-left",children:"樓層"}),rS.columns.map(e=>(0,l.jsx)("th",{className:"py-1 text-right",children:e},e))]})}),(0,l.jsx)("tbody",{className:"text-zinc-200",children:rS.rows.map((e,t)=>(0,l.jsxs)("tr",{className:"border-t border-white/5",children:[(0,l.jsx)("td",{className:"py-1 text-left",children:e}),rS.matrix[t].map((t,r)=>{let a=t/rS.maxValue,n=0===t?0:.12+.48*a;return(0,l.jsx)("td",{className:"py-1 text-right",style:{backgroundColor:0===t?"transparent":`rgba(34, 211, 238, ${n})`},children:0===t?"-":t},`${e}-${rS.columns[r]}`)})]},e))})]})})]}),(0,l.jsxs)("div",{className:"rounded-lg border border-white/10 bg-zinc-900/60 p-3",children:[(0,l.jsx)("div",{className:"text-[13px] font-semibold text-zinc-100 mb-2",children:"房型面積分佈熱力圖"}),0===rC.selectedRooms.length?(0,l.jsx)("div",{className:"text-[12px] text-zinc-500 py-4 text-center",children:"無面積分佈資料"}):(0,l.jsx)(f.m,{data:rC.data,selectedRooms:rC.selectedRooms,minArea:rC.minArea,maxArea:rC.maxArea,interval:rC.interval,height:240,chartId:rx.current})]})]})]})]}),(0,l.jsxs)("div",{children:[(0,l.jsxs)("div",{className:"flex flex-wrap items-center justify-between gap-3 mb-3",children:[(0,l.jsx)("div",{className:"text-sm font-semibold text-zinc-100",children:"預售交易明細"}),(0,l.jsxs)("div",{className:"text-[11px] text-zinc-500",children:["共 ",e6.length.toLocaleString()," 筆"]})]}),(0,l.jsxs)("div",{className:"grid grid-cols-2 md:grid-cols-4 gap-3 mb-4 text-[12px]",children:[(0,l.jsxs)("div",{className:"rounded-lg border border-white/10 bg-zinc-900/60 px-3 py-2",children:[(0,l.jsx)("div",{className:"text-zinc-500 text-[10px]",children:"最高單價(萬)"}),(0,l.jsx)("div",{className:"text-zinc-100",children:null!==rN.max?rN.max.toFixed(2):"-"})]}),(0,l.jsxs)("div",{className:"rounded-lg border border-white/10 bg-zinc-900/60 px-3 py-2",children:[(0,l.jsx)("div",{className:"text-zinc-500 text-[10px]",children:"最低單價(萬)"}),(0,l.jsx)("div",{className:"text-zinc-100",children:null!==rN.min?rN.min.toFixed(2):"-"})]}),(0,l.jsxs)("div",{className:"rounded-lg border border-white/10 bg-zinc-900/60 px-3 py-2",children:[(0,l.jsx)("div",{className:"text-zinc-500 text-[10px]",children:"平均單價(萬)"}),(0,l.jsx)("div",{className:"text-zinc-100",children:null!==rN.avg?rN.avg.toFixed(2):"-"})]}),(0,l.jsxs)("div",{className:"rounded-lg border border-white/10 bg-zinc-900/60 px-3 py-2",children:[(0,l.jsx)("div",{className:"text-zinc-500 text-[10px]",children:"中位數(萬)"}),(0,l.jsx)("div",{className:"text-zinc-100",children:null!==rN.median?rN.median.toFixed(2):"-"})]})]}),e7&&(0,l.jsxs)("div",{className:"text-[12px] text-cyan-300 flex items-center gap-2",children:[(0,l.jsx)(c.A,{className:"h-3 w-3 animate-spin"}),"讀取交易明細中..."]}),tt&&(0,l.jsx)("div",{className:"text-[12px] text-rose-300",children:tt}),!e7&&!tt&&(0,l.jsxs)(l.Fragment,{children:[(0,l.jsx)("div",{className:"overflow-x-auto border border-white/10 rounded-lg",children:(0,l.jsxs)("table",{className:"min-w-[900px] w-full text-[12px]",children:[(0,l.jsx)("thead",{className:"bg-zinc-900/80 text-zinc-400",children:(0,l.jsxs)("tr",{children:[(0,l.jsx)("th",{className:"px-3 py-2 text-left",children:"交易日"}),(0,l.jsx)("th",{className:"px-3 py-2 text-left",children:"戶型"}),(0,l.jsx)("th",{className:"px-3 py-2 text-left",children:"樓層"}),(0,l.jsx)("th",{className:"px-3 py-2 text-right",children:"房屋面積(坪)"}),(0,l.jsx)("th",{className:"px-3 py-2 text-right",children:"房屋單價(萬)"}),(0,l.jsx)("th",{className:"px-3 py-2 text-right",children:"房屋總價(萬)"}),(0,l.jsx)("th",{className:"px-3 py-2 text-right",children:"交易總價(萬)"}),(0,l.jsx)("th",{className:"px-3 py-2 text-right",children:"車位總價(萬)"}),(0,l.jsx)("th",{className:"px-3 py-2 text-left",children:"備註"})]})}),(0,l.jsxs)("tbody",{className:"text-zinc-200",children:[0===rj.length&&(0,l.jsx)("tr",{children:(0,l.jsx)("td",{colSpan:9,className:"px-3 py-4 text-center text-zinc-500",children:"尚無交易明細"})}),rj.map((e,t)=>(0,l.jsxs)("tr",{className:"border-t border-white/5",children:[(0,l.jsx)("td",{className:"px-3 py-2 whitespace-nowrap",children:L(e["交易日"])}),(0,l.jsx)("td",{className:"px-3 py-2",children:L(e["戶型"]||e["戶別"])}),(0,l.jsx)("td",{className:"px-3 py-2",children:L(e["樓層"])}),(0,l.jsx)("td",{className:"px-3 py-2 text-right",children:L(e["房屋面積(坪)"])}),(0,l.jsx)("td",{className:"px-3 py-2 text-right",children:L(e["房屋單價(萬)"])}),(0,l.jsx)("td",{className:"px-3 py-2 text-right",children:L(e["房屋總價(萬)"])}),(0,l.jsx)("td",{className:"px-3 py-2 text-right",children:L(e["交易總價(萬)"])}),(0,l.jsx)("td",{className:"px-3 py-2 text-right",children:L(e["車位總價(萬)"])}),(0,l.jsx)("td",{className:"px-3 py-2",children:L(e["備註"])})]},e["編號"]||t))]})]})}),rv>1&&(0,l.jsxs)("div",{className:"flex items-center justify-end gap-2 mt-3 text-[11px] text-zinc-400",children:[(0,l.jsx)("button",{onClick:()=>ta(e=>Math.max(1,e-1)),disabled:1===tl,className:"px-2 py-1 rounded border border-white/10 disabled:opacity-50",children:"上一頁"}),(0,l.jsxs)("span",{children:[tl," / ",rv]}),(0,l.jsx)("button",{onClick:()=>ta(e=>Math.min(rv,e+1)),disabled:tl>=rv,className:"px-2 py-1 rounded border border-white/10 disabled:opacity-50",children:"下一頁"})]})]})]})]})})]})}},23879:()=>{},33024:(e,t,r)=>{"use strict";r.d(t,{A:()=>l});let l=(0,r(78340).A)("layers",[["path",{d:"M12.83 2.18a2 2 0 0 0-1.66 0L2.6 6.08a1 1 0 0 0 0 1.83l8.58 3.91a2 2 0 0 0 1.66 0l8.58-3.9a1 1 0 0 0 0-1.83z",key:"zw3jo"}],["path",{d:"M2 12a1 1 0 0 0 .58.91l8.6 3.91a2 2 0 0 0 1.65 0l8.58-3.9A1 1 0 0 0 22 12",key:"1wduqc"}],["path",{d:"M2 17a1 1 0 0 0 .58.91l8.6 3.91a2 2 0 0 0 1.65 0l8.58-3.9A1 1 0 0 0 22 17",key:"kqbvx6"}]])},33210:(e,t,r)=>{"use strict";r.d(t,{A:()=>l});let l=(0,r(78340).A)("x",[["path",{d:"M18 6 6 18",key:"1bl5f8"}],["path",{d:"m6 6 12 12",key:"d8bk6v"}]])},34198:(e,t,r)=>{"use strict";r.d(t,{K:()=>o});var l=r(95155),a=r(12115),n=r(40980),i=r(33210),s=r(94514);let o=(0,a.forwardRef)(({options:e,value:t,onChange:r,placeholder:o="Select...",maxItems:c,disabled:u=!1,className:d,onSearch:p,loading:m=!1,onFocus:x},h)=>{let[y,f]=(0,a.useState)(""),[g,b]=(0,a.useState)(!1),v=(0,a.useRef)(null),j=(0,a.useRef)(null),N=p?e:e.filter(e=>e.label.toLowerCase().includes(y.toLowerCase()));return t.map(t=>{let r=e.find(e=>e.value===t);return r?r.label:t}),(0,a.useEffect)(()=>{let e=e=>{v.current&&!v.current.contains(e.target)&&b(!1)};return document.addEventListener("mousedown",e),()=>document.removeEventListener("mousedown",e)},[]),(0,a.useEffect)(()=>{p&&p(y)},[y,p]),(0,l.jsxs)("div",{className:(0,n.cn)("relative w-full",d),ref:v,children:[(0,l.jsxs)("div",{className:(0,n.cn)("flex items-center gap-2 bg-zinc-950/50 border border-input rounded-md px-2 py-1.5 h-[42px] overflow-x-auto custom-scrollbar cursor-text transition-all",g&&"ring-2 ring-ring ring-offset-0 border-ring",u&&"bg-zinc-900/50 cursor-not-allowed opacity-50"),onClick:()=>!u&&j.current?.focus(),children:[t.map(a=>{let n=e.find(e=>e.value===a),s=n?n.label:a,o=n?.renderLabel??s;return(0,l.jsxs)("span",{className:"bg-violet-500/20 text-violet-200 border border-violet-500/30 text-xs rounded-full px-2 py-0.5 flex items-center gap-1 animate-in fade-in zoom-in-95 duration-100 whitespace-nowrap shrink-0",children:[o,!u&&(0,l.jsx)(i.A,{size:12,className:"cursor-pointer hover:text-white transition-colors",onClick:e=>{e.stopPropagation(),r(t.filter(e=>e!==a))}})]},a)}),(0,l.jsx)("input",{ref:j,type:"text",value:y,onChange:e=>f(e.target.value),onFocus:()=>{b(!0),x?.()},onKeyDown:e=>{"Backspace"===e.key&&""===y&&t.length>0&&r(t.slice(0,-1))},placeholder:0===t.length?o:"",className:(0,n.cn)("bg-transparent outline-none flex-grow min-w-[60px] text-zinc-100 placeholder:text-zinc-500 text-sm",u&&"cursor-not-allowed"),disabled:u})]}),g&&!u&&(0,l.jsx)("div",{className:"absolute z-[110] w-full mt-1 bg-zinc-900 border border-zinc-700 rounded-md shadow-xl max-h-60 overflow-y-auto custom-scrollbar animate-in fade-in slide-in-from-top-2 duration-100",children:m?(0,l.jsx)("div",{className:"p-2 text-center text-zinc-500 text-sm",children:"Loading..."}):0===N.length?(0,l.jsx)("div",{className:"p-2 text-center text-zinc-500 text-sm",children:"No options found"}):N.map((e,i)=>{if(!e)return null;let o=0===i||e.group!==N[i-1]?.group;return(0,l.jsxs)(a.Fragment,{children:[o&&e.group&&(0,l.jsx)("div",{className:"px-2 py-1 bg-zinc-800/50 text-xs font-semibold text-zinc-400 sticky top-0 backdrop-blur-sm z-10",children:e.group}),(0,l.jsxs)("div",{className:(0,n.cn)("px-3 py-2 cursor-pointer text-sm flex items-start justify-between hover:bg-zinc-800 transition-colors",t.includes(e.value)&&"bg-violet-500/10 text-violet-400"),onClick:()=>(e=>{if(t.includes(e))r(t.filter(t=>t!==e));else{if(c&&t.length>=c)return;r([...t,e])}f("")})(e.value),children:[(0,l.jsxs)("div",{className:"flex flex-col",children:[(0,l.jsx)("span",{className:"font-medium",children:e.renderLabel??e.label}),e.details&&(0,l.jsxs)("div",{className:"flex items-center gap-2 mt-0.5",children:[(e.details.county||e.details.district)&&(0,l.jsxs)("span",{className:"text-xs text-zinc-500 bg-zinc-800/80 px-1.5 rounded border border-zinc-700",children:[e.details.county,e.details.district]}),e.details.date&&(0,l.jsx)("span",{className:"text-xs text-zinc-600 font-mono",children:e.details.date.substring(0,7)})]})]}),t.includes(e.value)&&(0,l.jsx)(s.A,{size:16,className:"mt-1"})]})]},e.value)})})]})});o.displayName="MultiSelect"},94514:(e,t,r)=>{"use strict";r.d(t,{A:()=>l});let l=(0,r(78340).A)("check",[["path",{d:"M20 6 9 17l-5-5",key:"1gmf2c"}]])}}]);