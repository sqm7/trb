(self.webpackChunk_N_E=self.webpackChunk_N_E||[]).push([[117],{117:(e,t,r)=>{"use strict";r.r(t),r.d(t,{default:()=>p});var l=r(95155),i=r(12115),a=r(36379),s=r.n(a);r(23879);var o=r(56572),n=r(33024);let c=(0,r(78340).A)("palette",[["path",{d:"M12 22a1 1 0 0 1 0-20 10 9 0 0 1 10 9 5 5 0 0 1-5 5h-2.25a1.75 1.75 0 0 0-1.4 2.8l.3.4a1.75 1.75 0 0 1-1.4 2.8z",key:"e79jfc"}],["circle",{cx:"13.5",cy:"6.5",r:".5",fill:"currentColor",key:"1okk4w"}],["circle",{cx:"17.5",cy:"10.5",r:".5",fill:"currentColor",key:"f64h9f"}],["circle",{cx:"6.5",cy:"12.5",r:".5",fill:"currentColor",key:"qy21gx"}],["circle",{cx:"8.5",cy:"7.5",r:".5",fill:"currentColor",key:"fotxhn"}]]);var d=r(41463);let u=[121.5318,25.0478];function p(){let e=(0,i.useRef)(null),t=(0,i.useRef)(null),[r,a]=(0,i.useState)(!1),p="1GYoblfxWX2uc8edFcbq",[y,b]=(0,i.useState)(p?"streets-v2":"demo"),[x,f]=(0,i.useState)(!0),[g,m]=(0,i.useState)("default"),[h,v]=(0,i.useState)(!1),[w,j]=(0,i.useState)("idle"),[P,k]=(0,i.useState)({zoning:{visible:!1,opacity:.6},cadastral:{visible:!1,opacity:.6}}),N=(0,i.useRef)(P),z=(0,i.useRef)(x),L=(0,i.useRef)(g),S=(0,i.useRef)(h),C=(0,i.useRef)(null),M=(0,i.useRef)(null),$=(0,i.useRef)(null),E=(0,i.useRef)(!1),A=(0,i.useMemo)(()=>[{id:"zoning",label:"國土利用現況調查成果圖",tiles:"https://wmts.nlsc.gov.tw/wmts/LUIMAP/default/GoogleMapsCompatible/{z}/{y}/{x}"},{id:"cadastral",label:"段籍圖（地籍）",tiles:"https://wmts.nlsc.gov.tw/wmts/LANDSECT/default/GoogleMapsCompatible/{z}/{y}/{x}"}],[]),R=(0,i.useMemo)(()=>{let e={id:"demo",label:"開源預設",url:"https://demotiles.maplibre.org/style.json"},t=d.env.NEXT_PUBLIC_MAP_CUSTOM_STYLE_URL,r=t?[{id:"custom",label:"商業配色",url:t}]:[],l=[{id:"streets-v2",label:"街景",url:`https://api.maptiler.com/maps/streets-v2/style.json?key=${p}`},{id:"basic-v2",label:"極簡",url:`https://api.maptiler.com/maps/basic-v2/style.json?key=${p}`},{id:"topo-v2",label:"地形",url:`https://api.maptiler.com/maps/topo-v2/style.json?key=${p}`},{id:"dataviz",label:"數據",url:`https://api.maptiler.com/maps/dataviz/style.json?key=${p}`}];return p?[...r,...l]:r.length?[...r,e]:[e]},[p]),_=(0,i.useCallback)(e=>{let t=L.current;if("default"===t)return;let r="cyberpunk"===t?{background:"#05020d",land:"#0d0b1f",landSecondary:"#12162a",water:"#00d1ff",park:"#0f3b2e",road:"#3a2b5a",roadMajor:"#ff2bd6",boundary:"#2a1a52",building:"#121022",text:"#e5e7ff",textHalo:"#05020d",poi:"#7dd3fc"}:"neon"===t?{background:"#06070b",land:"#0b0f1a",landSecondary:"#0f172a",water:"#22d3ee",park:"#0b3b3b",road:"#1f2a44",roadMajor:"#22c55e",boundary:"#1f2937",building:"#0b1327",text:"#e2f2ff",textHalo:"#05070d",poi:"#f472b6"}:"graphite"===t?{background:"#0b0c10",land:"#12141b",landSecondary:"#171a22",water:"#475569",park:"#1f2937",road:"#2b313c",roadMajor:"#94a3b8",boundary:"#232833",building:"#111827",text:"#e5e7eb",textHalo:"#0b0c10",poi:"#cbd5f5"}:{background:"#0b0d13",land:"#111827",landSecondary:"#0f172a",water:"#0ea5e9",park:"#0f3d2e",road:"#334155",roadMajor:"#38bdf8",boundary:"#1f2937",building:"#0f172a",text:"#e2e8f0",textHalo:"#020617",poi:"#22d3ee"},l=e.getStyle();if(!l?.layers)return;l.layers.forEach(t=>{let l=t.id,i=t["source-layer"],a=l.toLowerCase();if("background"===t.type&&e.setPaintProperty(l,"background-color",r.background),"fill"===t.type&&("water"===i?e.setPaintProperty(l,"fill-color",r.water):"landcover"===i||"landuse"===i||a.includes("land")?e.setPaintProperty(l,"fill-color",r.land):(a.includes("park")||a.includes("garden"))&&e.setPaintProperty(l,"fill-color",r.park)),"line"===t.type){if("waterway"===i)e.setPaintProperty(l,"line-color",r.water);else if("boundary"===i)e.setPaintProperty(l,"line-color",r.boundary);else if("transportation"===i||"road"===i||a.includes("road")){let t=a.includes("motorway")||a.includes("trunk")||a.includes("primary");e.setPaintProperty(l,"line-color",t?r.roadMajor:r.road)}}"fill-extrusion"===t.type&&"building"===i&&e.setPaintProperty(l,"fill-extrusion-color",r.building),"symbol"===t.type&&t.layout?.["text-field"]&&(e.setPaintProperty(l,"text-color",r.text),e.setPaintProperty(l,"text-halo-color",r.textHalo),e.setPaintProperty(l,"text-halo-width",1.2),a.includes("poi")&&e.setPaintProperty(l,"text-color",r.poi))});let i="gov-cadastral-layer";if(e.getLayer(i)){let r="cyberpunk"===t||"neon"===t?{contrast:.6,min:.2,max:1.7,saturation:1.25}:"graphite"===t?{contrast:.4,min:.2,max:1.4,saturation:.9}:{contrast:.35,min:.25,max:1.35,saturation:1.05};e.setPaintProperty(i,"raster-contrast",r.contrast),e.setPaintProperty(i,"raster-brightness-min",r.min),e.setPaintProperty(i,"raster-brightness-max",r.max),e.setPaintProperty(i,"raster-saturation",r.saturation)}let a="osm-buildings-fill",s="osm-buildings-outline",o="osm-buildings-label";e.getLayer(a)&&(e.setPaintProperty(a,"fill-color",r.roadMajor),e.setPaintProperty(a,"fill-opacity",.18)),e.getLayer(s)&&(e.setPaintProperty(s,"line-color",r.poi),e.setPaintProperty(s,"line-opacity",.65)),e.getLayer(o)&&(e.setPaintProperty(o,"text-color",r.text),e.setPaintProperty(o,"text-halo-color",r.textHalo),e.setPaintProperty(o,"text-halo-width",1.1))},[]),T=(0,i.useCallback)(e=>{e.getSource("osm-buildings")||e.addSource("osm-buildings",{type:"geojson",data:{type:"FeatureCollection",features:[]}}),e.getLayer("osm-buildings-fill")||e.addLayer({id:"osm-buildings-fill",type:"fill",source:"osm-buildings",paint:{"fill-color":"#38bdf8","fill-opacity":.18}}),e.getLayer("osm-buildings-outline")||e.addLayer({id:"osm-buildings-outline",type:"line",source:"osm-buildings",paint:{"line-color":"#22d3ee","line-width":1.2,"line-opacity":.6}}),e.getLayer("osm-buildings-label")||e.addLayer({id:"osm-buildings-label",type:"symbol",source:"osm-buildings",layout:{"text-field":["get","levelsLabel"],"text-size":11,"text-anchor":"center","text-allow-overlap":!0},paint:{"text-color":"#e2e8f0","text-halo-color":"#0b0d13","text-halo-width":1.1}})},[]),O=(0,i.useCallback)((e,t)=>{let r=t?"visible":"none";e.getLayer("osm-buildings-fill")&&e.setLayoutProperty("osm-buildings-fill","visibility",r),e.getLayer("osm-buildings-outline")&&e.setLayoutProperty("osm-buildings-outline","visibility",r),e.getLayer("osm-buildings-label")&&e.setLayoutProperty("osm-buildings-label","visibility",r)},[]),F=(0,i.useCallback)(async e=>{if(16>e.getZoom())return void j("zoom");let t=e.getBounds(),r=`${t.getSouth()},${t.getWest()},${t.getNorth()},${t.getEast()}`;if(r===$.current)return;$.current=r,C.current&&C.current.abort();let l=new AbortController;C.current=l,j("loading");let i=`[out:json][timeout:25];
(
  way["building"]["building:levels"](${r});
  way["building"]["levels"](${r});
);
out tags geom;`;try{let t=await fetch("https://overpass-api.de/api/interpreter",{method:"POST",body:i,signal:l.signal,headers:{"Content-Type":"text/plain"}});if(!t.ok)throw Error(`OSM fetch failed: ${t.status}`);let r=await t.json(),a=(r?.elements||[]).filter(e=>"way"===e.type&&Array.isArray(e.geometry)).map(e=>{let t=e.tags||{},r=t["building:levels"]||t.levels,l=Number.parseInt(r,10);if(!l||!e.geometry)return null;let i=e.geometry.map(e=>[e.lon,e.lat]);if(i.length<3)return null;let a=i[0],s=i[i.length-1];return(a[0]!==s[0]||a[1]!==s[1])&&i.push(a),{type:"Feature",properties:{id:e.id,levels:l,levelsLabel:`${l}F`},geometry:{type:"Polygon",coordinates:[i]}}}).filter(Boolean);e.getSource("osm-buildings").setData({type:"FeatureCollection",features:a}),j("ready")}catch(e){if(e?.name==="AbortError")return;console.warn("OSM levels fetch error",e),j("error")}},[]),H=(0,i.useCallback)(e=>{if(!z.current)return;let t=e.getStyle();if(!t?.layers)return;let r=t.layers.find(e=>"symbol"===e.type&&e.layout?.["text-field"])?.id,l=e.getSource("openmaptiles")?"openmaptiles":e.getSource("maptiler")?"maptiler":null;!l||e.getLayer("3d-buildings")||e.addLayer({id:"3d-buildings",source:l,"source-layer":"building",type:"fill-extrusion",minzoom:15,paint:{"fill-extrusion-color":"#64748b","fill-extrusion-height":["coalesce",["get","render_height"],["get","height"],6],"fill-extrusion-base":["coalesce",["get","render_min_height"],["get","min_height"],0],"fill-extrusion-opacity":.85}},r)},[]);return(0,i.useEffect)(()=>{if(!e.current||t.current)return;let r=R.find(e=>e.id===y)?.url||"https://demotiles.maplibre.org/style.json",l=new(s()).Map({container:e.current,style:r,center:u,zoom:14,pitch:45,bearing:-15,antialias:!0});l.addControl(new(s()).NavigationControl({showCompass:!0}),"top-right"),l.on("style.load",()=>{H(l),A.forEach(e=>{if(!e.tiles)return;let t=`gov-${e.id}`,r=`gov-${e.id}-layer`;l.getSource(t)||l.addSource(t,{type:"raster",tiles:[e.tiles],tileSize:256}),l.getLayer(r)||l.addLayer({id:r,type:"raster",source:t,layout:{visibility:"none"},paint:{"raster-opacity":N.current[e.id]?.opacity??.6}})}),A.forEach(e=>{if(!e.tiles)return;let t=`gov-${e.id}-layer`;if(!l.getLayer(t))return;let r=N.current[e.id];r&&(l.setLayoutProperty(t,"visibility",r.visible?"visible":"none"),l.setPaintProperty(t,"raster-opacity",r.opacity))}),T(l),O(l,S.current),S.current&&F(l),_(l),E.current||(E.current=!0,a(!0))}),t.current=l;let i=new ResizeObserver(()=>l.resize());return i.observe(e.current),()=>{i.disconnect(),l.remove(),t.current=null}},[]),(0,i.useEffect)(()=>{z.current=x,L.current=g,S.current=h,N.current=P;let e=t.current;e&&A.forEach(t=>{if(!t.tiles)return;let r=`gov-${t.id}-layer`;if(!e.getLayer(r))return;let l=P[t.id];l&&(e.setLayoutProperty(r,"visibility",l.visible?"visible":"none"),e.setPaintProperty(r,"raster-opacity",l.opacity))})},[P,A]),(0,i.useEffect)(()=>{let e=t.current;if(e){if(!x){e.getLayer("3d-buildings")&&e.removeLayer("3d-buildings"),e.easeTo({pitch:0,bearing:0,duration:450});return}H(e),e.easeTo({pitch:45,bearing:-15,duration:450})}},[x,H]),(0,i.useEffect)(()=>{let e=t.current;if(!e)return;let r=R.find(e=>e.id===y)?.url;r&&e.setStyle(r,{diff:!1})},[y,R]),(0,i.useEffect)(()=>{let e=t.current;e&&r&&_(e)},[g,r,_]),(0,i.useEffect)(()=>{let e=t.current;if(!e||!r)return;T(e),O(e,h),h?F(e):j("idle");let l=()=>{S.current&&(M.current&&window.clearTimeout(M.current),M.current=window.setTimeout(()=>{F(e)},400))};return e.on("moveend",l),()=>{e.off("moveend",l),M.current&&window.clearTimeout(M.current)}},[r,h,T,O,F]),(0,l.jsxs)("div",{className:"relative w-full h-full rounded-xl overflow-hidden border border-white/10 shadow-2xl",children:[(0,l.jsxs)("div",{className:"absolute top-4 left-4 z-10 rounded-full bg-zinc-900/80 px-3 py-1 text-xs text-zinc-300 border border-white/10 flex items-center gap-2",children:[(0,l.jsx)(o.A,{className:"h-3.5 w-3.5 text-cyan-400"}),"MapLibre + MapTiler"]}),(0,l.jsxs)("div",{className:"absolute top-4 left-44 z-10 rounded-full bg-zinc-900/80 px-2 py-1 text-[11px] text-zinc-300 border border-white/10 flex items-center gap-2",children:[(0,l.jsx)("span",{className:"text-zinc-400",children:"視角"}),(0,l.jsx)("button",{onClick:()=>f(!0),className:`rounded-full px-2 py-0.5 ${x?"bg-cyan-500/20 text-cyan-200":"text-zinc-400 hover:text-zinc-200"}`,children:"3D"}),(0,l.jsx)("button",{onClick:()=>f(!1),className:`rounded-full px-2 py-0.5 ${!x?"bg-cyan-500/20 text-cyan-200":"text-zinc-400 hover:text-zinc-200"}`,children:"平面"})]}),(0,l.jsxs)("div",{className:"absolute top-4 right-4 z-10 rounded-2xl bg-zinc-900/85 px-4 py-3 text-[11px] text-zinc-300 border border-white/10 shadow-lg space-y-3 w-64",children:[(0,l.jsxs)("div",{className:"flex items-center gap-2 text-xs font-semibold text-white",children:[(0,l.jsx)(n.A,{className:"h-4 w-4 text-cyan-400"}),"圖層控制"]}),(0,l.jsx)("div",{className:"space-y-3",children:A.map(e=>{let t=P[e.id],r=!e.tiles;return(0,l.jsxs)("div",{className:r?"opacity-40":"",children:[(0,l.jsxs)("label",{className:"flex items-center justify-between gap-3 text-xs text-zinc-300",children:[(0,l.jsx)("span",{children:e.label}),(0,l.jsx)("input",{type:"checkbox",checked:t?.visible||!1,onChange:t=>k(r=>({...r,[e.id]:{...r[e.id]||{opacity:.6,visible:!1},visible:t.target.checked}})),className:"h-4 w-4 accent-cyan-500",disabled:r})]}),(0,l.jsxs)("label",{className:"space-y-1 text-[10px] text-zinc-500",children:[(0,l.jsx)("span",{children:"透明度"}),(0,l.jsx)("input",{type:"range",min:0,max:1,step:.05,value:t?.opacity??.6,onChange:t=>k(r=>({...r,[e.id]:{...r[e.id]||{visible:!1,opacity:.6},opacity:parseFloat(t.target.value)}})),className:"w-full",disabled:r})]}),r&&(0,l.jsx)("div",{className:"text-[10px] text-zinc-600",children:"未設定圖資 URL"})]},e.id)})}),(0,l.jsxs)("div",{className:"pt-2 border-t border-white/10 space-y-2",children:[(0,l.jsx)("div",{className:"text-xs text-white font-semibold",children:"OpenStreetMap"}),(0,l.jsxs)("label",{className:"flex items-center justify-between gap-3 text-xs text-zinc-300",children:[(0,l.jsx)("span",{children:"建物樓層（OSM）"}),(0,l.jsx)("input",{type:"checkbox",checked:h,onChange:e=>v(e.target.checked),className:"h-4 w-4 accent-cyan-500"})]}),(0,l.jsx)("div",{className:"text-[10px] text-zinc-500",children:"放大到 16+ 才會載入"}),h&&"loading"===w&&(0,l.jsx)("div",{className:"text-[10px] text-cyan-300",children:"載入建物樓層中..."}),h&&"zoom"===w&&(0,l.jsx)("div",{className:"text-[10px] text-zinc-500",children:"請再放大一些"}),h&&"error"===w&&(0,l.jsx)("div",{className:"text-[10px] text-rose-300",children:"OSM 讀取失敗，稍後再試"})]}),(0,l.jsxs)("div",{className:"pt-2 border-t border-white/10 space-y-2",children:[(0,l.jsxs)("div",{className:"text-xs text-white font-semibold flex items-center gap-2",children:[(0,l.jsx)(o.A,{className:"h-3.5 w-3.5 text-cyan-400"}),"底圖風格"]}),(0,l.jsx)("div",{className:"grid grid-cols-2 gap-2",children:R.map(e=>(0,l.jsx)("button",{onClick:()=>b(e.id),className:`rounded-lg px-2 py-1 text-[10px] border transition-colors ${y===e.id?"border-cyan-500 text-cyan-200 bg-cyan-500/10":"border-white/10 text-zinc-400 hover:border-white/30"}`,children:e.label},e.id))}),(0,l.jsx)("div",{className:"text-[10px] text-zinc-500",children:"3D 建物已啟用（縮放 15+）"})]}),(0,l.jsxs)("div",{className:"pt-2 border-t border-white/10 space-y-2",children:[(0,l.jsxs)("div",{className:"text-xs text-white font-semibold flex items-center gap-2",children:[(0,l.jsx)(c,{className:"h-3.5 w-3.5 text-cyan-400"}),"配色"]}),(0,l.jsx)("div",{className:"grid grid-cols-3 gap-2",children:["default","dark","cyberpunk","graphite","neon"].map(e=>(0,l.jsx)("button",{onClick:()=>m(e),className:`rounded-lg px-2 py-1 text-[10px] border transition-colors ${g===e?"border-cyan-500 text-cyan-200 bg-cyan-500/10":"border-white/10 text-zinc-400 hover:border-white/30"}`,children:"default"===e?"預設":"dark"===e?"深色":"cyberpunk"===e?"賽博":"graphite"===e?"石墨":"霓虹"},e))}),(0,l.jsx)("div",{className:"text-[10px] text-zinc-500",children:"深色系會重新套色"})]})]}),!r&&(0,l.jsx)("div",{className:"absolute inset-0 flex items-center justify-center bg-zinc-950/70 z-20",children:(0,l.jsx)("div",{className:"text-sm text-zinc-400",children:"正在載入地圖引擎..."})}),(0,l.jsx)("div",{ref:e,className:"w-full h-full"})]})}},23879:()=>{},33024:(e,t,r)=>{"use strict";r.d(t,{A:()=>l});let l=(0,r(78340).A)("layers",[["path",{d:"M12.83 2.18a2 2 0 0 0-1.66 0L2.6 6.08a1 1 0 0 0 0 1.83l8.58 3.91a2 2 0 0 0 1.66 0l8.58-3.9a1 1 0 0 0 0-1.83z",key:"zw3jo"}],["path",{d:"M2 12a1 1 0 0 0 .58.91l8.6 3.91a2 2 0 0 0 1.65 0l8.58-3.9A1 1 0 0 0 22 12",key:"1wduqc"}],["path",{d:"M2 17a1 1 0 0 0 .58.91l8.6 3.91a2 2 0 0 0 1.65 0l8.58-3.9A1 1 0 0 0 22 17",key:"kqbvx6"}]])}}]);