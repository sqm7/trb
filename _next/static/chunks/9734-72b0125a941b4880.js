"use strict";(self.webpackChunk_N_E=self.webpackChunk_N_E||[]).push([[9734],{39734:(e,t,r)=>{r.d(t,{g:()=>y});var a=r(12115),i=r(27529),n=r(88743),o=r(55873),c=r(98883),s=r(89579),l=r(56722);function u(e,t){var r,a;return t?e?(t.transactionDetails&&Array.isArray(t.transactionDetails)&&(e.transactionDetails||(e.transactionDetails=[]),e.transactionDetails=[...e.transactionDetails,...t.transactionDetails]),e.coreMetrics=function(e,t){if(!t)return e;if(!e)return t;let r=(e.totalSaleAmount||0)+(t.totalSaleAmount||0),a=(e.totalHouseArea||0)+(t.totalHouseArea||0);return{totalSaleAmount:r,totalHouseArea:a,overallAveragePrice:a>0?r/a:0,transactionCount:(e.transactionCount||0)+(t.transactionCount||0),medianPrice:0,q1Price:0,q3Price:0,minPrice:Math.min(e.minPrice||1/0,t.minPrice||1/0),maxPrice:Math.max(e.maxPrice||0,t.maxPrice||0)}}(e.coreMetrics,t.coreMetrics),t.projectRanking&&Array.isArray(t.projectRanking)&&(e.projectRanking=[...e.projectRanking,...t.projectRanking]),e.priceBandAnalysis=function(e,t){if(!t)return e;let r=Array.isArray(e)?e:e?.details||[],a=Array.isArray(t)?t:t?.details||[],i=e?.locationCrossTable||{},n=t?.locationCrossTable||{},o=e?.allDistricts||[],c=t?.allDistricts||[],s=e?.allRoomTypes||[],l=t?.allRoomTypes||[],u=new Map,m=e=>{let t=null!==e.bathrooms&&void 0!==e.bathrooms?String(e.bathrooms):"null",r=(e.roomType||"").replace(/\s+/g,""),a=`${r}-${t}`,i=Number(e.count)||0,n=Number(e.avgPrice)||0,o=Number(e.minPrice)||0,c=Number(e.maxPrice)||0;if(u.has(a)){let t=u.get(a),r=Number(t.count)||0,s=Number(t.avgPrice)||0,l=n*i,m=r+i,y=m>0?(s*r+l)/m:0;if(t.count=m,t.avgPrice=parseFloat(y.toFixed(2)),t.minPrice=Math.min(t.minPrice,o),t.maxPrice=Math.max(t.maxPrice,c),e.projectNames){let r=new Set([...t.projectNames,...e.projectNames]);t.projectNames=Array.from(r)}e.byDistrict&&Object.entries(e.byDistrict).forEach(([e,r])=>{t.byDistrict[e]=(t.byDistrict[e]||0)+r})}else u.set(a,{...e,roomType:r,count:i,avgPrice:n,minPrice:o,maxPrice:c,projectNames:e.projectNames?[...e.projectNames]:[],byDistrict:e.byDistrict?{...e.byDistrict}:{}})};r.forEach(m),a.forEach(m);let y={...i};Object.entries(n).forEach(([e,t])=>{y[e]?Object.entries(t).forEach(([t,r])=>{y[e][t]=(y[e][t]||0)+r}):y[e]={...t}});let P=Array.from(new Set([...o,...c])).sort(),f=Array.from(new Set([...s,...l])).sort();return{details:Array.from(u.values()),locationCrossTable:y,allDistricts:P,allRoomTypes:f}}(e.priceBandAnalysis,t.priceBandAnalysis),e.unitPriceAnalysis=function(e,t){if(!t)return e;let r=(e,t)=>{if(!t)return e;if(!e)return t;let r=(e.count||0)+(t.count||0);if(0===r)return e;let a={arithmetic:0,weighted:0},i=(e,t)=>"number"==typeof e.avgPrice?e.weightedAvgPrice||e.avgPrice:e.avgPrice?.[t]||0;["arithmetic","weighted"].forEach(n=>{let o=i(e,n),c=i(t,n);a[n]=(o*(e.count||0)+c*(t.count||0))/r});let n=Math.min(e.minPrice,t.minPrice),o=Math.max(e.maxPrice,t.maxPrice);return{count:r,avgPrice:a,minPrice:n,maxPrice:o,minPriceProject:e.minPrice<t.minPrice?e.minPriceProject:t.minPriceProject,maxPriceProject:e.maxPrice>t.maxPrice?e.maxPriceProject:t.maxPriceProject,medianPrice:0,q1Price:0,q3Price:0}},a=r(e.residentialStats,t.residentialStats),i=r(e.officeStats,t.officeStats),n=r(e.storeStats,t.storeStats),o=[...e.typeComparison||[]];return t.typeComparison&&(o=[...o,...t.typeComparison]),{residentialStats:a,officeStats:i,storeStats:n,typeComparison:o}}(e.unitPriceAnalysis,t.unitPriceAnalysis),e.transactionDetails&&e.transactionDetails.length>0&&function(e,t){if(!e||!t||0===t.length)return;let r=new s.B$(t),a=[],i={price:0,area:0,count:0},n=[],o={price:0,area:0,count:0},c=[],u={price:0,area:0,count:0},y=()=>({minPrice:1/0,maxPrice:-1/0,minRecord:null,maxRecord:null}),P=y(),f=y(),g=y();t.forEach(e=>{let t=e["建物型態"],r=e["主要用途"],s=e["房屋單價(萬)"],l=e["房屋總價(萬)"]||0,m=e["建物移轉總面積"]||0;if("number"!=typeof s||s<=0)return;let y=a,d=i,p=P,h=String(e["樓層"]||e.floor||e.layer||""),S="1"===h||"001"===h||h.includes("一樓"),b=t?.includes("店")||"商業用"===r||e.buildingType?.includes("店")||"商業用"===e.mainPurpose||e["備註"]?.includes("店")||e.note?.includes("店"),D=t?.includes("辦公")||t?.includes("廠辦")||t?.includes("事務所")||r?.includes("辦公")||e.buildingType?.includes("辦公")||e.buildingType?.includes("廠辦")||e.buildingType?.includes("事務所")||e.mainPurpose?.includes("辦公");b&&S?(y=c,d=u,p=g):(D||b&&!S)&&(y=n,d=o,p=f),y.push(s),d.price+=l,d.area+=m,d.count+=1,s>p.maxPrice&&(p.maxPrice=s,p.maxRecord=e),s<p.minPrice&&(p.minPrice=s,p.minRecord=e)});let d=(e,t,a,i)=>{e&&(function(e,t){if(!t||0===t.length){e.medianPrice=0,e.q1Price=0,e.q3Price=0;return}t.sort((e,t)=>e-t),e.medianPrice=m(t,.5),e.q1Price=m(t,.25),e.q3Price=m(t,.75)}(e,t),e.count=a.count,e.avgPrice=a.count>0?t.reduce((e,t)=>e+t,0)/a.count:0,e.weightedAvgPrice=a.area>0?a.price/a.area:0,i.maxRecord&&(e.maxPrice=i.maxPrice,e.maxPriceProject=i.maxRecord["建案名稱"],e.maxPriceUnit=(0,l.n)(i.maxRecord,r),e.maxPriceFloor=i.maxRecord["樓層"]),i.minRecord&&(e.minPrice=i.minPrice,e.minPriceProject=i.minRecord["建案名稱"],e.minPriceUnit=(0,l.n)(i.minRecord,r),e.minPriceFloor=i.minRecord["樓層"]))};e.residentialStats&&d(e.residentialStats,a,i,P),e.officeStats&&d(e.officeStats,n,o,f),e.storeStats&&d(e.storeStats,c,u,g);let p=new Map;t.forEach(e=>{let t=e["建案名稱"];if(!t)return;p.has(t)||p.set(t,{resSum:{price:0,area:0,count:0},shopSum:{price:0,area:0,count:0},officeSum:{price:0,area:0,count:0},county:e["縣市"],district:e["行政區"]});let r=p.get(t),a=e["建物型態"],i=e["主要用途"],n=e["房屋單價(萬)"],o=e["房屋總價(萬)"]||0,c=e["建物移轉總面積"]||0;if("number"!=typeof n||n<=0)return;let s=String(e["樓層"]||e.floor||e.layer||""),l="1"===s||"001"===s||s.includes("一樓"),u=a?.includes("店")||"商業用"===i||e.buildingType?.includes("店")||"商業用"===e.mainPurpose||e["備註"]?.includes("店")||e.note?.includes("店"),m=a?.includes("辦公")||a?.includes("廠辦")||a?.includes("事務所")||i?.includes("辦公")||e.buildingType?.includes("辦公")||e.buildingType?.includes("廠辦")||e.buildingType?.includes("事務所")||e.mainPurpose?.includes("辦公");u&&l?(r.shopSum.price+=o,r.shopSum.area+=c,r.shopSum.count+=1):m||u&&!l?(r.officeSum.price+=o,r.officeSum.area+=c,r.officeSum.count+=1):(r.resSum.price+=o,r.resSum.area+=c,r.resSum.count+=1)});let h=[];p.forEach((e,t)=>{let r=e.resSum.area>0?e.resSum.price/e.resSum.area:0,a=e.shopSum.area>0?e.shopSum.price/e.shopSum.area:0,i=e.officeSum.area>0?e.officeSum.price/e.officeSum.area:0;r>0&&(a>0||i>0)&&h.push({projectName:t,county:e.county,district:e.district,residentialAvg:r,shopAvg:a,officeAvg:i,shopMultiple:r>0?a/r:0,officeMultiple:r>0?i/r:0})}),h.sort((e,t)=>e.projectName.localeCompare(t.projectName))}(e.unitPriceAnalysis,e.transactionDetails),e.parkingAnalysis=function(e,t){if(!t)return e;let r=e.parkingRatio,a=t.parkingRatio,i=null;if(r&&a){let e=r.withParking.count,t=r.withoutParking.count,n=a.withParking.count,o=a.withoutParking.count,c=e+n,s=t+o,l=c+s;i={withParking:{count:c,percentage:l>0?c/l*100:0},withoutParking:{count:s,percentage:l>0?s/l*100:0}}}else i=r||a;let n=new Map,o=e=>{if(n.has(e.type)){let t=n.get(e.type),r=t.count+e.count,a=t.transactionCount+e.transactionCount,i=t.avgPrice,o=e.avgPrice,c=a>0?(i*t.transactionCount+o*e.transactionCount)/a:0;t.count=r,t.transactionCount=a,t.avgPrice=c}else n.set(e.type,{...e})};(e.avgPriceByType||[]).forEach(o),(t.avgPriceByType||[]).forEach(o);let c=Array.from(n.values()),s=new Map,l=e=>{if(s.has(e.floor)){let t=s.get(e.floor),r=t.count+e.count;e.rawRecords&&(t.rawRecords=[...t.rawRecords||[],...e.rawRecords]);let a=r>0?(t.avgPrice*t.count+e.avgPrice*e.count)/r:0;t.count=r,t.avgPrice=a,t.minPrice=Math.min(t.minPrice,e.minPrice),t.maxPrice=Math.max(t.maxPrice,e.maxPrice),e.maxPrice>t.maxPrice&&(t.maxPriceProject=e.maxPriceProject,t.maxPriceUnit=e.maxPriceUnit,t.maxPriceFloor=e.maxPriceFloor),e.minPrice<t.minPrice&&(t.minPriceProject=e.minPriceProject,t.minPriceUnit=e.minPriceUnit,t.minPriceFloor=e.minPriceFloor)}else s.set(e.floor,{...e,rawRecords:e.rawRecords?[...e.rawRecords]:[]})};return(e.rampPlanePriceByFloor||[]).forEach(l),(t.rampPlanePriceByFloor||[]).forEach(l),{parkingRatio:i,avgPriceByType:c,rampPlanePriceByFloor:Array.from(s.values())}}(e.parkingAnalysis,t.parkingAnalysis),e.salesVelocityAnalysis=function(e,t){if(!t)return e;let r=e.overall||{},a=t.overall||{},i=r.transactionCount||0,n=a.transactionCount||0,o=i+n,c={avgDaysToSell:0,medianDaysToSell:0,fastestSale:0,transactionCount:o};o>0&&(c.avgDaysToSell=((r.avgDaysToSell||0)*i+(a.avgDaysToSell||0)*n)/o,c.fastestSale=Math.min(void 0!==r.fastestSale?r.fastestSale:1/0,void 0!==a.fastestSale?a.fastestSale:1/0),c.fastestSale===1/0&&(c.fastestSale=0),c.medianDaysToSell=((r.medianDaysToSell||0)*i+(a.medianDaysToSell||0)*n)/o);let s=new Map,l=e=>{if(!e)return;let t=e.roomType;if(s.has(t)){let r=s.get(t),a=r.count+e.count,i=r.avgDays||0,n=e.avgDays||0;r.avgDays=a>0?(i*r.count+n*e.count)/a:0,r.count=a}else s.set(t,{...e})};(e.byRoomType||[]).forEach(l),(t.byRoomType||[]).forEach(l);let u=Array.from(s.values()),m=Array.from(new Set([...e.allRoomTypes||[],...t.allRoomTypes||[]])),y={};return["monthly","quarterly","yearly","weekly"].forEach(r=>{let a=e[r]||{},i=t[r]||{},n={};new Set([...Object.keys(a),...Object.keys(i)]).forEach(e=>{let t=a[e]||{},r=i[e]||{},o=new Set([...Object.keys(t),...Object.keys(r)]),c={};o.forEach(e=>{let a=t[e],i=r[e];if(a&&i){let t=a.count+i.count,r=a.priceSum+i.priceSum,n=a.areaSum+i.areaSum;c[e]={count:t,priceSum:r,areaSum:n,avgPrice:n>0?r/n:0}}else a?c[e]={...a}:i&&(c[e]={...i})}),n[e]=c}),y[r]=n}),{overall:c,byRoomType:u,allRoomTypes:m,...y}}(e.salesVelocityAnalysis,t.salesVelocityAnalysis),r=e.priceGridAnalysis,e.priceGridAnalysis=(a=t.priceGridAnalysis)?{projectNames:[...r.projectNames||[],...a.projectNames||[]],byProject:{...r.byProject||{},...a.byProject||{}}}:r,e.areaDistributionAnalysis=function(e,t){if(!t)return e;if(!e)return t;let r={...e};return Object.keys(t).forEach(e=>{r[e]?r[e]=[...r[e],...t[e]]:r[e]=[...t[e]]}),r}(e.areaDistributionAnalysis,t.areaDistributionAnalysis),e):JSON.parse(JSON.stringify(t)):e}function m(e,t){let r=(e.length-1)*t,a=Math.floor(r);return void 0!==e[a+1]?parseFloat((e[a]+(r-a)*(e[a+1]-e[a])).toFixed(2)):parseFloat(e[a].toFixed(2))}function y(){let e=(0,n.P)(),[t,r]=(0,a.useState)(!1),[s,l]=(0,a.useState)(null),[m,y]=(0,a.useState)(null),P=(0,a.useCallback)(async()=>{r(!0),l(null),y(null),e.setAnalysisData(null);try{let t=e.counties.map(e=>({name:e,code:o.WG[e]||e})),a=t.map(e=>e.code);if(0===a.length){l("請至少選擇一個縣市"),r(!1);return}let{dateRange:n,startDate:s,endDate:m}=e;if("custom"!==n&&(!s||!m)){let e=(0,c.P)(n);e.startDate&&e.endDate&&(s=e.startDate,m=e.endDate)}let P={districts:e.districts,transactionType:e.transactionType,type:e.transactionType,projectNames:e.projectNames,buildingType:e.buildingType,excludeCommercial:e.excludeCommercial,floorPremium:e.floorPremium,dateRange:n,dateStart:s,dateEnd:m},f=e=>{if(!e)return null;let t=e.match(/^(\d{4})[-\/](\d{2})[-\/](\d{2})$/);if(t){let e=Number(t[1]),r=Number(t[2]),a=Number(t[3]);if(!Number.isFinite(e)||!Number.isFinite(r)||!Number.isFinite(a))return null;let i=new Date(Date.UTC(e,r-1,a));return Number.isNaN(i.getTime())?null:i}let r=new Date(e);return Number.isNaN(r.getTime())?null:r},g=e=>{let t=e.getUTCFullYear(),r=String(e.getUTCMonth()+1).padStart(2,"0"),a=String(e.getUTCDate()).padStart(2,"0");return`${t}-${r}-${a}`},d=(e,t)=>{let r=new Date(e.getTime());return r.setUTCDate(r.getUTCDate()+t),r},p=(e,t,r)=>{let a=[],i=e;for(;i.getTime()<=t.getTime();){let e=d(i,r-1);e.getTime()>t.getTime()&&(e=t),a.push({dateStart:g(i),dateEnd:g(e)}),i=d(e,1)}return a},h=e=>!!(e?.projectRanking&&e?.coreMetrics),S=((e,t)=>{let r=f(e),a=f(t);if(!r||!a||r.getTime()>a.getTime())return null;let i=a.getTime()-r.getTime(),n=Math.floor(i/864e5)+1;return{start:r,end:a,totalDays:n}})(s,m),b=!!(S&&S.totalDays>=360),D=()=>{y(e=>{if(!e)return e;let t=Math.min(e.completed+1,e.total);return{...e,completed:t}})},T=async(e,t,r)=>{if(!S)throw Error("無法解析日期區間，無法進行分段查詢。");let a=p(S.start,S.end,r),n=null,o=0,c=[];for(let r of a){y(e=>e?{...e,currentCounty:t,currentRange:`${r.dateStart} ~ ${r.dateEnd}`}:e);try{let a={...P,countyCode:e,counties:[e],dateStart:r.dateStart,dateEnd:r.dateEnd},s=await i.FH.analyzeProjectRanking(a);if(h(s))n=u(n,s),o++;else if("message"in s&&s.message)c.push(s.message);else if("error"in s&&s.error)throw Error(s.error);else throw Error(`縣市 ${t} 分段查詢回傳格式異常`)}finally{D()}}return 0===o?c.length>0?{message:c[0]}:{error:`縣市 ${t} 在此區間無可用資料`}:{data:n}},A=async(e,t)=>{let r=S?`${g(S.start)} ~ ${g(S.end)}`:void 0,a={...P,countyCode:e,counties:[e]},n=!1;try{if(b&&S){n=!0;let r=S.totalDays>=720?120:180;return console.warn(`[useAnalysisData] ${t} 區間過長，改用 ${r} 天分段查詢。`),await T(e,t,r)}y(e=>e?{...e,currentCounty:t,currentRange:r}:e);let o=await i.FH.analyzeProjectRanking(a);if(h(o))return{data:o};if("message"in o&&o.message)return{message:o.message};if("error"in o&&o.error)return{error:o.error};return{error:`縣市 ${t} 回傳格式異常`}}catch(r){if(S&&S.totalDays>=90){console.warn(`[useAnalysisData] ${t} 單次查詢失敗，改用分段查詢。`,r);try{var o;return n=!0,(o=p(S.start,S.end,90).length-1)&&y(e=>{if(!e)return e;let t=Math.max(e.completed,e.total+o);return{...e,total:t}}),await T(e,t,90)}catch(e){return{error:e?.message||r?.message||"未知錯誤"}}}return{error:r?.message||"未知錯誤"}}finally{n||D()}},w=async(e,t,r)=>{let a=Array(e.length),i=0,n=Array.from({length:Math.min(t,e.length)},async()=>{for(;;){let t=i++;if(t>=e.length)break;a[t]=await r(e[t],t)}});return await Promise.all(n),a};console.log("[useAnalysisData] Analyzing with counties:",a);let x=b&&S?t.reduce(e=>{let t=S.totalDays>=720?120:180;return e+p(S.start,S.end,t).length},0):t.length;y({total:Math.max(x,1),completed:0,currentCounty:t[0]?.name,currentRange:S?`${g(S.start)} ~ ${g(S.end)}`:void 0});let j=await w(t,b?1:2,e=>A(e.code,e.name)),v=null,R=0,N=[],k=[],E=[];for(let e=0;e<j.length;e++){let r=j[e],i=t[e]?.name||a[e]||"未知";r?.data&&r.data.projectRanking&&r.data.coreMetrics?(console.log("Merging result for county:",r.data.projectRanking?.[0]?.county||i),v=u(v,r.data),R++):(r?.message?N.push(`[${i}] ${r.message}`):r?.error?k.push(`[${i}] ${r.error}`):k.push(`[${i}] 回傳格式異常`),E.push(i))}if(console.log("Aggregation complete. Total Transaction Details:",v?.transactionDetails?.length),0===R){if(e.projectNames.length>0)throw Error("這段時間 這個建案查詢不到資料");if(N.length>0)throw Error(N[0]);if(k.length>0)throw Error(k[0]);throw Error("無法取得任何縣市的分析數據")}if(R<a.length){let e=a.length-R,t=E.length>0?`（${E.join("、")}）`:"";l(`注意：有 ${e} 個縣市的資料載入失敗${t}，分析結果可能不完整。`)}e.setAnalysisData(v)}catch(e){console.error("Analysis failed:",e),l(e.message||"無法取得分析數據，請稍後再試。")}finally{r(!1),y(null)}},[e]);return{loading:t,error:s,analysisData:e.analysisData,analysisProgress:m,handleAnalyze:P,setError:l,setLoading:r,setAnalysisData:e.setAnalysisData}}}}]);