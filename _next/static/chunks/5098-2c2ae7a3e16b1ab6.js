"use strict";(self.webpackChunk_N_E=self.webpackChunk_N_E||[]).push([[5098],{1509:(e,t,r)=>{r.d(t,{S:()=>u});var i=r(95155),n=r(12115),a=r(89579),s=r(80642),l=r(39430),o=r(86901),c=r(94514),d=r(21628);function u({transactions:e,currentPremium:t,onApply:r,onManualChange:u}){let[x,p]=(0,n.useState)(null),[m,h]=(0,n.useState)(!1),[f,g]=(0,n.useState)(String(t)),b=(0,n.useRef)(null),[y,j]=(0,n.useState)(null),[N,v]=(0,n.useState)(360),w=Math.max(160,N-28),z=(0,n.useMemo)(()=>(function(e){if(!e||0===e.length)return[];let t=[],r={},i=new a.B$(e);e.forEach(e=>{let t=((e,t)=>{let r=e?.["戶型"];if("string"==typeof r&&r)return r;let i=t.resolve(e);if(i)return i;let n=e?.["戶別"]||e?.unit||e?.unitName;return"string"==typeof n&&n?n:""})(e,i),n=(e=>{if(!e)return 0;let t=String(e).match(/\d+/);return t?parseInt(t[0],10):0})(e["樓層"]||e.floor||""),a=parseFloat(e["房屋單價(萬)"]||e.unitPrice||0);t&&0!==n&&a>0&&(r[t]||(r[t]=[]),r[t].push({floor:n,price:a,original:e}))}),Object.entries(r).forEach(([e,r])=>{r.sort((e,t)=>e.floor-t.floor);for(let i=0;i<r.length;i++)for(let n=i+1;n<r.length;n++){let a=r[i],s=r[n],l=s.floor-a.floor;if(l>0&&l<=10){let r=Math.round(10*((s.price-a.price)/l))/10;r>=-2&&r<=2&&t.push({stack:e,floorLow:a.floor,floorHigh:s.floor,priceLow:a.price,priceHigh:s.price,diff:r,dateLow:a.original["交易年月日"]||a.original["交易日"]||a.original.transactionDate,dateHigh:s.original["交易年月日"]||s.original["交易日"]||s.original.transactionDate})}}});let n=new Map;t.forEach(e=>{let t=`${e.stack}-${e.floorLow}-${e.floorHigh}-${e.priceLow}-${e.priceHigh}`;n.has(t)||n.set(t,e)});let s=Array.from(n.values()),l={};s.forEach(e=>{l[e.diff]||(l[e.diff]={premium:e.diff,count:0,pairs:[]}),l[e.diff].count+=1,l[e.diff].pairs.push(e)});let o=Object.values(l);return o.sort((e,t)=>t.count!==e.count?t.count-e.count:e.premium-t.premium),o})(e),[e]),P=(0,n.useMemo)(()=>[...z.slice(0,5)].sort((e,t)=>e.premium-t.premium),[z]),S=(0,n.useMemo)(()=>[...z].sort((e,t)=>e.premium-t.premium),[z]),M=(0,n.useMemo)(()=>m?S:P,[m,S,P]),A=(0,n.useMemo)(()=>z.find(e=>1e-6>Math.abs(e.premium-t))||null,[z,t]),E=z.length>P.length;(0,n.useEffect)(()=>{p(null)},[A?.premium]),(0,n.useEffect)(()=>{g(String(t))},[t]),(0,n.useEffect)(()=>{if(!b.current)return;let e=()=>{if(!b.current)return;let e=Math.round(b.current.getBoundingClientRect().width);e>0&&j(e)};e();let t=new ResizeObserver(()=>e());return t.observe(b.current),window.addEventListener("resize",e),()=>{t.disconnect(),window.removeEventListener("resize",e)}},[]),(0,n.useEffect)(()=>{let e=()=>{v(Math.max(260,Math.min(520,Math.round(.55*window.innerHeight))))};return e(),window.addEventListener("resize",e),()=>window.removeEventListener("resize",e)},[]);let k=(0,n.useMemo)(()=>{let t=new Set,r=new Set,i=new a.B$(e);e.forEach(e=>{if(!e)return;let n=(e=>{let t=e?.["戶型"];if("string"==typeof t&&t)return t;let r=i.resolve(e);if(r)return r;let n=e?.["戶別"]||e?.unit||e?.unitName;return"string"==typeof n&&n?n:""})(e),a=(e=>{if(!e)return 0;let t=String(e).match(/\d+/);return t?parseInt(t[0],10):0})(e["樓層"]||e.floor);n&&t.add(n),0!==a&&r.add(a)});let n=Array.from(r).sort((e,t)=>t-e),s=e=>{let t=String(e||"").trim().toUpperCase(),r=t.match(/^([A-Z]+)(\d+)?$/);return r?{alpha:r[1]||"",num:r[2]?parseInt(r[2],10):Number.MAX_SAFE_INTEGER,raw:t}:{alpha:t,num:Number.MAX_SAFE_INTEGER,raw:t}},l=Array.from(t).sort((e,t)=>{let r=s(e),i=s(t),n=r.alpha.localeCompare(i.alpha,"en");return 0!==n?n:r.num!==i.num?r.num-i.num:r.raw.localeCompare(i.raw,"en")}),o=new Set;A&&A.pairs.forEach(e=>{o.add(`${e.stack}-${e.floorLow}`),o.add(`${e.stack}-${e.floorHigh}`)});let c=n.length||1,d=l.length||1,u=(y||0)-32-16,x=N-24-4,p=Math.min(40,Math.max(8,Math.min(u>0?Math.floor(u/d):24,x>0?Math.floor(x/c):24)));return{sortedFloors:n,sortedStacks:l,highlightedCells:o,cellSize:p,gridHeight:c*p+24}},[e,A,y,N]);if(0===z.length)return null;let F=null!==x&&A?A.pairs[x]:null;return(0,i.jsxs)("div",{className:"bg-zinc-900/50 border border-white/10 rounded-xl p-4 mb-6",children:[(0,i.jsxs)("div",{className:"flex items-center gap-2 mb-3",children:[(0,i.jsx)(o.A,{className:"w-4 h-4 text-yellow-400"}),(0,i.jsx)("h3",{className:"text-sm font-bold text-zinc-100",children:"AI 樓層價差分析建議"})]}),(0,i.jsxs)("div",{className:"flex flex-wrap gap-2 mb-4 items-center",children:[M.map(e=>{let n=1e-6>Math.abs(t-e.premium);return(0,i.jsxs)("button",{onClick:()=>{r(e.premium)},className:`
                                relative px-3 py-1.5 rounded-lg border text-xs font-mono transition-all
                                flex items-center gap-2
                                ${n?"bg-cyan-500/20 border-cyan-500 text-cyan-300":"bg-zinc-800 border-white/5 text-zinc-400 hover:border-white/20 hover:text-zinc-200"}
                            `,children:[(0,i.jsxs)("span",{className:"text-base font-bold",children:[e.premium>0?"+":"",e.premium]}),(0,i.jsx)("span",{className:"opacity-50",children:"萬/坪"}),(0,i.jsxs)("span",{className:"ml-1 bg-black/20 px-1.5 rounded text-[10px]",children:[e.count," 組"]}),n&&(0,i.jsx)(c.A,{className:"w-3 h-3 text-green-400"})]},e.premium)}),u&&(0,i.jsxs)("div",{className:"flex items-center gap-2 px-3 py-1.5 rounded-lg border border-white/10 bg-zinc-900/60 text-xs text-zinc-300",children:[(0,i.jsx)("span",{className:"text-[10px] text-zinc-500",children:"手動"}),(0,i.jsx)("input",{type:"text",inputMode:"decimal",value:f,onChange:e=>g(e.target.value),onBlur:()=>{let e=Number(f);Number.isNaN(e)||u(Math.max(0,e))},onKeyDown:e=>{if("Enter"===e.key){let t=Number(f);Number.isNaN(t)||(u(Math.max(0,t)),e.target.blur())}},className:"w-16 bg-transparent text-right pr-1 outline-none text-zinc-200"}),(0,i.jsx)("span",{className:"text-[10px] text-violet-300",children:"萬/坪"})]}),E&&(0,i.jsx)("button",{onClick:()=>h(e=>!e),className:"px-3 py-1.5 rounded-lg border border-white/10 bg-zinc-800 text-[10px] text-zinc-400 hover:text-zinc-200 hover:border-white/30 transition",children:m?"收合標籤":"顯示全部"})]}),(0,i.jsx)(s.N,{children:A&&(0,i.jsx)(l.P.div,{initial:{opacity:0,height:0},animate:{opacity:1,height:"auto"},exit:{opacity:0,height:0},className:"overflow-hidden",children:(0,i.jsxs)("div",{className:"border-t border-white/10 pt-4 mt-2",children:[(0,i.jsxs)("div",{className:"flex justify-between items-end mb-3",children:[(0,i.jsxs)("div",{className:"text-xs text-zinc-400",children:[(0,i.jsx)("span",{className:"text-cyan-400 font-bold",children:A.count})," 組對比符合此規律。 點擊右側明細可連動網格顯示。"]}),(0,i.jsx)("div",{className:"text-[10px] text-zinc-500",children:"點擊上方標籤即可套用"})]}),(0,i.jsxs)("div",{className:"flex flex-col xl:flex-row gap-4 items-stretch",children:[(0,i.jsx)("div",{ref:b,className:"flex-1 bg-black/40 rounded border border-white/5 p-2 overflow-hidden relative",style:{height:N},children:(0,i.jsxs)("div",{className:"w-full",children:[(0,i.jsxs)("div",{className:"flex",children:[(0,i.jsx)("div",{className:"shrink-0",style:{width:32}}),k.sortedStacks.map(e=>(0,i.jsx)("div",{className:"text-center text-[10px] text-zinc-500 pb-1",style:{width:k.cellSize},children:e},e))]}),k.sortedFloors.map(e=>(0,i.jsxs)("div",{className:"flex items-center relative z-10",style:{height:k.cellSize},children:[(0,i.jsxs)("div",{className:"shrink-0 text-right text-[10px] text-zinc-600 pr-2",style:{width:32},children:[e,"F"]}),k.sortedStacks.map(t=>{let r=`${t}-${e}`,n=k.highlightedCells.has(r),a=F&&F.stack===t&&(e===F.floorLow||e===F.floorHigh),s=A.pairs.some(r=>r.stack===t&&e>r.floorLow&&e<r.floorHigh),l=F&&F.stack===t&&e>F.floorLow&&e<F.floorHigh;return(0,i.jsxs)("div",{className:"h-full flex items-center justify-center p-0.5 relative",style:{width:k.cellSize},children:[s&&(0,i.jsx)("div",{className:`
                                                                    absolute w-0.5 h-[140%] top-[-20%] transition-colors duration-200
                                                                    ${l?"bg-yellow-400 z-20":"bg-cyan-500/20"}
                                                                `}),(0,i.jsx)("div",{className:`
                                                                    w-full h-full rounded-sm transition-all duration-200 relative z-10
                                                                    ${a?"bg-yellow-400 shadow-[0_0_12px_rgba(250,204,21,0.8)] scale-100 ring-2 ring-white/50 z-30":n?"bg-cyan-500 shadow-[0_0_8px_rgba(6,182,212,0.6)] scale-90":"bg-zinc-800/30"}
                                                                `})]},r)})]},e))]})}),(0,i.jsxs)("div",{className:"w-full xl:w-[380px] flex flex-col gap-2",style:{height:N},children:[(0,i.jsxs)("div",{className:"text-[10px] uppercase tracking-wider text-zinc-500 font-bold mb-1",children:["對比明細 (共 ",A.pairs.length," 組)"]}),(0,i.jsx)("div",{className:"flex flex-col gap-2 overflow-y-auto pr-2 custom-scrollbar",style:{maxHeight:w},children:A.pairs.map((e,t)=>(0,i.jsxs)("div",{onMouseEnter:()=>p(t),onMouseLeave:()=>p(null),className:`
                                                    border rounded-lg p-2 flex items-center justify-between group transition-all cursor-crosshair
                                                    ${x===t?"bg-yellow-400/10 border-yellow-400/50 translate-x-1":"bg-white/5 border-white/5 hover:border-white/20"}
                                                `,children:[(0,i.jsxs)("div",{className:"flex items-center gap-3",children:[(0,i.jsx)("div",{className:`
                                                        w-8 h-8 rounded flex items-center justify-center font-bold text-xs border transition-colors
                                                        ${x===t?"bg-yellow-400/20 text-yellow-400 border-yellow-400/30":"bg-cyan-500/10 text-cyan-400 border-cyan-500/20"}
                                                    `,children:e.stack}),(0,i.jsxs)("div",{className:"flex flex-col",children:[(0,i.jsxs)("div",{className:"flex items-center gap-1.5 leading-none",children:[(0,i.jsxs)("span",{className:"text-xs text-zinc-300",children:[e.floorLow,"F"]}),(0,i.jsx)(d.A,{className:`w-3 h-3 ${x===t?"text-yellow-400":"text-zinc-600"}`}),(0,i.jsxs)("span",{className:"text-xs text-zinc-100 font-bold",children:[e.floorHigh,"F"]})]}),(0,i.jsxs)("div",{className:"text-[10px] text-zinc-500 mt-1 flex gap-1 items-center",children:[(0,i.jsx)("span",{className:"opacity-70",children:e.dateLow||"N/A"}),(0,i.jsx)("span",{className:"opacity-30",children:"|"}),(0,i.jsx)("span",{className:"opacity-70",children:e.dateHigh||"N/A"})]})]})]}),(0,i.jsxs)("div",{className:"text-right",children:[(0,i.jsxs)("div",{className:"text-xs font-mono text-zinc-200",children:[e.priceLow,(0,i.jsx)("span",{className:"text-[10px] opacity-40 mx-1",children:"→"}),e.priceHigh]}),(0,i.jsxs)("div",{className:`text-[10px] font-bold ${x===t?"text-yellow-400":"text-cyan-400/80"}`,children:["+",e.diff," 萬/層"]})]})]},t))})]})]})]})})})]})}},29991:(e,t,r)=>{r.d(t,{l:()=>l});var i=r(95155),n=r(12115),a=r(40980),s=r(66088);let l=n.forwardRef(({className:e,children:t,...r},n)=>(0,i.jsxs)("div",{className:"relative",children:[(0,i.jsx)("select",{className:(0,a.cn)("flex h-10 w-full appearance-none rounded-md border border-input bg-zinc-950/50 px-3 py-2 text-sm text-zinc-100 ring-offset-background focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2 disabled:cursor-not-allowed disabled:opacity-50 pr-8",e),ref:n,...r,children:t}),(0,i.jsx)(s.A,{className:"absolute right-3 top-2.5 h-4 w-4 opacity-50 pointer-events-none"})]}));l.displayName="Select"},48165:(e,t,r)=>{r.d(t,{ZW:()=>a,e7:()=>l});var i=r(89579),n=r(56722);let a=e=>{let t=String(e?.["樓層"]||e?.floor||e?.layer||""),r="1"===t||"001"===t||t.includes("一樓"),i=e?.["建物型態"]||e?.buildingType||"",n=e?.["主要用途"]||e?.mainPurpose||"",a=e?.["備註"]||e?.note||"",s=i.includes("店")||e.buildingType?.includes("店")||"商業用"===n||"商業用"===e.mainPurpose||a.includes("店")||e.note?.includes("店"),l=i.includes("辦公")||e.buildingType?.includes("辦公")||i.includes("廠辦")||e.buildingType?.includes("廠辦")||i.includes("事務所")||e.buildingType?.includes("事務所")||n.includes("辦公")||e.mainPurpose?.includes("辦公")||n.includes("事務所")||e.mainPurpose?.includes("事務所")||a.includes("辦公")||a.includes("事務所")||e.note?.includes("辦公")||e.note?.includes("事務所");return{buildingType:i,mainPurpose:n,note:a,isStorefront:s&&r,isOffice:l||s&&!r}},s=e=>{let{note:t,isStorefront:r,isOffice:i}=a(e),n=t.includes("親友")||t.includes("員工")||t.includes("關係人")||t.includes("關係戶")||t.includes("員工關係");return{note:t,isStorefront:r,isOffice:i,isEmployeeRelated:n}};function l(e,t=.3,r=14,o={}){let c=e.reduce((e,t)=>{let{isStorefront:r,isOffice:i}=a(t);return i&&(e.hasOffice=!0),i||r||(e.hasResidential=!0),e},{hasOffice:!1,hasResidential:!1}),d=!(c.hasOffice&&c.hasResidential)&&c.hasOffice,u="boolean"==typeof o.includeOfficePremium?o.includeOfficePremium:d,x="boolean"==typeof o.includeStorefrontPremium&&o.includeStorefrontPremium,p="boolean"==typeof o.includeEmployeePremium&&o.includeEmployeePremium,m=e=>{let{isStorefront:t,isOffice:r,isEmployeeRelated:i}=s(e);return(!!x||!t)&&(!!u||!r)&&(!!p||!i)},h={},f=new Set,g=new Set,b=new i.B$(e);if(e.forEach(e=>{let t=e["樓層"]||e.floor||e.layer;if(null==t)return;"number"==typeof t&&(t=String(t)),"number"==typeof t&&(t=String(t));let r=(0,n.n)(e,b);f.add(t),g.add(r),h[t]||(h[t]={}),h[t][r]||(h[t][r]=[]);let i=parseFloat(e["房屋單價(萬)"]||e.unitPrice||0),a=parseFloat(e["交易總價(萬)"]||e.totalPrice||0),l=parseFloat(e["房屋總價(萬)"]||e.housePrice||0),o=parseFloat(e["車位總價(萬)"]||e.parkingPrice||0),c=parseFloat(e["房屋面積(坪)"]||e.houseArea||0),d=e["房數"]||e.rooms,u=e["車位類別"]||e.parkingType||"";"string"==typeof u&&u.includes("車位");let{note:x,isStorefront:p,isOffice:m,isEmployeeRelated:y}=s(e),j=e["交易日"]||e["交易年月日"]||e.transactionDate||"",N=j;if(j&&/^\d{6,7}$/.test(String(j))){let e=String(j),t=6===e.length?2:3;N=`${e.substring(0,t)}/${e.substring(t,t+2)}/${e.substring(t+2)}`}h[t][r].push({...e,unitPrice:i,floor:t,unit:r,transactionDate:N,remark:x,isStorefront:p,isOffice:m,isEmployeeRelated:y,hasParking:o>0,tooltipInfo:{totalPrice:a,housePrice:l,parkingPrice:o,houseArea:c,rooms:d}})}),0===f.size)return{horizontalGrid:{},sortedFloors:[],sortedUnits:[],unitColorMap:{},summary:{totalBaselineHousePrice:0,totalPricePremiumValue:0,totalSoldArea:0,transactionCount:0,calculationFlags:{includesOfficePremium:u,includesStorefrontPremium:x,includesEmployeePremium:p}},horizontalComparison:[]};let y=Array.from(f).sort((e,t)=>{let r=e=>e?e.startsWith("B")?-parseInt(e.substring(1)):parseInt(e)||0:0;return r(t)-r(e)}),j=e=>{let t=String(e||"").trim().toUpperCase(),r=t.match(/^([A-Z]+)(\d+)?$/);return r?{alpha:r[1]||"",num:r[2]?parseInt(r[2],10):Number.MAX_SAFE_INTEGER,raw:t}:{alpha:t,num:Number.MAX_SAFE_INTEGER,raw:t}},N=Array.from(g).sort((e,t)=>{let r=j(e),i=j(t),n=r.alpha.localeCompare(i.alpha,"en");return 0!==n?n:r.num!==i.num?r.num-i.num:r.raw.localeCompare(i.raw,"en")}),v={},w=e=>{if(!e)return null;let t=e.replace(/\//g,"");if(t.length<6)return null;let r=6===t.length?2:3;return new Date(1911+parseInt(t.substring(0,r)),parseInt(t.substring(r,r+2))-1,parseInt(t.substring(r+2)))},z={};e.forEach(e=>{let t=(0,n.n)(e,b),{note:r}=s(e),i=parseFloat(e["房屋單價(萬)"]||e.unitPrice||0);!(!m(e)||r.includes("特殊")||r.includes("毛胚"))&&i>0&&(z[t]||(z[t]=[]),z[t].push(e))}),Object.keys(z).forEach(e=>{let i=z[e];if(i.sort((e,t)=>(w(e["交易年月日"]||e.transactionDate)?.getTime()||0x9184e729fff)-(w(t["交易年月日"]||t.transactionDate)?.getTime()||0x9184e729fff)),0===i.length)return;let n=w(i[0]["交易年月日"]||i[0].transactionDate);if(!n){v[e]=i.reduce((e,t)=>parseFloat(t["房屋單價(萬)"])<parseFloat(e["房屋單價(萬)"])?t:e,i[0]);return}let a=new Date(n);a.setDate(a.getDate()+r);let s=i.filter(e=>{let t=w(e["交易年月日"]||e.transactionDate);return t&&t<=a}),l=s[0]||i[0],o=1/0;s.forEach(e=>{let r,i=parseFloat(e["房屋單價(萬)"]||0)-((r=String(e["樓層"]))?r.startsWith("B")?-parseInt(r.substring(1)):parseInt(r):0)*t;i<o&&(o=i,l=e)}),v[e]=l});let P=0,S=0,M=0,A=0;Object.keys(h).forEach(e=>{Object.keys(h[e]).forEach(r=>{h[e][r].forEach((i,n)=>{let a=null,s=v[r];if(s&&m(i)){let l=e=>e?e.startsWith("B")?-parseInt(e.substring(1)):parseInt(e):0,o=String(s["樓層"]),c=String(i.floor),d=l(o),u=l(c),x=parseFloat(s["房屋單價(萬)"]||s.unitPrice||0)+(u-d)*t;if(x>0&&(a=(i["房屋單價(萬)"]-x)/x*100,(i===s||.1>Math.abs(i["房屋單價(萬)"]-x))&&(a=0)),i.tooltipInfo.housePrice&&i.tooltipInfo.houseArea){let e=x*i.tooltipInfo.houseArea;P+=e,S+=i.tooltipInfo.housePrice-e,M+=i.tooltipInfo.houseArea,A++}h[e][r][n].theoreticalPrice=x}else a=null,h[e][r][n].theoreticalPrice=null;h[e][r][n].premium=a})})});let E={},k=["#f87171","#fb923c","#fbbf24","#a3e635","#34d399","#22d3ee","#818cf8","#c084fc","#f472b6"];N.forEach((e,t)=>{E[e]=k[t%k.length]});let F={};N.forEach(e=>{F[e]={totalOriginalPriceValue:0,totalActualPriceValue:0,totalSoldArea:0,count:0,anchorPrice:null,anchorFloor:null};let t=v[e];t&&(F[e].anchorPrice=parseFloat(t["房屋單價(萬)"]||0),F[e].anchorFloor=String(t["樓層"]))}),Object.keys(h).forEach(e=>{Object.keys(h[e]).forEach(r=>{h[e][r].forEach(e=>{let i=v[r];if(m(e)&&e.tooltipInfo.houseArea&&i){let n=e=>e?e.startsWith("B")?-parseInt(e.substring(1)):parseInt(e):0,a=n(String(i["樓層"])),s=n(e.floor),l=parseFloat(e["房屋單價(萬)"]||e.unitPrice||0),o=l-(s-a)*t,c=e.tooltipInfo.houseArea;Number.isFinite(o)&&Number.isFinite(l)&&c>0&&F[r]&&(F[r].totalOriginalPriceValue+=o*c,F[r].totalActualPriceValue+=l*c,F[r].totalSoldArea+=c,F[r].count++)}})})});let $=[],C=[],T=null,I=null,O=1/0,D=1/0;Object.keys(F).forEach(e=>{let t=F[e];if(t.totalSoldArea>0){let r=t.totalOriginalPriceValue/t.totalSoldArea,i=t.totalActualPriceValue/t.totalSoldArea;$.push(r),C.push(i),r<O&&(O=r,T=e),i<D&&(D=i,I=e)}});let L=$.length?Math.min(...$):0,H=C.length?Math.min(...C):0,R=Object.keys(F).map(e=>{let t=F[e];if(0===t.count||0===t.totalSoldArea)return null;let r=t.totalOriginalPriceValue/t.totalSoldArea,i=t.totalActualPriceValue/t.totalSoldArea,n=i-r,a=n*t.totalSoldArea;return{unitType:e,anchorInfo:t.anchorPrice?`${t.anchorFloor}F / ${t.anchorPrice}萬`:"N/A",originalHorizontalDiff:r-L,actualHorizontalDiff:i-H,unitsSold:t.count,totalSoldArea:t.totalSoldArea,originalAvgPrice:r,actualAvgPrice:i,avgPremiumPerPing:n,timePremiumContribution:a}}).filter(Boolean),B=R.reduce((e,t)=>e+(t.timePremiumContribution||0),0);return R.forEach(e=>{e.contributionPercentage=B>0?e.timePremiumContribution/B*100:0}),{horizontalGrid:h,sortedFloors:y,sortedUnits:N,unitColorMap:E,summary:{totalBaselineHousePrice:P,totalPricePremiumValue:S,totalSoldArea:M,transactionCount:A,calculationFlags:{includesOfficePremium:u,includesStorefrontPremium:x,includesEmployeePremium:p}},horizontalComparison:R,comparisonMeta:{originalMinUnit:T,originalMinAvg:Number.isFinite(O)?O:null,actualMinUnit:I,actualMinAvg:Number.isFinite(D)?D:null}}}},56722:(e,t,r)=>{r.d(t,{n:()=>i});let i=(e,t)=>{let r=e?.["戶型"];if("string"==typeof r&&r)return r;let i=t.resolve(e);if(i)return i;let n=e?.["戶別"]||e?.unit||e?.unitName;return"string"==typeof n&&n?n:"?"}},60529:(e,t,r)=>{r.d(t,{p:()=>s});var i=r(95155),n=r(12115),a=r(40980);let s=n.forwardRef(({className:e,type:t,...r},n)=>(0,i.jsx)("input",{type:t,className:(0,a.cn)("flex h-10 w-full rounded-md border border-input bg-zinc-950/50 px-3 py-2 text-sm text-zinc-100 ring-offset-background file:border-0 file:bg-transparent file:text-sm file:font-medium placeholder:text-zinc-500 focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2 disabled:cursor-not-allowed disabled:opacity-50",e),ref:n,...r}));s.displayName="Input"},93398:(e,t,r)=>{r.d(t,{t:()=>h});var i=r(95155),n=r(12115),a=r(47650),s=r(40980),l=r(43987),o=r(32745),c=r(75364),d=r(8875);let u=(e,t=0)=>e?.toLocaleString(void 0,{maximumFractionDigits:t}),x=[{key:"employee",label:"員工關係戶",shortLabel:"員",badgeClass:"border-purple-500/70 text-purple-300",predicate:e=>!!e.isEmployeeRelated},{key:"office",label:"事務所/商辦",shortLabel:"辦",badgeClass:"border-blue-500/70 text-blue-300",predicate:e=>!!e.isOffice},{key:"storefront",label:"店鋪",shortLabel:"店",badgeClass:"border-amber-500/70 text-amber-300",predicate:e=>!!e.isStorefront}],p=e=>null===e?"#1f2937":e<0?"rgba(16, 185, 129, 0.4)":0===e?"#06b6d4":e>5?"rgba(244, 63, 94, 0.5)":e>2?"rgba(249, 115, 22, 0.5)":"rgba(234, 179, 8, 0.4)",m=({children:e,triggerRect:t,isTopRow:r})=>{if(!t)return null;let n={position:"fixed",left:t.left+t.width/2,transform:"translateX(-50%)",zIndex:9999};return r?n.top=t.bottom+8:n.bottom=window.innerHeight-t.top+8,(0,a.createPortal)((0,i.jsx)("div",{style:n,className:"pointer-events-none",children:e}),document.body)};function h({data:e,floorPremium:t=.3,showGrid:r=!0,showSummary:a=!0,showComparison:h=!0,configProject:f,configScope:g,rawTransactions:b,disablePremiumColor:y=!1,disableHover:j=!1,hidePremiumInTooltip:N=!1,showHeaderDeltaAlways:v=!1}){let w,z,{horizontalGrid:P,sortedFloors:S,sortedUnits:M,unitColorMap:A,summary:E,horizontalComparison:k}=e,[F,$]=(0,n.useState)(null),[C,T]=(0,n.useState)(null),[I,O]=(0,n.useState)(null),[D,L]=(0,n.useState)(!1),[H,R]=(0,n.useState)("premium"),[B,V]=(0,n.useState)("percent"),[_,U]=(0,n.useState)(null),W=g||c.Ze;(0,n.useEffect)(()=>{if(!f)return;let e=async()=>{let e=(0,c.oP)(f,W);e&&O(e);try{let e=await (0,c.ew)(f);e&&O(e)}catch(e){console.warn("Failed to fetch official config:",e)}};e();let t=t=>{!t.detail?.project||t.detail.project!==f||t.detail?.scope&&t.detail.scope!==W||e()};return window.addEventListener(c.Vz,t),()=>window.removeEventListener(c.Vz,t)},[f,W]),(0,n.useEffect)(()=>{U(null)},[C]);let G=(0,n.useCallback)(e=>{O(e)},[]),X=(0,n.useMemo)(()=>{if(!h||!P||!M||0===M.length)return{topPair:null,maxPairOverall:null,unitOverallStats:new Map,unitFloorStats:new Map,unitsInMaxPair:new Set};let e=new Map(M.map((e,t)=>[e,t])),t=new Map;Object.keys(P||{}).forEach(e=>{let r=new Map,i=P?.[e]||{};Object.keys(i).forEach(e=>{(i[e]||[]).forEach(t=>{if(!t||null===t.premium)return;let i=parseFloat(t["房屋單價(萬)"]||t.unitPrice||0);Number.isFinite(i)&&!(i<=0)&&(r.has(e)||r.set(e,[]),r.get(e).push(i))})}),r.size>0&&t.set(e,r)});let r=new Map,i=new Set,n=null,a=(e,t)=>{let r=e=>e?e.startsWith("B")?-parseInt(e.substring(1)):parseInt(e)||0:0;return r(t)-r(e)},s=(e,t)=>{if(!e.length)return 0;let r=[...e].sort((e,t)=>e-t),i=(r.length-1)*t,n=Math.floor(i);return void 0!==r[n+1]?r[n]+(i-n)*(r[n+1]-r[n]):r[n]},l=(e,t)=>e.reduce((e,r)=>e?Math.abs(r.diff-t)<Math.abs(e.diff-t)?r:e:r,e[0]),o=e=>{if(!e.length)return null;let t=e.map(e=>e.diff),r=s(t,.25),i=s(t,.5),n=s(t,.75),a=i>=0?e.reduce((e,t)=>t.diff>e.diff?t:e,e[0]):e.reduce((e,t)=>t.diff<e.diff?t:e,e[0]);return{q1:r,median:i,q3:n,max:a.diff,samples:{q1:l(e,r),median:l(e,i),q3:l(e,n),max:a}}},c=new Map,d=new Map,u=new Map;Array.from(t.keys()).sort(a).forEach(a=>{let s=t.get(a);if(!s)return;let l=Array.from(s.keys()).sort((t,r)=>(e.get(t)??0)-(e.get(r)??0)),c=null;for(let e=0;e<l.length;e++)for(let t=e+1;t<l.length;t++){let i=l[e],n=l[t],a=s.get(i)||[],o=s.get(n)||[];if(!a.length||!o.length)continue;let d=[],u=a.slice(0,20),x=o.slice(0,20);u.forEach(e=>{x.forEach(t=>{d.push(e-t)})});let p=`${i}__${n}`;r.has(p)||r.set(p,{unitA:i,unitB:n,diffs:[],count:0});let m=r.get(p);m.diffs.push(...d),m.count+=1;let h=d.reduce((e,t)=>Math.abs(t)>Math.abs(e)?t:e,d[0]);(!c||Math.abs(h)>Math.abs(c.diff))&&(c={unitHigh:h>=0?i:n,unitLow:h>=0?n:i,diff:h})}c&&(i.add(c.unitHigh),i.add(c.unitLow),(!n||Math.abs(c.diff)>Math.abs(n.diff))&&(n={floor:a,unitHigh:c.unitHigh,unitLow:c.unitLow,diff:c.diff})),l.forEach(e=>{let t=s.get(e)||[];if(!t.length)return;let r=[],i=t.slice(0,10);if(l.forEach(t=>{if(t===e)return;let n=s.get(t)||[];if(!n.length)return;let l=n.slice(0,10);i.forEach(e=>{l.forEach(i=>{r.push({diff:e-i,otherUnit:t,floor:a})})})}),!r.length)return;let n=o(r);n&&(d.has(e)||d.set(e,[]),d.get(e).push({floor:a,...n}),u.has(e)||u.set(e,[]),u.get(e).push(...r))})}),d.forEach(e=>e.sort((e,t)=>a(e.floor,t.floor))),u.forEach((e,t)=>{let r=o(e);r&&c.set(t,r)});let x=null;return r.forEach(e=>{let t=e.diffs.reduce((e,t)=>e+t,0)/e.diffs.length;if(!x||e.count>x.count){x={unitA:e.unitA,unitB:e.unitB,count:e.count,avgDiff:t};return}e.count===x.count&&Math.abs(t)>Math.abs(x.avgDiff)&&(x={unitA:e.unitA,unitB:e.unitB,count:e.count,avgDiff:t})}),{topPair:x,maxPairOverall:n,unitOverallStats:c,unitFloorStats:d,unitsInMaxPair:i}},[P,M,h]);(0,n.useMemo)(()=>{if(!I?.configurations||!Array.isArray(I.configurations))return null;let e=new Map;return I.configurations.forEach(t=>{if(!t||!Array.isArray(t.positions)||!t.floorRange)return;let r=(0,o.Qy)(t.positions,t.envTiles||[],t.compassDirection||0,1);if(!r||!Array.isArray(r))return;let i=new Map(r.filter(e=>!!e).map(e=>[e.unitType,e])),n=Math.min(Number(t.floorRange.start)||0,Number(t.floorRange.end)||0),a=Math.max(Number(t.floorRange.start)||0,Number(t.floorRange.end)||0);for(let t=n;t<=a;t++)e.set(t,i)}),e},[I]);let Z={school:"學校",plaza:"廣場",park:"公園",river:"河景",tower:"高壓塔",grave:"墓地",bridge:"高架橋",mountain:"山景",adjacent:"臨房"},q={N:"北",S:"南",E:"東",W:"西",NE:"東北",NW:"西北",SE:"東南",SW:"西南"},Q=e=>{let t=[];if(e.roadFacing){let r=e.roadFacingDirections&&e.roadFacingDirections.length>0?e.roadFacingDirections:e.roadFacingDirection?[e.roadFacingDirection]:[];r.length?r.forEach(e=>{let r=q[e]||e;t.push({text:`${r}臨路`,tone:"road"})}):t.push({text:"臨路",tone:"road"})}if(e.facingOpenSpace&&e.openSpaceType){let r=new Set(["tower","grave","bridge"]);(e.openSpaceFacingDirections&&e.openSpaceFacingDirections.length>0?e.openSpaceFacingDirections.map(e=>({dir:e.direction,type:e.type})):[{dir:e.openSpaceFacingDirection||"",type:e.openSpaceType}]).forEach(e=>{if(!e.type)return;let i=Z[e.type]||e.type,n=e.dir?q[e.dir]||e.dir:"",a=n?`${n}`:"";if("adjacent"===e.type)return void t.push({text:`${a}${i}`,tone:"adjacent"});let s=r.has(e.type);t.push({text:`${a}面${i}`,tone:s?"bad":"good"})})}return e.adjacentToUnits&&!t.some(e=>e.text.includes("臨房"))&&t.push({text:"臨房",tone:"adjacent"}),t},K=(0,n.useMemo)(()=>{if(!I?.configurations||!Array.isArray(I.configurations))return null;let e=new Map;return I.configurations.forEach(t=>{if(!t||!Array.isArray(t.positions))return;let r=(0,o.Qy)(t.positions,t.envTiles||[],t.compassDirection||0,1);r?.forEach(t=>{if(!t)return;let r=Q(t);e.has(t.unitType)||e.set(t.unitType,{labelMap:new Map,details:[]});let i=e.get(t.unitType);r.forEach(e=>{i.labelMap.set(e.text,e.tone)})})}),e},[I,Q]),[J,Y]=(0,n.useState)(null),[ee,et]=(0,n.useState)(null),er=(()=>{let e=E?.calculationFlags;if(!e)return"排除店舖/辦公室";let t=[];return e.includesStorefrontPremium||t.push("店舖"),e.includesOfficePremium||t.push("辦公室"),e.includesEmployeePremium||t.push("員工關係戶"),t.length?`排除${t.join("/")}`:"全部納入"})(),ei=(0,n.useMemo)(()=>{let e={};return P&&M&&M.forEach(t=>{let r=1/0,i=0;if(S?.forEach(e=>{(P?.[e]?.[t]||[]).forEach(e=>{if(!e||e?.isStorefront||e?.isOffice)return;let t=Number(e?.tooltipInfo?.houseArea||e?.houseArea||0);Number.isFinite(t)&&!(t<=0)&&(t<r&&(r=t),t>i&&(i=t))})}),!Number.isFinite(r)||i<=0){e[t]={hasVariance:!1,label:""};return}let n=i-r>3,a=`${r.toFixed(2).replace(/\.00$/,"")}–${i.toFixed(2).replace(/\.00$/,"")} 坪`;e[t]={hasVariance:n,label:n?a:""}}),e},[P,S,M]),en=()=>{j||$(null)};return P&&S&&M?(0,i.jsxs)("div",{className:"space-y-8 overflow-x-auto relative",children:[!j&&F&&(0,i.jsx)(m,{triggerRect:F.rect,isTopRow:F.isTopRow,children:(w=F.data,z=x.filter(e=>e.predicate(w)).map(e=>e.label),(0,i.jsx)("div",{className:"w-48 bg-zinc-900 border border-zinc-700 rounded-lg p-3 shadow-xl animate-in fade-in zoom-in-95 duration-200",children:(0,i.jsxs)("div",{className:"space-y-1",children:[z.length>0&&(0,i.jsxs)("div",{className:"text-amber-300 text-xs",children:["特殊交易: ",z.join("、")]}),F.data?.hasParking&&(0,i.jsxs)("div",{className:"flex items-center gap-1 text-xs text-blue-300",children:[(0,i.jsx)("span",{className:"flex items-center justify-center w-3 h-3 bg-blue-500 text-white text-[8px] font-bold rounded-sm",children:"P"}),(0,i.jsx)("span",{children:"含車位"})]}),F.data?.premium===0&&(0,i.jsx)("div",{className:"text-cyan-400 font-bold mb-1",children:"★ 基準戶"}),!N&&F.data?.premium!==void 0&&F.data?.premium!==null&&(0,i.jsxs)("div",{className:"text-zinc-300",children:["調價: ",(0,i.jsxs)("span",{className:(0,s.cn)(F.data.premium>0?"text-red-400":F.data.premium<0?"text-violet-400":"text-zinc-400"),children:[F.data.premium>0?"+":"",F.data.premium.toFixed(2),"%"]})]}),(0,i.jsx)("div",{className:"h-px bg-zinc-700 my-2"}),(0,i.jsxs)("div",{className:"grid grid-cols-2 gap-x-2 gap-y-1 text-xs text-zinc-400",children:[(0,i.jsx)("span",{children:"成交總價:"})," ",(0,i.jsxs)("span",{className:"text-white text-right",children:[u(F.data?.tooltipInfo?.totalPrice??F.data?.totalPrice),"萬"]}),(0,i.jsx)("span",{children:"房屋總價:"})," ",(0,i.jsxs)("span",{className:"text-white text-right",children:[u(F.data?.tooltipInfo?.housePrice??F.data?.housePrice),"萬"]}),(0,i.jsx)("span",{children:"車位總價:"})," ",(0,i.jsxs)("span",{className:"text-white text-right",children:[u(F.data?.tooltipInfo?.parkingPrice??F.data?.parkingPrice),"萬"]}),(0,i.jsx)("span",{children:"房屋面積:"})," ",(0,i.jsxs)("span",{className:"text-white text-right",children:[u(F.data?.tooltipInfo?.houseArea??F.data?.houseArea,2),"坪"]})]})]})}))}),!j&&J&&(0,i.jsx)(m,{triggerRect:J.rect,isTopRow:!0,children:(0,i.jsxs)("div",{className:"w-56 bg-zinc-900 border border-zinc-700 rounded-lg p-2 shadow-xl text-xs text-zinc-300",children:["住宅面積變化: ",(0,i.jsx)("span",{className:"text-amber-300",children:J.label}),(0,i.jsx)("div",{className:"text-[10px] text-zinc-500 mt-1",children:"已排除店舖/商辦"})]})}),r&&(0,i.jsxs)("div",{className:"min-w-max pb-32",children:[(0,i.jsxs)("div",{className:"flex items-center justify-end gap-2 mb-2",children:[(0,i.jsx)("span",{className:"text-xs text-zinc-500",children:"特殊交易"}),x.map(e=>{let t=ee===e.key;return(0,i.jsxs)("button",{onClick:()=>et(t=>t===e.key?null:e.key),className:(0,s.cn)("flex items-center gap-1 px-2 py-1 rounded border text-[10px] transition",t?"border-cyan-400 text-cyan-300 bg-cyan-500/10":"border-white/10 text-zinc-400 hover:text-zinc-200 hover:border-white/30"),children:[(0,i.jsx)("span",{className:(0,s.cn)("w-4 h-4 rounded border flex items-center justify-center text-[9px] font-bold bg-transparent",e.badgeClass),title:e.label,children:e.shortLabel}),e.label]},e.key)})]}),(0,i.jsxs)("table",{className:"divide-y divide-zinc-800 border-collapse w-full text-sm",children:[(0,i.jsx)("thead",{children:(0,i.jsxs)("tr",{children:[(0,i.jsx)("th",{className:"sticky left-0 bg-dark-card z-20 p-2 text-zinc-400 border-r border-zinc-800",children:"樓層 \\ 戶別"}),M.map(e=>(0,i.jsx)("th",{className:(0,s.cn)("p-2 text-zinc-300 font-medium border-l border-zinc-800/50 bg-zinc-900/50 relative",(v||ei[e]?.hasVariance)&&"bg-amber-500/10"),onMouseEnter:t=>{if(j)return;let r=ei[e];(v||r?.hasVariance)&&Y({rect:t.currentTarget.getBoundingClientRect(),label:r.label||""})},onMouseLeave:()=>{j||Y(null)},children:(0,i.jsxs)("span",{className:"inline-flex items-center justify-center gap-1",children:[e,(v||ei[e]?.hasVariance)&&(0,i.jsx)("span",{className:"px-1 py-0.5 text-[9px] rounded border border-amber-400/70 text-amber-300 bg-amber-500/10",children:"Δ坪"})]})},e))]})}),(0,i.jsx)("tbody",{className:"divide-y divide-zinc-800/50",children:S.map((e,t)=>(0,i.jsxs)("tr",{className:"hover:bg-zinc-800/30 transition-colors",children:[(0,i.jsx)("td",{className:"sticky left-0 bg-dark-card z-10 p-2 font-bold text-zinc-300 border-r border-zinc-800 text-center",children:e}),M.map(r=>{let n=P[e]?.[r];return n&&0!==n.length?(0,i.jsx)("td",{className:"p-1 border-l border-zinc-800/50 align-top",children:(0,i.jsx)("div",{className:"flex flex-col gap-1",children:n.map((e,r)=>{let n=x.filter(t=>t.predicate(e)),a=n.length>0,o=y||a?"transparent":p(e.premium),c=e.remark?.includes("露台")?{icon:(0,i.jsx)(l.A,{className:"w-3 h-3"}),label:"露台"}:null,d=0===e.premium,u=t<3,m=ee?x.find(e=>e.key===ee)?.predicate:null,h=!m||m(e);return(0,i.jsxs)("div",{className:(0,s.cn)("p-1.5 rounded text-xs transition-transform hover:scale-105 cursor-default relative group",!y&&d&&"ring-1 ring-cyan-500",a&&"bg-transparent border border-zinc-700/60",ee&&!h&&"opacity-20",ee&&h&&"ring-2 ring-cyan-400"),style:{backgroundColor:o},onMouseEnter:j?void 0:t=>{j||$({rect:t.currentTarget.getBoundingClientRect(),data:e,isTopRow:u})},onMouseLeave:j?void 0:en,children:[(0,i.jsxs)("div",{className:"flex flex-col gap-0.5 pr-4",children:[(0,i.jsxs)("span",{className:"font-semibold text-white flex items-center gap-1 leading-tight",children:[c&&(0,i.jsx)("span",{className:"text-zinc-200",title:c.label,children:c.icon}),e.unitPrice.toFixed(1),"萬"]}),(0,i.jsx)("div",{className:"text-[10px] text-zinc-300 font-mono tracking-tight opacity-90",children:e.transactionDate||"-"})]}),(0,i.jsxs)("div",{className:"absolute top-0.5 right-0.5 flex flex-col items-end gap-0.5",children:[n.map(e=>(0,i.jsx)("span",{className:(0,s.cn)("flex items-center justify-center w-3 h-3 text-[8px] font-bold rounded border bg-transparent",e.badgeClass),title:e.label,children:e.shortLabel},e.key)),e.hasParking&&(0,i.jsx)("span",{className:"flex items-center justify-center w-3 h-3 bg-blue-500 text-white text-[8px] font-bold rounded-sm",title:"含車位",children:"P"})]})]},r)})})},`${e}-${r}`):(0,i.jsx)("td",{className:"p-2 border-l border-zinc-800/50 bg-zinc-900/20 text-center text-zinc-600",children:"-"},`${e}-${r}`)})]},e))})]})]}),a&&E&&(0,i.jsxs)("div",{className:"space-y-2",children:[(0,i.jsxs)("h3",{className:"text-lg font-semibold text-zinc-200",children:["調價幅度統計摘要 (",er,")"]}),(0,i.jsx)("div",{className:"overflow-x-auto rounded-lg border border-zinc-800",children:(0,i.jsxs)("table",{className:"w-full text-sm text-left text-zinc-300",children:[(0,i.jsx)("thead",{className:"text-xs text-zinc-400 uppercase bg-zinc-900/50",children:(0,i.jsxs)("tr",{children:[(0,i.jsx)("th",{className:"px-6 py-3",children:"基準房屋總價"}),(0,i.jsx)("th",{className:"px-6 py-3",children:"調價幅度總額"}),(0,i.jsx)("th",{className:"px-6 py-3",children:"總溢價率"}),(0,i.jsx)("th",{className:"px-6 py-3",children:"已售房屋坪數"}),(0,i.jsx)("th",{className:"px-6 py-3",children:"平均單價調價"})]})}),(0,i.jsx)("tbody",{children:(0,i.jsxs)("tr",{className:"bg-zinc-900/20 border-b border-zinc-800",children:[(0,i.jsxs)("td",{className:"px-6 py-4",children:[u(E.totalBaselineHousePrice)," 萬"]}),(0,i.jsxs)("td",{className:(0,s.cn)("px-6 py-4 font-bold",E.totalPricePremiumValue>0?"text-red-400":"text-violet-400"),children:[E.totalPricePremiumValue>0?"+":"",u(E.totalPricePremiumValue)," 萬"]}),(0,i.jsxs)("td",{className:"px-6 py-4",children:[(E.totalPricePremiumValue/E.totalBaselineHousePrice*100).toFixed(2)," %"]}),(0,i.jsxs)("td",{className:"px-6 py-4",children:[u(E.totalSoldArea)," 坪"]}),(0,i.jsxs)("td",{className:(0,s.cn)("px-6 py-4",E.totalPricePremiumValue>0?"text-red-400":"text-violet-400"),children:[(E.totalPricePremiumValue/E.totalSoldArea).toFixed(2)," 萬/坪"]})]})})]})})]}),h&&k&&k.length>0&&(0,i.jsxs)("div",{className:"space-y-2",children:[(0,i.jsx)("h3",{className:"text-lg font-semibold text-zinc-200",children:"戶型水平價差與溢價貢獻"}),(0,i.jsxs)("div",{className:"flex flex-wrap items-center gap-2 text-xs text-zinc-400",children:[e.comparisonMeta&&(0,i.jsxs)("span",{children:["原始最低戶型：",e.comparisonMeta.originalMinUnit||"-"," ","number"==typeof e.comparisonMeta.originalMinAvg?`(${e.comparisonMeta.originalMinAvg.toFixed(2)} 萬/坪)`:""," ｜ ","實際最低戶型：",e.comparisonMeta.actualMinUnit||"-"," ","number"==typeof e.comparisonMeta.actualMinAvg?`(${e.comparisonMeta.actualMinAvg.toFixed(2)} 萬/坪)`:""]}),X.topPair&&(0,i.jsxs)("span",{children:["AI 摘要：常見價差組合 ",X.topPair.unitA," ↔ ",X.topPair.unitB,"（",X.topPair.count," 層，平均差 ",X.topPair.avgDiff>0?"+":"",X.topPair.avgDiff.toFixed(2),"）"]}),X.maxPairOverall&&(0,i.jsxs)("span",{children:["最大價差：",X.maxPairOverall.floor,"F ",X.maxPairOverall.unitHigh," ↔ ",X.maxPairOverall.unitLow,"（",X.maxPairOverall.diff>0?"+":"",X.maxPairOverall.diff.toFixed(2),"）"]}),f&&(0,i.jsxs)("div",{className:"flex items-center gap-2 text-zinc-500",children:[(0,i.jsxs)("span",{children:["樓層配置：",I?.configurations?.length?`已同步 ${I.configurations.length} 組`:"未設定"]}),b&&b.length>0&&(0,i.jsx)("button",{onClick:()=>L(e=>!e),className:"px-2 py-1 rounded border border-white/10 text-[11px] text-zinc-400 hover:text-zinc-200 hover:border-white/30 transition",children:D?"收合配置":"設定配置"})]})]}),D&&b&&b.length>0&&f&&(0,i.jsx)("div",{className:"mt-3",children:(0,i.jsx)(d.sB,{transactions:b,project:f,configOnly:!0,title:"樓層配置（戶型水平價差）",storageScope:W,initialStep:"config",onConfigChange:G,mode:"report"})}),(0,i.jsx)("div",{className:"overflow-x-auto rounded-lg border border-zinc-800",children:(0,i.jsxs)("table",{className:"w-full text-sm text-left text-zinc-300",children:[(0,i.jsx)("thead",{className:"text-xs text-zinc-400 uppercase bg-zinc-900/50",children:(0,i.jsxs)("tr",{children:[(0,i.jsx)("th",{className:"px-4 py-3",children:"戶型"}),(0,i.jsx)("th",{className:"px-4 py-3",children:"環境標籤"}),(0,i.jsx)("th",{className:"px-4 py-3",children:"基準戶 (樓/價)"}),(0,i.jsx)("th",{className:"px-4 py-3",children:"原始平均單價"}),(0,i.jsx)("th",{className:"px-4 py-3",children:"實際平均單價"}),(0,i.jsx)("th",{className:"px-4 py-3",children:"去化戶數"}),(0,i.jsx)("th",{className:"px-4 py-3",children:"去化坪數"}),(0,i.jsx)("th",{className:"px-4 py-3",children:"溢價(萬/坪)"}),(0,i.jsx)("th",{className:"px-4 py-3",children:"溢價貢獻"}),(0,i.jsx)("th",{className:"px-4 py-3",children:"貢獻佔比"}),(0,i.jsx)("th",{className:"px-4 py-3",children:"細節"})]})}),(0,i.jsx)("tbody",{children:k.map((e,t)=>{let r,a,l,o=t=>{t&&t!==e.unitType?U(e=>e===t?null:t):U(null)},c=_&&_!==e.unitType?[e.unitType,_]:[e.unitType];return(0,i.jsxs)(n.Fragment,{children:[(0,i.jsxs)("tr",{className:"bg-zinc-900/20 border-b border-zinc-800 hover:bg-zinc-800/20",children:[(0,i.jsx)("td",{className:"px-4 py-3 font-medium text-white",children:e.unitType}),(0,i.jsx)("td",{className:"px-4 py-3",children:(a=(r=K?.get(e.unitType))?Array.from(r.labelMap.entries()):[]).length?(0,i.jsx)("div",{className:"flex flex-wrap gap-1",title:r?.details.join(" | "),children:a.map(([t,r])=>(0,i.jsx)("span",{className:`px-2 py-0.5 rounded text-[10px] border ${(e=>{switch(e){case"road":return"border-amber-400/40 text-amber-300 bg-amber-500/10";case"good":return"border-emerald-400/40 text-emerald-300 bg-emerald-500/10";case"bad":return"border-rose-400/40 text-rose-300 bg-rose-500/10";case"adjacent":return"border-zinc-500/40 text-zinc-300 bg-zinc-500/10";default:return"border-white/10 text-zinc-300 bg-white/5"}})(r)}`,children:t},`${e.unitType}-${t}`))}):(0,i.jsx)("span",{className:"text-zinc-500",children:"-"})}),(0,i.jsx)("td",{className:"px-4 py-3",children:e.anchorInfo}),(0,i.jsx)("td",{className:"px-4 py-3",children:"number"==typeof e.originalAvgPrice?`${e.originalAvgPrice.toFixed(2)} 萬/坪`:"-"}),(0,i.jsx)("td",{className:"px-4 py-3",children:"number"==typeof e.actualAvgPrice?`${e.actualAvgPrice.toFixed(2)} 萬/坪`:"-"}),(0,i.jsxs)("td",{className:"px-4 py-3",children:[e.unitsSold," 戶"]}),(0,i.jsx)("td",{className:"px-4 py-3",children:"number"==typeof e.totalSoldArea?`${e.totalSoldArea.toFixed(2)} 坪`:"-"}),(0,i.jsx)("td",{className:(0,s.cn)("px-4 py-3",e.avgPremiumPerPing>0?"text-red-400":"text-violet-400"),children:"number"==typeof e.avgPremiumPerPing?`${e.avgPremiumPerPing>0?"+":""}${e.avgPremiumPerPing.toFixed(2)} 萬/坪`:"-"}),(0,i.jsxs)("td",{className:(0,s.cn)("px-4 py-3 font-bold",e.timePremiumContribution>0?"text-red-400":"text-violet-400"),children:[e.timePremiumContribution>0?"+":"",u(e.timePremiumContribution)," 萬"]}),(0,i.jsxs)("td",{className:"px-4 py-3",children:["number"==typeof e.contributionPercentage?e.contributionPercentage.toFixed(2):"0.00","%"]}),(0,i.jsx)("td",{className:"px-4 py-3",children:(0,i.jsx)("button",{onClick:()=>T(t=>t===e.unitType?null:e.unitType),className:"text-[11px] text-cyan-300 border border-cyan-400/30 rounded px-2 py-1 hover:bg-cyan-500/10 transition",children:C===e.unitType?"收合":"展開"})})]}),C===e.unitType&&(0,i.jsx)("tr",{className:"bg-zinc-950/40 border-b border-zinc-800",children:(0,i.jsx)("td",{colSpan:11,className:"px-4 py-3",children:(0,i.jsxs)("div",{className:"flex flex-col xl:flex-row gap-6",children:[(0,i.jsx)("div",{className:"xl:w-[400px] shrink-0",children:(0,i.jsxs)("div",{className:"bg-zinc-900/40 rounded border border-white/10 p-2 h-full flex flex-col",children:[(0,i.jsxs)("h4",{className:"text-xs font-bold text-zinc-400 mb-2 flex items-center gap-2",children:[(0,i.jsx)("span",{className:"w-1.5 h-1.5 rounded-full bg-cyan-400"}),"樓層配置視圖"]}),(0,i.jsx)("div",{className:"flex-1 min-h-[300px] relative rounded overflow-hidden bg-zinc-950/50 border border-white/5",children:(()=>{let e=I?.configurations?.[0];if(!e)return(0,i.jsx)("div",{className:"absolute inset-0 flex items-center justify-center text-zinc-500 text-xs",children:"無配置資料"});let t=(e.positions||[]).map(e=>(0,d.jk)(e,1)),r=e.envTiles||[];return(0,i.jsx)(d.Cn,{positions:t,envTiles:r,selectedUnits:c,zoom:.6,gridSize:e.gridSize||30,compassDirection:e.compassDirection||0,onPositionsChange:()=>{},onUnitClick:e=>o(e),onZoomChange:()=>{},isAnalyzeMode:!0,showBadges:!1,unitShape:"square"})})()}),(0,i.jsx)("div",{className:"mt-2 text-[10px] text-zinc-500 text-center",children:"* 此為唯讀視圖，顯示目前選擇戶型位置"})]})}),(0,i.jsxs)("div",{className:"flex-1 rounded border border-white/10 bg-zinc-900/40 p-3 overflow-hidden",children:[(0,i.jsxs)("div",{className:"flex items-center justify-between mb-3",children:[(0,i.jsxs)("div",{className:"text-xs text-zinc-400",children:["戶型比價矩陣（單位：","percent"===B?"%":"萬/坪","，",(0,i.jsx)("span",{className:"text-red-400",children:"紅>5%"}),"，",(0,i.jsx)("span",{className:"text-orange-400",children:"橘2~5%"}),"，",(0,i.jsx)("span",{className:"text-yellow-400",children:"黃0~2%"}),"，",(0,i.jsx)("span",{className:"text-emerald-400",children:"綠<0%"}),"）"]}),(0,i.jsxs)("div",{className:"flex bg-zinc-950 p-0.5 rounded-md border border-zinc-800",children:[(0,i.jsx)("button",{onClick:e=>{e.stopPropagation(),V("value")},className:(0,s.cn)("px-2 py-1 text-[10px] rounded transition-all","value"===B?"bg-zinc-800 text-white shadow-sm":"text-zinc-500 hover:text-zinc-300"),children:"價差數值 $"}),(0,i.jsx)("button",{onClick:e=>{e.stopPropagation(),V("percent")},className:(0,s.cn)("px-2 py-1 text-[10px] rounded transition-all","percent"===B?"bg-zinc-800 text-white shadow-sm":"text-zinc-500 hover:text-zinc-300"),children:"價差比例 %"})]})]}),(0,i.jsx)("div",{className:"overflow-x-auto",children:(0,i.jsxs)("table",{className:"w-full text-xs border-collapse",children:[(0,i.jsx)("thead",{children:(0,i.jsxs)("tr",{children:[(0,i.jsx)("th",{className:"p-2 text-zinc-500 font-normal text-left whitespace-nowrap sticky left-0 bg-zinc-900/90 z-10 border-b border-zinc-800",children:"樓層"}),M.filter(t=>t!==e.unitType).map(e=>{let t=K?.get(e),r=t?Array.from(t.labelMap.keys()):[],n=_===e;return(0,i.jsx)("th",{onClick:()=>o(e),className:(0,s.cn)("p-2 text-zinc-400 font-medium text-center whitespace-nowrap min-w-[60px] border-b border-zinc-800 align-top cursor-pointer transition-colors",n&&"bg-cyan-500/10 text-cyan-200 ring-1 ring-cyan-400/40"),title:"點擊高亮此戶型欄位",children:(0,i.jsxs)("div",{className:"flex flex-col gap-0.5 items-center",children:[(0,i.jsxs)("span",{children:["vs ",e]}),r.map((e,t)=>(0,i.jsx)("span",{className:"text-[10px] bg-zinc-800 text-zinc-400 px-1 rounded transform scale-90 origin-top",children:e},t))]})},e)})]})}),(0,i.jsx)("tbody",{className:"divide-y divide-zinc-800/30",children:(l=M.filter(t=>t!==e.unitType),S.map(t=>{let r=P?.[t]?.[e.unitType],n=r?.[0];if(!n||!n.unitPrice)return null;let a=n.unitPrice;return(0,i.jsxs)("tr",{className:"hover:bg-zinc-800/20",children:[(0,i.jsxs)("td",{className:"p-2 text-zinc-500 font-mono sticky left-0 bg-zinc-900/90 border-r border-zinc-800/50",children:[t,"F"]}),l.map(e=>{let r=P?.[t]?.[e],n=r?.[0],l=n?.unitPrice,o=_===e;if(!l)return(0,i.jsx)("td",{className:(0,s.cn)("p-2 text-center text-zinc-700 transition-colors",o&&"bg-cyan-500/10 ring-1 ring-cyan-400/30"),children:"-"},e);let c=a-l,d=c/l*100,u=p(d),x="text-zinc-200";x=d>5?"text-white font-bold shadow-sm":d<0?"text-emerald-100":d>2?"text-orange-100":"text-yellow-100",.1>Math.abs(d)&&(x="text-zinc-400");let m="percent"===B?`${d.toFixed(1)}%`:c.toFixed(1),h=c>0?"+":"";return(0,i.jsx)("td",{className:(0,s.cn)("p-1 text-center transition-colors",o&&"bg-cyan-500/10"),children:(0,i.jsxs)("div",{className:(0,s.cn)("py-1 px-1.5 rounded text-[11px] font-mono transition-colors",x,o&&"ring-2 ring-cyan-400/70 ring-offset-1 ring-offset-zinc-900/40"),style:{backgroundColor:u},title:`${e}: ${l}萬/坪`,children:[h,m]})},e)})]},t)}))})]})})]})]})})})]},t)})})]})})]})]}):(0,i.jsx)("div",{className:"text-zinc-500 text-center p-8",children:"無有效熱力圖資料"})}}}]);