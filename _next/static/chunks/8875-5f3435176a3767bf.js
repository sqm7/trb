"use strict";(self.webpackChunk_N_E=self.webpackChunk_N_E||[]).push([[8875],{8875:(e,t,n)=>{n.d(t,{Cn:()=>k,jk:()=>M,sB:()=>D});var r=n(95155),i=n(12115),a=n(32745),l=n(75364),o=n(38346),s=n(39430),c=n(80642),d=n(33210),u=n(33024),p=n(63888),f=n(44071),x=n(67514),h=n(82482),g=n(86901),m=n(9199),b=n(55243),y=n(94514),v=n(89363),j=n(89823),w=n(67635),N=n(68459),z=n(14403),S=n(24538);let _=3;function M(e,t){return{unitType:e.unitType,col:e.x,row:e.y,facing:e.facing,roadFacing:e.roadFacing,roadFacingDirection:e.roadFacingDirection,roadFacingDirections:e.roadFacingDirections,adjacentToUnits:e.adjacentToUnits,facingOpenSpace:e.facingOpenSpace,openSpaceType:e.openSpaceType,openSpaceFacingDirection:e.openSpaceFacingDirection,openSpaceFacingDirections:e.openSpaceFacingDirections}}function F({position:e,result:t,isSelected:n,isDragging:i,cellSize:a,compassDirection:l,onClick:o,onDragStart:s,showBadges:c=!0,shape:d="square"}){let u={left:e.col*a,top:e.row*a,width:_*a,height:_*a},p={top:[],right:[],bottom:[],left:[]},f=["N","E","S","W"],x=(l||0)/90%4,h={N:"top",E:"right",S:"bottom",W:"left"};["top","right","bottom","left"].forEach((e,t)=>{h[f[(x+t)%4]]=e});let g=(e,t,n)=>{e&&["N","S","E","W"].includes(e)&&p[h[e]].push({text:t,color:n})};if(e.facing&&g(e.facing[0],"朝","violet"),e.roadFacing&&(e.roadFacingDirections&&e.roadFacingDirections.length>0?e.roadFacingDirections.forEach(e=>g(e,"路","orange")):g(e.roadFacingDirection,"路","orange")),e.facingOpenSpace){let t={school:"校",plaza:"廣",park:"園",river:"河",tower:"塔",grave:"墓",bridge:"橋",mountain:"山",adjacent:"鄰"},n={school:"green",plaza:"green",park:"green",river:"cyan",tower:"red",grave:"zinc",bridge:"blue",mountain:"green",adjacent:"zinc"};if(e.openSpaceFacingDirections&&e.openSpaceFacingDirections.length>0)e.openSpaceFacingDirections.forEach(e=>{let r=e.type;g(e.direction,t[r]||"空",n[r]||"green")});else{let r=e.openSpaceType||"park";g(e.openSpaceFacingDirection,t[r]||"空",n[r]||"green")}}let m=(e,t)=>0===e.length?null:(0,r.jsx)("div",{className:`absolute flex gap-0.5 ${t}`,children:e.map((e,t)=>(0,r.jsx)("div",{className:`
                            text-white px-1 py-0.5 rounded shadow-sm font-bold min-w-[14px] text-center flex items-center justify-center leading-none
                            ${"violet"===e.color?"bg-violet-500":""}
                            ${"orange"===e.color?"bg-orange-500":""}
                            ${"blue"===e.color?"bg-blue-500":""}
                            ${"cyan"===e.color?"bg-cyan-600":""}
                            ${"red"===e.color?"bg-red-600":""}
                            ${"zinc"===e.color?"bg-zinc-600":""}
                            ${"green"===e.color?"bg-emerald-600":""}
                        `,style:{fontSize:`${Math.max(10,.5*a)}px`,padding:`${.05*a}px ${.1*a}px`,minWidth:`${.5*a}px`},children:e.text},t))});return(0,r.jsxs)("div",{className:`
                absolute cursor-grab active:cursor-grabbing select-none transition-all duration-200
                ${n?"z-30 scale-110 drop-shadow-md":"z-10 hover:z-20 hover:scale-105 opacity-90"}
                ${i?"opacity-50 scale-105":""}
            `,style:u,onClick:o,onMouseDown:t=>s(e.unitType,t),children:[(0,r.jsx)("div",{className:`
                    w-full h-full flex items-center justify-center font-bold text-white shadow-sm transition-colors border-2
                    ${n?"bg-cyan-600 border-cyan-300":"bg-zinc-700 border-zinc-600 hover:bg-zinc-600"}
                    ${"circle"===d?"rounded-full":"rounded-md"}
                `,style:{fontSize:`${Math.max(11,.5*a)}px`},children:e.unitType}),c&&(0,r.jsxs)(r.Fragment,{children:[m(p.top,"bottom-full mb-0.5 left-1/2 -translate-x-1/2"),m(p.bottom,"top-full mt-0.5 left-1/2 -translate-x-1/2"),m(p.left,"right-full mr-0.5 top-1/2 -translate-y-1/2 flex-col"),m(p.right,"left-full ml-0.5 top-1/2 -translate-y-1/2 flex-col")]})]})}function T({tile:e,cellSize:t,isSelected:n,onMouseDown:i,onResizeStart:a,onRemove:l}){let o={left:e.x*t,top:e.y*t,width:e.width*t,height:e.height*t},s={road:"bg-zinc-600/50 border-zinc-500",park:"bg-emerald-600/30 border-emerald-500",school:"bg-indigo-600/30 border-indigo-500",plaza:"bg-amber-600/30 border-amber-500",river:"bg-cyan-600/30 border-cyan-500",tower:"bg-red-600/30 border-red-500",grave:"bg-zinc-600/30 border-zinc-500",bridge:"bg-blue-600/30 border-blue-500",mountain:"bg-green-700/30 border-green-600",adjacent:"bg-zinc-500/30 border-zinc-400",custom:"bg-zinc-700/50 border-zinc-600"};return(0,r.jsxs)("div",{className:`
                absolute transition-all duration-75 group select-none
                ${s[e.type]||s.custom}
                ${n?"border-2 border-white z-20":"border border-dashed z-0 opacity-80 hover:opacity-100"}
            `,style:o,onMouseDown:i,children:[l&&(0,r.jsx)("button",{onMouseDown:e=>e.stopPropagation(),onClick:e=>{e.stopPropagation(),l()},className:"absolute -top-2 -right-2 w-4 h-4 rounded-full bg-black/70 border border-white/20 text-white/80 hover:text-white hover:border-white/60 flex items-center justify-center text-[10px]","aria-label":"移除元件",children:(0,r.jsx)(d.A,{className:"w-3 h-3"})}),(0,r.jsx)("div",{className:"w-full h-full flex items-center justify-center text-white/80 font-medium overflow-hidden px-0.5",style:{fontSize:`${Math.max(11,.5*t)}px`},children:e.label||e.type}),l&&(0,r.jsx)(r.Fragment,{children:(0,r.jsx)("div",{className:"absolute bottom-0 right-0 w-3 h-3 bg-white/50 cursor-se-resize hover:bg-white",onMouseDown:e=>{e.stopPropagation(),a(e,"se")}})})]})}function A({selectedUnits:e,positions:t,compassDirection:n=0,onBatchUpdate:a,onClear:l,onCompassChange:o}){let s=0===e.length?"empty":1===e.length?"inspector":"batch",c="inspector"===s?t.find(t=>t.unitType===e[0]):null,p=(0,i.useMemo)(()=>{if(!t||!Array.isArray(t)||0===t.length)return null;let e=t.filter(e=>e&&"number"==typeof e.col&&"number"==typeof e.row);if(0===e.length)return null;let n=Math.min(...e.map(e=>e.col)),r=Math.max(...e.map(e=>e.col+_)),i=Math.min(...e.map(e=>e.row)),a=Math.max(...e.map(e=>e.row+_));return{minCol:n,maxCol:r,minRow:i,maxRow:a,centerX:(n+r)/2,centerY:(i+a)/2}},[t]),f=(0,i.useMemo)(()=>{if(!c||!p||"number"!=typeof c.col||"number"!=typeof c.row)return"";let e=c.col+_/2,t=c.row+_/2,r=e-p.centerX,i=t-p.centerY,a=.25>=Math.abs(r)?"":r>0?"E":"W",l=.25>=Math.abs(i)?"":i>0?"S":"N";if(!a&&!l)return"C";let o=`${l}${a}`,s={N:0,NE:45,E:90,SE:135,S:180,SW:225,W:270,NW:315},d=s[o];if(void 0===d)return o;let u=(d+n)%360;return Object.keys(s).find(e=>s[e]===u)||o},[c,p,n]),x=(0,i.useMemo)(()=>f?({N:"北",S:"南",E:"東",W:"西",NE:"東北",NW:"西北",SE:"東南",SW:"西南",C:"中央"})[f]||f:"—",[f]);return(0,r.jsxs)("div",{className:"bg-zinc-900/50 rounded-lg border border-white/10 p-4 h-full flex flex-col gap-4",children:[o&&(0,r.jsxs)("div",{className:"flex flex-col gap-2 items-center bg-zinc-950/50 p-3 rounded-lg border border-white/5",children:[(0,r.jsx)("div",{className:"text-[10px] font-bold text-zinc-500 uppercase tracking-widest self-start",children:"指北針設定"}),(0,r.jsx)("div",{className:"relative w-full h-24 flex items-center justify-center",children:(0,r.jsx)(C,{direction:n||0,onChange:o})}),(0,r.jsx)("div",{className:"text-[10px] text-zinc-400",children:"點擊切換地圖朝向"})]}),(0,r.jsxs)("div",{className:"flex items-center justify-between border-b border-white/5 pb-2",children:[(0,r.jsxs)("div",{className:"text-sm font-bold text-zinc-100",children:["empty"===s&&"環境標籤與設定","inspector"===s&&(0,r.jsxs)("span",{className:"text-cyan-400",children:["檢視戶型: ",c?.unitType]}),"batch"===s&&(0,r.jsxs)("span",{className:"text-violet-400",children:["批量設定 (",e.length,")"]})]}),"empty"!==s&&(0,r.jsx)("button",{onClick:l,className:"text-zinc-500 hover:text-zinc-300",children:(0,r.jsx)(d.A,{className:"w-4 h-4"})})]}),"inspector"===s&&c&&(0,r.jsxs)("div",{className:"space-y-4",children:[(0,r.jsxs)("div",{className:"text-xs text-zinc-400 space-y-1",children:[(0,r.jsxs)("div",{className:"flex justify-between",children:[(0,r.jsx)("span",{children:"座標:"}),(0,r.jsxs)("span",{className:"font-mono text-zinc-200",children:["(",c.col,", ",c.row,")"]})]}),(0,r.jsxs)("div",{className:"flex justify-between",children:[(0,r.jsx)("span",{children:"相對朝向:"}),(0,r.jsx)("span",{className:"font-medium text-zinc-200",children:x})]})]}),(0,r.jsxs)("div",{children:[(0,r.jsxs)("div",{className:"text-xs font-medium text-zinc-300 mb-2 flex justify-between",children:[(0,r.jsx)("span",{children:"臨路偵測 (Roads)"}),(0,r.jsx)("span",{className:"text-[10px] text-zinc-500",children:c.roadFacing?"Yes":"No"})]}),(0,r.jsx)("div",{className:"flex gap-2 flex-wrap",children:c.roadFacingDirections&&c.roadFacingDirections.length>0?c.roadFacingDirections.map(e=>(0,r.jsxs)("span",{className:"px-2 py-0.5 rounded bg-orange-500/20 text-orange-300 text-xs border border-orange-500/30",children:["N"===e?"北":"S"===e?"南":"E"===e?"東":"W"===e?"西":e,"側臨路"]},e)):(0,r.jsx)("span",{className:"text-xs text-zinc-600 px-2",children:"無臨路"})})]}),(0,r.jsxs)("div",{children:[(0,r.jsx)("div",{className:"text-xs font-medium text-zinc-300 mb-2",children:"周邊設施 (Amenities)"}),(0,r.jsx)("div",{className:"flex gap-2 flex-wrap",children:c.openSpaceFacingDirections&&c.openSpaceFacingDirections.length>0?c.openSpaceFacingDirections.map((e,t)=>(0,r.jsxs)("span",{className:"px-2 py-0.5 rounded bg-emerald-500/20 text-emerald-300 text-xs border border-emerald-500/30 flex items-center gap-1",children:[(0,r.jsx)("span",{children:"N"===e.direction?"北":"S"===e.direction?"南":"E"===e.direction?"東":"W"===e.direction?"西":e.direction}),(0,r.jsx)("span",{className:"opacity-50",children:"|"}),(0,r.jsx)("span",{className:"tower"===e.type?"text-red-400":"grave"===e.type?"text-zinc-400":"river"===e.type?"text-cyan-400":"park"===e.type?"text-emerald-400":"school"===e.type?"text-indigo-400":"plaza"===e.type?"text-amber-400":"bridge"===e.type?"text-blue-400":"mountain"===e.type?"text-green-400":"adjacent"===e.type?"text-zinc-400":"",children:"park"===e.type?"公園":"school"===e.type?"學校":"plaza"===e.type?"廣場":"river"===e.type?"河景":"tower"===e.type?"電塔":"grave"===e.type?"墳墓":"bridge"===e.type?"高架":"mountain"===e.type?"山景":"adjacent"===e.type?"鄰房":e.type})]},`${e.type}-${e.direction}-${t}`)):(0,r.jsx)("span",{className:"text-xs text-zinc-600 px-2",children:"無偵測到設施"})})]})]}),"batch"===s&&(0,r.jsxs)("div",{className:"space-y-4",children:[(0,r.jsxs)("div",{className:"p-2 bg-violet-900/20 border border-violet-500/30 rounded text-xs text-violet-200",children:["正在批量修改 ",e.length," 個單位"]}),(0,r.jsxs)("div",{children:[(0,r.jsx)("div",{className:"text-xs font-medium text-zinc-300 mb-2",children:"統一朝向"}),(0,r.jsx)("div",{className:"grid grid-cols-3 gap-1",children:[{value:"",label:"清除"},{value:"N",label:"北"},{value:"S",label:"南"},{value:"E",label:"東"},{value:"W",label:"西"},{value:"NE",label:"東北"},{value:"NW",label:"西北"},{value:"SE",label:"東南"},{value:"SW",label:"西南"}].map(e=>(0,r.jsx)("button",{onClick:()=>a({facing:e.value}),className:"text-xs py-1 rounded bg-zinc-800 text-zinc-400 hover:bg-violet-600 hover:text-white transition",children:e.label},e.value))})]})]}),(0,r.jsx)("div",{className:"h-px bg-white/10 my-2"}),(0,r.jsxs)("div",{className:"flex-1",children:[(0,r.jsxs)("div",{className:"text-xs font-bold text-zinc-400 mb-3 uppercase tracking-wider flex items-center gap-2",children:[(0,r.jsx)(u.A,{className:"w-3 h-3"}),"環境標籤 (拖曳使用)"]}),(0,r.jsx)("div",{className:"grid grid-cols-2 gap-2",children:[{id:"road",label:"臨路",color:"bg-zinc-700",border:"border-zinc-500"},{id:"park",label:"公園",color:"bg-green-800",border:"border-green-600"},{id:"school",label:"學校",color:"bg-blue-900",border:"border-blue-700"},{id:"plaza",label:"廣場",color:"bg-violet-900",border:"border-violet-700"},{id:"river",label:"河景",color:"bg-cyan-800",border:"border-cyan-600"},{id:"tower",label:"電塔",color:"bg-red-900",border:"border-red-700"},{id:"grave",label:"墳墓",color:"bg-zinc-800",border:"border-zinc-600"},{id:"bridge",label:"高架",color:"bg-blue-800",border:"border-blue-600"},{id:"mountain",label:"山景",color:"bg-green-900",border:"border-green-700"},{id:"adjacent",label:"鄰房",color:"bg-zinc-600",border:"border-zinc-400"}].map(e=>(0,r.jsx)("div",{draggable:!0,onDragStart:t=>{var n;return n=e.id,void(t.dataTransfer.setData("env-type",n),t.dataTransfer.setData("application/json",JSON.stringify({type:"env",envType:n})),t.dataTransfer.effectAllowed="copy")},className:`
                                ${e.color} ${e.border}
                                text-white text-xs font-bold py-2 px-3 rounded cursor-grab active:cursor-grabbing
                                border shadow-sm hover:brightness-110 flex items-center justify-center
                            `,children:e.label},e.id))})]})]})}function C({direction:e,onChange:t}){return(0,r.jsxs)("div",{className:"absolute top-8 right-8 z-50 flex flex-col items-center",children:[(0,r.jsx)("div",{className:"relative",children:(0,r.jsx)("div",{className:"w-16 h-16 bg-zinc-900/90 rounded-full border-2 border-zinc-700 shadow-xl flex items-center justify-center cursor-pointer hover:border-zinc-500 transition-colors z-10 relative",onClick:()=>t((e+90)%360),children:(0,r.jsxs)(s.P.div,{animate:{rotate:-e},transition:{type:"spring",stiffness:150,damping:15},className:"w-full h-full flex items-center justify-center relative",children:[(0,r.jsx)("div",{className:"absolute -top-1 left-1/2 -translate-x-1/2 w-0 h-0 border-l-[5px] border-r-[5px] border-b-[7px] border-transparent border-b-red-500"}),(0,r.jsx)("div",{className:"absolute w-1 h-3/5 bg-gradient-to-b from-red-500 to-zinc-600 rounded-full"}),(0,r.jsx)("div",{className:"absolute w-3 h-3 bg-white rounded-full border-2 border-zinc-900 z-20"})]})})}),(0,r.jsx)("div",{className:"mt-2 flex gap-1 bg-black/50 p-1 rounded-full border border-white/10",children:[{label:"北",abbr:"N",value:0},{label:"東",abbr:"E",value:90},{label:"南",abbr:"S",value:180},{label:"西",abbr:"W",value:270}].map(n=>(0,r.jsx)("button",{onClick:e=>{e.stopPropagation(),t(n.value)},className:`
                            text-[10px] px-2.5 py-1 rounded-full font-bold transition-all min-w-[40px]
                            ${e===n.value?"bg-cyan-500 text-white":"bg-zinc-800 text-zinc-400 hover:bg-zinc-700 hover:text-white"}
                        `,children:(0,r.jsxs)("span",{className:"flex flex-col leading-none",children:[(0,r.jsx)("span",{children:n.label}),(0,r.jsx)("span",{className:"text-[9px] opacity-70",children:n.abbr})]})},n.value))}),(0,r.jsxs)("div",{className:"mt-6 text-[10px] text-zinc-500 font-mono bg-black/50 px-2 py-1 rounded",children:["上方為 ",0===e?"北":90===e?"東":180===e?"南":"西"]})]})}function k({positions:e,envTiles:t=[],results:n,selectedUnits:l,zoom:o,compassDirection:s=0,gridSize:d=30,onPositionsChange:u,onEnvTilesChange:p,onUnitClick:f,onZoomChange:x,onCompassChange:h,onGridSizeChange:g,isAnalyzeMode:m=!1,showBadges:b=!0,unitShape:y="square"}){let[v,j]=(0,i.useState)(null),[w,N]=(0,i.useState)(null),[z,S]=(0,i.useState)({x:0,y:0}),[M,A]=(0,i.useState)(null),[C,k]=(0,i.useState)(null),[$,D]=(0,i.useState)(null),[P,I]=(0,i.useState)(null),E=i.useRef(null),Z=i.useRef(null),[R,W]=(0,i.useState)({width:0,height:0}),U=Math.min(Math.max(0,(R.width||1e3)-80),Math.max(0,(R.height||1e3)-80))/d,B=U>0?U:1e3/d;i.useLayoutEffect(()=>{if(!Z.current)return;let e=Z.current,t=()=>{let t=e.getBoundingClientRect();W({width:t.width,height:t.height})};t();let n=new ResizeObserver(t);return n.observe(e),()=>n.disconnect()},[]);let O=(0,i.useCallback)((t,n,r)=>e.find(e=>e.unitType!==r&&t>=e.col&&t<e.col+_&&n>=e.row&&n<e.row+_),[e]),q=(0,i.useCallback)((e,t,n=_,r=_)=>e>=0&&t>=0&&e+n<=d&&t+r<=d,[d,d]),Y=(0,i.useCallback)((n,r,i)=>{if(m)return;i.preventDefault(),i.stopPropagation();let a="unit"===r?e.find(e=>e.unitType===n):t.find(e=>e.id===n);if(!a||!E.current)return;let l=E.current.getBoundingClientRect(),o="unit"===r?a.col:a.x,s="unit"===r?a.row:a.y,c=o*B,d=s*B;j(n),N(r),S({x:i.clientX-l.left-c,y:i.clientY-l.top-d}),A({col:o,row:s})},[e,t,m,B]),X=(0,i.useCallback)((e,n)=>{if(m)return;n.preventDefault(),n.stopPropagation();let r=t.find(t=>t.id===e);r&&(D(e),I({x:n.clientX,y:n.clientY,w:r.width,h:r.height}))},[t,m]),J=(0,i.useCallback)(n=>{if(E.current){if($&&P&&p){let e=n.clientX-P.x,r=n.clientY-P.y,i=Math.round(e/B),a=Math.round(r/B),l=Math.max(1,P.w+i),o=Math.max(1,P.h+a),s=t?.find(e=>e.id===$);s&&(s.width!==l||s.height!==o)&&p(t.map(e=>e.id===$?{...e,width:l,height:o}:e));return}if(v&&z){let r=E.current.getBoundingClientRect(),i=n.clientX-r.left-z.x,l=n.clientY-r.top-z.y,o=Math.round(i/B),c=Math.round(l/B),u="unit"===w?_:t?.find(e=>e.id===v)?.width||1,p="unit"===w?_:t?.find(e=>e.id===v)?.height||1;if(A({col:o=Math.max(0,Math.min(o,d-u)),row:c=Math.max(0,Math.min(c,d-p))}),"env"===w&&void 0!==s){let n=t?.find(e=>e.id===v);if(n){let t=o,r=o+n.width,i=c,l=c+n.height,d=t+n.width/2,u=i+n.height/2,p=null;for(let o of e){let e=o.col,c=o.col+_,f=o.row,x=o.row+_,h=e+_/2,g=f+_/2,m=Math.max(0,f-l,i-x);if(1>=Math.max(0,e-r,t-c)&&m<=1){let r=(0,a.Ul)({x:e,y:f,width:_,height:_},{x:t,y:i,width:n.width,height:n.height},s);p={targetUnit:o.unitType,direction:r,sourceTileId:v,lineStart:{x:h*B,y:g*B},lineEnd:{x:d*B,y:u*B}};break}}k(p)}}else k(null)}else k(null)}},[v,w,z,B,$,P,p,u,t,d,d,s,e]),K=(0,i.useCallback)(()=>{if($){D(null),I(null),k(null);return}if(v&&M&&w){if("unit"===w){let t=O(M.col,M.row,v);if(t){let n=e.find(e=>e.unitType===v);u(e.map(e=>e.unitType===v?{...e,col:t.col,row:t.row}:e.unitType===t.unitType?{...e,col:n.col,row:n.row}:e))}else q(M.col,M.row)&&u(e.map(e=>e.unitType===v?{...e,col:M.col,row:M.row}:e))}else if("env"===w&&p&&t){let e=t.find(e=>e.id===v);e&&q(M.col,M.row,e.width,e.height)&&p(t.map(e=>e.id===v?{...e,x:M.col,y:M.row}:e))}}j(null),N(null),A(null),k(null)},[v,M,w,O,q,u,e,p,t,$]),V=(0,i.useCallback)(()=>{v&&(j(null),N(null),A(null),k(null))},[v]);M&&v&&"unit"===w&&O(M.col,M.row,v);let G=(0,i.useCallback)(e=>{e.preventDefault();let n=e.dataTransfer.getData("env-type");if(!n)try{let t=e.dataTransfer.getData("application/json");if(t){let e=JSON.parse(t);"env"===e.type&&(n=e.envType)}}catch(e){}if(n&&p&&E.current){let r=E.current.getBoundingClientRect(),i=e.clientX-r.left,a=e.clientY-r.top,l=Math.min(d-2,Math.max(0,Math.floor(i/B))),o=Math.min(d-2,Math.max(0,Math.floor(a/B)));p([...t,{id:`env-${Date.now()}`,type:n,x:l,y:o,width:"road"===n?4:3,height:2,label:{road:"臨路",park:"公園",school:"學校",plaza:"廣場",river:"河景",tower:"電塔",grave:"墳墓",bridge:"高架",mountain:"山景",adjacent:"鄰房"}[n]||"設施"}])}},[p,B,t,d,d]),[L,Q]=(0,i.useState)(null),H=(0,i.useCallback)(e=>{if(!E.current||m||e.target.closest(".grid-unit"))return;let t=E.current.getBoundingClientRect(),n=e.clientX-t.left,r=e.clientY-t.top;Q({start:{x:n,y:r},end:{x:n,y:r}})},[m]),ee=(0,i.useCallback)(e=>{if((v||$)&&E.current)return void J(e);if(L&&E.current){let t=E.current.getBoundingClientRect(),n=e.clientX-t.left,r=e.clientY-t.top;Q(e=>e?{...e,end:{x:n,y:r}}:null)}},[v,$,J,L]),et=(0,i.useCallback)(t=>{if(v||$)return void K();if(L){let n=Math.min(L.start.x,L.end.x),r=Math.max(L.start.x,L.end.x),i=Math.min(L.start.y,L.end.y),a=Math.max(L.start.y,L.end.y);if(Math.abs(r-n)>5||Math.abs(a-i)>5){let o=e.filter(e=>{let t=e.col*B,l=e.row*B,o=t+_*B,s=l+_*B;return n<o&&r>t&&i<s&&a>l}).map(e=>e.unitType);t.shiftKey||t.ctrlKey||t.metaKey?f(null,{...t,type:"box-select",units:Array.from(new Set([...l,...o]))}):f(null,{...t,type:"box-select",units:o})}Q(null)}},[v,$,K,L,e,B,l,f]),en=(0,i.useCallback)(()=>{V(),Q(null)},[V]);return(0,r.jsxs)("div",{className:"space-y-2 h-full flex flex-col",children:[(0,r.jsx)("div",{className:"flex items-center gap-2 justify-end px-2 pb-2 border-b border-white/5 bg-zinc-900/50 pt-2",children:g&&(0,r.jsxs)(r.Fragment,{children:[(0,r.jsxs)("span",{className:"text-xs text-zinc-500",children:["網格數: ",d]}),(0,r.jsx)("input",{type:"range",min:"20",max:"80",step:"5",value:d,onChange:e=>g(Number(e.target.value)),className:"w-24 accent-violet-500 cursor-pointer",title:"調整網格數量 (同時調整元件顯示大小)"})]})}),(0,r.jsx)("div",{ref:Z,className:"flex-1 overflow-hidden bg-zinc-950/80 rounded-lg border border-white/10 relative max-h-[600px]",children:(0,r.jsx)("div",{className:"flex justify-center items-center min-w-full min-h-full p-10",onMouseDown:H,onMouseMove:ee,onMouseUp:et,onMouseLeave:en,children:(0,r.jsxs)("div",{ref:E,className:"relative bg-zinc-900 border border-zinc-700 shadow-2xl transition-all duration-300",style:{width:(Number(d)||30)*B,height:(Number(d)||30)*B,backgroundSize:`${B}px ${B}px`,backgroundImage:`
                                linear-gradient(to right, rgba(255, 255, 255, 0.05) 1px, transparent 1px),
                                linear-gradient(to bottom, rgba(255, 255, 255, 0.05) 1px, transparent 1px)
                            `},onDragOver:e=>e.preventDefault(),onDrop:G,children:[C&&(0,r.jsxs)("svg",{className:"absolute inset-0 pointer-events-none z-50 overflow-visible",children:[(0,r.jsx)("line",{x1:C.lineStart.x,y1:C.lineStart.y,x2:C.lineEnd.x,y2:C.lineEnd.y,stroke:"#ec4899",strokeWidth:"2",strokeDasharray:"4",className:"animate-pulse"}),(0,r.jsx)("circle",{cx:C.lineStart.x,cy:C.lineStart.y,r:"4",fill:"#ec4899"}),(0,r.jsx)("text",{x:(C.lineStart.x+C.lineEnd.x)/2,y:(C.lineStart.y+C.lineEnd.y)/2-10,fill:"#ec4899",fontSize:"12",fontWeight:"bold",textAnchor:"middle",className:"drop-shadow-md",style:{textShadow:"0 1px 2px rgba(0,0,0,0.8)"},children:C.direction})]}),(0,r.jsxs)("div",{className:"absolute inset-0 pointer-events-none opacity-20",children:[Array.from({length:(Number(d)||30)+1}).map((e,t)=>(0,r.jsx)("div",{className:"absolute top-0 bottom-0 border-l border-white/10",style:{left:t*B}},`v-${t}`)),Array.from({length:(Number(d)||30)+1}).map((e,t)=>(0,r.jsx)("div",{className:"absolute left-0 right-0 border-t border-white/10",style:{top:t*B}},`h-${t}`))]}),L&&(0,r.jsx)("div",{className:"absolute bg-cyan-500/10 border border-cyan-400/50 pointer-events-none z-50",style:{left:Math.min(L.start.x,L.end.x),top:Math.min(L.start.y,L.end.y),width:Math.abs(L.end.x-L.start.x),height:Math.abs(L.end.y-L.start.y)}}),M&&v&&(0,r.jsx)("div",{className:"absolute bg-white/10 border border-white/30 z-40 transition-all duration-75",style:{left:M.col*B,top:M.row*B,width:("unit"===w?_:t?.find(e=>e.id===v)?.width||1)*B,height:("unit"===w?_:t?.find(e=>e.id===v)?.height||1)*B}}),(0,r.jsx)(c.N,{children:t?.map(e=>(0,r.jsx)(T,{tile:e,cellSize:B,isSelected:!1,onMouseDown:t=>Y(e.id,"env",t),onResizeStart:(t,n)=>X(e.id,t),onRemove:m?void 0:()=>{p&&t&&p(t.filter(t=>t.id!==e.id))}},e.id))}),(0,r.jsx)(c.N,{children:e.map(e=>{let t=n?.find(t=>t.unitType===e.unitType);return(0,r.jsx)(F,{position:e,result:t,isSelected:l.includes(e.unitType),isDragging:v===e.unitType,cellSize:B,compassDirection:s,onClick:t=>f(e.unitType,t),onDragStart:(e,t)=>Y(e,"unit",t),showBadges:b,shape:y},e.unitType)})})]})})})]})}function $({comparison:e,onClose:t}){return(0,r.jsxs)(s.P.div,{initial:{opacity:0,y:20},animate:{opacity:1,y:0},exit:{opacity:0,y:20},className:"bg-zinc-900/70 border border-cyan-500/30 rounded-xl p-4 mb-4 backdrop-blur-sm",children:[(0,r.jsxs)("div",{className:"flex items-center justify-between mb-3",children:[(0,r.jsxs)("div",{className:"flex items-center gap-2",children:[(0,r.jsx)(p.A,{className:"w-4 h-4 text-cyan-400"}),(0,r.jsx)("h4",{className:"text-sm font-bold text-zinc-100",children:"戶型比對"})]}),(0,r.jsx)("button",{onClick:t,className:"w-6 h-6 rounded hover:bg-white/10 flex items-center justify-center transition",children:(0,r.jsx)(d.A,{className:"w-4 h-4 text-zinc-400"})})]}),(0,r.jsxs)("div",{className:"grid grid-cols-2 gap-4",children:[(0,r.jsxs)("div",{className:"bg-black/30 rounded-lg p-3 border border-white/5",children:[(0,r.jsx)("div",{className:"text-lg font-bold text-cyan-400 mb-2",children:e.unitType1}),(0,r.jsxs)("div",{className:"space-y-1 text-xs",children:[(0,r.jsxs)("div",{className:"flex justify-between",children:[(0,r.jsx)("span",{className:"text-zinc-500",children:"平均單價"}),(0,r.jsx)("span",{className:"text-zinc-200 font-mono",children:e.stats1.avgPrice.toFixed(2)})]}),(0,r.jsxs)("div",{className:"flex justify-between",children:[(0,r.jsx)("span",{className:"text-zinc-500",children:"最低價"}),(0,r.jsx)("span",{className:"text-zinc-200 font-mono",children:e.stats1.minPrice.toFixed(2)})]}),(0,r.jsxs)("div",{className:"flex justify-between",children:[(0,r.jsx)("span",{className:"text-zinc-500",children:"最高價"}),(0,r.jsx)("span",{className:"text-zinc-200 font-mono",children:e.stats1.maxPrice.toFixed(2)})]}),(0,r.jsxs)("div",{className:"flex justify-between",children:[(0,r.jsx)("span",{className:"text-zinc-500",children:"中位數"}),(0,r.jsx)("span",{className:"text-zinc-200 font-mono",children:e.stats1.medianPrice.toFixed(2)})]}),(0,r.jsxs)("div",{className:"flex justify-between",children:[(0,r.jsx)("span",{className:"text-zinc-500",children:"樣本數"}),(0,r.jsxs)("span",{className:"text-zinc-200",children:[e.stats1.count," 筆"]})]})]})]}),(0,r.jsxs)("div",{className:"bg-black/30 rounded-lg p-3 border border-white/5",children:[(0,r.jsx)("div",{className:"text-lg font-bold text-violet-400 mb-2",children:e.unitType2}),(0,r.jsxs)("div",{className:"space-y-1 text-xs",children:[(0,r.jsxs)("div",{className:"flex justify-between",children:[(0,r.jsx)("span",{className:"text-zinc-500",children:"平均單價"}),(0,r.jsx)("span",{className:"text-zinc-200 font-mono",children:e.stats2.avgPrice.toFixed(2)})]}),(0,r.jsxs)("div",{className:"flex justify-between",children:[(0,r.jsx)("span",{className:"text-zinc-500",children:"最低價"}),(0,r.jsx)("span",{className:"text-zinc-200 font-mono",children:e.stats2.minPrice.toFixed(2)})]}),(0,r.jsxs)("div",{className:"flex justify-between",children:[(0,r.jsx)("span",{className:"text-zinc-500",children:"最高價"}),(0,r.jsx)("span",{className:"text-zinc-200 font-mono",children:e.stats2.maxPrice.toFixed(2)})]}),(0,r.jsxs)("div",{className:"flex justify-between",children:[(0,r.jsx)("span",{className:"text-zinc-500",children:"中位數"}),(0,r.jsx)("span",{className:"text-zinc-200 font-mono",children:e.stats2.medianPrice.toFixed(2)})]}),(0,r.jsxs)("div",{className:"flex justify-between",children:[(0,r.jsx)("span",{className:"text-zinc-500",children:"樣本數"}),(0,r.jsxs)("span",{className:"text-zinc-200",children:[e.stats2.count," 筆"]})]})]})]})]}),(0,r.jsx)("div",{className:"mt-3 bg-gradient-to-r from-cyan-500/10 to-violet-500/10 rounded-lg p-3 border border-white/10",children:(0,r.jsxs)("div",{className:"flex items-center justify-between",children:[(0,r.jsx)("span",{className:"text-sm text-zinc-400",children:"價差"}),(0,r.jsxs)("div",{className:"flex items-center gap-2",children:[e.priceDiff>0?(0,r.jsx)(f.A,{className:"w-4 h-4 text-green-400"}):e.priceDiff<0?(0,r.jsx)(x.A,{className:"w-4 h-4 text-red-400"}):(0,r.jsx)(h.A,{className:"w-4 h-4 text-zinc-400"}),(0,r.jsxs)("span",{className:`text-lg font-bold font-mono ${e.priceDiff>0?"text-green-400":e.priceDiff<0?"text-red-400":"text-zinc-400"}`,children:[e.priceDiff>0?"+":"",e.priceDiff.toFixed(2)," 萬/坪"]}),(0,r.jsxs)("span",{className:"text-sm text-zinc-500",children:["(",e.diffPercent>0?"+":"",e.diffPercent.toFixed(1),"%)"]})]})]})})]})}function D({transactions:e,project:t,configOnly:n=!1,title:d,storageScope:p,initialStep:f="analyze",onConfigChange:x,mode:h="report"}){let[F,T]=(0,i.useState)(n?"config":f||"config"),[C,D]=(0,i.useState)([]),[P,I]=(0,i.useState)(null),[E,Z]=(0,i.useState)([]),[R,W]=(0,i.useState)("per-floor"),[U,B]=(0,i.useState)(null),[O,q]=(0,i.useState)(null),[Y,X]=(0,i.useState)(null),J=i.useRef(null);i.useRef(!1);let K=p||l.Ze,V=(0,i.useMemo)(()=>(0,a.RS)(e),[e]),{role:G}=(0,o.h)(),L="admin"===G||"super_admin"===G,[Q,H]=(0,i.useState)(!1),[ee,et]=(0,i.useState)(!1),[en,er]=(0,i.useState)(!1);(0,i.useEffect)(()=>{(async()=>{if(!t)return;let n=await (0,l.ew)(t),r=(0,l.oP)(t,K),i=[],o=null,s=!1,c=!1;if(r&&Array.isArray(r.configurations)&&r.configurations.length>0)n&&JSON.stringify(r.configurations)===JSON.stringify(n.configurations)?(i=n.configurations,o=n.activeConfigId||r.activeConfigId||null,s=!0,c=!1,(0,l.a2)(t,K)):(i=r.configurations,o=r.activeConfigId||null,s=!1,c=!0);else if(n&&Array.isArray(n.configurations)&&n.configurations.length>0)i=n.configurations,o=n.activeConfigId||null,s=!0,c=!1;else{if(e.length>0&&V.length>0){let t=(0,a.ik)(e,"預設配置（全部樓層）");i=[t],o=t.id}s=!1,c=!1}D(i),I(o||i[0]?.id||null),H(s),et(c),x&&x({configurations:i,activeConfigId:o})})()},[t,K,e,V]),(0,i.useEffect)(()=>{t&&(C.length>0?(0,l.NG)(t,{configurations:C,activeConfigId:P},K):(0,l.a2)(t,K),x&&x({configurations:C,activeConfigId:P}))},[t,C,P,K]),(0,i.useEffect)(()=>{V.length>0&&null===U&&B(V[0])},[V,U]);let ei=C.find(e=>e.id===P),ea=(0,i.useMemo)(()=>ei?ei.positions.map(e=>M(e,36)):[],[ei]),el=(0,i.useMemo)(()=>{if(!ei||"analyze"!==F)return[];let t=ei.positions;return"vertical-avg"===R?(0,a.AT)(e,ei.floorRange.start,ei.floorRange.end,t):null!==U?(0,a.p3)(e,U,t):[]},[e,ei,F,R,U]),eo=e=>{if(!ei)return;let t=e.map(e=>({unitType:e.unitType,x:e.col,y:e.row,facing:e.facing,roadFacing:e.roadFacing,roadFacingDirection:e.roadFacingDirection,adjacentToUnits:e.adjacentToUnits,facingOpenSpace:e.facingOpenSpace,openSpaceType:e.openSpaceType,openSpaceFacingDirection:e.openSpaceFacingDirection,openSpaceFacingDirections:e.openSpaceFacingDirections,roadFacingDirections:e.roadFacingDirections})),n=(0,a.Qy)(t,ei.envTiles||[],ei.compassDirection||0,1);D(C.map(e=>e.id===P?{...e,positions:n}:e)),H(!1),et(!0)},es=e=>{if(!ei)return;let t=function(e,t,n){if(0===e.length)return{positions:e,envTiles:t||[]};let r=Math.min(...e.map(e=>e.x)),i=Math.max(...e.map(e=>e.x+_)),a=Math.min(...e.map(e=>e.y)),l=Math.max(...e.map(e=>e.y+_)),o=Math.round(n/2-(r+i)/2),s=Math.round(n/2-(a+l)/2),c=e.map(e=>({...e,x:e.x+o,y:e.y+s})),d=(t||[]).map(e=>({...e,x:e.x+o,y:e.y+s})),u=[...c.map(e=>({start:e.x,end:e.x+_})),...d.map(e=>({start:e.x,end:e.x+e.width}))],p=[...c.map(e=>({start:e.y,end:e.y+_})),...d.map(e=>({start:e.y,end:e.y+e.height}))],f=Math.min(...u.map(e=>e.start)),x=Math.max(...u.map(e=>e.end)),h=Math.min(...p.map(e=>e.start)),g=Math.max(...p.map(e=>e.end)),m=0,b=0;return f<0?m=-f:x>n&&(m=n-x),h<0?b=-h:g>n&&(b=n-g),(0!==m||0!==b)&&(c=c.map(e=>({...e,x:e.x+m,y:e.y+b})),d=d.map(e=>({...e,x:e.x+m,y:e.y+b}))),{positions:c,envTiles:d}}(ei.positions,ei.envTiles,e);D(C.map(n=>n.id===P?{...n,gridSize:e,positions:t.positions,envTiles:t.envTiles}:n)),H(!1),et(!0)},ec=async()=>{if(!L||!confirm("確定要發布目前的配置為「官方配置」嗎？這將會覆蓋所有使用者的預設配置。"))return;er(!0);let e=await (0,l.Z5)(t,{configurations:C,activeConfigId:P});er(!1),e.success?(alert("發布成功！"),H(!0),et(!1),(0,l.a2)(t,K)):alert(`發布失敗：${e.error}`)},ed=async()=>{console.log("Reset requested. Mode:",h,"Draft exists:",ee);let n="admin"===h;if(confirm(n?"確定要重置為「預設配置」嗎？這將清除目前的配置並重新生成預設值。":"確定要放棄本地修改，重置為「官方配置」嗎？您目前的本地修改將會遺失。")){console.log("Reset confirmed. Mode:",n?"Factory":"Official");try{if(n){let t=(0,a.ik)(e,"預設配置（全部樓層）");D([t]),I(t.id),H(!1),et(!0)}else{(0,l.a2)(t,K);let n=await (0,l.ew)(t);if(console.log("Fetched official config:",n),n&&n.configurations.length>0)D(n.configurations),I(n.activeConfigId||(n.configurations.length>0?n.configurations[0].id:null)),H(!0),et(!1);else{console.log("No official config found, falling back to default.");let t=(0,a.ik)(e,"預設配置（全部樓層）");D([t]),I(t.id),H(!1),et(!1)}}}catch(e){console.error("Error during reset:",e),alert("重置失敗，請查看控制台日誌。")}}};return 0===e.length?null:(0,r.jsxs)("div",{ref:J,className:"bg-zinc-900/50 border border-white/10 rounded-xl p-4 mb-6",children:[(0,r.jsxs)("div",{className:"flex items-center gap-2 mb-4",children:[(0,r.jsx)(g.A,{className:"w-4 h-4 text-violet-400"}),(0,r.jsx)("h3",{className:"text-sm font-bold text-zinc-100",children:d||"水平價差分析"}),L&&(0,r.jsxs)("div",{className:"ml-auto flex items-center gap-2",children:[ee?(0,r.jsx)("span",{className:"text-[10px] bg-amber-500/20 text-amber-400 px-2 py-0.5 rounded border border-amber-500/30 animate-pulse",children:"admin"===h?"請重新配置戶型配置":"本地草稿 (未發布)"}):Q&&!ee?(0,r.jsx)("span",{className:"text-[10px] bg-emerald-500/20 text-emerald-400 px-2 py-0.5 rounded border border-emerald-500/30",children:"admin"===h?"官方配置完成":"已同步官方配置"}):null,(0,r.jsxs)("div",{className:"flex bg-zinc-950 p-1 rounded-lg border border-white/10 ml-2",children:["admin"===h&&(0,r.jsxs)("button",{onClick:ec,disabled:!ee||en,className:`
                                        flex items-center gap-1 px-3 py-1.5 rounded-md text-xs font-medium transition-all
                                        ${ee?"bg-emerald-600 text-white hover:bg-emerald-500 shadow-lg shadow-emerald-500/20":"bg-zinc-800 text-zinc-500 cursor-not-allowed"}
                                    `,title:"將目前配置發布為官方版本",children:[en?(0,r.jsx)(m.A,{className:"w-3.5 h-3.5 animate-spin"}):(0,r.jsx)(b.A,{className:"w-3.5 h-3.5"}),en?"發布中...":"發布配置"]}),(0,r.jsxs)("button",{onClick:ed,className:"flex items-center gap-1 px-3 py-1.5 rounded-md text-xs font-medium text-zinc-400 hover:text-white hover:bg-zinc-800 transition-all",title:"admin"===h?"重置為預設配置 (Factory Reset)":"重置為官方配置 (Discard Changes)",children:[(0,r.jsx)(m.A,{className:"w-3.5 h-3.5"}),"重置"]})]})]}),!n&&!L&&(0,r.jsxs)("div",{className:"ml-auto flex items-center gap-1 text-xs",children:[(0,r.jsx)("button",{onClick:()=>T("config"),className:`px-3 py-1.5 rounded transition-all ${"config"===F?"bg-violet-500 text-white":"text-zinc-400 hover:text-zinc-200"}`,children:"樓層配置"}),(0,r.jsx)("button",{onClick:()=>C.length>0&&T("analyze"),disabled:0===C.length,className:`px-3 py-1.5 rounded transition-all ${"analyze"===F?"bg-violet-500 text-white":"text-zinc-400 hover:text-zinc-200 disabled:opacity-30"}`,children:"分析"})]})]}),"config"===F&&(0,r.jsx)(s.P.div,{initial:{opacity:0},animate:{opacity:1},children:(0,r.jsxs)("div",{className:"bg-black/40 rounded-lg border border-white/5 p-3 mb-3 flex items-center gap-2 text-sm text-zinc-400",children:[en?(0,r.jsx)("span",{className:"animate-spin",children:"⏳"}):Q?(0,r.jsx)(y.A,{className:"w-4 h-4 text-green-500"}):(0,r.jsx)(b.A,{className:"w-4 h-4"}),(0,r.jsx)("span",{children:Q?"已發布":"儲存"})]})},"config-list"),(0,r.jsxs)("div",{className:"flex-1 relative overflow-hidden flex",children:[(0,r.jsxs)("div",{className:"w-64 border-r border-zinc-800 bg-zinc-900/30 flex flex-col",children:[(0,r.jsxs)("div",{className:"p-3 border-b border-zinc-800 flex items-center justify-between",children:[(0,r.jsx)("span",{className:"text-xs font-bold text-zinc-500 uppercase tracking-wider",children:"樓層配置方案"}),(0,r.jsxs)("button",{onClick:()=>{let e=window.location.hostname.includes("github.io");window.open(`${e?"/trb":""}/admin/projects?openConfig=${encodeURIComponent(t)}`,"_blank")},className:"px-3 py-1.5 bg-indigo-500/10 hover:bg-indigo-500/20 text-indigo-400 text-xs font-bold rounded-lg border border-indigo-500/20 transition-colors flex items-center gap-1.5",title:"開啟管理後台進行配置",children:[(0,r.jsx)(v.A,{className:"w-3.5 h-3.5"}),"管理"]})]}),(0,r.jsx)("div",{className:"flex-1 overflow-y-auto p-2 space-y-2 custom-scrollbar",children:C.map(e=>(0,r.jsxs)("div",{onClick:()=>I(e.id),className:`
                                    group flex flex-col gap-1 p-3 rounded-lg border cursor-pointer transition-all
                                    ${P===e.id?"bg-cyan-950/30 border-cyan-500/50 shadow-md":"bg-zinc-900/50 border-zinc-800 hover:border-zinc-700 hover:bg-zinc-800/50"}
                                `,children:[(0,r.jsxs)("div",{className:"flex items-center justify-between",children:[Y?.id===e.id?(0,r.jsxs)("div",{className:"flex flex-col gap-2 w-full bg-black/50 p-2 rounded border border-cyan-500/50",onClick:e=>e.stopPropagation(),children:[(0,r.jsx)("input",{type:"text",defaultValue:e.name,placeholder:"配置名稱",autoFocus:!0,className:"bg-zinc-900 text-white text-xs px-2 py-1 rounded border border-zinc-700 w-full focus:border-cyan-500",onKeyDown:e=>{if("Enter"===e.key){let t=e.currentTarget,n=t.parentElement;if(!n)return;let r=n.querySelector('input[name="startFloor"]'),i=n.querySelector('input[name="endFloor"]');t.value;let a=parseInt(r.value),l=parseInt(i.value);isNaN(a)||isNaN(l)}}}),(0,r.jsxs)("div",{className:"flex items-center gap-2",children:[(0,r.jsxs)("div",{className:"flex items-center gap-1 flex-1",children:[(0,r.jsx)("span",{className:"text-[10px] text-zinc-500",children:"起始"}),(0,r.jsx)("input",{type:"number",name:"startFloor",defaultValue:e.floorRange.start,className:"bg-zinc-900 text-white text-xs px-1 py-1 rounded border border-zinc-700 w-full focus:border-cyan-500"})]}),(0,r.jsx)("span",{className:"text-zinc-600",children:"-"}),(0,r.jsxs)("div",{className:"flex items-center gap-1 flex-1",children:[(0,r.jsx)("span",{className:"text-[10px] text-zinc-500",children:"結束"}),(0,r.jsx)("input",{type:"number",name:"endFloor",defaultValue:e.floorRange.end,className:"bg-zinc-900 text-white text-xs px-1 py-1 rounded border border-zinc-700 w-full focus:border-cyan-500"})]})]}),(0,r.jsxs)("div",{className:"flex justify-end gap-2 mt-1",children:[(0,r.jsx)("button",{className:"px-2 py-0.5 text-[10px] bg-red-900/30 text-red-400 rounded hover:bg-red-900/50",onClick:()=>X(null),children:"取消"}),(0,r.jsx)("button",{className:"px-2 py-0.5 text-[10px] bg-cyan-600 text-white rounded hover:bg-cyan-500",onClick:t=>{let n=t.currentTarget.parentElement?.parentElement;if(!n)return;let r=n.querySelector('input[type="text"]'),i=n.querySelector('input[name="startFloor"]'),a=n.querySelector('input[name="endFloor"]'),l=r.value,o=parseInt(i.value),s=parseInt(a.value);if(l&&!isNaN(o)&&!isNaN(s)){if(o>s)return void alert("起始樓層不能大於結束樓層");D(t=>t.map(t=>t.id===e.id?{...t,name:l,floorRange:{start:o,end:s}}:t)),H(!1),et(!0),X(null)}},children:"確認"})]})]}):(0,r.jsx)("span",{className:`text-sm font-medium ${P===e.id?"text-cyan-100":"text-zinc-400"}`,children:e.name}),(0,r.jsxs)("div",{className:"opacity-0 group-hover:opacity-100 transition-opacity flex gap-1",children:[(0,r.jsx)("button",{onClick:t=>{t.stopPropagation(),X({id:e.id,name:e.name,range:{start:e.floorRange.start.toString(),end:e.floorRange.end.toString()}})},className:"p-1 hover:bg-zinc-700 rounded text-zinc-500 hover:text-white",children:(0,r.jsx)(j.A,{className:"w-3 h-3"})}),(0,r.jsx)("button",{onClick:t=>{var n;let r;t.stopPropagation(),n=e.id,(r=C.find(e=>e.id===n))&&(D([...C,{...r,id:(0,a.L1)(),name:`${r.name} (複製)`,positions:r.positions.map(e=>({...e}))}]),H(!1),et(!0))},className:"p-1 hover:bg-zinc-700 rounded text-zinc-500 hover:text-white",children:(0,r.jsx)(w.A,{className:"w-3 h-3"})}),(0,r.jsx)("button",{onClick:t=>{t.stopPropagation(),(e=>{if(C.length<=1)return;let t=C.filter(t=>t.id!==e);D(t),P===e&&I(t[0]?.id||null),H(!1),et(!0)})(e.id)},className:"p-1 hover:bg-red-900/30 rounded text-zinc-500 hover:text-red-400",children:(0,r.jsx)(N.A,{className:"w-3 h-3"})})]})]}),(0,r.jsxs)("div",{className:"text-xs text-zinc-600 flex items-center gap-1",children:[(0,r.jsx)(u.A,{className:"w-3 h-3"}),e.floorRange.start,"F - ",e.floorRange.end,"F"]})]},e.id))})]}),(0,r.jsx)("div",{className:"flex-1 relative flex flex-col bg-zinc-950/50",children:"config"===F?ei?(0,r.jsxs)("div",{className:"flex items-start h-full p-4 gap-4",children:[(0,r.jsxs)("div",{className:"flex-1 bg-black/40 rounded-lg border border-white/5 p-4 h-full flex flex-col relative overflow-hidden",children:[(0,r.jsx)("div",{className:"flex items-center justify-between mb-3 absolute top-4 left-4 right-4 z-10 pointer-events-none",children:(0,r.jsxs)("div",{className:"text-xs text-zinc-400 flex items-center gap-2 pointer-events-auto bg-black/50 px-2 py-1 rounded backdrop-blur-sm",children:[(0,r.jsx)(z.A,{className:"w-3 h-3"}),ei.name]})}),(0,r.jsx)(k,{positions:ea,envTiles:ei.envTiles,results:[],selectedUnits:E,zoom:1,compassDirection:ei.compassDirection||0,gridSize:ei.gridSize||30,unitShape:"square",onZoomChange:()=>{},onPositionsChange:eo,onEnvTilesChange:e=>{if(!ei)return;let t=(0,a.Qy)(ei.positions,e,ei.compassDirection||0,1);D(C.map(n=>n.id===P?{...n,envTiles:e,positions:t}:n)),H(!1),et(!0)},onUnitClick:(e,t)=>{t?Z(t=>t.includes(e)?t.filter(t=>t!==e):[...t,e]):Z(t=>t.includes(e)&&1===t.length?[]:[e])},onCompassChange:e=>{if(!ei)return;let t=(0,a.Qy)(ei.positions,ei.envTiles||[],e,1);D(C.map(n=>n.id===P?{...n,compassDirection:e,positions:t}:n)),H(!1),et(!0)},onGridSizeChange:es})]}),(0,r.jsx)("div",{className:"w-[280px]",children:(0,r.jsx)(A,{selectedUnits:E,positions:ea,compassDirection:ei.compassDirection||0,onBatchUpdate:e=>{P&&(D(t=>t.map(t=>{if(t.id!==P)return t;let n=t.positions.map(t=>E.includes(t.unitType)?{...t,...e}:t);return{...t,positions:n}})),H(!1),et(!0))},onClear:()=>Z([])})})]}):(0,r.jsx)("div",{className:"flex items-center justify-center h-full text-zinc-500",children:"請選擇或新增配置"}):(0,r.jsxs)(s.P.div,{initial:{opacity:0},animate:{opacity:1},className:"flex flex-col h-full p-4",children:[(0,r.jsxs)("div",{className:"flex items-center mb-4",children:[(0,r.jsx)("button",{onClick:()=>{W("per-floor"),Z([]),q(null)},className:`px-3 py-1.5 text-xs rounded-lg transition-all ${"per-floor"===R?"bg-violet-500 text-white":"bg-zinc-700 text-zinc-400 hover:bg-zinc-600"}`,children:"當層比較"}),(0,r.jsx)("button",{onClick:()=>{W("vertical-avg"),Z([]),q(null)},className:`px-3 py-1.5 text-xs rounded-lg transition-all ${"vertical-avg"===R?"bg-violet-500 text-white":"bg-zinc-700 text-zinc-400 hover:bg-zinc-600"}`,children:"垂直平均比較"})]}),"per-floor"===R&&(0,r.jsxs)("div",{className:"ml-4 flex items-center gap-2 mb-4",children:[(0,r.jsx)("span",{className:"text-sm text-zinc-400",children:"樓層："}),(0,r.jsx)("select",{value:U||"",onChange:e=>{B(Number(e.target.value)),Z([]),q(null)},className:"bg-zinc-700 border border-white/10 text-zinc-200 text-sm rounded px-2 py-1",children:V.filter(e=>!ei||e>=ei.floorRange.start&&e<=ei.floorRange.end).map(e=>(0,r.jsx)("option",{value:e,children:e>0?`${e}F`:`B${Math.abs(e)}F`},e))})]}),"vertical-avg"===R&&ei&&(0,r.jsxs)("div",{className:"ml-4 text-xs text-zinc-500 mb-4",children:["分析範圍：",ei.floorRange.start,"F ~ ",ei.floorRange.end,"F"]}),(0,r.jsxs)("div",{className:"flex-1 bg-black/40 rounded-lg border border-white/5 p-4 min-h-0 relative",children:[ei&&(0,r.jsx)(k,{positions:ea,envTiles:ei.envTiles,results:el,selectedUnits:E,zoom:1,gridSize:ei.gridSize||30,unitShape:"square",onPositionsChange:eo,onUnitClick:(e,t)=>{if("per-floor"===R&&null===U)return;let n=[...E];if(n.includes(e)?n=n.filter(t=>t!==e):(n.length>=2&&n.shift(),n.push(e)),Z(n),2===n.length){let e=n[0],t=n[1],r=el.find(t=>t.unitType===e),i=el.find(e=>e.unitType===t);r&&i&&q({unitType1:e,unitType2:t,priceDiff:r.avgPrice-i.avgPrice,diffPercent:(r.avgPrice-i.avgPrice)/i.avgPrice*100,stats1:r,stats2:i,transactions1:r.transactions,transactions2:i.transactions})}else q(null)},onZoomChange:e=>{},onGridSizeChange:es,isAnalyzeMode:!0}),(0,r.jsxs)("div",{className:"absolute top-4 right-4 bg-black/80 px-3 py-1.5 rounded-full text-[10px] text-zinc-400 border border-white/10 flex items-center gap-2 pointer-events-none",children:[(0,r.jsx)(S.A,{className:"w-3 h-3 text-cyan-400"}),(0,r.jsx)("span",{children:"點擊兩個戶型進行比對"})]})]}),(0,r.jsx)(c.N,{children:O&&(0,r.jsx)("div",{className:"mt-4",children:(0,r.jsx)($,{comparison:O,onClose:()=>{q(null),Z([])}})})}),el.length>0&&!O&&(0,r.jsx)("div",{className:"mt-4 grid grid-cols-2 md:grid-cols-3 lg:grid-cols-4 xl:grid-cols-5 gap-2 overflow-y-auto max-h-[200px] custom-scrollbar",children:el.map(e=>(0,r.jsxs)("div",{className:`
                                            bg-zinc-800/50 border rounded-lg p-2 transition-all cursor-pointer
                                            ${E.includes(e.unitType)?"border-cyan-400 bg-cyan-500/10":"border-white/10 hover:border-white/20"}
                                        `,onClick:()=>{let t=[...E];if(t.includes(e.unitType)?t=t.filter(t=>t!==e.unitType):(t.length>=2&&t.shift(),t.push(e.unitType)),Z(t),2===t.length){let e=t[0],n=t[1],r=el.find(t=>t.unitType===e),i=el.find(e=>e.unitType===n);r&&i&&q({unitType1:e,unitType2:n,priceDiff:r.avgPrice-i.avgPrice,diffPercent:(r.avgPrice-i.avgPrice)/i.avgPrice*100,stats1:r,stats2:i,transactions1:r.transactions,transactions2:i.transactions})}else q(null)},children:[(0,r.jsxs)("div",{className:"flex items-center justify-between mb-1",children:[(0,r.jsx)("div",{className:"text-sm font-bold text-zinc-100",children:e.unitType}),"floorCount"in e&&(0,r.jsxs)("div",{className:"text-[10px] text-zinc-500",children:[e.floorCount," 層"]})]}),(0,r.jsx)("div",{className:"text-xs space-y-0.5",children:(0,r.jsxs)("div",{className:"flex justify-between",children:[(0,r.jsx)("span",{className:"text-zinc-500",children:"均價"}),(0,r.jsx)("span",{className:"text-cyan-400 font-mono",children:e.avgPrice.toFixed(1)})]})})]},e.unitType))})]})})]})]})}},32745:(e,t,n)=>{n.d(t,{AT:()=>u,Fd:()=>c,L1:()=>f,Qy:()=>m,RS:()=>a,Ul:()=>g,ZU:()=>p,ik:()=>x,l3:()=>h,p3:()=>s});var r=n(89579);function i(e){let t=(e["移轉層次"]||"").match(/^([+-]?\d+)/);return t?parseInt(t[1],10):0}function a(e){let t=new Set;return e.forEach(e=>{let n=i(e);0!==n&&t.add(n)}),Array.from(t).sort((e,t)=>e-t)}function l(e,t){let n=e.reduce((e,t)=>e+(t["單價元平方公尺"]||0),0)/e.length,r=e.map(e=>e["單價元平方公尺"]||0).sort((e,t)=>e-t),i=r.length%2==0?(r[r.length/2-1]+r[r.length/2])/2:r[Math.floor(r.length/2)];return{unitType:t,avgPrice:n,minPrice:Math.min(...r),maxPrice:Math.max(...r),medianPrice:i,count:e.length,transactions:e}}function o(e){let t=new r.B$(e),n=new Map;return e.forEach(e=>{if(!e)return;let r=t.resolve(e);r&&(n.has(r)||n.set(r,[]),n.get(r).push(e))}),n}function s(e,t,n){let r=e.filter(e=>i(e)===t);if(0===r.length)return[];let a=o(r),s=[];return n.forEach(e=>{let r=a.get(e.unitType)||[];if(0===r.length)return;let i=l(r,e.unitType),o=[];n.forEach(t=>{if(t.unitType===e.unitType)return;let n=a.get(t.unitType)||[];if(0===n.length)return;let r=l(n,t.unitType),s=i.avgPrice-r.avgPrice,c=r.avgPrice>0?s/r.avgPrice*100:0;o.push({compareWith:t.unitType,diff:s,diffPercent:c})}),s.push({...i,floor:t,priceDiffs:o,position:e})}),s}function c(e,t,n,r){let a=o(e.filter(e=>i(e)===t)),s=a.get(n)||[],c=a.get(r)||[];if(0===s.length||0===c.length)return null;let d=l(s,n),u=l(c,r),p=d.avgPrice-u.avgPrice,f=u.avgPrice>0?p/u.avgPrice*100:0;return{unitType1:n,unitType2:r,stats1:d,stats2:u,priceDiff:p,diffPercent:f,transactions1:s,transactions2:c}}function d(e,t,n){return e.filter(e=>{let r=i(e);return r>=t&&r<=n})}function u(e,t,n,a){let s=d(e,t,n);if(0===s.length)return[];let c=o(s),u=new r.B$(s),p=new Map;s.forEach(e=>{let t=u.resolve(e);t&&(p.has(t)||p.set(t,new Set),p.get(t).add(i(e)))});let f=[];return a.forEach(e=>{let r=c.get(e.unitType)||[];if(0===r.length)return;let i=l(r,e.unitType),o=p.get(e.unitType)||new Set,s=[];a.forEach(t=>{if(t.unitType===e.unitType)return;let n=c.get(t.unitType)||[];if(0===n.length)return;let r=l(n,t.unitType),a=i.avgPrice-r.avgPrice,o=r.avgPrice>0?a/r.avgPrice*100:0;s.push({compareWith:t.unitType,diff:a,diffPercent:o})}),f.push({...i,floorRange:{start:t,end:n},floorCount:o.size,priceDiffs:s,position:e})}),f}function p(e,t,n,r,i){let a=o(d(e,t,n)),s=a.get(r)||[],c=a.get(i)||[];if(0===s.length||0===c.length)return null;let u=l(s,r),p=l(c,i),f=u.avgPrice-p.avgPrice,x=p.avgPrice>0?f/p.avgPrice*100:0;return{unitType1:r,unitType2:i,stats1:u,stats2:p,priceDiff:f,diffPercent:x,transactions1:s,transactions2:c}}function f(){return Math.random().toString(36).substring(2,9)}function x(e,t="預設配置",n){let i=a(e),l=n||(i.length>0?{start:Math.min(...i),end:Math.max(...i)}:{start:1,end:1}),o=function(e){if(0===e.length)return[];let t=new r.B$(e),n=new Set;e.forEach(e=>{let r=t.resolve(e);r&&n.add(r)});let i=Array.from(n),a=Math.ceil(Math.sqrt(i.length)),l=Math.ceil(i.length/a),o=Math.floor((30-(4*a-1))/2),s=Math.floor((30-(4*l-1))/2);return i.map((e,t)=>{let n=Math.floor(t/a);return{unitType:e,x:o+t%a*4,y:s+4*n,facing:"",roadFacing:!1,roadFacingDirection:"",adjacentToUnits:!1,facingOpenSpace:!1,openSpaceType:"",openSpaceFacingDirection:""}})}(e);return{id:f(),name:t,floorRange:l,positions:o,envTiles:[],zoom:1,compassDirection:0,gridSize:30}}function h(e,t,n){return t.some(t=>(!n||t.id!==n)&&!(e.end<t.floorRange.start||e.start>t.floorRange.end))}function g(e,t,n){let r,i=e.x,a=e.x+e.width,l=e.y,o=e.y+e.height,s=t.x,c=t.x+t.width,d=t.y,u=t.y+t.height,p=Math.max(0,Math.min(a,c)-Math.max(i,s)),f=Math.max(0,Math.min(o,u)-Math.max(l,d));if(p>f){let n=l+e.height/2;r=d+t.height/2<n?"up":"down"}else if(f>p){let n=i+e.width/2;r=s+t.width/2<n?"left":"right"}else{let n=i+e.width/2,a=l+e.height/2,o=s+t.width/2,c=d+t.height/2,u=o-n,p=c-a;r=Math.abs(u)>=Math.abs(p)?u>0?"right":"left":p>0?"down":"up"}return({0:{up:"N",down:"S",left:"W",right:"E"},90:{up:"E",down:"W",left:"N",right:"S"},180:{up:"S",down:"N",left:"E",right:"W"},270:{up:"W",down:"E",left:"S",right:"N"}})[n][r]}function m(e,t,n=0,r=1){if(!e||!Array.isArray(e))return[];if(!t||0===t.length)return e;let i=[];e.forEach(e=>{i.push({type:"unit",id:e.unitType,rect:{left:e.x,right:e.x+3,top:e.y,bottom:e.y+3},data:e})}),t.forEach(e=>{i.push({type:"env",id:e.id,rect:{left:e.x,right:e.x+e.width,top:e.y,bottom:e.y+e.height},data:e})});let a={0:{up:"N",down:"S",left:"W",right:"E"},90:{up:"E",down:"W",left:"N",right:"S"},180:{up:"S",down:"N",left:"E",right:"W"},270:{up:"W",down:"E",left:"S",right:"N"}}[n];return e.map(e=>{let t={left:Number(e.x)||0,right:(Number(e.x)||0)+3,top:Number(e.y)||0,bottom:(Number(e.y)||0)+3},n=new Set,r=[],l=!1,o=!1;return["up","down","left","right"].forEach(s=>{let c=a[s],d=i.filter(n=>{if("unit"===n.type&&n.id===e.unitType)return!1;let r=!1,i=!1,a=1/0;return"up"===s?(r=Math.max(0,Math.min(t.right,n.rect.right)-Math.max(t.left,n.rect.left))>0,(i=n.rect.bottom<=t.top)&&(a=t.top-n.rect.bottom)):"down"===s?(r=Math.max(0,Math.min(t.right,n.rect.right)-Math.max(t.left,n.rect.left))>0,(i=n.rect.top>=t.bottom)&&(a=n.rect.top-t.bottom)):"left"===s?(r=Math.max(0,Math.min(t.bottom,n.rect.bottom)-Math.max(t.top,n.rect.top))>0,(i=n.rect.right<=t.left)&&(a=t.left-n.rect.right)):"right"===s&&(r=Math.max(0,Math.min(t.bottom,n.rect.bottom)-Math.max(t.top,n.rect.top))>0,(i=n.rect.left>=t.right)&&(a=n.rect.left-t.right)),!!r&&!!i&&a<=15&&(n._dist=a,!0)});for(let e of(d.sort((e,t)=>e._dist-t._dist),d)){if("unit"===e.type)break;if("env"===e.type){let t=e.data;if("road"===t.type)o=!0,n.add(c);else if(["park","school","plaza","river","tower","grave","bridge","mountain","adjacent"].includes(t.type)){l=!0,r.some(e=>e.type===t.type&&e.direction===c)||r.push({type:t.type,direction:c});continue}}}}),{...e,roadFacing:o,roadFacingDirection:Array.from(n)[0]||"",roadFacingDirections:Array.from(n),facingOpenSpace:l,openSpaceType:r[0]?.type||"",openSpaceFacingDirection:r[0]?.direction||"",openSpaceFacingDirections:r}})}},38346:(e,t,n)=>{n.d(t,{h:()=>a});var r=n(12115),i=n(16385);function a(){let[e,t]=(0,r.useState)(null),[n,a]=(0,r.useState)(!0);return(0,r.useEffect)(()=>{let e=!0,n=async()=>{try{let{data:{session:n}}=await i.N.auth.getSession();if(!n?.user){e&&(t(null),a(!1));return}let{data:r,error:l}=await i.N.from("profiles").select("role").eq("id",n.user.id).single();e&&(r?t(r.role):t("user"),a(!1))}catch(n){console.error("Error fetching user role:",n),e&&(t("user"),a(!1))}};n();let{data:{subscription:r}}=i.N.auth.onAuthStateChange((e,r)=>{r?n():t(null)});return()=>{e=!1,r.unsubscribe()}},[]),{role:e,isLoading:n}}},75364:(e,t,n)=>{n.d(t,{NG:()=>s,Vz:()=>a,Z5:()=>u,Ze:()=>i,a2:()=>c,ew:()=>d,oP:()=>o});var r=n(16385);let i="horizontal-diff",a="floor-config-update",l=(e,t=i)=>{let n=String(e||"default").trim()||"default",r=String(t||i).trim()||i;return`floor-configs:${r}:${n}`},o=(e,t=i)=>{try{let n=window.localStorage.getItem(l(e,t));if(!n)return null;let r=JSON.parse(n);if(!r||!Array.isArray(r.configurations))return null;return r}catch{return null}},s=(e,t,n=i)=>{try{window.localStorage.setItem(l(e,n),JSON.stringify(t)),window.dispatchEvent(new CustomEvent(a,{detail:{project:e,scope:n}}))}catch{}},c=(e,t=i)=>{try{window.localStorage.removeItem(l(e,t)),window.dispatchEvent(new CustomEvent(a,{detail:{project:e,scope:t}}))}catch{}},d=async e=>{try{let{data:t,error:n}=await r.N.from("project_floor_configs").select("config_data").eq("project_name",e).eq("is_official",!0).single();if(n||!t)return null;return t.config_data}catch(e){return console.error("Error fetching official config:",e),null}},u=async(e,t)=>{try{let{data:{user:n}}=await r.N.auth.getUser();if(!n)return{success:!1,error:"User not logged in"};let{error:i}=await r.N.from("project_floor_configs").upsert({project_name:e,config_data:t,is_official:!0,created_by:n.id,updated_at:new Date().toISOString()},{onConflict:"project_name",ignoreDuplicates:!1}).select();if(i)return console.error("Error publishing config:",i),{success:!1,error:i.message||JSON.stringify(i)};return{success:!0}}catch(e){return console.error("Error publishing official config:",e),{success:!1,error:e.message||"Unknown error"}}}},89579:(e,t,n)=>{n.d(t,{B$:()=>l});class r{constructor(){this.knownPatterns=new Map,this.patternFrequency=new Map,this.initializeBasePatterns()}initializeBasePatterns(){[{id:"unit_slash_floorF_format",name:"戶號斜線樓層F格式",regex:/^([A-Z]\d+)\/(\d+)F[號号]?$/i,extract:(e,t)=>{let n=e[1],r=e[2];return t?.floor&&parseInt(r,10)===parseInt(t.floor,10)?n:n+r},confidence:100,priority:.01},{id:"building_unit_floor_combined",name:"棟別戶號樓層合併格式",regex:/^([A-Z])棟(\d+)-(\d+)[號号]?$/i,extract:(e,t)=>{let n=e[1],r=e[2],i=e[3];return t?.floor&&parseInt(i,10)===parseInt(t.floor,10)?n+r:n+r+i},confidence:100,priority:.02},{id:"building_unit_floorF_format_v2",name:"棟別戶號樓層F格式v2",regex:/^([A-Z])棟(\d+)-(\d+)F[號号]?$/i,extract:(e,t)=>{let n=e[1],r=e[2],i=e[3];return t?.floor&&parseInt(i,10)===parseInt(t.floor,10)?n+r:n+r+i},confidence:100,priority:.03},{id:"unit_building_zero_format",name:"戶號棟別0號格式",regex:/^([A-Z]\d+)棟0[號号]?$/i,extract:e=>e[1],confidence:100,priority:.04},{id:"single_letter_unit",name:"單字母戶號格式",regex:/^([A-Z])[號号]$/i,extract:e=>e[1],confidence:95,priority:.045},{id:"building_floor_unit_letter_format",name:"棟別樓層數字戶型字母格式",regex:/^([A-Z])棟(\d+)([A-Z])[號号]?$/i,extract:(e,t)=>{let n=e[1],r=parseInt(e[2],10),i=e[3];return t?.floor&&r===parseInt(t.floor,10)?i:`${n}${r}${i}`},confidence:99,priority:.05},{id:"building_floor_unit_format",name:"棟別樓層戶號格式",regex:/^([A-Z])棟(\d{1,2})F-(\d+)[號号]?$/,extract:(e,t)=>{let n=e[1],r=e[2],i=e[3];return t?.floor&&parseInt(r,10)===parseInt(t.floor,10)?n+i:n+r+i},confidence:99,priority:.1},{id:"letter_number_floor_format",name:"字母數字-樓層F格式",regex:/^([A-Z])0*(\d+)-(\d{1,2})F[號号]?$/,extract:(e,t)=>{let n=e[1],r=e[2],i=e[3];return t?.floor&&parseInt(i,10)===parseInt(t.floor,10)?n+r:n+r+i},confidence:99,priority:.15},{id:"identifier_building_floor_redundant",name:"識別碼棟與F樓層格式(贅余樓層)",regex:/^([A-Z]\d+)棟F(\d+)[號号]?$/i,extract:(e,t)=>{let n=e[1],r=e[2],i=n.match(/^[A-Z]+/)?.[0]||"",a=parseInt(n.match(/\d+/)?.[0]||"0",10),l=`${i}${a}`;return t?.floor&&parseInt(r,10)===parseInt(t.floor,10)?l:l+"F"+r},confidence:98,priority:.18},{id:"identifier_building_floorF_format",name:"識別碼棟與樓層F格式(贅余樓層)",regex:/^([A-Z]\d+)棟(\d{1,2})F[號号]?$/i,extract:(e,t)=>{let n=e[1],r=e[2];return t?.floor&&parseInt(r,10)===parseInt(t.floor,10)?n:n+r},confidence:98,priority:.19},{id:"unit_building_floor_format",name:"戶棟樓層格式",regex:/^([A-Z]\d+)戶棟(\d+)F[號号]?$/,extract:(e,t)=>{let n=e[1],r=e[2];return t?.floor&&parseInt(r,10)===parseInt(t.floor,10)?n:n+r},confidence:99,priority:.2},{id:"building_sub_unit_floor_format",name:"棟別子戶號樓層格式",regex:/^([A-Z])棟(\d+)-(\d+)F[號号]?$/,extract:(e,t)=>{let n=e[1],r=e[2],i=e[3];return t?.floor&&parseInt(i,10)===parseInt(t.floor,10)?n+r:n+r+i},confidence:99,priority:.3},{id:"building_unit_floor_format",name:"棟別戶別樓層格式",regex:/^([A-Z])棟([A-Z])-(\d{1,2})F[號号]?$/,extract:(e,t)=>{let n=e[2],r=e[3];return t?.floor&&parseInt(r,10)===parseInt(t.floor,10)?n:n+r},confidence:99,priority:.4},{id:"building_self_unit_floor_format",name:"棟別自身戶號樓層格式",regex:/^([A-Z])棟\1-(\d+)[號号]?$/,extract:(e,t)=>{let n=e[1],r=e[2];return t?.floor&&parseInt(r,10)===parseInt(t.floor,10)?n:n+r},confidence:98,priority:.45},{id:"building_unit_letter_floor_number",name:"棟別戶號字母樓層數字格式",regex:/^([A-Z])棟([A-Z])(\d{1,2})[號号]?$/,extract:(e,t)=>{let n=e[2],r=e[3];return t?.floor&&parseInt(r,10)===parseInt(t.floor,10)?n:n+r},confidence:98,priority:.46},{id:"redundant_building_format",name:"重複棟別格式",regex:/^([A-Z])棟\1-(\d{1,2})F[號号]?$/,extract:(e,t)=>{let n=e[1],r=e[2];return t?.floor&&parseInt(r,10)===parseInt(t.floor,10)?n:n+r},confidence:98,priority:.5},{id:"building_floor_letter_unit",name:"棟別樓層字母戶號格式",regex:/^[A-Z]棟(\d{1,2})F-([A-Z])[號号]?$/,extract:(e,t)=>{let n=e[1],r=e[2];return t?.floor&&parseInt(n,10)===parseInt(t.floor,10)?r:r+n},confidence:98,priority:.6},{id:"letter_leading_zero_unit",name:"字母與0開頭數字戶號",regex:/^([A-Z])0+(\d+)[號号]?$/,extract:e=>e[1]+e[2],confidence:97,priority:.7},{id:"floor_prefix_format",name:"樓層前綴格式",regex:/^(\d{1,2})([A-Z])[號号]?$/,extract:(e,t)=>{let n=e[1],r=e[2];return t?.floor&&parseInt(n,10)===parseInt(t.floor,10)?r:n+r},confidence:96,priority:.8},{id:"floorF_building_unit_format",name:"樓層F棟戶號格式",regex:/^(\d{1,2})F棟([A-Z])[號号]?$/,extract:(e,t)=>{let n=e[1],r=e[2];return t?.floor&&parseInt(n,10)===parseInt(t.floor,10)?r:n+r},confidence:98,priority:.85},{id:"numericBuilding_floor_unit_format",name:"數字棟別樓層戶號格式",regex:/^(\d+)棟(\d{1,2})([A-Z])[號号]?$/,extract:(e,t)=>{let n=e[2],r=e[3];return t?.floor&&parseInt(n,10)===parseInt(t.floor,10)?r:n+r},confidence:98,priority:.86},{id:"floor_first_detailed",name:"樓層優先詳細格式",regex:/(\d{1,2})F-([A-Z])(\d{2})/,extract:e=>e[2]+e[3],confidence:95,priority:1},{id:"floor_prefix_complex_unit",name:"樓層前綴複合戶號",regex:/^(\d{1,2})F-([A-Z]\d+)[號号]?$/,extract:(e,t)=>{let n=e[1],r=e[2];return t?.floor&&parseInt(n,10)===parseInt(t.floor,10)?r:n+r},confidence:94,priority:1.2},{id:"floor_first_simple_letter",name:"樓層優先簡單字母格式",regex:/^(\d{1,2})F-([A-Z])[號号]?$/,extract:(e,t)=>{let n=e[1],r=e[2];return t?.floor&&parseInt(n,10)===parseInt(t.floor,10)?r:n+r},confidence:90,priority:1.5},{id:"building_with_unit",name:"棟別完整戶號",regex:/([A-Z])棟([A-Z])(\d{1,2})(?:-(\d{1,2})F?[號号])?/,extract:e=>e[2]+e[3],confidence:90,priority:2,conditions:[{type:"building_match",validator:e=>{let t=e.rawUnit.match(/([A-Z])棟([A-Z])/);return!!t&&t[1]===t[2]}}]},{id:"building_simple_letter_unit",name:"棟別字母戶號格式",regex:/^[A-Z]棟([A-Z])[號号]?$/,extract:e=>e[1],confidence:92,priority:2.5},{id:"unit_floor_suffix",name:"戶號樓層後綴",regex:/([A-Z]\d{1,2})-(\d{1,2})F?[號号]?/,extract:e=>e[1],confidence:85,priority:3},{id:"building_floor_format",name:"棟別樓層格式",regex:/^([A-Z]\d{1,2})棟(\d{1,2})(?:F|樓)[號号]?$/,extract:(e,t)=>{let n=e[1],r=e[2];return t?.floor&&parseInt(r,10)===parseInt(t.floor,10)?n:n+r},confidence:88,priority:3.5},{id:"building_complex_number",name:"複合棟別編號",regex:/^([A-Z]\d+)棟(\d+)[號号]$/,extract:(e,t)=>{let n=e[1],r=e[2];return t?.floor&&parseInt(r,10)===parseInt(t.floor,10)?n:n+r},confidence:86,priority:3.8},{id:"building_floor_F_format",name:"棟別樓層F格式",regex:/^([A-Z])棟(\d{1,2})F[號号]?$/,extract:(e,t)=>{let n=e[1],r=e[2];return t?.floor&&parseInt(r,10)===parseInt(t.floor,10)?n:n+r},confidence:87,priority:3.9},{id:"building_zero_placeholder_unit",name:"棟別0號佔位符格式",regex:/^([A-Z])棟0[號号]?$/,extract:e=>e[1],confidence:95,priority:3.95},{id:"building_simple_number",name:"棟別簡單編號",regex:/([A-Z])棟(\d{1,2})[號号]/,extract:(e,t)=>{let n=e[1],r=e[2];return t?.floor&&parseInt(r,10)===parseInt(t.floor,10)?n:n+r},confidence:85,priority:4},{id:"unit_floor_concatenated",name:"複合戶號樓層格式",regex:/^([A-Z])(\d+)F[號号]?$/,extract:(e,t)=>{let n=e[1],r=e[2],i=t?.floor;if(i){let e=parseInt(i,10);if(!isNaN(e)){if(e<10){let e="0"+i;if(r.endsWith(e))return n+r.substring(0,r.length-2)}if(r.endsWith(i))return n+r.substring(0,r.length-i.length)}}return n+r},confidence:80,priority:4.5},{id:"letter_floor",name:"字母樓層格式",regex:/^([A-Z])-(\d{1,2})F?[號号]?$/,extract:(e,t)=>{let n=e[2];return t?.floor&&parseInt(n,10)===parseInt(t.floor,10)?e[1]:e[1]+n},confidence:70,priority:5}].forEach(e=>{this.knownPatterns.set(e.id,e)})}detectPattern(e,t){let n=this.normalizeText(e),r=null;for(let e of Array.from(this.knownPatterns.values()).sort((e,t)=>e.priority-t.priority)){let i=n.match(e.regex);if(i){if(e.conditions&&t&&!e.conditions.every(e=>e.validator(t)))continue;r={rule:e,match:i};break}}return r&&this.patternFrequency.set(r.rule.id,(this.patternFrequency.get(r.rule.id)||0)+1),r}normalizeText(e){return e?e.toUpperCase().replace(/[\uff01-\uff5e]/g,e=>String.fromCharCode(e.charCodeAt(0)-65248)).replace(/\s+/g,""):""}}class i{analyzeProject(e,t){let n={projectName:e,patterns:new Map,unitMappings:new Map,namingStyle:"unknown"},i=new r;for(let r of t){let t=r["戶別"],a=r["樓層"];if(!t)continue;let l={rawUnit:t,floor:a?String(a):void 0,projectName:e},o=i.detectPattern(t,l);if(o){let e=o.rule;n.patterns.has(e.id)||n.patterns.set(e.id,{patternId:e.id,count:0,examples:[],confidence:e.confidence});let r=n.patterns.get(e.id);r.count++,r.examples.length<10&&r.examples.push(t)}n.unitMappings.has(t)||n.unitMappings.set(t,{floors:new Set,rawVariations:new Set([t])});let s=n.unitMappings.get(t);a&&s.floors.add(String(a))}return this.determineNamingStyle(n),this.projectProfiles.set(e,n),n}determineNamingStyle(e){let t=e.patterns.size,n=Array.from(e.patterns.values()).reduce((e,t)=>e+t.count,0);if(0===t){e.namingStyle="unknown";return}let r=null,i=0;for(let t of e.patterns.values())t.count>i&&(i=t.count,r=t);r&&(e.dominantPattern=r.patternId,r.count/n>.8?e.namingStyle="consistent":e.namingStyle="mixed")}getProjectProfile(e){return this.projectProfiles.get(e)}isAmbiguousUnit(e,t){let n=this.projectProfiles.get(e);if(!n)return!1;let r=n.unitMappings.get(t);return!!r&&r.floors.size>1}constructor(){this.projectProfiles=new Map}}class a{constructor(e){this.customRules=new Map,this.detector=e,this.initializeCustomRules()}initializeCustomRules(){}applyRules(e){for(let[t,n]of this.customRules){let t=n(e);if(t)return t}let t=this.detector.detectPattern(e.rawUnit,e);if(t){let{rule:n,match:r}=t;return{identifier:n.extract(r,e),confidence:n.confidence,method:`pattern:${n.id}`}}return{identifier:this.simpleFallback(e.rawUnit),confidence:50,method:"fallback"}}simpleFallback(e){return e?e.toUpperCase().replace(/[\uff01-\uff5e]/g,e=>String.fromCharCode(e.charCodeAt(0)-65248)).replace(/\s+/g,"").replace(/[棟樓F室號\-]/g,""):""}}class l{constructor(e){this.resolveCache=new Map,console.log("[AdaptiveUnitResolver] 初始化，處理",e.length,"筆資料"),this.detector=new r,this.analyzer=new i,this.ruleEngine=new a(this.detector),this.buildKnowledgeBase(e)}buildKnowledgeBase(e){let t=new Map;for(let n of e){let e=n["建案名稱"];e&&(t.has(e)||t.set(e,[]),t.get(e).push(n))}for(let[e,n]of(console.log("[AdaptiveUnitResolver] 分析",t.size,"個建案"),t))this.analyzer.analyzeProject(e,n)}resolve(e){return this.resolveWithContext(e).identifier}resolveWithContext(e){let t=e["戶別"];t&&"string"==typeof t&&(t=t.trim());let n=e["樓層"],r=e["建案名稱"];if(!t)return{identifier:"",confidence:0,method:"no_input"};let i=`${r}|${t}|${n||""}`;if(this.resolveCache.has(i))return this.resolveCache.get(i);let a={rawUnit:t,floor:n?String(n):void 0,projectName:r},l=this.ruleEngine.applyRules(a);if(l)return this.resolveCache.set(i,l),l;let o={identifier:t,confidence:0,method:"fallback_null"};return this.resolveCache.set(i,o),o}}}}]);