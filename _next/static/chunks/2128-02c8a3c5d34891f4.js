"use strict";(self.webpackChunk_N_E=self.webpackChunk_N_E||[]).push([[2128],{9505:(e,t,a)=>{a.d(t,{l:()=>o});var r=a(95155),s=a(12115),i=a(40980),n=a(68459),l=a(94514),c=a(61878);function o({projects:e,className:t,onChange:a,max:o=6,placeholder:d="搜尋並加入比較...",title:x="建案亮點標示"}){let[h,m]=(0,s.useState)(""),[p,u]=(0,s.useState)([]),[g,f]=(0,s.useState)(!1),b=(0,s.useRef)(null),j=(0,s.useRef)(null);(0,s.useEffect)(()=>{let e=e=>{b.current&&!b.current.contains(e.target)&&f(!1)};return document.addEventListener("mousedown",e),()=>document.removeEventListener("mousedown",e)},[]);let y=e.filter(e=>!p.includes(e.value)&&e.label.toLowerCase().includes(h.toLowerCase())).slice(0,10);return(0,r.jsxs)("div",{className:(0,i.cn)("space-y-2",t),ref:b,children:[(0,r.jsxs)("div",{className:"flex justify-between items-center bg-zinc-900/50 p-1 rounded-lg border border-white/5",children:[(0,r.jsxs)("h4",{className:"text-sm font-medium text-zinc-400 pl-2 border-l-2 border-yellow-500",children:[x," ",(0,r.jsxs)("span",{className:"text-xs font-normal text-zinc-600",children:["(最多 ",o," 個)"]})]}),p.length>0&&(0,r.jsxs)("button",{onClick:()=>{u([]),a([]),j.current?.focus()},className:"p-1.5 text-zinc-500 hover:text-rose-400 hover:bg-rose-500/10 rounded transition-colors flex items-center gap-1 text-xs",title:"清除所有選擇",children:[(0,r.jsx)(n.A,{size:14}),"清除"]})]}),(0,r.jsxs)("div",{className:"flex flex-wrap gap-2 min-h-[32px]",children:[0===p.length&&(0,r.jsx)("span",{className:"text-xs text-zinc-600 italic py-1",children:"尚未選擇建案..."}),p.map(e=>(0,r.jsxs)("div",{className:"flex items-center gap-1 bg-yellow-500/10 text-yellow-500 px-2 py-1 rounded text-xs border border-yellow-500/30",children:[(0,r.jsx)("span",{children:e}),(0,r.jsx)("button",{onClick:()=>{let t;u(t=p.filter(t=>t!==e)),a(t)},className:"hover:text-yellow-300",children:(0,r.jsx)(l.A,{size:12,className:"rotate-45"})})]},e))]}),(0,r.jsxs)("div",{className:"relative",children:[(0,r.jsx)(c.A,{className:"absolute left-3 top-1/2 -translate-y-1/2 w-4 h-4 text-zinc-500"}),(0,r.jsx)("input",{ref:j,type:"text",value:h,onChange:e=>{m(e.target.value),f(!0)},onFocus:()=>f(!0),placeholder:d,className:"w-full bg-zinc-900/50 border border-white/10 rounded-lg pl-9 pr-4 py-2 text-sm text-white placeholder:text-zinc-600 focus:outline-none focus:ring-1 focus:ring-cyan-500/50 transition-all",disabled:p.length>=o}),g&&(0,r.jsx)("div",{className:"absolute top-full left-0 right-0 mt-1 bg-zinc-900 border border-white/10 rounded-lg shadow-xl z-50 max-h-60 overflow-y-auto",children:y.length>0?y.map(e=>(0,r.jsx)("button",{onClick:()=>(e=>{if(p.length>=o)return;let t=[...p,e];u(t),a(t),m(""),j.current?.focus()})(e.value),className:"w-full text-left px-3 py-2 text-sm text-zinc-300 hover:bg-white/5 hover:text-white transition-colors",children:e.label},e.value)):(0,r.jsx)("div",{className:"px-3 py-2 text-sm text-zinc-600",children:"無相關建案"})})]})]})}},20871:(e,t,a)=>{a.d(t,{U:()=>p});var r=a(95155),s=a(12115),i=a(68605),n=a(47650),l=a(40980),c=a(60529);let o=({children:e,x:t,y:a,visible:i})=>{let[l,c]=(0,s.useState)(!1);return((0,s.useEffect)(()=>(c(!0),()=>c(!1)),[]),l&&i&&!("u"<typeof document))?(0,n.createPortal)((0,r.jsx)("div",{className:"fixed pointer-events-none z-[9999]",style:{left:t,top:a,transform:"translate(-50%, -100%) translateY(-12px)"},children:e}),document.body):null};function d({data:e,minPrice:t,maxPrice:a,interval:i,sizeMetric:n,onMinPriceChange:d,onMaxPriceChange:x,onIntervalChange:h,onSizeMetricChange:m}){let[p,u]=(0,s.useState)("natural"),[g,f]=(0,s.useState)(null),[b,j]=(0,s.useState)({x:0,y:0}),[y,v]=(0,s.useState)([]),N=(0,s.useRef)(null),[w,z]=(0,s.useState)({width:0,height:0});(0,s.useEffect)(()=>{if(!N.current)return;let e=()=>{N.current&&z({width:N.current.clientWidth,height:N.current.clientHeight})};e(),window.addEventListener("resize",e);let t=setTimeout(e,200);return()=>{window.removeEventListener("resize",e),clearTimeout(t)}},[]),(0,s.useEffect)(()=>{let e=e=>{"Escape"===e.key&&v([])};return window.addEventListener("keydown",e),()=>window.removeEventListener("keydown",e)},[]);let k=(e,t)=>{let a=e.currentTarget.getBoundingClientRect();j({x:a.left+a.width/2,y:a.top}),f(t)},{buckets:S,validBuckets:P,maxValue:M}=(0,s.useMemo)(()=>{if(!e||0===e.length)return{buckets:[],validBuckets:[],maxValue:0};let r=[];for(let e=t;e<a;e+=i)r.push({min:e,max:Math.min(e+i,a),label:`${e}-${Math.min(e+i,a)}`,count:0,totalArea:0,avgPrice:0,transactions:[]});e.forEach(e=>{let s=e["房屋單價(萬)"],n=e["房屋面積(坪)"]||0;if("number"!=typeof s||s<t||s>=a)return;let l=Math.floor((s-t)/i);l>=0&&l<r.length&&(r[l].count++,r[l].totalArea+=n,r[l].transactions.push(e))});let s=r.filter(e=>e.count>0),l=Math.max(...s.map(e=>"count"===n?e.count:e.totalArea));return{buckets:r,validBuckets:s,maxValue:l}},[e,t,a,i,n]);(0,s.useEffect)(()=>{let e=new Set(P.map(e=>e.label));v(t=>t.filter(t=>e.has(t)))},[P]);let{nodes:A,onMouseDown:C,dragId:_,consumeWasDragged:$}=((e,t,a,r,i,n)=>{let[l,c]=(0,s.useState)([]),o=(0,s.useRef)(null),d=(0,s.useRef)(null),x=(0,s.useRef)(null),h=(0,s.useRef)(!1),m=(0,s.useRef)(!1);return(0,s.useEffect)(()=>{if(!e.length||!t||!a)return;let s=t/2,n=a/2,l=e.map((e,t)=>{let a="count"===r?e.count:e.totalArea,s=i>0?30+a/i*80:30;return{id:e.label,value:a,radius:s/2,x:0,y:0,vx:0,vy:0,origIndex:t}});l.sort((e,t)=>e.value-t.value),l=l.map((e,t)=>{let a=2.39996*t,r=10*Math.sqrt(t)*2.5;return{...e,x:s+Math.cos(a)*r,y:n+Math.sin(a)*r}});for(let e=0;e<120;e++)for(let e=0;e<l.length;e++)for(let t=e+1;t<l.length;t++){let a=l[e],r=l[t],s=r.x-a.x,i=r.y-a.y,n=s*s+i*i,c=a.radius+r.radius+5;if(n<c*c&&n>0){let e=Math.sqrt(n),t=c-e,l=s/e,o=i/e,d=.5*t;a.x-=l*d,a.y-=o*d,r.x+=l*d,r.y+=o*d}}c(l)},[e,t,a,r,i]),(0,s.useEffect)(()=>{if(!n)return;let e=e=>{x.current={x:e.clientX,y:e.clientY},d.current&&Math.hypot(e.clientX-d.current.startX,e.clientY-d.current.startY)>4&&(h.current=!0)},t=()=>{m.current=h.current,h.current=!1,d.current=null,x.current=null};return window.addEventListener("mousemove",e),window.addEventListener("mouseup",t),()=>{window.removeEventListener("mousemove",e),window.removeEventListener("mouseup",t)}},[n]),(0,s.useEffect)(()=>{if(!n||0===l.length||!t)return;let e=t/2,r=a/2,s=()=>{c(t=>{let a=t.map(e=>({...e})),s=0,i=0,n=0,l=0;d.current&&x.current&&(s=x.current.x-d.current.startX,i=x.current.y-d.current.startY,n=d.current.nodeOrigX+s,l=d.current.nodeOrigY+i),a.forEach(t=>{if(d.current?.id===t.id)t.x=n,t.y=l,t.vx=0,t.vy=0;else{let a=e-t.x,s=r-t.y;t.vx+=.05*a*.05,t.vy+=.05*s*.05,t.vx+=(Math.random()-.5)*.003,t.vy+=(Math.random()-.5)*.003,t.x+=t.vx,t.y+=t.vy,t.vx*=.94,t.vy*=.94}});for(let e=0;e<6;e++)for(let e=0;e<a.length;e++)for(let t=e+1;t<a.length;t++){let r=a[e],s=a[t],i=d.current?.id===r.id,n=d.current?.id===s.id,l=s.x-r.x,c=s.y-r.y,o=l*l+c*c,x=r.radius+s.radius+5;if(o<x*x&&o>0){let e=Math.sqrt(o),t=x-e,a=l/e,d=c/e,h=.5*t;i?(s.x+=a*t,s.y+=d*t):n?(r.x-=a*t,r.y-=d*t):(r.x-=a*h,r.y-=d*h,s.x+=a*h,s.y+=d*h)}}return a}),o.current=requestAnimationFrame(s)};return o.current=requestAnimationFrame(s),()=>{null!==o.current&&cancelAnimationFrame(o.current)}},[n,t,a,l.length]),{nodes:l,onMouseDown:(e,t,a,r)=>{e.preventDefault(),h.current=!1,d.current={id:t,startX:e.clientX,startY:e.clientY,nodeOrigX:a,nodeOrigY:r},x.current={x:e.clientX,y:e.clientY}},dragId:d.current?.id,consumeWasDragged:()=>{let e=m.current;return m.current=!1,e}}})(P,w.width,w.height,n,M,"natural"===p);if(!e||0===e.length)return(0,r.jsx)("div",{className:"text-zinc-500 text-center p-8",children:"無交易資料可顯示"});let F=(e,t)=>{let a,r,s=e/(t-1||1);return s<.33?(a="radial-gradient(circle at 30% 30%, rgb(167, 139, 250), rgb(124, 58, 237))",r="rgba(124, 58, 237, 0.4)"):s<.66?(a="radial-gradient(circle at 30% 30%, rgb(34, 211, 238), rgb(8, 145, 178))",r="rgba(8, 145, 178, 0.4)"):(a="radial-gradient(circle at 30% 30%, rgb(52, 211, 153), rgb(5, 150, 105))",r="rgba(5, 150, 105, 0.4)"),{background:a,shadowColor:r}},E=null!==g?P[g]:null,R=(e,t)=>{t||v(t=>t.includes(e)?t.filter(t=>t!==e):[...t,e])},T=(e,t="bottom")=>(0,r.jsxs)("div",{className:"pointer-events-none px-4 py-3 bg-zinc-900/90 backdrop-blur-xl border border-white/10 rounded-xl shadow-2xl min-w-[160px]",children:[(0,r.jsxs)("div",{className:"flex items-center justify-between mb-2",children:[(0,r.jsx)("span",{className:"text-xs font-medium text-zinc-400",children:"成交單價"}),(0,r.jsx)("span",{className:"text-sm font-bold text-white",children:e.label})]}),(0,r.jsxs)("div",{className:"space-y-1.5",children:[(0,r.jsxs)("div",{className:"flex justify-between items-center text-xs",children:[(0,r.jsx)("span",{className:"text-zinc-500",children:"成交筆數"}),(0,r.jsxs)("span",{className:"font-medium text-violet-300",children:[e.count," 筆"]})]}),(0,r.jsxs)("div",{className:"flex justify-between items-center text-xs",children:[(0,r.jsx)("span",{className:"text-zinc-500",children:"總銷坪數"}),(0,r.jsxs)("span",{className:"font-medium text-cyan-300",children:[Math.round(e.totalArea)," 坪"]})]})]}),(0,r.jsx)("div",{className:(0,l.cn)("absolute left-1/2 w-2 h-2 bg-zinc-900/90 rotate-45 -translate-x-1/2","bottom"===t?"bottom-0 -mb-1 border-r border-b border-white/10":"top-0 -mt-1 border-l border-t border-white/10")})]});return(0,r.jsxs)("div",{className:"space-y-6",children:[(0,r.jsx)(o,{x:b.x,y:b.y,visible:null!==g&&!!E&&!_,children:E&&(0,r.jsx)("div",{className:"animate-in fade-in zoom-in-95 duration-200",children:T(E)})}),(0,r.jsxs)("div",{className:"flex flex-wrap items-center justify-between gap-4 p-4 bg-zinc-900/30 border border-white/5 rounded-xl","data-report-control":"hide",children:[(0,r.jsxs)("div",{className:"flex flex-wrap items-center gap-4",children:[(0,r.jsxs)("div",{className:"flex items-center gap-2",children:[(0,r.jsx)("span",{className:"text-zinc-400 text-xs",children:"單價範圍"}),(0,r.jsxs)("div",{className:"flex items-center gap-1",children:[(0,r.jsx)(c.p,{type:"number",value:t,onChange:e=>d(Number(e.target.value)),className:"w-16 h-7 text-xs bg-zinc-950/50 border-white/10 px-2"}),(0,r.jsx)("span",{className:"text-zinc-600",children:"-"}),(0,r.jsx)(c.p,{type:"number",value:a,onChange:e=>x(Number(e.target.value)),className:"w-16 h-7 text-xs bg-zinc-950/50 border-white/10 px-2"})]})]}),(0,r.jsxs)("div",{className:"flex items-center gap-2",children:[(0,r.jsx)("span",{className:"text-zinc-400 text-xs",children:"級距"}),(0,r.jsx)(c.p,{type:"number",value:i,onChange:e=>h(Number(e.target.value)),className:"w-14 h-7 text-xs bg-zinc-950/50 border-white/10 px-2"})]}),(0,r.jsxs)("div",{className:"flex bg-zinc-950/50 rounded-md p-0.5 border border-white/10",children:[(0,r.jsx)("button",{onClick:()=>m("count"),className:(0,l.cn)("px-2.5 py-1 text-[10px] rounded transition-colors","count"===n?"bg-violet-500 text-white shadow-sm":"text-zinc-400 hover:text-white"),children:"成交筆數"}),(0,r.jsx)("button",{onClick:()=>m("area"),className:(0,l.cn)("px-2.5 py-1 text-[10px] rounded transition-colors","area"===n?"bg-violet-500 text-white shadow-sm":"text-zinc-400 hover:text-white"),children:"總銷坪數"})]})]}),(0,r.jsxs)("div",{className:"bg-zinc-950/50 p-1 rounded-lg border border-white/5 flex gap-1",children:[(0,r.jsx)("button",{onClick:()=>u("natural"),className:(0,l.cn)("px-3 py-1.5 text-xs font-medium rounded-md transition-all duration-300","natural"===p?"bg-gradient-to-r from-violet-600 to-indigo-600 text-white shadow-lg shadow-violet-500/20":"text-zinc-500 hover:text-zinc-300"),children:(0,r.jsxs)("span",{className:"flex items-center gap-1.5",children:[(0,r.jsxs)("span",{className:"relative flex h-2 w-2",children:[(0,r.jsx)("span",{className:(0,l.cn)("absolute inline-flex h-full w-full rounded-full bg-violet-400 opacity-75","natural"===p&&"animate-ping")}),(0,r.jsx)("span",{className:"relative inline-flex rounded-full h-2 w-2 bg-violet-500"})]}),"無重力模式"]})}),(0,r.jsx)("button",{onClick:()=>u("coordinate"),className:(0,l.cn)("px-3 py-1.5 text-xs font-medium rounded-md transition-all duration-300","coordinate"===p?"bg-gradient-to-r from-violet-600 to-indigo-600 text-white shadow-lg shadow-violet-500/20":"text-zinc-500 hover:text-zinc-300"),children:(0,r.jsxs)("span",{className:"flex items-center gap-1.5",children:[(0,r.jsxs)("svg",{className:"w-3.5 h-3.5",viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:"2",children:[(0,r.jsx)("path",{d:"M3 3v18h18"}),(0,r.jsx)("path",{d:"M18 17V9"}),(0,r.jsx)("path",{d:"M13 17V5"}),(0,r.jsx)("path",{d:"M8 17v-3"})]}),"座標模式"]})})]})]}),(0,r.jsxs)("div",{ref:N,className:(0,l.cn)("relative rounded-3xl overflow-hidden border border-white/5 transition-all duration-500","bg-gradient-to-b from-zinc-900 via-zinc-900 to-zinc-950","h-full min-h-[500px]"),onClick:()=>v([]),children:[(0,r.jsxs)("div",{className:"absolute inset-0 pointer-events-none",children:[(0,r.jsx)("div",{className:"absolute top-0 inset-x-0 h-px bg-gradient-to-r from-transparent via-white/10 to-transparent"}),(0,r.jsx)("div",{className:"absolute top-[-10%] left-[-10%] w-[40%] h-[40%] bg-violet-500/10 rounded-full blur-[100px]"}),(0,r.jsx)("div",{className:"absolute bottom-[-10%] right-[-10%] w-[40%] h-[40%] bg-cyan-500/10 rounded-full blur-[100px]"})]}),(0,r.jsxs)("div",{className:"absolute inset-0",children:["natural"===p&&(0,r.jsxs)("div",{className:"absolute inset-0",children:[A.map((e,t)=>{var a,s;let i=g===e.origIndex,c=_===e.id,o=P[e.origIndex],d=o?.label,x=!!d&&y.includes(d),h=F(e.origIndex,P.length),m=2*e.radius,p=(a=e.y)-(s=e.radius)-90<0&&a+s+90<w.height?"bottom":a+s+90>w.height&&a-s-90>0?"top":a<w.height/2?"bottom":"top";return(0,r.jsxs)("div",{className:(0,l.cn)("absolute block rounded-full select-none cursor-grab active:cursor-grabbing will-change-transform",c?"z-[100] scale-110 shadow-2xl":"transition-[transform,box-shadow] duration-75 ease-linear"),style:{width:m,height:m,left:0,top:0,transform:`translate(${e.x-e.radius}px, ${e.y-e.radius}px) scale(${i||c?1.1:1})`,background:h.background,boxShadow:c?`0 25px 50px -12px ${h.shadowColor}, inset 0 2px 20px rgba(255,255,255,0.6)`:i?`0 20px 40px -10px ${h.shadowColor}, inset 0 2px 20px rgba(255,255,255,0.4)`:`0 10px 30px -10px ${h.shadowColor}, inset 0 2px 10px rgba(255,255,255,0.2)`,zIndex:c?100:i?50:10},onMouseEnter:t=>k(t,e.origIndex),onMouseLeave:()=>f(null),onMouseDown:t=>C(t,e.id,e.x,e.y),onClick:e=>{e.stopPropagation(),d&&R(d,$())},children:[(0,r.jsx)("div",{className:"absolute inset-0 rounded-full bg-gradient-to-tr from-white/0 via-white/0 to-white/30 opacity-50 pointer-events-none"}),(0,r.jsx)("div",{className:"absolute top-[15%] left-[15%] w-[25%] h-[15%] rounded-[100%] bg-white blur-[2px] opacity-40 transform -rotate-45 pointer-events-none"}),(0,r.jsxs)("div",{className:"absolute inset-0 flex flex-col items-center justify-center text-center z-20 pointer-events-none",children:[(0,r.jsx)("div",{className:(0,l.cn)("font-bold text-white drop-shadow-md leading-none",m>80?"text-2xl":m>60?"text-lg":"text-sm","mix-blend-overlay opacity-90"),children:e.value>=1?Math.round(e.value):e.value.toFixed(1)}),m>80&&(0,r.jsx)("div",{className:"text-[10px] text-white/70 mt-1 font-medium tracking-wide",children:"count"===n?"筆":"坪"})]}),o&&x&&(0,r.jsx)("div",{className:(0,l.cn)("absolute left-1/2 z-[110]","top"===p?"-top-3 -translate-x-1/2 -translate-y-full":"top-full mt-3 -translate-x-1/2"),children:T(o,"top"===p?"bottom":"top")})]},e.id)}),(0,r.jsx)("div",{className:"absolute bottom-4 left-0 right-0 text-center text-xs text-zinc-500 font-medium tracking-widest uppercase opacity-50 pointer-events-none",children:"Zero Gravity • Force Layout • Draggable"})]}),"coordinate"===p&&(0,r.jsxs)("div",{className:"absolute inset-0 pt-6 pb-8 px-0",children:[(0,r.jsx)("div",{className:"flex flex-col justify-between h-full py-0 pr-1 text-right w-[46px] border-r border-white/5 relative z-10 float-left",children:[...Array(6)].map((e,s)=>(0,r.jsx)("span",{className:"text-xs font-mono text-zinc-600 block leading-none transform -translate-y-1/2 first:translate-y-0 last:-translate-y-full",children:Math.round(a-(a-t)/5*s)},s))}),(0,r.jsxs)("div",{className:"relative ml-[46px] h-full",children:[(0,r.jsx)("div",{className:"absolute inset-0 flex flex-col justify-between pointer-events-none",children:[...Array(6)].map((e,t)=>(0,r.jsx)("div",{className:"w-full h-px border-t border-dashed border-zinc-800"},t))}),(0,r.jsx)("div",{className:"absolute inset-0",children:P.map((e,s)=>{var i;let c,o=(i="count"===n?e.count:e.totalArea,0===M?40:40+i/M*100),d=(e.min+e.max)/2,x=(c=e.label,y.includes(c)),h=s/(P.length-1||1)*90+5,m=100-(d-t)/(a-t)*100,p=g===s,u=F(s,P.length);return(0,r.jsxs)("div",{className:"absolute transform -translate-x-1/2 -translate-y-1/2 transition-all duration-500",style:{left:`${h}%`,top:`${m}%`,zIndex:p?50:20},onMouseEnter:e=>k(e,s),onMouseLeave:()=>f(null),children:[(0,r.jsx)("div",{className:(0,l.cn)("relative rounded-full flex items-center justify-center cursor-pointer shadow-lg transition-transform duration-300",p?"scale-110":"scale-100"),style:{width:o,height:o,background:u.background,boxShadow:p?`0 10px 20px -5px ${u.shadowColor}, inset 0 2px 10px rgba(255,255,255,0.3)`:`0 5px 15px -5px ${u.shadowColor}, inset 0 2px 5px rgba(255,255,255,0.2)`},onClick:t=>{t.stopPropagation(),R(e.label)},children:(0,r.jsx)("div",{className:"absolute inset-0 rounded-full bg-gradient-to-tr from-transparent to-white/30 opacity-60"})}),x&&(0,r.jsx)("div",{className:"absolute left-1/2 -top-3 -translate-x-1/2 -translate-y-full z-[60]",children:T(e)})]},e.label)})}),(0,r.jsxs)("div",{className:"absolute bottom-0 inset-x-0 flex justify-between text-xs text-zinc-600 font-mono translate-y-full pt-1 px-2",children:[(0,r.jsx)("span",{children:"Low Price"}),(0,r.jsx)("span",{children:"High Price"})]})]})]})]})]}),(0,r.jsxs)("div",{className:"flex items-center justify-between px-2 text-xs text-zinc-500",children:[(0,r.jsxs)("div",{children:["* Bubble size represents ","count"===n?"Transaction Count":"Total Area"]}),(0,r.jsxs)("div",{className:"flex items-center gap-4",children:[(0,r.jsxs)("div",{className:"flex items-center gap-1.5",children:[(0,r.jsx)("div",{className:"w-2 h-2 rounded-full bg-violet-500"}),(0,r.jsx)("span",{children:"Low"})]}),(0,r.jsxs)("div",{className:"flex items-center gap-1.5",children:[(0,r.jsx)("div",{className:"w-2 h-2 rounded-full bg-cyan-500"}),(0,r.jsx)("span",{children:"Mid"})]}),(0,r.jsxs)("div",{className:"flex items-center gap-1.5",children:[(0,r.jsx)("div",{className:"w-2 h-2 rounded-full bg-emerald-500"}),(0,r.jsx)("span",{children:"High"})]})]})]})]})}function x({title:e,stats:t,noDataMessage:a="無資料",className:s,averageType:i="weighted"}){if(!t||0===t.count)return(0,r.jsxs)("div",{className:(0,l.cn)("p-6 border border-white/5 rounded-lg bg-zinc-900/30",s),children:[(0,r.jsx)("h3",{className:"text-zinc-400 font-medium mb-4",children:e}),(0,r.jsx)("p",{className:"text-zinc-500 text-center py-4",children:a})]});let n="weighted"===i&&t.weightedAvgPrice?t.weightedAvgPrice:t.avgPrice;return(0,r.jsxs)("div",{className:(0,l.cn)("p-6 border border-white/5 rounded-lg bg-zinc-900/30",s),children:[(0,r.jsxs)("div",{className:"flex justify-between items-start mb-6",children:[(0,r.jsx)("h3",{className:"text-lg font-semibold text-white",children:e}),(0,r.jsxs)("span",{className:"text-xs text-zinc-500 bg-zinc-800 px-2 py-1 rounded",children:["樣本數: ",t.count]})]}),(0,r.jsxs)("div",{className:"flex flex-col gap-6",children:[(0,r.jsx)("div",{className:"space-y-1",children:(0,r.jsx)("table",{className:"w-full text-sm",children:(0,r.jsxs)("tbody",{className:"divide-y divide-white/5",children:[(0,r.jsxs)("tr",{className:"group",children:[(0,r.jsx)("td",{className:"py-2 text-zinc-400 whitespace-nowrap pr-4",children:"weighted"===i?"加權平均單價":"算術平均單價"}),(0,r.jsx)("td",{className:"py-2 text-right font-mono text-white group-hover:text-cyan-400 transition-colors pl-4 whitespace-nowrap",children:(0,r.jsxs)("span",{className:"inline-flex items-baseline gap-1",children:[(0,l.Z)(n),(0,r.jsx)("span",{className:"text-[10px] text-zinc-500",children:"萬/坪"})]})})]}),(0,r.jsxs)("tr",{className:"group",children:[(0,r.jsx)("td",{className:"py-2 text-zinc-400",children:"最低單價"}),(0,r.jsx)("td",{className:"py-2 text-right font-mono text-zinc-300 group-hover:text-white transition-colors whitespace-nowrap",children:(0,r.jsxs)("span",{className:"inline-flex items-baseline gap-1",children:[(0,l.Z)(t.minPrice),(0,r.jsx)("span",{className:"text-[10px] text-zinc-500",children:"萬/坪"})]})})]}),(0,r.jsxs)("tr",{className:"group",children:[(0,r.jsx)("td",{className:"py-2 text-zinc-400",children:"1/4分位數"}),(0,r.jsx)("td",{className:"py-2 text-right font-mono text-zinc-300 group-hover:text-white transition-colors whitespace-nowrap",children:(0,r.jsxs)("span",{className:"inline-flex items-baseline gap-1",children:[(0,l.Z)(t.q1Price),(0,r.jsx)("span",{className:"text-[10px] text-zinc-500",children:"萬/坪"})]})})]}),(0,r.jsxs)("tr",{className:"group",children:[(0,r.jsx)("td",{className:"py-2 text-violet-400 font-medium",children:"中位數單價"}),(0,r.jsx)("td",{className:"py-2 text-right font-mono text-violet-400 font-bold whitespace-nowrap",children:(0,r.jsxs)("span",{className:"inline-flex items-baseline gap-1",children:[(0,l.Z)(t.medianPrice),(0,r.jsx)("span",{className:"text-[10px] text-violet-300",children:"萬/坪"})]})})]}),(0,r.jsxs)("tr",{className:"group",children:[(0,r.jsx)("td",{className:"py-2 text-zinc-400",children:"3/4分位數"}),(0,r.jsx)("td",{className:"py-2 text-right font-mono text-zinc-300 group-hover:text-white transition-colors whitespace-nowrap",children:(0,r.jsxs)("span",{className:"inline-flex items-baseline gap-1",children:[(0,l.Z)(t.q3Price),(0,r.jsx)("span",{className:"text-[10px] text-zinc-500",children:"萬/坪"})]})})]}),(0,r.jsxs)("tr",{className:"group",children:[(0,r.jsx)("td",{className:"py-2 text-zinc-400",children:"最高單價"}),(0,r.jsx)("td",{className:"py-2 text-right font-mono text-zinc-300 group-hover:text-white transition-colors whitespace-nowrap",children:(0,r.jsxs)("span",{className:"inline-flex items-baseline gap-1",children:[(0,l.Z)(t.maxPrice),(0,r.jsx)("span",{className:"text-[10px] text-zinc-500",children:"萬/坪"})]})})]})]})})}),(0,r.jsxs)("div",{className:"grid grid-cols-2 gap-3 text-sm",children:[(0,r.jsxs)("div",{className:"p-3 bg-zinc-950/50 rounded border border-white/5",children:[(0,r.jsx)("div",{className:"text-cyan-500 font-medium mb-1 text-[10px] uppercase tracking-wider",children:"最高價建案"}),(0,r.jsx)("div",{className:"text-white font-bold text-base mb-1 truncate",title:t.maxPriceProject||"",children:t.maxPriceProject||"N/A"}),(0,r.jsxs)("div",{className:"flex gap-3 text-zinc-400 text-[10px]",children:[(0,r.jsxs)("span",{children:["戶別: ",t.maxPriceUnit||"-"]}),(0,r.jsxs)("span",{children:["樓層: ",t.maxPriceFloor||"-"]})]})]}),(0,r.jsxs)("div",{className:"p-3 bg-zinc-950/50 rounded border border-white/5",children:[(0,r.jsx)("div",{className:"text-green-500 font-medium mb-1 text-[10px] uppercase tracking-wider",children:"最低價建案"}),(0,r.jsx)("div",{className:"text-white font-bold text-base mb-1 truncate",title:t.minPriceProject||"",children:t.minPriceProject||"N/A"}),(0,r.jsxs)("div",{className:"flex gap-3 text-zinc-400 text-[10px]",children:[(0,r.jsxs)("span",{children:["戶別: ",t.minPriceUnit||"-"]}),(0,r.jsxs)("span",{children:["樓層: ",t.minPriceFloor||"-"]})]})]})]})]})]})}function h({data:e,expandAll:t=!1}){if(!e||0===e.length)return(0,r.jsx)("div",{className:"text-zinc-500 text-center p-8",children:"無符合條件的建案可進行類型比較"});let a=Math.max(...e.map(e=>e.shopMultiple),1),s=Math.max(...e.map(e=>e.officeMultiple),1);return(0,r.jsx)("div",{className:(0,l.cn)("overflow-x-auto relative scrollbar-thin scrollbar-thumb-zinc-700 scrollbar-track-transparent",t?"overflow-y-visible":"max-h-[600px] overflow-y-auto"),children:(0,r.jsxs)("table",{className:"w-full text-sm text-left",children:[(0,r.jsx)("thead",{className:"sticky top-0 z-10 bg-zinc-900 text-zinc-400 font-semibold uppercase text-xs shadow-md",children:(0,r.jsxs)("tr",{children:[(0,r.jsx)("th",{className:"px-4 py-3 whitespace-nowrap",children:"建案名稱"}),(0,r.jsx)("th",{className:"px-4 py-3 text-right",children:"住宅均價"}),(0,r.jsxs)("th",{className:"px-4 py-3 text-right",children:["店舖均價 ",(0,r.jsx)("span",{className:"text-[10px] text-zinc-500 font-normal ml-1",children:"/ 倍數"})]}),(0,r.jsxs)("th",{className:"px-4 py-3 text-right",children:["事務所均價 ",(0,r.jsx)("span",{className:"text-[10px] text-zinc-500 font-normal ml-1",children:"/ 倍數"})]})]})}),(0,r.jsx)("tbody",{className:"divide-y divide-white/5",children:e.map((e,t)=>(0,r.jsxs)("tr",{className:"hover:bg-zinc-800/30 transition-colors",children:[(0,r.jsxs)("td",{className:"px-4 py-3 whitespace-nowrap",children:[(0,r.jsx)("div",{className:"font-medium text-white",children:e.projectName}),(0,r.jsxs)("div",{className:"text-xs text-zinc-500 flex gap-1 mt-0.5",children:[e.county&&(0,r.jsx)("span",{className:"bg-zinc-800 px-1 rounded",children:e.county}),e.district&&(0,r.jsx)("span",{className:"bg-zinc-800 px-1 rounded",children:e.district})]})]}),(0,r.jsx)("td",{className:"px-4 py-3 text-right font-mono text-zinc-300",children:e.residentialAvg>0?(0,l.Z)(e.residentialAvg):"-"}),(0,r.jsxs)("td",{className:"px-4 py-3 text-right",children:[(0,r.jsx)("div",{className:"font-mono text-zinc-300",children:e.shopAvg>0?(0,l.Z)(e.shopAvg):"-"}),e.shopMultiple>0&&(0,r.jsxs)("div",{className:"flex flex-col gap-1 mt-1.5 w-[80px] ml-auto",children:[(0,r.jsx)("div",{className:"h-1 bg-zinc-800 rounded-full overflow-hidden w-full",children:(0,r.jsx)("div",{className:"h-full bg-violet-600 rounded-full",style:{width:`${Math.min(e.shopMultiple/a*100,100)}%`}})}),(0,r.jsxs)("div",{className:"text-[10px] text-right text-violet-400 font-medium",children:[e.shopMultiple.toFixed(2),"x"]})]})]}),(0,r.jsxs)("td",{className:"px-4 py-3 text-right",children:[(0,r.jsx)("div",{className:"font-mono text-zinc-300",children:e.officeAvg>0?(0,l.Z)(e.officeAvg):"-"}),e.officeMultiple>0&&(0,r.jsxs)("div",{className:"flex flex-col gap-1 mt-1.5 w-[80px] ml-auto",children:[(0,r.jsx)("div",{className:"h-1 bg-zinc-800 rounded-full overflow-hidden w-full",children:(0,r.jsx)("div",{className:"h-full bg-cyan-600 rounded-full",style:{width:`${Math.min(e.officeMultiple/s*100,100)}%`}})}),(0,r.jsxs)("div",{className:"text-[10px] text-right text-cyan-400 font-medium",children:[e.officeMultiple.toFixed(2),"x"]})]})]})]},t))})]})})}var m=a(89733);function p({data:e,visibleSections:t=["stats","comparison","chart"],comparisonExpandAll:a=!1}){let[n,c]=(0,s.useState)("weighted"),[o,p]=(0,s.useState)(30),[u,g]=(0,s.useState)(150),[f,b]=(0,s.useState)(5),[j,y]=(0,s.useState)("count"),v=s.useRef(null),N=s.useRef(null),w=s.useRef(null),z=e?.transactionDetails||[],k=e?.unitPriceAnalysis,S=k?.residentialStats,P=k?.officeStats,M=k?.storeStats,A=k?.typeComparison;return e&&(z.length||k)?(0,r.jsxs)("div",{className:"space-y-8 animate-in fade-in slide-in-from-bottom-4 duration-500",children:[t.includes("stats")&&(0,r.jsx)(i.c,{title:"各用途單價統計",containerRef:v,headerAction:(0,r.jsxs)("div",{className:"flex items-center gap-4",children:[(0,r.jsxs)("div",{className:"flex items-center gap-2",children:[(0,r.jsx)("span",{className:"text-zinc-400 text-xs",children:"平均類型:"}),(0,r.jsxs)("div",{className:"flex bg-zinc-950/50 rounded-md p-1 border border-white/5",children:[(0,r.jsx)("button",{onClick:()=>c("arithmetic"),className:(0,l.cn)("px-2 py-0.5 text-[10px] rounded transition-colors","arithmetic"===n?"bg-violet-500 text-white":"text-zinc-500 hover:text-white"),children:"算術"}),(0,r.jsx)("button",{onClick:()=>c("weighted"),className:(0,l.cn)("px-2 py-0.5 text-[10px] rounded transition-colors","weighted"===n?"bg-violet-500 text-white":"text-zinc-500 hover:text-white"),children:"加權"})]})]}),(0,r.jsx)(m.N,{data:[S,P,M],filename:"unit_price_stats",label:"匯出",chartType:"unit-price-stats",targetRef:v,snapshotData:{residentialStats:S,officeStats:P,storeStats:M,averageType:n}})]}),children:(0,r.jsxs)("div",{className:"grid grid-cols-1 md:grid-cols-3 gap-6",children:[(0,r.jsx)(x,{title:"住宅建案統計",stats:S,noDataMessage:"無住宅交易數據",className:"border-violet-500/20",averageType:n}),(0,r.jsx)(x,{title:"一般事務所/辦公室統計",stats:P,noDataMessage:"無事務所/辦公室交易數據",className:"border-cyan-500/20",averageType:n}),(0,r.jsx)(x,{title:"店舖統計",stats:M,noDataMessage:"無店舖交易數據",className:"border-amber-500/20",averageType:n})]})}),(0,r.jsxs)("div",{className:"flex flex-col lg:flex-row gap-6 items-stretch",children:[t.includes("comparison")&&A&&A.length>0&&(0,r.jsx)("div",{className:"flex-1 min-w-0 flex flex-col",children:(0,r.jsx)(i.c,{title:"建案產品類型單價比較",description:"同一建案內不同用途（住宅/店面/事務所）的單價與倍數比較",containerRef:N,headerAction:(0,r.jsx)(m.N,{data:A,filename:"type_comparison_data",label:"匯出",chartType:"type-comparison-table",targetRef:N,snapshotData:A,columns:{projectName:"建案",residentialAvg:"住宅均價",officeAvg:"辦公均價",storeAvg:"店舖均價",officeRatio:"辦公倍數",storeRatio:"店舖倍數"}}),className:"h-full",children:(0,r.jsx)(h,{data:A,expandAll:a})})}),t.includes("chart")&&(0,r.jsx)("div",{className:"flex-1 min-w-0 flex flex-col",children:(0,r.jsx)(i.c,{title:"單價分佈泡泡圖",description:"分析各單價區間的成交熱度與分佈密集區",containerRef:w,headerAction:(0,r.jsx)(m.N,{data:z,filename:"bubble_chart_source_data",label:"匯出",chartType:"unit-price-bubble",targetRef:w,snapshotData:z}),className:"h-full",children:(0,r.jsx)(d,{data:z,minPrice:o,maxPrice:u,interval:f,sizeMetric:j,onMinPriceChange:p,onMaxPriceChange:g,onIntervalChange:b,onSizeMetricChange:y})})})]})]}):null}},27529:(e,t,a)=>{a.d(t,{FH:()=>l});var r=a(16385),s=a(55873);async function i(){let{data:{session:e}}=await r.N.auth.getSession();return{"Content-Type":"application/json",apikey:s.m5,Authorization:`Bearer ${e?.access_token||s.m5}`}}async function n(e){let t=await i(),a=await fetch(s.Sn.RANKING_ANALYSIS,{method:"POST",headers:t,body:JSON.stringify({filters:e})});if(!a.ok)throw Error((await a.json().catch(()=>({error:`Analysis request failed: ${a.status}`}))).error||"Analyze data failed");return a.json()}let l={checkAuth:async function(){let{data:{session:e}}=await r.N.auth.getSession();e||console.log("User not logged in, but allowing access.")},getUser:async function(){let{data:{user:e}}=await r.N.auth.getUser();return e},signOut:async function(){let{error:e}=await r.N.auth.signOut();if(e)throw console.error("Sign out failed:",e),e},fetchData:async function(e,t){let a=await i(),r=await fetch(s.Sn.QUERY_DATA,{method:"POST",headers:a,body:JSON.stringify({filters:e,pagination:t})});if(!r.ok)throw Error((await r.json().catch(()=>({error:"Failed to parse server response"}))).error||"Fetch data failed");return r.json()},analyzeData:n,analyzeProjectRanking:n,fetchSubData:async function(e,t,a){if(!e||!t||!a)throw Error(`Insufficient parameters: ${e}, ${t}, ${a}`);let r=await i(),n=await fetch(s.Sn.SUB_DATA,{method:"POST",headers:r,body:JSON.stringify({id:e,type:t,county:a})});if(!n.ok)throw Error((await n.json().catch(()=>({error:"Failed to fetch sub data"}))).error||"Fetch sub data failed");return n.json()},fetchProjectNameSuggestions:async function(e,t,a=[]){let r=await i(),n=t.replace(/\u3127/g,"一"),l=await fetch(s.Sn.PROJECT_NAMES,{method:"POST",headers:r,body:JSON.stringify({countyCode:e,query:n,districts:a,detailed:!0})});if(!l.ok)throw Error(`Server error: ${l.status}`);return l.json()},getAdminUsers:async function(){let e=await i(),t=await fetch(s.Sn.GET_USERS,{method:"POST",headers:e,body:JSON.stringify({})});if(!t.ok)throw Error((await t.json().catch(()=>({error:"Failed to fetch users"}))).error||"Fetch users failed");return t.json()},getUserActivity:async function(e,t=200,a=0){let r=await i(),n=await fetch(s.Sn.GET_USER_ACTIVITY,{method:"POST",headers:r,body:JSON.stringify({userId:e,limit:t,offset:a})});if(!n.ok)throw Error((await n.json().catch(()=>({error:"Failed to fetch user activity"}))).error||"Fetch user activity failed");return n.json()},getActivityStats:async function(){let e=await i(),t=await fetch(s.Sn.GET_ACTIVITY_STATS,{method:"POST",headers:e,body:JSON.stringify({})});if(!t.ok)throw Error((await t.json().catch(()=>({error:"Failed to fetch activity stats"}))).error||"Fetch activity stats failed");return t.json()},validateReferralCode:async function(e){let t=await i();return(await fetch(s.Sn.VALIDATE_REFERRAL_CODE,{method:"POST",headers:t,body:JSON.stringify({code:e})})).json()},activateSubscription:async function(e){let t=await i(),a=await fetch(s.Sn.ACTIVATE_SUBSCRIPTION,{method:"POST",headers:t,body:JSON.stringify(e)});if(!a.ok)throw Error((await a.json().catch(()=>({error:"Activation failed"}))).error||"Activation failed");return a.json()},bindReferralCode:async function(e){let t=await i(),a=await fetch(s.Sn.BIND_REFERRAL_CODE,{method:"POST",headers:t,body:JSON.stringify("string"==typeof e?{code:e}:e)});if(!a.ok)throw Error((await a.json().catch(()=>({error:"Failed to bind referral code"}))).error||"Failed to bind referral code");return a.json()},clearReferralCode:async function(){let e=await i(),t=await fetch(s.Sn.BIND_REFERRAL_CODE,{method:"POST",headers:e,body:JSON.stringify({action:"clear"})});if(!t.ok)throw Error((await t.json().catch(()=>({error:"Failed to clear referral code"}))).error||"Failed to clear referral code");return t.json()},getReferralDashboard:async function(){let e=await i(),t=await fetch(s.Sn.GET_REFERRAL_DASHBOARD,{method:"POST",headers:e,body:JSON.stringify({})});if(!t.ok)throw Error((await t.json().catch(()=>({error:"Failed to fetch referral data"}))).error||"Fetch referral dashboard failed");return t.json()},consumeReferralFeature:async function(e,t="consume"){let a=await i(),r=await fetch(s.Sn.CONSUME_REFERRAL_FEATURE,{method:"POST",headers:a,body:JSON.stringify({feature:e,mode:t})});if(!r.ok){let e=await r.json().catch(()=>({error:"Failed to consume feature"}));throw Error(e.error||e.reason||"Failed to consume feature")}return r.json()}}},29991:(e,t,a)=>{a.d(t,{l:()=>l});var r=a(95155),s=a(12115),i=a(40980),n=a(66088);let l=s.forwardRef(({className:e,children:t,...a},s)=>(0,r.jsxs)("div",{className:"relative",children:[(0,r.jsx)("select",{className:(0,i.cn)("flex h-10 w-full appearance-none rounded-md border border-input bg-zinc-950/50 px-3 py-2 text-sm text-zinc-100 ring-offset-background focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2 disabled:cursor-not-allowed disabled:opacity-50 pr-8",e),ref:s,...a,children:t}),(0,r.jsx)(n.A,{className:"absolute right-3 top-2.5 h-4 w-4 opacity-50 pointer-events-none"})]}));l.displayName="Select"},30327:(e,t,a)=>{a.d(t,{A:()=>S});var r=a(95155),s=a(12115),i=a(81477),n=a(18460),l=a(40980);let c=(0,n.F)("inline-flex items-center rounded-full border px-2.5 py-0.5 text-xs font-semibold transition-colors focus:outline-none focus:ring-2 focus:ring-ring focus:ring-offset-2",{variants:{variant:{default:"border-transparent bg-primary text-primary-foreground hover:bg-primary/80",secondary:"border-transparent bg-secondary text-secondary-foreground hover:bg-secondary/80",destructive:"border-transparent bg-destructive text-destructive-foreground hover:bg-destructive/80",outline:"text-foreground"}},defaultVariants:{variant:"default"}});function o({className:e,variant:t,...a}){return(0,r.jsx)("div",{className:(0,l.cn)(c({variant:t}),e),...a})}let d=[{id:"p-2012-08-01",date:"2012-08-01",title:"實價登錄 1.0 上路",category:"policy",impact:"high",description:"交易後30日內申報，區段化揭露(30號區間)，預售屋採代銷結案後整批申報。",change_content:"交易資訊不透明 -> 區段化揭露",affected_scope:"房仲業者、買賣雙方、預售屋投機客",background:"低利環境延續：國內房貸利率處於低檔 (約1.8%-1.9%)。",impact_analysis:"[受益] 買方獲得參考依據。[適應] 房仲失去資訊壟斷優勢。[無感] 預售屋投機客因資訊未即時揭露，仍可操作紅單。",details:["申報義務人：地政士、經紀業或權利人。","申報時機：買賣案件於辦竣所有權移轉登記後30日內申報。","揭露方式：以區段化、去識別化方式提供查詢 (例如：中正路1-30號)。","預售屋規定：委託代銷者，於委託代銷契約屆滿或終止30日內「整批」申報 (資訊落後嚴重)。"]},{id:"p-2014-06-04",date:"2014-06-04",title:"囤房稅 1.0",category:"policy",impact:"medium",description:"非自住住家用稅率由1.2%-2%調高為1.5%-3.6%，授權地方政府自訂差別稅率。",change_content:"非自住稅率 1.2% -> 1.5%~3.6%",affected_scope:"多屋族、台北市置產客",background:"美國聯準會結束QE：預期升息心理浮現，全球資金派對暫歇。",impact_analysis:"[微痛] 持有成本上升，但因多數縣市未採最高稅率，且稅基(房屋評定現值)偏低，實質痛感有限。",details:["自住房屋稅率：維持 1.2% (需本人、配偶或直系親屬實際居住，且全國合計3戶以內)。","非自住房屋稅率：由 1.2%~2% 調升至 1.5%~3.6%。","地方權限：各地方政府可視地方發展需要，在範圍內自訂差別稅率。","持有認定：以個人(自然人)或法人(公司)為單位個別計算。"]},{id:"p-2016-01-01",date:"2016-01-01",title:"房地合一稅 1.0",category:"policy",impact:"high",description:"獲利課稅取代舊制。持有<1年45%，1-2年35%，自用滿6年獲利400萬免稅。奢侈稅同步停徵。",change_content:"按售價課稅(奢侈稅) -> 按獲利課稅(45%~15%)",affected_scope:"短線炒作客、自住客",background:"奢侈稅同步停徵：象徵房市進入「實價課稅」新紀元。",impact_analysis:"[毀滅] 短進短出獲利被腰斬，投資客大量退場。[受益] 房價盤整，自住客獲得較佳議價空間。",details:["課稅基礎：房地交易所得 = 交易成交價額 - 原始取得成本 - 相關費用 - 土地漲價總數額。","持有1年以內：稅率 45%。","持有1-2年：稅率 35%。","持有2-10年：稅率 20%。","持有超過10年：稅率 15%。","自用住宅優惠：獲利400萬元以下免稅，超過部分10%。(需連續設籍滿6年)","日出條款：2016年1月1日以後取得之房地適用新制。"]},{id:"f-2016-03-24",date:"2016-03-24",title:"央行大幅鬆綁信用管制",category:"finance",impact:"high",description:"刪除特定地區管制與自然人第3戶以上限制，僅保留豪宅管制(6成)。",change_content:"刪除多數管制，僅保留豪宅限貸",affected_scope:"換屋族、一般投資客",background:"經濟成長疲弱：為提振內需經濟，央行解除長達6年的房市管制。",impact_analysis:"[受益] 貸款成數恢復，換屋與置產門檻降低，市場交易量逐漸回溫。",details:["解除管制區域：台北市及新北市特定地區。","解除限制對象：自然人第3戶以上購屋貸款、公司法人購屋貸款。","保留限制：高價住宅(豪宅)貸款最高成數仍維持6成。"]},{id:"p-2018-06-27",date:"2018-06-27",title:"租賃住宅市場發展及管理條例",category:"policy",impact:"low",description:"建立包租代管機制，鼓勵房東釋出空屋，給予稅賦優惠(所得稅減免)。",change_content:"包租代管稅賦優惠",affected_scope:"房東、租屋族",background:"美中貿易戰開打：全球供應鏈重組，資金開始撤離中國。",impact_analysis:"[受益] 房東享有所得稅減免；租屋族獲得專業代管服務，租賃關係較有保障。",details:["租稅優惠：個人房東委託包租代管，月租金6000元以下免稅；6000-20000元必要費用率53%。","專業證照：建立租賃住宅管理人員證照制度。","糾紛處理：建立租賃糾紛免費調處機制。"]},{id:"f-2019-08-15",date:"2019-08-15",title:"境外資金匯回專法",category:"finance",impact:"medium",description:"鼓勵台商資金回流享優惠稅率，禁止直接投資房地產，但產生外溢效應帶動豪宅與工業地產。",change_content:"資金專法回流 (禁入房市但有外溢)",affected_scope:"工業地產主、豪宅建商",background:"台商回流潮：史上最大規模資金回台，雖禁入房市，但產生外溢效應。",impact_analysis:"[暴富] 工業用地與廠房價格飆漲。[受益] 企業主獲利與分紅轉入豪宅市場，帶動高總價產品去化。",details:["優惠稅率：第一年匯回稅率8%，第二年10%。(實質投資可退稅一半)","投資限制：禁止資金直接投資房地產(避免炒房)。","資金控管：資金需存入專戶，控管5-7年才能分批提取。","外溢效應：雖然不能直接買房，但增加市場資金總量，且企業獲利後的分紅仍可自由運用。"]},{id:"f-2020-03-19",date:"2020-03-19",title:"央行降息 1 碼",category:"finance",impact:"high",description:"重貼現率降至1.125%，房貸利率跌破1.4%歷史新低，無限QE背景下引發資產通膨。",change_content:"重貼現率 1.375% -> 1.125%",affected_scope:"全體購屋族、股市投資人",background:"COVID-19 疫情爆發：美國聯準會無限QE，全球熱錢氾濫。",impact_analysis:"[刺激] 持有成本極低，「租不如買」與「買房抗通膨」心理大爆發，股房雙漲。",details:["降息幅度：調降重貼現率 0.25個百分點。","房貸利率：五大銀行新承做房貸利率跌破 1.4%，創歷史新低。","配套補貼：針對受疫情影響產業及自用住宅貸款提供額外補貼。"]},{id:"f-2020-12-08",date:"2020-12-08",title:"央行信用管制 (第一波)",category:"finance",impact:"medium",description:"法人購屋限貸6成，自然人第3戶限貸6成，建商餘屋限貸5成。",change_content:"法人/第3戶/餘屋 限貸 5-6成",affected_scope:"公司法人、多屋族(3戶+)",background:"房市過熱跡象：紅單炒作猖獗，排隊買房現象頻傳。",impact_analysis:"[警示] 宣示政府打炒房決心，但因低利環境，實質殺傷力有限。",details:["公司法人：第一戶貸款成數最高 6成，無寬限期。","自然人第3戶(含)以上：貸款成數最高 6成，無寬限期。","購地貸款：限貸 6.5成，需保留 1成動工款。","餘屋貸款：限貸 5成。"]},{id:"f-2021-03-19",date:"2021-03-19",title:"央行信用管制 (第二波)",category:"finance",impact:"medium",description:"法人購屋成數降至4成，豪宅降至5.5成。",change_content:"法人限貸 4成；豪宅限貸 5.5成",affected_scope:"公司法人、豪宅客",background:"投機風氣未減",impact_analysis:"[打擊] 封鎖利用公司名義高槓桿炒房的途徑。",details:["公司法人：貸款成數調降至 4成。","自然人高價住宅：第1戶限貸 5.5成，第3戶以上限貸 4成。","工業區閒置土地：貸款最高 5.5成。"]},{id:"p-2021-07-01",date:"2021-07-01",title:"實價登錄 2.0 & 房地合一 2.0",category:"policy",impact:"high",description:"門牌完整揭露，預售屋即時申報(30日)，禁止紅單轉售；重稅期延長(45%改2年, 35%改5年)，預售屋納稅。",change_content:"預售屋納管、重稅閉鎖期延長、禁紅單",affected_scope:"預售屋買方/投機客、建商、換屋族",background:"房市多頭確立；疫情三級警戒(內需停滯但房市創高)",impact_analysis:"[雙面刃] 資訊全透明反成定錨工具。[閉鎖] 投機客無法短進短出，成屋惜售供給減少，價格難跌。",details:["實價登錄2.0：門牌號碼完整揭露 (不再區段化)。","預售屋納管：銷售前需備查，簽約後30日內申報實價登錄。","紅單禁止：禁止預售屋紅單轉售。","房地合一2.0：預售屋獲利納入房地合一稅課徵。","延長重稅期：持有2年內45%，2-5年35% (原為1-2年)。","法人比照：法人交易比照自然人稅率 (防堵公司名義短期炒作)。"]},{id:"f-2021-09-24",date:"2021-09-24",title:"央行信用管制 (第三波)",category:"finance",impact:"medium",description:"特定地區 (六都+新竹) 第2戶取消寬限期。",change_content:"特定地區第2戶 取消寬限期",affected_scope:"投資客、換屋族",background:"房價持續攀升",impact_analysis:"[壓力] 買第2間房必須立刻還本金，增加現金流壓力，迫使部分槓桿過大者退場。",details:["管制區域：新增特定地區 (六都 + 新竹縣市)。","自然人第2戶：取消寬限期 (需本息攤還)。","購地貸款：調降至 6成。","工業區閒置土地：調降至 5成。"]},{id:"f-2021-12-17",date:"2021-12-17",title:"央行信用管制 (第四波)",category:"finance",impact:"medium",description:"豪宅貸款降至4成，第3戶降至4成，餘屋貸款降至4成。",change_content:"豪宅/第3戶/餘屋 限貸 4成",affected_scope:"建商、豪宅客",background:"營建成本飆漲：缺工缺料議題發酵。",impact_analysis:"[緊縮] 建商資金鏈趨緊，中小型建商生存困難，市場走向大者恆大。",details:["自然人高價住宅：貸款成數一律降至 4成 (無寬限期)。","自然人第3戶(含)以上：貸款成數一律降至 4成。","購地貸款：降至 5成。","餘屋貸款：降至 4成。"]},{id:"f-2022-03-17",date:"2022-03-17",title:"央行升息循環啟動",category:"finance",impact:"medium",description:"央行跟進Fed升息(全年共2.5碼)，房貸利率重回2%以上。",change_content:"升息 2.5碼 (利率重回 2% table+)",affected_scope:"房貸族",background:"全球通膨危機：美國暴力升息，全球股市修正。",impact_analysis:"[負擔增加] 每千萬房貸每年利息支出增加約3-4萬元，稍微冷卻追價意願。",details:["2022-03：升息 1碼 (0.25%)。","2022-06：升息 半碼 (0.125%)。","2022-09：升息 半碼 (0.125%)。","2022-12：升息 半碼 (0.125%)。","存款準備率：同步調升，緊縮市場游資。"]},{id:"f-2023-06-16",date:"2023-06-16",title:"央行信用管制 (第五波)",category:"finance",impact:"medium",description:"特定地區第2戶限貸成數上限 7成。",change_content:"特定地區第2戶 限貸 7成",affected_scope:"換屋族、投資客",background:"房市量縮價穩：市場觀望平均地權條例上路。",impact_analysis:"[微痛] 需多準備1成自備款，影響尚可控。",details:["管制區域：特定地區 (六都 + 新竹縣市)。","自然人第2戶：新增貸款成數上限 7成 (此前僅無寬限期)。"]},{id:"p-2023-07-01",date:"2023-07-01",title:"平均地權條例修正",category:"policy",impact:"high",description:"預售屋禁止換約轉售，建立檢舉獎金，私法人購屋許可制。",change_content:"預售屋禁換約、私法人許可制",affected_scope:"預售屋黃牛、豪宅法人",background:"投機客的大限",impact_analysis:"[滅絕] 純粹賺價差的紅單與換約客徹底消失。豪宅市場因法人需經許可，交易量急凍。",details:["限制換約轉售：預售屋與新建成屋簽約後，除配偶、直系或二親等旁系外，不得讓與或轉售 (禁止黃牛)。","重罰炒作：嚴懲散播不實資訊影響房價，最高罰5000萬元。","檢舉獎金：建立檢舉實名制，獎金為罰鍰 30%。","私法人購屋許可制：私法人購買住宅用房屋需經內政部許可 (限制豪宅私法人節稅管道)。"]},{id:"p-2023-08-01",date:"2023-08-01",title:"新青安貸款專案",category:"policy",impact:"high",description:"額度1000萬，年限40年，寬限期5年，利率補貼(1.775%起)。",change_content:"40年期/5年寬限/降息補貼",affected_scope:"首購族、投機客(人頭)、低總價屋主",background:"總統大選前夕：政府釋出利多，試圖減輕年輕人負擔。",impact_analysis:"[狂熱] 創造「租不如買」與「5年免還本」的套利空間。低總價成屋被掃貨，房價逆勢暴漲。",details:["貸款額度：提高至 1000萬元。","利息補貼：政府補貼 1.5碼 (0.375%) + 公股銀行減半碼 = 利率 1.775% 起。","貸款年限：延長至 40年。","寬限期：延長至 5年 (只繳息不還本)。","資格：本人、配偶及未成年子女名下均無自有住宅。"]},{id:"f-2024-06-14",date:"2024-06-14",title:"央行信用管制 (第六波)",category:"finance",impact:"medium",description:"特定地區第2戶限貸成數降至 6成。",change_content:"特定地區第2戶 限貸 6成",affected_scope:"換屋族、置產客",background:"台股站上2萬點：AI熱潮帶動股市財富效應，資金外溢至房市。",impact_analysis:"[無效] 股市獲利豐厚，6成限貸無法阻擋資金湧入房市。",details:["管制區域：特定地區 (六都 + 新竹縣市)。","自然人第2戶：貸款成數上限由 7成調降為 6成。","調升存款準備率：調升 0.25個百分點 (收回市場資金)。"]},{id:"p-2024-07-01",date:"2024-07-01",title:"囤房稅 2.0 實施",category:"policy",impact:"medium",description:"全國歸戶，非自用稅率調高至 2.0%-4.8%，建商餘屋依持有年限課稅。",change_content:"全國歸戶；稅率 2.0%~4.8%",affected_scope:"多屋族、租屋族、建商",background:"租金指數創高",impact_analysis:"[轉嫁] 多屋族將稅負轉嫁至租金，導致租金上漲。建商面臨餘屋去化壓力，傾向預售完銷。",details:["全國歸戶：由縣市歸戶改為全國歸戶計算戶數。","稅率調升：非自住住家用稅率調升為 2%~4.8% (原1.5%~3.6%)。","單一自住優惠：全國單一自住(本人配偶子女僅一戶)且房屋現值在一定金額以下，稅率降至 1%。","建商餘屋：持有2年以內稅率 2%~3.6%；超過2年稅率 2%~4.8% (鼓勵釋出餘屋)。"]},{id:"f-2024-08-01",date:"2024-08-01",title:"銀行限貸令 (72-2水位)",category:"finance",impact:"high",description:"銀行法72-2條逼近30%上限，自主限貸、排隊撥款，市場流動性急凍。",change_content:"銀行自主限貸、排隊撥款",affected_scope:"即將交屋族、賣屋換屋族",background:"新青安效應發酵：過多成屋交易與新青安撥款，耗盡銀行額度。",impact_analysis:"[恐慌] 買了房卻貸不到款，面臨違約風險。市場流動性瞬間急凍。",details:["銀行法72-2條：商業銀行辦理住宅建築及企業建築放款總額，不得超過存款總餘額及金融債券發售額之 30%。","現象：多家銀行房貸水位接近滿載。","影響：銀行暫停收件、排隊撥款(需等數月)、利率大幅調升(2.6%-3%以上)。"]},{id:"f-2024-09-20",date:"2024-09-20",title:"央行信用管制 (第七波)",category:"finance",impact:"high",description:"有房者第1戶無寬限期；全國第2戶限貸5成；法人/豪宅/第3戶限貸3成。",change_content:"有房者第1戶無寬限；第2戶全國限貸5成",affected_scope:"換屋族、繼承族、交屋族",background:"金龍海嘯：央行判定房市過熱，認為新青安助長投機，決心斷絕金流。",impact_analysis:"[重傷/錯殺] 史上最嚴厲管制。1. 換屋族需5成自備。2. 繼承祖產失寬限。3. 預售交屋斷頭風險大增。",details:["自然人第1戶：名下有房屋者(含繼承、持分)，第1戶購屋貸款「無寬限期」。","自然人第2戶：貸款成數上限降至 5成，且擴及「全國」。","自然人第3戶以上：貸款成數上限降至 3成。","公司法人：購屋貸款成數降至 3成。","豪宅(高價住宅)：貸款成數降至 3成。","餘屋貸款：降至 3成。","存款準備率：再調升 0.25個百分點。"]}];var x=a(30122),h=a(85753),m=a(68822),p=a(44071),u=a(9921),g=a(66088),f=a(57420),b=a(69220),j=a(22651),y=a(64479),v=a(9505),N=a(89733),w=a(72264),z=a(60529),k=a(33807);function S({data:e}){let t=(0,s.useMemo)(()=>{if(!e)return[];let t=new Set;return e.forEach(e=>{e["建案名稱"]&&t.add(e["建案名稱"])}),Array.from(t).map(e=>({value:e,label:e}))},[e]),[a,n]=(0,s.useState)([]),[c,S]=(0,s.useState)(null),[P,M]=(0,s.useState)(null),A=[{label:"2年/行",yearsPerRow:2},{label:"1年/行",yearsPerRow:1},{label:"6月/行",yearsPerRow:.5},{label:"3月/行",yearsPerRow:.25}],[C,_]=(0,s.useState)(0),$=A[C],F=$.yearsPerRow,[E,R]=(0,s.useState)(!1),[T,I]=(0,s.useState)(null),[L,D]=(0,s.useState)({}),[O,B]=(0,s.useState)(!0),[W,U]=(0,s.useState)(!0),[H,q]=(0,s.useState)(null),[Y,Z]=(0,s.useState)(null),V=(0,s.useMemo)(()=>{if(0===a.length||!e||0===e.length)return[];let t={};return e.forEach(e=>{let r=e["建案名稱"];if(!r||!a.includes(r))return;let s=new Date(e["交易日"]).getTime();isNaN(s)||(t[r]||(t[r]=[]),t[r].push(s))}),Object.entries(t).map(([e,t])=>{let a=Math.min(...t),r=Math.max(...t);return{name:e,start:new Date(a),end:new Date(r),startStr:new Date(a).toISOString().slice(0,10),endStr:new Date(r).toISOString().slice(0,10),count:t.length}}).sort((e,t)=>e.start.getTime()-t.start.getTime()).slice(0,10)},[e,a]),G=(0,s.useMemo)(()=>{let e=H??2012,t=new Date().getFullYear();if(V.length>0&&(t=Math.max(t,Math.max(...V.map(e=>e.end.getFullYear()))+1)),null!==Y)t=Y;else{let e=new Date().getFullYear();t=t>e?Math.max(e,t):e}return{start:new Date(`${e}-01-01`),end:new Date(`${t}-12-31`),totalMonths:(t-e+1)*12}},[V,H,Y]),J=[16,-16,32,-32],X=G.start.getFullYear(),K=Math.ceil((G.end.getFullYear()-X+1)/F),Q=(0,s.useMemo)(()=>Array.from({length:K}).map((e,t)=>{let a=t*F,r=(t+1)*F,s=new Date(X,0,1),i=new Date(X,0,1),n=Math.floor(12*a),l=Math.floor(12*r);s.setMonth(s.getMonth()+n),i.setMonth(i.getMonth()+l);let c=new Date(i);return c.setDate(c.getDate()-1),{startYear:s.getFullYear(),endYear:c.getFullYear(),startStr:s.toISOString().slice(0,7),endStr:c.toISOString().slice(0,7),start:s,end:i}}),[K,F,X]),ee=24*(V.length>0),et=(0,s.useMemo)(()=>{if(null===T||T<0||T>=Q.length)return null;let e=Q[T],t=e.start.getTime(),a=e.end.getTime(),r=a-t,s=V.filter(e=>Math.max(e.start.getTime(),t)<Math.min(e.end.getTime(),a)),i=[],n=s.map((e,s)=>{let n=Math.max(e.start.getTime(),t),l=Math.min(e.end.getTime(),a),c=i.findIndex(e=>e<n);-1===c?(c=i.length,i.push(l)):i[c]=l;let o=(l-n)/r*100;return{...e,laneIndex:c,startPct:(n-t)/r*100,widthPct:o,originalIndex:s}});return{maxLanes:i.length,items:n}},[T,Q,V]),ea=(0,s.useMemo)(()=>Array.from({length:K}).map((e,t)=>t===T&&et?Math.max(72,116+36*et.maxLanes):72),[K,T,et]),er=(0,s.useMemo)(()=>{let e=24;return ea.map(t=>{let a=e;return e+=t,a})},[ea]),es=ea.reduce((e,t)=>e+t,0),ei=Math.max(24+es+80,24+es+ee+36*V.length+60),en=(0,s.useMemo)(()=>d.filter(e=>{let t=new Date(e.date);return!!(t>=G.start&&t<=G.end)&&("finance"!==e.category||!!O)&&("policy"!==e.category||!!W)}),[G,O,W]),el=(0,s.useMemo)(()=>{let e=Array.from({length:K},()=>[]);en.forEach((t,a)=>{let r=new Date(t.date),s=Q.findIndex(e=>r>=e.start&&r<e.end);s<0&&(r.getTime(),Q[Q.length-1].end.getTime(),s=K-1),e[s].push({index:a,date:r})});let t=Array(en.length),a=e=>Math.min(.6,Math.max(0,e/365*.18));return e.forEach((e,r)=>{if(e.sort((e,t)=>e.date.getTime()-t.date.getTime()),0===e.length)return;let s=0;for(let t=1;t<e.length;t+=1)s+=a(Math.max(0,(e[t].date.getTime()-e[t-1].date.getTime())/864e5));let i=e.length+s,n=0,l=[-999,-999,-999,-999];e.forEach((s,c)=>{if(c>0){let t=Math.max(0,(s.date.getTime()-e[c-1].date.getTime())/864e5);n+=a(t)}n+=1;let o=i>0?(n-.5)/i:0,d=100*o,x=d-6,h=-1;for(let e=0;e<4;e++)if(l[e]+2<x){h=e;break}-1===h&&(h=l.indexOf(Math.min(...l))),l[h]=d+6,t[s.index]={rowIndex:r,posInRow:c,densityPos:o,laneIndex:h}})}),t},[en,Q,K]),ec=(0,s.useMemo)(()=>en.slice().reverse().map(e=>({日期:e.date,標題:e.title,類別:"finance"===e.category?"金融":"政策",影響:e.impact,變革內容:e.change_content,影響對象:e.affected_scope})),[en]),eo=c&&P&&P.id!==c.id?P:null,ed=!!eo,ex=e=>{if(E&&c){e.id===c.id?M(null):M(e),R(!1);return}S(e),P?.id===e.id&&M(null)},eh=()=>{c&&eo&&(S(eo),M(c))},em=(e,t)=>{let a=!!L[e.id],s="primary"===t;return(0,r.jsx)("div",{className:"border border-white/10 bg-black/45 backdrop-blur-lg p-6 rounded-xl animate-in fade-in slide-in-from-top-4 shadow-2xl shadow-black/50",children:(0,r.jsxs)("div",{className:"flex flex-col gap-6",children:[(0,r.jsxs)("div",{className:"flex items-start justify-between border-b border-white/5 pb-4",children:[(0,r.jsxs)("div",{className:"space-y-2",children:[(0,r.jsxs)("div",{className:"flex items-center gap-2",children:[(0,r.jsx)("span",{className:(0,l.cn)("text-[10px] uppercase tracking-wider px-2 py-0.5 rounded border",s?"border-cyan-500/40 text-cyan-300 bg-cyan-500/10":"border-emerald-500/40 text-emerald-300 bg-emerald-500/10"),children:s?"主事件":"對照事件"}),(0,r.jsx)("span",{className:"text-zinc-400 font-mono text-xs",children:e.date})]}),(0,r.jsx)("div",{className:"flex items-center gap-3",children:(0,r.jsx)(o,{variant:"outline",className:(0,l.cn)("text-sm px-3 py-1","finance"===e.category?"bg-emerald-500/10 text-emerald-400 border-emerald-500/30":"bg-rose-500/10 text-rose-400 border-rose-500/30"),children:"finance"===e.category?"金融事件":"房市政策"})}),(0,r.jsx)("h3",{className:"text-2xl font-bold text-white tracking-tight",children:e.title})]}),(0,r.jsxs)("div",{className:"flex flex-col items-end gap-2",children:[(0,r.jsxs)("div",{className:(0,l.cn)("px-3 py-1 rounded-full text-xs font-medium border","high"===e.impact?"bg-red-500/10 text-red-400 border-red-500/30":"bg-yellow-500/10 text-yellow-400 border-yellow-500/30"),children:["影響程度: ","high"===e.impact?"高":"medium"===e.impact?"中":"低"]}),s?(0,r.jsxs)("div",{className:"flex items-center gap-2",children:[ed&&(0,r.jsx)("button",{onClick:eh,className:"text-[11px] px-2 py-1 rounded border border-white/10 text-zinc-300 hover:text-white hover:border-white/30 transition-colors",children:"對調"}),ed?(0,r.jsx)("button",{onClick:()=>M(null),className:"text-[11px] px-2 py-1 rounded border border-white/10 text-zinc-300 hover:text-white hover:border-white/30 transition-colors",children:"清除對照"}):(0,r.jsx)("button",{onClick:()=>R(!0),className:"text-[11px] px-2 py-1 rounded border border-cyan-500/30 text-cyan-300 hover:text-white hover:border-cyan-400/60 transition-colors",children:"選對照事件"})]}):(0,r.jsx)("button",{onClick:()=>M(null),className:"text-[11px] px-2 py-1 rounded border border-white/10 text-zinc-300 hover:text-white hover:border-white/30 transition-colors",children:"移除對照"})]})]}),(0,r.jsxs)("div",{className:"grid grid-cols-1 gap-8",children:[(0,r.jsxs)("div",{className:"space-y-6",children:[(0,r.jsxs)("div",{children:[(0,r.jsxs)("h4",{className:"text-sm font-bold text-zinc-500 uppercase tracking-wider mb-2 flex items-center gap-2",children:[(0,r.jsx)(m.A,{className:"w-4 h-4"})," 政策/事件內容"]}),(0,r.jsx)("p",{className:"text-zinc-200 text-base leading-relaxed bg-black/40 p-4 rounded-lg border border-white/5",children:e.description})]}),(0,r.jsxs)("div",{children:[(0,r.jsxs)("h4",{className:"text-sm font-bold text-zinc-500 uppercase tracking-wider mb-2 flex items-center gap-2",children:[(0,r.jsx)(h.A,{className:"w-4 h-4"})," 具體規範變革"]}),(0,r.jsx)("div",{className:"bg-black/40 p-4 rounded-lg border border-white/5 text-cyan-400 font-medium",children:e.change_content||"無具體規範變更"})]})]}),(0,r.jsxs)("div",{className:"space-y-6",children:[(0,r.jsxs)("div",{children:[(0,r.jsxs)("h4",{className:"text-sm font-bold text-zinc-500 uppercase tracking-wider mb-2 flex items-center gap-2",children:[(0,r.jsx)(x.A,{className:"w-4 h-4"})," 時代背景與金融環境"]}),(0,r.jsx)("p",{className:"text-zinc-300 text-sm leading-relaxed bg-black/30 p-4 rounded-lg border border-white/5",children:e.background||"尚無背景資料"})]}),(0,r.jsxs)("div",{children:[(0,r.jsxs)("h4",{className:"text-sm font-bold text-zinc-500 uppercase tracking-wider mb-2 flex items-center gap-2",children:[(0,r.jsx)(p.A,{className:"w-4 h-4"})," 受眾影響分析"]}),(0,r.jsxs)("div",{className:"relative overflow-hidden rounded-lg border border-white/10 bg-gradient-to-br from-indigo-500/10 to-purple-500/10 p-4",children:[(0,r.jsx)("div",{className:"absolute top-0 right-0 p-2 opacity-10",children:(0,r.jsx)(p.A,{className:"w-24 h-24"})}),(0,r.jsxs)("div",{className:"relative z-10",children:[(0,r.jsxs)("p",{className:"text-indigo-300 font-medium mb-2 text-xs uppercase",children:["影響對象: ",e.affected_scope]}),(0,r.jsx)("p",{className:"text-white text-sm leading-relaxed",children:e.impact_analysis||"尚無詳細分析"})]})]})]})]})]}),e.details&&e.details.length>0&&(0,r.jsxs)("div",{className:"border-t border-white/5 pt-4",children:[(0,r.jsx)("button",{onClick:()=>{var t;return t=e.id,void D(e=>({...e,[t]:!e[t]}))},className:"flex items-center gap-2 text-sm text-zinc-400 hover:text-white transition-colors w-full justify-center py-2",children:a?(0,r.jsxs)(r.Fragment,{children:[(0,r.jsx)(u.A,{className:"w-4 h-4"})," 收起完整規範細節"]}):(0,r.jsxs)(r.Fragment,{children:[(0,r.jsx)(g.A,{className:"w-4 h-4"})," 展開完整規範細節 (",e.details.length," 項)"]})}),a&&(0,r.jsx)("div",{className:"mt-4 grid grid-cols-1 gap-4 animate-in fade-in slide-in-from-top-2",children:e.details.map((e,t)=>(0,r.jsxs)("div",{className:"flex items-start gap-3 bg-black/40 p-3 rounded border border-zinc-800 text-sm text-zinc-300",children:[(0,r.jsx)("span",{className:"flex items-center justify-center w-5 h-5 rounded-full bg-zinc-800 text-zinc-500 text-xs shrink-0 mt-0.5",children:t+1}),(0,r.jsx)("span",{children:e})]},t))})]})]})})};return(0,r.jsxs)(i.Zp,{className:"w-full bg-black/40 border-zinc-800 backdrop-blur-xl",children:[(0,r.jsxs)(i.aR,{children:[(0,r.jsxs)(i.ZB,{className:"flex items-center gap-2 text-xl font-bold text-transparent bg-clip-text bg-gradient-to-r from-cyan-400 to-purple-400",children:[(0,r.jsx)(f.A,{className:"w-6 h-6 text-cyan-500"}),"房市政策時光機"]}),(0,r.jsx)(i.BT,{className:"text-zinc-400",children:"建案銷售期間與重大政策/金融事件的交叉比對"})]}),(0,r.jsxs)(i.Wu,{children:[(0,r.jsxs)("div",{className:"flex flex-col md:flex-row items-start md:items-end justify-between mb-6 px-2 gap-4",children:[(0,r.jsx)("div",{className:"w-full md:w-1/2 lg:w-1/3",children:(0,r.jsx)(v.l,{projects:t,onChange:n,title:"選擇建案 (顯示銷售區間)",placeholder:"搜尋建案以顯示在時間軸...",max:6})}),(0,r.jsxs)("div",{className:"flex items-center justify-between w-full md:w-auto gap-4",children:[(0,r.jsxs)("div",{className:"flex items-center gap-2 bg-black/20 rounded-lg p-1 border border-white/5",children:[(0,r.jsx)("button",{onClick:()=>_(e=>Math.max(0,e-1)),disabled:0===C,className:"p-1.5 hover:bg-white/10 rounded-md text-zinc-400 hover:text-white transition-colors disabled:opacity-30",children:(0,r.jsx)(b.A,{className:"w-4 h-4"})}),(0,r.jsx)("span",{className:"text-xs font-mono text-zinc-500 w-16 text-center",children:$.label}),(0,r.jsx)("button",{onClick:()=>_(e=>Math.min(A.length-1,e+1)),disabled:C===A.length-1,className:"p-1.5 hover:bg-white/10 rounded-md text-zinc-400 hover:text-white transition-colors disabled:opacity-30",children:(0,r.jsx)(j.A,{className:"w-4 h-4"})})]}),(0,r.jsxs)(w.rI,{children:[(0,r.jsx)(w.ty,{asChild:!0,children:(0,r.jsx)("button",{className:"p-2 bg-black/20 hover:bg-white/10 border border-white/5 rounded-lg text-zinc-400 hover:text-white transition-colors",children:(0,r.jsx)(y.A,{className:"w-4 h-4"})})}),(0,r.jsxs)(w.SQ,{align:"end",className:"w-64 bg-zinc-950 border-zinc-800 text-zinc-200",children:[(0,r.jsx)(w.lp,{children:"顯示設定"}),(0,r.jsx)(w.mB,{className:"bg-zinc-800"}),(0,r.jsxs)(w.hO,{checked:W,onCheckedChange:U,className:"focus:bg-zinc-800 focus:text-white",children:[(0,r.jsx)("span",{className:"w-2 h-2 rounded-full bg-rose-500 mr-2"}),"房市政策"]}),(0,r.jsxs)(w.hO,{checked:O,onCheckedChange:B,className:"focus:bg-zinc-800 focus:text-white",children:[(0,r.jsx)("span",{className:"w-2 h-2 rounded-full bg-emerald-500 mr-2"}),"金融事件"]}),(0,r.jsx)(w.mB,{className:"bg-zinc-800"}),(0,r.jsx)(w.lp,{children:"時間範圍"}),(0,r.jsxs)("div",{className:"p-2 space-y-3",children:[(0,r.jsxs)("div",{className:"grid grid-cols-[1fr_auto] gap-2 items-center",children:[(0,r.jsx)(k.J,{htmlFor:"start-year",className:"text-xs text-zinc-500",children:"起始年"}),(0,r.jsx)(z.p,{id:"start-year",type:"number",className:"h-7 w-20 text-xs bg-zinc-900 border-zinc-700 focus-visible:ring-zinc-600",placeholder:"2012",value:H??"",onChange:e=>{q(e.target.value?parseInt(e.target.value):null)}})]}),(0,r.jsxs)("div",{className:"grid grid-cols-[1fr_auto] gap-2 items-center",children:[(0,r.jsx)(k.J,{htmlFor:"end-year",className:"text-xs text-zinc-500",children:"結束年"}),(0,r.jsx)(z.p,{id:"end-year",type:"number",className:"h-7 w-20 text-xs bg-zinc-900 border-zinc-700 focus-visible:ring-zinc-600",placeholder:"Auto",value:Y??"",onChange:e=>{Z(e.target.value?parseInt(e.target.value):null)}})]})]})]})]}),(0,r.jsxs)("div",{className:"flex items-center gap-3 text-xs text-zinc-500",children:[(0,r.jsxs)("div",{className:"flex items-center gap-1.5",children:[(0,r.jsx)("div",{className:"w-2 h-2 rounded-full bg-emerald-500"})," 金融事件"]}),(0,r.jsxs)("div",{className:"flex items-center gap-1.5",children:[(0,r.jsx)("div",{className:"w-2 h-2 rounded-full bg-rose-500"})," 房市政策"]})]})]})]}),E&&(0,r.jsxs)("div",{className:"mb-4 mx-2 text-xs text-amber-300 bg-amber-500/10 border border-amber-500/30 rounded-lg px-3 py-2 flex items-center justify-between",children:[(0,r.jsx)("span",{children:"對照選取中：請點選時間軸或表格的另一筆事件。"}),(0,r.jsx)("button",{onClick:()=>R(!1),className:"text-amber-200 hover:text-white transition-colors",children:"取消"})]}),(0,r.jsxs)("div",{className:"space-y-8",children:[(0,r.jsxs)("div",{className:"grid grid-cols-1 xl:grid-cols-[1fr_450px] gap-16 items-start",children:[(0,r.jsx)("div",{className:"relative w-full",children:(0,r.jsx)("div",{className:"relative w-full overflow-x-hidden pb-12 pt-8",children:(0,r.jsxs)("div",{className:"relative ml-16 border-b border-zinc-800 transition-all duration-300 ease-out cursor-default",style:{width:"90%",minWidth:"90%",height:`${ei}px`,paddingRight:"140px"},onClick:()=>{S(null),M(null),R(!1)},children:[(0,r.jsx)("div",{className:"absolute inset-0 z-10",children:Q.map((e,t)=>{let a=er[t],s=a+36,i=t===T,n=e.start.getTime(),c=e.end.getTime(),o=c-n;return(0,r.jsxs)("div",{className:"group/row",onClick:e=>{I(e=>e===t?null:t)},children:[(0,r.jsx)("div",{className:(0,l.cn)("absolute left-0 right-0 transition-colors duration-200 pointer-events-auto cursor-pointer",i?"bg-white/5":"hover:bg-white/5"),style:{top:`${a}px`,height:`${ea[t]}px`}}),(0,r.jsx)("div",{className:"absolute left-0 right-0 h-px bg-zinc-700/60 pointer-events-none",style:{top:`${s}px`}}),i&&et&&(0,r.jsx)("div",{className:"absolute left-0 right-0 pointer-events-none",style:{top:`${s+60}px`,bottom:0},children:et.items.map(e=>{let t=["bg-cyan-600 border-cyan-400 text-white","bg-violet-600 border-violet-400 text-white","bg-amber-600 border-amber-400 text-white","bg-emerald-600 border-emerald-400 text-white","bg-pink-600 border-pink-400 text-white"],a=t[V.findIndex(t=>t.name===e.name)%t.length];return(0,r.jsxs)("div",{className:(0,l.cn)("absolute h-7 rounded-md flex items-center px-3 text-xs font-bold whitespace-nowrap overflow-hidden shadow-lg border transition-transform hover:scale-[1.02] z-30",a),style:{left:`${e.startPct}%`,width:`${Math.max(.5,e.widthPct)}%`,top:`${36*e.laneIndex}px`},children:[(0,r.jsx)("span",{className:"mr-2",children:e.name}),(0,r.jsxs)("span",{className:"opacity-80 text-[10px] font-normal",children:[e.startStr," ~ ",e.endStr]})]},`stack-${e.name}-${e.originalIndex}`)})}),F<=1&&(0,r.jsx)(r.Fragment,{children:Array.from({length:e.endYear-e.startYear+1}).flatMap((t,a)=>{let r=e.startYear+a,s=[];if(F<=1&&s.push({m:6,d:1,label:"7/1",major:!0}),F<=.5&&(s.push({m:3,d:1,label:"4/1",major:!0}),s.push({m:9,d:1,label:"10/1",major:!0})),F<=.25)for(let e=1;e<12;e++)3!==e&&6!==e&&9!==e&&s.push({m:e,d:1,label:`${e+1}/1`,major:!1});return s.map(e=>{let t=new Date(r,e.m,e.d).getTime();return{...e,dateMs:t,year:r}})}).map((e,t)=>{if(e.dateMs>=n&&e.dateMs<=c){let t=(e.dateMs-n)/o*100,a=e.major;return(0,r.jsx)("div",{className:(0,l.cn)("absolute flex flex-col items-center justify-end group",a?"h-3 w-px bg-zinc-600":"h-2 w-px bg-zinc-700/50"),style:{left:`${t}%`,top:`${s-(a?5:4)}px`},children:(0,r.jsx)("span",{className:(0,l.cn)("font-mono -mt-4 transition-opacity",a?"text-[8px] text-zinc-500 opacity-60 group-hover:opacity-100":"text-[7px] text-zinc-700 opacity-0 group-hover:opacity-100"),children:e.label})},`mk-${e.year}-${e.m}`)}return null})}),!i&&(()=>{let e=V.filter(e=>Math.max(e.start.getTime(),n)<Math.min(e.end.getTime(),c));if(0===e.length)return null;let a=e.map(e=>({start:Math.max(e.start.getTime(),n),end:Math.min(e.end.getTime(),c)})).sort((e,t)=>e.start-t.start),i=[];if(a.length>0){let e=a[0];for(let t=1;t<a.length;t++)a[t].start<e.end?e.end=Math.max(e.end,a[t].end):(i.push(e),e=a[t]);i.push(e)}return i.map((e,a)=>{let i=(e.start-n)/o*100,l=(e.end-e.start)/o*100;return(0,r.jsx)("div",{className:"absolute h-1.5 bg-cyan-400 rounded-full shadow-[0_0_8px_rgba(34,211,238,0.6)] z-20 pointer-events-none",style:{left:`${i}%`,width:`${Math.max(.5,l)}%`,top:`${s}px`,marginTop:"-3px"}},`summary-${t}-${a}`)})})(),(0,r.jsx)("div",{className:"absolute text-[10px] font-mono text-zinc-500",style:{top:`${s-22}px`,left:"16px"},children:F<=.5?e.startStr:e.start.getFullYear()}),(0,r.jsx)("div",{className:"absolute text-[10px] font-mono text-zinc-500",style:{top:`${s-22}px`,right:"16px"},children:F<=.5?e.endStr:e.end.getFullYear()})]},`row-${e.startStr}-${e.endStr}`)})}),en.map((e,t)=>{let a="high"===e.impact,{rowIndex:s,posInRow:i,densityPos:n,laneIndex:o}=el[t]||{rowIndex:0,posInRow:0,densityPos:0,laneIndex:0},d=Q[s];if(!d)return null;let p=d.start.getTime(),u=d.end.getTime(),g=new Date(e.date).getTime(),f=u>p?(g-p)/(u-p):0,b=Math.min(95,Math.max(5,100*Math.min(1,Math.max(0,(n??f)*.8+.2*f)))),j=er[s],y=J[o%J.length],v=y<0,N=Math.max(10,Math.abs(y)-6),w=!1;if(V.length>0){let t=new Date(e.date);w=V.some(e=>t>=e.start&&t<=e.end)}let z=c?.id===e.id,k=P?.id===e.id;return(0,r.jsxs)("div",{className:(0,l.cn)("absolute transform -translate-x-1/2 flex flex-col items-center group cursor-pointer transition-all duration-200 ease-out z-20",z?"scale-[2.0] opacity-100 z-40":k?"scale-[1.8] opacity-100 z-40":w?"scale-100 opacity-90 hover:scale-[2.5] hover:opacity-100 hover:z-50":"scale-75 opacity-50 hover:scale-[2.5] hover:opacity-100 hover:z-50"),style:{left:`${b}%`,top:`${j+36+y}px`},onClick:t=>{t.stopPropagation(),ex(e)},children:[(0,r.jsx)("div",{className:(0,l.cn)("w-px absolute",v?"top-full bg-gradient-to-b":"bottom-full bg-gradient-to-t","from-transparent to-zinc-700"),style:{height:`${N}px`}}),(0,r.jsx)("div",{className:(0,l.cn)("w-3 h-3 rounded-full flex items-center justify-center border shadow-[0_0_10px_rgba(0,0,0,0.5)] transition-all","finance"===e.category?"bg-emerald-950/80 border-emerald-500/50 text-emerald-400 group-hover:shadow-emerald-500/20":"bg-rose-950/80 border-rose-500/50 text-rose-400 group-hover:shadow-rose-500/20",a&&"ring-1 ring-offset-1 ring-offset-black/50 ring-opacity-50","finance"===e.category&&a?"ring-emerald-500":"ring-rose-500",z&&"ring-1 ring-white ring-offset-1 ring-offset-black",!z&&k&&"ring-1 ring-emerald-400/70 ring-offset-1 ring-offset-black/70"),children:(e=>{switch(e){case"finance":return(0,r.jsx)(x.A,{className:"w-2 h-2 text-emerald-400"});case"policy":return(0,r.jsx)(h.A,{className:"w-2 h-2 text-rose-400"});default:return(0,r.jsx)(m.A,{className:"w-2 h-2 text-blue-400"})}})(e.category)}),(0,r.jsx)("div",{className:(0,l.cn)("absolute whitespace-nowrap text-[8px] px-1.5 py-0.5 rounded bg-black/80 border border-zinc-700 backdrop-blur-md transition-all font-medium",v?"-top-7":"-bottom-7",w?"text-white border-yellow-500/50":"text-zinc-400 group-hover:text-white",z&&"text-white border-white/50 bg-zinc-800",!z&&k&&"text-emerald-200 border-emerald-400/50 bg-emerald-950/60"),children:e.title}),(0,r.jsx)("div",{className:(0,l.cn)("absolute whitespace-nowrap text-[6px] font-mono text-zinc-600",v?"top-8":"bottom-8"),children:e.date})]},e.id)})]})})}),c?(0,r.jsx)("aside",{className:"xl:sticky xl:top-24 self-start max-h-[calc(100vh-8rem)] overflow-y-auto pr-1 bg-black/35 border border-white/10 rounded-2xl backdrop-blur-xl shadow-[0_20px_60px_rgba(0,0,0,0.55)] w-full max-w-[420px] justify-self-end",children:(0,r.jsx)("div",{className:"p-4",children:(0,r.jsxs)("div",{className:(0,l.cn)("grid grid-cols-1 gap-4",ed&&"xl:grid-cols-2"),children:[em(c,"primary"),eo&&em(eo,"compare")]})})}):(0,r.jsx)("div",{className:"hidden xl:block"})]}),(0,r.jsxs)("div",{className:"border-t border-zinc-800 pt-6",children:[(0,r.jsxs)("div",{className:"flex items-center justify-between mb-4",children:[(0,r.jsxs)("div",{className:"flex items-center gap-2",children:[(0,r.jsx)(p.A,{className:"w-5 h-5 text-purple-400"}),(0,r.jsx)("h3",{className:"text-lg font-bold text-zinc-200",children:"政策影響比較表"})]}),(0,r.jsx)(N.N,{data:ec,filename:"policy_comparison",label:"匯出政策表"})]}),(0,r.jsxs)("div",{className:"rounded-xl border border-white/10 overflow-hidden bg-black/20",children:[(0,r.jsxs)("div",{className:"grid grid-cols-12 gap-4 p-4 bg-zinc-900/50 border-b border-white/5 text-xs font-bold text-zinc-400 uppercase tracking-wider",children:[(0,r.jsx)("div",{className:"col-span-2",children:"實施日期"}),(0,r.jsx)("div",{className:"col-span-3",children:"政策/事件名稱"}),(0,r.jsx)("div",{className:"col-span-4",children:"變革內容 (Before vs After)"}),(0,r.jsx)("div",{className:"col-span-3",children:"影響對象與範圍"})]}),(0,r.jsx)("div",{className:"divide-y divide-white/5 max-h-[400px] overflow-y-auto custom-scrollbar",children:en.slice().reverse().map(e=>{let t=c?.id===e.id,a=P?.id===e.id&&!t;return(0,r.jsxs)("div",{className:(0,l.cn)("grid grid-cols-12 gap-4 p-4 text-sm transition-colors hover:bg-white/5 cursor-pointer",t?"bg-white/10":"",a?"bg-emerald-500/10":""),onClick:()=>ex(e),children:[(0,r.jsx)("div",{className:"col-span-2 font-mono text-zinc-500",children:e.date}),(0,r.jsxs)("div",{className:"col-span-3 flex items-start gap-2",children:[(0,r.jsx)(o,{variant:"outline",className:(0,l.cn)("shrink-0 mt-0.5","finance"===e.category?"text-emerald-400 border-emerald-500/30":"text-rose-400 border-rose-500/30"),children:"finance"===e.category?"金融":"政策"}),(0,r.jsx)("span",{className:(0,l.cn)("font-medium","high"===e.impact?"text-white":"text-zinc-400"),children:e.title})]}),(0,r.jsx)("div",{className:"col-span-4 text-zinc-300",children:e.change_content?(0,r.jsxs)("div",{className:"flex items-center gap-2",children:[(0,r.jsx)("span",{className:"w-1.5 h-1.5 rounded-full bg-cyan-500 shrink-0"}),e.change_content]}):(0,r.jsx)("span",{className:"text-zinc-600 italic",children:"--"})}),(0,r.jsx)("div",{className:"col-span-3 text-zinc-400",children:e.affected_scope||(0,r.jsx)("span",{className:"text-zinc-600 italic",children:"--"})})]},e.id)})})]})]})]})]})]})}},31840:(e,t,a)=>{a.d(t,{p:()=>w});var r=a(95155),s=a(12115),i=a(68605),n=a(65770),l=a(9921),c=a(66088),o=a(6296),d=a(61878),x=a(33210),h=a(18837),m=a(41641),p=a(21362),u=a(40980),g=a(88743),f=a(27529),b=a(55873),j=a(98883),y=a(51806),v=a(89733),N=a(70872);function w({data:e,trigger:t,uiSize:a="dashboard"}){let{counties:w,districts:z,transactionType:k,buildingType:S,projectNames:P,dateRange:M,startDate:A,endDate:C}=(0,g.P)(),[_,$]=(0,s.useState)([]),[F,E]=(0,s.useState)(!1),[R,T]=(0,s.useState)(null),[I,L]=(0,s.useState)(1),[D,O]=(0,s.useState)(new Set),[B,W]=(0,s.useState)({key:"",direction:null}),[U,H]=(0,s.useState)(""),[q,Y]=(0,s.useState)("建案名稱"),Z=(0,u.cn)("bg-zinc-800 border border-zinc-700 rounded px-3 text-zinc-200","builder"===a?"py-2 text-xl h-12":"py-1.5 text-sm h-9"),[V,G]=(0,s.useState)(!1),[J,X]=(0,s.useState)([]),[K,Q]=(0,s.useState)(!1),[ee,et]=(0,s.useState)([]),[ea,er]=(0,s.useState)(""),es=s.useRef(null),ei=(0,s.useRef)({counties:w,districts:z,transactionType:k,buildingType:S,projectNames:P,dateRange:M,startDate:A,endDate:C});(0,s.useEffect)(()=>{ei.current={counties:w,districts:z,transactionType:k,buildingType:S,projectNames:P,dateRange:M,startDate:A,endDate:C}});let en=(0,s.useCallback)(async()=>{let{counties:e,districts:t,transactionType:a,buildingType:r,projectNames:s,dateRange:i,startDate:n,endDate:l}=ei.current;E(!0),T(null),$([]);try{if(0===e.length)return void E(!1);let c=n,o=l;if("custom"!==i){let e=(0,j.P)(i);e.startDate&&(c=e.startDate),e.endDate&&(o=e.endDate)}let d=e.map(async e=>{let i=b.WG[e],n=b.Ib[e]||[],l=t?t.filter(e=>n.includes(e)):[],d={countyCode:i,districts:l.length>0?l:void 0,type:a,dateStart:c,dateEnd:o,projectNames:s,buildingType:r};try{return await f.FH.fetchData(d,{page:1,limit:1e3})}catch(t){return console.warn(`Fetch failed for ${e}`,t),{data:[],count:0}}}),x=await Promise.all(d),h=[];x.forEach(e=>{e&&Array.isArray(e.data)&&(h=[...h,...e.data])}),h.sort((e,t)=>{let a=e["交易日"]||"";return(t["交易日"]||"").localeCompare(a)}),$(h)}catch(e){console.error("Data List fetch failed:",e),T(e.message||"讀取交易資料失敗")}finally{E(!1)}},[]),el=JSON.stringify({counties:w,districts:z,transactionType:k,buildingType:S,projectNames:P,dateRange:M,startDate:A,endDate:C});(0,s.useEffect)(()=>{en()},[el]),(0,s.useEffect)(()=>{t&&en()},[en,t]);let ec=async e=>{Q(!0),X([]),et([]);let a=e["建案名稱"]||"未命名建案";er(`車位/附表明細 - ${a}`),G(!0);let r=[],s=e=>{console.log(e),r.push(e)};try{let i=e.編號,n=ei.current?.transactionType||k;if(s(`TID: ${i}`),s(`Type: ${n}`),s(`Project: ${a}`),!i){s("Error: No Transaction ID"),et(r),Q(!1);return}let l=[],c=e.縣市代碼;if(!c){let e=ei.current?.counties||[];1===e.length&&(c=b.WG[e[0]])}if(!c&&e.地址)for(let[t,a]of Object.entries(b.WG)){if(e.地址.startsWith(t)){c=a;break}let r=t.replace("台","臺");if(e.地址.replace("台","臺").startsWith(r)){c=a;break}}if(s(`CountyCode: ${c} (Inferred: ${!e.縣市代碼})`),c){let t=e["交易類型"]||n;s(`Calling API with: ${i}, ${t}, ${c}`);try{let r=await f.FH.fetchSubData(i,t,c);r.park&&Array.isArray(r.park)&&r.park.length>0?(s(`API Success: Found ${r.park.length} park records`),l=r.park.map(t=>({車位類別:t["車位類別"]||"-","車位價格(萬)":t["車位價格(萬)"]||(t["車位價格"]?(Number(t["車位價格"])/1e4).toFixed(2):"-"),"車位面積(坪)":t["車位面積(坪)"]||(t["車位面積"]?(Number(t["車位面積"])/3.30579).toFixed(2):"-"),車位樓層:t["車位樓層"]||t["車位所在樓層"]||"-",建案名稱:t["建案名稱"]||a,交易日:t["交易日"]||e["交易日"],備註:t["備註"]||"",_category:"車位資料(來自API)"}))):s("API Result: No park data found"),r.build&&Array.isArray(r.build)&&r.build.length>0?(s(`API Success: Found ${r.build.length} build records`),l=[...l,...r.build.map(e=>({...e,_category:"建物明細"}))]):s("API Result: No build data found"),r.land&&Array.isArray(r.land)&&r.land.length>0?(s(`API Success: Found ${r.land.length} land records`),l=[...l,...r.land.map(e=>({...e,"土地移轉總面積(坪)":e["土地移轉總面積(平方公尺)"]?(.3025*Number(e["土地移轉總面積(平方公尺)"])).toFixed(2):"-",土地位置:e["土地區段位置"]||e["土地位置"]||"-",_category:"土地明細"}))]):s("API Result: No land data found")}catch(e){console.warn("API fetchSubData failed, proceeding to fallback:",e),s(`API Error: ${String(e)} - Proceeding to fallback`)}}else s("Skip API: No County Code");if(0===l.length&&t?.parkingAnalysis?.rampPlanePriceByFloor){s("Check AnalysisData RawRecords...");let r=t.parkingAnalysis.rampPlanePriceByFloor,n=[],c=e=>String(e||"").replace(/[^a-zA-Z0-9]/g,"").toUpperCase(),o=c(i);for(let e of(s(`Normalized Target ID: ${o}`),r))if(e.rawRecords&&Array.isArray(e.rawRecords)){let t=e.rawRecords.filter(e=>{let t=c(e.transactionId),a=c(e["編號"]);return t===o||a===o});t.length>0&&n.push(...t.map(t=>({...t,floorFromBucket:e.floor})))}if(n.length>0)for(let t of(s(`AnalysisData: Found ${n.length} matches`),s(`Match Data: ${JSON.stringify(n[0]).substring(0,100)}...`),n))l.push({車位類別:t["車位類別"]||"坡道平面","車位價格(萬)":t.parkingPrice||t["車位價格(萬)"]||"-","車位面積(坪)":t.parkingArea||t["車位面積(坪)"]||"-",車位樓層:t["車位所在樓層"]||t.floorFromBucket||"-",建案名稱:t["建案名稱"]||a,交易日:t["交易日"]||e["交易日"],備註:t["備註"]||"",_category:"車位資料(來自分析數據)"});else s("AnalysisData: No matches found")}if(0===l.length){s("Fallback: Using Main Record");let t=e["車位數"]&&Number(e["車位數"])>0,r=e["車位總價"]||e["車位總價(萬)"];if(t||r){let t=e["車位總價(萬)"]?Number(e["車位總價(萬)"]):e["車位總價"]?(Number(e["車位總價"])/1e4).toFixed(2):"-",r=e["車位面積(坪)"]?Number(e["車位面積(坪)"]):e["車位面積"]?(Number(e["車位面積"])/3.30579).toFixed(2):"-";l.push({車位類別:e["車位類別"]||"無資料","車位價格(萬)":t,"車位面積(坪)":r,車位樓層:"-",建案名稱:a,交易日:e["交易日"],備註:e["備註"]||"",_category:"車位資料(來自交易明細)"})}else s("Fallback: No parking info in main record")}X(l),et(r)}catch(t){if(console.error("handleFetchSubTable error:",t),r.push(`Error: ${String(t)}`),et(r),e["車位數"]&&Number(e["車位數"])>0){let t=e["車位總價(萬)"]?Number(e["車位總價(萬)"]):e["車位總價"]?(Number(e["車位總價"])/1e4).toFixed(2):0,a=e["車位面積(坪)"]?Number(e["車位面積(坪)"]):e["車位面積"]?(Number(e["車位面積"])/3.30579).toFixed(2):0;X([{車位類別:e["車位類別"]||"無資料","車位價格(萬)":t,"車位面積(坪)":a,車位樓層:"-",_category:"車位資料(來自交易明細)"}])}else X([])}finally{Q(!1)}},eo=[{key:"行政區",label:"行政區",sortable:!0},{key:"建案名稱",label:"建案名稱",sortable:!0},{key:"交易日",label:"交易日",sortable:!0},{key:"交易筆棟數",label:"交易筆棟數",sortable:!1},{key:"主要用途",label:"主要用途",sortable:!1},{key:"建物型態",label:"建物型態",sortable:!1},{key:"戶型",label:"戶型",sortable:!0},{key:"樓層",label:"樓層",sortable:!0},{key:"房屋面積(坪)",label:"坪數",sortable:!0},{key:"房屋單價(萬)",label:"單價",sortable:!0}],ed=["編號","地址","總樓層","交易總價(萬)","房屋總價(萬)","車位總價(萬)","房數","廳數","衛浴數","備註","解約情形","戶別","主要用途","建物型態","車位類別","車位價格","車位面積","主建物面積","附屬建物面積","陽台面積","土地使用分區","地號","社區戶數"],ex=e=>{O(t=>{let a=new Set(t);return a.has(e)?a.delete(e):a.add(e),a})},eh=e=>null==e||""===e?"-":"number"==typeof e?Number.isInteger(e)?e.toLocaleString():e.toFixed(2):String(e),em=(0,s.useMemo)(()=>{let e=[..._];if(U.trim()){let t=U.toLowerCase();e=e.filter(e=>{let a=e[q];return null!=a&&String(a).toLowerCase().includes(t)})}return B.key&&B.direction&&e.sort((e,t)=>{let a=e[B.key],r=t[B.key];if(null==a&&null==r)return 0;if(null==a)return 1;if(null==r)return -1;if("number"==typeof a&&"number"==typeof r)return"asc"===B.direction?a-r:r-a;let s=String(a),i=String(r);return"asc"===B.direction?s.localeCompare(i,"zh-TW"):i.localeCompare(s,"zh-TW")}),e},[_,U,q,B]),ep=Math.ceil(em.length/20),eu=(I-1)*20,eg=eu+20,ef=em.slice(eu,eg);return F?(0,r.jsxs)("div",{className:"flex flex-col items-center justify-center py-20",children:[(0,r.jsx)(o.A,{className:"h-8 w-8 animate-spin text-violet-500 mb-2"}),(0,r.jsx)("p",{className:"text-zinc-500 text-sm",children:"正在載入交易資料相關明細..."})]}):R?(0,r.jsxs)("div",{className:"text-center p-12 text-red-400",children:[(0,r.jsxs)("p",{children:["載入失敗: ",R]}),(0,r.jsx)("button",{onClick:()=>en(),className:"mt-4 px-4 py-2 bg-zinc-800 rounded hover:bg-zinc-700",children:"重試"})]}):_&&0!==_.length?(0,r.jsxs)("div",{className:"space-y-4 animate-in fade-in slide-in-from-bottom-4 duration-500",children:[(0,r.jsxs)("div",{className:"flex flex-wrap gap-3 items-center p-3 bg-zinc-900/50 rounded-lg border border-white/5","data-report-control":"hide",children:[(0,r.jsxs)("div",{className:"flex items-center gap-2 flex-1 min-w-[200px]",children:[(0,r.jsx)(d.A,{size:16,className:"text-zinc-500"}),(0,r.jsx)("input",{type:"text",value:U,onChange:e=>{H(e.target.value),L(1)},placeholder:`搜尋 ${q}...`,className:"flex-1 bg-transparent border-none outline-none text-white placeholder-zinc-500 text-sm"}),U&&(0,r.jsx)("button",{onClick:()=>H(""),className:"text-zinc-500 hover:text-white",children:(0,r.jsx)(x.A,{size:14})})]}),(0,r.jsxs)("select",{value:q,onChange:e=>Y(e.target.value),className:Z,children:[(0,r.jsx)("option",{value:"建案名稱",children:"建案名稱"}),(0,r.jsx)("option",{value:"行政區",children:"行政區"}),(0,r.jsx)("option",{value:"戶型",children:"戶型"}),(0,r.jsx)("option",{value:"主要用途",children:"主要用途"})]})]}),(0,r.jsxs)("div",{className:"flex justify-between items-center text-sm text-zinc-400",children:[(0,r.jsxs)("span",{children:["共 ",(0,r.jsx)("span",{className:"text-white font-semibold",children:em.length.toLocaleString()})," 筆資料 ",U&&(0,r.jsx)("span",{className:"text-zinc-500",children:"(已篩選)"})]}),(0,r.jsxs)("span",{children:["第 ",I," / ",ep||1," 頁"]})]}),(0,r.jsxs)(i.c,{title:"交易資料明細",description:"點擊表頭可排序，點擊「明細」可展開詳細資訊",containerRef:es,headerAction:(0,r.jsx)(v.N,{data:em,filename:"transaction_list_data",label:"匯出",chartType:"data-list",targetRef:es}),children:[(0,r.jsx)("div",{className:"hidden md:block overflow-x-auto",children:(0,r.jsxs)("table",{className:"w-full text-sm text-left",children:[(0,r.jsx)("thead",{className:"bg-zinc-900/80 text-zinc-400 uppercase text-xs font-semibold sticky top-0",children:(0,r.jsxs)("tr",{children:[(0,r.jsx)("th",{className:"px-3 py-3 w-20 text-center","data-report-control":"hide",children:"操作"}),eo.map(e=>{var t;return(0,r.jsx)("th",{className:(0,u.cn)("px-3 py-3 text-left whitespace-nowrap",e.sortable&&"cursor-pointer select-none group hover:text-white transition-colors","建案名稱"===e.key&&"min-w-[120px] max-w-[200px] whitespace-normal","行政區"===e.key&&"w-20","交易日"===e.key&&"w-24",("房屋單價(萬)"===e.key||"房屋面積(坪)"===e.key)&&"text-right"),onClick:()=>{var t;return e.sortable&&(t=e.key,void(W(e=>{if(e.key===t){if("asc"===e.direction)return{key:t,direction:"desc"};if("desc"===e.direction)return{key:"",direction:null}}return{key:t,direction:"asc"}}),L(1)))},children:(0,r.jsxs)("div",{className:(0,u.cn)("flex items-center gap-1",("房屋單價(萬)"===e.key||"房屋面積(坪)"===e.key)&&"justify-end"),children:[e.label,e.sortable&&(t=e.key,B.key!==t?(0,r.jsx)(n.A,{size:12,className:"opacity-30 group-hover:opacity-70"}):"asc"===B.direction?(0,r.jsx)(l.A,{size:12,className:"text-violet-400"}):(0,r.jsx)(c.A,{size:12,className:"text-violet-400"}))]})},e.key)})]})}),(0,r.jsx)("tbody",{className:"divide-y divide-white/5",children:ef.map((e,t)=>{let a=eu+t,i=D.has(a);return(0,r.jsxs)(s.Fragment,{children:[(0,r.jsxs)("tr",{className:(0,u.cn)("hover:bg-zinc-800/50 transition-colors",i&&"bg-zinc-800/30"),children:[(0,r.jsx)("td",{className:"px-3 py-2","data-report-control":"hide",children:(0,r.jsxs)("div",{className:"flex items-center gap-2 justify-center",children:[(0,r.jsxs)("button",{onClick:()=>ec(e),className:"px-2 py-1 rounded text-xs font-medium bg-cyan-900/30 text-cyan-400 hover:bg-cyan-900/50 hover:text-cyan-300 transition-colors flex items-center gap-1 border border-cyan-800/50 active:scale-95",title:"查看車位或其他附表資料",children:[(0,r.jsx)(h.A,{size:12}),"附表"]}),(0,r.jsxs)("button",{onClick:()=>ex(a),className:(0,u.cn)("flex items-center gap-1 px-2 py-1 rounded text-xs font-medium transition-colors border active:scale-95",i?"bg-violet-500/20 text-violet-300 border-violet-500/30":"bg-zinc-800 text-zinc-400 border-zinc-700 hover:bg-zinc-700 hover:text-zinc-200"),children:[i?(0,r.jsx)(l.A,{size:12}):(0,r.jsx)(c.A,{size:12}),"明細"]})]})}),eo.map(t=>(0,r.jsx)("td",{className:(0,u.cn)("px-3 py-2","建案名稱"===t.key?"whitespace-normal min-w-[120px] max-w-[200px]":"whitespace-nowrap",("房屋單價(萬)"===t.key||"房屋面積(坪)"===t.key)&&"text-right"),children:"戶型"===t.key?(0,r.jsx)(N.Bc,{delayDuration:100,children:(0,r.jsxs)(N.m_,{children:[(0,r.jsx)(N.k$,{asChild:!0,children:(0,r.jsx)("span",{className:"cursor-help border-b border-dotted border-zinc-600 block truncate max-w-[80px]",children:eh(e[t.key])})}),(0,r.jsx)(N.ZI,{side:"top",className:"max-w-[200px]",children:(0,r.jsxs)("p",{className:"text-xs",children:["原始戶別: ",(0,r.jsx)("strong",{children:e["戶別"]||"無資料"})]})})]})}):"主要用途"===t.key?(0,r.jsx)("span",{className:"text-zinc-300",children:"見其他登記事項"===e["主要用途"]?"其他":eh(e[t.key])}):(0,r.jsx)("span",{className:(0,u.cn)("房屋單價(萬)"===t.key&&"font-mono text-violet-400 font-bold","建案名稱"===t.key&&"font-medium text-white text-sm leading-tight block","建案名稱"!==t.key&&"房屋單價(萬)"!==t.key&&"text-zinc-300"),children:eh(e[t.key])})},t.key))]}),i&&(0,r.jsx)("tr",{className:"bg-zinc-900/50","data-report-control":"hide",children:(0,r.jsx)("td",{colSpan:eo.length+1,className:"px-4 py-4",children:(0,r.jsx)("div",{className:"grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 lg:grid-cols-6 gap-3",children:ed.map(t=>t in e?(0,r.jsxs)("div",{className:"bg-zinc-800/50 rounded p-2",children:[(0,r.jsx)("div",{className:"text-xs text-zinc-500 mb-1",children:t}),(0,r.jsx)("div",{className:"text-sm text-zinc-200 font-mono",children:eh(e[t])})]},t):null)})})})]},a)})})]})}),(0,r.jsxs)("div",{className:"md:hidden space-y-4",children:[ef.map((e,t)=>{let a=eu+t,s=D.has(a);return(0,r.jsxs)("div",{className:(0,u.cn)("bg-zinc-900/40 border border-white/5 rounded-xl overflow-hidden transition-all duration-200",s?"ring-1 ring-violet-500/30 bg-zinc-900/60":"hover:bg-zinc-900/60"),children:[(0,r.jsxs)("div",{className:"p-4",onClick:()=>ex(a),children:[(0,r.jsxs)("div",{className:"flex justify-between items-start mb-3",children:[(0,r.jsxs)("div",{children:[(0,r.jsxs)("div",{className:"flex items-center gap-2 mb-1",children:[(0,r.jsx)("span",{className:"text-xs font-medium px-1.5 py-0.5 rounded bg-zinc-800 text-zinc-400",children:e["行政區"]}),(0,r.jsx)("h3",{className:"text-base font-bold text-white leading-tight",children:e["建案名稱"]})]}),(0,r.jsxs)("div",{className:"text-xs text-zinc-500 font-mono",children:[e["交易日"]," • ",e["戶型"]||"-"]})]}),(0,r.jsxs)("div",{className:"text-right",children:[(0,r.jsxs)("div",{className:"text-lg font-bold text-violet-400 font-mono leading-none",children:[eh(e["房屋單價(萬)"]),(0,r.jsx)("span",{className:"text-xs text-zinc-500 font-normal ml-0.5",children:"萬/坪"})]}),(0,r.jsxs)("div",{className:"text-xs text-zinc-500 mt-1",children:[eh(e["交易總價(萬)"])," 萬"]})]})]}),(0,r.jsxs)("div",{className:"grid grid-cols-3 gap-2 py-3 border-t border-white/5",children:[(0,r.jsxs)("div",{className:"text-center",children:[(0,r.jsx)("div",{className:"text-[10px] text-zinc-500 mb-0.5",children:"樓層"}),(0,r.jsxs)("div",{className:"text-sm font-medium text-zinc-300",children:[eh(e["樓層"]),"F"]})]}),(0,r.jsxs)("div",{className:"text-center border-l border-white/5",children:[(0,r.jsx)("div",{className:"text-[10px] text-zinc-500 mb-0.5",children:"坪數"}),(0,r.jsx)("div",{className:"text-sm font-medium text-zinc-300",children:eh(e["房屋面積(坪)"])})]}),(0,r.jsxs)("div",{className:"text-center border-l border-white/5",children:[(0,r.jsx)("div",{className:"text-[10px] text-zinc-500 mb-0.5",children:"車位"}),(0,r.jsx)("div",{className:"text-sm font-medium text-zinc-300",children:eh(e["車位總價(萬)"])})]})]}),(0,r.jsxs)("div",{className:"flex gap-2 mt-2","data-report-control":"hide",children:[(0,r.jsxs)("button",{onClick:t=>{t.stopPropagation(),ec(e)},className:"flex-1 py-2 rounded-lg text-xs font-medium bg-cyan-900/20 text-cyan-400 border border-cyan-800/30 flex items-center justify-center gap-1.5 active:scale-[0.98] transition-all",children:[(0,r.jsx)(h.A,{size:14}),"查看附表"]}),(0,r.jsxs)("button",{onClick:e=>{e.stopPropagation(),ex(a)},className:(0,u.cn)("flex-1 py-2 rounded-lg text-xs font-medium border flex items-center justify-center gap-1.5 active:scale-[0.98] transition-all",s?"bg-violet-500/10 text-violet-300 border-violet-500/30":"bg-zinc-800/50 text-zinc-300 border-zinc-700"),children:[s?"收合明細":"顯示明細",s?(0,r.jsx)(l.A,{size:14}):(0,r.jsx)(c.A,{size:14})]})]})]}),s&&(0,r.jsx)("div",{className:"bg-zinc-950/50 border-t border-white/5 p-4 animate-accordion-down","data-report-control":"hide",children:(0,r.jsx)("div",{className:"grid grid-cols-2 gap-x-4 gap-y-3",children:ed.map(t=>t in e?(0,r.jsxs)("div",{className:"overflow-hidden",children:[(0,r.jsx)("div",{className:"text-[10px] text-zinc-500 truncate",children:t}),(0,r.jsx)("div",{className:"text-sm text-zinc-300 font-mono truncate",children:eh(e[t])})]},t):null)})})]},a)}),0===ef.length&&(0,r.jsx)("div",{className:"text-center py-12 text-zinc-500 bg-zinc-900/20 rounded-xl border border-dashed border-zinc-800",children:"無符合條件的資料"})]})]}),(0,r.jsxs)("div",{className:"flex justify-between items-center pt-4 border-t border-white/5",children:[(0,r.jsxs)("div",{className:"text-sm text-zinc-500",children:["顯示第 ",em.length>0?eu+1:0," - ",Math.min(eg,em.length)," 筆"]}),(0,r.jsxs)("div",{className:"flex items-center gap-2",children:[(0,r.jsx)("button",{onClick:()=>L(e=>Math.max(1,e-1)),disabled:1===I,className:"p-2 rounded bg-zinc-800 text-zinc-300 hover:bg-zinc-700 disabled:opacity-50 disabled:cursor-not-allowed transition-colors",children:(0,r.jsx)(m.A,{size:16})}),(0,r.jsx)("div",{className:"flex gap-1",children:Array.from({length:Math.min(5,ep||1)},(e,t)=>{let a,s=ep||1;return(a=s<=5||I<=3?t+1:I>=s-2?s-4+t:I-2+t)<1||a>s?null:(0,r.jsx)("button",{onClick:()=>L(a),className:(0,u.cn)("w-8 h-8 rounded text-sm font-medium transition-colors",I===a?"bg-violet-500 text-white":"bg-zinc-800 text-zinc-400 hover:bg-zinc-700"),children:a},a)})}),(0,r.jsx)("button",{onClick:()=>L(e=>Math.min(ep||1,e+1)),disabled:I===ep||0===ep,className:"p-2 rounded bg-zinc-800 text-zinc-300 hover:bg-zinc-700 disabled:opacity-50 disabled:cursor-not-allowed transition-colors",children:(0,r.jsx)(p.A,{size:16})})]})]}),(0,r.jsx)(y.a,{isOpen:V,onClose:()=>G(!1),className:"max-w-5xl",title:(0,r.jsxs)("div",{className:"flex items-center justify-between w-full",children:[(0,r.jsxs)("div",{className:"flex items-center gap-2",children:[(0,r.jsx)(h.A,{className:"text-cyan-400"}),(0,r.jsx)("span",{children:ea})]}),(0,r.jsx)(v.N,{data:J,filename:`sub_table_${ea}`,label:"匯出附表",className:"ml-4"})]}),children:K?(0,r.jsxs)("div",{className:"flex flex-col items-center justify-center py-12",children:[(0,r.jsx)(o.A,{className:"h-8 w-8 animate-spin text-cyan-400 mb-3"}),(0,r.jsx)("p",{className:"text-zinc-500 text-sm animate-pulse",children:"正在讀取附表資料..."})]}):J.length>0?(0,r.jsxs)("div",{className:"space-y-8",children:[J.some(e=>e._category.includes("車位"))&&(0,r.jsxs)("div",{className:"space-y-3",children:[(0,r.jsxs)("h4",{className:"text-sm font-bold text-violet-400 flex items-center gap-2",children:[(0,r.jsx)("div",{className:"w-1 h-4 bg-violet-500 rounded-full"}),"車位明細"]}),(0,r.jsx)("div",{className:"bg-zinc-800/30 rounded-lg overflow-hidden border border-white/5",children:(0,r.jsx)("div",{className:"overflow-x-auto",children:(0,r.jsxs)("table",{className:"w-full text-sm text-left",children:[(0,r.jsx)("thead",{className:"bg-zinc-900/80 text-zinc-400 uppercase text-xs font-semibold",children:(0,r.jsxs)("tr",{children:[(0,r.jsx)("th",{className:"px-4 py-3 whitespace-nowrap bg-zinc-900 text-cyan-400",children:"來源"}),["車位類別","車位價格(萬)","車位面積(坪)","車位樓層","建案名稱","備註"].map(e=>(0,r.jsx)("th",{className:"px-4 py-3 whitespace-nowrap bg-zinc-900",children:e},e))]})}),(0,r.jsx)("tbody",{className:"divide-y divide-white/5",children:J.filter(e=>e._category.includes("車位")).map((e,t)=>(0,r.jsxs)("tr",{className:"hover:bg-zinc-800/50 transition-colors",children:[(0,r.jsx)("td",{className:"px-4 py-3 whitespace-nowrap text-cyan-400 font-medium text-xs",children:e._category.replace("車位資料","").replace(/[()]/g,"")||"API"}),["車位類別","車位價格(萬)","車位面積(坪)","車位樓層","建案名稱","備註"].map(t=>(0,r.jsx)("td",{className:"px-4 py-3 whitespace-nowrap text-zinc-300",children:eh(e[t])},t))]},t))})]})})})]}),J.some(e=>e._category.includes("建物"))&&(0,r.jsxs)("div",{className:"space-y-3",children:[(0,r.jsxs)("h4",{className:"text-sm font-bold text-emerald-400 flex items-center gap-2",children:[(0,r.jsx)("div",{className:"w-1 h-4 bg-emerald-500 rounded-full"}),"建物明細"]}),(0,r.jsx)("div",{className:"bg-zinc-800/30 rounded-lg overflow-hidden border border-white/5",children:(0,r.jsx)("div",{className:"overflow-x-auto",children:(0,r.jsxs)("table",{className:"w-full text-sm text-left",children:[(0,r.jsx)("thead",{className:"bg-zinc-900/80 text-zinc-400 uppercase text-xs font-semibold",children:(0,r.jsx)("tr",{children:Array.from(new Set(J.filter(e=>e._category.includes("建物")).flatMap(Object.keys))).filter(e=>!["id","編號","created_at","_category","rawRecords"].includes(e)).map(e=>(0,r.jsx)("th",{className:"px-4 py-3 whitespace-nowrap bg-zinc-900",children:e},e))})}),(0,r.jsx)("tbody",{className:"divide-y divide-white/5",children:J.filter(e=>e._category.includes("建物")).map((e,t)=>(0,r.jsx)("tr",{className:"hover:bg-zinc-800/50 transition-colors",children:Array.from(new Set(J.filter(e=>e._category.includes("建物")).flatMap(Object.keys))).filter(e=>!["id","編號","created_at","_category","rawRecords"].includes(e)).map(t=>(0,r.jsx)("td",{className:"px-4 py-3 whitespace-nowrap text-zinc-300",children:eh(e[t])},t))},t))})]})})})]}),J.some(e=>e._category.includes("土地"))&&(0,r.jsxs)("div",{className:"space-y-3",children:[(0,r.jsxs)("h4",{className:"text-sm font-bold text-amber-400 flex items-center gap-2",children:[(0,r.jsx)("div",{className:"w-1 h-4 bg-amber-500 rounded-full"}),"土地明細"]}),(0,r.jsx)("div",{className:"bg-zinc-800/30 rounded-lg overflow-hidden border border-white/5",children:(0,r.jsx)("div",{className:"overflow-x-auto",children:(0,r.jsxs)("table",{className:"w-full text-sm text-left",children:[(0,r.jsx)("thead",{className:"bg-zinc-900/80 text-zinc-400 uppercase text-xs font-semibold",children:(0,r.jsx)("tr",{children:Array.from(new Set(J.filter(e=>e._category.includes("土地")).flatMap(Object.keys))).filter(e=>!["id","編號","created_at","_category","rawRecords"].includes(e)).map(e=>(0,r.jsx)("th",{className:"px-4 py-3 whitespace-nowrap bg-zinc-900",children:e},e))})}),(0,r.jsx)("tbody",{className:"divide-y divide-white/5",children:J.filter(e=>e._category.includes("土地")).map((e,t)=>(0,r.jsx)("tr",{className:"hover:bg-zinc-800/50 transition-colors",children:Array.from(new Set(J.filter(e=>e._category.includes("土地")).flatMap(Object.keys))).filter(e=>!["id","編號","created_at","_category","rawRecords"].includes(e)).map(t=>(0,r.jsx)("td",{className:"px-4 py-3 whitespace-nowrap text-zinc-300",children:eh(e[t])},t))},t))})]})})})]}),(0,r.jsx)("div",{className:"flex justify-end",children:(0,r.jsx)("button",{onClick:()=>G(!1),className:"px-4 py-2 bg-zinc-800 hover:bg-zinc-700 text-sm text-white rounded transition-colors",children:"關閉"})})]}):(0,r.jsxs)("div",{className:"flex flex-col items-center justify-center py-12 text-zinc-500",children:[(0,r.jsx)("div",{className:"bg-zinc-800/50 p-4 rounded-full mb-3",children:(0,r.jsx)(h.A,{size:24,className:"opacity-20"})}),(0,r.jsx)("p",{children:"此筆交易沒有相關附表資料"})]})})]}):(0,r.jsx)("div",{className:"text-center p-12 text-zinc-500",children:"無交易資料可顯示"})}},33807:(e,t,a)=>{a.d(t,{J:()=>n});var r=a(95155),s=a(12115),i=a(40980);let n=s.forwardRef(({className:e,...t},a)=>(0,r.jsx)("label",{ref:a,className:(0,i.cn)("text-sm font-medium leading-none peer-disabled:cursor-not-allowed peer-disabled:opacity-70",e),...t}));n.displayName="Label"},37717:(e,t,a)=>{a.d(t,{A:()=>c});var r=a(12115);let s=(e,t)=>getComputedStyle(document.documentElement).getPropertyValue(e).trim()||t,i=e=>{let t=e.match(/rgba?\((\d+),\s*(\d+),\s*(\d+)/i);return t?[Number(t[1]),Number(t[2]),Number(t[3])]:null},n=e=>{let t=e.replace("#","").trim();if(![3,6].includes(t.length))return null;let a=parseInt(3===t.length?t.split("").map(e=>e+e).join(""):t,16);return Number.isNaN(a)?null:[a>>16&255,a>>8&255,255&a]},l=()=>{let e=[s("--color-chart-1","#8b5cf6"),s("--color-chart-2","#06b6d4"),s("--color-chart-3","#10b981"),s("--color-chart-4","#f43f5e"),s("--color-chart-5","#f59e0b")],t=s("--color-dark-bg","#09090b");return{bg:s("--color-dark-bg","#09090b"),card:s("--color-dark-card","#18181b"),surface:s("--color-dark-surface","#27272a"),primary:s("--color-primary","#8b5cf6"),primaryHover:s("--color-primary-hover","#7c3aed"),accent:s("--color-chart-2","#06b6d4"),accentAlt:s("--color-chart-4","#f43f5e"),text:s("--color-text-primary","#fafafa"),textMuted:s("--color-text-secondary","#a1a1aa"),border:s("--color-border","#27272a"),grid:s("--color-zinc-700","#3f3f46"),danger:s("--color-destructive","#ef4444"),warning:s("--color-amber-500","#f59e0b"),success:s("--color-emerald-500","#10b981"),chart:e,chartPalette:((e,t)=>{if(0===e.length)return[];let a=e.map(e=>((e,t,a=.35)=>{let r=n(e)??i(e),s=n(t)??i(t);if(!r||!s)return e;let l=(e,t)=>Math.round(e*(1-a)+t*a),c=l(r[0],s[0]),o=l(r[1],s[1]),d=l(r[2],s[2]);return`rgb(${c}, ${o}, ${d})`})(e,t,.4));return[...e,...a]})(e,t)}};function c(){let[e,t]=(0,r.useState)(()=>l());return(0,r.useEffect)(()=>{let e=()=>t(l());e();let a=new MutationObserver(e);a.observe(document.documentElement,{attributes:!0,attributeFilter:["data-theme"]});let r=t=>{"sqm_theme"===t.key&&e()};return window.addEventListener("storage",r),()=>{a.disconnect(),window.removeEventListener("storage",r)}},[]),(0,r.useMemo)(()=>e,[e])}},37847:(e,t,a)=>{a.d(t,{v:()=>z});var r=a(95155),s=a(12115),i=a(68605),n=a(97085),l=a(37717);function c({data:e}){let t=(0,l.A)(),a=(0,s.useMemo)(()=>e?[e.withParking.count,e.withoutParking.count]:[],[e]),i=(0,s.useMemo)(()=>({chart:{type:"donut",background:"transparent",foreColor:t.text},labels:["含車位","無車位"],colors:[t.chart[0],t.chart[3]],plotOptions:{pie:{donut:{labels:{show:!0,total:{show:!0,label:"總交易",color:t.text,formatter:e=>e.globals.seriesTotals.reduce((e,t)=>e+t,0).toLocaleString()+" 筆"}}}}},dataLabels:{enabled:!0,formatter:e=>`${e.toFixed(1)}%`},legend:{show:!1},tooltip:{theme:"dark",y:{formatter:e=>`${e} 筆`}},stroke:{show:!1},responsive:[{breakpoint:480,options:{chart:{width:300},legend:{position:"bottom"}}}]}),[t]);return e&&(0!==e.withParking.count||0!==e.withoutParking.count)?(0,r.jsx)(n.A,{type:"donut",series:a,options:i,height:350,className:"w-full"}):(0,r.jsx)("div",{className:"text-zinc-500 text-center p-8",children:"無車位配比資料"})}var o=a(40980);function d({data:e,xLabel:t,yLabel:a,xUnit:i="",yUnit:n="",title:l,highlightIds:c=[]}){let[d,x]=(0,s.useState)(null),[h,m]=(0,s.useState)(null),[p,u]=(0,s.useState)({x:0,y:0}),{xMin:g,xMax:f,yMin:b,yMax:j}=(0,s.useMemo)(()=>{if(0===e.length)return{xMin:0,xMax:100,yMin:0,yMax:100};let t=e.map(e=>e.x),a=e.map(e=>e.y),r=Math.min(...t),s=Math.max(...t),i=Math.min(...a),n=Math.max(...a),l=(s-r)*.1||1,c=(n-i)*.1||1;return{xMin:Math.max(0,r-l),xMax:s+l,yMin:Math.max(0,i-c),yMax:n+c}},[e]),y=c.length>0,v=e=>{let t=e.currentTarget.closest(".relative.bg-zinc-900\\/30")?.getBoundingClientRect();t&&u({x:e.clientX-t.left,y:e.clientY-t.top})},N=h||d,w=(0,s.useMemo)(()=>c.length?[...e].sort((e,t)=>!!c.includes(e.id)-!!c.includes(t.id)):e,[e,c]);return(0,r.jsxs)("div",{className:"w-full h-[400px] relative bg-zinc-900/30 rounded-xl border border-white/5 p-4 select-none cursor-crosshair",onClick:()=>{m(null),x(null)},onMouseMove:e=>{!h&&d&&v(e)},children:[l&&(0,r.jsx)("h4",{className:"absolute top-4 left-4 text-sm font-medium text-zinc-400 pointer-events-none",children:l}),(0,r.jsxs)("div",{className:"absolute inset-x-12 inset-y-12 pointer-events-none",children:[(0,r.jsx)("div",{className:"absolute inset-0 flex flex-col justify-between opacity-20",children:[0,.25,.5,.75,1].map(e=>(0,r.jsx)("div",{className:"w-full h-px border-t border-dashed border-zinc-500"},e))}),(0,r.jsx)("div",{className:"absolute inset-0 flex justify-between opacity-20",children:[0,.25,.5,.75,1].map(e=>(0,r.jsx)("div",{className:"h-full w-px border-l border-dashed border-zinc-500"},e))})]}),(0,r.jsx)("div",{className:"absolute inset-x-12 inset-y-12",children:w.map(e=>{var t,a;let s=(t=e.x,a=e.y,{left:`${(t-g)/(f-g)*100}%`,top:`${100-(a-b)/(j-b)*100}%`}),i=d?.id===e.id,n=h?.id===e.id,l=y&&c.includes(e.id),p="bg-cyan-500/60 hover:bg-cyan-400 z-10",u="";return y&&(l?(p="bg-yellow-400 shadow-[0_0_10px_rgba(250,204,21,0.6)] z-20",u="scale-125"):p="bg-zinc-700/30 z-0"),(i||n)&&(p="bg-cyan-400 shadow-[0_0_15px_rgba(34,211,238,0.8)] ring-2 ring-white z-30",u="scale-150",y&&l&&(p="bg-yellow-400 shadow-[0_0_15px_rgba(250,204,21,0.8)] ring-2 ring-white z-30")),(0,r.jsx)("div",{className:(0,o.cn)("absolute w-3 h-3 rounded-full cursor-pointer transition-all duration-300 transform -translate-x-1/2 -translate-y-1/2",p,u),style:{left:s.left,top:s.top},onMouseEnter:t=>{h||(!y||c.includes(e.id))&&(x(e),v(t))},onMouseLeave:()=>!h&&x(null),onClick:t=>{t.stopPropagation(),(!y||c.includes(e.id))&&(h?.id===e.id?(m(null),x(e)):(m(e),x(null),v(t)))}},e.id)})}),(0,r.jsxs)("div",{className:"absolute left-0 top-12 bottom-12 w-10 flex flex-col justify-between text-[10px] text-zinc-500 text-right pr-2 pointer-events-none",children:[(0,r.jsxs)("span",{children:[Math.round(j),n]}),(0,r.jsxs)("span",{children:[Math.round(b),n]})]}),(0,r.jsxs)("div",{className:"absolute left-12 right-12 bottom-4 h-6 flex justify-between text-[10px] text-zinc-500 pt-1 pointer-events-none",children:[(0,r.jsxs)("span",{children:[Math.round(g),i]}),(0,r.jsxs)("span",{children:[Math.round(f),i]})]}),(0,r.jsx)("div",{className:"absolute bottom-1 left-1/2 -translate-x-1/2 text-xs text-zinc-400 font-bold pointer-events-none",children:t}),(0,r.jsx)("div",{className:"absolute left-1 top-1/2 -translate-y-1/2 -rotate-90 text-xs text-zinc-400 font-bold pointer-events-none",children:a}),N&&(0,r.jsx)("div",{className:"absolute z-50 pointer-events-none",style:{left:p.x,top:p.y,transform:"translate(10px, 10px)"},children:(0,r.jsxs)("div",{className:"bg-zinc-950/90 border border-cyan-500/30 rounded-lg p-3 shadow-xl backdrop-blur-md w-48 animate-in zoom-in-95 fade-in duration-200",children:[(0,r.jsx)("div",{className:"text-sm font-bold text-white mb-1",children:N.label}),(0,r.jsxs)("div",{className:"space-y-1 text-xs text-zinc-400",children:[(0,r.jsxs)("div",{className:"flex justify-between",children:[(0,r.jsxs)("span",{children:[t,":"]}),(0,r.jsxs)("span",{className:"text-cyan-400 font-mono",children:[N.x.toLocaleString()," ",i]})]}),(0,r.jsxs)("div",{className:"flex justify-between",children:[(0,r.jsxs)("span",{children:[a,":"]}),(0,r.jsxs)("span",{className:"text-cyan-400 font-mono",children:[N.y.toLocaleString()," ",n]})]})]})]})})]})}var x=a(47650),h=a(39430),m=a(80642);function p({data:e,selectedFloors:t,hoveredFloor:a,onHover:i,onToggle:n,onDetail:l,floorColors:c}){let d=[...e].sort((e,t)=>{let a=e=>"B1"===e?1:"B2"===e?2:"B3"===e?3:"B4"===e?4:e.includes("B5")?5:99;return a(e.floor)-a(t.floor)}),p=d.length>4?Math.max(.7,4/d.length):1,g=s.useRef(null),[f,b]=s.useState(!1);s.useEffect(()=>{b(!0)},[]);let j=d.find(e=>e.floor===a);return(0,r.jsxs)("div",{className:"w-full h-[600px] flex items-start justify-start relative perspective-container overflow-visible pl-12 lg:pl-24 -mt-12",onMouseMove:e=>{if(g.current){let t=e.clientX+12,a=e.clientY+12;g.current.style.transform=`translate3d(${t}px, ${a}px, 0)`}},children:[(0,r.jsx)("div",{className:"relative flex items-center justify-center preserve-3d",style:{width:240,height:240,perspective:"3000px",transformStyle:"preserve-3d",zIndex:10,transform:`scale(${p})`},children:(0,r.jsx)(h.P.div,{className:"relative preserve-3d",initial:{rotateX:60,rotateZ:45},animate:{rotateX:60,rotateZ:45},transition:{duration:.8,ease:"easeOut"},style:{transformStyle:"preserve-3d",width:"100%",height:"100%"},children:(0,r.jsx)(m.N,{children:d.map((e,s)=>{let n=t.includes(e.floor),o=a===e.floor,x=c[e.floor]||"#71717a";return(0,r.jsx)(u,{data:e,color:x,isSelected:n,isHovered:o,active:n,onHover:()=>i(e.floor),onLeave:()=>i(null),onDetail:()=>l(e.floor),zIndex:d.length-s,baseZ:-(110*s),thickness:40},e.floor)})})})}),f&&(0,x.createPortal)((0,r.jsx)("div",{className:"fixed inset-0 pointer-events-none z-[9999]",children:(0,r.jsx)(m.N,{children:j&&(0,r.jsx)("div",{ref:g,className:"absolute top-0 left-0 will-change-transform",style:{transform:"translate3d(-500px, -500px, 0)"},children:(0,r.jsx)(h.P.div,{initial:{opacity:0,scale:.95},animate:{opacity:1,scale:1},exit:{opacity:0,scale:.95,transition:{duration:.1}},transition:{type:"spring",stiffness:400,damping:25},className:"flex items-center justify-start",children:(0,r.jsxs)("div",{className:"flex items-center gap-3 whitespace-nowrap",children:[(0,r.jsx)("span",{className:(0,o.cn)("text-6xl font-black text-white drop-shadow-[0_5px_8px_rgba(0,0,0,0.8)] leading-none","font-sans italic tracking-tighter"),style:{textShadow:"0 0 30px rgba(255,255,255,0.4)"},children:j.floor}),(0,r.jsxs)("div",{className:"bg-zinc-950/95 border-l-4 border-cyan-500 backdrop-blur-xl px-4 py-2 rounded-r-lg shadow-[0_20px_50px_rgba(0,0,0,0.5)] flex items-center gap-6 border border-white/10",children:[(0,r.jsxs)("div",{children:[(0,r.jsx)("div",{className:"text-[10px] text-zinc-500 uppercase font-black leading-none mb-1 tracking-widest",children:"均價 (萬)"}),(0,r.jsx)("div",{className:"text-2xl font-mono font-bold text-cyan-400 leading-none",children:Math.round(j.avgPrice).toLocaleString()})]}),(0,r.jsx)("div",{className:"h-8 w-px bg-white/10"}),(0,r.jsxs)("div",{children:[(0,r.jsx)("div",{className:"text-[10px] text-zinc-500 uppercase font-black leading-none mb-1 tracking-widest",children:"成交量"}),(0,r.jsx)("div",{className:"text-xl font-mono text-zinc-100 leading-none font-medium",children:j.count})]})]})]})},"tooltip")})})}),document.body)]})}function u({data:e,color:t,isSelected:a,isHovered:s,active:i,onHover:n,onLeave:l,onDetail:c,zIndex:d,baseZ:x,thickness:m}){let p=s?t:"#52525b";return(0,r.jsxs)(h.P.div,{className:(0,o.cn)("absolute top-0 left-0 w-full h-full preserve-3d pointer-events-none",!i&&"pointer-events-none"),initial:{scale:.9,opacity:0},animate:{translateZ:x+0,scale:+!!i,opacity:+!!i},transition:{type:"spring",stiffness:600,damping:15},style:{transformStyle:"preserve-3d",zIndex:d},children:[(0,r.jsx)("div",{className:"absolute inset-0 rounded-sm overflow-hidden transition-all duration-75 pointer-events-auto cursor-pointer",style:{backgroundColor:p,backgroundImage:s?"linear-gradient(135deg, rgba(255,255,255,0.6) 0%, rgba(255,255,255,0.1) 50%, rgba(0,0,0,0.2) 100%)":"linear-gradient(135deg, rgba(255,255,255,0.2) 0%, rgba(255,255,255,0.05) 50%, rgba(0,0,0,0.1) 100%)",filter:s?"none":"brightness(1.1)",boxShadow:s?`inset 0 0 0 1px rgba(255,255,255,0.4), 0 0 30px -5px ${t}`:"inset 0 0 0 1px rgba(255,255,255,0.1)"},onMouseEnter:n,onMouseLeave:l,onClick:e=>{e.stopPropagation(),c()},children:(0,r.jsx)(h.P.div,{initial:{x:"-100%"},animate:s?{x:"200%"}:{x:"-100%"},transition:{duration:1.5,repeat:1/0,repeatDelay:1},className:"absolute top-0 left-0 w-1/2 h-full bg-gradient-to-r from-transparent via-white/20 to-transparent skew-x-12 pointer-events-none"})}),(0,r.jsx)("div",{className:"absolute top-0 origin-top-right transition-all duration-75 pointer-events-auto cursor-pointer",style:{right:0,width:m,height:"100%",backgroundColor:p,filter:s?"brightness(0.6)":"brightness(0.5)",left:"100%",transformOrigin:"left center",transform:"rotateY(90deg)"},onMouseEnter:n,onMouseLeave:l,onClick:e=>{e.stopPropagation(),c()}}),(0,r.jsx)("div",{className:"absolute left-0 origin-bottom-left transition-all duration-75 pointer-events-auto cursor-pointer",style:{bottom:0,width:"100%",height:m,backgroundColor:p,filter:s?"brightness(0.8)":"brightness(0.3)",top:"100%",transformOrigin:"top center",transform:"rotateX(-90deg)"},onMouseEnter:n,onMouseLeave:l,onClick:e=>{e.stopPropagation(),c()}})]})}var g=a(94961),f=a(94514),b=a(57420),j=a(61878),y=a(51806),v=a(89733),N=a(9505);function w({chartData:e,hasData:t,summaryStats:a}){let[i,n]=(0,s.useState)("scale"),[l,c]=(0,s.useState)(null);s.useRef(null);let[x,h]=(0,s.useState)([]);if(!t)return(0,r.jsx)("p",{className:"text-zinc-500 text-center py-4",children:"無坡道平面車位坪數資料"});let m="scale"===i?e.map(e=>({id:e.id,label:e.id,x:e.count,y:e.avgArea})):e.map(e=>({id:e.id,label:e.id,x:e.avgPrice,y:e.avgArea}));return(0,r.jsxs)("div",{className:"grid grid-cols-1 lg:grid-cols-3 gap-8 relative","data-report-control":"allow",children:[l&&(0,r.jsxs)("div",{className:"fixed z-50 px-3 py-2 bg-zinc-900 border border-white/10 rounded-lg shadow-xl text-xs text-zinc-300 pointer-events-none transform -translate-x-1/2 -translate-y-full animate-in fade-in zoom-in-95",style:{left:l.x,top:l.y},children:[l.text,(0,r.jsx)("div",{className:"absolute left-1/2 bottom-0 w-2 h-2 bg-zinc-900 border-r border-b border-white/10 text-zinc-900 transform rotate-45 -translate-x-1/2 -mb-1"})]}),(0,r.jsxs)("div",{className:"lg:col-span-1 space-y-6",children:[(0,r.jsxs)("div",{className:"space-y-4",children:[(0,r.jsx)("h4",{className:"text-sm font-medium text-zinc-400 pl-1 border-l-2 border-cyan-500",children:"總體統計數據"}),(0,r.jsx)("div",{className:"bg-zinc-900/30 rounded-xl border border-white/5 p-4",children:(0,r.jsx)("table",{className:"w-full text-sm",children:(0,r.jsxs)("tbody",{className:"divide-y divide-white/5",children:[(0,r.jsxs)("tr",{children:[(0,r.jsx)("td",{className:"py-3 text-zinc-500",children:"數據範圍"}),(0,r.jsxs)("td",{className:"py-3 text-right font-mono text-white",children:[(0,r.jsx)("span",{className:"text-cyan-400",children:e.length})," 建案",(0,r.jsx)("span",{className:"mx-1 text-zinc-600",children:"/"}),(0,r.jsx)("span",{className:"text-zinc-300",children:a.count.toLocaleString()})," 車位"]})]}),(0,r.jsxs)("tr",{children:[(0,r.jsx)("td",{className:"py-3 text-zinc-500",children:"平均坪數"}),(0,r.jsxs)("td",{className:"py-3 text-right font-mono text-cyan-400 text-lg font-bold",children:[a.avgArea.toFixed(2)," ",(0,r.jsx)("span",{className:"text-xs font-normal text-zinc-500",children:"坪"})]})]}),(0,r.jsxs)("tr",{children:[(0,r.jsx)("td",{className:"py-3 text-zinc-500",children:"坪數中位數"}),(0,r.jsxs)("td",{className:"py-3 text-right font-mono text-zinc-300 text-lg font-bold",children:[a.medianArea.toFixed(2)," ",(0,r.jsx)("span",{className:"text-xs font-normal text-zinc-500",children:"坪"})]})]})]})})})]}),(0,r.jsx)(N.l,{projects:e.map(e=>({value:e.id,label:e.id})),className:"w-full",onChange:e=>h(e),max:6})]}),(0,r.jsxs)("div",{className:"lg:col-span-2 space-y-4",children:[(0,r.jsxs)("div",{className:"flex flex-wrap justify-between items-center gap-2",children:[(0,r.jsxs)("div",{children:[(0,r.jsx)("h4",{className:"text-sm font-medium text-zinc-400 pl-1 border-l-2 border-violet-500",children:"分佈散佈圖"}),(0,r.jsx)("div",{className:"mt-1 text-xs text-zinc-500 font-mono",children:"scale"===i?(0,r.jsxs)("span",{children:[(0,r.jsx)("span",{className:"text-cyan-400",children:"X軸"}),": 建案車位總數 ",(0,r.jsx)("span",{className:"text-zinc-600",children:"|"})," ",(0,r.jsx)("span",{className:"text-cyan-400",children:"Y軸"}),": 平均車位坪數"]}):(0,r.jsxs)("span",{children:[(0,r.jsx)("span",{className:"text-cyan-400",children:"X軸"}),": 平均車位價格 ",(0,r.jsx)("span",{className:"text-zinc-600",children:"|"})," ",(0,r.jsx)("span",{className:"text-cyan-400",children:"Y軸"}),": 平均車位坪數"]})})]}),(0,r.jsxs)("div",{className:"flex gap-2 items-center",children:[(0,r.jsxs)("div",{className:"relative group",children:[(0,r.jsx)("button",{className:"p-1.5 text-zinc-500 hover:text-cyan-400 transition-colors",children:(0,r.jsx)(g.A,{size:14})}),(0,r.jsx)("div",{className:"absolute right-0 top-full mt-2 w-64 p-3 bg-zinc-900 border border-white/10 rounded-lg shadow-xl z-50 opacity-0 group-hover:opacity-100 transition-opacity pointer-events-none",children:(0,r.jsx)("div",{className:"text-xs text-zinc-300 leading-relaxed",children:"scale"===i?"分析各建案「規劃車位總數」與「平均車位坪數」的關係。可觀察大社區是否傾向規劃較大或較小的車位。":"分析各建案「平均車位價格」與「平均車位坪數」的關係。可觀察車位價格是否隨著坪數增加而顯著提升。"})})]}),(0,r.jsx)("div",{className:"w-px h-4 bg-white/10 mx-1"}),(0,r.jsx)("button",{onClick:()=>n("scale"),className:(0,o.cn)("px-3 py-1.5 text-xs font-medium rounded-md border transition-all duration-200","scale"===i?"bg-cyan-500/10 text-cyan-400 border-cyan-500/50 shadow-[0_0_10px_rgba(34,211,238,0.1)]":"bg-zinc-900/50 border-white/10 text-zinc-500 hover:text-zinc-300 hover:bg-white/5"),children:"規模分析"}),(0,r.jsx)("button",{onClick:()=>n("value"),className:(0,o.cn)("px-3 py-1.5 text-xs font-medium rounded-md border transition-all duration-200","value"===i?"bg-cyan-500/10 text-cyan-400 border-cyan-500/50 shadow-[0_0_10px_rgba(34,211,238,0.1)]":"bg-zinc-900/50 border-white/10 text-zinc-500 hover:text-zinc-300 hover:bg-white/5"),children:"價值分析"})]})]}),(0,r.jsx)(d,{data:m,xLabel:"scale"===i?"建案車位總數":"平均車位價格",yLabel:"平均車位坪數",xUnit:"scale"===i?"位":"萬",yUnit:"坪",title:"scale"===i?"建案規模 vs 車位坪數分佈":"車位價值 vs 坪數分佈",highlightIds:x})]})]})}function z({data:e,visibleSections:t=["ratio","price","scatter","floor"]}){let[a,n]=(0,s.useState)(["B1","B2","B3","B4"]),[l,d]=(0,s.useState)(null),x=s.useRef(null),h=s.useRef(null),m=s.useRef(null),u=s.useRef(null),[g,N]=(0,s.useState)(!1),[z,k]=(0,s.useState)(null),[S,P]=(0,s.useState)([]),[M,A]=(0,s.useState)(!1),[C,_]=(0,s.useState)(0),$=(t,a=!0)=>{k(t),A(!1);let r=R?.find(e=>e.floor===t),s=r?.rawRecords;if(s&&s.length>0){let e=s.map(e=>({...e,_isMatch:!0}));e.sort((e,t)=>{let a=e["交易年月日"]||0;return(t["交易年月日"]||0)-a}),P(e),_(e.length)}else{let a=e?.transactionDetails||[],r=[t];"B1"===t&&r.push("地下一層","B1","b1"),"B2"===t&&r.push("地下二層","B2","b2"),"B3"===t&&r.push("地下三層","B3","b3"),"B4"===t&&r.push("地下四層","B4","b4"),"B5_below"===t&&r.push("地下五層","B5","b5");let s=a.filter(e=>(e["車位類別"]||"").includes("坡道平面")),i=s.filter(e=>{let t=e["車位所在樓層"]||"",a=e["備註"]||"";return r.some(e=>t&&t.includes(e)||a&&a.includes(e))});_(i.length);let n=s.map(e=>{let t=e["車位所在樓層"]||"",a=e["備註"]||"",s=r.some(e=>t&&t.includes(e)||a&&a.includes(e));return{...e,_isMatch:s}});n.sort((e,t)=>{if(e._isMatch&&!t._isMatch)return -1;if(!e._isMatch&&t._isMatch)return 1;let a=e["交易年月日"]||0;return(t["交易年月日"]||0)-a}),P(n),0===i.length&&A(!0)}a&&N(!0)};if(!e?.parkingAnalysis)return null;let{parkingRatio:F,avgPriceByType:E,rampPlanePriceByFloor:R}=e.parkingAnalysis,T=["B1","B2","B3","B4","B5_below","Unknown"],I=R?.filter(e=>T.includes(e.floor)&&e.count>0)||[],L=t.includes("ratio"),D=t.includes("price"),O=t.includes("scatter"),B=t.includes("floor"),W=t.includes("floor-detail")&&!L&&!D&&!O&&!B;s.useEffect(()=>{if(!W||z)return;let e=I[0]?.floor||"B1";e&&$(e,!1)},[W,z,I]);let U=(0,s.useMemo)(()=>(function(e,t){let a=[];if(e.forEach(e=>{t.includes(e.floor)&&e.rawRecords&&e.rawRecords.forEach(e=>{"number"!=typeof e.parkingPrice||isNaN(e.parkingPrice)||a.push(e.parkingPrice)})}),0===a.length)return{avgPrice:0,medianPrice:0,q3Price:0,count:0};a.sort((e,t)=>e-t);let r=a.reduce((e,t)=>e+t,0)/a.length,s=a[Math.floor(a.length/2)],i=Math.floor(.75*a.length),n=a[i]||s;return{avgPrice:r,medianPrice:s,q3Price:n,count:a.length}})(I,a),[I,a]),H=(0,s.useCallback)(e=>{n(t=>t.includes(e)?t.filter(t=>t!==e):[...t,e])},[]),q=(0,s.useCallback)(()=>{a.length===T.length?n([]):n([...T])},[a.length]),Y=()=>(0,r.jsxs)("div",{className:"space-y-4",children:[(0,r.jsxs)("div",{className:"flex items-center gap-2 bg-zinc-800/50 p-1 rounded-lg border border-white/10",children:[(0,r.jsxs)("button",{onClick:()=>A(!1),className:(0,o.cn)("px-3 py-1.5 rounded text-xs transition-colors font-medium flex items-center gap-1.5",M?"text-zinc-500 hover:text-zinc-300 hover:bg-white/5":"bg-cyan-500/20 text-cyan-400 border border-cyan-500/30 shadow-[0_0_10px_rgba(34,211,238,0.1)]"),children:[(0,r.jsx)(f.A,{size:12}),"精確匹配 (",C,")"]}),(0,r.jsxs)("button",{onClick:()=>A(!0),className:(0,o.cn)("px-3 py-1.5 rounded text-xs transition-colors font-medium",M?"bg-rose-500/20 text-rose-400 border border-rose-500/30 shadow-[0_0_10px_rgba(244,63,94,0.1)]":"text-zinc-500 hover:text-zinc-300 hover:bg-white/5"),children:["未匹配 (",S.length-C,")"]}),(0,r.jsx)("div",{className:"ml-auto",children:(0,r.jsx)(v.N,{data:S.filter(e=>M?!e._isMatch:e._isMatch),filename:`parking_details_${z||"floor"}_${M?"all":"match"}`,label:"匯出明細"})})]}),(0,r.jsx)("div",{className:"overflow-x-auto rounded-lg border border-white/10 max-h-[60vh] custom-scrollbar",children:(0,r.jsxs)("table",{className:"w-full text-sm text-left",children:[(0,r.jsx)("thead",{className:"bg-zinc-900/80 text-zinc-400 whitespace-nowrap sticky top-0 z-10 backdrop-blur-md",children:(0,r.jsxs)("tr",{children:[(0,r.jsx)("th",{className:"p-3",children:"建案名稱"}),(0,r.jsx)("th",{className:"p-3",children:"交易日期"}),(0,r.jsx)("th",{className:"p-3 text-right",children:"車位總價"}),(0,r.jsx)("th",{className:"p-3 text-right",children:"車位面積"}),(0,r.jsx)("th",{className:"p-3",children:"車位樓層"}),(0,r.jsx)("th",{className:"p-3",children:"備註"})]})}),(0,r.jsx)("tbody",{className:"divide-y divide-white/5",children:S.length>0?S.filter(e=>M?!e._isMatch:e._isMatch).map((e,t)=>(0,r.jsxs)("tr",{className:(0,o.cn)("hover:bg-zinc-800/50 transition-colors",e._isMatch?"bg-cyan-500/5":"opacity-60"),children:[(0,r.jsxs)("td",{className:"p-3 font-medium text-white",children:[(0,r.jsx)("div",{children:e["建案名稱"]}),(0,r.jsxs)("div",{className:"text-[10px] text-zinc-600 font-mono mt-0.5",children:["#",e.transactionId||e["編號"]]})]}),(0,r.jsxs)("td",{className:"p-3 text-zinc-400 flex items-center gap-1",children:[(0,r.jsx)(b.A,{size:12,className:"text-zinc-600"}),e["交易日"]]}),(0,r.jsxs)("td",{className:"p-3 text-right font-mono text-cyan-400",children:[e["車位總價元"]?(e["車位總價元"]/1e4).toLocaleString():"-"," 萬"]}),(0,r.jsxs)("td",{className:"p-3 text-right font-mono text-zinc-300",children:[e["車位移轉總面積平方公尺"]?(.3025*e["車位移轉總面積平方公尺"]).toFixed(2):"-"," 坪"]}),(0,r.jsx)("td",{className:"p-3 text-zinc-300",children:e["車位所在樓層"]||"-"}),(0,r.jsx)("td",{className:"p-3 text-zinc-500 text-xs max-w-[200px] truncate",title:e["備註"],children:e["備註"]})]},t)):(0,r.jsx)("tr",{children:(0,r.jsx)("td",{colSpan:6,className:"p-8 text-center text-zinc-500",children:"查無相關交易資料。"})})})]})})]}),Z={B1:"#06b6d4",B2:"#3b82f6",B3:"#6366f1",B4:"#8b5cf6",B5_below:"#a855f7",Unknown:"#71717a"},{parkingChartData:V,parkingChartStats:G,hasParkingData:J}=(0,s.useMemo)(()=>{let e=new Map,t=!1;I.forEach(a=>{a.rawRecords&&a.rawRecords.forEach(a=>{let r=a["建案名稱"],s=a.parkingArea||a["車位面積(坪)"]||.3025*(a["車位移轉總面積平方公尺"]||0),i=a.parkingPrice||a["車位價格(萬)"]||0;if(r&&s>0){e.has(r)||e.set(r,{count:0,totalArea:0,totalPrice:0});let a=e.get(r);a.count+=1,a.totalArea+=s,a.totalPrice+=i,t=!0}})});let a=Array.from(e.entries()).map(([e,t])=>({id:e,label:e,avgArea:parseFloat((t.totalArea/t.count).toFixed(2)),count:t.count,avgPrice:parseFloat((t.totalPrice/t.count).toFixed(2))})),r=0,s=[];a.forEach(e=>{r+=e.count,s.push(e.avgArea)}),s.sort((e,t)=>e-t);let i=s.length>0?s.reduce((e,t)=>e+t,0)/s.length:0,n=s.length>0?s[Math.floor(s.length/2)]:0;return{parkingChartData:a,parkingChartStats:{count:r,avgArea:i,medianArea:n},hasParkingData:t}},[I]);return W?(0,r.jsx)("div",{className:"space-y-4 animate-in fade-in slide-in-from-bottom-4 duration-500 text-white",children:Y()}):(0,r.jsxs)("div",{className:"space-y-6 animate-in fade-in slide-in-from-bottom-4 duration-500 text-white",children:[L&&D?(0,r.jsxs)("div",{className:"grid grid-cols-1 lg:grid-cols-2 gap-6",children:[(0,r.jsx)(i.c,{title:"房車配比分析",description:"建案有購置車位的比例",containerRef:x,headerAction:(0,r.jsx)(v.N,{data:[{type:"有車位",...F?.withParking},{type:"無車位",...F?.withoutParking},{ratio:F?.avgRatio}],filename:"parking_ratio_data",label:"匯出",columns:{type:"類別",count:"數量",percentage:"百分比",ratio:"比率"},chartType:"parking-pie",targetRef:x,snapshotData:[{type:"有車位",...F?.withParking},{type:"無車位",...F?.withoutParking},{ratio:F?.avgRatio}]}),children:(0,r.jsxs)("div",{className:"flex flex-col md:flex-row items-start gap-6",children:[(0,r.jsx)("div",{className:"w-full md:w-1/2",children:(0,r.jsx)(c,{data:F})}),(0,r.jsx)("div",{className:"w-full md:w-1/2 flex flex-col gap-4",children:(0,r.jsxs)("table",{className:"w-full text-sm",children:[(0,r.jsx)("thead",{className:"bg-zinc-900/50 text-zinc-500",children:(0,r.jsxs)("tr",{children:[(0,r.jsx)("th",{className:"p-2 text-left",children:"類型"}),(0,r.jsx)("th",{className:"p-2 text-right",children:"筆數"}),(0,r.jsx)("th",{className:"p-2 text-right",children:"佔比"})]})}),(0,r.jsxs)("tbody",{className:"divide-y divide-white/5",children:[(0,r.jsxs)("tr",{children:[(0,r.jsxs)("td",{className:"p-2 flex items-center gap-2",children:[(0,r.jsx)("span",{className:"w-3 h-3 rounded-full bg-indigo-300"}),"有搭車位"]}),(0,r.jsx)("td",{className:"p-2 text-right font-mono text-zinc-300",children:F?.withParking?.count.toLocaleString()}),(0,r.jsxs)("td",{className:"p-2 text-right font-mono text-cyan-400",children:[F?.withParking?.percentage.toFixed(2),"%"]})]}),(0,r.jsxs)("tr",{children:[(0,r.jsxs)("td",{className:"p-2 flex items-center gap-2",children:[(0,r.jsx)("span",{className:"w-3 h-3 rounded-full bg-gray-600"}),"無車位"]}),(0,r.jsx)("td",{className:"p-2 text-right font-mono text-zinc-300",children:F?.withoutParking?.count.toLocaleString()}),(0,r.jsxs)("td",{className:"p-2 text-right font-mono text-zinc-500",children:[F?.withoutParking?.percentage.toFixed(2),"%"]})]})]})]})})]})}),(0,r.jsx)(i.c,{title:"車位類型均價",description:"各類車位成交行情",containerRef:h,headerAction:(0,r.jsx)(v.N,{data:E||[],filename:"parking_price_by_type",label:"匯出",columns:{type:"車位類型",avgPrice:"平均價格",medianPrice:"中位數",count:"數量"},chartType:"parking-price",targetRef:h,snapshotData:E||[]}),children:(0,r.jsxs)("table",{className:"w-full text-sm",children:[(0,r.jsx)("thead",{className:"bg-zinc-900/50 text-zinc-500",children:(0,r.jsxs)("tr",{children:[(0,r.jsx)("th",{className:"p-2 text-left",children:"類型"}),(0,r.jsx)("th",{className:"p-2 text-right",children:"均價(萬)"}),(0,r.jsx)("th",{className:"p-2 text-right",children:"中位數"}),(0,r.jsx)("th",{className:"p-2 text-right",children:"總數"})]})}),(0,r.jsx)("tbody",{className:"divide-y divide-white/5",children:E?.map(e=>(0,r.jsxs)("tr",{className:"hover:bg-zinc-800/50",children:[(0,r.jsx)("td",{className:"p-2 font-medium",children:e.type}),(0,r.jsx)("td",{className:"p-2 text-right font-mono text-cyan-400",children:Math.round(e.avgPrice).toLocaleString()}),(0,r.jsx)("td",{className:"p-2 text-right font-mono text-zinc-300",children:Math.round(e.medianPrice).toLocaleString()}),(0,r.jsx)("td",{className:"p-2 text-right font-mono text-zinc-500",children:e.count.toLocaleString()})]},e.type))})]})})]}):(0,r.jsxs)(r.Fragment,{children:[L&&(0,r.jsx)(i.c,{title:"房車配比分析",description:"建案有購置車位的比例",containerRef:x,headerAction:(0,r.jsx)(v.N,{data:[{type:"有車位",...F?.withParking},{type:"無車位",...F?.withoutParking},{ratio:F?.avgRatio}],filename:"parking_ratio_data",label:"匯出",columns:{type:"類別",count:"數量",percentage:"百分比",ratio:"比率"},chartType:"parking-pie",targetRef:x,snapshotData:[{type:"有車位",...F?.withParking},{type:"無車位",...F?.withoutParking},{ratio:F?.avgRatio}]}),children:(0,r.jsxs)("div",{className:"flex flex-col md:flex-row items-start gap-6",children:[(0,r.jsx)("div",{className:"w-full md:w-1/2",children:(0,r.jsx)(c,{data:F})}),(0,r.jsx)("div",{className:"w-full md:w-1/2 flex flex-col gap-4",children:(0,r.jsxs)("table",{className:"w-full text-sm",children:[(0,r.jsx)("thead",{className:"bg-zinc-900/50 text-zinc-500",children:(0,r.jsxs)("tr",{children:[(0,r.jsx)("th",{className:"p-2 text-left",children:"類型"}),(0,r.jsx)("th",{className:"p-2 text-right",children:"筆數"}),(0,r.jsx)("th",{className:"p-2 text-right",children:"佔比"})]})}),(0,r.jsxs)("tbody",{className:"divide-y divide-white/5",children:[(0,r.jsxs)("tr",{children:[(0,r.jsxs)("td",{className:"p-2 flex items-center gap-2",children:[(0,r.jsx)("span",{className:"w-3 h-3 rounded-full bg-indigo-300"}),"有搭車位"]}),(0,r.jsx)("td",{className:"p-2 text-right font-mono text-zinc-300",children:F?.withParking?.count.toLocaleString()}),(0,r.jsxs)("td",{className:"p-2 text-right font-mono text-cyan-400",children:[F?.withParking?.percentage.toFixed(2),"%"]})]}),(0,r.jsxs)("tr",{children:[(0,r.jsxs)("td",{className:"p-2 flex items-center gap-2",children:[(0,r.jsx)("span",{className:"w-3 h-3 rounded-full bg-gray-600"}),"無車位"]}),(0,r.jsx)("td",{className:"p-2 text-right font-mono text-zinc-300",children:F?.withoutParking?.count.toLocaleString()}),(0,r.jsxs)("td",{className:"p-2 text-right font-mono text-zinc-500",children:[F?.withoutParking?.percentage.toFixed(2),"%"]})]})]})]})})]})}),D&&(0,r.jsx)(i.c,{title:"車位類型均價",description:"各類車位成交行情",containerRef:h,headerAction:(0,r.jsx)(v.N,{data:E||[],filename:"parking_price_by_type",label:"匯出",columns:{type:"車位類型",avgPrice:"平均價格",medianPrice:"中位數",count:"數量"},chartType:"parking-price",targetRef:h,snapshotData:E||[]}),children:(0,r.jsxs)("table",{className:"w-full text-sm",children:[(0,r.jsx)("thead",{className:"bg-zinc-900/50 text-zinc-500",children:(0,r.jsxs)("tr",{children:[(0,r.jsx)("th",{className:"p-2 text-left",children:"類型"}),(0,r.jsx)("th",{className:"p-2 text-right",children:"均價(萬)"}),(0,r.jsx)("th",{className:"p-2 text-right",children:"中位數"}),(0,r.jsx)("th",{className:"p-2 text-right",children:"總數"})]})}),(0,r.jsx)("tbody",{className:"divide-y divide-white/5",children:E?.map(e=>(0,r.jsxs)("tr",{className:"hover:bg-zinc-800/50",children:[(0,r.jsx)("td",{className:"p-2 font-medium",children:e.type}),(0,r.jsx)("td",{className:"p-2 text-right font-mono text-cyan-400",children:Math.round(e.avgPrice).toLocaleString()}),(0,r.jsx)("td",{className:"p-2 text-right font-mono text-zinc-300",children:Math.round(e.medianPrice).toLocaleString()}),(0,r.jsx)("td",{className:"p-2 text-right font-mono text-zinc-500",children:e.count.toLocaleString()})]},e.type))})]})})]}),O&&(0,r.jsx)(i.c,{title:"坡道平面車位坪數散佈分析",description:"建案車位數與坪數分佈",className:"relative z-20",containerRef:m,headerAction:(0,r.jsx)(v.N,{data:V||[],filename:"parking_area_scatter_data",label:"匯出",columns:{id:"建案名稱",label:"標籤",avgArea:"平均坪數",count:"車位數",avgPrice:"平均價格"},chartType:"parking-scatter",targetRef:m,snapshotData:V||[]}),children:(0,r.jsx)(w,{chartData:V,hasData:J,summaryStats:G})}),B&&(0,r.jsx)(i.c,{title:"坡道平面車位 - 樓層價差分析",description:"勾選樓層以動態更新統計數據",containerRef:u,headerAction:(0,r.jsx)(v.N,{data:I||[],filename:"parking_floor_analysis",label:"匯出",columns:{floor:"樓層",count:"數量",avgPrice:"平均價格",medianPrice:"中位數",maxPrice:"最高價",minPrice:"最低價",q3Price:"第三四分位數"},chartType:"parking-floor",targetRef:u,snapshotData:I||[]}),children:(0,r.jsxs)("div",{className:"grid grid-cols-1 lg:grid-cols-2 gap-8",children:[(0,r.jsxs)("div",{className:"flex flex-col items-center justify-center p-8 bg-zinc-900/10 rounded-xl relative overflow-visible min-h-[450px]",children:[(0,r.jsx)("div",{className:"absolute inset-0 bg-gradient-to-b from-zinc-900/0 via-zinc-900/20 to-zinc-900/0 pointer-events-none"}),(0,r.jsx)(p,{data:I,selectedFloors:a,hoveredFloor:l,onHover:d,onToggle:H,onDetail:e=>$(e),floorColors:Z}),(0,r.jsx)("div",{className:"absolute bottom-4 left-0 w-full text-center text-zinc-600 text-xs pointer-events-none",children:"點擊方塊選取 • 懸停查看詳情"})]}),(0,r.jsx)(y.a,{isOpen:g,onClose:()=>N(!1),title:`${z} 車位交易明細`,maxWidth:"max-w-5xl",children:Y()}),(0,r.jsxs)("div",{className:"space-y-4",children:[(0,r.jsxs)("div",{className:"p-4 bg-gradient-to-r from-cyan-500/10 to-violet-500/10 border border-cyan-500/30 rounded-lg",children:[(0,r.jsx)("h4",{className:"text-sm font-medium text-cyan-400 mb-3",children:"已選樓層統計"}),(0,r.jsxs)("div",{className:"grid grid-cols-2 md:grid-cols-4 gap-4",children:[(0,r.jsxs)("div",{children:[(0,r.jsx)("div",{className:"text-xs text-zinc-500",children:"車位數"}),(0,r.jsx)("div",{className:"text-lg font-bold text-white",children:U.count.toLocaleString()})]}),(0,r.jsxs)("div",{children:[(0,r.jsx)("div",{className:"text-xs text-zinc-500",children:"平均單價"}),(0,r.jsxs)("div",{className:"text-lg font-bold text-cyan-400",children:[Math.round(U.avgPrice).toLocaleString()," 萬"]})]}),(0,r.jsxs)("div",{children:[(0,r.jsx)("div",{className:"text-xs text-zinc-500",children:"中位數"}),(0,r.jsxs)("div",{className:"text-lg font-bold text-zinc-300",children:[Math.round(U.medianPrice).toLocaleString()," 萬"]})]}),(0,r.jsxs)("div",{children:[(0,r.jsx)("div",{className:"text-xs text-zinc-500",children:"3/4位數"}),(0,r.jsxs)("div",{className:"text-lg font-bold text-zinc-300",children:[Math.round(U.q3Price).toLocaleString()," 萬"]})]})]})]}),(0,r.jsx)("div",{className:"overflow-x-auto",children:(0,r.jsxs)("table",{className:"w-full text-sm",children:[(0,r.jsx)("thead",{className:"bg-zinc-900/50 text-zinc-500",children:(0,r.jsxs)("tr",{children:[(0,r.jsx)("th",{className:"p-2 text-left",children:(0,r.jsxs)("label",{className:"flex items-center gap-2 cursor-pointer",children:[(0,r.jsx)("input",{type:"checkbox",checked:a.length===T.length,onChange:q,className:"form-checkbox rounded bg-zinc-800 border-zinc-600 text-cyan-500"}),(0,r.jsx)("span",{children:"全選"})]})}),(0,r.jsx)("th",{className:"p-2 text-left",children:"樓層"}),(0,r.jsx)("th",{className:"p-2 text-right",children:"均價(萬)"}),(0,r.jsx)("th",{className:"p-2 text-right",children:"中位數"}),(0,r.jsx)("th",{className:"p-2 text-right",children:"最高"}),(0,r.jsx)("th",{className:"p-2 text-right",children:"最低"}),(0,r.jsx)("th",{className:"p-2 text-right",children:"車位數"}),(0,r.jsx)("th",{className:"p-2 text-center",children:"操作"})]})}),(0,r.jsx)("tbody",{className:"divide-y divide-white/5",children:I.map(e=>{let t=a.includes(e.floor),s=l===e.floor;return(0,r.jsxs)("tr",{onMouseEnter:()=>d(e.floor),onMouseLeave:()=>d(null),className:(0,o.cn)("transition-colors cursor-pointer",s?"bg-zinc-800":"hover:bg-zinc-800/50",!t&&"opacity-50"),onClick:()=>H(e.floor),children:[(0,r.jsx)("td",{className:"p-2",children:(0,r.jsx)("input",{type:"checkbox",checked:t,onChange:()=>H(e.floor),className:"form-checkbox rounded bg-zinc-800 border-zinc-600 text-cyan-500",onClick:e=>e.stopPropagation()})}),(0,r.jsx)("td",{className:"p-2 font-medium",children:(0,r.jsxs)("div",{className:"flex items-center gap-2",children:[(0,r.jsx)("span",{className:"w-3 h-3 rounded-full",style:{backgroundColor:Z[e.floor]}}),e.floor]})}),(0,r.jsx)("td",{className:"p-2 text-right font-mono text-cyan-400",children:Math.round(e.avgPrice).toLocaleString()}),(0,r.jsx)("td",{className:"p-2 text-right font-mono text-zinc-300",children:Math.round(e.medianPrice).toLocaleString()}),(0,r.jsx)("td",{className:"p-2 text-right font-mono text-zinc-500",children:Math.round(e.maxPrice).toLocaleString()}),(0,r.jsx)("td",{className:"p-2 text-right font-mono text-zinc-500",children:Math.round(e.minPrice).toLocaleString()}),(0,r.jsx)("td",{className:"p-2 text-right font-mono text-zinc-500",children:e.count.toLocaleString()}),(0,r.jsx)("td",{className:"p-2 text-center",children:(0,r.jsx)("button",{onClick:t=>{t.stopPropagation(),$(e.floor)},className:"p-1.5 rounded-full hover:bg-cyan-500/20 text-zinc-400 hover:text-cyan-400 transition-colors",title:"查看明細",children:(0,r.jsx)(j.A,{size:14})})})]},e.floor)})})]})})]})]})})]})}},48551:(e,t,a)=>{a.d(t,{K:()=>o});var r=a(95155),s=a(12115),i=a(88743),n=a(80642),l=a(39430),c=a(40980);function o(){let{selectedRoomTypes:e,setSelectedRoomTypes:t}=(0,i.P)(),[a,o]=(0,s.useState)(!1),[d,x]=(0,s.useState)(!1);return(0,s.useEffect)(()=>{let e=()=>{let e=document.getElementById("room-type-filter-anchor");e&&o(e.getBoundingClientRect().bottom<80)};return window.addEventListener("scroll",e),e(),()=>window.removeEventListener("scroll",e)},[]),(0,s.useEffect)(()=>{let e=document.querySelector("aside");if(!e)return;let t=()=>x(!0),a=()=>x(!1);return e.addEventListener("mouseenter",t),e.addEventListener("mouseleave",a),()=>{e.removeEventListener("mouseenter",t),e.removeEventListener("mouseleave",a)}},[]),(0,r.jsx)(n.N,{children:a&&!d&&(0,r.jsxs)(l.P.div,{initial:{opacity:0,y:20},animate:{opacity:1,y:0},exit:{opacity:0,y:20},transition:{duration:.3},"data-report-control":"always-hide",className:(0,c.cn)("fixed z-[90] flex gap-1.5 p-1.5 bg-zinc-900/95 backdrop-blur-md border border-white/10 rounded-xl shadow-xl","flex-row bottom-8 left-1/2 -translate-x-1/2 items-center max-w-[90vw]","md:flex-col md:left-20 md:top-1/2 md:-translate-y-1/2 md:bottom-auto md:translate-x-0 md:items-stretch md:max-w-none"),children:[(0,r.jsx)("div",{className:(0,c.cn)("text-[9px] text-zinc-500 font-medium overflow-hidden","md:writing-mode-vertical md:text-center md:mb-0.5","whitespace-nowrap px-1"),children:"房型"}),(0,r.jsx)("div",{className:"flex md:flex-col gap-1.5 overflow-x-auto md:overflow-visible max-w-full md:max-w-none pb-2 md:pb-0 scrollbar-thumb-zinc-600 pr-8 md:pr-0",children:i.M.map(a=>(0,r.jsx)("button",{onClick:()=>{t(e.includes(a)?e.filter(e=>e!==a):[...e,a])},className:(0,c.cn)("px-2 py-1 text-[10px] font-medium rounded-lg transition-all hover:scale-105 active:scale-95 whitespace-nowrap",e.includes(a)?"bg-violet-500 text-white shadow-lg shadow-violet-500/20":"bg-zinc-800/50 text-zinc-400 hover:bg-zinc-700 hover:text-white"),children:a},a))}),e.length>0&&e.length<i.M.length&&(0,r.jsx)("button",{onClick:()=>t([]),className:(0,c.cn)("text-[9px] text-cyan-400 hover:text-cyan-300 transition-colors whitespace-nowrap px-1","md:mt-1 md:border-t md:border-white/5 md:pt-1 md:text-center md:px-0","border-l border-white/5 pl-1 md:border-l-0 md:pl-0"),children:"清除"})]})})}},51806:(e,t,a)=>{a.d(t,{a:()=>l});var r=a(95155);a(12115);var s=a(33210),i=a(40980),n=a(81477);function l({isOpen:e,onClose:t,title:a,children:l,className:c,maxWidth:o="max-w-4xl"}){return e?(0,r.jsxs)("div",{className:"fixed inset-0 z-50 flex items-center justify-center p-4 bg-black/70 backdrop-blur-sm animate-in fade-in duration-200",children:[(0,r.jsx)("div",{className:"absolute inset-0",onClick:t}),(0,r.jsxs)(n.Zp,{className:(0,i.cn)("relative w-full max-h-[90vh] flex flex-col overflow-hidden animate-in zoom-in-95 duration-200",o,c),"data-report-control":"allow",onClick:e=>e.stopPropagation(),children:[(0,r.jsxs)("div",{className:"flex items-center justify-between p-6 border-b border-border",children:[a&&(0,r.jsx)("h2",{className:"text-2xl font-bold text-white",children:a}),(0,r.jsx)("button",{onClick:t,className:"p-1 rounded-full hover:bg-white/10 transition-colors text-gray-400 hover:text-white",children:(0,r.jsx)(s.A,{size:24})})]}),(0,r.jsx)("div",{className:"p-6 overflow-y-auto custom-scrollbar",children:l})]})]}):null}},56722:(e,t,a)=>{a.d(t,{n:()=>r});let r=(e,t)=>{let a=e?.["戶型"];if("string"==typeof a&&a)return a;let r=t.resolve(e);if(r)return r;let s=e?.["戶別"]||e?.unit||e?.unitName;return"string"==typeof s&&s?s:"?"}},60529:(e,t,a)=>{a.d(t,{p:()=>n});var r=a(95155),s=a(12115),i=a(40980);let n=s.forwardRef(({className:e,type:t,...a},s)=>(0,r.jsx)("input",{type:t,className:(0,i.cn)("flex h-10 w-full rounded-md border border-input bg-zinc-950/50 px-3 py-2 text-sm text-zinc-100 ring-offset-background file:border-0 file:bg-transparent file:text-sm file:font-medium placeholder:text-zinc-500 focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2 disabled:cursor-not-allowed disabled:opacity-50",e),ref:s,...a}));n.displayName="Input"},62400:(e,t,a)=>{a.d(t,{b:()=>s});var r=a(88743);function s(){let e=r.P.getState(),t=[];return e.counties.length>0&&(e.districts.length>0?t.push(`${e.counties.join(", ")} - ${e.districts.join(", ")}`):t.push(e.counties.join(", "))),e.startDate&&e.endDate?t.push(`${e.startDate} ~ ${e.endDate}`):e.dateRange&&"custom"!==e.dateRange&&t.push({"3m":"近3個月","6m":"近6個月","9m":"近9個月","12m":"近12個月","15m":"近15個月","18m":"近18個月","21m":"近21個月","24m":"近24個月","36m":"近36個月","48m":"近48個月",all:"全部時間"}[e.dateRange]||e.dateRange),e.transactionType&&t.push(e.transactionType),e.buildingType&&""!==e.buildingType&&t.push(e.buildingType),e.projectNames.length>0&&e.projectNames.length<=3?t.push(e.projectNames.join(", ")):e.projectNames.length>3&&t.push(`${e.projectNames.length} 個建案`),e.excludeCommercial&&t.push("排除商業/辦公"),t.length>0?t.join(" | "):"所有條件"}},68305:(e,t,a)=>{a.d(t,{p:()=>v});var r=a(95155),s=a(12115),i=a(68605),n=a(97085),l=a(37717);function c({data:e,sortKey:t,limit:a=30,chartType:i="auto",height:c,chartId:o}){let d=(0,l.A)(),x=(0,s.useMemo)(()=>i&&"auto"!==i?i:["averagePrice","minPrice","maxPrice","medianPrice","avgParkingPrice"].includes(t)?"bar":"treemap",[t,i]),h=(0,s.useMemo)(()=>({averagePrice:{title:"建案平均單價排行",unit:"萬/坪"},minPrice:{title:"建案最低單價排行",unit:"萬/坪"},maxPrice:{title:"建案最高單價排行",unit:"萬/坪"},medianPrice:{title:"建案單價中位數排行",unit:"萬/坪"},avgParkingPrice:{title:"車位平均單價排行",unit:"萬"},saleAmountSum:{title:"建案銷售總額佔比",unit:"萬",yLabel:"銷售總額"},houseAreaSum:{title:"建案房屋面積佔比",unit:"坪",yLabel:"房屋面積"},transactionCount:{title:"建案交易筆數佔比",unit:"筆",yLabel:"資料筆數"}})[t]||{title:"建案分析圖表",unit:"",yLabel:"數值"},[t]),m=(0,s.useMemo)(()=>{if(!e||0===e.length)return[];if("bar"!==x)return e.reduce((e,a)=>e+(a[t]||0),0),[{name:h.yLabel||h.unit,data:e.map(e=>({x:e.projectName,y:parseFloat((e[t]||0).toFixed(2))}))}];{let r=[...e].filter(e=>e[t]>0).sort((e,a)=>a[t]-e[t]).slice(0,a);return[{name:h.unit,data:r.map(e=>parseFloat((e[t]||0).toFixed(2)))}]}},[e,t,x,h,a]),p=(0,s.useMemo)(()=>{let r={title:{text:h.title,align:"center",style:{fontSize:"16px",fontWeight:600,color:d.text}}};if("bar"===x){let s=[...e].filter(e=>e[t]>0).sort((e,a)=>a[t]-e[t]).slice(0,a).map(e=>e.projectName);return{...r,chart:{type:"bar",toolbar:{show:!1},id:o,animations:{enabled:!1}},tooltip:{theme:"dark",y:{formatter:e=>`${e.toLocaleString()} ${h.unit}`,title:{formatter:(e,t)=>{let a=s[t?.dataPointIndex];return a?`${a}:`:`${e}:`}}},x:{show:!0,formatter:(e,t)=>s[t?.dataPointIndex]||e}},plotOptions:{bar:{horizontal:!1,columnWidth:"60%",borderRadius:4,distributed:!1}},colors:[d.chart[0]||d.primary],fill:{type:"gradient",gradient:{shade:"dark",type:"vertical",shadeIntensity:.5,gradientToColors:[d.chart[1]||d.primaryHover],inverseColors:!0,opacityFrom:1,opacityTo:1,stops:[0,100]}},dataLabels:{enabled:!1},xaxis:{categories:s,labels:{style:{colors:d.textMuted},rotate:-45,trim:!0,maxHeight:100}},yaxis:{title:{text:h.unit,style:{color:d.textMuted}},labels:{style:{colors:d.text,fontSize:"12px",fontWeight:500}}},legend:{show:!1}}}{let a=e.reduce((e,a)=>e+(a[t]||0),0);return{...r,tooltip:{theme:"dark",y:{formatter:e=>`${e.toLocaleString()} ${h.unit}`}},chart:{type:"treemap",height:450,toolbar:{show:!1},id:o},plotOptions:{treemap:{distributed:!0,enableShades:!1,colorScale:{ranges:[{from:0,to:.1*a,color:d.chart[1]||d.accent},{from:.1*a,to:.3*a,color:d.chart[2]||d.success},{from:.3*a,to:.6*a,color:d.chart[0]||d.primary},{from:.6*a,to:1/0,color:d.chart[3]||d.accentAlt}]}}},dataLabels:{enabled:!0,style:{fontSize:"11px",fontWeight:500,colors:[d.text]},formatter:e=>e,offsetY:-2}}}},[x,m,h,e,t,a,o,d]);if(!e||0===e.length)return(0,r.jsx)("div",{className:"text-zinc-500 text-center p-8",children:"無排名資料可顯示"});let u="bar"===x&&m[0]?.data?m[0].data.length:0,g="bar"===x?{width:"100%",minWidth:`${45*u}px`}:{width:"100%"};return(0,r.jsx)("div",{className:`w-full ${"bar"===x?"overflow-x-auto pb-4":""}`,children:(0,r.jsx)("div",{style:g,children:(0,r.jsx)(n.A,{type:"bar"===x?"bar":"treemap",series:m,options:p,height:c||450,className:"w-full"})})})}var o=a(88743),d=a(89239),x=a(86901),h=a(89123),m=a(37595),p=a(56842),u=a(72055),g=a(65770),f=a(41641),b=a(21362),j=a(89733),y=a(40980);function v({data:e,visibleSections:t=["metrics","chart","table"],className:a}){let{rankingCurrentPage:n,rankingPageSize:l,setRankingCurrentPage:v,setRankingPageSize:N}=(0,o.P)(),[w,z]=(0,s.useState)(1),[k,S]=(0,s.useState)(10),[P,M]=(0,s.useState)({key:"saleAmountSum",order:"desc"}),[A,C]=(0,s.useState)(30),[_,$]=(0,s.useState)("auto"),F=s.useRef(null),E=s.useRef(null),R=s.useRef(null),T=s.useRef(`ranking-chart-${Math.random().toString(36).slice(2,8)}`).current;if(!e)return null;let{coreMetrics:I,projectRanking:L}=e,D=(0,s.useMemo)(()=>{if(!L||0===L.length)return{min:0,max:0,median:0,parking:0};let e=Math.min(...L.map(e=>e.minPrice).filter(e=>e>0)),t=Math.max(...L.map(e=>e.maxPrice)),a=L.map(e=>e.medianPrice).filter(e=>e>0),r=a.length>0?a.reduce((e,t)=>e+t,0)/a.length:0,s=L.map(e=>e.avgParkingPrice).filter(e=>e>0);return{min:e,max:t,median:r,parking:s.length>0?s.reduce((e,t)=>e+t,0)/s.length:0}},[L]),O=(0,s.useMemo)(()=>L?[...L].sort((e,t)=>{let a=e[P.key]||0,r=t[P.key]||0;return"desc"===P.order?r-a:a-r}):[],[L,P]),B=Math.ceil(O.length/k),W=O.slice((w-1)*k,w*k),U=e=>{M({key:e,order:"desc"})},H=({title:e,value:t,unit:a,sortKey:s})=>(0,r.jsxs)("div",{onClick:()=>s&&U(s),className:`bg-zinc-800/50 rounded-lg p-4 border border-white/5 flex flex-col items-center justify-center text-center transition-all duration-300 ${s?"cursor-pointer hover:bg-zinc-800 hover:border-violet-500/30 hover:shadow-[0_0_20px_rgba(139,92,246,0.1)] group":""}`,children:[(0,r.jsx)("div",{className:`text-zinc-400 text-sm mb-1 ${s?"group-hover:text-violet-300":""}`,children:e}),(0,r.jsxs)("div",{className:"flex items-baseline gap-1",children:[(0,r.jsx)("span",{className:`text-2xl font-bold text-white ${s?"group-hover:text-white":""}`,children:t}),(0,r.jsx)("span",{className:"text-xs text-zinc-500",children:a})]})]});return(0,r.jsxs)("div",{className:(0,y.cn)("space-y-6 animate-in fade-in slide-in-from-bottom-4 duration-500",a),children:[t.includes("metrics")&&(0,r.jsx)(i.c,{title:"核心數據指標",containerRef:F,headerAction:(0,r.jsx)(j.N,{data:[I,D],filename:"core_metrics",label:"匯出",chartType:"ranking-metrics",targetRef:F,snapshotData:{coreMetrics:I,derivedMetrics:D}}),children:(0,r.jsxs)("div",{className:"grid grid-cols-1 sm:grid-cols-2 md:grid-cols-4 gap-3 sm:gap-4",children:[(0,r.jsx)(H,{title:"市場去化總銷售金額",value:I.totalSaleAmount.toLocaleString(),unit:"萬",sortKey:"saleAmountSum"}),(0,r.jsx)(H,{title:"總銷去化房屋坪數",value:I.totalHouseArea.toLocaleString(void 0,{maximumFractionDigits:2}),unit:"坪",sortKey:"houseAreaSum"}),(0,r.jsx)(H,{title:"總平均單價",value:I.overallAveragePrice.toLocaleString(void 0,{maximumFractionDigits:2}),unit:"萬/坪",sortKey:"averagePrice"}),(0,r.jsx)(H,{title:"總交易筆數",value:I.transactionCount.toLocaleString(),unit:"筆",sortKey:"transactionCount"}),(0,r.jsx)(H,{title:"最低成交單價 (Min)",value:D.min.toLocaleString(void 0,{maximumFractionDigits:1}),unit:"萬/坪",sortKey:"minPrice"}),(0,r.jsx)(H,{title:"最高成交單價 (Max)",value:D.max.toLocaleString(void 0,{maximumFractionDigits:1}),unit:"萬/坪",sortKey:"maxPrice"}),(0,r.jsx)(H,{title:"平均中位數單價",value:D.median.toLocaleString(void 0,{maximumFractionDigits:1}),unit:"萬/坪",sortKey:"medianPrice"}),(0,r.jsx)(H,{title:"平均車位價格",value:D.parking.toLocaleString(void 0,{maximumFractionDigits:0}),unit:"萬",sortKey:"avgParkingPrice"})]})}),t.includes("chart")&&(0,r.jsxs)("div",{className:"space-y-4",children:[(0,r.jsx)("div",{className:"flex flex-wrap gap-2 justify-center","data-report-control":"hide",children:[{key:"saleAmountSum",label:"交易總價(萬)"},{key:"houseAreaSum",label:"房屋面積(坪)"},{key:"transactionCount",label:"資料筆數"},{key:"marketShare",label:"市場佔比(%)"},{key:"averagePrice",label:"平均單價"},{key:"minPrice",label:"最低單價"},{key:"maxPrice",label:"最高單價"},{key:"medianPrice",label:"中位數單價"},{key:"avgParkingPrice",label:"車位均價"}].map(e=>(0,r.jsx)("button",{onClick:()=>U(e.key),className:`px-3 py-1.5 text-xs font-medium rounded-full border transition-all duration-300 ${P.key===e.key?"bg-violet-600/20 border-violet-500/50 text-violet-300 shadow-[0_0_15px_rgba(139,92,246,0.2)]":"bg-zinc-800/50 border-white/5 text-zinc-400 hover:text-white hover:bg-zinc-800 hover:border-white/10"}`,children:e.label},e.key))}),(0,r.jsx)(i.c,{title:"建案分析圖表",description:"根據排序指標顯示建案排名",containerRef:E,headerAction:(0,r.jsxs)("div",{className:"flex flex-col sm:flex-row items-start sm:items-center gap-3 w-full sm:w-auto",children:[(0,r.jsxs)("div",{className:"flex bg-zinc-800 p-0.5 rounded-lg border border-white/5","data-report-control":"hide",children:[(0,r.jsx)("button",{onClick:()=>$("auto"),className:`p-1.5 rounded-md transition-all ${"auto"===_?"bg-violet-600 text-white shadow-lg shadow-violet-500/20":"text-zinc-400 hover:text-white hover:bg-white/5"}`,title:"自動選擇 (Auto)",children:(0,r.jsx)(x.A,{size:14})}),(0,r.jsx)("button",{onClick:()=>$("bar"),className:`p-1.5 rounded-md transition-all ${"bar"===_?"bg-violet-600 text-white shadow-lg shadow-violet-500/20":"text-zinc-400 hover:text-white hover:bg-white/5"}`,title:"長條圖 (Bar)",children:(0,r.jsx)(h.A,{size:14})}),(0,r.jsx)("button",{onClick:()=>$("treemap"),className:`p-1.5 rounded-md transition-all ${"treemap"===_?"bg-violet-600 text-white shadow-lg shadow-violet-500/20":"text-zinc-400 hover:text-white hover:bg-white/5"}`,title:"矩形樹圖 (Treemap)",children:(0,r.jsx)(m.A,{size:14})})]}),(0,r.jsx)("div",{className:"hidden sm:block w-px h-6 bg-white/10"}),(0,r.jsxs)("div",{className:"flex items-center gap-3 w-full sm:w-auto justify-between sm:justify-start",children:[(0,r.jsx)("div",{className:"flex bg-zinc-800 p-0.5 rounded-lg border border-white/5 overflow-x-auto max-w-[200px] sm:max-w-none scrollbar-hide","data-report-control":"hide",children:[10,30,50,100].map(e=>(0,r.jsxs)("button",{onClick:()=>C(e),className:`px-3 py-1 text-xs rounded-md transition-all whitespace-nowrap ${A===e?"bg-violet-600 text-white shadow-lg shadow-violet-500/20":"text-zinc-400 hover:text-white hover:bg-white/5"}`,children:["Top ",e]},e))}),(0,r.jsx)("div",{className:"hidden sm:block w-px h-6 bg-white/10"}),(0,r.jsx)(j.N,{data:O.slice(0,A),filename:"ranking_chart_data",label:"匯出",chartType:"ranking-chart",targetRef:E,snapshotData:O.slice(0,A),chartId:T,columns:{projectName:"建案名稱",county:"縣市",district:"行政區",saleAmountSum:"交易總價",houseAreaSum:"房屋面積",transactionCount:"資料筆數",marketShare:"市場佔比",averagePrice:"平均單價",minPrice:"最低單價",maxPrice:"最高單價",medianPrice:"中位數單價",avgParkingPrice:"車位均價"}})]})]}),children:(0,r.jsx)(c,{data:O,sortKey:P.key,limit:A,chartType:_,chartId:T})})]}),t.includes("table")&&(0,r.jsxs)(i.c,{title:"區域建案排行列表",description:"點擊表頭可進行排序",containerRef:R,headerAction:(0,r.jsx)(j.N,{data:O,filename:"ranking_table_data",label:"匯出",chartType:"ranking-table",targetRef:R,snapshotData:O,columns:{projectName:"建案名稱",county:"縣市",district:"行政區",saleAmountSum:"交易總價",houseAreaSum:"房屋面積",transactionCount:"資料筆數",marketShare:"市場佔比",averagePrice:"平均單價",minPrice:"最低單價",maxPrice:"最高單價",medianPrice:"中位數單價",avgParkingPrice:"車位均價"}}),children:[(0,r.jsx)("div",{className:"overflow-x-auto",children:(0,r.jsxs)("table",{className:"w-full text-sm text-left",children:[(0,r.jsx)("thead",{className:"bg-zinc-900/80 text-zinc-400 uppercase text-xs font-semibold",children:(0,r.jsxs)("tr",{children:[(0,r.jsx)("th",{className:"px-4 py-3 cursor-default",children:"排名"}),(0,r.jsx)("th",{className:"px-4 py-3 cursor-default",children:"建案名稱"}),[{key:"saleAmountSum",label:(0,r.jsxs)(r.Fragment,{children:["交易",(0,r.jsx)("br",{}),"總價(萬)"]})},{key:"houseAreaSum",label:(0,r.jsxs)(r.Fragment,{children:["房屋",(0,r.jsx)("br",{}),"面積(坪)"]})},{key:"transactionCount",label:(0,r.jsxs)(r.Fragment,{children:["資料",(0,r.jsx)("br",{}),"筆數"]})},{key:"marketShare",label:(0,r.jsxs)(r.Fragment,{children:["市場",(0,r.jsx)("br",{}),"佔比(%)"]})},{key:"averagePrice",label:(0,r.jsxs)(r.Fragment,{children:["平均",(0,r.jsx)("br",{}),"單價"]})},{key:"minPrice",label:(0,r.jsxs)(r.Fragment,{children:["最低",(0,r.jsx)("br",{}),"單價"]})},{key:"maxPrice",label:(0,r.jsxs)(r.Fragment,{children:["最高",(0,r.jsx)("br",{}),"單價"]})},{key:"medianPrice",label:(0,r.jsxs)(r.Fragment,{children:["中位數",(0,r.jsx)("br",{}),"單價"]})},{key:"avgParkingPrice",label:(0,r.jsxs)(r.Fragment,{children:["車位",(0,r.jsx)("br",{}),"均價"]})}].map(e=>(0,r.jsx)("th",{className:"px-3 py-3 cursor-pointer hover:text-white transition-colors text-center whitespace-nowrap",onClick:()=>U(e.key),children:(0,r.jsxs)("div",{className:"flex items-center justify-center gap-1.5 group/header",children:[(0,r.jsx)("span",{className:"leading-tight",children:e.label}),(0,r.jsx)("div",{className:"flex flex-col opacity-50 group-hover/header:opacity-100 transition-opacity",children:P.key===e.key?"desc"===P.order?(0,r.jsx)(p.A,{size:14,className:"text-violet-500"}):(0,r.jsx)(u.A,{size:14,className:"text-violet-500"}):(0,r.jsx)(g.A,{size:14,className:"text-zinc-600 group-hover/header:text-zinc-400"})})]})},e.key))]})}),(0,r.jsx)("tbody",{className:"divide-y divide-white/5",children:W.map((e,t)=>(0,r.jsxs)("tr",{className:"hover:bg-zinc-800/50 transition-colors",children:[(0,r.jsx)("td",{className:"px-4 py-3 text-zinc-500 font-mono",children:(w-1)*k+t+1}),(0,r.jsx)("td",{className:"px-4 py-3",children:(0,r.jsxs)("div",{className:"flex flex-col",children:[(0,r.jsx)("span",{className:"font-medium text-white",children:e.projectName}),(0,r.jsxs)("div",{className:"flex gap-1 mt-1",children:[e.county&&(0,r.jsx)("span",{className:"text-[10px] bg-zinc-800 text-zinc-400 px-1 py-0.5 rounded",children:e.county}),e.district&&(0,r.jsx)("span",{className:"text-[10px] bg-zinc-800 text-zinc-400 px-1 py-0.5 rounded",children:e.district})]})]})}),(0,r.jsx)("td",{className:"px-4 py-3 font-mono text-zinc-300",children:e.saleAmountSum.toLocaleString()}),(0,r.jsx)("td",{className:"px-4 py-3 font-mono text-zinc-300",children:e.houseAreaSum.toLocaleString()}),(0,r.jsx)("td",{className:"px-4 py-3 font-mono text-zinc-300",children:e.transactionCount.toLocaleString()}),(0,r.jsxs)("td",{className:"px-4 py-3 font-mono text-zinc-300",children:[e.marketShare.toFixed(2),"%"]}),(0,r.jsx)("td",{className:"px-4 py-3 font-mono text-cyan-400",children:e.averagePrice.toFixed(1)}),(0,r.jsx)("td",{className:"px-4 py-3 font-mono text-zinc-500",children:e.minPrice.toFixed(1)}),(0,r.jsx)("td",{className:"px-4 py-3 font-mono text-zinc-500",children:e.maxPrice.toFixed(1)}),(0,r.jsx)("td",{className:"px-4 py-3 font-mono text-zinc-400",children:e.medianPrice.toFixed(1)}),(0,r.jsx)("td",{className:"px-4 py-3 font-mono text-zinc-400",children:e.avgParkingPrice>0?e.avgParkingPrice.toLocaleString():"-"})]},t))}),(0,r.jsx)("tfoot",{className:"bg-zinc-900/80 font-bold border-t-2 border-zinc-700",children:(0,r.jsxs)("tr",{children:[(0,r.jsx)("td",{colSpan:2,className:"px-4 py-3 text-center text-zinc-300",children:"總計"}),(0,r.jsx)("td",{className:"px-4 py-3 text-zinc-300",children:I.totalSaleAmount.toLocaleString()}),(0,r.jsx)("td",{className:"px-4 py-3 text-zinc-300",children:I.totalHouseArea.toLocaleString()}),(0,r.jsx)("td",{className:"px-4 py-3 text-zinc-300",children:I.transactionCount.toLocaleString()}),(0,r.jsx)("td",{colSpan:6})]})})]})}),(0,r.jsxs)("div",{className:"flex items-center justify-between mt-4 border-t border-white/5 pt-4",children:[(0,r.jsxs)("div",{className:"text-sm text-zinc-500",children:["顯示 ",(w-1)*k+1," 到 ",Math.min(w*k,O.length)," 筆，共 ",O.length," 筆"]}),(0,r.jsxs)("div",{className:"flex items-center gap-2",children:[(0,r.jsx)(d.$,{variant:"outline",size:"sm",onClick:()=>z(e=>Math.max(1,e-1)),disabled:1===w,children:(0,r.jsx)(f.A,{size:16})}),(0,r.jsxs)("span",{className:"text-sm text-zinc-300",children:["Page ",w," of ",B]}),(0,r.jsx)(d.$,{variant:"outline",size:"sm",onClick:()=>z(e=>Math.min(B,e+1)),disabled:w===B,children:(0,r.jsx)(b.A,{size:16})})]})]})]})]})}},68605:(e,t,a)=>{a.d(t,{c:()=>n});var r=a(95155);a(12115);var s=a(40980),i=a(62400);function n({title:e,description:t,children:a,headerAction:n,className:l,containerRef:c}){let o=(0,i.b)();return(0,r.jsxs)("div",{ref:c,className:(0,s.cn)("bg-zinc-900/50 border border-white/5 rounded-2xl p-4 md:p-6 backdrop-blur-sm",l),children:[(0,r.jsxs)("div",{className:"flex flex-col md:flex-row md:items-center justify-between gap-4 mb-6",children:[(0,r.jsxs)("div",{children:[(0,r.jsx)("h3",{className:"text-xl font-bold text-white flex items-center gap-2",children:e}),t&&(0,r.jsx)("p",{className:"text-zinc-400 text-sm mt-1",children:t})]}),n&&(0,r.jsx)("div",{className:"flex-shrink-0 w-full md:w-auto overflow-x-auto","data-html2canvas-ignore":"true",children:n})]}),a,(0,r.jsxs)("div",{className:"mt-4 pt-3 border-t border-white/10 flex flex-col items-center gap-1 text-xs text-center",style:{display:"none"},"data-export-footer":"true",children:[(0,r.jsx)("div",{className:"text-white font-semibold text-sm whitespace-nowrap",children:"彙整：平米內參 　來源：內政部實登"}),(0,r.jsxs)("div",{className:"text-zinc-400 text-center whitespace-nowrap overflow-hidden text-ellipsis w-full",children:["搜尋條件：",o]})]})]})}},70872:(e,t,a)=>{a.d(t,{Bc:()=>l,ZI:()=>d,k$:()=>o,m_:()=>c});var r=a(95155),s=a(12115),i=a(36376),n=a(40980);let l=i.Kq,c=i.bL,o=i.l9,d=s.forwardRef(({className:e,sideOffset:t=4,...a},s)=>(0,r.jsx)(i.UC,{ref:s,sideOffset:t,className:(0,n.cn)("z-50 overflow-hidden rounded-md border border-zinc-800 bg-zinc-950 px-3 py-1.5 text-sm text-zinc-100 shadow-md animate-in fade-in-0 zoom-in-95 data-[state=closed]:animate-out data-[state=closed]:fade-out-0 data-[state=closed]:zoom-out-95 data-[side=bottom]:slide-in-from-top-2 data-[side=left]:slide-in-from-right-2 data-[side=right]:slide-in-from-left-2 data-[side=top]:slide-in-from-bottom-2",e),...a}));d.displayName=i.UC.displayName},72264:(e,t,a)=>{a.d(t,{SQ:()=>o,_2:()=>d,hO:()=>x,lp:()=>h,mB:()=>m,rI:()=>l,ty:()=>c});var r=a(95155);a(12115);var s=a(61108),i=a(94514),n=a(40980);function l({...e}){return(0,r.jsx)(s.bL,{"data-slot":"dropdown-menu",...e})}function c({...e}){return(0,r.jsx)(s.l9,{"data-slot":"dropdown-menu-trigger",...e})}function o({className:e,sideOffset:t=4,...a}){return(0,r.jsx)(s.ZL,{children:(0,r.jsx)(s.UC,{"data-slot":"dropdown-menu-content",sideOffset:t,className:(0,n.cn)("bg-popover text-popover-foreground data-[state=open]:animate-in data-[state=closed]:animate-out data-[state=closed]:fade-out-0 data-[state=open]:fade-in-0 data-[state=closed]:zoom-out-95 data-[state=open]:zoom-in-95 data-[side=bottom]:slide-in-from-top-2 data-[side=left]:slide-in-from-right-2 data-[side=right]:slide-in-from-left-2 data-[side=top]:slide-in-from-bottom-2 z-50 max-h-(--radix-dropdown-menu-content-available-height) min-w-[8rem] origin-(--radix-dropdown-menu-content-transform-origin) overflow-x-hidden overflow-y-auto rounded-md border p-1 shadow-md",e),...a})})}function d({className:e,inset:t,variant:a="default",...i}){return(0,r.jsx)(s.q7,{"data-slot":"dropdown-menu-item","data-inset":t,"data-variant":a,className:(0,n.cn)("focus:bg-accent focus:text-accent-foreground data-[variant=destructive]:text-destructive data-[variant=destructive]:focus:bg-destructive/10 dark:data-[variant=destructive]:focus:bg-destructive/20 data-[variant=destructive]:focus:text-destructive data-[variant=destructive]:*:[svg]:!text-destructive [&_svg:not([class*='text-'])]:text-muted-foreground relative flex cursor-default items-center gap-2 rounded-sm px-2 py-1.5 text-sm outline-hidden select-none data-[disabled]:pointer-events-none data-[disabled]:opacity-50 data-[inset]:pl-8 [&_svg]:pointer-events-none [&_svg]:shrink-0 [&_svg:not([class*='size-'])]:size-4",e),...i})}function x({className:e,children:t,checked:a,...l}){return(0,r.jsxs)(s.H_,{"data-slot":"dropdown-menu-checkbox-item",className:(0,n.cn)("focus:bg-accent focus:text-accent-foreground relative flex cursor-default items-center gap-2 rounded-sm py-1.5 pr-2 pl-8 text-sm outline-hidden select-none data-[disabled]:pointer-events-none data-[disabled]:opacity-50 [&_svg]:pointer-events-none [&_svg]:shrink-0 [&_svg:not([class*='size-'])]:size-4",e),checked:a,...l,children:[(0,r.jsx)("span",{className:"pointer-events-none absolute left-2 flex size-3.5 items-center justify-center",children:(0,r.jsx)(s.VF,{children:(0,r.jsx)(i.A,{className:"size-4"})})}),t]})}function h({className:e,inset:t,...a}){return(0,r.jsx)(s.JU,{"data-slot":"dropdown-menu-label","data-inset":t,className:(0,n.cn)("px-2 py-1.5 text-sm font-medium data-[inset]:pl-8",e),...a})}function m({className:e,...t}){return(0,r.jsx)(s.wv,{"data-slot":"dropdown-menu-separator",className:(0,n.cn)("bg-border -mx-1 my-1 h-px",e),...t})}},77837:(e,t,a)=>{a.d(t,{P:()=>N});var r=a(95155),s=a(12115),i=a(68605),n=a(47650),l=a(80642),c=a(39430),o=a(33210),d=a(44071),x=a(67514),h=a(37717);let m={height:450,paddingTop:40,paddingBottom:80,paddingLeft:100,paddingRight:40,boxWidth:60,whiskerWidth:30,whiskerStrokeWidth:1,boxStrokeWidth:1.5,medianStrokeWidth:2};function p({data:e}){let t=(0,h.A)(),[a,i]=(0,s.useState)(null),[p,u]=(0,s.useState)(null),[g,f]=(0,s.useState)(null),[b,j]=(0,s.useState)(!1),y=(0,s.useRef)(null),v=(0,s.useRef)(null),N=(0,s.useRef)(null),w=(0,s.useMemo)(()=>({...m,colors:{upper:t.chart[1]||t.primary,lower:t.chart[0]||t.accent,whisker:t.text,median:t.text,grid:t.grid,text:t.textMuted,background:"transparent"}}),[t]);(0,s.useEffect)(()=>{j(!0)},[]),(0,s.useEffect)(()=>{let e=e=>{let t=N.current;if(t&&!t.contains(e.target)){let t=y.current;if(t&&t.contains(e.target))return;i(null)}};if(a){let t=setTimeout(()=>{document.addEventListener("click",e)},100);return()=>{clearTimeout(t),document.removeEventListener("click",e)}}},[a]);let z=(0,s.useMemo)(()=>{if(!e||0===e.length)return null;let t=e.map(e=>[e.minPrice,e.q1Price,e.medianPrice,e.q3Price,e.maxPrice].some(e=>"number"!=typeof e||isNaN(e))?null:{category:null!==e.bathrooms?`${e.roomType}-${e.bathrooms}衛`:e.roomType,min:Math.round(e.minPrice),q1:Math.round(e.q1Price),median:Math.round(e.medianPrice),q3:Math.round(e.q3Price),max:Math.round(e.maxPrice),count:e.count}).filter(Boolean);if(0===t.length)return null;let a=t.flatMap(e=>[e.min,e.q1,e.median,e.q3,e.max]),r=Math.min(...a),s=Math.max(...a),i=s-r,n=0===i?Math.max(.1*r,100):.1*i;return{items:t,yMin:Math.max(0,r-n),yMax:s+n}},[e]),k=(0,s.useMemo)(()=>{if(!z)return null;let e=v.current?.clientWidth||800,t=e-w.paddingLeft-w.paddingRight,a=w.height-w.paddingTop-w.paddingBottom,r=t/z.items.length;return{width:e,height:w.height,drawWidth:t,drawHeight:a,categoryWidth:r}},[z,w,v.current?.clientWidth]),S=(0,s.useMemo)(()=>z&&k?e=>{let t=(e-z.yMin)/(z.yMax-z.yMin);return w.paddingTop+k.drawHeight*(1-t)}:null,[z,k,w]),P=(0,s.useMemo)(()=>{if(!z)return[];let{yMin:e,yMax:t}=z,a=(t-e)/5;return Array.from({length:6},(t,r)=>Math.round(e+r*a))},[z]);return e&&0!==e.length&&z?(0,r.jsxs)("div",{ref:v,className:"relative w-full",children:[(0,r.jsx)("svg",{ref:y,width:"100%",height:w.height,className:"overflow-visible",onMouseMove:e=>{if(!y.current||!S||!z||!k)return;let t=y.current.getBoundingClientRect(),a=t.height/w.height||1,r=(e.clientY-t.top)/a;r>=w.paddingTop&&r<=w.paddingTop+k.drawHeight?f(r):f(null)},onMouseLeave:()=>{f(null)},children:k&&S&&(0,r.jsxs)(r.Fragment,{children:[P.map((e,t)=>(0,r.jsxs)("g",{children:[(0,r.jsx)("line",{x1:w.paddingLeft,y1:S(e),x2:w.paddingLeft+k.drawWidth,y2:S(e),stroke:w.colors.grid,strokeWidth:1,strokeDasharray:"4,4"}),(0,r.jsxs)("text",{x:w.paddingLeft-10,y:S(e),textAnchor:"end",dominantBaseline:"middle",fill:w.colors.text,fontSize:12,children:[e.toLocaleString()," 萬"]})]},`tick-${t}`)),(0,r.jsx)("text",{x:15,y:w.height/2,textAnchor:"middle",dominantBaseline:"middle",fill:w.colors.text,fontSize:12,transform:`rotate(-90, 15, ${w.height/2})`,children:"房屋總價 (萬)"}),z.items.map((e,s)=>{let n=w.paddingLeft+k.categoryWidth*(s+.5),l=w.boxWidth/2,c=w.whiskerWidth/2,o=S(e.max),d=S(e.q3),x=S(e.median),h=S(e.q1),m=S(e.min),g=p===s,f=a?.category===e.category;return(0,r.jsxs)("g",{className:"cursor-pointer transition-opacity",style:{opacity:null===p||g?1:.5},onMouseEnter:()=>u(s),onMouseLeave:()=>u(null),onClick:()=>i(e),children:[(0,r.jsx)("line",{x1:n,y1:d,x2:n,y2:o,stroke:w.colors.whisker,strokeWidth:w.whiskerStrokeWidth,strokeLinecap:"round"}),(0,r.jsx)("line",{x1:n-c,y1:o,x2:n+c,y2:o,stroke:w.colors.whisker,strokeWidth:w.whiskerStrokeWidth,strokeLinecap:"round"}),(0,r.jsx)("line",{x1:n,y1:h,x2:n,y2:m,stroke:w.colors.whisker,strokeWidth:w.whiskerStrokeWidth,strokeLinecap:"round"}),(0,r.jsx)("line",{x1:n-c,y1:m,x2:n+c,y2:m,stroke:w.colors.whisker,strokeWidth:w.whiskerStrokeWidth,strokeLinecap:"round"}),(0,r.jsx)("rect",{x:n-l,y:d,width:w.boxWidth,height:x-d,fill:w.colors.upper,stroke:g||f?t.text:w.colors.upper,strokeWidth:w.boxStrokeWidth,rx:2,style:{filter:g?"brightness(1.2)":"none"}}),(0,r.jsx)("rect",{x:n-l,y:x,width:w.boxWidth,height:h-x,fill:w.colors.lower,stroke:g||f?t.text:w.colors.lower,strokeWidth:w.boxStrokeWidth,rx:2,style:{filter:g?"brightness(1.2)":"none"}}),(0,r.jsx)("line",{x1:n-l,y1:x,x2:n+l,y2:x,stroke:w.colors.median,strokeWidth:w.medianStrokeWidth}),(0,r.jsx)("text",{x:n,y:w.height-25,textAnchor:"middle",fill:g?t.text:w.colors.text,fontSize:12,fontWeight:g?"bold":"normal",children:e.category})]},e.category)}),null!==g&&(0,r.jsxs)(r.Fragment,{children:[(0,r.jsx)("line",{x1:w.paddingLeft,y1:g,x2:w.paddingLeft+k.drawWidth,y2:g,stroke:t.accent,strokeWidth:1,strokeDasharray:"4,4",pointerEvents:"none"}),(0,r.jsx)("rect",{x:w.paddingLeft+k.drawWidth+5,y:g-12,width:70,height:24,rx:4,fill:t.card,stroke:t.accent,strokeWidth:1}),(0,r.jsxs)("text",{x:w.paddingLeft+k.drawWidth+40,y:g+4,textAnchor:"middle",fill:t.accent,fontSize:11,fontWeight:"bold",children:[(e=>{if(!z||!k)return 0;let t=1-(e-w.paddingTop)/k.drawHeight;return Math.round(z.yMin+t*(z.yMax-z.yMin))})(g).toLocaleString()," 萬"]})]})]})}),b&&(0,n.createPortal)((0,r.jsx)(l.N,{children:a&&(0,r.jsxs)("div",{className:"fixed inset-0 z-[9998] pointer-events-none",children:[(0,r.jsx)(c.P.div,{initial:{opacity:0},animate:{opacity:1},exit:{opacity:0},className:"absolute inset-0 bg-black/50 backdrop-blur-sm pointer-events-auto",onClick:()=>i(null)}),(0,r.jsx)(c.P.div,{ref:N,initial:{opacity:0,scale:.9,y:20},animate:{opacity:1,scale:1,y:0},exit:{opacity:0,scale:.9,y:20},transition:{type:"spring",stiffness:400,damping:30},className:"absolute top-1/2 left-1/2 -translate-x-1/2 -translate-y-1/2 pointer-events-auto w-[90vw] max-w-sm max-h-[85vh] flex flex-col",onClick:e=>e.stopPropagation(),children:(0,r.jsxs)("div",{className:"bg-zinc-900 border border-white/10 rounded-2xl shadow-2xl overflow-hidden flex flex-col",children:[(0,r.jsx)("div",{className:"bg-gradient-to-r from-cyan-500/20 to-violet-500/20 px-5 py-3 border-b border-white/10 flex-shrink-0",children:(0,r.jsxs)("div",{className:"flex items-center justify-between",children:[(0,r.jsxs)("div",{children:[(0,r.jsx)("div",{className:"text-zinc-400 text-[10px] uppercase tracking-widest mb-0.5",children:"總價帶分析"}),(0,r.jsxs)("div",{className:"flex items-baseline gap-2",children:[(0,r.jsx)("div",{className:"text-white text-2xl font-black tracking-tight",children:a.category}),a.count>0&&(0,r.jsxs)("div",{className:"text-zinc-400 text-xs",children:["(",(0,r.jsx)("span",{className:"text-cyan-400 font-bold",children:a.count})," 筆)"]})]})]}),(0,r.jsx)("button",{onClick:()=>i(null),className:"p-1.5 rounded-full hover:bg-white/10 transition-colors",children:(0,r.jsx)(o.A,{className:"w-4 h-4 text-zinc-400"})})]})}),(0,r.jsxs)("div",{className:"p-4 space-y-2 overflow-y-auto flex-1 custom-scrollbar",children:[(0,r.jsxs)("div",{className:"flex items-center gap-3 p-2 rounded-lg bg-white/5 border border-white/5",children:[(0,r.jsx)(d.A,{className:"w-4 h-4 text-white/70 flex-shrink-0"}),(0,r.jsx)("div",{className:"flex-1 min-w-0",children:(0,r.jsxs)("div",{className:"flex justify-between items-baseline",children:[(0,r.jsx)("span",{className:"text-white/60 text-xs font-medium",children:"最高成交"}),(0,r.jsxs)("span",{className:"text-white text-base font-mono font-bold",children:[a.max.toLocaleString()," 萬"]})]})}),(0,r.jsx)("div",{className:"w-1 h-3 border-r border-white/50 flex-shrink-0",title:"上引線"})]}),(0,r.jsxs)("div",{className:"p-3 rounded-lg bg-cyan-500/10 border border-cyan-500/30",children:[(0,r.jsxs)("div",{className:"flex items-center gap-1.5 mb-1",children:[(0,r.jsx)("div",{className:"w-3 h-3 rounded-[2px] bg-cyan-500"}),(0,r.jsx)("span",{className:"text-cyan-400 text-xs font-bold",children:"較高價區間 (25%)"})]}),(0,r.jsxs)("div",{className:"text-white text-lg font-mono font-bold mb-1",children:[a.median.toLocaleString()," ~ ",a.q3.toLocaleString()," 萬"]}),(0,r.jsx)("div",{className:"text-zinc-400 text-[10px] leading-tight",children:"價格偏高但屬正常範圍的交易。"})]}),(0,r.jsx)("div",{className:"flex items-center gap-3 px-3 py-2 bg-white/5 rounded-lg border border-white/5",children:(0,r.jsx)("div",{className:"flex-1",children:(0,r.jsxs)("div",{className:"flex justify-between items-center",children:[(0,r.jsx)("div",{className:"text-white text-xs font-bold",children:"中位數 (50%)"}),(0,r.jsxs)("div",{className:"text-white text-lg font-mono font-bold",children:[a.median.toLocaleString()," 萬"]})]})})}),(0,r.jsxs)("div",{className:"p-3 rounded-lg bg-violet-500/10 border border-violet-500/30",children:[(0,r.jsxs)("div",{className:"flex items-center gap-1.5 mb-1",children:[(0,r.jsx)("div",{className:"w-3 h-3 rounded-[2px] bg-violet-500"}),(0,r.jsx)("span",{className:"text-violet-400 text-xs font-bold",children:"較低價區間 (25%)"})]}),(0,r.jsxs)("div",{className:"text-white text-lg font-mono font-bold mb-1",children:[a.q1.toLocaleString()," ~ ",a.median.toLocaleString()," 萬"]}),(0,r.jsx)("div",{className:"text-zinc-400 text-[10px] leading-tight",children:"價格偏低但屬正常範圍的交易。"})]}),(0,r.jsxs)("div",{className:"flex items-center gap-3 p-2 rounded-lg bg-white/5 border border-white/5",children:[(0,r.jsx)(x.A,{className:"w-4 h-4 text-zinc-500 flex-shrink-0"}),(0,r.jsx)("div",{className:"flex-1 min-w-0",children:(0,r.jsxs)("div",{className:"flex justify-between items-baseline",children:[(0,r.jsx)("span",{className:"text-zinc-500 text-xs font-medium",children:"最低成交"}),(0,r.jsxs)("span",{className:"text-white text-base font-mono font-bold",children:[a.min.toLocaleString()," 萬"]})]})}),(0,r.jsx)("div",{className:"w-1 h-3 border-r border-zinc-600 flex-shrink-0",title:"下引線"})]})]}),(0,r.jsx)("div",{className:"px-4 py-2 bg-white/5 border-t border-white/10 flex-shrink-0",children:(0,r.jsxs)("div",{className:"text-zinc-500 text-[10px] text-center",children:["\uD83D\uDCA1 藍+紫區塊涵蓋 ",(0,r.jsx)("span",{className:"text-white font-bold",children:"50%"})," 的交易 (市場主流)"]})})]})})]})}),document.body)]}):(0,r.jsx)("div",{className:"text-zinc-500 text-center p-8",children:"無總價帶資料可顯示"})}var u=a(97085);function g({roomTypes:e,locations:t,crossTable:a,dimension:i,chartId:n}){let l=(0,h.A)(),c=(0,s.useMemo)(()=>e&&t&&a?e.map(e=>{let r=t.map(t=>a[e]&&a[e][t]||0);return{name:e,data:r}}):[],[e,t,a]),o=(0,s.useMemo)(()=>{let e="county"===i?"縣市":"行政區";return{chart:{type:"bar",height:Math.max(350,35*t.length),stacked:!0,background:"transparent",toolbar:{show:!1},foreColor:l.text,id:n},plotOptions:{bar:{horizontal:!0,barHeight:"70%",borderRadius:4,dataLabels:{total:{enabled:!0,offsetX:5,style:{fontSize:"11px",fontWeight:600,color:l.text},formatter:function(e,t){let a=t.w.config.series,r=t.dataPointIndex,s=0;return a.forEach(e=>{s+=e.data[r]||0}),s>0?s.toString():""}}}}},colors:l.chartPalette,dataLabels:{enabled:!1},xaxis:{categories:t,title:{text:"成交筆數",style:{color:l.textMuted}},labels:{style:{colors:l.textMuted}}},yaxis:{title:{text:e,style:{color:l.textMuted}},labels:{style:{colors:l.text},maxWidth:150}},legend:{position:"top",horizontalAlign:"center",labels:{colors:l.text}},tooltip:{theme:"dark",y:{formatter:function(e){return e+" 筆"}}},grid:{borderColor:l.grid},title:{text:`各${e}房型成交筆數分佈`,align:"center",style:{fontSize:"16px",color:l.text}}}},[t,i,n,l]);return c&&0!==c.length?(0,r.jsx)(u.A,{type:"bar",series:c,options:o,height:o.chart?.height||350,className:"w-full"}):(0,r.jsx)("div",{className:"text-zinc-500 text-center p-8",children:"無區域分佈資料"})}var f=a(40980);function b({isOpen:e,onClose:t,title:a,projects:i}){let n=(0,s.useRef)(null);return((0,s.useEffect)(()=>{let a=e=>{"Escape"===e.key&&t()};return e&&(document.addEventListener("keydown",a),document.body.style.overflow="hidden"),()=>{document.removeEventListener("keydown",a),document.body.style.overflow=""}},[e,t]),e)?(0,r.jsx)("div",{className:"fixed inset-0 z-50 flex items-center justify-center bg-black/60 backdrop-blur-sm animate-in fade-in duration-200",onClick:e=>{n.current&&!n.current.contains(e.target)&&t()},children:(0,r.jsxs)("div",{ref:n,className:"bg-zinc-900 border border-white/10 rounded-xl shadow-2xl max-w-md w-full mx-4 animate-in zoom-in-95 duration-200",children:[(0,r.jsxs)("div",{className:"flex items-center justify-between px-5 py-4 border-b border-white/5",children:[(0,r.jsx)("h3",{className:"text-lg font-semibold text-white",children:a}),(0,r.jsx)("button",{onClick:t,className:"p-1 rounded hover:bg-white/10 text-zinc-400 hover:text-white transition-colors",children:(0,r.jsx)(o.A,{size:20})})]}),(0,r.jsx)("div",{className:"px-5 py-4 max-h-[50vh] overflow-y-auto scrollbar-thin scrollbar-thumb-zinc-700",children:0===i.length?(0,r.jsx)("p",{className:"text-zinc-500 text-center py-4",children:"無建案資料"}):(0,r.jsx)("ul",{className:"space-y-2",children:i.map((e,t)=>(0,r.jsx)("li",{className:(0,f.cn)("px-3 py-2 rounded-lg text-zinc-200 text-sm","bg-zinc-800/50 hover:bg-zinc-800 transition-colors","border border-white/5"),children:e},t))})}),(0,r.jsxs)("div",{className:"px-5 py-3 border-t border-white/5 flex justify-between items-center",children:[(0,r.jsxs)("span",{className:"text-xs text-zinc-500",children:["共 ",i.length," 個建案"]}),(0,r.jsx)("button",{onClick:t,className:"px-4 py-1.5 text-sm rounded-lg bg-zinc-800 text-zinc-300 hover:bg-zinc-700 transition-colors",children:"關閉"})]})]})}):null}var j=a(89733),y=a(88743),v=a(48551);function N({data:e,visibleSections:t=["chart","table","location-table","location-chart"]}){let{selectedRoomTypes:a,setSelectedRoomTypes:n,districts:l}=(0,y.P)(),c=["套房","1房","2房","3房","4房","毛胚"],o=s.useRef(null),d=s.useRef(null),x=s.useRef(null),h=s.useRef(null),m=s.useRef(`price-band-location-${Math.random().toString(36).slice(2,8)}`).current,[u,N]=(0,s.useState)("district"),[w,z]=(0,s.useState)(!1),[k,S]=(0,s.useState)(""),[P,M]=(0,s.useState)([]),[A,C]=(0,s.useState)(null),_=(0,s.useMemo)(()=>{if(!e?.transactionDetails)return[];let t=new Set;return e.transactionDetails.forEach(e=>{e["縣市"]&&t.add(e["縣市"])}),Array.from(t).sort()},[e?.transactionDetails]);s.useEffect(()=>{0===_.length?C(null):1===_.length?C(_[0]):A&&!_.includes(A)&&C(null)},[_,A]);let $=(e,t,a)=>{S(`${e}${null!==t?` / ${t}衛`:""} 建案組成`),M(a),z(!0)};if(!e||!e.details||0===e.details.length)return null;let{details:F,locationCrossTable:E,allDistricts:R,transactionDetails:T}=e,I=(0,s.useMemo)(()=>F.filter(e=>a.includes(e.roomType)),[F,a]),[L,D]=(0,s.useState)(!0),O=t.includes("table")||t.includes("chart"),B=(0,s.useMemo)(()=>{let e=F.filter(e=>a.includes(e.roomType));if(!L)return e;let t=new Map;return e.forEach(e=>{let a=e.roomType;t.has(a)||t.set(a,{...e,bathrooms:null,projectNames:e.projectNames?[...e.projectNames]:[],count:0,avgPrice:0});let r=t.get(a),s=r.avgPrice*r.count,i=e.avgPrice*e.count,n=r.count+e.count;r.count=n,r.avgPrice=n>0?(s+i)/n:0,r.minPrice=Math.min(r.minPrice,e.minPrice),r.maxPrice=Math.max(r.maxPrice,e.maxPrice);let l=r.count-e.count,c=e.count;if(r.medianPrice=(r.medianPrice*l+e.medianPrice*c)/n,r.q1Price=(r.q1Price*l+e.q1Price*c)/n,r.q3Price=(r.q3Price*l+e.q3Price*c)/n,e.projectNames){let t=new Set([...r.projectNames||[],...e.projectNames]);r.projectNames=Array.from(t)}}),Array.from(t.values()).sort((e,t)=>c.indexOf(e.roomType)-c.indexOf(t.roomType))},[F,a,L,c]),W=(0,s.useMemo)(()=>{if("county"===u&&T){let e={},t=new Set;T.forEach(a=>{let r=a["房型"]||a.roomType||a["戶型"];if(!r||"其他"===r){let e=Number(a["房數"]);r=!isNaN(e)&&e>0?`${e}房`:"其他"}let s="string"==typeof r?r.replace(/\s+/g,""):r;("number"==typeof s||"string"==typeof s&&/^\d+$/.test(s))&&(s=`${s}房`);let i=a["縣市"]||"未知";e[s]||(e[s]={}),e[s][i]=(e[s][i]||0)+1,t.add(i)});let r=Array.from(t).sort(),s={},i=0;r.forEach(e=>s[e]=0);let n=a.map(t=>{let a=e[t]||{},n=0,l=r.map(e=>{let t=a[e]||0;return n+=t,s[e]+=t,t});return i+=n,{roomType:t,cells:l,rowTotal:n}});return{locations:r,rows:n,locationTotals:s,grandTotal:i}}if("district"===u){let e={},t=new Set;if(T)T.forEach(a=>{let r=a["房型"]||a.roomType||a["戶型"];if(!r||"其他"===r){let e=Number(a["房數"]);r=!isNaN(e)&&e>0?`${e}房`:"其他"}let s="string"==typeof r?r.replace(/\s+/g,""):r;("number"==typeof s||"string"==typeof s&&/^\d+$/.test(s))&&(s=`${s}房`);let i=a["行政區"]||"未知",n=a["縣市"]||"未知";A&&n!==A||(e[s]||(e[s]={}),e[s][i]=(e[s][i]||0)+1,t.add(i))}),A||(R&&R.length>0?R:l).forEach(e=>t.add(e));else if(E){let r=new Set;a.forEach(e=>{let t=E[e];t&&Object.keys(t).forEach(e=>r.add(e))}),r.forEach(e=>t.add(e)),A||(R&&R.length>0?R:l).forEach(e=>t.add(e)),a.forEach(t=>{let a=E[t];a&&(e[t]=a)})}let r=Array.from(t).sort(),s={},i=0;r.forEach(e=>s[e]=0);let n=a.map(t=>{let a=e[t]||{},n=0,l=r.map(e=>{let t=a[e]||0;return n+=t,s[e]+=t,t});return i+=n,{roomType:t,cells:l,rowTotal:n}});return{locations:r,rows:n,locationTotals:s,grandTotal:i}}return null},[E,T,a,u,A]),[U,H]=(0,s.useState)(new Set),q=(0,s.useMemo)(()=>W?W.rows.map(e=>{let t={房型:e.roomType};return W.locations.forEach((a,r)=>{t[a]=e.cells[r]}),t["總計"]=e.rowTotal,t}):[],[W]),Y=e=>(0,r.jsxs)("div",{className:(0,f.cn)("flex bg-zinc-800 rounded-md p-0.5 border border-white/5",e),children:[(0,r.jsx)("button",{onClick:()=>N("district"),"data-report-control":"allow",className:(0,f.cn)("px-2 py-1 text-xs rounded transition-colors","district"===u?"bg-zinc-700 text-white":"text-zinc-400 hover:text-white"),children:"行政區"}),(0,r.jsx)("button",{onClick:()=>N("county"),"data-report-control":"allow",className:(0,f.cn)("px-2 py-1 text-xs rounded transition-colors","county"===u?"bg-zinc-700 text-white":"text-zinc-400 hover:text-white"),children:"縣市"})]}),Z=()=>"district"!==u||_.length<=1?null:(0,r.jsxs)("div",{className:"flex items-center gap-2",children:[(0,r.jsx)("span",{className:"text-sm text-zinc-500",children:"顯示縣市:"}),(0,r.jsxs)("div",{className:"flex gap-1 bg-zinc-900 p-1 rounded-lg",children:[(0,r.jsx)("button",{onClick:()=>C(null),"data-report-control":"allow",className:(0,f.cn)("px-3 py-1 text-xs font-medium rounded-md transition-all",A?"text-zinc-500 hover:text-zinc-300 hover:bg-zinc-800":"bg-violet-500/20 text-violet-300 shadow-sm border border-violet-500/50"),children:"全部"}),_.map(e=>(0,r.jsx)("button",{onClick:()=>C(e),"data-report-control":"allow",className:(0,f.cn)("px-3 py-1 text-xs font-medium rounded-md transition-all",A===e?"bg-violet-500/20 text-violet-300 shadow-sm border border-violet-500/50":"text-zinc-500 hover:text-zinc-300 hover:bg-zinc-800"),children:e},e))]})]}),V=e=>F.filter(t=>t.roomType===e).sort((e,t)=>(Number(e.bathrooms)||0)-(Number(t.bathrooms)||0)),G=(0,s.useMemo)(()=>{if(!L)return B;let e=[];return B.forEach(t=>{if(e.push(t),U.has(t.roomType)){let a=V(t.roomType);e.push(...a)}}),e},[B,L,U,F]);return(0,r.jsxs)("div",{className:"space-y-6 animate-in fade-in slide-in-from-bottom-4 duration-500",children:[(0,r.jsxs)("div",{id:"room-type-filter-anchor","data-report-control":"hide",className:"p-4 bg-zinc-900/30 border border-white/5 rounded-lg flex flex-col sm:flex-row sm:flex-wrap items-start sm:items-center justify-between gap-3 sm:gap-4 scroll-mt-24",children:[(0,r.jsxs)("div",{className:"w-full sm:w-auto flex flex-wrap items-center gap-2",children:[(0,r.jsx)("span",{className:"text-zinc-400 text-sm whitespace-nowrap shrink-0 mr-1",children:"分析房型:"}),(0,r.jsx)("div",{className:"flex flex-wrap gap-1.5 sm:gap-2",children:y.M.map(e=>(0,r.jsx)("button",{onClick:()=>{n(a.includes(e)?a.filter(t=>t!==e):[...a,e])},className:(0,f.cn)("px-3 py-1 rounded-full text-xs font-medium transition-colors border",a.includes(e)?"bg-violet-500/20 border-violet-500 text-violet-200":"bg-zinc-800 border-zinc-700 text-zinc-500 hover:bg-zinc-700"),children:e},e))})]}),O&&(0,r.jsxs)("div",{"data-report-control":"hide",className:"flex items-center gap-2 bg-zinc-800/50 p-1 rounded-lg border border-white/5 ml-auto sm:ml-0",children:[(0,r.jsx)("span",{className:"text-xs text-zinc-400 pl-2",children:"表格顯示:"}),(0,r.jsx)("button",{onClick:()=>D(!L),className:(0,f.cn)("px-3 py-1 text-xs font-medium rounded-md transition-all whitespace-nowrap",L?"bg-violet-500 text-white shadow-sm":"text-zinc-400 hover:text-white hover:bg-zinc-700"),children:L?"依房型合併":"顯示衛浴細節"})]})]}),t.includes("chart")&&(0,r.jsx)(i.c,{title:"各房型總價帶分佈箱型圖",description:"顯示各房型總價的中位數與四分位距",containerRef:o,headerAction:(0,r.jsx)(j.N,{data:B,filename:"price_band_chart_data",label:"匯出",chartType:"price-band-chart",targetRef:o,snapshotData:B,columns:{roomType:"房型",bathrooms:"衛浴",minPrice:"最低價",q1Price:"Q1",medianPrice:"中位數",q3Price:"Q3",maxPrice:"最高價",avgPrice:"平均價",count:"筆數"}}),children:(0,r.jsx)(p,{data:B})}),t.includes("table")&&(0,r.jsx)(i.c,{title:"總價帶詳細數據",description:L?"各房型合併統計 (點擊「全部」可展開細節)":"各房型詳細價格統計",containerRef:d,headerAction:(0,r.jsx)(j.N,{data:G,filename:"price_band_detail_data",label:"匯出",chartType:"price-band-table",targetRef:d,snapshotData:G,columns:{roomType:"房型",bathrooms:"衛浴",minPrice:"最低價",q1Price:"Q1",medianPrice:"中位數",q3Price:"Q3",maxPrice:"最高價",avgPrice:"平均價",count:"筆數"}}),children:(0,r.jsx)("div",{className:"overflow-x-auto",children:(0,r.jsxs)("table",{className:"w-full text-sm text-left",children:[(0,r.jsx)("thead",{className:"bg-zinc-900/80 text-zinc-400 uppercase text-xs font-semibold",children:(0,r.jsxs)("tr",{children:[(0,r.jsx)("th",{className:"px-4 py-3",children:"房型"}),(0,r.jsx)("th",{className:"px-4 py-3",children:"衛浴"}),(0,r.jsx)("th",{className:"px-4 py-3 whitespace-nowrap min-w-[100px]",children:"建案數"}),(0,r.jsx)("th",{className:"px-4 py-3 whitespace-nowrap",children:"筆數"}),(0,r.jsx)("th",{className:"px-4 py-3 whitespace-nowrap",children:"平均總價"}),(0,r.jsx)("th",{className:"px-4 py-3",children:"最低總價"}),(0,r.jsx)("th",{className:"px-4 py-3",children:"1/4位總價"}),(0,r.jsx)("th",{className:"px-4 py-3 text-violet-400",children:"中位數總價"}),(0,r.jsx)("th",{className:"px-4 py-3",children:"3/4位總價"}),(0,r.jsx)("th",{className:"px-4 py-3",children:"最高總價"})]})}),(0,r.jsxs)("tbody",{className:"divide-y divide-white/5",children:[B.map((e,t)=>{let a=L&&null===e.bathrooms,i=U.has(e.roomType),n=a&&i?V(e.roomType):[];return(0,r.jsxs)(s.Fragment,{children:[(0,r.jsxs)("tr",{className:(0,f.cn)("hover:bg-zinc-800/50 transition-colors",i&&"bg-zinc-800/30"),children:[(0,r.jsx)("td",{className:"px-4 py-3 font-medium text-white",children:e.roomType}),(0,r.jsx)("td",{className:"px-4 py-3 text-zinc-400",children:a?(0,r.jsxs)("button",{onClick:()=>{var t;return t=e.roomType,void H(e=>{let a=new Set(e);return a.has(t)?a.delete(t):a.add(t),a})},"data-report-control":"allow",className:"flex items-center gap-1 text-xs px-2 py-0.5 rounded bg-zinc-700/50 hover:bg-zinc-600 hover:text-white transition-colors cursor-pointer",children:[(0,r.jsx)("span",{children:"全部"}),(0,r.jsx)("span",{className:(0,f.cn)("transform transition-transform text-[10px]",i?"rotate-180":""),children:"▼"})]}):e.bathrooms??"-"}),(0,r.jsx)("td",{className:"px-4 py-3",children:e.projectNames&&e.projectNames.length>0?(0,r.jsxs)("button",{onClick:()=>$(e.roomType,e.bathrooms,e.projectNames||[]),className:"px-2 py-1 text-xs font-medium rounded-full bg-violet-500/20 border border-violet-500/50 text-violet-300 hover:bg-violet-500/30 transition-colors cursor-pointer whitespace-nowrap",children:[e.projectNames.length," 建案"]}):(0,r.jsx)("span",{className:"text-zinc-500",children:"-"})}),(0,r.jsx)("td",{className:"px-4 py-3 text-zinc-300",children:e.count.toLocaleString()}),(0,r.jsx)("td",{className:"px-4 py-3 font-mono text-zinc-300",children:e.avgPrice.toLocaleString(void 0,{maximumFractionDigits:0})}),(0,r.jsx)("td",{className:"px-4 py-3 font-mono text-zinc-500",children:e.minPrice.toLocaleString()}),(0,r.jsx)("td",{className:"px-4 py-3 font-mono text-zinc-500",children:e.q1Price.toLocaleString()}),(0,r.jsx)("td",{className:"px-4 py-3 font-mono text-violet-400 font-bold",children:e.medianPrice.toLocaleString()}),(0,r.jsx)("td",{className:"px-4 py-3 font-mono text-zinc-500",children:e.q3Price.toLocaleString()}),(0,r.jsx)("td",{className:"px-4 py-3 font-mono text-zinc-500",children:e.maxPrice.toLocaleString()})]}),n.map((e,a)=>(0,r.jsxs)("tr",{className:"bg-zinc-900/50 hover:bg-zinc-900 border-l-2 border-l-violet-500/30",children:[(0,r.jsxs)("td",{className:"px-4 py-2 font-medium text-zinc-500 text-xs pl-8",children:["↳ ",e.roomType]}),(0,r.jsxs)("td",{className:"px-4 py-2 text-zinc-400 text-xs",children:[e.bathrooms," 衛"]}),(0,r.jsx)("td",{className:"px-4 py-2",children:e.projectNames&&e.projectNames.length>0?(0,r.jsxs)("button",{onClick:()=>$(e.roomType,e.bathrooms,e.projectNames||[]),className:"text-xs text-zinc-500 hover:text-zinc-300 underline decoration-zinc-700",children:[e.projectNames.length," 建案"]}):"-"}),(0,r.jsx)("td",{className:"px-4 py-2 text-zinc-500 text-xs",children:e.count.toLocaleString()}),(0,r.jsx)("td",{className:"px-4 py-2 font-mono text-zinc-500 text-xs",children:e.avgPrice.toLocaleString(void 0,{maximumFractionDigits:0})}),(0,r.jsx)("td",{className:"px-4 py-2 font-mono text-zinc-600 text-xs",children:e.minPrice.toLocaleString()}),(0,r.jsx)("td",{className:"px-4 py-2 font-mono text-zinc-600 text-xs",children:e.q1Price.toLocaleString()}),(0,r.jsx)("td",{className:"px-4 py-2 font-mono text-zinc-500 text-xs font-medium",children:e.medianPrice.toLocaleString()}),(0,r.jsx)("td",{className:"px-4 py-2 font-mono text-zinc-600 text-xs",children:e.q3Price.toLocaleString()}),(0,r.jsx)("td",{className:"px-4 py-2 font-mono text-zinc-600 text-xs",children:e.maxPrice.toLocaleString()})]},`${t}-sub-${a}`))]},t)}),0===I.length&&(0,r.jsx)("tr",{children:(0,r.jsx)("td",{colSpan:10,className:"p-8 text-center text-zinc-500",children:"請選擇房型顯示數據"})})]})]})})}),(W||T)&&(0,r.jsxs)("div",{className:"space-y-6 pt-4 border-t border-white/5",children:[t.includes("location-table")&&(0,r.jsxs)(i.c,{title:"區域房型成交分佈",containerRef:x,headerAction:(0,r.jsx)(j.N,{data:q,filename:"price_band_location_cross_table",label:"匯出",chartType:"price-band-location-table",targetRef:x,snapshotData:W}),children:[(0,r.jsxs)("div",{className:"flex flex-wrap items-center gap-3 mb-2","data-html2canvas-ignore":"true",children:[Z(),(0,r.jsx)("div",{className:"ml-auto",children:Y()})]}),(0,r.jsx)("div",{className:"overflow-x-auto",children:W?(0,r.jsxs)("table",{className:"w-full text-sm text-left border-collapse",children:[(0,r.jsx)("thead",{className:"bg-zinc-900/80 text-zinc-400 font-semibold",children:(0,r.jsxs)("tr",{children:[(0,r.jsx)("th",{className:"px-3 py-2 sticky left-0 bg-zinc-900 z-10 border-r border-white/5",children:"房型"}),W.locations.map(e=>(0,r.jsx)("th",{className:"px-3 py-2 text-center min-w-[80px]",children:e},e)),(0,r.jsx)("th",{className:"px-3 py-2 text-center border-l border-white/5 bg-zinc-900 font-bold text-white",children:"總計"})]})}),(0,r.jsx)("tbody",{className:"divide-y divide-white/5",children:W.rows.map((e,t)=>(0,r.jsxs)("tr",{className:"hover:bg-zinc-800/30",children:[(0,r.jsx)("td",{className:"px-3 py-2 font-medium text-zinc-300 sticky left-0 bg-zinc-950/90 border-r border-white/5",children:e.roomType}),e.cells.map((e,t)=>{let a=e>0?Math.min(e/20,1):0,s=e>0?{backgroundColor:`rgba(6, 182, 212, ${.3*a})`}:{};return(0,r.jsx)("td",{className:"px-3 py-2 text-center text-zinc-400",style:s,children:e>0?e:"-"},t)}),(0,r.jsx)("td",{className:"px-3 py-2 text-center font-bold text-white border-l border-white/5 bg-zinc-900/50",children:e.rowTotal})]},t))}),(0,r.jsx)("tfoot",{className:"bg-zinc-900 font-bold border-t-2 border-zinc-700",children:(0,r.jsxs)("tr",{children:[(0,r.jsx)("td",{className:"px-3 py-2 sticky left-0 bg-zinc-900 border-r border-white/5 text-white",children:"總計"}),W.locations.map(e=>(0,r.jsx)("td",{className:"px-3 py-2 text-center text-white",children:W.locationTotals[e]},e)),(0,r.jsx)("td",{className:"px-3 py-2 text-center text-cyan-400 border-l border-white/5 bg-zinc-900",children:W.grandTotal})]})})]}):(0,r.jsx)("div",{className:"p-8 text-center text-zinc-500",children:"無區域分佈數據"})})]}),t.includes("location-chart")&&(0,r.jsxs)(i.c,{title:"區域成交佔比圖表",containerRef:h,headerAction:(0,r.jsx)("div",{className:"flex items-center gap-2",children:(0,r.jsx)(j.N,{data:q,filename:"price_band_location_chart_data",label:"匯出",chartType:"price-band-location-chart",targetRef:h,snapshotData:W,chartId:m})}),children:[(0,r.jsxs)("div",{className:"flex flex-wrap items-center gap-3 mb-2","data-html2canvas-ignore":"true",children:[Z(),(0,r.jsx)("div",{className:"ml-auto",children:Y()})]}),W&&(0,r.jsx)(g,{roomTypes:a,locations:W.locations,crossTable:W.rows.reduce((e,t)=>{let a={};return W.locations.forEach((e,r)=>{a[e]=t.cells[r]}),e[t.roomType]=a,e},{}),dimension:u,chartId:m})]})]}),(0,r.jsx)(b,{isOpen:w,onClose:()=>z(!1),title:k,projects:P}),(0,r.jsx)(b,{isOpen:w,onClose:()=>z(!1),title:k,projects:P}),(0,r.jsx)(v.K,{})]})}},78269:(e,t,a)=>{a.d(t,{b:()=>O});var r=a(95155),s=a(12115),i=a(68605),n=a(47650),l=a(40980),c=a(43987),o=a(32745),d=a(75364),x=a(8875);let h=(e,t=0)=>e?.toLocaleString(void 0,{maximumFractionDigits:t}),m=[{key:"employee",label:"員工關係戶",shortLabel:"員",badgeClass:"border-purple-500/70 text-purple-300",predicate:e=>!!e.isEmployeeRelated},{key:"office",label:"事務所/商辦",shortLabel:"辦",badgeClass:"border-blue-500/70 text-blue-300",predicate:e=>!!e.isOffice},{key:"storefront",label:"店鋪",shortLabel:"店",badgeClass:"border-amber-500/70 text-amber-300",predicate:e=>!!e.isStorefront}],p=e=>null===e?"#1f2937":e<0?"rgba(16, 185, 129, 0.4)":0===e?"#06b6d4":e>5?"rgba(244, 63, 94, 0.5)":e>2?"rgba(249, 115, 22, 0.5)":"rgba(234, 179, 8, 0.4)",u=({children:e,triggerRect:t,isTopRow:a})=>{if(!t)return null;let s={position:"fixed",left:t.left+t.width/2,transform:"translateX(-50%)",zIndex:9999};return a?s.top=t.bottom+8:s.bottom=window.innerHeight-t.top+8,(0,n.createPortal)((0,r.jsx)("div",{style:s,className:"pointer-events-none",children:e}),document.body)};function g({data:e,floorPremium:t=.3,showGrid:a=!0,showSummary:i=!0,showComparison:n=!0,configProject:g,configScope:f,rawTransactions:b}){let j,y,{horizontalGrid:v,sortedFloors:N,sortedUnits:w,unitColorMap:z,summary:k,horizontalComparison:S}=e,[P,M]=(0,s.useState)(null),[A,C]=(0,s.useState)(null),[_,$]=(0,s.useState)(null),[F,E]=(0,s.useState)(!1),[R,T]=(0,s.useState)("premium"),[I,L]=(0,s.useState)("percent"),[D,O]=(0,s.useState)(null),B=f||d.Ze;(0,s.useEffect)(()=>{if(!g)return;let e=async()=>{let e=(0,d.oP)(g,B);e&&$(e);try{let e=await (0,d.ew)(g);e&&$(e)}catch(e){console.warn("Failed to fetch official config:",e)}};e();let t=t=>{!t.detail?.project||t.detail.project!==g||t.detail?.scope&&t.detail.scope!==B||e()};return window.addEventListener(d.Vz,t),()=>window.removeEventListener(d.Vz,t)},[g,B]),(0,s.useEffect)(()=>{O(null)},[A]);let W=(0,s.useCallback)(e=>{$(e)},[]),U=(0,s.useMemo)(()=>{if(!n||!v||!w||0===w.length)return{topPair:null,maxPairOverall:null,unitOverallStats:new Map,unitFloorStats:new Map,unitsInMaxPair:new Set};let e=new Map(w.map((e,t)=>[e,t])),t=new Map;Object.keys(v||{}).forEach(e=>{let a=new Map,r=v?.[e]||{};Object.keys(r).forEach(e=>{(r[e]||[]).forEach(t=>{if(!t||null===t.premium)return;let r=parseFloat(t["房屋單價(萬)"]||t.unitPrice||0);Number.isFinite(r)&&!(r<=0)&&(a.has(e)||a.set(e,[]),a.get(e).push(r))})}),a.size>0&&t.set(e,a)});let a=new Map,r=new Set,s=null,i=(e,t)=>{let a=e=>e?e.startsWith("B")?-parseInt(e.substring(1)):parseInt(e)||0:0;return a(t)-a(e)},l=(e,t)=>{if(!e.length)return 0;let a=[...e].sort((e,t)=>e-t),r=(a.length-1)*t,s=Math.floor(r);return void 0!==a[s+1]?a[s]+(r-s)*(a[s+1]-a[s]):a[s]},c=(e,t)=>e.reduce((e,a)=>e?Math.abs(a.diff-t)<Math.abs(e.diff-t)?a:e:a,e[0]),o=e=>{if(!e.length)return null;let t=e.map(e=>e.diff),a=l(t,.25),r=l(t,.5),s=l(t,.75),i=r>=0?e.reduce((e,t)=>t.diff>e.diff?t:e,e[0]):e.reduce((e,t)=>t.diff<e.diff?t:e,e[0]);return{q1:a,median:r,q3:s,max:i.diff,samples:{q1:c(e,a),median:c(e,r),q3:c(e,s),max:i}}},d=new Map,x=new Map,h=new Map;Array.from(t.keys()).sort(i).forEach(i=>{let n=t.get(i);if(!n)return;let l=Array.from(n.keys()).sort((t,a)=>(e.get(t)??0)-(e.get(a)??0)),c=null;for(let e=0;e<l.length;e++)for(let t=e+1;t<l.length;t++){let r=l[e],s=l[t],i=n.get(r)||[],o=n.get(s)||[];if(!i.length||!o.length)continue;let d=[],x=i.slice(0,20),h=o.slice(0,20);x.forEach(e=>{h.forEach(t=>{d.push(e-t)})});let m=`${r}__${s}`;a.has(m)||a.set(m,{unitA:r,unitB:s,diffs:[],count:0});let p=a.get(m);p.diffs.push(...d),p.count+=1;let u=d.reduce((e,t)=>Math.abs(t)>Math.abs(e)?t:e,d[0]);(!c||Math.abs(u)>Math.abs(c.diff))&&(c={unitHigh:u>=0?r:s,unitLow:u>=0?s:r,diff:u})}c&&(r.add(c.unitHigh),r.add(c.unitLow),(!s||Math.abs(c.diff)>Math.abs(s.diff))&&(s={floor:i,unitHigh:c.unitHigh,unitLow:c.unitLow,diff:c.diff})),l.forEach(e=>{let t=n.get(e)||[];if(!t.length)return;let a=[],r=t.slice(0,10);if(l.forEach(t=>{if(t===e)return;let s=n.get(t)||[];if(!s.length)return;let l=s.slice(0,10);r.forEach(e=>{l.forEach(r=>{a.push({diff:e-r,otherUnit:t,floor:i})})})}),!a.length)return;let s=o(a);s&&(x.has(e)||x.set(e,[]),x.get(e).push({floor:i,...s}),h.has(e)||h.set(e,[]),h.get(e).push(...a))})}),x.forEach(e=>e.sort((e,t)=>i(e.floor,t.floor))),h.forEach((e,t)=>{let a=o(e);a&&d.set(t,a)});let m=null;return a.forEach(e=>{let t=e.diffs.reduce((e,t)=>e+t,0)/e.diffs.length;if(!m||e.count>m.count){m={unitA:e.unitA,unitB:e.unitB,count:e.count,avgDiff:t};return}e.count===m.count&&Math.abs(t)>Math.abs(m.avgDiff)&&(m={unitA:e.unitA,unitB:e.unitB,count:e.count,avgDiff:t})}),{topPair:m,maxPairOverall:s,unitOverallStats:d,unitFloorStats:x,unitsInMaxPair:r}},[v,w,n]);(0,s.useMemo)(()=>{if(!_?.configurations||!Array.isArray(_.configurations))return null;let e=new Map;return _.configurations.forEach(t=>{if(!t||!Array.isArray(t.positions)||!t.floorRange)return;let a=(0,o.Qy)(t.positions,t.envTiles||[],t.compassDirection||0,1);if(!a||!Array.isArray(a))return;let r=new Map(a.filter(e=>!!e).map(e=>[e.unitType,e])),s=Math.min(Number(t.floorRange.start)||0,Number(t.floorRange.end)||0),i=Math.max(Number(t.floorRange.start)||0,Number(t.floorRange.end)||0);for(let t=s;t<=i;t++)e.set(t,r)}),e},[_]);let H={school:"學校",plaza:"廣場",park:"公園",river:"河景",tower:"高壓塔",grave:"墓地",bridge:"高架橋",mountain:"山景",adjacent:"臨房"},q={N:"北",S:"南",E:"東",W:"西",NE:"東北",NW:"西北",SE:"東南",SW:"西南"},Y=e=>{let t=[];if(e.roadFacing){let a=e.roadFacingDirections&&e.roadFacingDirections.length>0?e.roadFacingDirections:e.roadFacingDirection?[e.roadFacingDirection]:[];a.length?a.forEach(e=>{let a=q[e]||e;t.push({text:`${a}臨路`,tone:"road"})}):t.push({text:"臨路",tone:"road"})}if(e.facingOpenSpace&&e.openSpaceType){let a=new Set(["tower","grave","bridge"]);(e.openSpaceFacingDirections&&e.openSpaceFacingDirections.length>0?e.openSpaceFacingDirections.map(e=>({dir:e.direction,type:e.type})):[{dir:e.openSpaceFacingDirection||"",type:e.openSpaceType}]).forEach(e=>{if(!e.type)return;let r=H[e.type]||e.type,s=e.dir?q[e.dir]||e.dir:"",i=s?`${s}`:"";if("adjacent"===e.type)return void t.push({text:`${i}${r}`,tone:"adjacent"});let n=a.has(e.type);t.push({text:`${i}面${r}`,tone:n?"bad":"good"})})}return e.adjacentToUnits&&!t.some(e=>e.text.includes("臨房"))&&t.push({text:"臨房",tone:"adjacent"}),t},Z=(0,s.useMemo)(()=>{if(!_?.configurations||!Array.isArray(_.configurations))return null;let e=new Map;return _.configurations.forEach(t=>{if(!t||!Array.isArray(t.positions))return;let a=(0,o.Qy)(t.positions,t.envTiles||[],t.compassDirection||0,1);a?.forEach(t=>{if(!t)return;let a=Y(t);e.has(t.unitType)||e.set(t.unitType,{labelMap:new Map,details:[]});let r=e.get(t.unitType);a.forEach(e=>{r.labelMap.set(e.text,e.tone)})})}),e},[_,Y]),[V,G]=(0,s.useState)(null),[J,X]=(0,s.useState)(null),K=(()=>{let e=k?.calculationFlags;if(!e)return"排除店舖/辦公室";let t=[];return e.includesStorefrontPremium||t.push("店舖"),e.includesOfficePremium||t.push("辦公室"),e.includesEmployeePremium||t.push("員工關係戶"),t.length?`排除${t.join("/")}`:"全部納入"})(),Q=(0,s.useMemo)(()=>{let e={};return v&&w&&w.forEach(t=>{let a=1/0,r=0;if(N?.forEach(e=>{(v?.[e]?.[t]||[]).forEach(e=>{if(!e||e?.isStorefront||e?.isOffice)return;let t=Number(e?.tooltipInfo?.houseArea||e?.houseArea||0);Number.isFinite(t)&&!(t<=0)&&(t<a&&(a=t),t>r&&(r=t))})}),!Number.isFinite(a)||r<=0){e[t]={hasVariance:!1,label:""};return}let s=r-a>3,i=`${a.toFixed(2).replace(/\.00$/,"")}–${r.toFixed(2).replace(/\.00$/,"")} 坪`;e[t]={hasVariance:s,label:s?i:""}}),e},[v,N,w]),ee=()=>{M(null)};return v&&N&&w?(0,r.jsxs)("div",{className:"space-y-8 overflow-x-auto relative",children:[P&&(0,r.jsx)(u,{triggerRect:P.rect,isTopRow:P.isTopRow,children:(j=P.data,y=m.filter(e=>e.predicate(j)).map(e=>e.label),(0,r.jsx)("div",{className:"w-48 bg-zinc-900 border border-zinc-700 rounded-lg p-3 shadow-xl animate-in fade-in zoom-in-95 duration-200",children:(0,r.jsxs)("div",{className:"space-y-1",children:[y.length>0&&(0,r.jsxs)("div",{className:"text-amber-300 text-xs",children:["特殊交易: ",y.join("、")]}),P.data?.hasParking&&(0,r.jsxs)("div",{className:"flex items-center gap-1 text-xs text-blue-300",children:[(0,r.jsx)("span",{className:"flex items-center justify-center w-3 h-3 bg-blue-500 text-white text-[8px] font-bold rounded-sm",children:"P"}),(0,r.jsx)("span",{children:"含車位"})]}),P.data?.premium===0&&(0,r.jsx)("div",{className:"text-cyan-400 font-bold mb-1",children:"★ 基準戶"}),P.data?.premium!==void 0&&P.data?.premium!==null&&(0,r.jsxs)("div",{className:"text-zinc-300",children:["調價: ",(0,r.jsxs)("span",{className:(0,l.cn)(P.data.premium>0?"text-red-400":P.data.premium<0?"text-violet-400":"text-zinc-400"),children:[P.data.premium>0?"+":"",P.data.premium.toFixed(2),"%"]})]}),(0,r.jsx)("div",{className:"h-px bg-zinc-700 my-2"}),(0,r.jsxs)("div",{className:"grid grid-cols-2 gap-x-2 gap-y-1 text-xs text-zinc-400",children:[(0,r.jsx)("span",{children:"成交總價:"})," ",(0,r.jsxs)("span",{className:"text-white text-right",children:[h(P.data?.tooltipInfo?.totalPrice??P.data?.totalPrice),"萬"]}),(0,r.jsx)("span",{children:"房屋總價:"})," ",(0,r.jsxs)("span",{className:"text-white text-right",children:[h(P.data?.tooltipInfo?.housePrice??P.data?.housePrice),"萬"]}),(0,r.jsx)("span",{children:"車位總價:"})," ",(0,r.jsxs)("span",{className:"text-white text-right",children:[h(P.data?.tooltipInfo?.parkingPrice??P.data?.parkingPrice),"萬"]}),(0,r.jsx)("span",{children:"房屋面積:"})," ",(0,r.jsxs)("span",{className:"text-white text-right",children:[h(P.data?.tooltipInfo?.houseArea??P.data?.houseArea,2),"坪"]})]})]})}))}),V&&(0,r.jsx)(u,{triggerRect:V.rect,isTopRow:!0,children:(0,r.jsxs)("div",{className:"w-56 bg-zinc-900 border border-zinc-700 rounded-lg p-2 shadow-xl text-xs text-zinc-300",children:["住宅面積變化: ",(0,r.jsx)("span",{className:"text-amber-300",children:V.label}),(0,r.jsx)("div",{className:"text-[10px] text-zinc-500 mt-1",children:"已排除店舖/商辦"})]})}),a&&(0,r.jsxs)("div",{className:"min-w-max pb-32",children:[(0,r.jsxs)("div",{className:"flex items-center justify-end gap-2 mb-2",children:[(0,r.jsx)("span",{className:"text-xs text-zinc-500",children:"特殊交易"}),m.map(e=>{let t=J===e.key;return(0,r.jsxs)("button",{onClick:()=>X(t=>t===e.key?null:e.key),className:(0,l.cn)("flex items-center gap-1 px-2 py-1 rounded border text-[10px] transition",t?"border-cyan-400 text-cyan-300 bg-cyan-500/10":"border-white/10 text-zinc-400 hover:text-zinc-200 hover:border-white/30"),children:[(0,r.jsx)("span",{className:(0,l.cn)("w-4 h-4 rounded border flex items-center justify-center text-[9px] font-bold bg-transparent",e.badgeClass),title:e.label,children:e.shortLabel}),e.label]},e.key)})]}),(0,r.jsxs)("table",{className:"divide-y divide-zinc-800 border-collapse w-full text-sm",children:[(0,r.jsx)("thead",{children:(0,r.jsxs)("tr",{children:[(0,r.jsx)("th",{className:"sticky left-0 bg-dark-card z-20 p-2 text-zinc-400 border-r border-zinc-800",children:"樓層 \\ 戶別"}),w.map(e=>(0,r.jsx)("th",{className:(0,l.cn)("p-2 text-zinc-300 font-medium border-l border-zinc-800/50 bg-zinc-900/50 relative",Q[e]?.hasVariance&&"bg-amber-500/10"),onMouseEnter:t=>{let a=Q[e];a?.hasVariance&&G({rect:t.currentTarget.getBoundingClientRect(),label:a.label})},onMouseLeave:()=>G(null),children:(0,r.jsxs)("span",{className:"inline-flex items-center justify-center gap-1",children:[e,Q[e]?.hasVariance&&(0,r.jsx)("span",{className:"px-1 py-0.5 text-[9px] rounded border border-amber-400/70 text-amber-300 bg-amber-500/10",children:"Δ坪"})]})},e))]})}),(0,r.jsx)("tbody",{className:"divide-y divide-zinc-800/50",children:N.map((e,t)=>(0,r.jsxs)("tr",{className:"hover:bg-zinc-800/30 transition-colors",children:[(0,r.jsx)("td",{className:"sticky left-0 bg-dark-card z-10 p-2 font-bold text-zinc-300 border-r border-zinc-800 text-center",children:e}),w.map(a=>{let s=v[e]?.[a];return s&&0!==s.length?(0,r.jsx)("td",{className:"p-1 border-l border-zinc-800/50 align-top",children:(0,r.jsx)("div",{className:"flex flex-col gap-1",children:s.map((e,a)=>{let s=m.filter(t=>t.predicate(e)),i=s.length>0,n=i?"transparent":p(e.premium),o=e.remark?.includes("露台")?{icon:(0,r.jsx)(c.A,{className:"w-3 h-3"}),label:"露台"}:null,d=0===e.premium,x=t<3,h=J?m.find(e=>e.key===J)?.predicate:null,u=!h||h(e);return(0,r.jsxs)("div",{className:(0,l.cn)("p-1.5 rounded text-xs transition-transform hover:scale-105 cursor-default relative group",d&&"ring-1 ring-cyan-500",i&&"bg-transparent border border-zinc-700/60",J&&!u&&"opacity-20",J&&u&&"ring-2 ring-cyan-400"),style:{backgroundColor:n},onMouseEnter:t=>{M({rect:t.currentTarget.getBoundingClientRect(),data:e,isTopRow:x})},onMouseLeave:ee,children:[(0,r.jsxs)("div",{className:"flex flex-col gap-0.5 pr-4",children:[(0,r.jsxs)("span",{className:"font-semibold text-white flex items-center gap-1 leading-tight",children:[o&&(0,r.jsx)("span",{className:"text-zinc-200",title:o.label,children:o.icon}),e.unitPrice.toFixed(1),"萬"]}),(0,r.jsx)("div",{className:"text-[10px] text-zinc-300 font-mono tracking-tight opacity-90",children:e.transactionDate||"-"})]}),(0,r.jsxs)("div",{className:"absolute top-0.5 right-0.5 flex flex-col items-end gap-0.5",children:[s.map(e=>(0,r.jsx)("span",{className:(0,l.cn)("flex items-center justify-center w-3 h-3 text-[8px] font-bold rounded border bg-transparent",e.badgeClass),title:e.label,children:e.shortLabel},e.key)),e.hasParking&&(0,r.jsx)("span",{className:"flex items-center justify-center w-3 h-3 bg-blue-500 text-white text-[8px] font-bold rounded-sm",title:"含車位",children:"P"})]})]},a)})})},`${e}-${a}`):(0,r.jsx)("td",{className:"p-2 border-l border-zinc-800/50 bg-zinc-900/20 text-center text-zinc-600",children:"-"},`${e}-${a}`)})]},e))})]})]}),i&&k&&(0,r.jsxs)("div",{className:"space-y-2",children:[(0,r.jsxs)("h3",{className:"text-lg font-semibold text-zinc-200",children:["調價幅度統計摘要 (",K,")"]}),(0,r.jsx)("div",{className:"overflow-x-auto rounded-lg border border-zinc-800",children:(0,r.jsxs)("table",{className:"w-full text-sm text-left text-zinc-300",children:[(0,r.jsx)("thead",{className:"text-xs text-zinc-400 uppercase bg-zinc-900/50",children:(0,r.jsxs)("tr",{children:[(0,r.jsx)("th",{className:"px-6 py-3",children:"基準房屋總價"}),(0,r.jsx)("th",{className:"px-6 py-3",children:"調價幅度總額"}),(0,r.jsx)("th",{className:"px-6 py-3",children:"總溢價率"}),(0,r.jsx)("th",{className:"px-6 py-3",children:"已售房屋坪數"}),(0,r.jsx)("th",{className:"px-6 py-3",children:"平均單價調價"})]})}),(0,r.jsx)("tbody",{children:(0,r.jsxs)("tr",{className:"bg-zinc-900/20 border-b border-zinc-800",children:[(0,r.jsxs)("td",{className:"px-6 py-4",children:[h(k.totalBaselineHousePrice)," 萬"]}),(0,r.jsxs)("td",{className:(0,l.cn)("px-6 py-4 font-bold",k.totalPricePremiumValue>0?"text-red-400":"text-violet-400"),children:[k.totalPricePremiumValue>0?"+":"",h(k.totalPricePremiumValue)," 萬"]}),(0,r.jsxs)("td",{className:"px-6 py-4",children:[(k.totalPricePremiumValue/k.totalBaselineHousePrice*100).toFixed(2)," %"]}),(0,r.jsxs)("td",{className:"px-6 py-4",children:[h(k.totalSoldArea)," 坪"]}),(0,r.jsxs)("td",{className:(0,l.cn)("px-6 py-4",k.totalPricePremiumValue>0?"text-red-400":"text-violet-400"),children:[(k.totalPricePremiumValue/k.totalSoldArea).toFixed(2)," 萬/坪"]})]})})]})})]}),n&&S&&S.length>0&&(0,r.jsxs)("div",{className:"space-y-2",children:[(0,r.jsx)("h3",{className:"text-lg font-semibold text-zinc-200",children:"戶型水平價差與溢價貢獻"}),(0,r.jsxs)("div",{className:"flex flex-wrap items-center gap-2 text-xs text-zinc-400",children:[e.comparisonMeta&&(0,r.jsxs)("span",{children:["原始最低戶型：",e.comparisonMeta.originalMinUnit||"-"," ","number"==typeof e.comparisonMeta.originalMinAvg?`(${e.comparisonMeta.originalMinAvg.toFixed(2)} 萬/坪)`:""," ｜ ","實際最低戶型：",e.comparisonMeta.actualMinUnit||"-"," ","number"==typeof e.comparisonMeta.actualMinAvg?`(${e.comparisonMeta.actualMinAvg.toFixed(2)} 萬/坪)`:""]}),U.topPair&&(0,r.jsxs)("span",{children:["AI 摘要：常見價差組合 ",U.topPair.unitA," ↔ ",U.topPair.unitB,"（",U.topPair.count," 層，平均差 ",U.topPair.avgDiff>0?"+":"",U.topPair.avgDiff.toFixed(2),"）"]}),U.maxPairOverall&&(0,r.jsxs)("span",{children:["最大價差：",U.maxPairOverall.floor,"F ",U.maxPairOverall.unitHigh," ↔ ",U.maxPairOverall.unitLow,"（",U.maxPairOverall.diff>0?"+":"",U.maxPairOverall.diff.toFixed(2),"）"]}),g&&(0,r.jsxs)("div",{className:"flex items-center gap-2 text-zinc-500",children:[(0,r.jsxs)("span",{children:["樓層配置：",_?.configurations?.length?`已同步 ${_.configurations.length} 組`:"未設定"]}),b&&b.length>0&&(0,r.jsx)("button",{onClick:()=>E(e=>!e),className:"px-2 py-1 rounded border border-white/10 text-[11px] text-zinc-400 hover:text-zinc-200 hover:border-white/30 transition",children:F?"收合配置":"設定配置"})]})]}),F&&b&&b.length>0&&g&&(0,r.jsx)("div",{className:"mt-3",children:(0,r.jsx)(x.sB,{transactions:b,project:g,configOnly:!0,title:"樓層配置（戶型水平價差）",storageScope:B,initialStep:"config",onConfigChange:W,mode:"report"})}),(0,r.jsx)("div",{className:"overflow-x-auto rounded-lg border border-zinc-800",children:(0,r.jsxs)("table",{className:"w-full text-sm text-left text-zinc-300",children:[(0,r.jsx)("thead",{className:"text-xs text-zinc-400 uppercase bg-zinc-900/50",children:(0,r.jsxs)("tr",{children:[(0,r.jsx)("th",{className:"px-4 py-3",children:"戶型"}),(0,r.jsx)("th",{className:"px-4 py-3",children:"環境標籤"}),(0,r.jsx)("th",{className:"px-4 py-3",children:"基準戶 (樓/價)"}),(0,r.jsx)("th",{className:"px-4 py-3",children:"原始平均單價"}),(0,r.jsx)("th",{className:"px-4 py-3",children:"實際平均單價"}),(0,r.jsx)("th",{className:"px-4 py-3",children:"去化戶數"}),(0,r.jsx)("th",{className:"px-4 py-3",children:"去化坪數"}),(0,r.jsx)("th",{className:"px-4 py-3",children:"溢價(萬/坪)"}),(0,r.jsx)("th",{className:"px-4 py-3",children:"溢價貢獻"}),(0,r.jsx)("th",{className:"px-4 py-3",children:"貢獻佔比"}),(0,r.jsx)("th",{className:"px-4 py-3",children:"細節"})]})}),(0,r.jsx)("tbody",{children:S.map((e,t)=>{let a,i,n,c=t=>{t&&t!==e.unitType?O(e=>e===t?null:t):O(null)},o=D&&D!==e.unitType?[e.unitType,D]:[e.unitType];return(0,r.jsxs)(s.Fragment,{children:[(0,r.jsxs)("tr",{className:"bg-zinc-900/20 border-b border-zinc-800 hover:bg-zinc-800/20",children:[(0,r.jsx)("td",{className:"px-4 py-3 font-medium text-white",children:e.unitType}),(0,r.jsx)("td",{className:"px-4 py-3",children:(i=(a=Z?.get(e.unitType))?Array.from(a.labelMap.entries()):[]).length?(0,r.jsx)("div",{className:"flex flex-wrap gap-1",title:a?.details.join(" | "),children:i.map(([t,a])=>(0,r.jsx)("span",{className:`px-2 py-0.5 rounded text-[10px] border ${(e=>{switch(e){case"road":return"border-amber-400/40 text-amber-300 bg-amber-500/10";case"good":return"border-emerald-400/40 text-emerald-300 bg-emerald-500/10";case"bad":return"border-rose-400/40 text-rose-300 bg-rose-500/10";case"adjacent":return"border-zinc-500/40 text-zinc-300 bg-zinc-500/10";default:return"border-white/10 text-zinc-300 bg-white/5"}})(a)}`,children:t},`${e.unitType}-${t}`))}):(0,r.jsx)("span",{className:"text-zinc-500",children:"-"})}),(0,r.jsx)("td",{className:"px-4 py-3",children:e.anchorInfo}),(0,r.jsx)("td",{className:"px-4 py-3",children:"number"==typeof e.originalAvgPrice?`${e.originalAvgPrice.toFixed(2)} 萬/坪`:"-"}),(0,r.jsx)("td",{className:"px-4 py-3",children:"number"==typeof e.actualAvgPrice?`${e.actualAvgPrice.toFixed(2)} 萬/坪`:"-"}),(0,r.jsxs)("td",{className:"px-4 py-3",children:[e.unitsSold," 戶"]}),(0,r.jsx)("td",{className:"px-4 py-3",children:"number"==typeof e.totalSoldArea?`${e.totalSoldArea.toFixed(2)} 坪`:"-"}),(0,r.jsx)("td",{className:(0,l.cn)("px-4 py-3",e.avgPremiumPerPing>0?"text-red-400":"text-violet-400"),children:"number"==typeof e.avgPremiumPerPing?`${e.avgPremiumPerPing>0?"+":""}${e.avgPremiumPerPing.toFixed(2)} 萬/坪`:"-"}),(0,r.jsxs)("td",{className:(0,l.cn)("px-4 py-3 font-bold",e.timePremiumContribution>0?"text-red-400":"text-violet-400"),children:[e.timePremiumContribution>0?"+":"",h(e.timePremiumContribution)," 萬"]}),(0,r.jsxs)("td",{className:"px-4 py-3",children:["number"==typeof e.contributionPercentage?e.contributionPercentage.toFixed(2):"0.00","%"]}),(0,r.jsx)("td",{className:"px-4 py-3",children:(0,r.jsx)("button",{onClick:()=>C(t=>t===e.unitType?null:e.unitType),className:"text-[11px] text-cyan-300 border border-cyan-400/30 rounded px-2 py-1 hover:bg-cyan-500/10 transition",children:A===e.unitType?"收合":"展開"})})]}),A===e.unitType&&(0,r.jsx)("tr",{className:"bg-zinc-950/40 border-b border-zinc-800",children:(0,r.jsx)("td",{colSpan:11,className:"px-4 py-3",children:(0,r.jsxs)("div",{className:"flex flex-col xl:flex-row gap-6",children:[(0,r.jsx)("div",{className:"xl:w-[400px] shrink-0",children:(0,r.jsxs)("div",{className:"bg-zinc-900/40 rounded border border-white/10 p-2 h-full flex flex-col",children:[(0,r.jsxs)("h4",{className:"text-xs font-bold text-zinc-400 mb-2 flex items-center gap-2",children:[(0,r.jsx)("span",{className:"w-1.5 h-1.5 rounded-full bg-cyan-400"}),"樓層配置視圖"]}),(0,r.jsx)("div",{className:"flex-1 min-h-[300px] relative rounded overflow-hidden bg-zinc-950/50 border border-white/5",children:(()=>{let e=_?.configurations?.[0];if(!e)return(0,r.jsx)("div",{className:"absolute inset-0 flex items-center justify-center text-zinc-500 text-xs",children:"無配置資料"});let t=(e.positions||[]).map(e=>(0,x.jk)(e,1)),a=e.envTiles||[];return(0,r.jsx)(x.Cn,{positions:t,envTiles:a,selectedUnits:o,zoom:.6,gridSize:e.gridSize||30,compassDirection:e.compassDirection||0,onPositionsChange:()=>{},onUnitClick:e=>c(e),onZoomChange:()=>{},isAnalyzeMode:!0,showBadges:!1,unitShape:"square"})})()}),(0,r.jsx)("div",{className:"mt-2 text-[10px] text-zinc-500 text-center",children:"* 此為唯讀視圖，顯示目前選擇戶型位置"})]})}),(0,r.jsxs)("div",{className:"flex-1 rounded border border-white/10 bg-zinc-900/40 p-3 overflow-hidden",children:[(0,r.jsxs)("div",{className:"flex items-center justify-between mb-3",children:[(0,r.jsxs)("div",{className:"text-xs text-zinc-400",children:["戶型比價矩陣（單位：","percent"===I?"%":"萬/坪","，",(0,r.jsx)("span",{className:"text-red-400",children:"紅>5%"}),"，",(0,r.jsx)("span",{className:"text-orange-400",children:"橘2~5%"}),"，",(0,r.jsx)("span",{className:"text-yellow-400",children:"黃0~2%"}),"，",(0,r.jsx)("span",{className:"text-emerald-400",children:"綠<0%"}),"）"]}),(0,r.jsxs)("div",{className:"flex bg-zinc-950 p-0.5 rounded-md border border-zinc-800",children:[(0,r.jsx)("button",{onClick:e=>{e.stopPropagation(),L("value")},className:(0,l.cn)("px-2 py-1 text-[10px] rounded transition-all","value"===I?"bg-zinc-800 text-white shadow-sm":"text-zinc-500 hover:text-zinc-300"),children:"價差數值 $"}),(0,r.jsx)("button",{onClick:e=>{e.stopPropagation(),L("percent")},className:(0,l.cn)("px-2 py-1 text-[10px] rounded transition-all","percent"===I?"bg-zinc-800 text-white shadow-sm":"text-zinc-500 hover:text-zinc-300"),children:"價差比例 %"})]})]}),(0,r.jsx)("div",{className:"overflow-x-auto",children:(0,r.jsxs)("table",{className:"w-full text-xs border-collapse",children:[(0,r.jsx)("thead",{children:(0,r.jsxs)("tr",{children:[(0,r.jsx)("th",{className:"p-2 text-zinc-500 font-normal text-left whitespace-nowrap sticky left-0 bg-zinc-900/90 z-10 border-b border-zinc-800",children:"樓層"}),w.filter(t=>t!==e.unitType).map(e=>{let t=Z?.get(e),a=t?Array.from(t.labelMap.keys()):[],s=D===e;return(0,r.jsx)("th",{onClick:()=>c(e),className:(0,l.cn)("p-2 text-zinc-400 font-medium text-center whitespace-nowrap min-w-[60px] border-b border-zinc-800 align-top cursor-pointer transition-colors",s&&"bg-cyan-500/10 text-cyan-200 ring-1 ring-cyan-400/40"),title:"點擊高亮此戶型欄位",children:(0,r.jsxs)("div",{className:"flex flex-col gap-0.5 items-center",children:[(0,r.jsxs)("span",{children:["vs ",e]}),a.map((e,t)=>(0,r.jsx)("span",{className:"text-[10px] bg-zinc-800 text-zinc-400 px-1 rounded transform scale-90 origin-top",children:e},t))]})},e)})]})}),(0,r.jsx)("tbody",{className:"divide-y divide-zinc-800/30",children:(n=w.filter(t=>t!==e.unitType),N.map(t=>{let a=v?.[t]?.[e.unitType],s=a?.[0];if(!s||!s.unitPrice)return null;let i=s.unitPrice;return(0,r.jsxs)("tr",{className:"hover:bg-zinc-800/20",children:[(0,r.jsxs)("td",{className:"p-2 text-zinc-500 font-mono sticky left-0 bg-zinc-900/90 border-r border-zinc-800/50",children:[t,"F"]}),n.map(e=>{let a=v?.[t]?.[e],s=a?.[0],n=s?.unitPrice,c=D===e;if(!n)return(0,r.jsx)("td",{className:(0,l.cn)("p-2 text-center text-zinc-700 transition-colors",c&&"bg-cyan-500/10 ring-1 ring-cyan-400/30"),children:"-"},e);let o=i-n,d=o/n*100,x=p(d),h="text-zinc-200";h=d>5?"text-white font-bold shadow-sm":d<0?"text-emerald-100":d>2?"text-orange-100":"text-yellow-100",.1>Math.abs(d)&&(h="text-zinc-400");let m="percent"===I?`${d.toFixed(1)}%`:o.toFixed(1),u=o>0?"+":"";return(0,r.jsx)("td",{className:(0,l.cn)("p-1 text-center transition-colors",c&&"bg-cyan-500/10"),children:(0,r.jsxs)("div",{className:(0,l.cn)("py-1 px-1.5 rounded text-[11px] font-mono transition-colors",h,c&&"ring-2 ring-cyan-400/70 ring-offset-1 ring-offset-zinc-900/40"),style:{backgroundColor:x},title:`${e}: ${n}萬/坪`,children:[u,m]})},e)})]},t)}))})]})})]})]})})})]},t)})})]})})]})]}):(0,r.jsx)("div",{className:"text-zinc-500 text-center p-8",children:"無有效熱力圖資料"})}var f=a(89579),b=a(80642),j=a(39430),y=a(86901),v=a(94514),N=a(21628);function w({transactions:e,currentPremium:t,onApply:a,onManualChange:i}){let[n,l]=(0,s.useState)(null),[c,o]=(0,s.useState)(!1),[d,x]=(0,s.useState)(String(t)),h=(0,s.useRef)(null),[m,p]=(0,s.useState)(null),[u,g]=(0,s.useState)(360),w=Math.max(160,u-28),z=(0,s.useMemo)(()=>(function(e){if(!e||0===e.length)return[];let t=[],a={},r=new f.B$(e);e.forEach(e=>{let t=((e,t)=>{let a=e?.["戶型"];if("string"==typeof a&&a)return a;let r=t.resolve(e);if(r)return r;let s=e?.["戶別"]||e?.unit||e?.unitName;return"string"==typeof s&&s?s:""})(e,r),s=(e=>{if(!e)return 0;let t=String(e).match(/\d+/);return t?parseInt(t[0],10):0})(e["樓層"]||e.floor||""),i=parseFloat(e["房屋單價(萬)"]||e.unitPrice||0);t&&0!==s&&i>0&&(a[t]||(a[t]=[]),a[t].push({floor:s,price:i,original:e}))}),Object.entries(a).forEach(([e,a])=>{a.sort((e,t)=>e.floor-t.floor);for(let r=0;r<a.length;r++)for(let s=r+1;s<a.length;s++){let i=a[r],n=a[s],l=n.floor-i.floor;if(l>0&&l<=10){let a=Math.round(10*((n.price-i.price)/l))/10;a>=-2&&a<=2&&t.push({stack:e,floorLow:i.floor,floorHigh:n.floor,priceLow:i.price,priceHigh:n.price,diff:a,dateLow:i.original["交易年月日"]||i.original["交易日"]||i.original.transactionDate,dateHigh:n.original["交易年月日"]||n.original["交易日"]||n.original.transactionDate})}}});let s=new Map;t.forEach(e=>{let t=`${e.stack}-${e.floorLow}-${e.floorHigh}-${e.priceLow}-${e.priceHigh}`;s.has(t)||s.set(t,e)});let i=Array.from(s.values()),n={};i.forEach(e=>{n[e.diff]||(n[e.diff]={premium:e.diff,count:0,pairs:[]}),n[e.diff].count+=1,n[e.diff].pairs.push(e)});let l=Object.values(n);return l.sort((e,t)=>t.count!==e.count?t.count-e.count:e.premium-t.premium),l})(e),[e]),k=(0,s.useMemo)(()=>[...z.slice(0,5)].sort((e,t)=>e.premium-t.premium),[z]),S=(0,s.useMemo)(()=>[...z].sort((e,t)=>e.premium-t.premium),[z]),P=(0,s.useMemo)(()=>c?S:k,[c,S,k]),M=(0,s.useMemo)(()=>z.find(e=>1e-6>Math.abs(e.premium-t))||null,[z,t]),A=z.length>k.length;(0,s.useEffect)(()=>{l(null)},[M?.premium]),(0,s.useEffect)(()=>{x(String(t))},[t]),(0,s.useEffect)(()=>{if(!h.current)return;let e=()=>{if(!h.current)return;let e=Math.round(h.current.getBoundingClientRect().width);e>0&&p(e)};e();let t=new ResizeObserver(()=>e());return t.observe(h.current),window.addEventListener("resize",e),()=>{t.disconnect(),window.removeEventListener("resize",e)}},[]),(0,s.useEffect)(()=>{let e=()=>{g(Math.max(260,Math.min(520,Math.round(.55*window.innerHeight))))};return e(),window.addEventListener("resize",e),()=>window.removeEventListener("resize",e)},[]);let C=(0,s.useMemo)(()=>{let t=new Set,a=new Set,r=new f.B$(e);e.forEach(e=>{if(!e)return;let s=(e=>{let t=e?.["戶型"];if("string"==typeof t&&t)return t;let a=r.resolve(e);if(a)return a;let s=e?.["戶別"]||e?.unit||e?.unitName;return"string"==typeof s&&s?s:""})(e),i=(e=>{if(!e)return 0;let t=String(e).match(/\d+/);return t?parseInt(t[0],10):0})(e["樓層"]||e.floor);s&&t.add(s),0!==i&&a.add(i)});let s=Array.from(a).sort((e,t)=>t-e),i=e=>{let t=String(e||"").trim().toUpperCase(),a=t.match(/^([A-Z]+)(\d+)?$/);return a?{alpha:a[1]||"",num:a[2]?parseInt(a[2],10):Number.MAX_SAFE_INTEGER,raw:t}:{alpha:t,num:Number.MAX_SAFE_INTEGER,raw:t}},n=Array.from(t).sort((e,t)=>{let a=i(e),r=i(t),s=a.alpha.localeCompare(r.alpha,"en");return 0!==s?s:a.num!==r.num?a.num-r.num:a.raw.localeCompare(r.raw,"en")}),l=new Set;M&&M.pairs.forEach(e=>{l.add(`${e.stack}-${e.floorLow}`),l.add(`${e.stack}-${e.floorHigh}`)});let c=s.length||1,o=n.length||1,d=(m||0)-32-16,x=u-24-4,h=Math.min(40,Math.max(8,Math.min(d>0?Math.floor(d/o):24,x>0?Math.floor(x/c):24)));return{sortedFloors:s,sortedStacks:n,highlightedCells:l,cellSize:h,gridHeight:c*h+24}},[e,M,m,u]);if(0===z.length)return null;let _=null!==n&&M?M.pairs[n]:null;return(0,r.jsxs)("div",{className:"bg-zinc-900/50 border border-white/10 rounded-xl p-4 mb-6",children:[(0,r.jsxs)("div",{className:"flex items-center gap-2 mb-3",children:[(0,r.jsx)(y.A,{className:"w-4 h-4 text-yellow-400"}),(0,r.jsx)("h3",{className:"text-sm font-bold text-zinc-100",children:"AI 樓層價差分析建議"})]}),(0,r.jsxs)("div",{className:"flex flex-wrap gap-2 mb-4 items-center",children:[P.map(e=>{let s=1e-6>Math.abs(t-e.premium);return(0,r.jsxs)("button",{onClick:()=>{a(e.premium)},className:`
                                relative px-3 py-1.5 rounded-lg border text-xs font-mono transition-all
                                flex items-center gap-2
                                ${s?"bg-cyan-500/20 border-cyan-500 text-cyan-300":"bg-zinc-800 border-white/5 text-zinc-400 hover:border-white/20 hover:text-zinc-200"}
                            `,children:[(0,r.jsxs)("span",{className:"text-base font-bold",children:[e.premium>0?"+":"",e.premium]}),(0,r.jsx)("span",{className:"opacity-50",children:"萬/坪"}),(0,r.jsxs)("span",{className:"ml-1 bg-black/20 px-1.5 rounded text-[10px]",children:[e.count," 組"]}),s&&(0,r.jsx)(v.A,{className:"w-3 h-3 text-green-400"})]},e.premium)}),i&&(0,r.jsxs)("div",{className:"flex items-center gap-2 px-3 py-1.5 rounded-lg border border-white/10 bg-zinc-900/60 text-xs text-zinc-300",children:[(0,r.jsx)("span",{className:"text-[10px] text-zinc-500",children:"手動"}),(0,r.jsx)("input",{type:"text",inputMode:"decimal",value:d,onChange:e=>x(e.target.value),onBlur:()=>{let e=Number(d);Number.isNaN(e)||i(Math.max(0,e))},onKeyDown:e=>{if("Enter"===e.key){let t=Number(d);Number.isNaN(t)||(i(Math.max(0,t)),e.target.blur())}},className:"w-16 bg-transparent text-right pr-1 outline-none text-zinc-200"}),(0,r.jsx)("span",{className:"text-[10px] text-violet-300",children:"萬/坪"})]}),A&&(0,r.jsx)("button",{onClick:()=>o(e=>!e),className:"px-3 py-1.5 rounded-lg border border-white/10 bg-zinc-800 text-[10px] text-zinc-400 hover:text-zinc-200 hover:border-white/30 transition",children:c?"收合標籤":"顯示全部"})]}),(0,r.jsx)(b.N,{children:M&&(0,r.jsx)(j.P.div,{initial:{opacity:0,height:0},animate:{opacity:1,height:"auto"},exit:{opacity:0,height:0},className:"overflow-hidden",children:(0,r.jsxs)("div",{className:"border-t border-white/10 pt-4 mt-2",children:[(0,r.jsxs)("div",{className:"flex justify-between items-end mb-3",children:[(0,r.jsxs)("div",{className:"text-xs text-zinc-400",children:[(0,r.jsx)("span",{className:"text-cyan-400 font-bold",children:M.count})," 組對比符合此規律。 點擊右側明細可連動網格顯示。"]}),(0,r.jsx)("div",{className:"text-[10px] text-zinc-500",children:"點擊上方標籤即可套用"})]}),(0,r.jsxs)("div",{className:"flex flex-col xl:flex-row gap-4 items-stretch",children:[(0,r.jsx)("div",{ref:h,className:"flex-1 bg-black/40 rounded border border-white/5 p-2 overflow-hidden relative",style:{height:u},children:(0,r.jsxs)("div",{className:"w-full",children:[(0,r.jsxs)("div",{className:"flex",children:[(0,r.jsx)("div",{className:"shrink-0",style:{width:32}}),C.sortedStacks.map(e=>(0,r.jsx)("div",{className:"text-center text-[10px] text-zinc-500 pb-1",style:{width:C.cellSize},children:e},e))]}),C.sortedFloors.map(e=>(0,r.jsxs)("div",{className:"flex items-center relative z-10",style:{height:C.cellSize},children:[(0,r.jsxs)("div",{className:"shrink-0 text-right text-[10px] text-zinc-600 pr-2",style:{width:32},children:[e,"F"]}),C.sortedStacks.map(t=>{let a=`${t}-${e}`,s=C.highlightedCells.has(a),i=_&&_.stack===t&&(e===_.floorLow||e===_.floorHigh),n=M.pairs.some(a=>a.stack===t&&e>a.floorLow&&e<a.floorHigh),l=_&&_.stack===t&&e>_.floorLow&&e<_.floorHigh;return(0,r.jsxs)("div",{className:"h-full flex items-center justify-center p-0.5 relative",style:{width:C.cellSize},children:[n&&(0,r.jsx)("div",{className:`
                                                                    absolute w-0.5 h-[140%] top-[-20%] transition-colors duration-200
                                                                    ${l?"bg-yellow-400 z-20":"bg-cyan-500/20"}
                                                                `}),(0,r.jsx)("div",{className:`
                                                                    w-full h-full rounded-sm transition-all duration-200 relative z-10
                                                                    ${i?"bg-yellow-400 shadow-[0_0_12px_rgba(250,204,21,0.8)] scale-100 ring-2 ring-white/50 z-30":s?"bg-cyan-500 shadow-[0_0_8px_rgba(6,182,212,0.6)] scale-90":"bg-zinc-800/30"}
                                                                `})]},a)})]},e))]})}),(0,r.jsxs)("div",{className:"w-full xl:w-[380px] flex flex-col gap-2",style:{height:u},children:[(0,r.jsxs)("div",{className:"text-[10px] uppercase tracking-wider text-zinc-500 font-bold mb-1",children:["對比明細 (共 ",M.pairs.length," 組)"]}),(0,r.jsx)("div",{className:"flex flex-col gap-2 overflow-y-auto pr-2 custom-scrollbar",style:{maxHeight:w},children:M.pairs.map((e,t)=>(0,r.jsxs)("div",{onMouseEnter:()=>l(t),onMouseLeave:()=>l(null),className:`
                                                    border rounded-lg p-2 flex items-center justify-between group transition-all cursor-crosshair
                                                    ${n===t?"bg-yellow-400/10 border-yellow-400/50 translate-x-1":"bg-white/5 border-white/5 hover:border-white/20"}
                                                `,children:[(0,r.jsxs)("div",{className:"flex items-center gap-3",children:[(0,r.jsx)("div",{className:`
                                                        w-8 h-8 rounded flex items-center justify-center font-bold text-xs border transition-colors
                                                        ${n===t?"bg-yellow-400/20 text-yellow-400 border-yellow-400/30":"bg-cyan-500/10 text-cyan-400 border-cyan-500/20"}
                                                    `,children:e.stack}),(0,r.jsxs)("div",{className:"flex flex-col",children:[(0,r.jsxs)("div",{className:"flex items-center gap-1.5 leading-none",children:[(0,r.jsxs)("span",{className:"text-xs text-zinc-300",children:[e.floorLow,"F"]}),(0,r.jsx)(N.A,{className:`w-3 h-3 ${n===t?"text-yellow-400":"text-zinc-600"}`}),(0,r.jsxs)("span",{className:"text-xs text-zinc-100 font-bold",children:[e.floorHigh,"F"]})]}),(0,r.jsxs)("div",{className:"text-[10px] text-zinc-500 mt-1 flex gap-1 items-center",children:[(0,r.jsx)("span",{className:"opacity-70",children:e.dateLow||"N/A"}),(0,r.jsx)("span",{className:"opacity-30",children:"|"}),(0,r.jsx)("span",{className:"opacity-70",children:e.dateHigh||"N/A"})]})]})]}),(0,r.jsxs)("div",{className:"text-right",children:[(0,r.jsxs)("div",{className:"text-xs font-mono text-zinc-200",children:[e.priceLow,(0,r.jsx)("span",{className:"text-[10px] opacity-40 mx-1",children:"→"}),e.priceHigh]}),(0,r.jsxs)("div",{className:`text-[10px] font-bold ${n===t?"text-yellow-400":"text-cyan-400/80"}`,children:["+",e.diff," 萬/層"]})]})]},t))})]})]})]})})})]})}var z=a(13545);class k extends s.Component{static getDerivedStateFromError(e){return{hasError:!0,error:e,errorInfo:null}}componentDidCatch(e,t){console.error("Uncaught error:",e,t),this.setState({error:e,errorInfo:t})}render(){return this.state.hasError?(0,r.jsxs)("div",{className:"p-6 bg-red-950/20 border border-red-500/30 rounded-lg flex flex-col items-center justify-center text-center gap-4 min-h-[200px]",children:[(0,r.jsx)("div",{className:"bg-red-500/10 p-3 rounded-full",children:(0,r.jsx)(z.A,{className:"w-8 h-8 text-red-400"})}),(0,r.jsxs)("div",{children:[(0,r.jsx)("h2",{className:"text-lg font-bold text-red-200 mb-1",children:this.props.fallbackTitle||"Something went wrong"}),this.props.componentName&&(0,r.jsxs)("p",{className:"text-xs text-red-400/80 font-mono mb-2",children:["Component: ",this.props.componentName]}),(0,r.jsx)("div",{className:"max-w-md bg-black/50 p-3 rounded text-left overflow-auto max-h-[150px] border border-red-500/20",children:(0,r.jsx)("p",{className:"text-xs font-mono text-red-300 break-all",children:this.state.error?.toString()})}),(0,r.jsx)("button",{className:"mt-4 px-4 py-2 bg-red-900/40 hover:bg-red-900/60 text-red-200 text-xs rounded transition-colors",onClick:()=>this.setState({hasError:!1,error:null,errorInfo:null}),children:"Try to Recover"})]})]}):this.props.children}constructor(...e){super(...e),this.state={hasError:!1,error:null,errorInfo:null}}}var S=a(29991),P=a(60529),M=a(89239),A=a(37618),C=a(61878),_=a(56722);let $=e=>{let t=String(e?.["樓層"]||e?.floor||e?.layer||""),a="1"===t||"001"===t||t.includes("一樓"),r=e?.["建物型態"]||e?.buildingType||"",s=e?.["主要用途"]||e?.mainPurpose||"",i=e?.["備註"]||e?.note||"",n=r.includes("店")||e.buildingType?.includes("店")||"商業用"===s||"商業用"===e.mainPurpose||i.includes("店")||e.note?.includes("店"),l=r.includes("辦公")||e.buildingType?.includes("辦公")||r.includes("廠辦")||e.buildingType?.includes("廠辦")||r.includes("事務所")||e.buildingType?.includes("事務所")||s.includes("辦公")||e.mainPurpose?.includes("辦公")||s.includes("事務所")||e.mainPurpose?.includes("事務所")||i.includes("辦公")||i.includes("事務所")||e.note?.includes("辦公")||e.note?.includes("事務所");return{buildingType:r,mainPurpose:s,note:i,isStorefront:n&&a,isOffice:l||n&&!a}},F=e=>{let{note:t,isStorefront:a,isOffice:r}=$(e),s=t.includes("親友")||t.includes("員工")||t.includes("關係人")||t.includes("關係戶")||t.includes("員工關係");return{note:t,isStorefront:a,isOffice:r,isEmployeeRelated:s}};var E=a(88743),R=a(27529),T=a(55873),I=a(98883),L=a(89733);function D({transactions:e,project:t}){let[a,i]=(0,s.useState)(""),[n,l]=(0,s.useState)(""),[c,o]=(0,s.useState)(null),[d,x]=(0,s.useState)(!1),[h,m]=(0,s.useState)(null),p=e=>{if(null==e)return null;if("number"==typeof e&&Number.isFinite(e))return e;let t=String(e).trim();if(!t||t.startsWith("B")||t.includes("地下")||t.includes("負"))return null;let a=t.match(/-?\d+/);if(!a)return null;let r=parseInt(a[0],10);return!Number.isFinite(r)||r<=0?null:r};(0,s.useEffect)(()=>{i(""),l(""),o(null)},[t]),(0,s.useEffect)(()=>{let e=()=>{x(!1),m(null)};return window.addEventListener("pointerup",e),()=>window.removeEventListener("pointerup",e)},[]);let u=s.useMemo(()=>{if(!e||0===e.length)return[];let t=0;return(e.forEach(e=>{let a=p(e["樓層"]);a&&a>t&&(t=a)}),t)?Array.from({length:t},(e,t)=>t+1):[]},[e]),g=s.useMemo(()=>{let e=parseInt(a,10),t=parseInt(n,10);return Number.isFinite(e)&&Number.isFinite(t)?{start:Math.min(e,t),end:Math.max(e,t)}:null},[a,n]),f=s.useCallback(a=>{if(!t||!e||!a)return void o(null);let r=e.filter(e=>{let t=p(e["樓層"]);return!!t&&t>=a.start&&t<=a.end});if(0===r.length)return void o({avg:0,count:0});let s=r.reduce((e,t)=>e+(t["房屋總價(萬)"]||0),0),i=r.reduce((e,t)=>e+(t["房屋面積(坪)"]||0),0);o({avg:i>0?s/i:0,count:r.length})},[t,e]);(0,s.useEffect)(()=>{f(g)},[g,f]);let b=(e,t)=>{let a=Math.min(e,t),r=Math.max(e,t);i(String(a)),l(String(r))};return(0,r.jsxs)("div",{className:"flex flex-col gap-3 bg-zinc-900/30 p-4 rounded-lg border border-white/5",children:[(0,r.jsxs)("div",{className:"flex flex-col sm:flex-row items-start sm:items-center gap-2 w-full sm:w-auto",children:[(0,r.jsx)("span",{className:"text-sm text-zinc-400 font-semibold whitespace-nowrap",children:"區間均價試算:"}),(0,r.jsxs)("div",{className:"flex items-center gap-2",children:[(0,r.jsx)(P.p,{type:"number",placeholder:"起樓",className:"w-20 h-8 bg-zinc-950/50",value:a,onChange:e=>i(e.target.value)}),(0,r.jsx)("span",{className:"text-zinc-500",children:"~"}),(0,r.jsx)(P.p,{type:"number",placeholder:"迄樓",className:"w-20 h-8 bg-zinc-950/50",value:n,onChange:e=>l(e.target.value)})]}),(0,r.jsx)(M.$,{size:"sm",variant:"secondary",onClick:()=>f(g),className:"h-8 ml-2",children:"計算"})]}),u.length>0&&(0,r.jsxs)("div",{className:"flex flex-col gap-2",children:[(0,r.jsx)("div",{className:"flex flex-wrap gap-2",children:u.map(e=>{let t=!!g&&e>=g.start&&e<=g.end,a=!!g&&(e===g.start||e===g.end);return(0,r.jsx)("button",{type:"button",onPointerDown:()=>{x(!0),m(e),b(e,e)},onPointerEnter:()=>{d&&null!==h&&b(h,e)},className:`h-9 w-9 rounded-md border text-xs font-semibold transition ${t?a?"border-violet-400 bg-violet-500/25 text-violet-200 shadow-[0_0_12px_rgba(139,92,246,0.35)]":"border-violet-500/40 bg-violet-500/15 text-violet-300":"border-white/10 bg-zinc-950/50 text-zinc-400 hover:border-white/30 hover:text-zinc-200"}`,children:e},`floor-${e}`)})}),(0,r.jsx)("span",{className:"text-[11px] text-zinc-500",children:"可點選或拖曳選取樓層範圍"})]}),c&&(0,r.jsxs)("div",{className:"flex flex-wrap items-center gap-4 animate-in fade-in",children:[(0,r.jsxs)("div",{className:"flex flex-col",children:[(0,r.jsx)("span",{className:"text-xs text-zinc-500",children:"平均單價 (加權)"}),(0,r.jsxs)("span",{className:"text-lg font-bold text-violet-400",children:[c.avg.toFixed(2)," 萬/坪"]})]}),(0,r.jsxs)("div",{className:"flex flex-col",children:[(0,r.jsx)("span",{className:"text-xs text-zinc-500",children:"參考筆數"}),(0,r.jsxs)("span",{className:"text-sm text-zinc-300",children:[c.count," 筆"]})]})]})]})}function O({data:e,visibleSections:t=["grid","stats","comparison"]}){let[a,n]=(0,s.useState)(""),[l,c]=(0,s.useState)(!1),[o,d]=(0,s.useState)(.3),[x,h]=(0,s.useState)(14),[m,p]=(0,s.useState)(!1),[u,b]=(0,s.useState)(!1),j=(0,E.P)(e=>e.excludeCommercial),{counties:y,districts:v,transactionType:N,buildingType:z,dateRange:M,startDate:O,endDate:B}=(0,E.P)(),[W,U]=(0,s.useState)(null),[H,q]=(0,s.useState)(!1),Y=s.useRef(null),Z=s.useRef(null),V=s.useRef(null);if((0,s.useEffect)(()=>{!l&&e?.priceGridAnalysis?.projectNames?.length&&!a&&n(e.priceGridAnalysis.projectNames[0])},[e,a,l]),!e?.priceGridAnalysis)return null;let{projectNames:G,byProject:J}=e.priceGridAnalysis,X=t.includes("grid"),K=t.includes("stats"),Q=t.includes("comparison"),ee=e=>String(e??"").normalize("NFKC").replace(/\s+/g,"").trim().toLowerCase(),et=s.useMemo(()=>{if(!a||!e.transactionDetails)return null;let t=ee(a);return t?e.transactionDetails.filter(e=>ee(e["建案名稱"])===t):null},[a,e.transactionDetails]);(0,s.useEffect)(()=>{let e=!0;return(async()=>{if(!a||et&&et.length>0)return U(null);let t=y.map(e=>T.WG[e]||e).filter(Boolean);if(0===t.length)return;let r=O,s=B;if("custom"!==M&&(!r||!s)){let e=(0,I.P)(M);r=e.startDate||r,s=e.endDate||s}q(!0);try{let i=[];for(let n of t){let t=1,l=1/0;for(;i.length<l;){let c=await R.FH.fetchData({countyCode:n,districts:v,type:N,transactionType:N,projectNames:[a],buildingType:z,dateStart:r,dateEnd:s},{page:t,pageSize:1e3,totalRecords:0});if(!e)return;let o=c?.data||[],d="number"==typeof c?.count?c.count:null;if(i.push(...o),null!==d&&(l=d),o.length<1e3||null!==d&&i.length>=d||(t+=1)>20)break}}e&&U(i)}catch(t){console.warn("Fetch project transactions failed:",t),e&&U([])}finally{e&&q(!1)}})(),()=>{e=!1}},[a,et,y,v,N,z,M,O,B]);let ea=et&&et.length>0?et:W,er=s.useMemo(()=>{if(!ea||0===ea.length)return{hasOffice:!1,hasResidential:!1,isMixed:!1};let e=ea.reduce((e,t)=>{let{isStorefront:a,isOffice:r}=$(t);return r&&(e.hasOffice=!0),r||a||(e.hasResidential=!0),e},{hasOffice:!1,hasResidential:!1});return{...e,isMixed:e.hasOffice&&e.hasResidential}},[ea]),es=s.useMemo(()=>!!ea&&0!==ea.length&&ea.some(e=>{let t=e["備註"]||e.note||"";return t.includes("親友")||t.includes("員工")||t.includes("關係人")||t.includes("關係戶")||t.includes("員工關係")}),[ea]);(0,s.useEffect)(()=>{a&&p(!er.isMixed&&er.hasOffice)},[a,er.isMixed,er.hasOffice]),(0,s.useEffect)(()=>{a&&b(!1)},[a]);let ei=s.useMemo(()=>{if(!ea)return null;let e=ea;return j&&(e=e.filter(e=>{let{isStorefront:t,isOffice:a}=$(e);return!t&&!a})),e},[ea,j]),en=!j&&m,el=s.useMemo(()=>{if(!a)return null;if(ei&&ei.length>0)try{return function(e,t=.3,a=14,r={}){let s=e.reduce((e,t)=>{let{isStorefront:a,isOffice:r}=$(t);return r&&(e.hasOffice=!0),r||a||(e.hasResidential=!0),e},{hasOffice:!1,hasResidential:!1}),i=!(s.hasOffice&&s.hasResidential)&&s.hasOffice,n="boolean"==typeof r.includeOfficePremium?r.includeOfficePremium:i,l="boolean"==typeof r.includeStorefrontPremium&&r.includeStorefrontPremium,c="boolean"==typeof r.includeEmployeePremium&&r.includeEmployeePremium,o=e=>{let{isStorefront:t,isOffice:a,isEmployeeRelated:r}=F(e);return(!!l||!t)&&(!!n||!a)&&(!!c||!r)},d={},x=new Set,h=new Set,m=new f.B$(e);if(e.forEach(e=>{let t=e["樓層"]||e.floor||e.layer;if(null==t)return;"number"==typeof t&&(t=String(t)),"number"==typeof t&&(t=String(t));let a=(0,_.n)(e,m);x.add(t),h.add(a),d[t]||(d[t]={}),d[t][a]||(d[t][a]=[]);let r=parseFloat(e["房屋單價(萬)"]||e.unitPrice||0),s=parseFloat(e["交易總價(萬)"]||e.totalPrice||0),i=parseFloat(e["房屋總價(萬)"]||e.housePrice||0),n=parseFloat(e["車位總價(萬)"]||e.parkingPrice||0),l=parseFloat(e["房屋面積(坪)"]||e.houseArea||0),c=e["房數"]||e.rooms,o=e["車位類別"]||e.parkingType||"";"string"==typeof o&&o.includes("車位");let{note:p,isStorefront:u,isOffice:g,isEmployeeRelated:f}=F(e),b=e["交易日"]||e["交易年月日"]||e.transactionDate||"",j=b;if(b&&/^\d{6,7}$/.test(String(b))){let e=String(b),t=6===e.length?2:3;j=`${e.substring(0,t)}/${e.substring(t,t+2)}/${e.substring(t+2)}`}d[t][a].push({...e,unitPrice:r,floor:t,unit:a,transactionDate:j,remark:p,isStorefront:u,isOffice:g,isEmployeeRelated:f,hasParking:n>0,tooltipInfo:{totalPrice:s,housePrice:i,parkingPrice:n,houseArea:l,rooms:c}})}),0===x.size)return{horizontalGrid:{},sortedFloors:[],sortedUnits:[],unitColorMap:{},summary:{totalBaselineHousePrice:0,totalPricePremiumValue:0,totalSoldArea:0,transactionCount:0,calculationFlags:{includesOfficePremium:n,includesStorefrontPremium:l,includesEmployeePremium:c}},horizontalComparison:[]};let p=Array.from(x).sort((e,t)=>{let a=e=>e?e.startsWith("B")?-parseInt(e.substring(1)):parseInt(e)||0:0;return a(t)-a(e)}),u=e=>{let t=String(e||"").trim().toUpperCase(),a=t.match(/^([A-Z]+)(\d+)?$/);return a?{alpha:a[1]||"",num:a[2]?parseInt(a[2],10):Number.MAX_SAFE_INTEGER,raw:t}:{alpha:t,num:Number.MAX_SAFE_INTEGER,raw:t}},g=Array.from(h).sort((e,t)=>{let a=u(e),r=u(t),s=a.alpha.localeCompare(r.alpha,"en");return 0!==s?s:a.num!==r.num?a.num-r.num:a.raw.localeCompare(r.raw,"en")}),b={},j=e=>{if(!e)return null;let t=e.replace(/\//g,"");if(t.length<6)return null;let a=6===t.length?2:3,r=parseInt(t.substring(0,a)),s=parseInt(t.substring(a,a+2));return new Date(1911+r,s-1,parseInt(t.substring(a+2)))},y={};e.forEach(e=>{let t=(0,_.n)(e,m),{note:a}=F(e),r=parseFloat(e["房屋單價(萬)"]||e.unitPrice||0);!(!o(e)||a.includes("特殊")||a.includes("毛胚"))&&r>0&&(y[t]||(y[t]=[]),y[t].push(e))}),Object.keys(y).forEach(e=>{let r=y[e];if(r.sort((e,t)=>(j(e["交易年月日"]||e.transactionDate)?.getTime()||0x9184e729fff)-(j(t["交易年月日"]||t.transactionDate)?.getTime()||0x9184e729fff)),0===r.length)return;let s=j(r[0]["交易年月日"]||r[0].transactionDate);if(!s){b[e]=r.reduce((e,t)=>parseFloat(t["房屋單價(萬)"])<parseFloat(e["房屋單價(萬)"])?t:e,r[0]);return}let i=new Date(s);i.setDate(i.getDate()+a);let n=r.filter(e=>{let t=j(e["交易年月日"]||e.transactionDate);return t&&t<=i}),l=n[0]||r[0],c=1/0;n.forEach(e=>{let a,r=parseFloat(e["房屋單價(萬)"]||0)-((a=String(e["樓層"]))?a.startsWith("B")?-parseInt(a.substring(1)):parseInt(a):0)*t;r<c&&(c=r,l=e)}),b[e]=l});let v=0,N=0,w=0,z=0;Object.keys(d).forEach(e=>{Object.keys(d[e]).forEach(a=>{d[e][a].forEach((r,s)=>{let i=null,n=b[a];if(n&&o(r)){let l=e=>e?e.startsWith("B")?-parseInt(e.substring(1)):parseInt(e):0,c=String(n["樓層"]),o=String(r.floor),x=l(c),h=l(o),m=parseFloat(n["房屋單價(萬)"]||n.unitPrice||0)+(h-x)*t;if(m>0&&(i=(r["房屋單價(萬)"]-m)/m*100,(r===n||.1>Math.abs(r["房屋單價(萬)"]-m))&&(i=0)),r.tooltipInfo.housePrice&&r.tooltipInfo.houseArea){let e=m*r.tooltipInfo.houseArea;v+=e,N+=r.tooltipInfo.housePrice-e,w+=r.tooltipInfo.houseArea,z++}d[e][a][s].theoreticalPrice=m}else i=null,d[e][a][s].theoreticalPrice=null;d[e][a][s].premium=i})})});let k={},S=["#f87171","#fb923c","#fbbf24","#a3e635","#34d399","#22d3ee","#818cf8","#c084fc","#f472b6"];g.forEach((e,t)=>{k[e]=S[t%S.length]});let P={};g.forEach(e=>{P[e]={totalOriginalPriceValue:0,totalActualPriceValue:0,totalSoldArea:0,count:0,anchorPrice:null,anchorFloor:null};let t=b[e];t&&(P[e].anchorPrice=parseFloat(t["房屋單價(萬)"]||0),P[e].anchorFloor=String(t["樓層"]))}),Object.keys(d).forEach(e=>{Object.keys(d[e]).forEach(a=>{d[e][a].forEach(e=>{let r=b[a];if(o(e)&&e.tooltipInfo.houseArea&&r){let s=e=>e?e.startsWith("B")?-parseInt(e.substring(1)):parseInt(e):0,i=s(String(r["樓層"])),n=s(e.floor),l=parseFloat(e["房屋單價(萬)"]||e.unitPrice||0),c=l-(n-i)*t,o=e.tooltipInfo.houseArea;Number.isFinite(c)&&Number.isFinite(l)&&o>0&&P[a]&&(P[a].totalOriginalPriceValue+=c*o,P[a].totalActualPriceValue+=l*o,P[a].totalSoldArea+=o,P[a].count++)}})})});let M=[],A=[],C=null,E=null,R=1/0,T=1/0;Object.keys(P).forEach(e=>{let t=P[e];if(t.totalSoldArea>0){let a=t.totalOriginalPriceValue/t.totalSoldArea,r=t.totalActualPriceValue/t.totalSoldArea;M.push(a),A.push(r),a<R&&(R=a,C=e),r<T&&(T=r,E=e)}});let I=M.length?Math.min(...M):0,L=A.length?Math.min(...A):0,D=Object.keys(P).map(e=>{let t=P[e];if(0===t.count||0===t.totalSoldArea)return null;let a=t.totalOriginalPriceValue/t.totalSoldArea,r=t.totalActualPriceValue/t.totalSoldArea,s=r-a,i=s*t.totalSoldArea;return{unitType:e,anchorInfo:t.anchorPrice?`${t.anchorFloor}F / ${t.anchorPrice}萬`:"N/A",originalHorizontalDiff:a-I,actualHorizontalDiff:r-L,unitsSold:t.count,totalSoldArea:t.totalSoldArea,originalAvgPrice:a,actualAvgPrice:r,avgPremiumPerPing:s,timePremiumContribution:i}}).filter(Boolean),O=D.reduce((e,t)=>e+(t.timePremiumContribution||0),0);return D.forEach(e=>{e.contributionPercentage=O>0?e.timePremiumContribution/O*100:0}),{horizontalGrid:d,sortedFloors:p,sortedUnits:g,unitColorMap:k,summary:{totalBaselineHousePrice:v,totalPricePremiumValue:N,totalSoldArea:w,transactionCount:z,calculationFlags:{includesOfficePremium:n,includesStorefrontPremium:l,includesEmployeePremium:c}},horizontalComparison:D,comparisonMeta:{originalMinUnit:C,originalMinAvg:Number.isFinite(R)?R:null,actualMinUnit:E,actualMinAvg:Number.isFinite(T)?T:null}}}(ei,o,x,{includeOfficePremium:en,includeEmployeePremium:u})}catch(e){console.error("Heatmap generation error:",e)}return J[a]&&J[a].horizontalGrid?J[a]:null},[a,ei,J,o,x,en,u]),ec=s.useMemo(()=>{let e=el?.summary?.calculationFlags;if(!e)return"排除店舖/辦公室";let t=[];return e.includesStorefrontPremium||t.push("店舖"),e.includesOfficePremium||t.push("辦公室"),e.includesEmployeePremium||t.push("員工關係戶"),t.length?`排除${t.join("/")}`:"全部納入"},[el?.summary?.calculationFlags]);return(0,r.jsxs)("div",{className:"space-y-6 animate-in fade-in slide-in-from-bottom-4 duration-500",children:[(0,r.jsx)("div",{className:"flex flex-col gap-4 bg-zinc-900/30 p-4 rounded-lg border border-white/5","data-report-control":"hide",children:(0,r.jsx)("div",{className:"flex flex-col lg:flex-row flex-wrap items-start lg:items-center gap-4",children:(0,r.jsxs)("div",{className:"flex flex-col sm:flex-row items-start sm:items-center gap-2 w-full lg:w-auto",children:[(0,r.jsxs)("div",{className:"flex items-center gap-2",children:[(0,r.jsx)("span",{className:"text-sm text-zinc-400 whitespace-nowrap",children:"選擇建案:"}),(0,r.jsx)("button",{onClick:()=>c(!l),className:`p-1 rounded transition-colors ${l?"text-violet-400 bg-violet-400/10":"text-zinc-500 hover:text-zinc-300"}`,title:l?"切換回下拉選單":"切換手動輸入",children:(0,r.jsx)(A.A,{className:"w-3.5 h-3.5"})})]}),l?(0,r.jsxs)("div",{className:"relative w-full sm:w-[280px]",children:[(0,r.jsx)(P.p,{value:a,onChange:e=>n(e.target.value),placeholder:"輸入建案名稱...",className:"w-full h-9 bg-zinc-950/50 pl-8 pr-4",list:"project-list",autoComplete:"off"}),(0,r.jsx)(C.A,{className:"absolute left-2.5 top-1/2 -translate-y-1/2 w-4 h-4 text-zinc-500"}),(0,r.jsx)("datalist",{id:"project-list",children:G.map(e=>(0,r.jsx)("option",{value:e},e))})]}):(0,r.jsxs)(S.l,{value:a,onChange:e=>n(e.target.value),className:"w-full sm:w-[280px] bg-zinc-950/50",children:[(0,r.jsx)("option",{value:"",disabled:!0,children:"請選擇建案..."}),G.map(e=>(0,r.jsx)("option",{value:e,children:e},e))]})]})})}),a&&ei&&ei.length>0&&(0,r.jsx)("div",{"data-report-control":"hide",children:(0,r.jsx)(k,{componentName:"FloorDiffAnalyzer",children:(0,r.jsx)(w,{transactions:ei,currentPremium:o,onApply:e=>d(e),onManualChange:e=>d(e)})})}),a&&ei&&ei.length>0&&(0,r.jsx)("div",{"data-report-control":"hide",children:(0,r.jsx)(D,{transactions:ei,project:a})}),(0,r.jsxs)("div",{className:"flex flex-wrap gap-4 p-4 bg-zinc-900/20 rounded-lg border border-white/5",children:[(0,r.jsxs)("div",{className:"flex items-center gap-2",children:[(0,r.jsx)("span",{className:"text-xs text-zinc-500",children:"溢價圖例:"}),(0,r.jsxs)("span",{className:"flex items-center gap-1",children:[(0,r.jsx)("span",{className:"w-4 h-4 rounded bg-red-500/80"}),(0,r.jsx)("span",{className:"text-xs text-zinc-400",children:"> 5%"})]}),(0,r.jsxs)("span",{className:"flex items-center gap-1",children:[(0,r.jsx)("span",{className:"w-4 h-4 rounded bg-orange-500/80"}),(0,r.jsx)("span",{className:"text-xs text-zinc-400",children:"2-5%"})]}),(0,r.jsxs)("span",{className:"flex items-center gap-1",children:[(0,r.jsx)("span",{className:"w-4 h-4 rounded bg-yellow-500/80"}),(0,r.jsx)("span",{className:"text-xs text-zinc-400",children:"0-2%"})]}),(0,r.jsxs)("span",{className:"flex items-center gap-1",children:[(0,r.jsx)("span",{className:"w-4 h-4 rounded bg-green-500/80"}),(0,r.jsx)("span",{className:"text-xs text-zinc-400",children:"< 0%"})]})]}),(0,r.jsx)("div",{className:"ml-auto"})]}),X&&(0,r.jsx)(i.c,{title:"建案銷控表與調價熱力圖",description:"可視化建案各戶別的銷售狀況與價格調整幅度",containerRef:Y,headerAction:(0,r.jsxs)("div",{className:"flex flex-wrap items-center gap-2",children:[!j&&er.hasOffice&&(0,r.jsxs)("div",{className:"flex items-center gap-2",children:[(0,r.jsx)("span",{className:"text-xs text-zinc-400 whitespace-nowrap",children:"事務所/商辦調價"}),(0,r.jsx)("button",{onClick:()=>p(e=>!e),className:`px-2 h-8 rounded border text-[11px] transition ${m?"border-cyan-400 text-cyan-300 bg-cyan-500/10":"border-white/10 text-zinc-400 hover:text-zinc-200 hover:border-white/30"}`,title:m?"已納入事務所/商辦調價":"排除事務所/商辦調價",children:m?"納入":"排除"}),er.isMixed&&(0,r.jsx)("span",{className:"text-[11px] text-zinc-500 whitespace-nowrap",children:"混合用途預設排除"})]}),es&&(0,r.jsxs)("div",{className:"flex items-center gap-2",children:[(0,r.jsx)("span",{className:"text-xs text-zinc-400 whitespace-nowrap",children:"員工關係戶調價"}),(0,r.jsx)("button",{onClick:()=>b(e=>!e),className:`px-2 h-8 rounded border text-[11px] transition ${u?"border-cyan-400 text-cyan-300 bg-cyan-500/10":"border-white/10 text-zinc-400 hover:text-zinc-200 hover:border-white/30"}`,title:u?"已納入員工關係戶調價":"排除員工關係戶調價",children:u?"納入":"排除"})]}),(0,r.jsxs)("div",{className:"flex items-center gap-2 bg-zinc-950/40 border border-white/10 rounded-lg px-2 py-1","data-report-control":"hide",children:[(0,r.jsx)("span",{className:"text-xs text-zinc-400",children:"基準天數"}),(0,r.jsx)(P.p,{type:"number",min:"1",max:"365",value:x,onChange:e=>h(Number(e.target.value)||14),className:"w-16 h-8 bg-zinc-950/50 text-right pr-2"}),(0,r.jsx)("span",{className:"text-xs font-mono text-violet-400 whitespace-nowrap",children:"天"})]}),(0,r.jsx)(L.N,{data:ei||[],filename:`heatmap_grid_${a}`,label:"匯出",chartType:"heatmap-grid",targetRef:Y,snapshotData:{projectData:el,floorPremium:o,selectedProject:a}})]}),children:el?(0,r.jsx)(k,{componentName:"PricingHeatmap (Grid)",children:(0,r.jsx)(g,{data:el,floorPremium:o,showGrid:!0,showSummary:!1,showComparison:!1})}):(0,r.jsx)("div",{className:"text-zinc-500 text-center p-12",children:"請選擇建案以查看銷控表"})}),K&&el?.summary&&(0,r.jsx)(i.c,{title:`調價幅度統計摘要 (${ec})`,containerRef:Z,headerAction:(0,r.jsx)(L.N,{data:[el.summary],filename:`heatmap_stats_${a}`,label:"匯出",chartType:"heatmap-stats",targetRef:Z,snapshotData:{summary:el.summary,selectedProject:a}}),children:(0,r.jsx)(k,{componentName:"PricingHeatmap (Summary)",children:(0,r.jsx)(g,{data:el,showGrid:!1,showSummary:!0,showComparison:!1})})}),Q&&el?.horizontalComparison&&el.horizontalComparison.length>0&&(0,r.jsx)(i.c,{title:"戶型水平價差與溢價貢獻",containerRef:V,headerAction:(0,r.jsx)(L.N,{data:el.horizontalComparison,filename:`heatmap_comparison_${a}`,label:"匯出",chartType:"heatmap-comparison",targetRef:V,snapshotData:{horizontalComparison:el.horizontalComparison,selectedProject:a}}),children:(0,r.jsx)(k,{componentName:"PricingHeatmap (Comparison)",children:(0,r.jsx)(g,{data:el,showGrid:!1,showSummary:!1,showComparison:!0,configProject:a,rawTransactions:ei||void 0})})})]})}},81477:(e,t,a)=>{a.d(t,{BT:()=>o,Wu:()=>d,ZB:()=>c,Zp:()=>n,aR:()=>l});var r=a(95155),s=a(12115),i=a(40980);let n=s.forwardRef(({className:e,...t},a)=>(0,r.jsx)("div",{ref:a,className:(0,i.cn)("glass-panel rounded-xl text-card-foreground",e),...t}));n.displayName="Card";let l=s.forwardRef(({className:e,...t},a)=>(0,r.jsx)("div",{ref:a,className:(0,i.cn)("flex flex-col space-y-1.5 p-6",e),...t}));l.displayName="CardHeader";let c=s.forwardRef(({className:e,...t},a)=>(0,r.jsx)("h3",{ref:a,className:(0,i.cn)("text-lg font-semibold leading-none tracking-tight text-white",e),...t}));c.displayName="CardTitle";let o=s.forwardRef(({className:e,...t},a)=>(0,r.jsx)("p",{ref:a,className:(0,i.cn)("text-sm text-zinc-400",e),...t}));o.displayName="CardDescription";let d=s.forwardRef(({className:e,...t},a)=>(0,r.jsx)("div",{ref:a,className:(0,i.cn)("p-6 pt-0",e),...t}));d.displayName="CardContent",s.forwardRef(({className:e,...t},a)=>(0,r.jsx)("div",{ref:a,className:(0,i.cn)("flex items-center p-6 pt-0",e),...t})).displayName="CardFooter"},85623:(e,t,a)=>{a.d(t,{Q:()=>j});var r=a(95155),s=a(12115),i=a(68605),n=a(97085),l=a(37717);function c({data:e,selectedRooms:t,metric:a,chartId:i}){let c=(0,l.A)(),o=(0,s.useMemo)(()=>({count:{label:"交易筆數",unit:"筆",decimals:0},priceSum:{label:"產權總價",unit:"萬",decimals:0},areaSum:{label:"房屋坪數",unit:"坪",decimals:2}})[a],[a]),d=(0,s.useMemo)(()=>{if(!e||0===t.length)return[];let r=Object.keys(e).sort();return 0===r.length?[]:t.map(t=>({name:t,data:r.map(r=>e[r]?.[t]?.[a]||0)}))},[e,t,a]),x=(0,s.useMemo)(()=>{let t=e?Object.keys(e).sort():[];return{chart:{type:"line",height:350,background:"transparent",toolbar:{show:!1},zoom:{enabled:!1},foreColor:c.text,id:i},colors:c.chartPalette,stroke:{curve:"smooth",width:2},dataLabels:{enabled:!1},xaxis:{categories:t,labels:{style:{colors:c.textMuted}}},yaxis:{title:{text:o.label,style:{color:c.textMuted}},labels:{style:{colors:c.textMuted},formatter:e=>e.toLocaleString("zh-TW",{minimumFractionDigits:0,maximumFractionDigits:0})}},legend:{position:"top",horizontalAlign:"right"},tooltip:{theme:"dark",y:{formatter:e=>`${e.toLocaleString("zh-TW",{minimumFractionDigits:o.decimals,maximumFractionDigits:o.decimals})} ${o.unit}`}},grid:{borderColor:c.grid}}},[e,o,i,c]);return e&&0!==Object.keys(e).length&&0!==t.length?(0,r.jsx)(n.A,{type:"line",series:d,options:x,height:350,className:"w-full"}):(0,r.jsx)("div",{className:"text-zinc-500 text-center p-8",children:"請選擇房型以顯示銷售趨勢"})}function o({data:e,selectedRooms:t,minArea:a,maxArea:i,interval:c,onDataPointClick:o,height:d,chartId:x}){let h=(0,l.A)(),m=(0,s.useMemo)(()=>[{from:0,to:0,color:h.surface||"#27272a",name:"0 戶"},{from:1,to:5,color:"#facc15",name:"1-5 戶"},{from:6,to:20,color:"#fbbf24",name:"6-20 戶"},{from:21,to:50,color:"#f97316",name:"21-50 戶"},{from:51,to:1e4,color:"#dc2626",name:"> 50 戶"}],[h]),{series:p,maxValue:u}=(0,s.useMemo)(()=>{if(!e||0===t.length)return{series:[],maxValue:0};let r=[];for(let e=a;e<i;e+=c){let t=Number.isInteger(c)&&Number.isInteger(a),s=t?e.toFixed(0):e.toFixed(1),i=t?(e+c).toFixed(0):(e+c).toFixed(1);r.push(`${s}-${i}`)}let s=0;return{series:r.map(r=>{let[n,l]=r.split("-").map(parseFloat);return{name:r,data:t.map(t=>{let r=(e[t]||[]).filter(e=>e>=n&&e<l&&e>=a&&e<=i).length;return r>s&&(s=r),r})}}),maxValue:s}},[e,t,a,i,c]),g=(0,s.useMemo)(()=>({chart:{type:"heatmap",height:d||Math.max(400,22*p.length),background:"transparent",toolbar:{show:!1},foreColor:h.text,id:x,events:{dataPointSelection:(e,a,r)=>{if(o){let{seriesIndex:e,dataPointIndex:a}=r,s=r.w.globals.seriesNames[e];o(t[a],s)}}}},plotOptions:{heatmap:{radius:0,useFillColorAsStroke:!0,enableShades:!1,colorScale:{ranges:m}}},dataLabels:{enabled:!0,style:{colors:[({value:e})=>0===e?"transparent":h.text]},formatter:function(e){return 0===e?"":e}},xaxis:{type:"category",categories:t},title:{text:"房型面積分佈熱力圖",align:"center",style:{color:h.text,fontSize:"16px"}},grid:{borderColor:h.grid},tooltip:{theme:"dark",y:{formatter:e=>0===e?"無成交紀錄":`${e} 戶`}}}),[p,t,m,o,h,x,d]);return e&&0!==p.length?(0,r.jsx)(n.A,{type:"heatmap",series:p,options:g,height:g.chart?.height||400,className:"w-full h-full"}):(0,r.jsx)("div",{className:"text-zinc-500 text-center p-8",children:"無面積分佈資料"})}var d=a(40980);function x({data:e,viewType:t,selectedRooms:a}){if(!e||0===Object.keys(e).length)return(0,r.jsx)("div",{className:"text-zinc-500 text-center p-8",children:"無銷售速度資料"});let i=Object.keys(e).sort().reverse();return(0,r.jsx)("div",{className:"overflow-x-auto max-h-[600px] border border-white/5 rounded-lg",children:(0,r.jsxs)("table",{className:"w-full text-sm text-left border-collapse",children:[(0,r.jsxs)("thead",{className:"bg-zinc-900 sticky top-0 z-20 shadow-md",children:[(0,r.jsxs)("tr",{children:[(0,r.jsx)("th",{rowSpan:2,className:"px-4 py-3 sticky left-0 z-30 bg-zinc-900 border-r border-white/10 font-medium text-white min-w-[120px]",children:"時間"}),a.map(e=>(0,r.jsx)("th",{colSpan:3,className:"px-2 py-2 text-center border-l border-white/5 text-zinc-300 font-medium bg-zinc-900/90",children:e},e)),(0,r.jsx)("th",{colSpan:3,className:"px-2 py-2 text-center border-l-2 border-white/10 text-cyan-400 font-bold bg-zinc-900/90",children:"總計"})]}),(0,r.jsxs)("tr",{children:[a.map((e,t)=>(0,r.jsxs)(s.Fragment,{children:[(0,r.jsx)("th",{className:(0,d.cn)("px-2 py-2 text-center text-xs text-zinc-500 font-normal bg-zinc-900/90 border-b border-white/10",0===t&&"border-l border-white/5"),children:"筆數"}),(0,r.jsx)("th",{className:"px-2 py-2 text-center text-xs text-zinc-500 font-normal bg-zinc-900/90 border-b border-white/10",children:"總價(萬)"}),(0,r.jsx)("th",{className:"px-2 py-2 text-center text-xs text-zinc-500 font-normal bg-zinc-900/90 border-b border-white/10",children:"坪數"})]},e)),(0,r.jsx)("th",{className:"px-2 py-2 text-center text-xs text-zinc-400 font-medium bg-zinc-900/90 border-b border-white/10 border-l-2 border-white/10",children:"筆數"}),(0,r.jsx)("th",{className:"px-2 py-2 text-center text-xs text-zinc-400 font-medium bg-zinc-900/90 border-b border-white/10",children:"總價(萬)"}),(0,r.jsx)("th",{className:"px-2 py-2 text-center text-xs text-zinc-400 font-medium bg-zinc-900/90 border-b border-white/10",children:"坪數"})]})]}),(0,r.jsx)("tbody",{className:"divide-y divide-white/5",children:i.map(i=>{let n=e[i]||{},l={count:0,priceSum:0,areaSum:0};return(0,r.jsxs)("tr",{className:"hover:bg-zinc-800/30 transition-colors",children:[(0,r.jsx)("td",{className:"px-4 py-2 sticky left-0 z-10 bg-zinc-950/90 border-r border-white/10 font-mono text-xs text-zinc-400",children:(e=>{if("weekly"===t){let t=e.match(/^(\d{4})-W(\d{1,2})$/);if(t){let a=((e,t)=>{if(!Number.isFinite(e)||!Number.isFinite(t))return"";let a=new Date(Date.UTC(e,0,4)),r=a.getUTCDay()||7,s=new Date(a);s.setUTCDate(a.getUTCDate()-(r-1));let i=new Date(s);i.setUTCDate(s.getUTCDate()+(t-1)*7);let n=new Date(i);n.setUTCDate(i.getUTCDate()+6);let l=`${i.getUTCMonth()+1}/${i.getUTCDate()}`,c=`${n.getUTCMonth()+1}/${n.getUTCDate()}`;return`${l}-${c}`})(parseInt(t[1],10),parseInt(t[2],10));return(0,r.jsxs)("div",{className:"flex flex-col leading-tight text-xs",children:[(0,r.jsx)("span",{children:e}),a&&(0,r.jsx)("span",{className:"text-[9px] text-zinc-500 whitespace-nowrap",children:a})]})}}return e})(i)}),a.map((e,t)=>{let a=n[e];return a?(l.count+=a.count,l.priceSum+=a.priceSum,l.areaSum+=a.areaSum,(0,r.jsxs)(s.Fragment,{children:[(0,r.jsx)("td",{className:(0,d.cn)("px-2 py-2 text-center text-zinc-300",0===t&&"border-l border-white/5"),children:a.count>0?a.count.toLocaleString():"-"}),(0,r.jsx)("td",{className:"px-2 py-2 text-center text-zinc-500 font-mono text-xs",children:a.count>0?(0,d.Z)(a.priceSum,0):"-"}),(0,r.jsx)("td",{className:"px-2 py-2 text-center text-zinc-500 font-mono text-xs",children:a.count>0?(0,d.Z)(a.areaSum,1):"-"})]},e)):(0,r.jsxs)(s.Fragment,{children:[(0,r.jsx)("td",{className:(0,d.cn)("px-2 py-2 text-center text-zinc-700",0===t&&"border-l border-white/5"),children:"-"}),(0,r.jsx)("td",{className:"px-2 py-2 text-center text-zinc-700",children:"-"}),(0,r.jsx)("td",{className:"px-2 py-2 text-center text-zinc-700",children:"-"})]},e)}),(0,r.jsx)("td",{className:"px-2 py-2 text-center font-bold text-cyan-400 border-l-2 border-white/10",children:l.count.toLocaleString()}),(0,r.jsx)("td",{className:"px-2 py-2 text-center font-bold text-zinc-300 font-mono text-xs",children:(0,d.Z)(l.priceSum,0)}),(0,r.jsx)("td",{className:"px-2 py-2 text-center font-bold text-zinc-300 font-mono text-xs",children:(0,d.Z)(l.areaSum,1)})]},i)})})]})})}var h=a(29991),m=a(60529),p=a(89733),u=a(88743),g=a(48551),f=a(39430),b=a(80642);function j({data:e,visibleSections:t=["chart","table","heatmap"],uiSize:a="dashboard"}){let[n,l]=(0,s.useState)("monthly"),[j,y]=(0,s.useState)("count"),v=(0,d.cn)("bg-zinc-950/50","builder"===a?"text-xl h-12":"text-sm h-9"),[N,w]=(0,s.useState)(15),[z,k]=(0,s.useState)(65),[S,P]=(0,s.useState)(5),[M,A]=(0,s.useState)([]),[C,_]=(0,s.useState)(null),{selectedRoomTypes:$,setSelectedRoomTypes:F}=(0,u.P)();if(!e)return null;let{salesVelocityAnalysis:E,areaDistributionAnalysis:R}=e,T=e=>Math.round(e)+"萬",I=s.useRef(null),L=s.useRef(null),D=s.useRef(null),O=s.useRef(null),B=s.useRef(`sales-velocity-${Math.random().toString(36).slice(2,8)}`).current,W=s.useRef(`area-heatmap-${Math.random().toString(36).slice(2,8)}`).current,U=(t,a)=>{I.current&&(I.current.style.width=`${I.current.offsetWidth}px`);let r=0,s=1/0;if(a.includes("<"))s=parseFloat(a.replace("<","").trim());else if(a.includes(">"))r=parseFloat(a.replace(">","").trim());else if(a.includes("-")){let e=a.split("-");r=parseFloat(e[0].trim()),s=parseFloat(e[1].trim())}let i=(e.transactionDetails||[]).filter(e=>{let a=function(e){let t=e=>e?String(e).normalize("NFKC").toUpperCase().replace(/\s+/g,""):"",a=t(e["建物型態"]||e.buildingType),r=t(e["主要用途"]||e.mainPurpose),s=t(e["戶別"]||e.unit),i=void 0!==e["房數"]?e["房數"]:e.rooms,n=void 0!==e["房屋面積(坪)"]?parseFloat(e["房屋面積(坪)"]):parseFloat(e.houseArea||0);if(a.includes("住宅大樓")&&s.includes("S")||s.includes("店舖")||s.includes("店面")||s.includes("店鋪"))return"店舖";if(s.includes("事務所")||s.includes("辦公"))return"辦公/事務所";if(a.includes("店舖")||a.includes("店面")||a.includes("店鋪"))return"店舖";if(a.includes("工廠")||a.includes("倉庫")||a.includes("廠辦"))return"廠辦/工廠";if(r.includes("商業")||a.includes("辦公")||a.includes("事務所"))return"辦公/事務所";if((a.includes("住宅大樓")||a.includes("華廈"))&&0===i){if(n>35)return"毛胚";if(n<=35)return"套房"}if("number"==typeof i&&!isNaN(i)){if(1===i)return"1房";if(2===i)return"2房";if(3===i)return"3房";if(4===i)return"4房";if(i>=5)return"5房以上"}return"其他"}(e),i=parseFloat(e["房屋面積(坪)"]||e.houseArea||(e["建物移轉平方公尺"]?.3025*e["建物移移轉平方公尺"]:0));if(!a)return!1;let n=i>=r&&i<s;return a===t&&n});console.log(`[Heatmap Click] Room: ${t}, Range: ${r}-${s}, Found: ${i.length}`);let n={};i.forEach(e=>{let t=e["建案名稱"]||e.projectName||"未知建案";n[t]||(n[t]=[]),n[t].push(e)});let l=Object.entries(n).map(([e,t])=>{let a=t.map(e=>e["產權總價"]||e["交易總價(萬)"]||e.totalPrice||0).filter(e=>e>0).sort((e,t)=>e-t),r=t.map(e=>e["房屋單價"]||e["房屋單價(萬)"]||e.unitPrice||0).filter(e=>e>0),s=0;if(a.length>0){let e=Math.floor(a.length/2);s=a.length%2!=0?a[e]:(a[e-1]+a[e])/2}return{projectName:e,count:t.length,priceRange:{min:a.length>0?a[0]:0,max:a.length>0?a[a.length-1]:0,median:s},unitPriceRange:{min:r.length>0?Math.min(...r):0,max:r.length>0?Math.max(...r):0},transactions:t.sort((e,t)=>{let a=e["房屋單價"]||e["房屋單價(萬)"]||e.unitPrice||0;return(t["房屋單價"]||t["房屋單價(萬)"]||t.unitPrice||0)-a}),isExpanded:!1}});l.sort((e,t)=>t.unitPriceRange.max-e.unitPriceRange.max),A(l),_({roomType:t,areaRange:a,totalCount:i.length})},H=()=>{I.current&&(I.current.style.width=`${I.current.offsetWidth}px`),_(null)},q=t.includes("chart"),Y=t.includes("table"),Z=t.includes("heatmap"),V=t.includes("heatmap-detail")&&!Z&&!q&&!Y;s.useEffect(()=>{let t,a,r;if(!V||C||!e?.transactionDetails?.length)return;let s=$[0]||u.M[0];s&&U(s,(a=(t=Number.isInteger(S)&&Number.isInteger(N))?N.toFixed(0):N.toFixed(1),r=t?(N+S).toFixed(0):(N+S).toFixed(1),`${a}-${r}`))},[V,C,e?.transactionDetails,$,N,S]);let G=()=>C?(0,r.jsxs)("div",{className:"flex-1 min-w-0 bg-zinc-900/50 border border-white/10 rounded-lg h-full flex flex-col p-4 overflow-hidden",children:[(0,r.jsxs)("div",{className:"flex justify-between items-start mb-4 pb-4 border-b border-white/5",children:[(0,r.jsxs)("div",{children:[(0,r.jsxs)("h4",{className:"text-white font-medium flex items-center gap-2 text-lg",children:[(0,r.jsx)("span",{className:"text-cyan-400",children:C.roomType}),(0,r.jsx)("span",{className:"text-zinc-500",children:"|"}),(0,r.jsxs)("span",{children:[C.areaRange," 坪"]})]}),(0,r.jsxs)("p",{className:"text-zinc-400 text-xs mt-1",children:["共找到 ",(0,r.jsx)("span",{className:"text-white font-mono",children:M.length})," 個建案",(0,r.jsx)("br",{}),"合計 ",(0,r.jsx)("span",{className:"text-white font-mono",children:C.totalCount})," 筆交易"]})]}),(0,r.jsxs)("div",{className:"flex gap-2 items-center",children:[(0,r.jsxs)("div",{className:"flex gap-1 mr-2",children:[(0,r.jsx)(p.N,{data:M,filename:`heatmap_aggregated_${C.roomType}_${C.areaRange}`,label:"統計",chartType:"sales-heatmap-detail",snapshotData:M,className:"whitespace-nowrap px-3 py-1 text-xs h-7 min-w-0"}),(0,r.jsx)(p.N,{data:M.flatMap(e=>e.transactions),filename:`heatmap_details_${C.roomType}_${C.areaRange}`,label:"明細",className:"whitespace-nowrap px-3 py-1 text-xs h-7 min-w-0"})]}),!V&&(0,r.jsxs)(r.Fragment,{children:[(0,r.jsx)("div",{className:"w-px h-4 bg-white/10 mx-1"}),(0,r.jsx)("button",{onClick:H,className:"text-zinc-400 hover:text-white p-1 hover:bg-zinc-800 rounded transition-colors",children:(0,r.jsxs)("svg",{xmlns:"http://www.w3.org/2000/svg",width:"20",height:"20",viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:"2",strokeLinecap:"round",strokeLinejoin:"round",children:[(0,r.jsx)("path",{d:"M18 6 6 18"}),(0,r.jsx)("path",{d:"m6 6 12 12"})]})})]})]})]}),M.length>0?(0,r.jsx)("div",{className:"flex-1 overflow-y-auto custom-scrollbar pr-1 -mr-1",children:(0,r.jsx)("div",{className:"space-y-3",children:M.map((e,t)=>(0,r.jsxs)("div",{className:"bg-zinc-950/30 rounded border border-white/5 overflow-hidden",children:[(0,r.jsxs)("div",{className:(0,d.cn)("p-3 cursor-pointer transition-colors flex justify-between items-center",e.isExpanded?"bg-zinc-800/80":"hover:bg-zinc-800/40"),onClick:()=>{A(e=>e.map((e,a)=>a===t?{...e,isExpanded:!e.isExpanded}:e))},children:[(0,r.jsxs)("div",{className:"flex items-center gap-2",children:[(0,r.jsx)("div",{className:(0,d.cn)("w-4 h-4 rounded-full bg-zinc-800 flex items-center justify-center text-[10px] text-zinc-400 transition-transform duration-200",e.isExpanded?"rotate-90 bg-violet-500/20 text-violet-300":""),children:"▶"}),(0,r.jsx)("span",{className:"font-medium text-sm text-zinc-200",children:e.projectName}),(0,r.jsxs)("span",{className:"px-1.5 py-0.5 rounded text-[10px] bg-zinc-800 text-zinc-400 border border-white/5",children:[e.count,"戶"]})]}),(0,r.jsx)("div",{className:"text-right",children:(0,r.jsxs)("div",{className:"text-xs font-mono text-cyan-400",children:[e.unitPriceRange.min===e.unitPriceRange.max?e.unitPriceRange.min.toFixed(1):`${e.unitPriceRange.min.toFixed(1)}~${e.unitPriceRange.max.toFixed(1)}`," ",(0,r.jsx)("span",{className:"text-zinc-500 text-[10px]",children:"萬/坪"})]})})]}),e.isExpanded&&(0,r.jsxs)("div",{className:"p-3 bg-black/20 border-t border-white/5",children:[(0,r.jsxs)("div",{className:"grid grid-cols-2 gap-x-4 gap-y-2 text-xs mb-3 text-zinc-400",children:[(0,r.jsxs)("div",{className:"flex justify-between border-b border-white/5 pb-1",children:[(0,r.jsx)("span",{children:"總價範圍"}),(0,r.jsx)("span",{className:"font-mono text-zinc-300",children:e.priceRange.min===e.priceRange.max?T(e.priceRange.min):`${T(e.priceRange.min)}~${T(e.priceRange.max)}`})]}),(0,r.jsxs)("div",{className:"flex justify-between border-b border-white/5 pb-1",children:[(0,r.jsx)("span",{children:"總價中位數"}),(0,r.jsx)("span",{className:"font-mono text-violet-300",children:T(e.priceRange.median||0)})]})]}),(0,r.jsxs)("div",{className:"space-y-1",children:[(0,r.jsxs)("div",{className:"grid grid-cols-5 text-[10px] text-zinc-500 pb-1 border-b border-white/5",children:[(0,r.jsx)("div",{className:"col-span-1",children:"樓層"}),(0,r.jsx)("div",{className:"col-span-1",children:"坪數"}),(0,r.jsx)("div",{className:"col-span-1 text-right",children:"單價"}),(0,r.jsx)("div",{className:"col-span-2 text-right",children:"總價"})]}),e.transactions.slice(0,e.showAll?void 0:10).map((e,t)=>(0,r.jsxs)("div",{className:"grid grid-cols-5 text-xs py-1 hover:bg-white/5 rounded px-1 -mx-1 transition-colors",children:[(0,r.jsx)("div",{className:"col-span-1 text-zinc-300",children:e["樓層"]||e.floor||"-"}),(0,r.jsx)("div",{className:"col-span-1 text-zinc-400",children:(e["房屋面積(坪)"]||e.houseArea||0).toFixed(1)}),(0,r.jsx)("div",{className:"col-span-1 text-right text-cyan-400",children:(e["房屋單價(萬)"]||e.unitPrice||0).toFixed(0)}),(0,r.jsx)("div",{className:"col-span-2 text-right text-zinc-300 font-mono",children:T(e["交易總價(萬)"]||e.totalPrice||0)})]},t)),e.transactions.length>10&&(0,r.jsx)("button",{onClick:e=>{e.stopPropagation(),A(e=>e.map((e,a)=>a===t?{...e,showAll:!e.showAll}:e))},className:"w-full text-center text-[10px] text-zinc-500 hover:text-cyan-400 py-1.5 mt-1 border-t border-white/5 transition-colors",children:e.showAll?"收合內容":`還有 ${e.transactions.length-10} 筆交易...`})]})]})]},t))})}):(0,r.jsx)("div",{className:"flex-1 flex flex-col items-center justify-center text-zinc-500 border border-dashed border-zinc-800 rounded bg-zinc-900/30",children:(0,r.jsx)("p",{children:"無詳細資料"})})]}):(0,r.jsx)("div",{className:"flex items-center justify-center text-zinc-500 border border-dashed border-zinc-800 rounded bg-zinc-900/30 p-6",children:"無詳細資料"});return V?(0,r.jsx)("div",{className:"space-y-4 animate-in fade-in slide-in-from-bottom-4 duration-500",children:(0,r.jsx)(G,{})}):(0,r.jsxs)("div",{className:"space-y-6 animate-in fade-in slide-in-from-bottom-4 duration-500",children:[(0,r.jsxs)("div",{id:"room-type-filter-anchor","data-report-control":"hide",className:"p-4 bg-zinc-900/30 border border-white/5 rounded-lg flex flex-wrap gap-2 items-center scroll-mt-24",children:[(0,r.jsx)("span",{className:"text-zinc-400 text-sm mr-2",children:"分析房型:"}),u.M.map(e=>(0,r.jsx)("button",{onClick:()=>{F($.includes(e)?$.filter(t=>t!==e):[...$,e])},className:(0,d.cn)("px-3 py-1 text-xs rounded-full border transition-colors",$.includes(e)?"bg-violet-500/20 border-violet-500 text-violet-200":"bg-zinc-800 border-zinc-700 text-zinc-500 hover:bg-zinc-700"),children:e},e))]}),q&&(0,r.jsx)(i.c,{title:"房型銷售速度與趨勢分析",containerRef:L,headerAction:(0,r.jsxs)("div",{className:"flex gap-2",children:[(0,r.jsx)("div",{"data-report-control":"hide",children:(0,r.jsxs)(h.l,{value:n,onChange:e=>l(e.target.value),className:v,children:[(0,r.jsx)("option",{value:"weekly",children:"每週"}),(0,r.jsx)("option",{value:"monthly",children:"每月"}),(0,r.jsx)("option",{value:"quarterly",children:"每季"})]})}),(0,r.jsx)("div",{"data-report-control":"hide",children:(0,r.jsxs)(h.l,{value:j,onChange:e=>y(e.target.value),className:v,children:[(0,r.jsx)("option",{value:"count",children:"交易筆數"}),(0,r.jsx)("option",{value:"priceSum",children:"總銷金額"}),(0,r.jsx)("option",{value:"areaSum",children:"總銷坪數"})]})}),(0,r.jsx)(p.N,{data:E?.[n]||[],filename:`sales_velocity_${n}`,label:"匯出",chartType:"sales-velocity-chart",targetRef:L,snapshotData:E?.[n]||[],chartId:B,columns:{period:"時間區間",count:"交易筆數",priceSum:"總銷金額",areaSum:"總銷坪數"}})]}),children:(0,r.jsx)(c,{data:E?.[n]||{},selectedRooms:$,metric:j,chartId:B})}),Y&&(0,r.jsx)(i.c,{title:"銷售速度明細表",description:"各時間段詳細銷售數據統計",containerRef:D,headerAction:(0,r.jsx)(p.N,{data:E?.[n],filename:`sales_velocity_table_${n}`,label:"匯出",chartType:"sales-velocity-table",targetRef:D,snapshotData:E?.[n]||[],columns:{period:"時間區間",count:"交易筆數",priceSum:"總銷金額",areaSum:"總銷坪數"}}),children:(0,r.jsx)(x,{data:E?.[n]||[],viewType:n,selectedRooms:$})}),Z&&(0,r.jsx)(i.c,{title:"房型面積分佈熱力圖",description:"分析不同坪數區間的產品供給與去化分佈",containerRef:O,headerAction:(0,r.jsxs)("div",{className:"flex gap-2 items-center text-zinc-400 text-xs",children:[(0,r.jsxs)("div",{className:"flex gap-2 items-center","data-report-control":"hide",children:[(0,r.jsx)("span",{children:"範圍:"}),(0,r.jsx)(m.p,{type:"number",value:N,onChange:e=>w(Number(e.target.value)),className:"w-16 h-8 text-xs bg-zinc-950/50"}),(0,r.jsx)("span",{children:"-"}),(0,r.jsx)(m.p,{type:"number",value:z,onChange:e=>k(Number(e.target.value)),className:"w-16 h-8 text-xs bg-zinc-950/50"}),(0,r.jsx)("span",{className:"ml-2",children:"級距:"}),(0,r.jsx)(m.p,{type:"number",value:S,onChange:e=>P(Number(e.target.value)),step:"0.5",className:"w-16 h-8 text-xs bg-zinc-950/50"}),(0,r.jsx)("div",{className:"border-l border-white/10 h-4 mx-1"})]}),(0,r.jsx)(p.N,{data:R?Object.entries(R).map(([e,t])=>({key:e,value:JSON.stringify(t)})):[],filename:"area_distribution_heatmap",label:"匯出",chartType:"sales-heatmap",targetRef:O,snapshotData:{distribution:R,selectedRooms:$,min:N,max:z,interval:S},chartId:W,columns:{key:"坪數區間",value:"分佈數據"}})]}),children:(0,r.jsxs)("div",{className:(0,d.cn)("flex flex-col lg:flex-row gap-6 relative overflow-hidden items-stretch transition-all duration-300",C?"lg:h-[600px]":"min-h-[500px]"),children:[(0,r.jsx)(f.P.div,{layout:!0,initial:!1,animate:{flex:C?"0 0 60%":"0 0 100%"},transition:{type:"spring",stiffness:300,damping:35,mass:1},onAnimationStart:()=>{},onAnimationComplete:()=>{I.current&&(I.current.style.width="100%",window.dispatchEvent(new Event("resize")))},className:"min-w-0 overflow-hidden h-full flex flex-col",children:(0,r.jsx)("div",{ref:I,className:"w-full h-full flex flex-col",children:(0,r.jsx)(o,{data:R||{},selectedRooms:$,minArea:N,maxArea:z,interval:S,onDataPointClick:U,height:C?"100%":void 0,chartId:W})})}),(0,r.jsx)(b.N,{mode:"wait",children:C&&(0,r.jsx)(f.P.div,{initial:{opacity:0,x:50,width:0},animate:{opacity:1,x:0,width:"40%"},exit:{opacity:0,x:50,width:0},transition:{type:"spring",stiffness:300,damping:35},className:"min-w-0 h-full flex",children:(0,r.jsx)(G,{})})})]})}),(0,r.jsx)(g.K,{})]})}},89733:(e,t,a)=>{a.d(t,{N:()=>N});var r=a(95155),s=a(98500),i=a.n(s);a(12115);var n=a(73321),l=a(6296),c=a(25777),o=a(6962),d=a(66088),x=a(95057),h=a(89239),m=a(38346),p=a(96066),u=a(70872),g=a(72264),f=a(40980),b=a(62400),j=a(66609),y=a(37717),v=a(98028);function N({data:e,filename:t="export",label:s="匯出",className:N,disabled:w=!1,columns:z,chartType:k,snapshotData:S,targetRef:P,chartId:M}){let{role:A,isLoading:C}=(0,m.h)(),_=(0,n.useRouter)(),$=(0,p.Q)(e=>e.addItem),F=(0,y.A)(),E=["pro","pro_max","admin","super_admin"].includes(A||""),R=!C,T=()=>{if(R&&E){if(!e||0===e.length)return void alert("無數據可導出");try{let a=Object.keys(e[0]),r=[a.map(e=>z&&z[e]||e).join(","),...e.map(e=>a.map(t=>{let a=e[t];if(null==a)return"";if("number"==typeof a){let e=z&&z[t]||t;return/Area|坪|Rate|Ratio|Share|Percent|比|率/.test(t)||/Area|坪|Rate|Ratio|Share|Percent|比|率/.test(e)?a.toFixed(2):Math.round(a).toFixed(0)}if("object"==typeof a)try{return`"${JSON.stringify(a).replace(/"/g,'""')}"`}catch(e){return""}return"string"==typeof a?`"${a.replace(/"/g,'""').replace(/\n/g," ")}"`:a}).join(","))].join("\n"),s=new Blob(["\uFEFF"+r],{type:"text/csv;charset=utf-8;"}),i=URL.createObjectURL(s),n=document.createElement("a"),l=new Date().toISOString().split("T")[0],c=`${t}_${l}.csv`;n.href=i,n.setAttribute("download",c),document.body.appendChild(n),n.click(),document.body.removeChild(n),URL.revokeObjectURL(i)}catch(e){console.error("Export failed:",e),alert("匯出失敗，請查看控制台日誌")}}},I=async()=>{if(E&&P?.current){if(M&&await L(M,P.current,t))return void j.o.success("已成功匯出圖片");try{let e=P.current,a=e.querySelectorAll('[data-export-footer="true"]');a.forEach(e=>{e.style.display="flex"}),await new Promise(e=>{requestAnimationFrame(()=>e())});let r=await (0,v.domToPng)(e,{scale:2,backgroundColor:F.card||F.bg,filter:e=>!(e instanceof HTMLElement&&e.getAttribute("data-html2canvas-ignore"))});a.forEach(e=>{e.style.display="none"});let s=document.createElement("a"),i=new Date().toISOString().split("T")[0];s.href=r,s.download=`${t}_${i}.png`,document.body.appendChild(s),s.click(),document.body.removeChild(s),j.o.success("已成功匯出圖片")}catch(t){console.error("PNG export failed:",t);let e=P.current;e&&e.querySelectorAll('[data-export-footer="true"]').forEach(e=>{e.style.display="none"}),j.o.error("匯出圖片失敗",{description:"請稍後再試或聯繫客服"})}}},L=async(e,t,r)=>{try{let s,{default:i}=await a.e(7776).then(a.bind(a,95338)),n=i.getChartByID(e);if(!n||!n.el)return!1;let l=n.el.querySelector(".apexcharts-canvas"),c=l?.style.backgroundColor;if(l&&(l.style.backgroundColor=F.card||F.bg),"function"==typeof n.dataURI)try{s=await n.dataURI()}catch(t){s=await i.exec(e,"dataURI")}else s=await i.exec(e,"dataURI");l&&(l.style.backgroundColor=c||"");let o=null,d=null;if(s?.blob instanceof Blob&&(d=o=URL.createObjectURL(s.blob)),o||(o=s?.imgURI||s?.imgUri||s?.dataURI),!o)return!1;let x=new Image;x.src=o,await new Promise((e,t)=>{x.onload=()=>e(null),x.onerror=t});let h=window.getComputedStyle(t),m=parseFloat(h.paddingTop||"0")||0,p=parseFloat(h.paddingBottom||"0")||0,u=parseFloat(h.paddingLeft||"0")||0,g=parseFloat(h.paddingRight||"0")||0,f=t.querySelector(":scope > div"),j=f?.querySelector("div"),y=j?.querySelector("h3"),v=j?.querySelector("p"),N=f&&parseFloat(window.getComputedStyle(f).marginBottom||"0")||0,w=y?.textContent?.trim()||"",z=v?.textContent?.trim()||"",k=y?window.getComputedStyle(y):null,S=v?window.getComputedStyle(v):null,P=k&&parseFloat(k.fontSize||"20")||20,M=k&&parseFloat(k.lineHeight||`${1.3*P}`)||1.3*P,A=k?.fontWeight||"700",C=k?.fontFamily||'"Noto Sans TC", "Inter", sans-serif',_=S&&parseFloat(S.fontSize||"13")||13,$=S&&parseFloat(S.lineHeight||`${1.4*_}`)||1.4*_,E=S?.fontWeight||"400",R=S?.fontFamily||'"Noto Sans TC", "Inter", sans-serif',T=w&&z?6:0,I=(w?M:0)+(z?$+T:0),L=x.width,D=Math.max(L+u+g,t.clientWidth||0),O=D-u-g,B=O/L,W=x.height*B,U=m+I+N+W+64+p,H=window.devicePixelRatio||1,q=document.createElement("canvas");q.width=Math.round(D*H),q.height=Math.round(U*H);let Y=q.getContext("2d");if(!Y)return!1;Y.scale(H,H),Y.fillStyle=F.card||F.bg,Y.fillRect(0,0,D,U);let Z=m;Y.textBaseline="top",w&&(Y.font=`${A} ${P}px ${C}`,Y.fillStyle=F.text,Y.textAlign="left",Y.fillText(w,u,Z),Z+=M),z&&(Z+=T,Y.font=`${E} ${_}px ${R}`,Y.fillStyle=F.textMuted,Y.textAlign="left",Y.fillText(z,u,Z),Z+=$),Z+=N,Y.drawImage(x,u,Z,O,W);let V=U-64-p;Y.strokeStyle=F.border,Y.beginPath(),Y.moveTo(0,V),Y.lineTo(D,V),Y.stroke();let G=`搜尋條件：${(0,b.b)()}`,J=D-48;Y.textAlign="center",Y.font=`600 13px ${C}`,Y.fillStyle=F.text,Y.fillText("彙整：平米內參 　來源：內政部實登",D/2,V+18),Y.font=`400 11px ${R}`,Y.fillStyle=F.textMuted;let X=G;for(;Y.measureText(X).width>J&&X.length>4;)X=X.slice(0,-1);X!==G&&(X=`${X.slice(0,-1)}…`),Y.fillText(X,D/2,V+38);let K=q.toDataURL("image/png"),Q=document.createElement("a"),ee=new Date().toISOString().split("T")[0];return Q.href=K,Q.download=`${r}_${ee}.png`,document.body.appendChild(Q),Q.click(),document.body.removeChild(Q),d&&URL.revokeObjectURL(d),!0}catch(e){return console.warn("ApexCharts export failed",e),!1}};return C?(0,r.jsxs)(h.$,{variant:"outline",size:"sm",disabled:!0,"data-report-control":"always-hide",className:`gap-2 border-dashed border-zinc-700 bg-zinc-900/50 text-zinc-600 ${N}`,children:[(0,r.jsx)(l.A,{className:"h-4 w-4 animate-spin"}),(0,r.jsx)("span",{className:"hidden sm:inline",children:"載入中..."})]}):k?(0,r.jsx)(u.Bc,{children:(0,r.jsxs)(u.m_,{delayDuration:0,children:[(0,r.jsx)(u.k$,{asChild:!0,children:(0,r.jsx)("span",{className:"inline-flex",tabIndex:E?-1:0,"data-report-control":"always-hide",children:E?(0,r.jsxs)(g.rI,{children:[(0,r.jsx)(g.ty,{asChild:!0,children:(0,r.jsxs)(h.$,{variant:"outline",size:"sm",disabled:w||!e||0===e.length,className:(0,f.cn)("gap-1.5 border-dashed transition-all border-zinc-700 bg-zinc-900/50 hover:bg-zinc-800 text-zinc-400 hover:text-white",N),children:[(0,r.jsx)(o.A,{className:"h-4 w-4"}),(0,r.jsx)("span",{className:"hidden sm:inline",children:s}),(0,r.jsx)(d.A,{className:"h-3 w-3"})]})}),(0,r.jsxs)(g.SQ,{align:"start",className:"min-w-[180px] bg-zinc-900 border-zinc-700",children:[(0,r.jsxs)(g._2,{onClick:T,className:"flex items-center gap-2 text-zinc-300 hover:text-white focus:text-white cursor-pointer",children:[(0,r.jsx)(o.A,{className:"h-4 w-4 text-zinc-500"}),"匯出 CSV"]}),P&&(0,r.jsxs)(g._2,{onClick:I,className:"flex items-center gap-2 text-zinc-300 hover:text-white focus:text-white cursor-pointer",children:[(0,r.jsx)("div",{className:"h-4 w-4 flex items-center justify-center text-zinc-500 font-bold text-[10px] border border-zinc-600 rounded",children:"P"}),"匯出 PNG (圖片)"]}),(0,r.jsxs)(g._2,{onClick:()=>{E&&k&&($(k,void 0!==S?S:e),j.o.success("已新增至報表編輯器",{description:"請點選左側「生成報告」繼續編輯",action:{label:"前往編輯",onClick:()=>_.push("/reports/builder")}}))},className:"flex items-center gap-2 text-zinc-300 hover:text-violet-300 focus:text-violet-300 hover:bg-violet-600/20 focus:bg-violet-600/20 cursor-pointer",children:[(0,r.jsx)(x.A,{className:"h-4 w-4 text-violet-500"}),"新增到報表編輯器"]})]})]}):(0,r.jsxs)(h.$,{variant:"outline",size:"sm",disabled:!0,className:(0,f.cn)("gap-1.5 border-dashed transition-all border-zinc-800 bg-zinc-900/30 text-zinc-600 cursor-not-allowed hover:bg-zinc-900/30",N),children:[(0,r.jsx)(c.A,{className:"h-3 w-3"}),(0,r.jsx)("span",{className:"hidden sm:inline",children:s})]})})}),!E&&(0,r.jsx)(u.ZI,{className:"bg-zinc-950 border border-zinc-800 p-0 overflow-hidden",children:(0,r.jsxs)("div",{className:"flex flex-col gap-1 items-center p-3",children:[(0,r.jsx)("p",{className:"font-medium text-zinc-200",children:"Pro 會員限定功能"}),(0,r.jsx)(i(),{href:"/pricing",className:"text-xs text-violet-400 hover:text-violet-300 underline underline-offset-2 transition-colors flex items-center gap-1",children:"查看升級方案 →"})]})})]})}):(0,r.jsx)(u.Bc,{children:(0,r.jsxs)(u.m_,{delayDuration:0,children:[(0,r.jsx)(u.k$,{asChild:!0,children:(0,r.jsx)("span",{className:"inline-flex",tabIndex:E?-1:0,"data-report-control":"always-hide",children:(0,r.jsxs)(h.$,{variant:"outline",size:"sm",onClick:T,disabled:w||E&&(!e||0===e.length),className:(0,f.cn)("gap-1.5 border-dashed transition-all",E?"border-zinc-700 bg-zinc-900/50 hover:bg-zinc-800 text-zinc-400 hover:text-white":"border-zinc-800 bg-zinc-900/30 text-zinc-600 cursor-not-allowed hover:bg-zinc-900/30",N),children:[E?(0,r.jsx)(o.A,{className:"h-4 w-4"}):(0,r.jsx)(c.A,{className:"h-3 w-3"}),(0,r.jsx)("span",{className:"hidden sm:inline",children:s})]})})}),!E&&(0,r.jsx)(u.ZI,{className:"bg-zinc-950 border border-zinc-800 p-0 overflow-hidden",children:(0,r.jsxs)("div",{className:"flex flex-col gap-1 items-center p-3",children:[(0,r.jsx)("p",{className:"font-medium text-zinc-200",children:"Pro 會員限定功能"}),(0,r.jsx)(i(),{href:"/pricing",className:"text-xs text-violet-400 hover:text-violet-300 underline underline-offset-2 transition-colors flex items-center gap-1",children:"查看升級方案 →"})]})})]})})}},96066:(e,t,a)=>{a.d(t,{Q:()=>l});var r=a(1934),s=a(31692);let i={"cover-template":{width:900,height:500},"ranking-chart":{width:400,height:300},"ranking-table":{width:600,height:400},"ranking-metrics":{width:600,height:200},"price-band-chart":{width:450,height:280},"price-band-table":{width:600,height:400},"price-band-location-table":{width:600,height:400},"price-band-location-chart":{width:600,height:400},"unit-price-bubble":{width:380,height:320},"unit-price-stats":{width:1e3,height:400},"type-comparison-table":{width:600,height:350},"sales-velocity-chart":{width:420,height:260},"sales-velocity-table":{width:600,height:400},"sales-heatmap":{width:450,height:350},"sales-heatmap-detail":{width:800,height:400},"parking-pie":{width:300,height:300},"parking-price":{width:400,height:300},"parking-scatter":{width:450,height:350},"parking-floor":{width:400,height:400},"parking-floor-detail":{width:900,height:420},"policy-timeline":{width:900,height:500},heatmap:{width:500,height:350},"heatmap-grid":{width:800,height:500},"heatmap-stats":{width:800,height:120},"heatmap-comparison":{width:800,height:300},"data-list":{width:600,height:400},"text-box":{width:280,height:90}},n=e=>({id:`page-${Date.now()}`,name:`第 ${e+1} 頁`,items:[]}),l=(0,r.v)()((0,s.Zr)((e,t)=>({pages:[n(0)],currentPageIndex:0,canvasRatio:"16:9",zoomLevel:100,viewMode:"continuous",selectedIds:[],isDragging:!1,draggedItemCount:0,hoveredPageIndex:null,setViewMode:t=>e({viewMode:t}),setDragging:(t,a=0)=>e({isDragging:t,draggedItemCount:a}),setHoveredPageIndex:t=>e({hoveredPageIndex:t}),get items(){let e=t();return e.pages[e.currentPageIndex]?.items||[]},addPage:()=>{e(e=>{let t=n(e.pages.length);return{pages:[...e.pages,t],currentPageIndex:e.pages.length,selectedIds:[]}})},deletePage:t=>{e(e=>{if(e.pages.length<=1||-1===e.pages.findIndex(e=>e.id===t))return e;let a=e.pages.filter(e=>e.id!==t).map((e,t)=>({...e,name:`第 ${t+1} 頁`})),r=Math.min(e.currentPageIndex,a.length-1);return{pages:a,currentPageIndex:r,selectedIds:[]}})},setCurrentPage:t=>{e(e=>({currentPageIndex:Math.max(0,Math.min(t,e.pages.length-1)),selectedIds:[]}))},renamePage:(t,a)=>{e(e=>({pages:e.pages.map(e=>e.id===t?{...e,name:a}:e)}))},reorderPages:(t,a)=>{e(e=>{if(t===a)return e;let r=[...e.pages],[s]=r.splice(t,1);r.splice(a,0,s);let i=r.map((e,t)=>({...e,name:`第 ${t+1} 頁`})),n=e.currentPageIndex;return e.currentPageIndex===t?n=a:t<e.currentPageIndex&&a>=e.currentPageIndex?n=e.currentPageIndex-1:t>e.currentPageIndex&&a<=e.currentPageIndex&&(n=e.currentPageIndex+1),{pages:i,currentPageIndex:n}})},addItem:(t,a)=>{let r=i[t]||{width:400,height:300};e(e=>{let s=e.pages[e.currentPageIndex];if(!s)return e;let i=20*s.items.length,n="cover-template"===t,l={id:`item-${Date.now()}`,type:t,x:n?0:50+i,y:n?0:50+i,width:r.width,height:r.height,contentBase:{width:r.width,height:r.height},headerLocked:!1,showControls:"text-box"===t,scaleMode:"select",panOffset:{x:0,y:0},contentScale:n||"text-box"===t?1:.5,data:a??(e=>{if("cover-template"===e){let e=new Date,t=e.getFullYear(),a=String(e.getMonth()+1).padStart(2,"0"),r=String(e.getDate()).padStart(2,"0");return{logoText:"平米內參",title:"市場分析報告",subtitle:"價格帶與銷售動能評估",projectName:"請填寫建案名稱",period:"2026 Q1",preparedBy:"平米內參",reportDate:`${t}-${a}-${r}`,searchConditions:[]}}if("text-box"===e)return{html:"<div>請輸入文字或數字</div>",align:"left",verticalAlign:"top",fontSize:20,maxFontSize:20,fontFamily:'"Noto Sans TC", "PingFang TC", "Microsoft JhengHei", system-ui, sans-serif',fontWeight:500,italic:!1,underline:!1,color:"var(--color-text-primary)",autoFit:!1,autoGrow:!0,rotation:0}})(t)};return{pages:e.pages.map((t,a)=>a===e.currentPageIndex?{...t,items:[...t.items,l]}:t),selectedIds:[l.id]}})},addItems:t=>{t.length&&e(e=>e.pages[e.currentPageIndex]?{pages:e.pages.map((a,r)=>r===e.currentPageIndex?{...a,items:[...a.items,...t]}:a),selectedIds:t.map(e=>e.id)}:e)},updateItem:(t,a)=>{e(e=>({pages:e.pages.map((r,s)=>s===e.currentPageIndex?{...r,items:r.items.map(e=>e.id===t?{...e,...a}:e)}:r)}))},removeItem:t=>{e(e=>({pages:e.pages.map((a,r)=>r===e.currentPageIndex?{...a,items:a.items.filter(e=>e.id!==t)}:a),selectedIds:e.selectedIds.filter(e=>e!==t)}))},moveItemToPage:(t,a)=>{e(e=>{let r=e.pages[e.currentPageIndex],s=r?.items.find(e=>e.id===t);return!s||a===e.currentPageIndex||a<0||a>=e.pages.length?e:{pages:e.pages.map((r,i)=>i===e.currentPageIndex?{...r,items:r.items.filter(e=>e.id!==t)}:i===a?{...r,items:[...r.items,{...s,x:50,y:50}]}:r),selectedIds:[]}})},clearCanvas:()=>{e(e=>({pages:e.pages.map((t,a)=>a===e.currentPageIndex?{...t,items:[]}:t),selectedIds:[]}))},batchUpdateItems:t=>{e(e=>({pages:e.pages.map((a,r)=>r===e.currentPageIndex?{...a,items:a.items.map(e=>t[e.id]?{...e,...t[e.id]}:e)}:a)}))},setCanvasRatio:t=>e({canvasRatio:t}),setZoomLevel:t=>e({zoomLevel:Math.max(25,Math.min(400,t))}),resetZoom:()=>e({zoomLevel:100}),setSelectedIds:t=>e({selectedIds:t}),toggleSelection:t=>{e(e=>({selectedIds:e.selectedIds.includes(t)?e.selectedIds.filter(e=>e!==t):[...e.selectedIds,t]}))},addToSelection:t=>{e(e=>({selectedIds:e.selectedIds.includes(t)?e.selectedIds:[...e.selectedIds,t]}))},clearSelection:()=>e({selectedIds:[]}),removeSelectedItems:()=>{e(e=>e.pages[e.currentPageIndex]?{pages:e.pages.map((t,a)=>a===e.currentPageIndex?{...t,items:t.items.filter(t=>!e.selectedIds.includes(t.id))}:t),selectedIds:[]}:e)},moveSelectedItemsToPage:t=>{e(e=>{if(t===e.currentPageIndex||t<0||t>=e.pages.length)return e;let a=e.pages[e.currentPageIndex].items.filter(t=>e.selectedIds.includes(t.id));return 0===a.length?e:{pages:e.pages.map((r,s)=>s===e.currentPageIndex?{...r,items:r.items.filter(t=>!e.selectedIds.includes(t.id))}:s===t?{...r,items:[...r.items,...a.map((e,t)=>({...e,x:50+20*t,y:50+20*t}))]}:r),selectedIds:[]}})}}),{name:"report-builder-storage"}))},97085:(e,t,a)=>{a.d(t,{A:()=>c});var r=a(95155);a(12115);var s=a(37206),i=a(81477),n=a(37717);let l=(0,s.default)(()=>Promise.all([a.e(7776),a.e(4822)]).then(a.bind(a,44822)),{loadableGenerated:{webpack:()=>[null]},ssr:!1});function c({type:e,series:t,options:a,height:s=350,title:c,description:o,className:d,loading:x}){let h=(0,n.A)(),m={chart:{background:"transparent",foreColor:h.text,toolbar:{show:!1}},theme:{mode:"dark",palette:"palette1"},dataLabels:{enabled:!1,style:{colors:[h.text]}},grid:{borderColor:h.grid,strokeDashArray:4},xaxis:{labels:{style:{colors:h.textMuted}},axisBorder:{color:h.border},axisTicks:{color:h.border}},yaxis:{labels:{style:{colors:h.textMuted}}},tooltip:{theme:"dark",style:{fontSize:"12px"},x:{show:!0}},legend:{labels:{colors:h.textMuted}}},p={...m,...a,chart:{...m.chart,...a.chart}};return(0,r.jsxs)(i.Zp,{className:`p-4 ${d}`,children:[(c||o)&&(0,r.jsxs)("div",{className:"mb-4",children:[c&&(0,r.jsx)("h3",{className:"text-lg font-bold text-text-primary mb-1",children:c}),o&&(0,r.jsx)("p",{className:"text-sm text-text-secondary",children:o})]}),x?(0,r.jsx)("div",{className:"flex items-center justify-center",style:{height:s},children:(0,r.jsx)("div",{className:"loader"})}):(0,r.jsx)(l,{options:p,series:t,type:e,height:s,width:"100%"})]})}},98883:(e,t,a)=>{a.d(t,{P:()=>r});let r=e=>{let t=new Date,a=new Date,r=e.match(/^(\d+)m$/);if(r){let e=parseInt(r[1],10);if(Number.isFinite(e))return a.setMonth(t.getMonth()-e),{startDate:a.toISOString().split("T")[0],endDate:t.toISOString().split("T")[0]}}switch(e){case"1q":a.setMonth(t.getMonth()-3);break;case"2q":a.setMonth(t.getMonth()-6);break;case"3q":a.setMonth(t.getMonth()-9);break;case"1y":a.setFullYear(t.getFullYear()-1);break;case"this_year":a=new Date(t.getFullYear(),0,1);break;case"last_2_years":a=new Date(t.getFullYear()-1,0,1);break;case"last_3_years":a=new Date(t.getFullYear()-2,0,1);break;default:return{startDate:"",endDate:""}}return{startDate:a.toISOString().split("T")[0],endDate:t.toISOString().split("T")[0]}}}}]);