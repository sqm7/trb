"use strict";(self.webpackChunk_N_E=self.webpackChunk_N_E||[]).push([[2047],{19835:(e,t,n)=>{n.d(t,{A:()=>l});let l=(0,n(78340).A)("move",[["path",{d:"M12 2v20",key:"t6zp3m"}],["path",{d:"m15 19-3 3-3-3",key:"11eu04"}],["path",{d:"m19 9 3 3-3 3",key:"1mg7y2"}],["path",{d:"M2 12h20",key:"9i4pu4"}],["path",{d:"m5 9-3 3 3 3",key:"j64kie"}],["path",{d:"m9 5 3-3 3 3",key:"l8vdw6"}]])},22651:(e,t,n)=>{n.d(t,{A:()=>l});let l=(0,n(78340).A)("zoom-in",[["circle",{cx:"11",cy:"11",r:"8",key:"4ej97u"}],["line",{x1:"21",x2:"16.65",y1:"21",y2:"16.65",key:"13gj7c"}],["line",{x1:"11",x2:"11",y1:"8",y2:"14",key:"1vmskp"}],["line",{x1:"8",x2:"14",y1:"11",y2:"11",key:"durymu"}]])},68459:(e,t,n)=>{n.d(t,{A:()=>l});let l=(0,n(78340).A)("trash-2",[["path",{d:"M10 11v6",key:"nco0om"}],["path",{d:"M14 11v6",key:"outv1u"}],["path",{d:"M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6",key:"miytrc"}],["path",{d:"M3 6h18",key:"d0wm0j"}],["path",{d:"M8 6V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2",key:"e791ji"}]])},69220:(e,t,n)=>{n.d(t,{A:()=>l});let l=(0,n(78340).A)("zoom-out",[["circle",{cx:"11",cy:"11",r:"8",key:"4ej97u"}],["line",{x1:"21",x2:"16.65",y1:"21",y2:"16.65",key:"13gj7c"}],["line",{x1:"8",x2:"14",y1:"11",y2:"11",key:"durymu"}]])},82047:(e,t,n)=>{n.r(t),n.d(t,{default:()=>y});var l=n(95155),i=n(12115),r=n(21975),a=n(19835),s=n(22390),o=n(78340);let d=(0,o.A)("spline",[["circle",{cx:"19",cy:"5",r:"2",key:"mhkx31"}],["circle",{cx:"5",cy:"19",r:"2",key:"v8kfzx"}],["path",{d:"M5 17A12 12 0 0 1 17 5",key:"1okkup"}]]),c=(0,o.A)("square",[["rect",{width:"18",height:"18",x:"3",y:"3",rx:"2",key:"afitv7"}]]),u=(0,o.A)("app-window",[["rect",{x:"2",y:"4",width:"20",height:"16",rx:"2",key:"izxlao"}],["path",{d:"M10 4v4",key:"pp8u80"}],["path",{d:"M2 8h20",key:"d11cs7"}],["path",{d:"M6 4v4",key:"1svtjw"}]]);var x=n(22651),h=n(69220),m=n(68459),p=n(40980);let g={wall:"#60a5fa",window:"#38bdf8",pillar:"#f97316"},f=[{type:"wardrobe",label:"衣櫃",size:{w:80,h:40}},{type:"cabinet",label:"櫃體",size:{w:60,h:30}},{type:"bed",label:"床",size:{w:120,h:80}},{type:"sofa",label:"沙發",size:{w:110,h:50}},{type:"diningTable",label:"餐桌",size:{w:90,h:60}},{type:"desk",label:"書桌",size:{w:80,h:45}},{type:"chair",label:"椅子",size:{w:30,h:30}},{type:"sink",label:"洗手台",size:{w:50,h:35}},{type:"toilet",label:"馬桶",size:{w:35,h:45}},{type:"kitchen",label:"流理台",size:{w:120,h:40}},{type:"fridge",label:"冰箱",size:{w:40,h:35}}],w=()=>Math.random().toString(36).slice(2,10);function y(){let e,t,n,o,y,b,v,k,P=(0,i.useRef)(null),j=(0,i.useRef)(null),N=(0,i.useRef)(null),z=(0,i.useRef)({zoomLevel:1,panOffset:{x:0,y:0},isPanning:!1,panStart:{x:0,y:0},drawing:!1,startPoint:{x:0,y:0},endPoint:{x:0,y:0},drawingPoints:[],measureLines:[],wallPaths:[],rooms:[],columns:[],windows:[],furniture:[],scale:null,selected:null,draggingFurnitureId:null,draggingWindowId:null,draggingWindowHandle:null,draggingWallPathId:null,draggingRoomId:null,draggingColumnId:null,dragStartMouse:{x:0,y:0},dragStartFurniturePos:{x:0,y:0},dragStartRoomPoints:[],dragStartColumnPoints:[],dragStartWallMouse:{x:0,y:0},dragStartWallPoints:[],dragStartWindow:null,snappedPoint:null,pointerWorld:null,isSpacePressed:!1,isShiftPressed:!1,isOrthoMode:!1,usedOrthoDuringDraw:!1}),[C,S]=(0,i.useState)({mode:null,hasImage:!1,scaleSet:!1,infoText:"請上傳平面圖開始",fillColor:"#4ade80",fillOpacity:.2,imageOpacity:.7,boundaryFillColor:"#22c55e",boundaryFillOpacity:.15,zoomDisplay:100,isOrtho:!1,selectedFurnitureType:"wardrobe",wallThicknessDefault:15,windowWidthCm:120,windowType:"sliding",planType:"indoor",planNote:""}),M=(0,i.useRef)(C.wallThicknessDefault),[T,I]=(0,i.useState)(null),L=e=>({x:(e.x-z.current.panOffset.x)/z.current.zoomLevel,y:(e.y-z.current.panOffset.y)/z.current.zoomLevel}),W=(e,t)=>Math.sqrt((t.x-e.x)**2+(t.y-e.y)**2),F=e=>{let t=0;for(let n=0,l=e.length;n<l;n++)t+=e[n].x*e[n===l-1?0:n+1].y-e[n===l-1?0:n+1].x*e[n].y;return Math.abs(t/2)},E=e=>{if(0===e.length)return{x:0,y:0};let t=0,n=0,l=0;for(let i=0;i<e.length;i++){let r=e[i],a=e[(i+1)%e.length],s=r.x*a.y-a.x*r.y;l+=s,t+=(r.x+a.x)*s,n+=(r.y+a.y)*s}let i=3*l;return 0===i?e[0]:{x:t/i,y:n/i}},D=(e,t)=>{let n=parseInt(e.slice(1,3),16),l=parseInt(e.slice(3,5),16),i=parseInt(e.slice(5,7),16);return`rgba(${n}, ${l}, ${i}, ${t})`},R=(e,t,n)=>{let l=n.x-t.x,i=n.y-t.y,r=e.x-t.x,a=e.y-t.y,s=l*l+i*i;if(0===s)return W(e,t);let o=Math.max(0,Math.min(1,(r*l+a*i)/s));return W(e,{x:t.x+l*o,y:t.y+i*o})},O=(e,t,n)=>{let l=n.x-t.x,i=n.y-t.y,r=e.x-t.x,a=e.y-t.y,s=l*l+i*i;if(0===s)return{point:t,t:0};let o=Math.max(0,Math.min(1,(r*l+a*i)/s));return{point:{x:t.x+l*o,y:t.y+i*o},t:o}},A=(e,t)=>{let n=!1;for(let l=0,i=t.length-1;l<t.length;i=l++){let r=t[l].x,a=t[l].y,s=t[i].x,o=t[i].y;a>e.y!=o>e.y&&e.x<(s-r)*(e.y-a)/(o-a+1e-5)+r&&(n=!n)}return n},B=e=>f.find(t=>t.type===e)||f[0],$=e=>{let t=B(e.type),n=t.size.w*e.scale/2,l=t.size.h*e.scale/2,i=Math.cos(e.rotation),r=Math.sin(e.rotation),a=[{x:-n,y:-l},{x:n,y:-l},{x:n,y:l},{x:-n,y:l}].map(t=>({x:e.position.x+t.x*i-t.y*r,y:e.position.y+t.x*r+t.y*i})),s=a.map(e=>e.x),o=a.map(e=>e.y);return{minX:Math.min(...s),maxX:Math.max(...s),minY:Math.min(...o),maxY:Math.max(...o)}},H=(e,t,n,l,i)=>{e.save();let r=13/i;e.font=`bold ${r}px sans-serif`,e.fillStyle="rgba(0,0,0,0.7)";let a=e.measureText(t).width;e.fillRect(n.x-a/2-2/i,n.y-r-2/i,a+4/i,r+4/i),e.fillStyle=l,e.textAlign="center",e.fillText(t,n.x,n.y-4/i),e.restore()},X=(e,t)=>Math.abs(t.x-e.x)>Math.abs(t.y-e.y)?{x:t.x,y:e.y}:{x:e.x,y:t.y},U=e=>{if(e.length<2)return e;let t=e[0],n=e[1],l=e[e.length-1];return Math.abs(n.x-t.x)>=Math.abs(n.y-t.y)?[{x:l.x,y:t.y},...e.slice(1)]:[{x:t.x,y:l.y},...e.slice(1)]},Y=e=>{if(e.length<2)return e;let t=[{...e[0]}];for(let n=1;n<e.length;n++){let l=t[n-1],i={...e[n]};Math.abs(i.x-l.x)>=Math.abs(i.y-l.y)?i.y=l.y:i.x=l.x,t.push(i)}return t},_=()=>z.current.wallPaths.find(e=>e.isBoundary)||null,q=(e,t=!0)=>{let n=z.current,l=18/n.zoomLevel,i=e;n.wallPaths.forEach(n=>{if(!t&&n.isBoundary)return;let r=n.isBoundary?n.points.length:n.points.length-1;for(let t=0;t<r;t++){let r=n.points[t],a=n.points[(t+1)%n.points.length],s=R(e,r,a);s<l&&(l=s,i=O(e,r,a).point)}});let r=K()?.polygon;if(r&&r.length>=2)for(let t=0;t<r.length;t++){let n=r[t],a=r[(t+1)%r.length],s=R(e,n,a);s<l&&(l=s,i=O(e,n,a).point)}return i},V=e=>_()?e.map(e=>q(e,!0)):e,K=()=>{let e=z.current;if(!e.scale)return null;let t=_();if(!t||t.points.length<3)return null;let n=[],l=t.segments,i=t.points.length;for(let t=0;t<i;t++){let i=l[t]?.thicknessCm??C.wallThicknessDefault;n.push(i*e.scale)}let r=((e,t)=>{if(e.length<3)return[];let n=(e=>{let t=0;for(let n=0,l=e.length;n<l;n++){let i=e[n],r=e[n===l-1?0:n+1];t+=i.x*r.y-r.x*i.y}return t/2})(e)>0,l=(e,t)=>{let l=t.x-e.x,i=t.y-e.y,r=Math.sqrt(l*l+i*i)||1,a=-i/r,s=l/r;return n?{x:a,y:s}:{x:-a,y:-s}},i=[],r=e.length;for(let n=0;n<r;n++){let a=e[(n-1+r)%r],s=e[n],o=e[(n+1)%r],d=t[(n-1+r)%r],c=t[n],u=l(a,s),x=l(s,o),h={x:a.x+u.x*d,y:a.y+u.y*d},m={x:s.x+u.x*d,y:s.y+u.y*d},p={x:s.x+x.x*c,y:s.y+x.y*c},g={x:o.x+x.x*c,y:o.y+x.y*c},f=(h.x-m.x)*(p.y-g.y)-(h.y-m.y)*(p.x-g.x);if(1e-5>Math.abs(f)){i.push({x:s.x+u.x*d,y:s.y+u.y*d});continue}let w=((h.x*m.y-h.y*m.x)*(p.x-g.x)-(h.x-m.x)*(p.x*g.y-p.y*g.x))/f,y=((h.x*m.y-h.y*m.x)*(p.y-g.y)-(h.y-m.y)*(p.x*g.y-p.y*g.x))/f;i.push({x:w,y:y})}return i})(t.points,n.map(e=>e));if(((e,t=.5)=>{if(e.length<2)return!1;for(let n=0;n<e.length;n++){let l=e[n],i=e[(n+1)%e.length],r=Math.abs(l.x-i.x),a=Math.abs(l.y-i.y);if(r>t&&a>t)return!1}return!0})(t.points)&&(r=Y(r)),r.length<3)return null;let a=F(r)/(e.scale*e.scale);return{areaCm2:a,areaM2:a/1e4,areaPing:a/33057.9,polygon:r}},G=(0,i.useCallback)(()=>{let e=P.current,t=e?.getContext("2d");if(!e||!t)return;let n=z.current,{width:l,height:i}=e;if(t.clearRect(0,0,l,i),t.save(),t.translate(n.panOffset.x,n.panOffset.y),t.scale(n.zoomLevel,n.zoomLevel),N.current){let e=N.current;t.save(),t.globalAlpha=C.imageOpacity,t.drawImage(e,-e.naturalWidth/2,-e.naturalHeight/2),t.restore()}let r=_(),a=K()?.polygon||null;if(r&&r.points.length>=3){t.beginPath(),t.moveTo(r.points[0].x,r.points[0].y);for(let e=1;e<r.points.length;e++)t.lineTo(r.points[e].x,r.points[e].y);t.closePath(),t.fillStyle=D(C.boundaryFillColor,C.boundaryFillOpacity),t.fill()}if(n.wallPaths.forEach(e=>{if(!(e.points.length<2))for(let l=0;l<e.points.length;l++){let i=e.points[l],r=e.points[(l+1)%e.points.length];if(!e.isBoundary&&l===e.points.length-1)break;let a=e.segments[l%e.segments.length],s=T?.kind==="wall"&&T.pathId===e.id&&T.segmentIndex===l,o=e.isBoundary?"#a855f7":g[a.wallType],d=n.scale?(a.thicknessCm||C.wallThicknessDefault)*n.scale:6,c=Math.max(2,d/12)/n.zoomLevel;if(e.isBoundary)t.beginPath(),t.moveTo(i.x,i.y),t.lineTo(r.x,r.y),"window"===a.wallType?t.setLineDash([8/n.zoomLevel,6/n.zoomLevel]):t.setLineDash([]),t.strokeStyle=s?"#facc15":o,t.lineWidth=s?1.6*c:c,t.stroke(),t.setLineDash([]);else{let n=r.x-i.x,l=r.y-i.y,a=Math.sqrt(n*n+l*l)||1,u={x:-l/a,y:n/a},x=(e.offsetSide??1)*d,h=u.x*x,m=u.y*x;t.beginPath(),t.moveTo(i.x,i.y),t.lineTo(r.x,r.y),t.lineTo(r.x+h,r.y+m),t.lineTo(i.x+h,i.y+m),t.closePath(),t.fillStyle="rgba(96,165,250,0.2)",t.fill(),t.strokeStyle=s?"#facc15":o,t.lineWidth=s?1.4*c:c,t.stroke()}}}),n.windows.forEach(e=>{let l=er(e);if(!l)return;let i=T?.kind==="window"&&T.id===e.id,r=Math.atan2(l.uy,l.ux);t.save(),t.translate(l.center.x,l.center.y),t.rotate(r),t.fillStyle="rgba(56,189,248,0.2)",t.strokeStyle=i?"#facc15":"#38bdf8",t.lineWidth=2/n.zoomLevel,t.fillRect(-l.widthPx/2,-l.thicknessPx/2,l.widthPx,l.thicknessPx),t.strokeRect(-l.widthPx/2,-l.thicknessPx/2,l.widthPx,l.thicknessPx),"sliding"===e.type?(t.beginPath(),t.moveTo(-l.widthPx/2,0),t.lineTo(l.widthPx/2,0),t.moveTo(-l.widthPx/2,-(.25*l.thicknessPx)),t.lineTo(0,-(.25*l.thicknessPx)),t.moveTo(0,.25*l.thicknessPx),t.lineTo(l.widthPx/2,.25*l.thicknessPx)):(t.beginPath(),t.moveTo(-l.widthPx/2,0),t.lineTo(l.widthPx/2,0),t.stroke(),t.beginPath(),t.arc(-l.widthPx/2,0,Math.min(.35*l.widthPx,24/n.zoomLevel),-Math.PI/2,Math.PI/2)),t.stroke(),t.fillStyle=i?"#facc15":"#38bdf8",t.beginPath(),t.arc(-l.widthPx/2,0,3/n.zoomLevel,0,2*Math.PI),t.arc(l.widthPx/2,0,3/n.zoomLevel,0,2*Math.PI),t.fill(),t.restore()}),a&&a.length>=3){t.beginPath(),t.moveTo(a[0].x,a[0].y);for(let e=1;e<a.length;e++)t.lineTo(a[e].x,a[e].y);t.closePath(),t.strokeStyle="#a78bfa",t.lineWidth=1.6/n.zoomLevel,t.setLineDash([6/n.zoomLevel,6/n.zoomLevel]),t.stroke(),t.setLineDash([])}if("drawWall"===C.mode&&a&&a.length>=2&&n.pointerWorld){let e=((e,t,n)=>{let l=n,i=null;for(let n=0;n<e.length;n++){let r=e[n],a=e[(n+1)%e.length],s=R(t,r,a);s<l&&(l=s,i={a:r,b:a})}return i})(a,n.pointerWorld,12/n.zoomLevel);e&&(t.beginPath(),t.moveTo(e.a.x,e.a.y),t.lineTo(e.b.x,e.b.y),t.strokeStyle="rgba(56,189,248,0.9)",t.lineWidth=3/n.zoomLevel,t.setLineDash([]),t.stroke())}if(n.rooms.forEach(e=>{if(e.points.length<3)return;let l=T?.kind==="room"&&T.id===e.id;t.beginPath(),t.moveTo(e.points[0].x,e.points[0].y);for(let n=1;n<e.points.length;n++)t.lineTo(e.points[n].x,e.points[n].y);if(t.closePath(),t.fillStyle=D(e.fillColor,e.fillOpacity),t.fill(),t.strokeStyle=l?"#facc15":"#34d399",t.lineWidth=(l?3:2)/n.zoomLevel,t.stroke(),n.scale){let l=F(e.points)/(n.scale*n.scale),i=E(e.points);H(t,`${e.name} ${(l/33057.9).toFixed(2)} 坪`,i,"#fbbf24",n.zoomLevel)}}),n.columns.forEach(e=>{if(e.points.length<3)return;let l=T?.kind==="column"&&T.id===e.id;t.beginPath(),t.moveTo(e.points[0].x,e.points[0].y);for(let n=1;n<e.points.length;n++)t.lineTo(e.points[n].x,e.points[n].y);t.closePath(),t.fillStyle="rgba(148,163,184,0.35)",t.fill(),t.strokeStyle=l?"#facc15":"#94a3b8",t.lineWidth=(l?2.5:1.5)/n.zoomLevel,t.stroke()}),n.measureLines.forEach(e=>{if(t.beginPath(),t.moveTo(e.pixelStart.x,e.pixelStart.y),t.lineTo(e.pixelEnd.x,e.pixelEnd.y),t.strokeStyle=e.color,t.lineWidth=2/n.zoomLevel,t.stroke(),n.scale){let l=W(e.pixelStart,e.pixelEnd)/n.scale,i={x:(e.pixelStart.x+e.pixelEnd.x)/2,y:(e.pixelStart.y+e.pixelEnd.y)/2};H(t,`${l.toFixed(1)} cm`,i,"#f87171",n.zoomLevel)}}),n.furniture.forEach(e=>{let l=T?.kind==="furniture"&&T.id===e.id;((e,t,n,l)=>{let i=B(t.type),r=i.size.w*t.scale,a=i.size.h*t.scale;e.save(),e.translate(t.position.x,t.position.y),e.rotate(t.rotation),e.lineWidth=2/l,e.strokeStyle=n?"#facc15":"#e5e7eb";let s=(t,n,l,i)=>e.strokeRect(t,n,l,i),o=(t,n,l)=>{e.beginPath(),e.arc(t,n,l,0,2*Math.PI),e.stroke()};switch(t.type){case"bed":s(-r/2,-a/2,r,a),s(-r/2,-a/2,r,.25*a),s(-r/2+.08*r,-a/2+.06*a,.28*r,.14*a),s(r/2-.36*r,-a/2+.06*a,.28*r,.14*a),e.beginPath(),e.moveTo(-r/2,-(.05*a)),e.lineTo(r/2,-(.05*a)),e.stroke();break;case"sofa":s(-r/2,-a/2,r,a),s(-r/2,-a/2,r,.25*a),s(-r/2,-a/2,.15*r,a),s(r/2-.15*r,-a/2,.15*r,a),s(-r/2+.2*r,-a/2+.35*a,.6*r,.45*a);break;case"wardrobe":s(-r/2,-a/2,r,a),e.beginPath(),e.moveTo(0,-a/2),e.lineTo(0,a/2),e.stroke(),o(-(.15*r),0,Math.max(2,.03*r)),o(.15*r,0,Math.max(2,.03*r));break;case"cabinet":s(-r/2,-a/2,r,a),e.beginPath(),e.moveTo(-r/2,-a/6),e.lineTo(r/2,-a/6),e.moveTo(-r/2,a/6),e.lineTo(r/2,a/6),e.stroke();break;case"diningTable":{s(-r/2,-a/2,r,a);let e=.18*r,t=.28*a;s(-r/2-.9*e,-t/2,e,t),s(r/2-.1*e,-t/2,e,t),s(-e/2,-a/2-.9*t,e,t),s(-e/2,a/2-.1*t,e,t);break}case"desk":s(-r/2,-a/2,r,a),e.beginPath(),e.moveTo(-r/2,-a/6),e.lineTo(r/2,-a/6),e.stroke(),s(r/2-.22*r,-a/2,.2*r,.45*a),e.beginPath(),e.moveTo(r/2-.22*r,-a/2+.22*a),e.lineTo(r/2-.02*r,-a/2+.22*a),e.stroke();break;case"chair":s(-r/2,-a/6,r,a/2),s(-r/2,-a/2,r,a/3);break;case"sink":s(-r/2,-a/2,r,a),o(0,0,.25*Math.min(r,a));break;case"toilet":s(-r/2,-a/2,r,.35*a),e.beginPath(),e.ellipse(0,.1*a,.4*r,.35*a,0,0,2*Math.PI),e.stroke(),e.beginPath(),e.ellipse(0,.1*a,.2*r,.18*a,0,0,2*Math.PI),e.stroke();break;case"kitchen":s(-r/2,-a/2,r,a),o(-(.2*r),0,.18*Math.min(r,a)),o(.2*r,0,.18*Math.min(r,a)),s(-r/2+.05*r,-a/2+.05*a,.35*r,.4*a);break;case"fridge":s(-r/2,-a/2,r,a),e.beginPath(),e.moveTo(-r/2,-a/2+.45*a),e.lineTo(r/2,-a/2+.45*a),e.stroke(),e.beginPath(),e.moveTo(r/2-.15*r,-a/2+.1*a),e.lineTo(r/2-.15*r,-a/2+.4*a),e.moveTo(r/2-.15*r,-a/2+.55*a),e.lineTo(r/2-.15*r,-a/2+.85*a),e.stroke();break;default:s(-r/2,-a/2,r,a)}e.restore()})(t,e,l,n.zoomLevel)}),n.drawing){if("setScale"===C.mode||"measureLine"===C.mode)t.beginPath(),t.moveTo(n.startPoint.x,n.startPoint.y),t.lineTo(n.endPoint.x,n.endPoint.y),t.strokeStyle="#ef4444",t.lineWidth=2/n.zoomLevel,t.stroke();else if(("drawBoundary"===C.mode||"drawRoom"===C.mode||"drawWall"===C.mode||"drawColumn"===C.mode)&&n.drawingPoints.length>0){t.beginPath(),t.moveTo(n.drawingPoints[0].x,n.drawingPoints[0].y);for(let e=1;e<n.drawingPoints.length;e++)t.lineTo(n.drawingPoints[e].x,n.drawingPoints[e].y);t.lineTo(n.endPoint.x,n.endPoint.y),t.strokeStyle="#38bdf8",t.lineWidth=2/n.zoomLevel,t.stroke()}else if("drawColumnRect"===C.mode){let e=Math.min(n.startPoint.x,n.endPoint.x),l=Math.max(n.startPoint.x,n.endPoint.x),i=Math.min(n.startPoint.y,n.endPoint.y),r=Math.max(n.startPoint.y,n.endPoint.y);t.strokeStyle="#94a3b8",t.lineWidth=2/n.zoomLevel,t.strokeRect(e,i,l-e,r-i)}}if(n.snappedPoint){let e,l={x:(e=n.snappedPoint).x*z.current.zoomLevel+z.current.panOffset.x,y:e.y*z.current.zoomLevel+z.current.panOffset.y};t.beginPath(),t.arc(l.x,l.y,6,0,2*Math.PI),t.strokeStyle="#facc15",t.lineWidth=2,t.stroke()}t.restore()},[T,C]);(0,i.useEffect)(()=>{z.current.isOrthoMode=C.isOrtho,G()},[C.isOrtho,G]),(0,i.useEffect)(()=>{let e=_(),t=M.current;e&&(e.segments.forEach(e=>{e.thicknessCm&&e.thicknessCm!==t||(e.thicknessCm=C.wallThicknessDefault)}),G()),M.current=C.wallThicknessDefault},[C.wallThicknessDefault,G]),(0,i.useEffect)(()=>{G()},[C.imageOpacity,C.fillColor,C.fillOpacity,C.boundaryFillColor,C.boundaryFillOpacity,C.mode,C.wallThicknessDefault,T,G]);let J=e=>{z.current.selected=e,I(e)},Q=(0,i.useCallback)(()=>{let e=z.current;if(e.drawingPoints.length>=3){let t=e.isOrthoMode||e.usedOrthoDuringDraw?Y(U(e.drawingPoints)):[...e.drawingPoints],n={id:w(),points:t,segments:Array.from({length:t.length},()=>({wallType:"wall",thicknessCm:C.wallThicknessDefault})),isBoundary:!0};e.wallPaths=e.wallPaths.filter(e=>!e.isBoundary),e.wallPaths.push(n),e.windows=[],S(e=>({...e,infoText:`外框建立完成。`}))}e.drawingPoints=[],e.drawing=!1,G()},[G,C.wallThicknessDefault]),Z=(0,i.useCallback)(()=>{let e=z.current;if(e.drawingPoints.length>=2){let t=prompt("請輸入內牆厚度 (cm)","10"),n=t?parseFloat(t):C.wallThicknessDefault,l=Number.isFinite(n)&&n>0?n:C.wallThicknessDefault,i=(e.isOrthoMode||e.usedOrthoDuringDraw?Y(e.drawingPoints):[...e.drawingPoints]).map(e=>q(e,!0)),r=_(),a=1;if(r&&i.length>=2){let e=i[0],t=i[1],n=t.x-e.x,l=t.y-e.y,s=Math.sqrt(n*n+l*l)||1,o={x:-l/s,y:n/s},d={x:(e.x+t.x)/2,y:(e.y+t.y)/2};a=A({x:d.x+6*o.x,y:d.y+6*o.y},r.points)?1:-1}let s={id:w(),points:i,segments:Array.from({length:i.length-1},()=>({wallType:"wall",thicknessCm:l})),offsetSide:a};e.wallPaths.push(s),S(e=>({...e,infoText:`內牆已新增。`}))}e.drawingPoints=[],e.drawing=!1,G()},[G,C.wallThicknessDefault]),ee=(0,i.useCallback)(()=>{let e=z.current;if(e.drawingPoints.length>=3){let t=e.isOrthoMode||e.usedOrthoDuringDraw?Y(U(e.drawingPoints)):[...e.drawingPoints],n={id:w(),name:`空間 ${e.rooms.length+1}`,points:t,fillColor:C.fillColor,fillOpacity:C.fillOpacity};e.rooms.push(n),S(e=>({...e,infoText:`空間已新增。`}))}e.drawingPoints=[],e.drawing=!1,G()},[G,C.fillColor,C.fillOpacity]),et=(0,i.useCallback)(()=>{let e=z.current;if(e.drawingPoints.length>=3){let t=V(e.isOrthoMode||e.usedOrthoDuringDraw?Y(U(e.drawingPoints)):[...e.drawingPoints]),n={id:w(),points:t};e.columns.push(n),S(e=>({...e,infoText:`柱子已新增。`}))}e.drawingPoints=[],e.drawing=!1,G()},[G]),en=(0,i.useCallback)(()=>{let e=z.current,t=e.startPoint,n=e.endPoint,l=Math.abs(n.x-t.x),i=Math.abs(n.y-t.y);if(l<1||i<1){e.drawing=!1,G();return}let r=Math.min(t.x,n.x),a=Math.max(t.x,n.x),s=Math.min(t.y,n.y),o=Math.max(t.y,n.y),d=V([{x:r,y:s},{x:a,y:s},{x:a,y:o},{x:r,y:o}]);e.columns.push({id:w(),points:d}),S(e=>({...e,infoText:`矩形柱子已新增。`})),e.drawing=!1,G()},[G]),el=(0,i.useCallback)(()=>{let e=z.current;if(T){if("furniture"===T.kind)e.furniture=e.furniture.filter(e=>e.id!==T.id);else if("window"===T.kind)e.windows=e.windows.filter(e=>e.id!==T.id);else if("room"===T.kind)e.rooms=e.rooms.filter(e=>e.id!==T.id);else if("column"===T.kind)e.columns=e.columns.filter(e=>e.id!==T.id);else if("wall"===T.kind){let t=e.wallPaths.find(e=>e.id===T.pathId);t?.isBoundary?(e.wallPaths=e.wallPaths.filter(e=>e.id!==t.id),e.windows=[]):e.wallPaths=e.wallPaths.filter(e=>e.id!==T.pathId)}J(null),G()}},[T,G]),ei=(0,i.useCallback)((e,t)=>{if(!T||"wall"!==T.kind)return;let n=z.current.wallPaths.find(e=>e.id===T.pathId);if(!n||!n.isBoundary)return;let l=n.points,i=l.length,r=T.segmentIndex%i,a=l[r],s=l[(r+1)%i],o=Math.abs(s.x-a.x)<Math.abs(s.y-a.y);if(o&&("left"===e||"right"===e)){let n="left"===e?-t:t;a.x+=n,s.x+=n}else{if(o||"up"!==e&&"down"!==e)return;let n="up"===e?-t:t;a.y+=n,s.y+=n}G()},[T,G]);(0,i.useEffect)(()=>{let e=e=>{if(!(document.activeElement?.tagName==="INPUT"||document.activeElement?.tagName==="TEXTAREA"||document.activeElement?.isContentEditable)){if("Shift"===e.key&&(z.current.isShiftPressed=!0),"Space"===e.code&&(z.current.isSpacePressed=!0),"Escape"===e.key){let e=z.current;(e.drawing||e.drawingPoints.length>0)&&(e.drawingPoints=[],e.drawing=!1),S(e=>({...e,mode:"select",infoText:"已進入選取模式"})),G();return}if("Delete"===e.key||"Backspace"===e.key){el(),e.preventDefault();return}if("Enter"===e.code&&("drawBoundary"===C.mode&&Q(),"drawWall"===C.mode&&Z(),"drawRoom"===C.mode&&ee(),"drawColumn"===C.mode&&et(),"drawColumnRect"===C.mode&&en()),e.key.startsWith("Arrow")){let t=(e.shiftKey?3:.5)/z.current.zoomLevel;"ArrowLeft"===e.key&&ei("left",t),"ArrowRight"===e.key&&ei("right",t),"ArrowUp"===e.key&&ei("up",t),"ArrowDown"===e.key&&ei("down",t),e.preventDefault()}}},t=e=>{"Shift"===e.key&&(z.current.isShiftPressed=!1),"Space"===e.code&&(z.current.isSpacePressed=!1)};return window.addEventListener("keydown",e),window.addEventListener("keyup",t),()=>{window.removeEventListener("keydown",e),window.removeEventListener("keyup",t)}},[Q,Z,ee,et,en,C.mode,G,el,ei]);let er=e=>{let t=z.current,n=_();if(!n||n.points.length<2)return null;let l=n.points;if(e.segmentIndex>=l.length)return null;let i=l[e.segmentIndex],r=l[(e.segmentIndex+1)%l.length],a=r.x-i.x,s=r.y-i.y,o=Math.sqrt(a*a+s*s)||1,d=a/o,c=s/o,u={x:-c,y:d},x={x:i.x+a*e.t,y:i.y+s*e.t},h=A({x:x.x+2*u.x,y:x.y+2*u.y},n.points)?u:{x:-u.x,y:-u.y},m=t.scale?(n.segments[e.segmentIndex]?.thicknessCm??C.wallThicknessDefault)*t.scale:12,p=t.scale?e.widthCm*t.scale:e.widthCm,g={x:x.x+h.x*(m/2),y:x.y+h.y*(m/2)},f={x:x.x-p/2*d,y:x.y-p/2*c},w={x:x.x+p/2*d,y:x.y+p/2*c};return{center:g,ux:d,uy:c,inward:h,widthPx:p,thicknessPx:m,start:f,end:w,segmentLength:o}},ea=e=>{let t=_();if(!t||t.points.length<2)return;let n=t.points;if(e.segmentIndex>=n.length)return;let l=W(n[e.segmentIndex],n[(e.segmentIndex+1)%n.length])||1,i=z.current.scale??1,r=Math.max(30,l/i*.95);e.widthCm>r&&(e.widthCm=r),e.widthCm<30&&(e.widthCm=30);let a=e.widthCm*i/(2*l);a>=.5?e.t=.5:e.t=Math.min(1-a,Math.max(a,e.t))};(0,i.useEffect)(()=>{let e=()=>{if(j.current&&P.current){P.current.width=j.current.clientWidth,P.current.height=j.current.clientHeight;let e=document;if((e.fullscreenElement||e.webkitFullscreenElement)&&N.current){let e=N.current,t=P.current.width/e.naturalWidth,n=P.current.height/e.naturalHeight;z.current.zoomLevel=.9*Math.min(t,n),z.current.panOffset={x:(P.current.width||0)/2,y:(P.current.height||0)/2},S(e=>({...e,zoomDisplay:Math.round(100*z.current.zoomLevel)}))}G()}},t=()=>e(),n=new ResizeObserver(()=>e());j.current&&n.observe(j.current),window.addEventListener("resize",e),document.addEventListener("fullscreenchange",t),document.addEventListener("webkitfullscreenchange",t),e();let l=e=>{"Space"===e.code&&(z.current.isSpacePressed=!0)},i=e=>{"Space"===e.code&&(z.current.isSpacePressed=!1)};return window.addEventListener("keydown",l),window.addEventListener("keyup",i),()=>{n.disconnect(),window.removeEventListener("resize",e),document.removeEventListener("fullscreenchange",t),document.removeEventListener("webkitfullscreenchange",t),window.removeEventListener("keydown",l),window.removeEventListener("keyup",i)}},[G]);let es=(()=>{if(!T||"wall"!==T.kind)return null;let e=z.current.wallPaths.find(e=>e.id===T.pathId);if(!e)return null;let t=e.segments[T.segmentIndex];return{path:e,segment:t,segmentIndex:T.segmentIndex}})(),eo=T&&"furniture"===T.kind&&z.current.furniture.find(e=>e.id===T.id)||null,ed=T&&"window"===T.kind&&z.current.windows.find(e=>e.id===T.id)||null,ec=T&&"column"===T.kind&&z.current.columns.find(e=>e.id===T.id)||null,eu=K(),ex=_(),eh=z.current.scale,em=!!eh,ep=ex&&em?F(ex.points)/(eh*eh):null,eg=z.current.rooms.map(e=>{let t=em?F(e.points)/(eh*eh):null;return{room:e,areaCm2:t}}),ef=(()=>{let e=z.current;if(null===e.scale)return null;let t=e.scale,n=0;return e.columns.forEach(e=>{if(e.points.length<3)return;let l=F(e.points);n+=l/(t*t)}),n})(),ew=(e=>{let t=z.current;if(!e||e.length<3||null===t.scale)return null;let n=t.scale,l=0;return t.columns.forEach(t=>{if(t.points.length<3||!A(E(t.points),e))return;let i=F(t.points);l+=i/(n*n)}),l})(eu?.polygon??null),ey=eu&&null!==ew?Math.max(0,eu.areaCm2-ew):eu?.areaCm2??null,eb=(()=>{let e=z.current;if(null===e.scale)return null;let t=e.scale,n=0;return e.wallPaths.forEach(e=>{if(e.isBoundary)return;let l=Math.max(0,e.points.length-1);for(let i=0;i<l;i++){let l=W(e.points[i],e.points[i+1])/t,r=e.segments[i]?.thicknessCm??C.wallThicknessDefault;n+=l*r}}),n})(),ev=eu&&em?Math.max(0,eu.areaCm2-(ef||0)-(eb||0)):null,ek=e=>null!==e&&em?`${(e/1e4).toFixed(2)} ㎡ / ${(e/33057.9).toFixed(2)} 坪`:"-",eP=(e,t)=>{S(n=>({...n,mode:e,infoText:t}))},ej=[{id:"upload",label:"Step 1 上傳平面圖",done:C.hasImage,action:"upload"},{id:"scale",label:"Step 2 設定比例尺",done:C.scaleSet,action:()=>eP("setScale","Step 2：請標出已知距離並輸入實際公分")},{id:"boundary",label:"Step 3 繪製外框",done:!!ex&&ex.points.length>=3,action:()=>eP("drawBoundary","Step 3：繪製外框（右鍵或 Enter 結束）")},{id:"rooms",label:"Step 4 繪製空間",done:z.current.rooms.length>0,action:()=>eP("drawRoom","Step 4：繪製各空間範圍")},{id:"walls",label:"Step 5 內牆（可選）",done:z.current.wallPaths.some(e=>!e.isBoundary),action:()=>eP("drawWall","Step 5：繪製內牆，可拖曳移動")},{id:"columns",label:"Step 6 柱子（可選）",done:z.current.columns.length>0,action:()=>eP("drawColumnRect","Step 6：拖拉建立矩形柱子")},{id:"windows",label:"Step 7 窗戶（可選）",done:z.current.windows.length>0,action:()=>eP("placeWindow","Step 7：點外框新增窗戶並可拖曳")},{id:"furniture",label:"Step 8 家具配置（可選）",done:z.current.furniture.length>0,action:()=>eP("placeFurniture","Step 8：拖放家具並可旋轉/縮放")}],eN="drawColumnRect"===C.mode||"drawColumn"===C.mode||!!ec,ez="placeWindow"===C.mode||!!ed,eC="placeFurniture"===C.mode||!!eo,eS=eN||ez||eC;return(0,l.jsxs)("div",{className:"flex h-full w-full gap-4",children:[(0,l.jsxs)("div",{className:"relative flex-1 min-w-0",ref:j,children:[(0,l.jsxs)("div",{className:"flex flex-wrap items-center gap-2 p-2 bg-zinc-900/80 backdrop-blur border border-white/5 rounded-xl z-10 w-full lg:absolute lg:top-4 lg:left-4 lg:right-4 shadow-xl",children:[(0,l.jsx)("input",{type:"file",id:"fp-upload",className:"hidden",accept:"image/*",onChange:e=>{let t=e.target.files?.[0];if(!t)return;let n=new FileReader;n.onload=e=>{let t=new Image;t.onload=()=>{N.current=t,z.current.panOffset={x:(P.current?.width||0)/2,y:(P.current?.height||0)/2};let e=P.current;if(e){let n=e.width/t.naturalWidth,l=e.height/t.naturalHeight;z.current.zoomLevel=.9*Math.min(n,l),S(e=>({...e,zoomDisplay:Math.round(100*z.current.zoomLevel)}))}S(e=>({...e,hasImage:!0,infoText:"圖片已載入。請設定比例尺 (Step 1)。"})),G()},t.src=e.target?.result},n.readAsDataURL(t)}}),(0,l.jsx)("label",{htmlFor:"fp-upload",className:"p-2 hover:bg-zinc-800 rounded-lg cursor-pointer text-zinc-400 hover:text-white transition-colors",title:"上傳圖片",children:(0,l.jsx)(r.A,{className:"h-5 w-5"})}),(0,l.jsx)("div",{className:"h-6 w-px bg-white/10 mx-1"}),(0,l.jsxs)("button",{onClick:()=>S(e=>({...e,mode:"setScale"})),className:(0,p.cn)("p-2 rounded-lg transition-colors flex items-center gap-2","setScale"===C.mode?"bg-cyan-600 text-white":"text-zinc-400 hover:bg-zinc-800"),disabled:!C.hasImage,title:"1. 設定比例尺",children:[(0,l.jsx)(a.A,{className:"h-5 w-5 rotate-45"}),(0,l.jsx)("span",{className:"text-xs font-bold hidden lg:block",children:"比例尺"})]}),(0,l.jsxs)("button",{onClick:()=>S(e=>({...e,mode:"measureLine"})),className:(0,p.cn)("p-2 rounded-lg transition-colors flex items-center gap-2","measureLine"===C.mode?"bg-cyan-600 text-white":"text-zinc-400 hover:bg-zinc-800"),disabled:!C.scaleSet,title:"測量長度",children:[(0,l.jsx)(s.A,{className:"h-5 w-5"}),(0,l.jsx)("span",{className:"text-xs font-bold hidden lg:block",children:"測距"})]}),(0,l.jsxs)("button",{onClick:()=>S(e=>({...e,mode:"drawBoundary"})),className:(0,p.cn)("p-2 rounded-lg transition-colors flex items-center gap-2","drawBoundary"===C.mode?"bg-violet-600 text-white":"text-zinc-400 hover:bg-zinc-800"),title:"外框（牆）",children:[(0,l.jsx)(d,{className:"h-5 w-5"}),(0,l.jsx)("span",{className:"text-xs font-bold hidden lg:block",children:"外框"})]}),(0,l.jsxs)("button",{onClick:()=>S(e=>({...e,mode:"drawRoom"})),className:(0,p.cn)("p-2 rounded-lg transition-colors flex items-center gap-2","drawRoom"===C.mode?"bg-emerald-600 text-white":"text-zinc-400 hover:bg-zinc-800"),title:"空間範圍",children:[(0,l.jsx)(d,{className:"h-5 w-5"}),(0,l.jsx)("span",{className:"text-xs font-bold hidden lg:block",children:"空間"})]}),(0,l.jsxs)("button",{onClick:()=>S(e=>({...e,mode:"drawWall"})),className:(0,p.cn)("p-2 rounded-lg transition-colors flex items-center gap-2","drawWall"===C.mode?"bg-sky-600 text-white":"text-zinc-400 hover:bg-zinc-800"),title:"內牆",children:[(0,l.jsx)(d,{className:"h-5 w-5"}),(0,l.jsx)("span",{className:"text-xs font-bold hidden lg:block",children:"內牆"})]}),(0,l.jsxs)("button",{onClick:()=>S(e=>({...e,mode:"drawColumnRect"})),className:(0,p.cn)("p-2 rounded-lg transition-colors flex items-center gap-2","drawColumn"===C.mode||"drawColumnRect"===C.mode?"bg-slate-500 text-white":"text-zinc-400 hover:bg-zinc-800"),title:"柱子（矩形）",children:[(0,l.jsx)(c,{className:"h-5 w-5"}),(0,l.jsx)("span",{className:"text-xs font-bold hidden lg:block",children:"柱子"})]}),(0,l.jsxs)("button",{onClick:()=>S(e=>({...e,mode:"placeWindow"})),className:(0,p.cn)("p-2 rounded-lg transition-colors flex items-center gap-2","placeWindow"===C.mode?"bg-cyan-600 text-white":"text-zinc-400 hover:bg-zinc-800"),title:"窗戶",children:[(0,l.jsx)(u,{className:"h-5 w-5"}),(0,l.jsx)("span",{className:"text-xs font-bold hidden lg:block",children:"窗戶"})]}),(0,l.jsxs)("button",{onClick:()=>S(e=>({...e,mode:"placeFurniture"})),className:(0,p.cn)("p-2 rounded-lg transition-colors flex items-center gap-2","placeFurniture"===C.mode?"bg-amber-600 text-white":"text-zinc-400 hover:bg-zinc-800"),title:"放置家具",children:[(0,l.jsx)("span",{className:"text-xs font-bold hidden lg:block",children:"家具"}),(0,l.jsx)("span",{className:"text-xs font-bold",children:"+F"})]}),(0,l.jsxs)("button",{onClick:()=>S(e=>({...e,mode:"select"})),className:(0,p.cn)("p-2 rounded-lg transition-colors flex items-center gap-2","select"===C.mode?"bg-slate-600 text-white":"text-zinc-400 hover:bg-zinc-800"),title:"選取/編輯",children:[(0,l.jsx)(a.A,{className:"h-5 w-5"}),(0,l.jsx)("span",{className:"text-xs font-bold hidden lg:block",children:"選取"})]}),(0,l.jsx)("div",{className:"h-6 w-px bg-white/10 mx-1"}),(0,l.jsxs)("button",{onClick:()=>S(e=>({...e,isOrtho:!e.isOrtho})),className:(0,p.cn)("p-2 rounded-lg transition-colors flex items-center gap-2",C.isOrtho?"bg-purple-600 text-white":"text-zinc-400 hover:bg-zinc-800"),title:"垂直/水平鎖定 (Shift)",children:[(0,l.jsx)(a.A,{className:"h-5 w-5"}),(0,l.jsx)("span",{className:"text-xs font-bold hidden lg:block",children:"正交"})]}),(0,l.jsx)("div",{className:"h-6 w-px bg-white/10 mx-1"}),(0,l.jsx)("button",{onClick:()=>{z.current.zoomLevel=Math.min(1.1*z.current.zoomLevel,5),S(e=>({...e,zoomDisplay:Math.round(100*z.current.zoomLevel)})),G()},className:"p-2 text-zinc-400 hover:bg-zinc-800 rounded-lg transition-colors",title:"放大",children:(0,l.jsx)(x.A,{className:"h-5 w-5"})}),(0,l.jsx)("button",{onClick:()=>{z.current.zoomLevel=Math.max(z.current.zoomLevel/1.1,.2),S(e=>({...e,zoomDisplay:Math.round(100*z.current.zoomLevel)})),G()},className:"p-2 text-zinc-400 hover:bg-zinc-800 rounded-lg transition-colors",title:"縮小",children:(0,l.jsx)(h.A,{className:"h-5 w-5"})}),(0,l.jsx)("div",{className:"h-6 w-px bg-white/10 mx-1"}),(0,l.jsx)("button",{onClick:()=>{confirm("清除所有繪製？")&&(z.current.measureLines=[],z.current.wallPaths=[],z.current.rooms=[],z.current.columns=[],z.current.windows=[],z.current.furniture=[],z.current.scale=null,J(null),S(e=>({...e,scaleSet:!1,infoText:"已清除，請重新設定比例尺"})),G())},className:"p-2 text-red-400 hover:bg-red-500/10 rounded-lg transition-colors",title:"全部清除",children:(0,l.jsx)(m.A,{className:"h-5 w-5"})}),(0,l.jsxs)("div",{className:"flex items-center gap-2 pl-2",children:[(0,l.jsx)("span",{className:"text-xs text-zinc-400",children:"圖片透明度"}),(0,l.jsx)("input",{type:"range",min:.1,max:1,step:.05,value:C.imageOpacity,onChange:e=>S(t=>({...t,imageOpacity:parseFloat(e.target.value)})),className:"w-24"})]})]}),eS&&(0,l.jsxs)("div",{className:"absolute top-20 left-4 right-4 z-10 bg-zinc-900/90 border border-white/10 rounded-xl shadow-xl p-3 flex gap-4 overflow-x-auto items-start",children:[eN&&(0,l.jsxs)("div",{className:"min-w-[240px] flex-shrink-0",children:[(0,l.jsx)("h3",{className:"text-sm font-semibold text-white",children:"柱子"}),(0,l.jsxs)("div",{className:"mt-2 space-y-2 text-xs",children:[(0,l.jsxs)("div",{className:"flex items-center gap-2",children:[(0,l.jsx)("button",{type:"button",onClick:()=>S(e=>({...e,mode:"drawColumnRect"})),className:(0,p.cn)("rounded-lg border px-2 py-1","drawColumnRect"===C.mode?"border-slate-400/40 bg-slate-500/20 text-slate-100":"border-white/10 text-zinc-300 hover:border-white/20"),children:"矩形柱子"}),(0,l.jsx)("button",{type:"button",onClick:()=>S(e=>({...e,mode:"drawColumn"})),className:(0,p.cn)("rounded-lg border px-2 py-1","drawColumn"===C.mode?"border-slate-400/40 bg-slate-500/20 text-slate-100":"border-white/10 text-zinc-300 hover:border-white/20"),children:"手繪柱子"})]}),0===z.current.columns.length?(0,l.jsx)("p",{className:"text-xs text-zinc-500",children:"尚未新增柱子"}):z.current.columns.map((e,t)=>{let n=em?F(e.points)/(eh*eh):null;return(0,l.jsxs)("div",{className:"rounded-lg border border-white/10 bg-zinc-950/40 p-2 flex items-center justify-between gap-2",children:[(0,l.jsxs)("div",{className:"text-[11px] text-zinc-300",children:[(0,l.jsxs)("div",{children:["柱子 ",t+1]}),(0,l.jsx)("div",{className:"text-zinc-500",children:null!==n?`${(n/1e4).toFixed(2)} ㎡ / ${(n/33057.9).toFixed(2)} 坪`:"-"})]}),(0,l.jsx)("button",{type:"button",onClick:()=>{z.current.columns=z.current.columns.filter(t=>t.id!==e.id),G()},className:"text-[11px] text-red-300 hover:text-red-200",children:"刪除"})]},e.id)}),ec&&(0,l.jsxs)("div",{className:"rounded-lg border border-white/10 bg-zinc-950/40 p-2 space-y-2",children:[(0,l.jsx)("div",{className:"text-[11px] text-zinc-300",children:"選取柱子調整尺寸"}),em?(e=ec.points.map(e=>e.x),t=ec.points.map(e=>e.y),n=Math.min(...e),o=Math.max(...e),y=Math.min(...t),b=Math.max(...t),v=(o-n)/(eh||1),k=(b-y)/(eh||1),(0,l.jsxs)("div",{className:"space-y-2",children:[(0,l.jsxs)("label",{className:"flex items-center justify-between gap-2",children:[(0,l.jsx)("span",{className:"text-zinc-400",children:"寬 (cm)"}),(0,l.jsx)("input",{type:"number",min:10,value:Number(v.toFixed(1)),onChange:e=>{let t=parseFloat(e.target.value||`${v}`);if(!eh)return;let l=(n+o)/2,i=t*eh;ec.points=[{x:l-i/2,y:y},{x:l+i/2,y:y},{x:l+i/2,y:b},{x:l-i/2,y:b}],G()},className:"w-20 bg-zinc-900 border border-white/10 rounded px-2 py-1 text-white"})]}),(0,l.jsxs)("label",{className:"flex items-center justify-between gap-2",children:[(0,l.jsx)("span",{className:"text-zinc-400",children:"高 (cm)"}),(0,l.jsx)("input",{type:"number",min:10,value:Number(k.toFixed(1)),onChange:e=>{let t=parseFloat(e.target.value||`${k}`);if(!eh)return;let l=(y+b)/2,i=t*eh;ec.points=[{x:n,y:l-i/2},{x:o,y:l-i/2},{x:o,y:l+i/2},{x:n,y:l+i/2}],G()},className:"w-20 bg-zinc-900 border border-white/10 rounded px-2 py-1 text-white"})]})]})):(0,l.jsx)("p",{className:"text-[11px] text-zinc-500",children:"請先設定比例尺後調整尺寸"})]})]})]}),ez&&(0,l.jsxs)("div",{className:"min-w-[240px] flex-shrink-0",children:[(0,l.jsx)("h3",{className:"text-sm font-semibold text-white",children:"窗戶"}),(0,l.jsxs)("div",{className:"mt-2 space-y-2 text-xs",children:[(0,l.jsxs)("label",{className:"flex items-center justify-between gap-2",children:[(0,l.jsx)("span",{className:"text-zinc-400",children:"預設類型"}),(0,l.jsxs)("select",{value:C.windowType,onChange:e=>S(t=>({...t,windowType:e.target.value})),className:"bg-zinc-900 border border-white/10 rounded px-2 py-1 text-white",children:[(0,l.jsx)("option",{value:"sliding",children:"橫拉窗"}),(0,l.jsx)("option",{value:"casement",children:"推窗"})]})]}),(0,l.jsxs)("label",{className:"flex items-center justify-between gap-2",children:[(0,l.jsx)("span",{className:"text-zinc-400",children:"預設寬度 (cm)"}),(0,l.jsx)("input",{type:"number",min:30,value:C.windowWidthCm,onChange:e=>S(t=>({...t,windowWidthCm:parseFloat(e.target.value||"0")})),className:"w-20 bg-zinc-900 border border-white/10 rounded px-2 py-1 text-white"})]}),ed&&(0,l.jsxs)("div",{className:"space-y-2",children:[(0,l.jsxs)("label",{className:"flex items-center justify-between gap-2",children:[(0,l.jsx)("span",{className:"text-zinc-400",children:"選取類型"}),(0,l.jsxs)("select",{value:ed.type,onChange:e=>{ed.type=e.target.value,G()},className:"bg-zinc-900 border border-white/10 rounded px-2 py-1 text-white",children:[(0,l.jsx)("option",{value:"sliding",children:"橫拉窗"}),(0,l.jsx)("option",{value:"casement",children:"推窗"})]})]}),(0,l.jsxs)("label",{className:"flex items-center justify-between gap-2",children:[(0,l.jsx)("span",{className:"text-zinc-400",children:"選取窗寬 (cm)"}),(0,l.jsx)("input",{type:"number",min:30,value:ed.widthCm,onChange:e=>{let t=parseFloat(e.target.value||"");Number.isFinite(t)&&(ed.widthCm=t,ea(ed),G())},className:"w-20 bg-zinc-900 border border-white/10 rounded px-2 py-1 text-white"})]})]}),(0,l.jsx)("p",{className:"text-[11px] text-zinc-500",children:"在外框線上點擊新增窗戶，可拖曳位置，拖曳端點或 Shift+拖曳調整尺寸"}),ed&&(0,l.jsx)("button",{type:"button",onClick:()=>{z.current.windows=z.current.windows.filter(e=>e.id!==ed.id),J(null),G()},className:"w-full rounded-lg border border-red-500/30 text-red-200 hover:bg-red-500/10 px-2 py-1.5",children:"刪除選取窗戶"})]})]}),eC&&(0,l.jsxs)("div",{className:"min-w-[240px] flex-shrink-0",children:[(0,l.jsx)("h3",{className:"text-sm font-semibold text-white",children:"家具"}),(0,l.jsx)("div",{className:"grid grid-cols-2 gap-2 mt-2",children:f.map(e=>(0,l.jsx)("button",{onClick:()=>S(t=>({...t,mode:"placeFurniture",selectedFurnitureType:e.type})),className:(0,p.cn)("text-xs rounded-lg border px-2 py-1.5",C.selectedFurnitureType===e.type&&"placeFurniture"===C.mode?"border-amber-400 bg-amber-500/10 text-amber-200":"border-white/10 text-zinc-400 hover:border-white/20"),children:e.label},e.type))}),eo&&(0,l.jsxs)("div",{className:"mt-3 space-y-2 text-xs",children:[(0,l.jsxs)("label",{className:"flex items-center justify-between gap-2",children:[(0,l.jsx)("span",{className:"text-zinc-400",children:"旋轉"}),(0,l.jsx)("input",{type:"range",min:0,max:360,value:180*eo.rotation/Math.PI,onChange:e=>{eo.rotation=parseFloat(e.target.value)*Math.PI/180,G()},className:"w-32"})]}),(0,l.jsxs)("label",{className:"flex items-center justify-between gap-2",children:[(0,l.jsx)("span",{className:"text-zinc-400",children:"縮放"}),(0,l.jsx)("input",{type:"range",min:.4,max:2,step:.05,value:eo.scale,onChange:e=>{eo.scale=parseFloat(e.target.value),G()},className:"w-32"})]})]})]})]}),(0,l.jsx)("div",{className:"absolute top-4 right-4 z-10 bg-black/60 backdrop-blur px-3 py-1.5 rounded-full border border-white/10 text-xs text-zinc-300",children:C.infoText}),(0,l.jsx)("canvas",{ref:P,className:(0,p.cn)("w-full h-full bg-zinc-950 cursor-crosshair touch-none",z.current.isPanning?"cursor-grab active:cursor-grabbing":""),onMouseDown:e=>{let t=z.current,n=P.current?.getBoundingClientRect();if(!n)return;let l=L({x:e.clientX-n.left,y:e.clientY-n.top});if(t.pointerWorld=l,0!==e.button)return;if(t.isSpacePressed){t.isPanning=!0,t.panStart={x:e.clientX,y:e.clientY};return}let i=t.snappedPoint?{...t.snappedPoint}:l;if("drawWall"===C.mode&&(i=q(i,!0)),("drawBoundary"===C.mode||"drawWall"===C.mode||"drawRoom"===C.mode||"drawColumn"===C.mode)&&(t.isShiftPressed||t.isOrthoMode)&&t.drawingPoints.length>0){let e=t.drawingPoints[t.drawingPoints.length-1];t.startPoint=X(e,i)}else t.startPoint=i;if("select"===C.mode||"placeFurniture"===C.mode||"placeWindow"===C.mode){if(((e,t)=>{let n,l,i,r,a=z.current,s=(e=>{let t=z.current,n=12/t.zoomLevel;for(let l of t.windows){let t=er(l);if(!t)continue;let i=W(e,t.start),r=W(e,t.end);if(i<n)return{window:l,handle:"start"};if(r<n)return{window:l,handle:"end"}}return null})(e);if(s){let{window:e,handle:t}=s,n=_();if(n){let l=W(n.points[e.segmentIndex],n.points[(e.segmentIndex+1)%n.points.length])||1,i=z.current.scale??1,r=e.widthCm*i/(2*l);return a.dragStartWindow={startT:e.t-r,endT:e.t+r,segmentIndex:e.segmentIndex},a.draggingWindowId=e.id,a.draggingWindowHandle=t,J({kind:"window",id:e.id}),G(),!0}}let o=(e=>{let t=z.current,n=6/t.zoomLevel;for(let l of t.windows){let t=er(l);if(!t)continue;let i=e.x-t.center.x,r=e.y-t.center.y,a=i*t.ux+r*t.uy,s=i*t.inward.x+r*t.inward.y;if(Math.abs(a)<=t.widthPx/2+n&&Math.abs(s)<=t.thicknessPx/2+n)return l}return null})(e);if(o)return J({kind:"window",id:o.id}),a.draggingWindowId=o.id,a.draggingWindowHandle=null,G(),!0;let d=(e=>{for(let t of z.current.furniture){let n=$(t);if(e.x>=n.minX&&e.x<=n.maxX&&e.y>=n.minY&&e.y<=n.maxY)return t}return null})(e);if(d)return J({kind:"furniture",id:d.id}),a.draggingFurnitureId=d.id,a.dragStartMouse={x:e.x,y:e.y},a.dragStartFurniturePos={...d.position},G(),!0;let c=(e=>{for(let t of z.current.columns)if(A(e,t.points))return t;return null})(e);if(c)return J({kind:"column",id:c.id}),a.draggingColumnId=c.id,a.dragStartMouse={x:e.x,y:e.y},a.dragStartColumnPoints=c.points.map(e=>({...e})),G(),!0;let u=(l=10/(n=z.current).zoomLevel,i=null,r=l,n.wallPaths.forEach(t=>{let n=t.isBoundary?t.points.length:t.points.length-1;for(let l=0;l<n;l++){let n=t.points[l],a=t.points[(l+1)%t.points.length],s=R(e,n,a);if(s<r){r=s;let o=O(e,n,a);i={pathId:t.id,segmentIndex:l,point:o.point}}}}),i);if(u){if(t.altKey){let e=a.wallPaths.find(e=>e.id===u.pathId);if(e){e.points.splice(u.segmentIndex+1,0,u.point);let t=e.segments[u.segmentIndex];e.segments.splice(u.segmentIndex,1,{...t},{...t}),S(e=>({...e,infoText:"已分割線段"})),G()}return!0}J({kind:"wall",pathId:u.pathId,segmentIndex:u.segmentIndex});let n=a.wallPaths.find(e=>e.id===u.pathId);return n&&!n.isBoundary&&(a.draggingWallPathId=n.id,a.dragStartWallMouse={x:e.x,y:e.y},a.dragStartWallPoints=n.points.map(e=>({...e}))),G(),!0}let x=(e=>{for(let t of z.current.rooms)if(A(e,t.points))return t;return null})(e);return!!x&&(J({kind:"room",id:x.id}),a.draggingRoomId=x.id,a.dragStartMouse={x:e.x,y:e.y},a.dragStartRoomPoints=x.points.map(e=>({...e})),G(),!0)})(l,e))return;if("select"===C.mode){J(null),G();return}}if("drawWall"===C.mode){t.drawing=!0,0===t.drawingPoints.length&&(t.usedOrthoDuringDraw=!1),t.drawingPoints.push(t.startPoint),t.endPoint={...t.startPoint},t.drawingPoints.length>=2?Z():G();return}if("drawBoundary"===C.mode||"drawRoom"===C.mode||"drawColumn"===C.mode){t.drawing=!0,0===t.drawingPoints.length&&(t.usedOrthoDuringDraw=!1),t.drawingPoints.push(t.startPoint),t.endPoint={...t.startPoint},G();return}if("drawColumnRect"===C.mode){t.drawing=!0,t.usedOrthoDuringDraw=!1,t.endPoint={...t.startPoint},G();return}if("placeWindow"===C.mode){let e=(e=>{let t=z.current,n=_();if(!n)return null;let l=1/0,i=null,r=n.points.length,a=K()?.polygon,s=a&&a.length===r;for(let o=0;o<r;o++){let d=n.points[o],c=n.points[(o+1)%r],u=R(e,d,c),x=u,h=t.scale?(n.segments[o]?.thicknessCm??C.wallThicknessDefault)*t.scale:12,m=Math.max(12/t.zoomLevel,1.2*h);if(s&&(x=Math.min(u,R(e,a[o],a[(o+1)%r]))),x<=m&&x<l){l=x;let t=O(e,d,c);i={segmentIndex:o,point:t.point,t:t.t}}}return i})(l),n=_();if(!n)return void S(e=>({...e,infoText:"請先繪製外框再放置窗戶"}));if(e){let l={id:w(),pathId:n.id,segmentIndex:e.segmentIndex,t:e.t,widthCm:C.windowWidthCm,type:C.windowType};ea(l),t.windows.push(l),J({kind:"window",id:l.id}),G()}return}if("placeFurniture"===C.mode){let e={id:w(),type:C.selectedFurnitureType,position:t.startPoint,rotation:0,scale:1};t.furniture.push(e),J({kind:"furniture",id:e.id}),G();return}("measureLine"===C.mode||"setScale"===C.mode)&&(t.drawing=!0,t.endPoint={...t.startPoint},G())},onMouseMove:e=>{let t,n,l,i,r,a=z.current,s=P.current?.getBoundingClientRect();if(!s)return;let o=e.clientX-s.left,d=e.clientY-s.top;if(a.isPanning){let t=e.clientX-a.panStart.x,n=e.clientY-a.panStart.y;a.panOffset.x+=t,a.panOffset.y+=n,a.panStart={x:e.clientX,y:e.clientY},G();return}let c=L({x:o,y:d});if("select"===C.mode){if(a.draggingFurnitureId){let e=a.furniture.find(e=>e.id===a.draggingFurnitureId);e&&(e.position={x:a.dragStartFurniturePos.x+(c.x-a.dragStartMouse.x),y:a.dragStartFurniturePos.y+(c.y-a.dragStartMouse.y)},G());return}if(a.draggingWindowId){let e=a.windows.find(e=>e.id===a.draggingWindowId),t=_();if(e&&t){let n=t.points[e.segmentIndex],l=t.points[(e.segmentIndex+1)%t.points.length],i=O(c,n,l);if(a.draggingWindowHandle&&a.dragStartWindow){let t=a.dragStartWindow.startT,r=a.dragStartWindow.endT;if("start"===a.draggingWindowHandle?t=i.t:r=i.t,t>r){let e=t;t=r,r=e}let s=W(n,l)||1,o=a.scale??1;r-t<.02&&(r=t+.02),e.t=(t+r)/2,e.widthCm=(r-t)*s/o}else if(a.isShiftPressed){let t=W(n,l)||1,r=a.scale??1,s=Math.max(.02,Math.abs(i.t-e.t));e.widthCm=2*s*t/r}else e.t=i.t;ea(e),G()}return}if(a.draggingRoomId){let e=a.rooms.find(e=>e.id===a.draggingRoomId);if(e){let t=c.x-a.dragStartMouse.x,n=c.y-a.dragStartMouse.y;e.points=a.dragStartRoomPoints.map(e=>({x:e.x+t,y:e.y+n})),G()}return}if(a.draggingColumnId){let e=a.columns.find(e=>e.id===a.draggingColumnId);if(e){let t=c.x-a.dragStartMouse.x,n=c.y-a.dragStartMouse.y;e.points=a.dragStartColumnPoints.map(e=>({x:e.x+t,y:e.y+n})),G()}return}if(a.draggingWallPathId){let e=a.wallPaths.find(e=>e.id===a.draggingWallPathId);if(e){let t=c.x-a.dragStartWallMouse.x,n=c.y-a.dragStartWallMouse.y;e.points=a.dragStartWallPoints.map(e=>({x:e.x+t,y:e.y+n})),G()}return}}n=15/(t=z.current).zoomLevel,l=null,i=e=>{let t=W(c,e);t<n&&(n=t,l=e)},t.wallPaths.forEach(e=>e.points.forEach(e=>i(e))),t.rooms.forEach(e=>e.points.forEach(e=>i(e))),t.columns.forEach(e=>e.points.forEach(e=>i(e))),t.drawingPoints.forEach(e=>i(e)),(r=K()?.polygon)&&r.forEach(e=>i(e)),t.snappedPoint=l;let u=a.snappedPoint?{...a.snappedPoint}:c;if(a.drawing&&(a.isShiftPressed||a.isOrthoMode)){a.usedOrthoDuringDraw=!0;let e=a.startPoint;("drawBoundary"===C.mode||"drawWall"===C.mode||"drawRoom"===C.mode||"drawColumn"===C.mode)&&a.drawingPoints.length>0&&(e=a.drawingPoints[a.drawingPoints.length-1]),u=X(e,u)}a.endPoint=u,G()},onMouseUp:()=>{let e=z.current;if(e.isPanning){e.isPanning=!1;return}if(e.draggingFurnitureId){e.draggingFurnitureId=null;return}if(e.draggingWindowId){e.draggingWindowId=null,e.draggingWindowHandle=null,e.dragStartWindow=null;return}if(e.draggingRoomId){e.draggingRoomId=null,e.dragStartRoomPoints=[];return}if(e.draggingColumnId){let t=e.columns.find(t=>t.id===e.draggingColumnId);t&&(t.points=V(t.points)),e.draggingColumnId=null,e.dragStartColumnPoints=[];return}if(e.draggingWallPathId){let t=e.wallPaths.find(t=>t.id===e.draggingWallPathId);t&&(t.points=t.points.map(e=>q(e,!0))),e.draggingWallPathId=null,e.dragStartWallPoints=[];return}if(!e.drawing)return;if("drawBoundary"===C.mode){if(e.drawingPoints.length>=2){let t=e.drawingPoints[0],n=15/e.zoomLevel;W(e.endPoint,t)<n&&Q()}return}if("drawRoom"===C.mode){if(e.drawingPoints.length>=2){let t=e.drawingPoints[0],n=15/e.zoomLevel;W(e.endPoint,t)<n&&ee()}return}if("drawColumn"===C.mode){if(e.drawingPoints.length>=2){let t=e.drawingPoints[0],n=15/e.zoomLevel;W(e.endPoint,t)<n&&et()}return}if("drawColumnRect"===C.mode)return void en();if("drawWall"===C.mode){1===e.drawingPoints.length&&W(e.startPoint,e.endPoint)>1/e.zoomLevel&&(e.drawingPoints.push(e.endPoint),Z());return}let t=W(e.startPoint,e.endPoint);if(!(t<1/e.zoomLevel)){if("setScale"===C.mode){let n=parseFloat(prompt("請輸入這段距離的實際長度(公分) e.g. 100","100")||"");n>0&&(e.scale=t/n,e.measureLines.push({type:"line",pixelStart:e.startPoint,pixelEnd:e.endPoint,color:"#06b6d4"}),S(t=>({...t,scaleSet:!0,mode:null,infoText:`比例尺已設定: ${(e.scale||0).toFixed(2)} px/cm`})))}else"measureLine"===C.mode&&e.scale&&e.measureLines.push({type:"line",pixelStart:e.startPoint,pixelEnd:e.endPoint,color:"#facc15"});e.drawing=!1,G()}},onContextMenu:e=>{e.preventDefault();let t=z.current;"drawBoundary"===C.mode?Q():"drawWall"===C.mode?Z():"drawRoom"===C.mode?ee():"drawColumn"===C.mode?et():"drawColumnRect"===C.mode?en():(t.drawingPoints=[],t.drawing=!1,G())}}),(0,l.jsx)("div",{className:"absolute bottom-4 left-4 text-[10px] text-zinc-500 pointer-events-none bg-black/40 p-2 rounded-lg backdrop-blur-sm border border-white/5",children:(0,l.jsx)("p",{children:"Esc: 選取 | Delete: 刪除 | 左鍵: 繪圖 | 右鍵/Enter: 結束 | Shift: 正交/調整窗寬 | 方向鍵: 微調外牆段 | Shift+方向鍵: 快速微調 | 空白鍵: 平移 | Alt+點牆段: 分割 | 拖曳: 內牆/窗戶/空間/柱子"})})]}),(0,l.jsxs)("div",{className:"w-80 shrink-0 h-full overflow-y-auto bg-zinc-900/80 border border-white/5 rounded-xl shadow-xl p-4 space-y-4",children:[(0,l.jsxs)("div",{children:[(0,l.jsx)("h3",{className:"text-sm font-semibold text-white",children:"使用流程"}),(0,l.jsx)("div",{className:"mt-2 space-y-2 text-xs",children:ej.map(e=>(0,l.jsxs)("div",{className:"flex items-center justify-between gap-2",children:[(0,l.jsxs)("div",{className:"flex items-center gap-2",children:[(0,l.jsx)("span",{className:(0,p.cn)("h-2.5 w-2.5 rounded-full",e.done?"bg-emerald-400":"bg-zinc-600")}),(0,l.jsx)("span",{className:e.done?"text-emerald-200":"text-zinc-300",children:e.label})]}),"upload"===e.action?(0,l.jsx)("label",{htmlFor:"fp-upload",className:"cursor-pointer rounded-full border border-white/10 px-2 py-0.5 text-[11px] text-zinc-300 hover:border-white/20",children:"上傳"}):(0,l.jsx)("button",{type:"button",onClick:e.action,className:"rounded-full border border-white/10 px-2 py-0.5 text-[11px] text-zinc-300 hover:border-white/20",children:"前往"})]},e.id))})]}),(0,l.jsxs)("div",{children:[(0,l.jsx)("h3",{className:"text-sm font-semibold text-white",children:"圖面備註"}),(0,l.jsxs)("div",{className:"mt-2 space-y-2 text-xs",children:[(0,l.jsxs)("label",{className:"flex items-center justify-between gap-2",children:[(0,l.jsx)("span",{className:"text-zinc-400",children:"圖面類型"}),(0,l.jsxs)("select",{value:C.planType,onChange:e=>S(t=>({...t,planType:e.target.value})),className:"bg-zinc-900 border border-white/10 rounded px-2 py-1 text-white",children:[(0,l.jsx)("option",{value:"indoor",children:"家配圖（室內）"}),(0,l.jsx)("option",{value:"public",children:"公設圖"})]})]}),(0,l.jsxs)("div",{children:[(0,l.jsx)("span",{className:"text-zinc-400",children:"備註"}),(0,l.jsx)("textarea",{value:C.planNote,onChange:e=>S(t=>({...t,planNote:e.target.value})),rows:2,className:"mt-1 w-full bg-zinc-900 border border-white/10 rounded px-2 py-1 text-white text-xs",placeholder:"例如：客變版本 / 家配圖"})]})]})]}),(0,l.jsxs)("div",{children:[(0,l.jsx)("h3",{className:"text-sm font-semibold text-white",children:"外框 / 淨面積"}),(0,l.jsx)("p",{className:"text-xs text-zinc-400",children:"外框牆厚可在選取牆段後調整"}),(0,l.jsxs)("div",{className:"mt-2 flex items-center justify-between text-xs",children:[(0,l.jsx)("span",{className:"text-zinc-400",children:"預設牆厚 (cm)"}),(0,l.jsx)("input",{type:"number",min:1,value:C.wallThicknessDefault,onChange:e=>S(t=>({...t,wallThicknessDefault:parseFloat(e.target.value||"0")})),className:"w-20 bg-zinc-900 border border-white/10 rounded px-2 py-1 text-white"})]}),(0,l.jsxs)("div",{className:"mt-2 flex items-center justify-between text-xs",children:[(0,l.jsx)("span",{className:"text-zinc-400",children:"外框填色"}),(0,l.jsx)("input",{type:"color",value:C.boundaryFillColor,onChange:e=>S(t=>({...t,boundaryFillColor:e.target.value})),className:"h-6 w-10 bg-transparent border border-white/10 rounded"})]}),(0,l.jsxs)("div",{className:"mt-2 flex items-center justify-between text-xs",children:[(0,l.jsx)("span",{className:"text-zinc-400",children:"外框透明度"}),(0,l.jsx)("input",{type:"range",min:0,max:.6,step:.05,value:C.boundaryFillOpacity,onChange:e=>S(t=>({...t,boundaryFillOpacity:parseFloat(e.target.value)})),className:"w-24"})]}),em?(0,l.jsxs)("div",{className:"mt-2 space-y-1 text-xs text-zinc-200",children:[(0,l.jsxs)("div",{children:["外框淨面積：",ek(ep)]}),(0,l.jsxs)("div",{children:["內框淨面積：",ek(ey)]}),(0,l.jsxs)("div",{children:["柱子面積：",ek(ew)]})]}):(0,l.jsx)("p",{className:"mt-2 text-xs text-zinc-500",children:"尚未設定外框或比例尺"})]}),(0,l.jsxs)("div",{children:[(0,l.jsx)("h3",{className:"text-sm font-semibold text-white",children:"房間列表"}),(0,l.jsx)("div",{className:"mt-2 space-y-2 max-h-48 overflow-auto",children:0===z.current.rooms.length?(0,l.jsx)("p",{className:"text-xs text-zinc-500",children:"尚未新增空間"}):z.current.rooms.map(e=>{let t=z.current.scale?F(e.points)/(z.current.scale*z.current.scale):null,n=null!==t?t/1e4:null,i=null!==t?t/33057.9:null;return(0,l.jsxs)("div",{className:"rounded-lg border border-white/10 bg-zinc-950/40 p-2",children:[(0,l.jsx)("input",{value:e.name,onChange:t=>{e.name=t.target.value,G(),I(t=>t&&"room"===t.kind&&t.id===e.id?{...t}:t)},className:"w-full bg-transparent text-xs text-white mb-1 outline-none border-b border-white/10"}),(0,l.jsxs)("div",{className:"text-[11px] text-zinc-400 flex flex-col gap-0.5",children:[(0,l.jsxs)("span",{children:["坪數：",null!==i?i.toFixed(2):"-"]}),(0,l.jsxs)("span",{children:["平方公尺：",null!==n?n.toFixed(2):"-"]}),(0,l.jsxs)("span",{children:["面積：",null!==t?t.toFixed(0):"-"]})]})]},e.id)})})]}),(0,l.jsxs)("div",{children:[(0,l.jsx)("h3",{className:"text-sm font-semibold text-white",children:"報表輸出"}),(0,l.jsxs)("div",{className:"mt-2 flex flex-wrap gap-2",children:[(0,l.jsx)("button",{type:"button",onClick:()=>{var e,t;let n,l=P.current;if(!l)return;let i=eg.slice(0,10),r=Math.max(0,eg.length-i.length),a=190+18*i.length+18*!!r,s=document.createElement("canvas");s.width=l.width+64,s.height=l.height+64+48+a;let o=s.getContext("2d");if(!o)return;o.fillStyle="#0b0c10",o.fillRect(0,0,s.width,s.height),o.fillStyle="#e5e7eb",o.font="bold 20px sans-serif",o.fillText("平面圖測量報表",32,52),o.font="12px sans-serif",o.fillStyle="#94a3b8",o.fillText(new Date().toLocaleString("zh-TW"),32,68),o.fillText(`圖面類型：${"public"===C.planType?"公設圖":"家配圖(室內)"}`,32,84),C.planNote.trim()&&o.fillText(`備註：${C.planNote.trim()}`,32,100),o.strokeStyle="#1f2937",o.lineWidth=2,o.strokeRect(32,80,l.width,l.height),o.drawImage(l,32,80);let d=80+l.height+28;o.fillStyle="#e5e7eb",o.font="bold 14px sans-serif",o.fillText("面積統計",32,d),d+=18,o.font="12px sans-serif";let c=e=>null==e?"-":`${(e/33057.9).toFixed(2)} 坪 / ${(e/1e4).toFixed(2)} ㎡`;o.fillStyle="#cbd5f5",o.fillText(`外框淨面積：${c(eu?.areaCm2??null)}`,32,d),d+=16,o.fillText(`柱子面積：${c(ef)}`,32,d),d+=16,o.fillText(`內牆面積：${c(eb)}`,32,d),d+=16,o.fillText(`可用面積：${c(ev)}`,32,d),d+=22,o.fillStyle="#e5e7eb",o.font="bold 14px sans-serif",o.fillText("空間明細",32,d),d+=18,o.font="12px sans-serif",o.fillStyle="#cbd5f5",i.forEach(e=>{let t=e.areaCm2,n=null!==t?t/1e4:null,l=null!==t?t/33057.9:null;o.fillText(`${e.room.name} - ${null!==l?l.toFixed(2):"-"} 坪 / ${null!==n?n.toFixed(2):"-"} ㎡`,32,d),d+=16}),r&&(o.fillStyle="#94a3b8",o.fillText(`... 另有 ${r} 個空間`,32,d)),e=s.toDataURL("image/png"),t=`平面圖_報表_${Date.now()}.png`,(n=document.createElement("a")).href=e,n.download=t,n.click()},className:"rounded-lg border border-emerald-400/30 bg-emerald-500/10 px-3 py-1.5 text-xs text-emerald-200 hover:bg-emerald-500/20",children:"匯出報表 PNG"}),(0,l.jsx)("button",{type:"button",onClick:()=>{var e,t;let n,l;0!==z.current.rooms.length&&(e=new Blob(["\uFEFF"+[["名稱","坪數","平方公尺","面積cm2"],...eg.map(e=>{let t=e.room,n=e.areaCm2,l=null!==n?n/1e4:null,i=null!==n?n/33057.9:null;return[t.name,null!==i?i.toFixed(2):"",null!==l?l.toFixed(2):"",null!==n?n.toFixed(0):""]})].map(e=>e.join(",")).join("\n")],{type:"text/csv;charset=utf-8;"}),t=`平面圖_房間表_${Date.now()}.csv`,n=URL.createObjectURL(e),(l=document.createElement("a")).href=n,l.download=t,l.click(),URL.revokeObjectURL(n))},className:"rounded-lg border border-white/10 px-3 py-1.5 text-xs text-zinc-200 hover:border-white/20",children:"匯出房間表 CSV"})]})]}),es&&(0,l.jsxs)("div",{children:[(0,l.jsx)("h3",{className:"text-sm font-semibold text-white",children:"牆段設定"}),(0,l.jsxs)("div",{className:"mt-2 space-y-2 text-xs",children:[(0,l.jsxs)("label",{className:"flex items-center justify-between gap-2",children:[(0,l.jsx)("span",{className:"text-zinc-400",children:"類型"}),(0,l.jsxs)("select",{value:es.segment.wallType,onChange:e=>{es.segment.wallType=e.target.value,G()},className:"bg-zinc-900 border border-white/10 rounded px-2 py-1 text-white",children:[(0,l.jsx)("option",{value:"wall",children:"牆"}),(0,l.jsx)("option",{value:"window",children:"窗"}),(0,l.jsx)("option",{value:"pillar",children:"柱"})]})]}),(0,l.jsxs)("label",{className:"flex items-center justify-between gap-2",children:[(0,l.jsx)("span",{className:"text-zinc-400",children:"牆厚 (cm)"}),(0,l.jsx)("input",{type:"number",min:1,value:es.segment.thicknessCm,onChange:e=>{let t=parseFloat(e.target.value||"0");if(es.path.isBoundary){let e=Number.isFinite(t)&&t>0?t:es.segment.thicknessCm;es.segment.thicknessCm=e}else es.segment.thicknessCm=parseFloat(e.target.value||"0");G()},className:"w-20 bg-zinc-900 border border-white/10 rounded px-2 py-1 text-white"})]}),!es.path.isBoundary&&(0,l.jsx)("button",{type:"button",onClick:()=>{es.path.offsetSide=-((es.path.offsetSide??1)*1),G()},className:"w-full rounded-lg border border-white/10 text-zinc-200 hover:border-white/20 px-2 py-1.5",children:"翻轉內牆方向"}),(0,l.jsx)("button",{type:"button",onClick:()=>{let e=es.path,t=es.segmentIndex,n=e.points[t],l=e.points[(t+1)%e.points.length],i={x:(n.x+l.x)/2,y:(n.y+l.y)/2};e.points.splice(t+1,0,i);let r=e.segments[t];e.segments.splice(t,1,{...r},{...r}),J({kind:"wall",pathId:e.id,segmentIndex:t}),G()},className:"w-full mt-1 rounded-lg border border-amber-500/30 text-amber-300 hover:bg-amber-500/10 px-2 py-1.5",children:"分割線段"}),(0,l.jsx)("p",{className:"text-[10px] text-zinc-500",children:"選取牆段後，按住 Alt 點擊線段可分割區間"})]})]}),eo&&(0,l.jsxs)("div",{children:[(0,l.jsx)("h3",{className:"text-sm font-semibold text-white",children:"家具設定"}),(0,l.jsxs)("div",{className:"mt-2 space-y-2 text-xs",children:[(0,l.jsxs)("label",{className:"flex items-center justify-between gap-2",children:[(0,l.jsx)("span",{className:"text-zinc-400",children:"旋轉"}),(0,l.jsx)("input",{type:"range",min:0,max:360,value:180*eo.rotation/Math.PI,onChange:e=>{eo.rotation=parseFloat(e.target.value)*Math.PI/180,G()},className:"w-32"})]}),(0,l.jsxs)("label",{className:"flex items-center justify-between gap-2",children:[(0,l.jsx)("span",{className:"text-zinc-400",children:"縮放"}),(0,l.jsx)("input",{type:"range",min:.4,max:2,step:.05,value:eo.scale,onChange:e=>{eo.scale=parseFloat(e.target.value),G()},className:"w-32"})]})]})]})]})]})}}}]);