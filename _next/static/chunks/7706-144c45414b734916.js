"use strict";(self.webpackChunk_N_E=self.webpackChunk_N_E||[]).push([[7706],{20871:(e,t,r)=>{r.d(t,{U:()=>u});var a=r(95155),s=r(12115),n=r(68605),i=r(47650),l=r(40980),o=r(60529);let c=({children:e,x:t,y:r,visible:n})=>{let[l,o]=(0,s.useState)(!1);return((0,s.useEffect)(()=>(o(!0),()=>o(!1)),[]),l&&n&&!("u"<typeof document))?(0,i.createPortal)((0,a.jsx)("div",{className:"fixed pointer-events-none z-[9999]",style:{left:t,top:r,transform:"translate(-50%, -100%) translateY(-12px)"},children:e}),document.body):null};function d({data:e,minPrice:t,maxPrice:r,interval:n,sizeMetric:i,onMinPriceChange:d,onMaxPriceChange:x,onIntervalChange:h,onSizeMetricChange:m}){let[u,p]=(0,s.useState)("natural"),[f,g]=(0,s.useState)(null),[b,j]=(0,s.useState)({x:0,y:0}),[v,w]=(0,s.useState)([]),y=(0,s.useRef)(null),[N,z]=(0,s.useState)({width:0,height:0});(0,s.useEffect)(()=>{if(!y.current)return;let e=()=>{y.current&&z({width:y.current.clientWidth,height:y.current.clientHeight})};e(),window.addEventListener("resize",e);let t=setTimeout(e,200);return()=>{window.removeEventListener("resize",e),clearTimeout(t)}},[]),(0,s.useEffect)(()=>{let e=e=>{"Escape"===e.key&&w([])};return window.addEventListener("keydown",e),()=>window.removeEventListener("keydown",e)},[]);let S=(e,t)=>{let r=e.currentTarget.getBoundingClientRect();j({x:r.left+r.width/2,y:r.top}),g(t)},{buckets:P,validBuckets:k,maxValue:M}=(0,s.useMemo)(()=>{if(!e||0===e.length)return{buckets:[],validBuckets:[],maxValue:0};let a=[];for(let e=t;e<r;e+=n)a.push({min:e,max:Math.min(e+n,r),label:`${e}-${Math.min(e+n,r)}`,count:0,totalArea:0,avgPrice:0,transactions:[]});e.forEach(e=>{let s=e["房屋單價(萬)"],i=e["房屋面積(坪)"]||0;if("number"!=typeof s||s<t||s>=r)return;let l=Math.floor((s-t)/n);l>=0&&l<a.length&&(a[l].count++,a[l].totalArea+=i,a[l].transactions.push(e))});let s=a.filter(e=>e.count>0),l=Math.max(...s.map(e=>"count"===i?e.count:e.totalArea));return{buckets:a,validBuckets:s,maxValue:l}},[e,t,r,n,i]);(0,s.useEffect)(()=>{let e=new Set(k.map(e=>e.label));w(t=>t.filter(t=>e.has(t)))},[k]);let{nodes:A,onMouseDown:C,dragId:E,consumeWasDragged:T}=((e,t,r,a,n,i)=>{let[l,o]=(0,s.useState)([]),c=(0,s.useRef)(null),d=(0,s.useRef)(null),x=(0,s.useRef)(null),h=(0,s.useRef)(!1),m=(0,s.useRef)(!1);return(0,s.useEffect)(()=>{if(!e.length||!t||!r)return;let s=t/2,i=r/2,l=e.map((e,t)=>{let r="count"===a?e.count:e.totalArea,s=n>0?30+r/n*80:30;return{id:e.label,value:r,radius:s/2,x:0,y:0,vx:0,vy:0,origIndex:t}});l.sort((e,t)=>e.value-t.value),l=l.map((e,t)=>{let r=2.39996*t,a=10*Math.sqrt(t)*2.5;return{...e,x:s+Math.cos(r)*a,y:i+Math.sin(r)*a}});for(let e=0;e<120;e++)for(let e=0;e<l.length;e++)for(let t=e+1;t<l.length;t++){let r=l[e],a=l[t],s=a.x-r.x,n=a.y-r.y,i=s*s+n*n,o=r.radius+a.radius+5;if(i<o*o&&i>0){let e=Math.sqrt(i),t=o-e,l=s/e,c=n/e,d=.5*t;r.x-=l*d,r.y-=c*d,a.x+=l*d,a.y+=c*d}}o(l)},[e,t,r,a,n]),(0,s.useEffect)(()=>{if(!i)return;let e=e=>{x.current={x:e.clientX,y:e.clientY},d.current&&Math.hypot(e.clientX-d.current.startX,e.clientY-d.current.startY)>4&&(h.current=!0)},t=()=>{m.current=h.current,h.current=!1,d.current=null,x.current=null};return window.addEventListener("mousemove",e),window.addEventListener("mouseup",t),()=>{window.removeEventListener("mousemove",e),window.removeEventListener("mouseup",t)}},[i]),(0,s.useEffect)(()=>{if(!i||0===l.length||!t)return;let e=t/2,a=r/2,s=()=>{o(t=>{let r=t.map(e=>({...e})),s=0,n=0,i=0,l=0;d.current&&x.current&&(s=x.current.x-d.current.startX,n=x.current.y-d.current.startY,i=d.current.nodeOrigX+s,l=d.current.nodeOrigY+n),r.forEach(t=>{if(d.current?.id===t.id)t.x=i,t.y=l,t.vx=0,t.vy=0;else{let r=e-t.x,s=a-t.y;t.vx+=.05*r*.05,t.vy+=.05*s*.05,t.vx+=(Math.random()-.5)*.003,t.vy+=(Math.random()-.5)*.003,t.x+=t.vx,t.y+=t.vy,t.vx*=.94,t.vy*=.94}});for(let e=0;e<6;e++)for(let e=0;e<r.length;e++)for(let t=e+1;t<r.length;t++){let a=r[e],s=r[t],n=d.current?.id===a.id,i=d.current?.id===s.id,l=s.x-a.x,o=s.y-a.y,c=l*l+o*o,x=a.radius+s.radius+5;if(c<x*x&&c>0){let e=Math.sqrt(c),t=x-e,r=l/e,d=o/e,h=.5*t;n?(s.x+=r*t,s.y+=d*t):i?(a.x-=r*t,a.y-=d*t):(a.x-=r*h,a.y-=d*h,s.x+=r*h,s.y+=d*h)}}return r}),c.current=requestAnimationFrame(s)};return c.current=requestAnimationFrame(s),()=>{null!==c.current&&cancelAnimationFrame(c.current)}},[i,t,r,l.length]),{nodes:l,onMouseDown:(e,t,r,a)=>{e.preventDefault(),h.current=!1,d.current={id:t,startX:e.clientX,startY:e.clientY,nodeOrigX:r,nodeOrigY:a},x.current={x:e.clientX,y:e.clientY}},dragId:d.current?.id,consumeWasDragged:()=>{let e=m.current;return m.current=!1,e}}})(k,N.width,N.height,i,M,"natural"===u);if(!e||0===e.length)return(0,a.jsx)("div",{className:"text-zinc-500 text-center p-8",children:"無交易資料可顯示"});let $=(e,t)=>{let r,a,s=e/(t-1||1);return s<.33?(r="radial-gradient(circle at 30% 30%, rgb(167, 139, 250), rgb(124, 58, 237))",a="rgba(124, 58, 237, 0.4)"):s<.66?(r="radial-gradient(circle at 30% 30%, rgb(34, 211, 238), rgb(8, 145, 178))",a="rgba(8, 145, 178, 0.4)"):(r="radial-gradient(circle at 30% 30%, rgb(52, 211, 153), rgb(5, 150, 105))",a="rgba(5, 150, 105, 0.4)"),{background:r,shadowColor:a}},F=null!==f?k[f]:null,R=(e,t)=>{t||w(t=>t.includes(e)?t.filter(t=>t!==e):[...t,e])},I=(e,t="bottom")=>(0,a.jsxs)("div",{className:"pointer-events-none px-4 py-3 bg-zinc-900/90 backdrop-blur-xl border border-white/10 rounded-xl shadow-2xl min-w-[160px]",children:[(0,a.jsxs)("div",{className:"flex items-center justify-between mb-2",children:[(0,a.jsx)("span",{className:"text-xs font-medium text-zinc-400",children:"成交單價"}),(0,a.jsx)("span",{className:"text-sm font-bold text-white",children:e.label})]}),(0,a.jsxs)("div",{className:"space-y-1.5",children:[(0,a.jsxs)("div",{className:"flex justify-between items-center text-xs",children:[(0,a.jsx)("span",{className:"text-zinc-500",children:"成交筆數"}),(0,a.jsxs)("span",{className:"font-medium text-violet-300",children:[e.count," 筆"]})]}),(0,a.jsxs)("div",{className:"flex justify-between items-center text-xs",children:[(0,a.jsx)("span",{className:"text-zinc-500",children:"總銷坪數"}),(0,a.jsxs)("span",{className:"font-medium text-cyan-300",children:[Math.round(e.totalArea)," 坪"]})]})]}),(0,a.jsx)("div",{className:(0,l.cn)("absolute left-1/2 w-2 h-2 bg-zinc-900/90 rotate-45 -translate-x-1/2","bottom"===t?"bottom-0 -mb-1 border-r border-b border-white/10":"top-0 -mt-1 border-l border-t border-white/10")})]});return(0,a.jsxs)("div",{className:"space-y-6",children:[(0,a.jsx)(c,{x:b.x,y:b.y,visible:null!==f&&!!F&&!E,children:F&&(0,a.jsx)("div",{className:"animate-in fade-in zoom-in-95 duration-200",children:I(F)})}),(0,a.jsxs)("div",{className:"flex flex-wrap items-center justify-between gap-4 p-4 bg-zinc-900/30 border border-white/5 rounded-xl","data-report-control":"hide",children:[(0,a.jsxs)("div",{className:"flex flex-wrap items-center gap-4",children:[(0,a.jsxs)("div",{className:"flex items-center gap-2",children:[(0,a.jsx)("span",{className:"text-zinc-400 text-xs",children:"單價範圍"}),(0,a.jsxs)("div",{className:"flex items-center gap-1",children:[(0,a.jsx)(o.p,{type:"number",value:t,onChange:e=>d(Number(e.target.value)),className:"w-16 h-7 text-xs bg-zinc-950/50 border-white/10 px-2"}),(0,a.jsx)("span",{className:"text-zinc-600",children:"-"}),(0,a.jsx)(o.p,{type:"number",value:r,onChange:e=>x(Number(e.target.value)),className:"w-16 h-7 text-xs bg-zinc-950/50 border-white/10 px-2"})]})]}),(0,a.jsxs)("div",{className:"flex items-center gap-2",children:[(0,a.jsx)("span",{className:"text-zinc-400 text-xs",children:"級距"}),(0,a.jsx)(o.p,{type:"number",value:n,onChange:e=>h(Number(e.target.value)),className:"w-14 h-7 text-xs bg-zinc-950/50 border-white/10 px-2"})]}),(0,a.jsxs)("div",{className:"flex bg-zinc-950/50 rounded-md p-0.5 border border-white/10",children:[(0,a.jsx)("button",{onClick:()=>m("count"),className:(0,l.cn)("px-2.5 py-1 text-[10px] rounded transition-colors","count"===i?"bg-violet-500 text-white shadow-sm":"text-zinc-400 hover:text-white"),children:"成交筆數"}),(0,a.jsx)("button",{onClick:()=>m("area"),className:(0,l.cn)("px-2.5 py-1 text-[10px] rounded transition-colors","area"===i?"bg-violet-500 text-white shadow-sm":"text-zinc-400 hover:text-white"),children:"總銷坪數"})]})]}),(0,a.jsxs)("div",{className:"bg-zinc-950/50 p-1 rounded-lg border border-white/5 flex gap-1",children:[(0,a.jsx)("button",{onClick:()=>p("natural"),className:(0,l.cn)("px-3 py-1.5 text-xs font-medium rounded-md transition-all duration-300","natural"===u?"bg-gradient-to-r from-violet-600 to-indigo-600 text-white shadow-lg shadow-violet-500/20":"text-zinc-500 hover:text-zinc-300"),children:(0,a.jsxs)("span",{className:"flex items-center gap-1.5",children:[(0,a.jsxs)("span",{className:"relative flex h-2 w-2",children:[(0,a.jsx)("span",{className:(0,l.cn)("absolute inline-flex h-full w-full rounded-full bg-violet-400 opacity-75","natural"===u&&"animate-ping")}),(0,a.jsx)("span",{className:"relative inline-flex rounded-full h-2 w-2 bg-violet-500"})]}),"無重力模式"]})}),(0,a.jsx)("button",{onClick:()=>p("coordinate"),className:(0,l.cn)("px-3 py-1.5 text-xs font-medium rounded-md transition-all duration-300","coordinate"===u?"bg-gradient-to-r from-violet-600 to-indigo-600 text-white shadow-lg shadow-violet-500/20":"text-zinc-500 hover:text-zinc-300"),children:(0,a.jsxs)("span",{className:"flex items-center gap-1.5",children:[(0,a.jsxs)("svg",{className:"w-3.5 h-3.5",viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:"2",children:[(0,a.jsx)("path",{d:"M3 3v18h18"}),(0,a.jsx)("path",{d:"M18 17V9"}),(0,a.jsx)("path",{d:"M13 17V5"}),(0,a.jsx)("path",{d:"M8 17v-3"})]}),"座標模式"]})})]})]}),(0,a.jsxs)("div",{ref:y,className:(0,l.cn)("relative rounded-3xl overflow-hidden border border-white/5 transition-all duration-500","bg-gradient-to-b from-zinc-900 via-zinc-900 to-zinc-950","h-full min-h-[500px]"),onClick:()=>w([]),children:[(0,a.jsxs)("div",{className:"absolute inset-0 pointer-events-none",children:[(0,a.jsx)("div",{className:"absolute top-0 inset-x-0 h-px bg-gradient-to-r from-transparent via-white/10 to-transparent"}),(0,a.jsx)("div",{className:"absolute top-[-10%] left-[-10%] w-[40%] h-[40%] bg-violet-500/10 rounded-full blur-[100px]"}),(0,a.jsx)("div",{className:"absolute bottom-[-10%] right-[-10%] w-[40%] h-[40%] bg-cyan-500/10 rounded-full blur-[100px]"})]}),(0,a.jsxs)("div",{className:"absolute inset-0",children:["natural"===u&&(0,a.jsxs)("div",{className:"absolute inset-0",children:[A.map((e,t)=>{var r,s;let n=f===e.origIndex,o=E===e.id,c=k[e.origIndex],d=c?.label,x=!!d&&v.includes(d),h=$(e.origIndex,k.length),m=2*e.radius,u=(r=e.y)-(s=e.radius)-90<0&&r+s+90<N.height?"bottom":r+s+90>N.height&&r-s-90>0?"top":r<N.height/2?"bottom":"top";return(0,a.jsxs)("div",{className:(0,l.cn)("absolute block rounded-full select-none cursor-grab active:cursor-grabbing will-change-transform",o?"z-[100] scale-110 shadow-2xl":"transition-[transform,box-shadow] duration-75 ease-linear"),style:{width:m,height:m,left:0,top:0,transform:`translate(${e.x-e.radius}px, ${e.y-e.radius}px) scale(${n||o?1.1:1})`,background:h.background,boxShadow:o?`0 25px 50px -12px ${h.shadowColor}, inset 0 2px 20px rgba(255,255,255,0.6)`:n?`0 20px 40px -10px ${h.shadowColor}, inset 0 2px 20px rgba(255,255,255,0.4)`:`0 10px 30px -10px ${h.shadowColor}, inset 0 2px 10px rgba(255,255,255,0.2)`,zIndex:o?100:n?50:10},onMouseEnter:t=>S(t,e.origIndex),onMouseLeave:()=>g(null),onMouseDown:t=>C(t,e.id,e.x,e.y),onClick:e=>{e.stopPropagation(),d&&R(d,T())},children:[(0,a.jsx)("div",{className:"absolute inset-0 rounded-full bg-gradient-to-tr from-white/0 via-white/0 to-white/30 opacity-50 pointer-events-none"}),(0,a.jsx)("div",{className:"absolute top-[15%] left-[15%] w-[25%] h-[15%] rounded-[100%] bg-white blur-[2px] opacity-40 transform -rotate-45 pointer-events-none"}),(0,a.jsxs)("div",{className:"absolute inset-0 flex flex-col items-center justify-center text-center z-20 pointer-events-none",children:[(0,a.jsx)("div",{className:(0,l.cn)("font-bold text-white drop-shadow-md leading-none",m>80?"text-2xl":m>60?"text-lg":"text-sm","mix-blend-overlay opacity-90"),children:e.value>=1?Math.round(e.value):e.value.toFixed(1)}),m>80&&(0,a.jsx)("div",{className:"text-[10px] text-white/70 mt-1 font-medium tracking-wide",children:"count"===i?"筆":"坪"})]}),c&&x&&(0,a.jsx)("div",{className:(0,l.cn)("absolute left-1/2 z-[110]","top"===u?"-top-3 -translate-x-1/2 -translate-y-full":"top-full mt-3 -translate-x-1/2"),children:I(c,"top"===u?"bottom":"top")})]},e.id)}),(0,a.jsx)("div",{className:"absolute bottom-4 left-0 right-0 text-center text-xs text-zinc-500 font-medium tracking-widest uppercase opacity-50 pointer-events-none",children:"Zero Gravity • Force Layout • Draggable"})]}),"coordinate"===u&&(0,a.jsxs)("div",{className:"absolute inset-0 pt-6 pb-8 px-0",children:[(0,a.jsx)("div",{className:"flex flex-col justify-between h-full py-0 pr-1 text-right w-[46px] border-r border-white/5 relative z-10 float-left",children:[...Array(6)].map((e,s)=>(0,a.jsx)("span",{className:"text-xs font-mono text-zinc-600 block leading-none transform -translate-y-1/2 first:translate-y-0 last:-translate-y-full",children:Math.round(r-(r-t)/5*s)},s))}),(0,a.jsxs)("div",{className:"relative ml-[46px] h-full",children:[(0,a.jsx)("div",{className:"absolute inset-0 flex flex-col justify-between pointer-events-none",children:[...Array(6)].map((e,t)=>(0,a.jsx)("div",{className:"w-full h-px border-t border-dashed border-zinc-800"},t))}),(0,a.jsx)("div",{className:"absolute inset-0",children:k.map((e,s)=>{var n;let o,c=(n="count"===i?e.count:e.totalArea,0===M?40:40+n/M*100),d=(e.min+e.max)/2,x=(o=e.label,v.includes(o)),h=s/(k.length-1||1)*90+5,m=100-(d-t)/(r-t)*100,u=f===s,p=$(s,k.length);return(0,a.jsxs)("div",{className:"absolute transform -translate-x-1/2 -translate-y-1/2 transition-all duration-500",style:{left:`${h}%`,top:`${m}%`,zIndex:u?50:20},onMouseEnter:e=>S(e,s),onMouseLeave:()=>g(null),children:[(0,a.jsx)("div",{className:(0,l.cn)("relative rounded-full flex items-center justify-center cursor-pointer shadow-lg transition-transform duration-300",u?"scale-110":"scale-100"),style:{width:c,height:c,background:p.background,boxShadow:u?`0 10px 20px -5px ${p.shadowColor}, inset 0 2px 10px rgba(255,255,255,0.3)`:`0 5px 15px -5px ${p.shadowColor}, inset 0 2px 5px rgba(255,255,255,0.2)`},onClick:t=>{t.stopPropagation(),R(e.label)},children:(0,a.jsx)("div",{className:"absolute inset-0 rounded-full bg-gradient-to-tr from-transparent to-white/30 opacity-60"})}),x&&(0,a.jsx)("div",{className:"absolute left-1/2 -top-3 -translate-x-1/2 -translate-y-full z-[60]",children:I(e)})]},e.label)})}),(0,a.jsxs)("div",{className:"absolute bottom-0 inset-x-0 flex justify-between text-xs text-zinc-600 font-mono translate-y-full pt-1 px-2",children:[(0,a.jsx)("span",{children:"Low Price"}),(0,a.jsx)("span",{children:"High Price"})]})]})]})]})]}),(0,a.jsxs)("div",{className:"flex items-center justify-between px-2 text-xs text-zinc-500",children:[(0,a.jsxs)("div",{children:["* Bubble size represents ","count"===i?"Transaction Count":"Total Area"]}),(0,a.jsxs)("div",{className:"flex items-center gap-4",children:[(0,a.jsxs)("div",{className:"flex items-center gap-1.5",children:[(0,a.jsx)("div",{className:"w-2 h-2 rounded-full bg-violet-500"}),(0,a.jsx)("span",{children:"Low"})]}),(0,a.jsxs)("div",{className:"flex items-center gap-1.5",children:[(0,a.jsx)("div",{className:"w-2 h-2 rounded-full bg-cyan-500"}),(0,a.jsx)("span",{children:"Mid"})]}),(0,a.jsxs)("div",{className:"flex items-center gap-1.5",children:[(0,a.jsx)("div",{className:"w-2 h-2 rounded-full bg-emerald-500"}),(0,a.jsx)("span",{children:"High"})]})]})]})]})}function x({title:e,stats:t,noDataMessage:r="無資料",className:s,averageType:n="weighted"}){if(!t||0===t.count)return(0,a.jsxs)("div",{className:(0,l.cn)("p-6 border border-white/5 rounded-lg bg-zinc-900/30",s),children:[(0,a.jsx)("h3",{className:"text-zinc-400 font-medium mb-4",children:e}),(0,a.jsx)("p",{className:"text-zinc-500 text-center py-4",children:r})]});let i="weighted"===n&&t.weightedAvgPrice?t.weightedAvgPrice:t.avgPrice;return(0,a.jsxs)("div",{className:(0,l.cn)("p-6 border border-white/5 rounded-lg bg-zinc-900/30",s),children:[(0,a.jsxs)("div",{className:"flex justify-between items-start mb-6",children:[(0,a.jsx)("h3",{className:"text-lg font-semibold text-white",children:e}),(0,a.jsxs)("span",{className:"text-xs text-zinc-500 bg-zinc-800 px-2 py-1 rounded",children:["樣本數: ",t.count]})]}),(0,a.jsxs)("div",{className:"flex flex-col gap-6",children:[(0,a.jsx)("div",{className:"space-y-1",children:(0,a.jsx)("table",{className:"w-full text-sm",children:(0,a.jsxs)("tbody",{className:"divide-y divide-white/5",children:[(0,a.jsxs)("tr",{className:"group",children:[(0,a.jsx)("td",{className:"py-2 text-zinc-400 whitespace-nowrap pr-4",children:"weighted"===n?"加權平均單價":"算術平均單價"}),(0,a.jsx)("td",{className:"py-2 text-right font-mono text-white group-hover:text-cyan-400 transition-colors pl-4 whitespace-nowrap",children:(0,a.jsxs)("span",{className:"inline-flex items-baseline gap-1",children:[(0,l.Z)(i),(0,a.jsx)("span",{className:"text-[10px] text-zinc-500",children:"萬/坪"})]})})]}),(0,a.jsxs)("tr",{className:"group",children:[(0,a.jsx)("td",{className:"py-2 text-zinc-400",children:"最低單價"}),(0,a.jsx)("td",{className:"py-2 text-right font-mono text-zinc-300 group-hover:text-white transition-colors whitespace-nowrap",children:(0,a.jsxs)("span",{className:"inline-flex items-baseline gap-1",children:[(0,l.Z)(t.minPrice),(0,a.jsx)("span",{className:"text-[10px] text-zinc-500",children:"萬/坪"})]})})]}),(0,a.jsxs)("tr",{className:"group",children:[(0,a.jsx)("td",{className:"py-2 text-zinc-400",children:"1/4分位數"}),(0,a.jsx)("td",{className:"py-2 text-right font-mono text-zinc-300 group-hover:text-white transition-colors whitespace-nowrap",children:(0,a.jsxs)("span",{className:"inline-flex items-baseline gap-1",children:[(0,l.Z)(t.q1Price),(0,a.jsx)("span",{className:"text-[10px] text-zinc-500",children:"萬/坪"})]})})]}),(0,a.jsxs)("tr",{className:"group",children:[(0,a.jsx)("td",{className:"py-2 text-violet-400 font-medium",children:"中位數單價"}),(0,a.jsx)("td",{className:"py-2 text-right font-mono text-violet-400 font-bold whitespace-nowrap",children:(0,a.jsxs)("span",{className:"inline-flex items-baseline gap-1",children:[(0,l.Z)(t.medianPrice),(0,a.jsx)("span",{className:"text-[10px] text-violet-300",children:"萬/坪"})]})})]}),(0,a.jsxs)("tr",{className:"group",children:[(0,a.jsx)("td",{className:"py-2 text-zinc-400",children:"3/4分位數"}),(0,a.jsx)("td",{className:"py-2 text-right font-mono text-zinc-300 group-hover:text-white transition-colors whitespace-nowrap",children:(0,a.jsxs)("span",{className:"inline-flex items-baseline gap-1",children:[(0,l.Z)(t.q3Price),(0,a.jsx)("span",{className:"text-[10px] text-zinc-500",children:"萬/坪"})]})})]}),(0,a.jsxs)("tr",{className:"group",children:[(0,a.jsx)("td",{className:"py-2 text-zinc-400",children:"最高單價"}),(0,a.jsx)("td",{className:"py-2 text-right font-mono text-zinc-300 group-hover:text-white transition-colors whitespace-nowrap",children:(0,a.jsxs)("span",{className:"inline-flex items-baseline gap-1",children:[(0,l.Z)(t.maxPrice),(0,a.jsx)("span",{className:"text-[10px] text-zinc-500",children:"萬/坪"})]})})]})]})})}),(0,a.jsxs)("div",{className:"grid grid-cols-2 gap-3 text-sm",children:[(0,a.jsxs)("div",{className:"p-3 bg-zinc-950/50 rounded border border-white/5",children:[(0,a.jsx)("div",{className:"text-cyan-500 font-medium mb-1 text-[10px] uppercase tracking-wider",children:"最高價建案"}),(0,a.jsx)("div",{className:"text-white font-bold text-base mb-1 truncate",title:t.maxPriceProject||"",children:t.maxPriceProject||"N/A"}),(0,a.jsxs)("div",{className:"flex gap-3 text-zinc-400 text-[10px]",children:[(0,a.jsxs)("span",{children:["戶別: ",t.maxPriceUnit||"-"]}),(0,a.jsxs)("span",{children:["樓層: ",t.maxPriceFloor||"-"]})]})]}),(0,a.jsxs)("div",{className:"p-3 bg-zinc-950/50 rounded border border-white/5",children:[(0,a.jsx)("div",{className:"text-green-500 font-medium mb-1 text-[10px] uppercase tracking-wider",children:"最低價建案"}),(0,a.jsx)("div",{className:"text-white font-bold text-base mb-1 truncate",title:t.minPriceProject||"",children:t.minPriceProject||"N/A"}),(0,a.jsxs)("div",{className:"flex gap-3 text-zinc-400 text-[10px]",children:[(0,a.jsxs)("span",{children:["戶別: ",t.minPriceUnit||"-"]}),(0,a.jsxs)("span",{children:["樓層: ",t.minPriceFloor||"-"]})]})]})]})]})]})}function h({data:e,expandAll:t=!1}){if(!e||0===e.length)return(0,a.jsx)("div",{className:"text-zinc-500 text-center p-8",children:"無符合條件的建案可進行類型比較"});let r=Math.max(...e.map(e=>e.shopMultiple),1),s=Math.max(...e.map(e=>e.officeMultiple),1);return(0,a.jsx)("div",{className:(0,l.cn)("overflow-x-auto relative scrollbar-thin scrollbar-thumb-zinc-700 scrollbar-track-transparent",t?"overflow-y-visible":"max-h-[600px] overflow-y-auto"),children:(0,a.jsxs)("table",{className:"w-full text-sm text-left",children:[(0,a.jsx)("thead",{className:"sticky top-0 z-10 bg-zinc-900 text-zinc-400 font-semibold uppercase text-xs shadow-md",children:(0,a.jsxs)("tr",{children:[(0,a.jsx)("th",{className:"px-4 py-3 whitespace-nowrap",children:"建案名稱"}),(0,a.jsx)("th",{className:"px-4 py-3 text-right",children:"住宅均價"}),(0,a.jsxs)("th",{className:"px-4 py-3 text-right",children:["店舖均價 ",(0,a.jsx)("span",{className:"text-[10px] text-zinc-500 font-normal ml-1",children:"/ 倍數"})]}),(0,a.jsxs)("th",{className:"px-4 py-3 text-right",children:["事務所均價 ",(0,a.jsx)("span",{className:"text-[10px] text-zinc-500 font-normal ml-1",children:"/ 倍數"})]})]})}),(0,a.jsx)("tbody",{className:"divide-y divide-white/5",children:e.map((e,t)=>(0,a.jsxs)("tr",{className:"hover:bg-zinc-800/30 transition-colors",children:[(0,a.jsxs)("td",{className:"px-4 py-3 whitespace-nowrap",children:[(0,a.jsx)("div",{className:"font-medium text-white",children:e.projectName}),(0,a.jsxs)("div",{className:"text-xs text-zinc-500 flex gap-1 mt-0.5",children:[e.county&&(0,a.jsx)("span",{className:"bg-zinc-800 px-1 rounded",children:e.county}),e.district&&(0,a.jsx)("span",{className:"bg-zinc-800 px-1 rounded",children:e.district})]})]}),(0,a.jsx)("td",{className:"px-4 py-3 text-right font-mono text-zinc-300",children:e.residentialAvg>0?(0,l.Z)(e.residentialAvg):"-"}),(0,a.jsxs)("td",{className:"px-4 py-3 text-right",children:[(0,a.jsx)("div",{className:"font-mono text-zinc-300",children:e.shopAvg>0?(0,l.Z)(e.shopAvg):"-"}),e.shopMultiple>0&&(0,a.jsxs)("div",{className:"flex flex-col gap-1 mt-1.5 w-[80px] ml-auto",children:[(0,a.jsx)("div",{className:"h-1 bg-zinc-800 rounded-full overflow-hidden w-full",children:(0,a.jsx)("div",{className:"h-full bg-violet-600 rounded-full",style:{width:`${Math.min(e.shopMultiple/r*100,100)}%`}})}),(0,a.jsxs)("div",{className:"text-[10px] text-right text-violet-400 font-medium",children:[e.shopMultiple.toFixed(2),"x"]})]})]}),(0,a.jsxs)("td",{className:"px-4 py-3 text-right",children:[(0,a.jsx)("div",{className:"font-mono text-zinc-300",children:e.officeAvg>0?(0,l.Z)(e.officeAvg):"-"}),e.officeMultiple>0&&(0,a.jsxs)("div",{className:"flex flex-col gap-1 mt-1.5 w-[80px] ml-auto",children:[(0,a.jsx)("div",{className:"h-1 bg-zinc-800 rounded-full overflow-hidden w-full",children:(0,a.jsx)("div",{className:"h-full bg-cyan-600 rounded-full",style:{width:`${Math.min(e.officeMultiple/s*100,100)}%`}})}),(0,a.jsxs)("div",{className:"text-[10px] text-right text-cyan-400 font-medium",children:[e.officeMultiple.toFixed(2),"x"]})]})]})]},t))})]})})}var m=r(89733);function u({data:e,visibleSections:t=["stats","comparison","chart"],comparisonExpandAll:r=!1}){let[i,o]=(0,s.useState)("weighted"),[c,u]=(0,s.useState)(30),[p,f]=(0,s.useState)(150),[g,b]=(0,s.useState)(5),[j,v]=(0,s.useState)("count"),w=s.useRef(null),y=s.useRef(null),N=s.useRef(null),z=e?.transactionDetails||[],S=e?.unitPriceAnalysis,P=S?.residentialStats,k=S?.officeStats,M=S?.storeStats,A=S?.typeComparison;return e&&(z.length||S)?(0,a.jsxs)("div",{className:"space-y-8 animate-in fade-in slide-in-from-bottom-4 duration-500",children:[t.includes("stats")&&(0,a.jsx)(n.c,{title:"各用途單價統計",containerRef:w,headerAction:(0,a.jsxs)("div",{className:"flex items-center gap-4",children:[(0,a.jsxs)("div",{className:"flex items-center gap-2",children:[(0,a.jsx)("span",{className:"text-zinc-400 text-xs",children:"平均類型:"}),(0,a.jsxs)("div",{className:"flex bg-zinc-950/50 rounded-md p-1 border border-white/5",children:[(0,a.jsx)("button",{onClick:()=>o("arithmetic"),className:(0,l.cn)("px-2 py-0.5 text-[10px] rounded transition-colors","arithmetic"===i?"bg-violet-500 text-white":"text-zinc-500 hover:text-white"),children:"算術"}),(0,a.jsx)("button",{onClick:()=>o("weighted"),className:(0,l.cn)("px-2 py-0.5 text-[10px] rounded transition-colors","weighted"===i?"bg-violet-500 text-white":"text-zinc-500 hover:text-white"),children:"加權"})]})]}),(0,a.jsx)(m.N,{data:[P,k,M],filename:"unit_price_stats",label:"匯出",chartType:"unit-price-stats",targetRef:w,snapshotData:{residentialStats:P,officeStats:k,storeStats:M,averageType:i}})]}),children:(0,a.jsxs)("div",{className:"grid grid-cols-1 md:grid-cols-3 gap-6",children:[(0,a.jsx)(x,{title:"住宅建案統計",stats:P,noDataMessage:"無住宅交易數據",className:"border-violet-500/20",averageType:i}),(0,a.jsx)(x,{title:"一般事務所/辦公室統計",stats:k,noDataMessage:"無事務所/辦公室交易數據",className:"border-cyan-500/20",averageType:i}),(0,a.jsx)(x,{title:"店舖統計",stats:M,noDataMessage:"無店舖交易數據",className:"border-amber-500/20",averageType:i})]})}),(0,a.jsxs)("div",{className:"flex flex-col lg:flex-row gap-6 items-stretch",children:[t.includes("comparison")&&A&&A.length>0&&(0,a.jsx)("div",{className:"flex-1 min-w-0 flex flex-col",children:(0,a.jsx)(n.c,{title:"建案產品類型單價比較",description:"同一建案內不同用途（住宅/店面/事務所）的單價與倍數比較",containerRef:y,headerAction:(0,a.jsx)(m.N,{data:A,filename:"type_comparison_data",label:"匯出",chartType:"type-comparison-table",targetRef:y,snapshotData:A,columns:{projectName:"建案",residentialAvg:"住宅均價",officeAvg:"辦公均價",storeAvg:"店舖均價",officeRatio:"辦公倍數",storeRatio:"店舖倍數"}}),className:"h-full",children:(0,a.jsx)(h,{data:A,expandAll:r})})}),t.includes("chart")&&(0,a.jsx)("div",{className:"flex-1 min-w-0 flex flex-col",children:(0,a.jsx)(n.c,{title:"單價分佈泡泡圖",description:"分析各單價區間的成交熱度與分佈密集區",containerRef:N,headerAction:(0,a.jsx)(m.N,{data:z,filename:"bubble_chart_source_data",label:"匯出",chartType:"unit-price-bubble",targetRef:N,snapshotData:z}),className:"h-full",children:(0,a.jsx)(d,{data:z,minPrice:c,maxPrice:p,interval:g,sizeMetric:j,onMinPriceChange:u,onMaxPriceChange:f,onIntervalChange:b,onSizeMetricChange:v})})})]})]}):null}},27529:(e,t,r)=>{r.d(t,{FH:()=>l});var a=r(16385),s=r(55873);async function n(){let{data:{session:e}}=await a.N.auth.getSession();return{"Content-Type":"application/json",apikey:s.m5,Authorization:`Bearer ${e?.access_token||s.m5}`}}async function i(e){let t=await n(),r=await fetch(s.Sn.RANKING_ANALYSIS,{method:"POST",headers:t,body:JSON.stringify({filters:e})});if(!r.ok)throw Error((await r.json().catch(()=>({error:`Analysis request failed: ${r.status}`}))).error||"Analyze data failed");return r.json()}let l={checkAuth:async function(){let{data:{session:e}}=await a.N.auth.getSession();e||console.log("User not logged in, but allowing access.")},getUser:async function(){let{data:{user:e}}=await a.N.auth.getUser();return e},signOut:async function(){let{error:e}=await a.N.auth.signOut();if(e)throw console.error("Sign out failed:",e),e},fetchData:async function(e,t){let r=await n(),a=await fetch(s.Sn.QUERY_DATA,{method:"POST",headers:r,body:JSON.stringify({filters:e,pagination:t})});if(!a.ok)throw Error((await a.json().catch(()=>({error:"Failed to parse server response"}))).error||"Fetch data failed");return a.json()},analyzeData:i,analyzeProjectRanking:i,fetchSubData:async function(e,t,r){if(!e||!t||!r)throw Error(`Insufficient parameters: ${e}, ${t}, ${r}`);let a=await n(),i=await fetch(s.Sn.SUB_DATA,{method:"POST",headers:a,body:JSON.stringify({id:e,type:t,county:r})});if(!i.ok)throw Error((await i.json().catch(()=>({error:"Failed to fetch sub data"}))).error||"Fetch sub data failed");return i.json()},fetchProjectNameSuggestions:async function(e,t,r=[]){let a=await n(),i=t.replace(/\u3127/g,"一"),l=await fetch(s.Sn.PROJECT_NAMES,{method:"POST",headers:a,body:JSON.stringify({countyCode:e,query:i,districts:r,detailed:!0})});if(!l.ok)throw Error(`Server error: ${l.status}`);return l.json()},getAdminUsers:async function(){let e=await n(),t=await fetch(s.Sn.GET_USERS,{method:"POST",headers:e,body:JSON.stringify({})});if(!t.ok)throw Error((await t.json().catch(()=>({error:"Failed to fetch users"}))).error||"Fetch users failed");return t.json()},getUserActivity:async function(e,t=200,r=0){let a=await n(),i=await fetch(s.Sn.GET_USER_ACTIVITY,{method:"POST",headers:a,body:JSON.stringify({userId:e,limit:t,offset:r})});if(!i.ok)throw Error((await i.json().catch(()=>({error:"Failed to fetch user activity"}))).error||"Fetch user activity failed");return i.json()},getActivityStats:async function(){let e=await n(),t=await fetch(s.Sn.GET_ACTIVITY_STATS,{method:"POST",headers:e,body:JSON.stringify({})});if(!t.ok)throw Error((await t.json().catch(()=>({error:"Failed to fetch activity stats"}))).error||"Fetch activity stats failed");return t.json()},validateReferralCode:async function(e){let t=await n();return(await fetch(s.Sn.VALIDATE_REFERRAL_CODE,{method:"POST",headers:t,body:JSON.stringify({code:e})})).json()},activateSubscription:async function(e){let t=await n(),r=await fetch(s.Sn.ACTIVATE_SUBSCRIPTION,{method:"POST",headers:t,body:JSON.stringify(e)});if(!r.ok)throw Error((await r.json().catch(()=>({error:"Activation failed"}))).error||"Activation failed");return r.json()},bindReferralCode:async function(e){let t=await n(),r=await fetch(s.Sn.BIND_REFERRAL_CODE,{method:"POST",headers:t,body:JSON.stringify("string"==typeof e?{code:e}:e)});if(!r.ok)throw Error((await r.json().catch(()=>({error:"Failed to bind referral code"}))).error||"Failed to bind referral code");return r.json()},clearReferralCode:async function(){let e=await n(),t=await fetch(s.Sn.BIND_REFERRAL_CODE,{method:"POST",headers:e,body:JSON.stringify({action:"clear"})});if(!t.ok)throw Error((await t.json().catch(()=>({error:"Failed to clear referral code"}))).error||"Failed to clear referral code");return t.json()},getReferralDashboard:async function(){let e=await n(),t=await fetch(s.Sn.GET_REFERRAL_DASHBOARD,{method:"POST",headers:e,body:JSON.stringify({})});if(!t.ok)throw Error((await t.json().catch(()=>({error:"Failed to fetch referral data"}))).error||"Fetch referral dashboard failed");return t.json()},consumeReferralFeature:async function(e,t="consume"){let r=await n(),a=await fetch(s.Sn.CONSUME_REFERRAL_FEATURE,{method:"POST",headers:r,body:JSON.stringify({feature:e,mode:t})});if(!a.ok){let e=await a.json().catch(()=>({error:"Failed to consume feature"}));throw Error(e.error||e.reason||"Failed to consume feature")}return a.json()}}},29991:(e,t,r)=>{r.d(t,{l:()=>l});var a=r(95155),s=r(12115),n=r(40980),i=r(66088);let l=s.forwardRef(({className:e,children:t,...r},s)=>(0,a.jsxs)("div",{className:"relative",children:[(0,a.jsx)("select",{className:(0,n.cn)("flex h-10 w-full appearance-none rounded-md border border-input bg-zinc-950/50 px-3 py-2 text-sm text-zinc-100 ring-offset-background focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2 disabled:cursor-not-allowed disabled:opacity-50 pr-8",e),ref:s,...r,children:t}),(0,a.jsx)(i.A,{className:"absolute right-3 top-2.5 h-4 w-4 opacity-50 pointer-events-none"})]}));l.displayName="Select"},37717:(e,t,r)=>{r.d(t,{A:()=>o});var a=r(12115);let s=(e,t)=>getComputedStyle(document.documentElement).getPropertyValue(e).trim()||t,n=e=>{let t=e.match(/rgba?\((\d+),\s*(\d+),\s*(\d+)/i);return t?[Number(t[1]),Number(t[2]),Number(t[3])]:null},i=e=>{let t=e.replace("#","").trim();if(![3,6].includes(t.length))return null;let r=parseInt(3===t.length?t.split("").map(e=>e+e).join(""):t,16);return Number.isNaN(r)?null:[r>>16&255,r>>8&255,255&r]},l=()=>{let e=[s("--color-chart-1","#8b5cf6"),s("--color-chart-2","#06b6d4"),s("--color-chart-3","#10b981"),s("--color-chart-4","#f43f5e"),s("--color-chart-5","#f59e0b")],t=s("--color-dark-bg","#09090b");return{bg:s("--color-dark-bg","#09090b"),card:s("--color-dark-card","#18181b"),surface:s("--color-dark-surface","#27272a"),primary:s("--color-primary","#8b5cf6"),primaryHover:s("--color-primary-hover","#7c3aed"),accent:s("--color-chart-2","#06b6d4"),accentAlt:s("--color-chart-4","#f43f5e"),text:s("--color-text-primary","#fafafa"),textMuted:s("--color-text-secondary","#a1a1aa"),border:s("--color-border","#27272a"),grid:s("--color-zinc-700","#3f3f46"),danger:s("--color-destructive","#ef4444"),warning:s("--color-amber-500","#f59e0b"),success:s("--color-emerald-500","#10b981"),chart:e,chartPalette:((e,t)=>{if(0===e.length)return[];let r=e.map(e=>((e,t,r=.35)=>{let a=i(e)??n(e),s=i(t)??n(t);if(!a||!s)return e;let l=(e,t)=>Math.round(e*(1-r)+t*r),o=l(a[0],s[0]),c=l(a[1],s[1]),d=l(a[2],s[2]);return`rgb(${o}, ${c}, ${d})`})(e,t,.4));return[...e,...r]})(e,t)}};function o(){let[e,t]=(0,a.useState)(()=>l());return(0,a.useEffect)(()=>{let e=()=>t(l());e();let r=new MutationObserver(e);r.observe(document.documentElement,{attributes:!0,attributeFilter:["data-theme"]});let a=t=>{"sqm_theme"===t.key&&e()};return window.addEventListener("storage",a),()=>{r.disconnect(),window.removeEventListener("storage",a)}},[]),(0,a.useMemo)(()=>e,[e])}},48551:(e,t,r)=>{r.d(t,{K:()=>c});var a=r(95155),s=r(12115),n=r(88743),i=r(80642),l=r(39430),o=r(40980);function c(){let{selectedRoomTypes:e,setSelectedRoomTypes:t}=(0,n.P)(),[r,c]=(0,s.useState)(!1),[d,x]=(0,s.useState)(!1);return(0,s.useEffect)(()=>{let e=()=>{let e=document.getElementById("room-type-filter-anchor");e&&c(e.getBoundingClientRect().bottom<80)};return window.addEventListener("scroll",e),e(),()=>window.removeEventListener("scroll",e)},[]),(0,s.useEffect)(()=>{let e=document.querySelector("aside");if(!e)return;let t=()=>x(!0),r=()=>x(!1);return e.addEventListener("mouseenter",t),e.addEventListener("mouseleave",r),()=>{e.removeEventListener("mouseenter",t),e.removeEventListener("mouseleave",r)}},[]),(0,a.jsx)(i.N,{children:r&&!d&&(0,a.jsxs)(l.P.div,{initial:{opacity:0,y:20},animate:{opacity:1,y:0},exit:{opacity:0,y:20},transition:{duration:.3},"data-report-control":"always-hide",className:(0,o.cn)("fixed z-[90] flex gap-1.5 p-1.5 bg-zinc-900/95 backdrop-blur-md border border-white/10 rounded-xl shadow-xl","flex-row bottom-8 left-1/2 -translate-x-1/2 items-center max-w-[90vw]","md:flex-col md:left-20 md:top-1/2 md:-translate-y-1/2 md:bottom-auto md:translate-x-0 md:items-stretch md:max-w-none"),children:[(0,a.jsx)("div",{className:(0,o.cn)("text-[9px] text-zinc-500 font-medium overflow-hidden","md:writing-mode-vertical md:text-center md:mb-0.5","whitespace-nowrap px-1"),children:"房型"}),(0,a.jsx)("div",{className:"flex md:flex-col gap-1.5 overflow-x-auto md:overflow-visible max-w-full md:max-w-none pb-2 md:pb-0 scrollbar-thumb-zinc-600 pr-8 md:pr-0",children:n.M.map(r=>(0,a.jsx)("button",{onClick:()=>{t(e.includes(r)?e.filter(e=>e!==r):[...e,r])},className:(0,o.cn)("px-2 py-1 text-[10px] font-medium rounded-lg transition-all hover:scale-105 active:scale-95 whitespace-nowrap",e.includes(r)?"bg-violet-500 text-white shadow-lg shadow-violet-500/20":"bg-zinc-800/50 text-zinc-400 hover:bg-zinc-700 hover:text-white"),children:r},r))}),e.length>0&&e.length<n.M.length&&(0,a.jsx)("button",{onClick:()=>t([]),className:(0,o.cn)("text-[9px] text-cyan-400 hover:text-cyan-300 transition-colors whitespace-nowrap px-1","md:mt-1 md:border-t md:border-white/5 md:pt-1 md:text-center md:px-0","border-l border-white/5 pl-1 md:border-l-0 md:pl-0"),children:"清除"})]})})}},51806:(e,t,r)=>{r.d(t,{a:()=>l});var a=r(95155);r(12115);var s=r(33210),n=r(40980),i=r(81477);function l({isOpen:e,onClose:t,title:r,children:l,className:o,maxWidth:c="max-w-4xl"}){return e?(0,a.jsxs)("div",{className:"fixed inset-0 z-50 flex items-center justify-center p-4 bg-black/70 backdrop-blur-sm animate-in fade-in duration-200",children:[(0,a.jsx)("div",{className:"absolute inset-0",onClick:t}),(0,a.jsxs)(i.Zp,{className:(0,n.cn)("relative w-full max-h-[90vh] flex flex-col overflow-hidden animate-in zoom-in-95 duration-200",c,o),"data-report-control":"allow",onClick:e=>e.stopPropagation(),children:[(0,a.jsxs)("div",{className:"flex items-center justify-between p-6 border-b border-border",children:[r&&(0,a.jsx)("h2",{className:"text-2xl font-bold text-white",children:r}),(0,a.jsx)("button",{onClick:t,className:"p-1 rounded-full hover:bg-white/10 transition-colors text-gray-400 hover:text-white",children:(0,a.jsx)(s.A,{size:24})})]}),(0,a.jsx)("div",{className:"p-6 overflow-y-auto custom-scrollbar",children:l})]})]}):null}},56722:(e,t,r)=>{r.d(t,{n:()=>a});let a=(e,t)=>{let r=e?.["戶型"];if("string"==typeof r&&r)return r;let a=t.resolve(e);if(a)return a;let s=e?.["戶別"]||e?.unit||e?.unitName;return"string"==typeof s&&s?s:"?"}},60529:(e,t,r)=>{r.d(t,{p:()=>i});var a=r(95155),s=r(12115),n=r(40980);let i=s.forwardRef(({className:e,type:t,...r},s)=>(0,a.jsx)("input",{type:t,className:(0,n.cn)("flex h-10 w-full rounded-md border border-input bg-zinc-950/50 px-3 py-2 text-sm text-zinc-100 ring-offset-background file:border-0 file:bg-transparent file:text-sm file:font-medium placeholder:text-zinc-500 focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2 disabled:cursor-not-allowed disabled:opacity-50",e),ref:s,...r}));i.displayName="Input"},62400:(e,t,r)=>{r.d(t,{b:()=>s});var a=r(88743);function s(){let e=a.P.getState(),t=[];return e.counties.length>0&&(e.districts.length>0?t.push(`${e.counties.join(", ")} - ${e.districts.join(", ")}`):t.push(e.counties.join(", "))),e.startDate&&e.endDate?t.push(`${e.startDate} ~ ${e.endDate}`):e.dateRange&&"custom"!==e.dateRange&&t.push({"3m":"近3個月","6m":"近6個月","9m":"近9個月","12m":"近12個月","15m":"近15個月","18m":"近18個月","21m":"近21個月","24m":"近24個月","36m":"近36個月","48m":"近48個月",all:"全部時間"}[e.dateRange]||e.dateRange),e.transactionType&&t.push(e.transactionType),e.buildingType&&""!==e.buildingType&&t.push(e.buildingType),e.projectNames.length>0&&e.projectNames.length<=3?t.push(e.projectNames.join(", ")):e.projectNames.length>3&&t.push(`${e.projectNames.length} 個建案`),e.excludeCommercial&&t.push("排除商業/辦公"),t.length>0?t.join(" | "):"所有條件"}},68605:(e,t,r)=>{r.d(t,{c:()=>i});var a=r(95155);r(12115);var s=r(40980),n=r(62400);function i({title:e,description:t,children:r,headerAction:i,className:l,containerRef:o}){let c=(0,n.b)();return(0,a.jsxs)("div",{ref:o,className:(0,s.cn)("bg-zinc-900/50 border border-white/5 rounded-2xl p-4 md:p-6 backdrop-blur-sm",l),children:[(0,a.jsxs)("div",{className:"flex flex-col md:flex-row md:items-center justify-between gap-4 mb-6",children:[(0,a.jsxs)("div",{children:[(0,a.jsx)("h3",{className:"text-xl font-bold text-white flex items-center gap-2",children:e}),t&&(0,a.jsx)("p",{className:"text-zinc-400 text-sm mt-1",children:t})]}),i&&(0,a.jsx)("div",{className:"flex-shrink-0 w-full md:w-auto overflow-x-auto","data-html2canvas-ignore":"true",children:i})]}),r,(0,a.jsxs)("div",{className:"mt-4 pt-3 border-t border-white/10 flex flex-col items-center gap-1 text-xs text-center",style:{display:"none"},"data-export-footer":"true",children:[(0,a.jsx)("div",{className:"text-white font-semibold text-sm whitespace-nowrap",children:"彙整：平米內參 　來源：內政部實登"}),(0,a.jsxs)("div",{className:"text-zinc-400 text-center whitespace-nowrap overflow-hidden text-ellipsis w-full",children:["搜尋條件：",c]})]})]})}},70872:(e,t,r)=>{r.d(t,{Bc:()=>l,ZI:()=>d,k$:()=>c,m_:()=>o});var a=r(95155),s=r(12115),n=r(36376),i=r(40980);let l=n.Kq,o=n.bL,c=n.l9,d=s.forwardRef(({className:e,sideOffset:t=4,...r},s)=>(0,a.jsx)(n.UC,{ref:s,sideOffset:t,className:(0,i.cn)("z-50 overflow-hidden rounded-md border border-zinc-800 bg-zinc-950 px-3 py-1.5 text-sm text-zinc-100 shadow-md animate-in fade-in-0 zoom-in-95 data-[state=closed]:animate-out data-[state=closed]:fade-out-0 data-[state=closed]:zoom-out-95 data-[side=bottom]:slide-in-from-top-2 data-[side=left]:slide-in-from-right-2 data-[side=right]:slide-in-from-left-2 data-[side=top]:slide-in-from-bottom-2",e),...r}));d.displayName=n.UC.displayName},72264:(e,t,r)=>{r.d(t,{SQ:()=>c,_2:()=>d,hO:()=>x,lp:()=>h,mB:()=>m,rI:()=>l,ty:()=>o});var a=r(95155);r(12115);var s=r(61108),n=r(94514),i=r(40980);function l({...e}){return(0,a.jsx)(s.bL,{"data-slot":"dropdown-menu",...e})}function o({...e}){return(0,a.jsx)(s.l9,{"data-slot":"dropdown-menu-trigger",...e})}function c({className:e,sideOffset:t=4,...r}){return(0,a.jsx)(s.ZL,{children:(0,a.jsx)(s.UC,{"data-slot":"dropdown-menu-content",sideOffset:t,className:(0,i.cn)("bg-popover text-popover-foreground data-[state=open]:animate-in data-[state=closed]:animate-out data-[state=closed]:fade-out-0 data-[state=open]:fade-in-0 data-[state=closed]:zoom-out-95 data-[state=open]:zoom-in-95 data-[side=bottom]:slide-in-from-top-2 data-[side=left]:slide-in-from-right-2 data-[side=right]:slide-in-from-left-2 data-[side=top]:slide-in-from-bottom-2 z-50 max-h-(--radix-dropdown-menu-content-available-height) min-w-[8rem] origin-(--radix-dropdown-menu-content-transform-origin) overflow-x-hidden overflow-y-auto rounded-md border p-1 shadow-md",e),...r})})}function d({className:e,inset:t,variant:r="default",...n}){return(0,a.jsx)(s.q7,{"data-slot":"dropdown-menu-item","data-inset":t,"data-variant":r,className:(0,i.cn)("focus:bg-accent focus:text-accent-foreground data-[variant=destructive]:text-destructive data-[variant=destructive]:focus:bg-destructive/10 dark:data-[variant=destructive]:focus:bg-destructive/20 data-[variant=destructive]:focus:text-destructive data-[variant=destructive]:*:[svg]:!text-destructive [&_svg:not([class*='text-'])]:text-muted-foreground relative flex cursor-default items-center gap-2 rounded-sm px-2 py-1.5 text-sm outline-hidden select-none data-[disabled]:pointer-events-none data-[disabled]:opacity-50 data-[inset]:pl-8 [&_svg]:pointer-events-none [&_svg]:shrink-0 [&_svg:not([class*='size-'])]:size-4",e),...n})}function x({className:e,children:t,checked:r,...l}){return(0,a.jsxs)(s.H_,{"data-slot":"dropdown-menu-checkbox-item",className:(0,i.cn)("focus:bg-accent focus:text-accent-foreground relative flex cursor-default items-center gap-2 rounded-sm py-1.5 pr-2 pl-8 text-sm outline-hidden select-none data-[disabled]:pointer-events-none data-[disabled]:opacity-50 [&_svg]:pointer-events-none [&_svg]:shrink-0 [&_svg:not([class*='size-'])]:size-4",e),checked:r,...l,children:[(0,a.jsx)("span",{className:"pointer-events-none absolute left-2 flex size-3.5 items-center justify-center",children:(0,a.jsx)(s.VF,{children:(0,a.jsx)(n.A,{className:"size-4"})})}),t]})}function h({className:e,inset:t,...r}){return(0,a.jsx)(s.JU,{"data-slot":"dropdown-menu-label","data-inset":t,className:(0,i.cn)("px-2 py-1.5 text-sm font-medium data-[inset]:pl-8",e),...r})}function m({className:e,...t}){return(0,a.jsx)(s.wv,{"data-slot":"dropdown-menu-separator",className:(0,i.cn)("bg-border -mx-1 my-1 h-px",e),...t})}},77837:(e,t,r)=>{r.d(t,{P:()=>y});var a=r(95155),s=r(12115),n=r(68605),i=r(47650),l=r(80642),o=r(39430),c=r(33210),d=r(44071),x=r(67514),h=r(37717);let m={height:450,paddingTop:40,paddingBottom:80,paddingLeft:100,paddingRight:40,boxWidth:60,whiskerWidth:30,whiskerStrokeWidth:1,boxStrokeWidth:1.5,medianStrokeWidth:2};function u({data:e}){let t=(0,h.A)(),[r,n]=(0,s.useState)(null),[u,p]=(0,s.useState)(null),[f,g]=(0,s.useState)(null),[b,j]=(0,s.useState)(!1),v=(0,s.useRef)(null),w=(0,s.useRef)(null),y=(0,s.useRef)(null),N=(0,s.useMemo)(()=>({...m,colors:{upper:t.chart[1]||t.primary,lower:t.chart[0]||t.accent,whisker:t.text,median:t.text,grid:t.grid,text:t.textMuted,background:"transparent"}}),[t]);(0,s.useEffect)(()=>{j(!0)},[]),(0,s.useEffect)(()=>{let e=e=>{let t=y.current;if(t&&!t.contains(e.target)){let t=v.current;if(t&&t.contains(e.target))return;n(null)}};if(r){let t=setTimeout(()=>{document.addEventListener("click",e)},100);return()=>{clearTimeout(t),document.removeEventListener("click",e)}}},[r]);let z=(0,s.useMemo)(()=>{if(!e||0===e.length)return null;let t=e.map(e=>[e.minPrice,e.q1Price,e.medianPrice,e.q3Price,e.maxPrice].some(e=>"number"!=typeof e||isNaN(e))?null:{category:null!==e.bathrooms?`${e.roomType}-${e.bathrooms}衛`:e.roomType,min:Math.round(e.minPrice),q1:Math.round(e.q1Price),median:Math.round(e.medianPrice),q3:Math.round(e.q3Price),max:Math.round(e.maxPrice),count:e.count}).filter(Boolean);if(0===t.length)return null;let r=t.flatMap(e=>[e.min,e.q1,e.median,e.q3,e.max]),a=Math.min(...r),s=Math.max(...r),n=s-a,i=0===n?Math.max(.1*a,100):.1*n;return{items:t,yMin:Math.max(0,a-i),yMax:s+i}},[e]),S=(0,s.useMemo)(()=>{if(!z)return null;let e=w.current?.clientWidth||800,t=e-N.paddingLeft-N.paddingRight,r=N.height-N.paddingTop-N.paddingBottom,a=t/z.items.length;return{width:e,height:N.height,drawWidth:t,drawHeight:r,categoryWidth:a}},[z,N,w.current?.clientWidth]),P=(0,s.useMemo)(()=>z&&S?e=>{let t=(e-z.yMin)/(z.yMax-z.yMin);return N.paddingTop+S.drawHeight*(1-t)}:null,[z,S,N]),k=(0,s.useMemo)(()=>{if(!z)return[];let{yMin:e,yMax:t}=z,r=(t-e)/5;return Array.from({length:6},(t,a)=>Math.round(e+a*r))},[z]);return e&&0!==e.length&&z?(0,a.jsxs)("div",{ref:w,className:"relative w-full",children:[(0,a.jsx)("svg",{ref:v,width:"100%",height:N.height,className:"overflow-visible",onMouseMove:e=>{if(!v.current||!P||!z||!S)return;let t=v.current.getBoundingClientRect(),r=t.height/N.height||1,a=(e.clientY-t.top)/r;a>=N.paddingTop&&a<=N.paddingTop+S.drawHeight?g(a):g(null)},onMouseLeave:()=>{g(null)},children:S&&P&&(0,a.jsxs)(a.Fragment,{children:[k.map((e,t)=>(0,a.jsxs)("g",{children:[(0,a.jsx)("line",{x1:N.paddingLeft,y1:P(e),x2:N.paddingLeft+S.drawWidth,y2:P(e),stroke:N.colors.grid,strokeWidth:1,strokeDasharray:"4,4"}),(0,a.jsxs)("text",{x:N.paddingLeft-10,y:P(e),textAnchor:"end",dominantBaseline:"middle",fill:N.colors.text,fontSize:12,children:[e.toLocaleString()," 萬"]})]},`tick-${t}`)),(0,a.jsx)("text",{x:15,y:N.height/2,textAnchor:"middle",dominantBaseline:"middle",fill:N.colors.text,fontSize:12,transform:`rotate(-90, 15, ${N.height/2})`,children:"房屋總價 (萬)"}),z.items.map((e,s)=>{let i=N.paddingLeft+S.categoryWidth*(s+.5),l=N.boxWidth/2,o=N.whiskerWidth/2,c=P(e.max),d=P(e.q3),x=P(e.median),h=P(e.q1),m=P(e.min),f=u===s,g=r?.category===e.category;return(0,a.jsxs)("g",{className:"cursor-pointer transition-opacity",style:{opacity:null===u||f?1:.5},onMouseEnter:()=>p(s),onMouseLeave:()=>p(null),onClick:()=>n(e),children:[(0,a.jsx)("line",{x1:i,y1:d,x2:i,y2:c,stroke:N.colors.whisker,strokeWidth:N.whiskerStrokeWidth,strokeLinecap:"round"}),(0,a.jsx)("line",{x1:i-o,y1:c,x2:i+o,y2:c,stroke:N.colors.whisker,strokeWidth:N.whiskerStrokeWidth,strokeLinecap:"round"}),(0,a.jsx)("line",{x1:i,y1:h,x2:i,y2:m,stroke:N.colors.whisker,strokeWidth:N.whiskerStrokeWidth,strokeLinecap:"round"}),(0,a.jsx)("line",{x1:i-o,y1:m,x2:i+o,y2:m,stroke:N.colors.whisker,strokeWidth:N.whiskerStrokeWidth,strokeLinecap:"round"}),(0,a.jsx)("rect",{x:i-l,y:d,width:N.boxWidth,height:x-d,fill:N.colors.upper,stroke:f||g?t.text:N.colors.upper,strokeWidth:N.boxStrokeWidth,rx:2,style:{filter:f?"brightness(1.2)":"none"}}),(0,a.jsx)("rect",{x:i-l,y:x,width:N.boxWidth,height:h-x,fill:N.colors.lower,stroke:f||g?t.text:N.colors.lower,strokeWidth:N.boxStrokeWidth,rx:2,style:{filter:f?"brightness(1.2)":"none"}}),(0,a.jsx)("line",{x1:i-l,y1:x,x2:i+l,y2:x,stroke:N.colors.median,strokeWidth:N.medianStrokeWidth}),(0,a.jsx)("text",{x:i,y:N.height-25,textAnchor:"middle",fill:f?t.text:N.colors.text,fontSize:12,fontWeight:f?"bold":"normal",children:e.category})]},e.category)}),null!==f&&(0,a.jsxs)(a.Fragment,{children:[(0,a.jsx)("line",{x1:N.paddingLeft,y1:f,x2:N.paddingLeft+S.drawWidth,y2:f,stroke:t.accent,strokeWidth:1,strokeDasharray:"4,4",pointerEvents:"none"}),(0,a.jsx)("rect",{x:N.paddingLeft+S.drawWidth+5,y:f-12,width:70,height:24,rx:4,fill:t.card,stroke:t.accent,strokeWidth:1}),(0,a.jsxs)("text",{x:N.paddingLeft+S.drawWidth+40,y:f+4,textAnchor:"middle",fill:t.accent,fontSize:11,fontWeight:"bold",children:[(e=>{if(!z||!S)return 0;let t=1-(e-N.paddingTop)/S.drawHeight;return Math.round(z.yMin+t*(z.yMax-z.yMin))})(f).toLocaleString()," 萬"]})]})]})}),b&&(0,i.createPortal)((0,a.jsx)(l.N,{children:r&&(0,a.jsxs)("div",{className:"fixed inset-0 z-[9998] pointer-events-none",children:[(0,a.jsx)(o.P.div,{initial:{opacity:0},animate:{opacity:1},exit:{opacity:0},className:"absolute inset-0 bg-black/50 backdrop-blur-sm pointer-events-auto",onClick:()=>n(null)}),(0,a.jsx)(o.P.div,{ref:y,initial:{opacity:0,scale:.9,y:20},animate:{opacity:1,scale:1,y:0},exit:{opacity:0,scale:.9,y:20},transition:{type:"spring",stiffness:400,damping:30},className:"absolute top-1/2 left-1/2 -translate-x-1/2 -translate-y-1/2 pointer-events-auto w-[90vw] max-w-sm max-h-[85vh] flex flex-col",onClick:e=>e.stopPropagation(),children:(0,a.jsxs)("div",{className:"bg-zinc-900 border border-white/10 rounded-2xl shadow-2xl overflow-hidden flex flex-col",children:[(0,a.jsx)("div",{className:"bg-gradient-to-r from-cyan-500/20 to-violet-500/20 px-5 py-3 border-b border-white/10 flex-shrink-0",children:(0,a.jsxs)("div",{className:"flex items-center justify-between",children:[(0,a.jsxs)("div",{children:[(0,a.jsx)("div",{className:"text-zinc-400 text-[10px] uppercase tracking-widest mb-0.5",children:"總價帶分析"}),(0,a.jsxs)("div",{className:"flex items-baseline gap-2",children:[(0,a.jsx)("div",{className:"text-white text-2xl font-black tracking-tight",children:r.category}),r.count>0&&(0,a.jsxs)("div",{className:"text-zinc-400 text-xs",children:["(",(0,a.jsx)("span",{className:"text-cyan-400 font-bold",children:r.count})," 筆)"]})]})]}),(0,a.jsx)("button",{onClick:()=>n(null),className:"p-1.5 rounded-full hover:bg-white/10 transition-colors",children:(0,a.jsx)(c.A,{className:"w-4 h-4 text-zinc-400"})})]})}),(0,a.jsxs)("div",{className:"p-4 space-y-2 overflow-y-auto flex-1 custom-scrollbar",children:[(0,a.jsxs)("div",{className:"flex items-center gap-3 p-2 rounded-lg bg-white/5 border border-white/5",children:[(0,a.jsx)(d.A,{className:"w-4 h-4 text-white/70 flex-shrink-0"}),(0,a.jsx)("div",{className:"flex-1 min-w-0",children:(0,a.jsxs)("div",{className:"flex justify-between items-baseline",children:[(0,a.jsx)("span",{className:"text-white/60 text-xs font-medium",children:"最高成交"}),(0,a.jsxs)("span",{className:"text-white text-base font-mono font-bold",children:[r.max.toLocaleString()," 萬"]})]})}),(0,a.jsx)("div",{className:"w-1 h-3 border-r border-white/50 flex-shrink-0",title:"上引線"})]}),(0,a.jsxs)("div",{className:"p-3 rounded-lg bg-cyan-500/10 border border-cyan-500/30",children:[(0,a.jsxs)("div",{className:"flex items-center gap-1.5 mb-1",children:[(0,a.jsx)("div",{className:"w-3 h-3 rounded-[2px] bg-cyan-500"}),(0,a.jsx)("span",{className:"text-cyan-400 text-xs font-bold",children:"較高價區間 (25%)"})]}),(0,a.jsxs)("div",{className:"text-white text-lg font-mono font-bold mb-1",children:[r.median.toLocaleString()," ~ ",r.q3.toLocaleString()," 萬"]}),(0,a.jsx)("div",{className:"text-zinc-400 text-[10px] leading-tight",children:"價格偏高但屬正常範圍的交易。"})]}),(0,a.jsx)("div",{className:"flex items-center gap-3 px-3 py-2 bg-white/5 rounded-lg border border-white/5",children:(0,a.jsx)("div",{className:"flex-1",children:(0,a.jsxs)("div",{className:"flex justify-between items-center",children:[(0,a.jsx)("div",{className:"text-white text-xs font-bold",children:"中位數 (50%)"}),(0,a.jsxs)("div",{className:"text-white text-lg font-mono font-bold",children:[r.median.toLocaleString()," 萬"]})]})})}),(0,a.jsxs)("div",{className:"p-3 rounded-lg bg-violet-500/10 border border-violet-500/30",children:[(0,a.jsxs)("div",{className:"flex items-center gap-1.5 mb-1",children:[(0,a.jsx)("div",{className:"w-3 h-3 rounded-[2px] bg-violet-500"}),(0,a.jsx)("span",{className:"text-violet-400 text-xs font-bold",children:"較低價區間 (25%)"})]}),(0,a.jsxs)("div",{className:"text-white text-lg font-mono font-bold mb-1",children:[r.q1.toLocaleString()," ~ ",r.median.toLocaleString()," 萬"]}),(0,a.jsx)("div",{className:"text-zinc-400 text-[10px] leading-tight",children:"價格偏低但屬正常範圍的交易。"})]}),(0,a.jsxs)("div",{className:"flex items-center gap-3 p-2 rounded-lg bg-white/5 border border-white/5",children:[(0,a.jsx)(x.A,{className:"w-4 h-4 text-zinc-500 flex-shrink-0"}),(0,a.jsx)("div",{className:"flex-1 min-w-0",children:(0,a.jsxs)("div",{className:"flex justify-between items-baseline",children:[(0,a.jsx)("span",{className:"text-zinc-500 text-xs font-medium",children:"最低成交"}),(0,a.jsxs)("span",{className:"text-white text-base font-mono font-bold",children:[r.min.toLocaleString()," 萬"]})]})}),(0,a.jsx)("div",{className:"w-1 h-3 border-r border-zinc-600 flex-shrink-0",title:"下引線"})]})]}),(0,a.jsx)("div",{className:"px-4 py-2 bg-white/5 border-t border-white/10 flex-shrink-0",children:(0,a.jsxs)("div",{className:"text-zinc-500 text-[10px] text-center",children:["\uD83D\uDCA1 藍+紫區塊涵蓋 ",(0,a.jsx)("span",{className:"text-white font-bold",children:"50%"})," 的交易 (市場主流)"]})})]})})]})}),document.body)]}):(0,a.jsx)("div",{className:"text-zinc-500 text-center p-8",children:"無總價帶資料可顯示"})}var p=r(97085);function f({roomTypes:e,locations:t,crossTable:r,dimension:n,chartId:i}){let l=(0,h.A)(),o=(0,s.useMemo)(()=>e&&t&&r?e.map(e=>{let a=t.map(t=>r[e]&&r[e][t]||0);return{name:e,data:a}}):[],[e,t,r]),c=(0,s.useMemo)(()=>{let e="county"===n?"縣市":"行政區";return{chart:{type:"bar",height:Math.max(350,35*t.length),stacked:!0,background:"transparent",toolbar:{show:!1},foreColor:l.text,id:i},plotOptions:{bar:{horizontal:!0,barHeight:"70%",borderRadius:4,dataLabels:{total:{enabled:!0,offsetX:5,style:{fontSize:"11px",fontWeight:600,color:l.text},formatter:function(e,t){let r=t.w.config.series,a=t.dataPointIndex,s=0;return r.forEach(e=>{s+=e.data[a]||0}),s>0?s.toString():""}}}}},colors:l.chartPalette,dataLabels:{enabled:!1},xaxis:{categories:t,title:{text:"成交筆數",style:{color:l.textMuted}},labels:{style:{colors:l.textMuted}}},yaxis:{title:{text:e,style:{color:l.textMuted}},labels:{style:{colors:l.text},maxWidth:150}},legend:{position:"top",horizontalAlign:"center",labels:{colors:l.text}},tooltip:{theme:"dark",y:{formatter:function(e){return e+" 筆"}}},grid:{borderColor:l.grid},title:{text:`各${e}房型成交筆數分佈`,align:"center",style:{fontSize:"16px",color:l.text}}}},[t,n,i,l]);return o&&0!==o.length?(0,a.jsx)(p.A,{type:"bar",series:o,options:c,height:c.chart?.height||350,className:"w-full"}):(0,a.jsx)("div",{className:"text-zinc-500 text-center p-8",children:"無區域分佈資料"})}var g=r(40980);function b({isOpen:e,onClose:t,title:r,projects:n}){let i=(0,s.useRef)(null);return((0,s.useEffect)(()=>{let r=e=>{"Escape"===e.key&&t()};return e&&(document.addEventListener("keydown",r),document.body.style.overflow="hidden"),()=>{document.removeEventListener("keydown",r),document.body.style.overflow=""}},[e,t]),e)?(0,a.jsx)("div",{className:"fixed inset-0 z-50 flex items-center justify-center bg-black/60 backdrop-blur-sm animate-in fade-in duration-200",onClick:e=>{i.current&&!i.current.contains(e.target)&&t()},children:(0,a.jsxs)("div",{ref:i,className:"bg-zinc-900 border border-white/10 rounded-xl shadow-2xl max-w-md w-full mx-4 animate-in zoom-in-95 duration-200",children:[(0,a.jsxs)("div",{className:"flex items-center justify-between px-5 py-4 border-b border-white/5",children:[(0,a.jsx)("h3",{className:"text-lg font-semibold text-white",children:r}),(0,a.jsx)("button",{onClick:t,className:"p-1 rounded hover:bg-white/10 text-zinc-400 hover:text-white transition-colors",children:(0,a.jsx)(c.A,{size:20})})]}),(0,a.jsx)("div",{className:"px-5 py-4 max-h-[50vh] overflow-y-auto scrollbar-thin scrollbar-thumb-zinc-700",children:0===n.length?(0,a.jsx)("p",{className:"text-zinc-500 text-center py-4",children:"無建案資料"}):(0,a.jsx)("ul",{className:"space-y-2",children:n.map((e,t)=>(0,a.jsx)("li",{className:(0,g.cn)("px-3 py-2 rounded-lg text-zinc-200 text-sm","bg-zinc-800/50 hover:bg-zinc-800 transition-colors","border border-white/5"),children:e},t))})}),(0,a.jsxs)("div",{className:"px-5 py-3 border-t border-white/5 flex justify-between items-center",children:[(0,a.jsxs)("span",{className:"text-xs text-zinc-500",children:["共 ",n.length," 個建案"]}),(0,a.jsx)("button",{onClick:t,className:"px-4 py-1.5 text-sm rounded-lg bg-zinc-800 text-zinc-300 hover:bg-zinc-700 transition-colors",children:"關閉"})]})]})}):null}var j=r(89733),v=r(88743),w=r(48551);function y({data:e,visibleSections:t=["chart","table","location-table","location-chart"]}){let{selectedRoomTypes:r,setSelectedRoomTypes:i,districts:l}=(0,v.P)(),o=["套房","1房","2房","3房","4房","毛胚"],c=s.useRef(null),d=s.useRef(null),x=s.useRef(null),h=s.useRef(null),m=s.useRef(`price-band-location-${Math.random().toString(36).slice(2,8)}`).current,[p,y]=(0,s.useState)("district"),[N,z]=(0,s.useState)(!1),[S,P]=(0,s.useState)(""),[k,M]=(0,s.useState)([]),[A,C]=(0,s.useState)(null),E=(0,s.useMemo)(()=>{if(!e?.transactionDetails)return[];let t=new Set;return e.transactionDetails.forEach(e=>{e["縣市"]&&t.add(e["縣市"])}),Array.from(t).sort()},[e?.transactionDetails]);s.useEffect(()=>{0===E.length?C(null):1===E.length?C(E[0]):A&&!E.includes(A)&&C(null)},[E,A]);let T=(e,t,r)=>{P(`${e}${null!==t?` / ${t}衛`:""} 建案組成`),M(r),z(!0)};if(!e||!e.details||0===e.details.length)return null;let{details:$,locationCrossTable:F,allDistricts:R,transactionDetails:I}=e,D=(0,s.useMemo)(()=>$.filter(e=>r.includes(e.roomType)),[$,r]),[L,O]=(0,s.useState)(!0),_=t.includes("table")||t.includes("chart"),W=(0,s.useMemo)(()=>{let e=$.filter(e=>r.includes(e.roomType));if(!L)return e;let t=new Map;return e.forEach(e=>{let r=e.roomType;t.has(r)||t.set(r,{...e,bathrooms:null,projectNames:e.projectNames?[...e.projectNames]:[],count:0,avgPrice:0});let a=t.get(r),s=a.avgPrice*a.count,n=e.avgPrice*e.count,i=a.count+e.count;a.count=i,a.avgPrice=i>0?(s+n)/i:0,a.minPrice=Math.min(a.minPrice,e.minPrice),a.maxPrice=Math.max(a.maxPrice,e.maxPrice);let l=a.count-e.count,o=e.count;if(a.medianPrice=(a.medianPrice*l+e.medianPrice*o)/i,a.q1Price=(a.q1Price*l+e.q1Price*o)/i,a.q3Price=(a.q3Price*l+e.q3Price*o)/i,e.projectNames){let t=new Set([...a.projectNames||[],...e.projectNames]);a.projectNames=Array.from(t)}}),Array.from(t.values()).sort((e,t)=>o.indexOf(e.roomType)-o.indexOf(t.roomType))},[$,r,L,o]),B=(0,s.useMemo)(()=>{if("county"===p&&I){let e={},t=new Set;I.forEach(r=>{let a=r["房型"]||r.roomType||r["戶型"];if(!a||"其他"===a){let e=Number(r["房數"]);a=!isNaN(e)&&e>0?`${e}房`:"其他"}let s="string"==typeof a?a.replace(/\s+/g,""):a;("number"==typeof s||"string"==typeof s&&/^\d+$/.test(s))&&(s=`${s}房`);let n=r["縣市"]||"未知";e[s]||(e[s]={}),e[s][n]=(e[s][n]||0)+1,t.add(n)});let a=Array.from(t).sort(),s={},n=0;a.forEach(e=>s[e]=0);let i=r.map(t=>{let r=e[t]||{},i=0,l=a.map(e=>{let t=r[e]||0;return i+=t,s[e]+=t,t});return n+=i,{roomType:t,cells:l,rowTotal:i}});return{locations:a,rows:i,locationTotals:s,grandTotal:n}}if("district"===p){let e={},t=new Set;if(I)I.forEach(r=>{let a=r["房型"]||r.roomType||r["戶型"];if(!a||"其他"===a){let e=Number(r["房數"]);a=!isNaN(e)&&e>0?`${e}房`:"其他"}let s="string"==typeof a?a.replace(/\s+/g,""):a;("number"==typeof s||"string"==typeof s&&/^\d+$/.test(s))&&(s=`${s}房`);let n=r["行政區"]||"未知",i=r["縣市"]||"未知";A&&i!==A||(e[s]||(e[s]={}),e[s][n]=(e[s][n]||0)+1,t.add(n))}),A||(R&&R.length>0?R:l).forEach(e=>t.add(e));else if(F){let a=new Set;r.forEach(e=>{let t=F[e];t&&Object.keys(t).forEach(e=>a.add(e))}),a.forEach(e=>t.add(e)),A||(R&&R.length>0?R:l).forEach(e=>t.add(e)),r.forEach(t=>{let r=F[t];r&&(e[t]=r)})}let a=Array.from(t).sort(),s={},n=0;a.forEach(e=>s[e]=0);let i=r.map(t=>{let r=e[t]||{},i=0,l=a.map(e=>{let t=r[e]||0;return i+=t,s[e]+=t,t});return n+=i,{roomType:t,cells:l,rowTotal:i}});return{locations:a,rows:i,locationTotals:s,grandTotal:n}}return null},[F,I,r,p,A]),[U,q]=(0,s.useState)(new Set),H=(0,s.useMemo)(()=>B?B.rows.map(e=>{let t={房型:e.roomType};return B.locations.forEach((r,a)=>{t[r]=e.cells[a]}),t["總計"]=e.rowTotal,t}):[],[B]),V=e=>(0,a.jsxs)("div",{className:(0,g.cn)("flex bg-zinc-800 rounded-md p-0.5 border border-white/5",e),children:[(0,a.jsx)("button",{onClick:()=>y("district"),"data-report-control":"allow",className:(0,g.cn)("px-2 py-1 text-xs rounded transition-colors","district"===p?"bg-zinc-700 text-white":"text-zinc-400 hover:text-white"),children:"行政區"}),(0,a.jsx)("button",{onClick:()=>y("county"),"data-report-control":"allow",className:(0,g.cn)("px-2 py-1 text-xs rounded transition-colors","county"===p?"bg-zinc-700 text-white":"text-zinc-400 hover:text-white"),children:"縣市"})]}),Z=()=>"district"!==p||E.length<=1?null:(0,a.jsxs)("div",{className:"flex items-center gap-2",children:[(0,a.jsx)("span",{className:"text-sm text-zinc-500",children:"顯示縣市:"}),(0,a.jsxs)("div",{className:"flex gap-1 bg-zinc-900 p-1 rounded-lg",children:[(0,a.jsx)("button",{onClick:()=>C(null),"data-report-control":"allow",className:(0,g.cn)("px-3 py-1 text-xs font-medium rounded-md transition-all",A?"text-zinc-500 hover:text-zinc-300 hover:bg-zinc-800":"bg-violet-500/20 text-violet-300 shadow-sm border border-violet-500/50"),children:"全部"}),E.map(e=>(0,a.jsx)("button",{onClick:()=>C(e),"data-report-control":"allow",className:(0,g.cn)("px-3 py-1 text-xs font-medium rounded-md transition-all",A===e?"bg-violet-500/20 text-violet-300 shadow-sm border border-violet-500/50":"text-zinc-500 hover:text-zinc-300 hover:bg-zinc-800"),children:e},e))]})]}),G=e=>$.filter(t=>t.roomType===e).sort((e,t)=>(Number(e.bathrooms)||0)-(Number(t.bathrooms)||0)),Y=(0,s.useMemo)(()=>{if(!L)return W;let e=[];return W.forEach(t=>{if(e.push(t),U.has(t.roomType)){let r=G(t.roomType);e.push(...r)}}),e},[W,L,U,$]);return(0,a.jsxs)("div",{className:"space-y-6 animate-in fade-in slide-in-from-bottom-4 duration-500",children:[(0,a.jsxs)("div",{id:"room-type-filter-anchor","data-report-control":"hide",className:"p-4 bg-zinc-900/30 border border-white/5 rounded-lg flex flex-col sm:flex-row sm:flex-wrap items-start sm:items-center justify-between gap-3 sm:gap-4 scroll-mt-24",children:[(0,a.jsxs)("div",{className:"w-full sm:w-auto flex flex-wrap items-center gap-2",children:[(0,a.jsx)("span",{className:"text-zinc-400 text-sm whitespace-nowrap shrink-0 mr-1",children:"分析房型:"}),(0,a.jsx)("div",{className:"flex flex-wrap gap-1.5 sm:gap-2",children:v.M.map(e=>(0,a.jsx)("button",{onClick:()=>{i(r.includes(e)?r.filter(t=>t!==e):[...r,e])},className:(0,g.cn)("px-3 py-1 rounded-full text-xs font-medium transition-colors border",r.includes(e)?"bg-violet-500/20 border-violet-500 text-violet-200":"bg-zinc-800 border-zinc-700 text-zinc-500 hover:bg-zinc-700"),children:e},e))})]}),_&&(0,a.jsxs)("div",{"data-report-control":"hide",className:"flex items-center gap-2 bg-zinc-800/50 p-1 rounded-lg border border-white/5 ml-auto sm:ml-0",children:[(0,a.jsx)("span",{className:"text-xs text-zinc-400 pl-2",children:"表格顯示:"}),(0,a.jsx)("button",{onClick:()=>O(!L),className:(0,g.cn)("px-3 py-1 text-xs font-medium rounded-md transition-all whitespace-nowrap",L?"bg-violet-500 text-white shadow-sm":"text-zinc-400 hover:text-white hover:bg-zinc-700"),children:L?"依房型合併":"顯示衛浴細節"})]})]}),t.includes("chart")&&(0,a.jsx)(n.c,{title:"各房型總價帶分佈箱型圖",description:"顯示各房型總價的中位數與四分位距",containerRef:c,headerAction:(0,a.jsx)(j.N,{data:W,filename:"price_band_chart_data",label:"匯出",chartType:"price-band-chart",targetRef:c,snapshotData:W,columns:{roomType:"房型",bathrooms:"衛浴",minPrice:"最低價",q1Price:"Q1",medianPrice:"中位數",q3Price:"Q3",maxPrice:"最高價",avgPrice:"平均價",count:"筆數"}}),children:(0,a.jsx)(u,{data:W})}),t.includes("table")&&(0,a.jsx)(n.c,{title:"總價帶詳細數據",description:L?"各房型合併統計 (點擊「全部」可展開細節)":"各房型詳細價格統計",containerRef:d,headerAction:(0,a.jsx)(j.N,{data:Y,filename:"price_band_detail_data",label:"匯出",chartType:"price-band-table",targetRef:d,snapshotData:Y,columns:{roomType:"房型",bathrooms:"衛浴",minPrice:"最低價",q1Price:"Q1",medianPrice:"中位數",q3Price:"Q3",maxPrice:"最高價",avgPrice:"平均價",count:"筆數"}}),children:(0,a.jsx)("div",{className:"overflow-x-auto",children:(0,a.jsxs)("table",{className:"w-full text-sm text-left",children:[(0,a.jsx)("thead",{className:"bg-zinc-900/80 text-zinc-400 uppercase text-xs font-semibold",children:(0,a.jsxs)("tr",{children:[(0,a.jsx)("th",{className:"px-4 py-3",children:"房型"}),(0,a.jsx)("th",{className:"px-4 py-3",children:"衛浴"}),(0,a.jsx)("th",{className:"px-4 py-3 whitespace-nowrap min-w-[100px]",children:"建案數"}),(0,a.jsx)("th",{className:"px-4 py-3 whitespace-nowrap",children:"筆數"}),(0,a.jsx)("th",{className:"px-4 py-3 whitespace-nowrap",children:"平均總價"}),(0,a.jsx)("th",{className:"px-4 py-3",children:"最低總價"}),(0,a.jsx)("th",{className:"px-4 py-3",children:"1/4位總價"}),(0,a.jsx)("th",{className:"px-4 py-3 text-violet-400",children:"中位數總價"}),(0,a.jsx)("th",{className:"px-4 py-3",children:"3/4位總價"}),(0,a.jsx)("th",{className:"px-4 py-3",children:"最高總價"})]})}),(0,a.jsxs)("tbody",{className:"divide-y divide-white/5",children:[W.map((e,t)=>{let r=L&&null===e.bathrooms,n=U.has(e.roomType),i=r&&n?G(e.roomType):[];return(0,a.jsxs)(s.Fragment,{children:[(0,a.jsxs)("tr",{className:(0,g.cn)("hover:bg-zinc-800/50 transition-colors",n&&"bg-zinc-800/30"),children:[(0,a.jsx)("td",{className:"px-4 py-3 font-medium text-white",children:e.roomType}),(0,a.jsx)("td",{className:"px-4 py-3 text-zinc-400",children:r?(0,a.jsxs)("button",{onClick:()=>{var t;return t=e.roomType,void q(e=>{let r=new Set(e);return r.has(t)?r.delete(t):r.add(t),r})},"data-report-control":"allow",className:"flex items-center gap-1 text-xs px-2 py-0.5 rounded bg-zinc-700/50 hover:bg-zinc-600 hover:text-white transition-colors cursor-pointer",children:[(0,a.jsx)("span",{children:"全部"}),(0,a.jsx)("span",{className:(0,g.cn)("transform transition-transform text-[10px]",n?"rotate-180":""),children:"▼"})]}):e.bathrooms??"-"}),(0,a.jsx)("td",{className:"px-4 py-3",children:e.projectNames&&e.projectNames.length>0?(0,a.jsxs)("button",{onClick:()=>T(e.roomType,e.bathrooms,e.projectNames||[]),className:"px-2 py-1 text-xs font-medium rounded-full bg-violet-500/20 border border-violet-500/50 text-violet-300 hover:bg-violet-500/30 transition-colors cursor-pointer whitespace-nowrap",children:[e.projectNames.length," 建案"]}):(0,a.jsx)("span",{className:"text-zinc-500",children:"-"})}),(0,a.jsx)("td",{className:"px-4 py-3 text-zinc-300",children:e.count.toLocaleString()}),(0,a.jsx)("td",{className:"px-4 py-3 font-mono text-zinc-300",children:e.avgPrice.toLocaleString(void 0,{maximumFractionDigits:0})}),(0,a.jsx)("td",{className:"px-4 py-3 font-mono text-zinc-500",children:e.minPrice.toLocaleString()}),(0,a.jsx)("td",{className:"px-4 py-3 font-mono text-zinc-500",children:e.q1Price.toLocaleString()}),(0,a.jsx)("td",{className:"px-4 py-3 font-mono text-violet-400 font-bold",children:e.medianPrice.toLocaleString()}),(0,a.jsx)("td",{className:"px-4 py-3 font-mono text-zinc-500",children:e.q3Price.toLocaleString()}),(0,a.jsx)("td",{className:"px-4 py-3 font-mono text-zinc-500",children:e.maxPrice.toLocaleString()})]}),i.map((e,r)=>(0,a.jsxs)("tr",{className:"bg-zinc-900/50 hover:bg-zinc-900 border-l-2 border-l-violet-500/30",children:[(0,a.jsxs)("td",{className:"px-4 py-2 font-medium text-zinc-500 text-xs pl-8",children:["↳ ",e.roomType]}),(0,a.jsxs)("td",{className:"px-4 py-2 text-zinc-400 text-xs",children:[e.bathrooms," 衛"]}),(0,a.jsx)("td",{className:"px-4 py-2",children:e.projectNames&&e.projectNames.length>0?(0,a.jsxs)("button",{onClick:()=>T(e.roomType,e.bathrooms,e.projectNames||[]),className:"text-xs text-zinc-500 hover:text-zinc-300 underline decoration-zinc-700",children:[e.projectNames.length," 建案"]}):"-"}),(0,a.jsx)("td",{className:"px-4 py-2 text-zinc-500 text-xs",children:e.count.toLocaleString()}),(0,a.jsx)("td",{className:"px-4 py-2 font-mono text-zinc-500 text-xs",children:e.avgPrice.toLocaleString(void 0,{maximumFractionDigits:0})}),(0,a.jsx)("td",{className:"px-4 py-2 font-mono text-zinc-600 text-xs",children:e.minPrice.toLocaleString()}),(0,a.jsx)("td",{className:"px-4 py-2 font-mono text-zinc-600 text-xs",children:e.q1Price.toLocaleString()}),(0,a.jsx)("td",{className:"px-4 py-2 font-mono text-zinc-500 text-xs font-medium",children:e.medianPrice.toLocaleString()}),(0,a.jsx)("td",{className:"px-4 py-2 font-mono text-zinc-600 text-xs",children:e.q3Price.toLocaleString()}),(0,a.jsx)("td",{className:"px-4 py-2 font-mono text-zinc-600 text-xs",children:e.maxPrice.toLocaleString()})]},`${t}-sub-${r}`))]},t)}),0===D.length&&(0,a.jsx)("tr",{children:(0,a.jsx)("td",{colSpan:10,className:"p-8 text-center text-zinc-500",children:"請選擇房型顯示數據"})})]})]})})}),(B||I)&&(0,a.jsxs)("div",{className:"space-y-6 pt-4 border-t border-white/5",children:[t.includes("location-table")&&(0,a.jsxs)(n.c,{title:"區域房型成交分佈",containerRef:x,headerAction:(0,a.jsx)(j.N,{data:H,filename:"price_band_location_cross_table",label:"匯出",chartType:"price-band-location-table",targetRef:x,snapshotData:B}),children:[(0,a.jsxs)("div",{className:"flex flex-wrap items-center gap-3 mb-2","data-html2canvas-ignore":"true",children:[Z(),(0,a.jsx)("div",{className:"ml-auto",children:V()})]}),(0,a.jsx)("div",{className:"overflow-x-auto",children:B?(0,a.jsxs)("table",{className:"w-full text-sm text-left border-collapse",children:[(0,a.jsx)("thead",{className:"bg-zinc-900/80 text-zinc-400 font-semibold",children:(0,a.jsxs)("tr",{children:[(0,a.jsx)("th",{className:"px-3 py-2 sticky left-0 bg-zinc-900 z-10 border-r border-white/5",children:"房型"}),B.locations.map(e=>(0,a.jsx)("th",{className:"px-3 py-2 text-center min-w-[80px]",children:e},e)),(0,a.jsx)("th",{className:"px-3 py-2 text-center border-l border-white/5 bg-zinc-900 font-bold text-white",children:"總計"})]})}),(0,a.jsx)("tbody",{className:"divide-y divide-white/5",children:B.rows.map((e,t)=>(0,a.jsxs)("tr",{className:"hover:bg-zinc-800/30",children:[(0,a.jsx)("td",{className:"px-3 py-2 font-medium text-zinc-300 sticky left-0 bg-zinc-950/90 border-r border-white/5",children:e.roomType}),e.cells.map((e,t)=>{let r=e>0?Math.min(e/20,1):0,s=e>0?{backgroundColor:`rgba(6, 182, 212, ${.3*r})`}:{};return(0,a.jsx)("td",{className:"px-3 py-2 text-center text-zinc-400",style:s,children:e>0?e:"-"},t)}),(0,a.jsx)("td",{className:"px-3 py-2 text-center font-bold text-white border-l border-white/5 bg-zinc-900/50",children:e.rowTotal})]},t))}),(0,a.jsx)("tfoot",{className:"bg-zinc-900 font-bold border-t-2 border-zinc-700",children:(0,a.jsxs)("tr",{children:[(0,a.jsx)("td",{className:"px-3 py-2 sticky left-0 bg-zinc-900 border-r border-white/5 text-white",children:"總計"}),B.locations.map(e=>(0,a.jsx)("td",{className:"px-3 py-2 text-center text-white",children:B.locationTotals[e]},e)),(0,a.jsx)("td",{className:"px-3 py-2 text-center text-cyan-400 border-l border-white/5 bg-zinc-900",children:B.grandTotal})]})})]}):(0,a.jsx)("div",{className:"p-8 text-center text-zinc-500",children:"無區域分佈數據"})})]}),t.includes("location-chart")&&(0,a.jsxs)(n.c,{title:"區域成交佔比圖表",containerRef:h,headerAction:(0,a.jsx)("div",{className:"flex items-center gap-2",children:(0,a.jsx)(j.N,{data:H,filename:"price_band_location_chart_data",label:"匯出",chartType:"price-band-location-chart",targetRef:h,snapshotData:B,chartId:m})}),children:[(0,a.jsxs)("div",{className:"flex flex-wrap items-center gap-3 mb-2","data-html2canvas-ignore":"true",children:[Z(),(0,a.jsx)("div",{className:"ml-auto",children:V()})]}),B&&(0,a.jsx)(f,{roomTypes:r,locations:B.locations,crossTable:B.rows.reduce((e,t)=>{let r={};return B.locations.forEach((e,a)=>{r[e]=t.cells[a]}),e[t.roomType]=r,e},{}),dimension:p,chartId:m})]})]}),(0,a.jsx)(b,{isOpen:N,onClose:()=>z(!1),title:S,projects:k}),(0,a.jsx)(b,{isOpen:N,onClose:()=>z(!1),title:S,projects:k}),(0,a.jsx)(w.K,{})]})}},78269:(e,t,r)=>{r.d(t,{b:()=>_});var a=r(95155),s=r(12115),n=r(68605),i=r(47650),l=r(40980),o=r(43987),c=r(32745),d=r(75364),x=r(8875);let h=(e,t=0)=>e?.toLocaleString(void 0,{maximumFractionDigits:t}),m=[{key:"employee",label:"員工關係戶",shortLabel:"員",badgeClass:"border-purple-500/70 text-purple-300",predicate:e=>!!e.isEmployeeRelated},{key:"office",label:"事務所/商辦",shortLabel:"辦",badgeClass:"border-blue-500/70 text-blue-300",predicate:e=>!!e.isOffice},{key:"storefront",label:"店鋪",shortLabel:"店",badgeClass:"border-amber-500/70 text-amber-300",predicate:e=>!!e.isStorefront}],u=e=>null===e?"#1f2937":e<0?"rgba(16, 185, 129, 0.4)":0===e?"#06b6d4":e>5?"rgba(244, 63, 94, 0.5)":e>2?"rgba(249, 115, 22, 0.5)":"rgba(234, 179, 8, 0.4)",p=({children:e,triggerRect:t,isTopRow:r})=>{if(!t)return null;let s={position:"fixed",left:t.left+t.width/2,transform:"translateX(-50%)",zIndex:9999};return r?s.top=t.bottom+8:s.bottom=window.innerHeight-t.top+8,(0,i.createPortal)((0,a.jsx)("div",{style:s,className:"pointer-events-none",children:e}),document.body)};function f({data:e,floorPremium:t=.3,showGrid:r=!0,showSummary:n=!0,showComparison:i=!0,configProject:f,configScope:g,rawTransactions:b}){let j,v,{horizontalGrid:w,sortedFloors:y,sortedUnits:N,unitColorMap:z,summary:S,horizontalComparison:P}=e,[k,M]=(0,s.useState)(null),[A,C]=(0,s.useState)(null),[E,T]=(0,s.useState)(null),[$,F]=(0,s.useState)(!1),[R,I]=(0,s.useState)("premium"),[D,L]=(0,s.useState)("percent"),[O,_]=(0,s.useState)(null),W=g||d.Ze;(0,s.useEffect)(()=>{if(!f)return;let e=async()=>{let e=(0,d.oP)(f,W);e&&T(e);try{let e=await (0,d.ew)(f);e&&T(e)}catch(e){console.warn("Failed to fetch official config:",e)}};e();let t=t=>{!t.detail?.project||t.detail.project!==f||t.detail?.scope&&t.detail.scope!==W||e()};return window.addEventListener(d.Vz,t),()=>window.removeEventListener(d.Vz,t)},[f,W]),(0,s.useEffect)(()=>{_(null)},[A]);let B=(0,s.useCallback)(e=>{T(e)},[]),U=(0,s.useMemo)(()=>{if(!i||!w||!N||0===N.length)return{topPair:null,maxPairOverall:null,unitOverallStats:new Map,unitFloorStats:new Map,unitsInMaxPair:new Set};let e=new Map(N.map((e,t)=>[e,t])),t=new Map;Object.keys(w||{}).forEach(e=>{let r=new Map,a=w?.[e]||{};Object.keys(a).forEach(e=>{(a[e]||[]).forEach(t=>{if(!t||null===t.premium)return;let a=parseFloat(t["房屋單價(萬)"]||t.unitPrice||0);Number.isFinite(a)&&!(a<=0)&&(r.has(e)||r.set(e,[]),r.get(e).push(a))})}),r.size>0&&t.set(e,r)});let r=new Map,a=new Set,s=null,n=(e,t)=>{let r=e=>e?e.startsWith("B")?-parseInt(e.substring(1)):parseInt(e)||0:0;return r(t)-r(e)},l=(e,t)=>{if(!e.length)return 0;let r=[...e].sort((e,t)=>e-t),a=(r.length-1)*t,s=Math.floor(a);return void 0!==r[s+1]?r[s]+(a-s)*(r[s+1]-r[s]):r[s]},o=(e,t)=>e.reduce((e,r)=>e?Math.abs(r.diff-t)<Math.abs(e.diff-t)?r:e:r,e[0]),c=e=>{if(!e.length)return null;let t=e.map(e=>e.diff),r=l(t,.25),a=l(t,.5),s=l(t,.75),n=a>=0?e.reduce((e,t)=>t.diff>e.diff?t:e,e[0]):e.reduce((e,t)=>t.diff<e.diff?t:e,e[0]);return{q1:r,median:a,q3:s,max:n.diff,samples:{q1:o(e,r),median:o(e,a),q3:o(e,s),max:n}}},d=new Map,x=new Map,h=new Map;Array.from(t.keys()).sort(n).forEach(n=>{let i=t.get(n);if(!i)return;let l=Array.from(i.keys()).sort((t,r)=>(e.get(t)??0)-(e.get(r)??0)),o=null;for(let e=0;e<l.length;e++)for(let t=e+1;t<l.length;t++){let a=l[e],s=l[t],n=i.get(a)||[],c=i.get(s)||[];if(!n.length||!c.length)continue;let d=[],x=n.slice(0,20),h=c.slice(0,20);x.forEach(e=>{h.forEach(t=>{d.push(e-t)})});let m=`${a}__${s}`;r.has(m)||r.set(m,{unitA:a,unitB:s,diffs:[],count:0});let u=r.get(m);u.diffs.push(...d),u.count+=1;let p=d.reduce((e,t)=>Math.abs(t)>Math.abs(e)?t:e,d[0]);(!o||Math.abs(p)>Math.abs(o.diff))&&(o={unitHigh:p>=0?a:s,unitLow:p>=0?s:a,diff:p})}o&&(a.add(o.unitHigh),a.add(o.unitLow),(!s||Math.abs(o.diff)>Math.abs(s.diff))&&(s={floor:n,unitHigh:o.unitHigh,unitLow:o.unitLow,diff:o.diff})),l.forEach(e=>{let t=i.get(e)||[];if(!t.length)return;let r=[],a=t.slice(0,10);if(l.forEach(t=>{if(t===e)return;let s=i.get(t)||[];if(!s.length)return;let l=s.slice(0,10);a.forEach(e=>{l.forEach(a=>{r.push({diff:e-a,otherUnit:t,floor:n})})})}),!r.length)return;let s=c(r);s&&(x.has(e)||x.set(e,[]),x.get(e).push({floor:n,...s}),h.has(e)||h.set(e,[]),h.get(e).push(...r))})}),x.forEach(e=>e.sort((e,t)=>n(e.floor,t.floor))),h.forEach((e,t)=>{let r=c(e);r&&d.set(t,r)});let m=null;return r.forEach(e=>{let t=e.diffs.reduce((e,t)=>e+t,0)/e.diffs.length;if(!m||e.count>m.count){m={unitA:e.unitA,unitB:e.unitB,count:e.count,avgDiff:t};return}e.count===m.count&&Math.abs(t)>Math.abs(m.avgDiff)&&(m={unitA:e.unitA,unitB:e.unitB,count:e.count,avgDiff:t})}),{topPair:m,maxPairOverall:s,unitOverallStats:d,unitFloorStats:x,unitsInMaxPair:a}},[w,N,i]);(0,s.useMemo)(()=>{if(!E?.configurations||!Array.isArray(E.configurations))return null;let e=new Map;return E.configurations.forEach(t=>{if(!t||!Array.isArray(t.positions)||!t.floorRange)return;let r=(0,c.Qy)(t.positions,t.envTiles||[],t.compassDirection||0,1);if(!r||!Array.isArray(r))return;let a=new Map(r.filter(e=>!!e).map(e=>[e.unitType,e])),s=Math.min(Number(t.floorRange.start)||0,Number(t.floorRange.end)||0),n=Math.max(Number(t.floorRange.start)||0,Number(t.floorRange.end)||0);for(let t=s;t<=n;t++)e.set(t,a)}),e},[E]);let q={school:"學校",plaza:"廣場",park:"公園",river:"河景",tower:"高壓塔",grave:"墓地",bridge:"高架橋",mountain:"山景",adjacent:"臨房"},H={N:"北",S:"南",E:"東",W:"西",NE:"東北",NW:"西北",SE:"東南",SW:"西南"},V=e=>{let t=[];if(e.roadFacing){let r=e.roadFacingDirections&&e.roadFacingDirections.length>0?e.roadFacingDirections:e.roadFacingDirection?[e.roadFacingDirection]:[];r.length?r.forEach(e=>{let r=H[e]||e;t.push({text:`${r}臨路`,tone:"road"})}):t.push({text:"臨路",tone:"road"})}if(e.facingOpenSpace&&e.openSpaceType){let r=new Set(["tower","grave","bridge"]);(e.openSpaceFacingDirections&&e.openSpaceFacingDirections.length>0?e.openSpaceFacingDirections.map(e=>({dir:e.direction,type:e.type})):[{dir:e.openSpaceFacingDirection||"",type:e.openSpaceType}]).forEach(e=>{if(!e.type)return;let a=q[e.type]||e.type,s=e.dir?H[e.dir]||e.dir:"",n=s?`${s}`:"";if("adjacent"===e.type)return void t.push({text:`${n}${a}`,tone:"adjacent"});let i=r.has(e.type);t.push({text:`${n}面${a}`,tone:i?"bad":"good"})})}return e.adjacentToUnits&&!t.some(e=>e.text.includes("臨房"))&&t.push({text:"臨房",tone:"adjacent"}),t},Z=(0,s.useMemo)(()=>{if(!E?.configurations||!Array.isArray(E.configurations))return null;let e=new Map;return E.configurations.forEach(t=>{if(!t||!Array.isArray(t.positions))return;let r=(0,c.Qy)(t.positions,t.envTiles||[],t.compassDirection||0,1);r?.forEach(t=>{if(!t)return;let r=V(t);e.has(t.unitType)||e.set(t.unitType,{labelMap:new Map,details:[]});let a=e.get(t.unitType);r.forEach(e=>{a.labelMap.set(e.text,e.tone)})})}),e},[E,V]),[G,Y]=(0,s.useState)(null),[J,X]=(0,s.useState)(null),Q=(()=>{let e=S?.calculationFlags;if(!e)return"排除店舖/辦公室";let t=[];return e.includesStorefrontPremium||t.push("店舖"),e.includesOfficePremium||t.push("辦公室"),e.includesEmployeePremium||t.push("員工關係戶"),t.length?`排除${t.join("/")}`:"全部納入"})(),K=(0,s.useMemo)(()=>{let e={};return w&&N&&N.forEach(t=>{let r=1/0,a=0;if(y?.forEach(e=>{(w?.[e]?.[t]||[]).forEach(e=>{if(!e||e?.isStorefront||e?.isOffice)return;let t=Number(e?.tooltipInfo?.houseArea||e?.houseArea||0);Number.isFinite(t)&&!(t<=0)&&(t<r&&(r=t),t>a&&(a=t))})}),!Number.isFinite(r)||a<=0){e[t]={hasVariance:!1,label:""};return}let s=a-r>3,n=`${r.toFixed(2).replace(/\.00$/,"")}–${a.toFixed(2).replace(/\.00$/,"")} 坪`;e[t]={hasVariance:s,label:s?n:""}}),e},[w,y,N]),ee=()=>{M(null)};return w&&y&&N?(0,a.jsxs)("div",{className:"space-y-8 overflow-x-auto relative",children:[k&&(0,a.jsx)(p,{triggerRect:k.rect,isTopRow:k.isTopRow,children:(j=k.data,v=m.filter(e=>e.predicate(j)).map(e=>e.label),(0,a.jsx)("div",{className:"w-48 bg-zinc-900 border border-zinc-700 rounded-lg p-3 shadow-xl animate-in fade-in zoom-in-95 duration-200",children:(0,a.jsxs)("div",{className:"space-y-1",children:[v.length>0&&(0,a.jsxs)("div",{className:"text-amber-300 text-xs",children:["特殊交易: ",v.join("、")]}),k.data?.hasParking&&(0,a.jsxs)("div",{className:"flex items-center gap-1 text-xs text-blue-300",children:[(0,a.jsx)("span",{className:"flex items-center justify-center w-3 h-3 bg-blue-500 text-white text-[8px] font-bold rounded-sm",children:"P"}),(0,a.jsx)("span",{children:"含車位"})]}),k.data?.premium===0&&(0,a.jsx)("div",{className:"text-cyan-400 font-bold mb-1",children:"★ 基準戶"}),k.data?.premium!==void 0&&k.data?.premium!==null&&(0,a.jsxs)("div",{className:"text-zinc-300",children:["調價: ",(0,a.jsxs)("span",{className:(0,l.cn)(k.data.premium>0?"text-red-400":k.data.premium<0?"text-violet-400":"text-zinc-400"),children:[k.data.premium>0?"+":"",k.data.premium.toFixed(2),"%"]})]}),(0,a.jsx)("div",{className:"h-px bg-zinc-700 my-2"}),(0,a.jsxs)("div",{className:"grid grid-cols-2 gap-x-2 gap-y-1 text-xs text-zinc-400",children:[(0,a.jsx)("span",{children:"成交總價:"})," ",(0,a.jsxs)("span",{className:"text-white text-right",children:[h(k.data?.tooltipInfo?.totalPrice??k.data?.totalPrice),"萬"]}),(0,a.jsx)("span",{children:"房屋總價:"})," ",(0,a.jsxs)("span",{className:"text-white text-right",children:[h(k.data?.tooltipInfo?.housePrice??k.data?.housePrice),"萬"]}),(0,a.jsx)("span",{children:"車位總價:"})," ",(0,a.jsxs)("span",{className:"text-white text-right",children:[h(k.data?.tooltipInfo?.parkingPrice??k.data?.parkingPrice),"萬"]}),(0,a.jsx)("span",{children:"房屋面積:"})," ",(0,a.jsxs)("span",{className:"text-white text-right",children:[h(k.data?.tooltipInfo?.houseArea??k.data?.houseArea,2),"坪"]})]})]})}))}),G&&(0,a.jsx)(p,{triggerRect:G.rect,isTopRow:!0,children:(0,a.jsxs)("div",{className:"w-56 bg-zinc-900 border border-zinc-700 rounded-lg p-2 shadow-xl text-xs text-zinc-300",children:["住宅面積變化: ",(0,a.jsx)("span",{className:"text-amber-300",children:G.label}),(0,a.jsx)("div",{className:"text-[10px] text-zinc-500 mt-1",children:"已排除店舖/商辦"})]})}),r&&(0,a.jsxs)("div",{className:"min-w-max pb-32",children:[(0,a.jsxs)("div",{className:"flex items-center justify-end gap-2 mb-2",children:[(0,a.jsx)("span",{className:"text-xs text-zinc-500",children:"特殊交易"}),m.map(e=>{let t=J===e.key;return(0,a.jsxs)("button",{onClick:()=>X(t=>t===e.key?null:e.key),className:(0,l.cn)("flex items-center gap-1 px-2 py-1 rounded border text-[10px] transition",t?"border-cyan-400 text-cyan-300 bg-cyan-500/10":"border-white/10 text-zinc-400 hover:text-zinc-200 hover:border-white/30"),children:[(0,a.jsx)("span",{className:(0,l.cn)("w-4 h-4 rounded border flex items-center justify-center text-[9px] font-bold bg-transparent",e.badgeClass),title:e.label,children:e.shortLabel}),e.label]},e.key)})]}),(0,a.jsxs)("table",{className:"divide-y divide-zinc-800 border-collapse w-full text-sm",children:[(0,a.jsx)("thead",{children:(0,a.jsxs)("tr",{children:[(0,a.jsx)("th",{className:"sticky left-0 bg-dark-card z-20 p-2 text-zinc-400 border-r border-zinc-800",children:"樓層 \\ 戶別"}),N.map(e=>(0,a.jsx)("th",{className:(0,l.cn)("p-2 text-zinc-300 font-medium border-l border-zinc-800/50 bg-zinc-900/50 relative",K[e]?.hasVariance&&"bg-amber-500/10"),onMouseEnter:t=>{let r=K[e];r?.hasVariance&&Y({rect:t.currentTarget.getBoundingClientRect(),label:r.label})},onMouseLeave:()=>Y(null),children:(0,a.jsxs)("span",{className:"inline-flex items-center justify-center gap-1",children:[e,K[e]?.hasVariance&&(0,a.jsx)("span",{className:"px-1 py-0.5 text-[9px] rounded border border-amber-400/70 text-amber-300 bg-amber-500/10",children:"Δ坪"})]})},e))]})}),(0,a.jsx)("tbody",{className:"divide-y divide-zinc-800/50",children:y.map((e,t)=>(0,a.jsxs)("tr",{className:"hover:bg-zinc-800/30 transition-colors",children:[(0,a.jsx)("td",{className:"sticky left-0 bg-dark-card z-10 p-2 font-bold text-zinc-300 border-r border-zinc-800 text-center",children:e}),N.map(r=>{let s=w[e]?.[r];return s&&0!==s.length?(0,a.jsx)("td",{className:"p-1 border-l border-zinc-800/50 align-top",children:(0,a.jsx)("div",{className:"flex flex-col gap-1",children:s.map((e,r)=>{let s=m.filter(t=>t.predicate(e)),n=s.length>0,i=n?"transparent":u(e.premium),c=e.remark?.includes("露台")?{icon:(0,a.jsx)(o.A,{className:"w-3 h-3"}),label:"露台"}:null,d=0===e.premium,x=t<3,h=J?m.find(e=>e.key===J)?.predicate:null,p=!h||h(e);return(0,a.jsxs)("div",{className:(0,l.cn)("p-1.5 rounded text-xs transition-transform hover:scale-105 cursor-default relative group",d&&"ring-1 ring-cyan-500",n&&"bg-transparent border border-zinc-700/60",J&&!p&&"opacity-20",J&&p&&"ring-2 ring-cyan-400"),style:{backgroundColor:i},onMouseEnter:t=>{M({rect:t.currentTarget.getBoundingClientRect(),data:e,isTopRow:x})},onMouseLeave:ee,children:[(0,a.jsxs)("div",{className:"flex flex-col gap-0.5 pr-4",children:[(0,a.jsxs)("span",{className:"font-semibold text-white flex items-center gap-1 leading-tight",children:[c&&(0,a.jsx)("span",{className:"text-zinc-200",title:c.label,children:c.icon}),e.unitPrice.toFixed(1),"萬"]}),(0,a.jsx)("div",{className:"text-[10px] text-zinc-300 font-mono tracking-tight opacity-90",children:e.transactionDate||"-"})]}),(0,a.jsxs)("div",{className:"absolute top-0.5 right-0.5 flex flex-col items-end gap-0.5",children:[s.map(e=>(0,a.jsx)("span",{className:(0,l.cn)("flex items-center justify-center w-3 h-3 text-[8px] font-bold rounded border bg-transparent",e.badgeClass),title:e.label,children:e.shortLabel},e.key)),e.hasParking&&(0,a.jsx)("span",{className:"flex items-center justify-center w-3 h-3 bg-blue-500 text-white text-[8px] font-bold rounded-sm",title:"含車位",children:"P"})]})]},r)})})},`${e}-${r}`):(0,a.jsx)("td",{className:"p-2 border-l border-zinc-800/50 bg-zinc-900/20 text-center text-zinc-600",children:"-"},`${e}-${r}`)})]},e))})]})]}),n&&S&&(0,a.jsxs)("div",{className:"space-y-2",children:[(0,a.jsxs)("h3",{className:"text-lg font-semibold text-zinc-200",children:["調價幅度統計摘要 (",Q,")"]}),(0,a.jsx)("div",{className:"overflow-x-auto rounded-lg border border-zinc-800",children:(0,a.jsxs)("table",{className:"w-full text-sm text-left text-zinc-300",children:[(0,a.jsx)("thead",{className:"text-xs text-zinc-400 uppercase bg-zinc-900/50",children:(0,a.jsxs)("tr",{children:[(0,a.jsx)("th",{className:"px-6 py-3",children:"基準房屋總價"}),(0,a.jsx)("th",{className:"px-6 py-3",children:"調價幅度總額"}),(0,a.jsx)("th",{className:"px-6 py-3",children:"總溢價率"}),(0,a.jsx)("th",{className:"px-6 py-3",children:"已售房屋坪數"}),(0,a.jsx)("th",{className:"px-6 py-3",children:"平均單價調價"})]})}),(0,a.jsx)("tbody",{children:(0,a.jsxs)("tr",{className:"bg-zinc-900/20 border-b border-zinc-800",children:[(0,a.jsxs)("td",{className:"px-6 py-4",children:[h(S.totalBaselineHousePrice)," 萬"]}),(0,a.jsxs)("td",{className:(0,l.cn)("px-6 py-4 font-bold",S.totalPricePremiumValue>0?"text-red-400":"text-violet-400"),children:[S.totalPricePremiumValue>0?"+":"",h(S.totalPricePremiumValue)," 萬"]}),(0,a.jsxs)("td",{className:"px-6 py-4",children:[(S.totalPricePremiumValue/S.totalBaselineHousePrice*100).toFixed(2)," %"]}),(0,a.jsxs)("td",{className:"px-6 py-4",children:[h(S.totalSoldArea)," 坪"]}),(0,a.jsxs)("td",{className:(0,l.cn)("px-6 py-4",S.totalPricePremiumValue>0?"text-red-400":"text-violet-400"),children:[(S.totalPricePremiumValue/S.totalSoldArea).toFixed(2)," 萬/坪"]})]})})]})})]}),i&&P&&P.length>0&&(0,a.jsxs)("div",{className:"space-y-2",children:[(0,a.jsx)("h3",{className:"text-lg font-semibold text-zinc-200",children:"戶型水平價差與溢價貢獻"}),(0,a.jsxs)("div",{className:"flex flex-wrap items-center gap-2 text-xs text-zinc-400",children:[e.comparisonMeta&&(0,a.jsxs)("span",{children:["原始最低戶型：",e.comparisonMeta.originalMinUnit||"-"," ","number"==typeof e.comparisonMeta.originalMinAvg?`(${e.comparisonMeta.originalMinAvg.toFixed(2)} 萬/坪)`:""," ｜ ","實際最低戶型：",e.comparisonMeta.actualMinUnit||"-"," ","number"==typeof e.comparisonMeta.actualMinAvg?`(${e.comparisonMeta.actualMinAvg.toFixed(2)} 萬/坪)`:""]}),U.topPair&&(0,a.jsxs)("span",{children:["AI 摘要：常見價差組合 ",U.topPair.unitA," ↔ ",U.topPair.unitB,"（",U.topPair.count," 層，平均差 ",U.topPair.avgDiff>0?"+":"",U.topPair.avgDiff.toFixed(2),"）"]}),U.maxPairOverall&&(0,a.jsxs)("span",{children:["最大價差：",U.maxPairOverall.floor,"F ",U.maxPairOverall.unitHigh," ↔ ",U.maxPairOverall.unitLow,"（",U.maxPairOverall.diff>0?"+":"",U.maxPairOverall.diff.toFixed(2),"）"]}),f&&(0,a.jsxs)("div",{className:"flex items-center gap-2 text-zinc-500",children:[(0,a.jsxs)("span",{children:["樓層配置：",E?.configurations?.length?`已同步 ${E.configurations.length} 組`:"未設定"]}),b&&b.length>0&&(0,a.jsx)("button",{onClick:()=>F(e=>!e),className:"px-2 py-1 rounded border border-white/10 text-[11px] text-zinc-400 hover:text-zinc-200 hover:border-white/30 transition",children:$?"收合配置":"設定配置"})]})]}),$&&b&&b.length>0&&f&&(0,a.jsx)("div",{className:"mt-3",children:(0,a.jsx)(x.sB,{transactions:b,project:f,configOnly:!0,title:"樓層配置（戶型水平價差）",storageScope:W,initialStep:"config",onConfigChange:B,mode:"report"})}),(0,a.jsx)("div",{className:"overflow-x-auto rounded-lg border border-zinc-800",children:(0,a.jsxs)("table",{className:"w-full text-sm text-left text-zinc-300",children:[(0,a.jsx)("thead",{className:"text-xs text-zinc-400 uppercase bg-zinc-900/50",children:(0,a.jsxs)("tr",{children:[(0,a.jsx)("th",{className:"px-4 py-3",children:"戶型"}),(0,a.jsx)("th",{className:"px-4 py-3",children:"環境標籤"}),(0,a.jsx)("th",{className:"px-4 py-3",children:"基準戶 (樓/價)"}),(0,a.jsx)("th",{className:"px-4 py-3",children:"原始平均單價"}),(0,a.jsx)("th",{className:"px-4 py-3",children:"實際平均單價"}),(0,a.jsx)("th",{className:"px-4 py-3",children:"去化戶數"}),(0,a.jsx)("th",{className:"px-4 py-3",children:"去化坪數"}),(0,a.jsx)("th",{className:"px-4 py-3",children:"溢價(萬/坪)"}),(0,a.jsx)("th",{className:"px-4 py-3",children:"溢價貢獻"}),(0,a.jsx)("th",{className:"px-4 py-3",children:"貢獻佔比"}),(0,a.jsx)("th",{className:"px-4 py-3",children:"細節"})]})}),(0,a.jsx)("tbody",{children:P.map((e,t)=>{let r,n,i,o=t=>{t&&t!==e.unitType?_(e=>e===t?null:t):_(null)},c=O&&O!==e.unitType?[e.unitType,O]:[e.unitType];return(0,a.jsxs)(s.Fragment,{children:[(0,a.jsxs)("tr",{className:"bg-zinc-900/20 border-b border-zinc-800 hover:bg-zinc-800/20",children:[(0,a.jsx)("td",{className:"px-4 py-3 font-medium text-white",children:e.unitType}),(0,a.jsx)("td",{className:"px-4 py-3",children:(n=(r=Z?.get(e.unitType))?Array.from(r.labelMap.entries()):[]).length?(0,a.jsx)("div",{className:"flex flex-wrap gap-1",title:r?.details.join(" | "),children:n.map(([t,r])=>(0,a.jsx)("span",{className:`px-2 py-0.5 rounded text-[10px] border ${(e=>{switch(e){case"road":return"border-amber-400/40 text-amber-300 bg-amber-500/10";case"good":return"border-emerald-400/40 text-emerald-300 bg-emerald-500/10";case"bad":return"border-rose-400/40 text-rose-300 bg-rose-500/10";case"adjacent":return"border-zinc-500/40 text-zinc-300 bg-zinc-500/10";default:return"border-white/10 text-zinc-300 bg-white/5"}})(r)}`,children:t},`${e.unitType}-${t}`))}):(0,a.jsx)("span",{className:"text-zinc-500",children:"-"})}),(0,a.jsx)("td",{className:"px-4 py-3",children:e.anchorInfo}),(0,a.jsx)("td",{className:"px-4 py-3",children:"number"==typeof e.originalAvgPrice?`${e.originalAvgPrice.toFixed(2)} 萬/坪`:"-"}),(0,a.jsx)("td",{className:"px-4 py-3",children:"number"==typeof e.actualAvgPrice?`${e.actualAvgPrice.toFixed(2)} 萬/坪`:"-"}),(0,a.jsxs)("td",{className:"px-4 py-3",children:[e.unitsSold," 戶"]}),(0,a.jsx)("td",{className:"px-4 py-3",children:"number"==typeof e.totalSoldArea?`${e.totalSoldArea.toFixed(2)} 坪`:"-"}),(0,a.jsx)("td",{className:(0,l.cn)("px-4 py-3",e.avgPremiumPerPing>0?"text-red-400":"text-violet-400"),children:"number"==typeof e.avgPremiumPerPing?`${e.avgPremiumPerPing>0?"+":""}${e.avgPremiumPerPing.toFixed(2)} 萬/坪`:"-"}),(0,a.jsxs)("td",{className:(0,l.cn)("px-4 py-3 font-bold",e.timePremiumContribution>0?"text-red-400":"text-violet-400"),children:[e.timePremiumContribution>0?"+":"",h(e.timePremiumContribution)," 萬"]}),(0,a.jsxs)("td",{className:"px-4 py-3",children:["number"==typeof e.contributionPercentage?e.contributionPercentage.toFixed(2):"0.00","%"]}),(0,a.jsx)("td",{className:"px-4 py-3",children:(0,a.jsx)("button",{onClick:()=>C(t=>t===e.unitType?null:e.unitType),className:"text-[11px] text-cyan-300 border border-cyan-400/30 rounded px-2 py-1 hover:bg-cyan-500/10 transition",children:A===e.unitType?"收合":"展開"})})]}),A===e.unitType&&(0,a.jsx)("tr",{className:"bg-zinc-950/40 border-b border-zinc-800",children:(0,a.jsx)("td",{colSpan:11,className:"px-4 py-3",children:(0,a.jsxs)("div",{className:"flex flex-col xl:flex-row gap-6",children:[(0,a.jsx)("div",{className:"xl:w-[400px] shrink-0",children:(0,a.jsxs)("div",{className:"bg-zinc-900/40 rounded border border-white/10 p-2 h-full flex flex-col",children:[(0,a.jsxs)("h4",{className:"text-xs font-bold text-zinc-400 mb-2 flex items-center gap-2",children:[(0,a.jsx)("span",{className:"w-1.5 h-1.5 rounded-full bg-cyan-400"}),"樓層配置視圖"]}),(0,a.jsx)("div",{className:"flex-1 min-h-[300px] relative rounded overflow-hidden bg-zinc-950/50 border border-white/5",children:(()=>{let e=E?.configurations?.[0];if(!e)return(0,a.jsx)("div",{className:"absolute inset-0 flex items-center justify-center text-zinc-500 text-xs",children:"無配置資料"});let t=(e.positions||[]).map(e=>(0,x.jk)(e,1)),r=e.envTiles||[];return(0,a.jsx)(x.Cn,{positions:t,envTiles:r,selectedUnits:c,zoom:.6,gridSize:e.gridSize||30,compassDirection:e.compassDirection||0,onPositionsChange:()=>{},onUnitClick:e=>o(e),onZoomChange:()=>{},isAnalyzeMode:!0,showBadges:!1,unitShape:"square"})})()}),(0,a.jsx)("div",{className:"mt-2 text-[10px] text-zinc-500 text-center",children:"* 此為唯讀視圖，顯示目前選擇戶型位置"})]})}),(0,a.jsxs)("div",{className:"flex-1 rounded border border-white/10 bg-zinc-900/40 p-3 overflow-hidden",children:[(0,a.jsxs)("div",{className:"flex items-center justify-between mb-3",children:[(0,a.jsxs)("div",{className:"text-xs text-zinc-400",children:["戶型比價矩陣（單位：","percent"===D?"%":"萬/坪","，",(0,a.jsx)("span",{className:"text-red-400",children:"紅>5%"}),"，",(0,a.jsx)("span",{className:"text-orange-400",children:"橘2~5%"}),"，",(0,a.jsx)("span",{className:"text-yellow-400",children:"黃0~2%"}),"，",(0,a.jsx)("span",{className:"text-emerald-400",children:"綠<0%"}),"）"]}),(0,a.jsxs)("div",{className:"flex bg-zinc-950 p-0.5 rounded-md border border-zinc-800",children:[(0,a.jsx)("button",{onClick:e=>{e.stopPropagation(),L("value")},className:(0,l.cn)("px-2 py-1 text-[10px] rounded transition-all","value"===D?"bg-zinc-800 text-white shadow-sm":"text-zinc-500 hover:text-zinc-300"),children:"價差數值 $"}),(0,a.jsx)("button",{onClick:e=>{e.stopPropagation(),L("percent")},className:(0,l.cn)("px-2 py-1 text-[10px] rounded transition-all","percent"===D?"bg-zinc-800 text-white shadow-sm":"text-zinc-500 hover:text-zinc-300"),children:"價差比例 %"})]})]}),(0,a.jsx)("div",{className:"overflow-x-auto",children:(0,a.jsxs)("table",{className:"w-full text-xs border-collapse",children:[(0,a.jsx)("thead",{children:(0,a.jsxs)("tr",{children:[(0,a.jsx)("th",{className:"p-2 text-zinc-500 font-normal text-left whitespace-nowrap sticky left-0 bg-zinc-900/90 z-10 border-b border-zinc-800",children:"樓層"}),N.filter(t=>t!==e.unitType).map(e=>{let t=Z?.get(e),r=t?Array.from(t.labelMap.keys()):[],s=O===e;return(0,a.jsx)("th",{onClick:()=>o(e),className:(0,l.cn)("p-2 text-zinc-400 font-medium text-center whitespace-nowrap min-w-[60px] border-b border-zinc-800 align-top cursor-pointer transition-colors",s&&"bg-cyan-500/10 text-cyan-200 ring-1 ring-cyan-400/40"),title:"點擊高亮此戶型欄位",children:(0,a.jsxs)("div",{className:"flex flex-col gap-0.5 items-center",children:[(0,a.jsxs)("span",{children:["vs ",e]}),r.map((e,t)=>(0,a.jsx)("span",{className:"text-[10px] bg-zinc-800 text-zinc-400 px-1 rounded transform scale-90 origin-top",children:e},t))]})},e)})]})}),(0,a.jsx)("tbody",{className:"divide-y divide-zinc-800/30",children:(i=N.filter(t=>t!==e.unitType),y.map(t=>{let r=w?.[t]?.[e.unitType],s=r?.[0];if(!s||!s.unitPrice)return null;let n=s.unitPrice;return(0,a.jsxs)("tr",{className:"hover:bg-zinc-800/20",children:[(0,a.jsxs)("td",{className:"p-2 text-zinc-500 font-mono sticky left-0 bg-zinc-900/90 border-r border-zinc-800/50",children:[t,"F"]}),i.map(e=>{let r=w?.[t]?.[e],s=r?.[0],i=s?.unitPrice,o=O===e;if(!i)return(0,a.jsx)("td",{className:(0,l.cn)("p-2 text-center text-zinc-700 transition-colors",o&&"bg-cyan-500/10 ring-1 ring-cyan-400/30"),children:"-"},e);let c=n-i,d=c/i*100,x=u(d),h="text-zinc-200";h=d>5?"text-white font-bold shadow-sm":d<0?"text-emerald-100":d>2?"text-orange-100":"text-yellow-100",.1>Math.abs(d)&&(h="text-zinc-400");let m="percent"===D?`${d.toFixed(1)}%`:c.toFixed(1),p=c>0?"+":"";return(0,a.jsx)("td",{className:(0,l.cn)("p-1 text-center transition-colors",o&&"bg-cyan-500/10"),children:(0,a.jsxs)("div",{className:(0,l.cn)("py-1 px-1.5 rounded text-[11px] font-mono transition-colors",h,o&&"ring-2 ring-cyan-400/70 ring-offset-1 ring-offset-zinc-900/40"),style:{backgroundColor:x},title:`${e}: ${i}萬/坪`,children:[p,m]})},e)})]},t)}))})]})})]})]})})})]},t)})})]})})]})]}):(0,a.jsx)("div",{className:"text-zinc-500 text-center p-8",children:"無有效熱力圖資料"})}var g=r(89579),b=r(80642),j=r(39430),v=r(86901),w=r(94514),y=r(21628);function N({transactions:e,currentPremium:t,onApply:r,onManualChange:n}){let[i,l]=(0,s.useState)(null),[o,c]=(0,s.useState)(!1),[d,x]=(0,s.useState)(String(t)),h=(0,s.useRef)(null),[m,u]=(0,s.useState)(null),[p,f]=(0,s.useState)(360),N=Math.max(160,p-28),z=(0,s.useMemo)(()=>(function(e){if(!e||0===e.length)return[];let t=[],r={},a=new g.B$(e);e.forEach(e=>{let t=((e,t)=>{let r=e?.["戶型"];if("string"==typeof r&&r)return r;let a=t.resolve(e);if(a)return a;let s=e?.["戶別"]||e?.unit||e?.unitName;return"string"==typeof s&&s?s:""})(e,a),s=(e=>{if(!e)return 0;let t=String(e).match(/\d+/);return t?parseInt(t[0],10):0})(e["樓層"]||e.floor||""),n=parseFloat(e["房屋單價(萬)"]||e.unitPrice||0);t&&0!==s&&n>0&&(r[t]||(r[t]=[]),r[t].push({floor:s,price:n,original:e}))}),Object.entries(r).forEach(([e,r])=>{r.sort((e,t)=>e.floor-t.floor);for(let a=0;a<r.length;a++)for(let s=a+1;s<r.length;s++){let n=r[a],i=r[s],l=i.floor-n.floor;if(l>0&&l<=10){let r=Math.round(10*((i.price-n.price)/l))/10;r>=-2&&r<=2&&t.push({stack:e,floorLow:n.floor,floorHigh:i.floor,priceLow:n.price,priceHigh:i.price,diff:r,dateLow:n.original["交易年月日"]||n.original["交易日"]||n.original.transactionDate,dateHigh:i.original["交易年月日"]||i.original["交易日"]||i.original.transactionDate})}}});let s=new Map;t.forEach(e=>{let t=`${e.stack}-${e.floorLow}-${e.floorHigh}-${e.priceLow}-${e.priceHigh}`;s.has(t)||s.set(t,e)});let n=Array.from(s.values()),i={};n.forEach(e=>{i[e.diff]||(i[e.diff]={premium:e.diff,count:0,pairs:[]}),i[e.diff].count+=1,i[e.diff].pairs.push(e)});let l=Object.values(i);return l.sort((e,t)=>t.count!==e.count?t.count-e.count:e.premium-t.premium),l})(e),[e]),S=(0,s.useMemo)(()=>[...z.slice(0,5)].sort((e,t)=>e.premium-t.premium),[z]),P=(0,s.useMemo)(()=>[...z].sort((e,t)=>e.premium-t.premium),[z]),k=(0,s.useMemo)(()=>o?P:S,[o,P,S]),M=(0,s.useMemo)(()=>z.find(e=>1e-6>Math.abs(e.premium-t))||null,[z,t]),A=z.length>S.length;(0,s.useEffect)(()=>{l(null)},[M?.premium]),(0,s.useEffect)(()=>{x(String(t))},[t]),(0,s.useEffect)(()=>{if(!h.current)return;let e=()=>{if(!h.current)return;let e=Math.round(h.current.getBoundingClientRect().width);e>0&&u(e)};e();let t=new ResizeObserver(()=>e());return t.observe(h.current),window.addEventListener("resize",e),()=>{t.disconnect(),window.removeEventListener("resize",e)}},[]),(0,s.useEffect)(()=>{let e=()=>{f(Math.max(260,Math.min(520,Math.round(.55*window.innerHeight))))};return e(),window.addEventListener("resize",e),()=>window.removeEventListener("resize",e)},[]);let C=(0,s.useMemo)(()=>{let t=new Set,r=new Set,a=new g.B$(e);e.forEach(e=>{if(!e)return;let s=(e=>{let t=e?.["戶型"];if("string"==typeof t&&t)return t;let r=a.resolve(e);if(r)return r;let s=e?.["戶別"]||e?.unit||e?.unitName;return"string"==typeof s&&s?s:""})(e),n=(e=>{if(!e)return 0;let t=String(e).match(/\d+/);return t?parseInt(t[0],10):0})(e["樓層"]||e.floor);s&&t.add(s),0!==n&&r.add(n)});let s=Array.from(r).sort((e,t)=>t-e),n=e=>{let t=String(e||"").trim().toUpperCase(),r=t.match(/^([A-Z]+)(\d+)?$/);return r?{alpha:r[1]||"",num:r[2]?parseInt(r[2],10):Number.MAX_SAFE_INTEGER,raw:t}:{alpha:t,num:Number.MAX_SAFE_INTEGER,raw:t}},i=Array.from(t).sort((e,t)=>{let r=n(e),a=n(t),s=r.alpha.localeCompare(a.alpha,"en");return 0!==s?s:r.num!==a.num?r.num-a.num:r.raw.localeCompare(a.raw,"en")}),l=new Set;M&&M.pairs.forEach(e=>{l.add(`${e.stack}-${e.floorLow}`),l.add(`${e.stack}-${e.floorHigh}`)});let o=s.length||1,c=i.length||1,d=(m||0)-32-16,x=p-24-4,h=Math.min(40,Math.max(8,Math.min(d>0?Math.floor(d/c):24,x>0?Math.floor(x/o):24)));return{sortedFloors:s,sortedStacks:i,highlightedCells:l,cellSize:h,gridHeight:o*h+24}},[e,M,m,p]);if(0===z.length)return null;let E=null!==i&&M?M.pairs[i]:null;return(0,a.jsxs)("div",{className:"bg-zinc-900/50 border border-white/10 rounded-xl p-4 mb-6",children:[(0,a.jsxs)("div",{className:"flex items-center gap-2 mb-3",children:[(0,a.jsx)(v.A,{className:"w-4 h-4 text-yellow-400"}),(0,a.jsx)("h3",{className:"text-sm font-bold text-zinc-100",children:"AI 樓層價差分析建議"})]}),(0,a.jsxs)("div",{className:"flex flex-wrap gap-2 mb-4 items-center",children:[k.map(e=>{let s=1e-6>Math.abs(t-e.premium);return(0,a.jsxs)("button",{onClick:()=>{r(e.premium)},className:`
                                relative px-3 py-1.5 rounded-lg border text-xs font-mono transition-all
                                flex items-center gap-2
                                ${s?"bg-cyan-500/20 border-cyan-500 text-cyan-300":"bg-zinc-800 border-white/5 text-zinc-400 hover:border-white/20 hover:text-zinc-200"}
                            `,children:[(0,a.jsxs)("span",{className:"text-base font-bold",children:[e.premium>0?"+":"",e.premium]}),(0,a.jsx)("span",{className:"opacity-50",children:"萬/坪"}),(0,a.jsxs)("span",{className:"ml-1 bg-black/20 px-1.5 rounded text-[10px]",children:[e.count," 組"]}),s&&(0,a.jsx)(w.A,{className:"w-3 h-3 text-green-400"})]},e.premium)}),n&&(0,a.jsxs)("div",{className:"flex items-center gap-2 px-3 py-1.5 rounded-lg border border-white/10 bg-zinc-900/60 text-xs text-zinc-300",children:[(0,a.jsx)("span",{className:"text-[10px] text-zinc-500",children:"手動"}),(0,a.jsx)("input",{type:"text",inputMode:"decimal",value:d,onChange:e=>x(e.target.value),onBlur:()=>{let e=Number(d);Number.isNaN(e)||n(Math.max(0,e))},onKeyDown:e=>{if("Enter"===e.key){let t=Number(d);Number.isNaN(t)||(n(Math.max(0,t)),e.target.blur())}},className:"w-16 bg-transparent text-right pr-1 outline-none text-zinc-200"}),(0,a.jsx)("span",{className:"text-[10px] text-violet-300",children:"萬/坪"})]}),A&&(0,a.jsx)("button",{onClick:()=>c(e=>!e),className:"px-3 py-1.5 rounded-lg border border-white/10 bg-zinc-800 text-[10px] text-zinc-400 hover:text-zinc-200 hover:border-white/30 transition",children:o?"收合標籤":"顯示全部"})]}),(0,a.jsx)(b.N,{children:M&&(0,a.jsx)(j.P.div,{initial:{opacity:0,height:0},animate:{opacity:1,height:"auto"},exit:{opacity:0,height:0},className:"overflow-hidden",children:(0,a.jsxs)("div",{className:"border-t border-white/10 pt-4 mt-2",children:[(0,a.jsxs)("div",{className:"flex justify-between items-end mb-3",children:[(0,a.jsxs)("div",{className:"text-xs text-zinc-400",children:[(0,a.jsx)("span",{className:"text-cyan-400 font-bold",children:M.count})," 組對比符合此規律。 點擊右側明細可連動網格顯示。"]}),(0,a.jsx)("div",{className:"text-[10px] text-zinc-500",children:"點擊上方標籤即可套用"})]}),(0,a.jsxs)("div",{className:"flex flex-col xl:flex-row gap-4 items-stretch",children:[(0,a.jsx)("div",{ref:h,className:"flex-1 bg-black/40 rounded border border-white/5 p-2 overflow-hidden relative",style:{height:p},children:(0,a.jsxs)("div",{className:"w-full",children:[(0,a.jsxs)("div",{className:"flex",children:[(0,a.jsx)("div",{className:"shrink-0",style:{width:32}}),C.sortedStacks.map(e=>(0,a.jsx)("div",{className:"text-center text-[10px] text-zinc-500 pb-1",style:{width:C.cellSize},children:e},e))]}),C.sortedFloors.map(e=>(0,a.jsxs)("div",{className:"flex items-center relative z-10",style:{height:C.cellSize},children:[(0,a.jsxs)("div",{className:"shrink-0 text-right text-[10px] text-zinc-600 pr-2",style:{width:32},children:[e,"F"]}),C.sortedStacks.map(t=>{let r=`${t}-${e}`,s=C.highlightedCells.has(r),n=E&&E.stack===t&&(e===E.floorLow||e===E.floorHigh),i=M.pairs.some(r=>r.stack===t&&e>r.floorLow&&e<r.floorHigh),l=E&&E.stack===t&&e>E.floorLow&&e<E.floorHigh;return(0,a.jsxs)("div",{className:"h-full flex items-center justify-center p-0.5 relative",style:{width:C.cellSize},children:[i&&(0,a.jsx)("div",{className:`
                                                                    absolute w-0.5 h-[140%] top-[-20%] transition-colors duration-200
                                                                    ${l?"bg-yellow-400 z-20":"bg-cyan-500/20"}
                                                                `}),(0,a.jsx)("div",{className:`
                                                                    w-full h-full rounded-sm transition-all duration-200 relative z-10
                                                                    ${n?"bg-yellow-400 shadow-[0_0_12px_rgba(250,204,21,0.8)] scale-100 ring-2 ring-white/50 z-30":s?"bg-cyan-500 shadow-[0_0_8px_rgba(6,182,212,0.6)] scale-90":"bg-zinc-800/30"}
                                                                `})]},r)})]},e))]})}),(0,a.jsxs)("div",{className:"w-full xl:w-[380px] flex flex-col gap-2",style:{height:p},children:[(0,a.jsxs)("div",{className:"text-[10px] uppercase tracking-wider text-zinc-500 font-bold mb-1",children:["對比明細 (共 ",M.pairs.length," 組)"]}),(0,a.jsx)("div",{className:"flex flex-col gap-2 overflow-y-auto pr-2 custom-scrollbar",style:{maxHeight:N},children:M.pairs.map((e,t)=>(0,a.jsxs)("div",{onMouseEnter:()=>l(t),onMouseLeave:()=>l(null),className:`
                                                    border rounded-lg p-2 flex items-center justify-between group transition-all cursor-crosshair
                                                    ${i===t?"bg-yellow-400/10 border-yellow-400/50 translate-x-1":"bg-white/5 border-white/5 hover:border-white/20"}
                                                `,children:[(0,a.jsxs)("div",{className:"flex items-center gap-3",children:[(0,a.jsx)("div",{className:`
                                                        w-8 h-8 rounded flex items-center justify-center font-bold text-xs border transition-colors
                                                        ${i===t?"bg-yellow-400/20 text-yellow-400 border-yellow-400/30":"bg-cyan-500/10 text-cyan-400 border-cyan-500/20"}
                                                    `,children:e.stack}),(0,a.jsxs)("div",{className:"flex flex-col",children:[(0,a.jsxs)("div",{className:"flex items-center gap-1.5 leading-none",children:[(0,a.jsxs)("span",{className:"text-xs text-zinc-300",children:[e.floorLow,"F"]}),(0,a.jsx)(y.A,{className:`w-3 h-3 ${i===t?"text-yellow-400":"text-zinc-600"}`}),(0,a.jsxs)("span",{className:"text-xs text-zinc-100 font-bold",children:[e.floorHigh,"F"]})]}),(0,a.jsxs)("div",{className:"text-[10px] text-zinc-500 mt-1 flex gap-1 items-center",children:[(0,a.jsx)("span",{className:"opacity-70",children:e.dateLow||"N/A"}),(0,a.jsx)("span",{className:"opacity-30",children:"|"}),(0,a.jsx)("span",{className:"opacity-70",children:e.dateHigh||"N/A"})]})]})]}),(0,a.jsxs)("div",{className:"text-right",children:[(0,a.jsxs)("div",{className:"text-xs font-mono text-zinc-200",children:[e.priceLow,(0,a.jsx)("span",{className:"text-[10px] opacity-40 mx-1",children:"→"}),e.priceHigh]}),(0,a.jsxs)("div",{className:`text-[10px] font-bold ${i===t?"text-yellow-400":"text-cyan-400/80"}`,children:["+",e.diff," 萬/層"]})]})]},t))})]})]})]})})})]})}var z=r(13545);class S extends s.Component{static getDerivedStateFromError(e){return{hasError:!0,error:e,errorInfo:null}}componentDidCatch(e,t){console.error("Uncaught error:",e,t),this.setState({error:e,errorInfo:t})}render(){return this.state.hasError?(0,a.jsxs)("div",{className:"p-6 bg-red-950/20 border border-red-500/30 rounded-lg flex flex-col items-center justify-center text-center gap-4 min-h-[200px]",children:[(0,a.jsx)("div",{className:"bg-red-500/10 p-3 rounded-full",children:(0,a.jsx)(z.A,{className:"w-8 h-8 text-red-400"})}),(0,a.jsxs)("div",{children:[(0,a.jsx)("h2",{className:"text-lg font-bold text-red-200 mb-1",children:this.props.fallbackTitle||"Something went wrong"}),this.props.componentName&&(0,a.jsxs)("p",{className:"text-xs text-red-400/80 font-mono mb-2",children:["Component: ",this.props.componentName]}),(0,a.jsx)("div",{className:"max-w-md bg-black/50 p-3 rounded text-left overflow-auto max-h-[150px] border border-red-500/20",children:(0,a.jsx)("p",{className:"text-xs font-mono text-red-300 break-all",children:this.state.error?.toString()})}),(0,a.jsx)("button",{className:"mt-4 px-4 py-2 bg-red-900/40 hover:bg-red-900/60 text-red-200 text-xs rounded transition-colors",onClick:()=>this.setState({hasError:!1,error:null,errorInfo:null}),children:"Try to Recover"})]})]}):this.props.children}constructor(...e){super(...e),this.state={hasError:!1,error:null,errorInfo:null}}}var P=r(29991),k=r(60529),M=r(89239),A=r(37618),C=r(61878),E=r(56722);let T=e=>{let t=String(e?.["樓層"]||e?.floor||e?.layer||""),r="1"===t||"001"===t||t.includes("一樓"),a=e?.["建物型態"]||e?.buildingType||"",s=e?.["主要用途"]||e?.mainPurpose||"",n=e?.["備註"]||e?.note||"",i=a.includes("店")||e.buildingType?.includes("店")||"商業用"===s||"商業用"===e.mainPurpose||n.includes("店")||e.note?.includes("店"),l=a.includes("辦公")||e.buildingType?.includes("辦公")||a.includes("廠辦")||e.buildingType?.includes("廠辦")||a.includes("事務所")||e.buildingType?.includes("事務所")||s.includes("辦公")||e.mainPurpose?.includes("辦公")||s.includes("事務所")||e.mainPurpose?.includes("事務所")||n.includes("辦公")||n.includes("事務所")||e.note?.includes("辦公")||e.note?.includes("事務所");return{buildingType:a,mainPurpose:s,note:n,isStorefront:i&&r,isOffice:l||i&&!r}},$=e=>{let{note:t,isStorefront:r,isOffice:a}=T(e),s=t.includes("親友")||t.includes("員工")||t.includes("關係人")||t.includes("關係戶")||t.includes("員工關係");return{note:t,isStorefront:r,isOffice:a,isEmployeeRelated:s}};var F=r(88743),R=r(27529),I=r(55873),D=r(98883),L=r(89733);function O({transactions:e,project:t}){let[r,n]=(0,s.useState)(""),[i,l]=(0,s.useState)(""),[o,c]=(0,s.useState)(null),[d,x]=(0,s.useState)(!1),[h,m]=(0,s.useState)(null),u=e=>{if(null==e)return null;if("number"==typeof e&&Number.isFinite(e))return e;let t=String(e).trim();if(!t||t.startsWith("B")||t.includes("地下")||t.includes("負"))return null;let r=t.match(/-?\d+/);if(!r)return null;let a=parseInt(r[0],10);return!Number.isFinite(a)||a<=0?null:a};(0,s.useEffect)(()=>{n(""),l(""),c(null)},[t]),(0,s.useEffect)(()=>{let e=()=>{x(!1),m(null)};return window.addEventListener("pointerup",e),()=>window.removeEventListener("pointerup",e)},[]);let p=s.useMemo(()=>{if(!e||0===e.length)return[];let t=0;return(e.forEach(e=>{let r=u(e["樓層"]);r&&r>t&&(t=r)}),t)?Array.from({length:t},(e,t)=>t+1):[]},[e]),f=s.useMemo(()=>{let e=parseInt(r,10),t=parseInt(i,10);return Number.isFinite(e)&&Number.isFinite(t)?{start:Math.min(e,t),end:Math.max(e,t)}:null},[r,i]),g=s.useCallback(r=>{if(!t||!e||!r)return void c(null);let a=e.filter(e=>{let t=u(e["樓層"]);return!!t&&t>=r.start&&t<=r.end});if(0===a.length)return void c({avg:0,count:0});let s=a.reduce((e,t)=>e+(t["房屋總價(萬)"]||0),0),n=a.reduce((e,t)=>e+(t["房屋面積(坪)"]||0),0);c({avg:n>0?s/n:0,count:a.length})},[t,e]);(0,s.useEffect)(()=>{g(f)},[f,g]);let b=(e,t)=>{let r=Math.min(e,t),a=Math.max(e,t);n(String(r)),l(String(a))};return(0,a.jsxs)("div",{className:"flex flex-col gap-3 bg-zinc-900/30 p-4 rounded-lg border border-white/5",children:[(0,a.jsxs)("div",{className:"flex flex-col sm:flex-row items-start sm:items-center gap-2 w-full sm:w-auto",children:[(0,a.jsx)("span",{className:"text-sm text-zinc-400 font-semibold whitespace-nowrap",children:"區間均價試算:"}),(0,a.jsxs)("div",{className:"flex items-center gap-2",children:[(0,a.jsx)(k.p,{type:"number",placeholder:"起樓",className:"w-20 h-8 bg-zinc-950/50",value:r,onChange:e=>n(e.target.value)}),(0,a.jsx)("span",{className:"text-zinc-500",children:"~"}),(0,a.jsx)(k.p,{type:"number",placeholder:"迄樓",className:"w-20 h-8 bg-zinc-950/50",value:i,onChange:e=>l(e.target.value)})]}),(0,a.jsx)(M.$,{size:"sm",variant:"secondary",onClick:()=>g(f),className:"h-8 ml-2",children:"計算"})]}),p.length>0&&(0,a.jsxs)("div",{className:"flex flex-col gap-2",children:[(0,a.jsx)("div",{className:"flex flex-wrap gap-2",children:p.map(e=>{let t=!!f&&e>=f.start&&e<=f.end,r=!!f&&(e===f.start||e===f.end);return(0,a.jsx)("button",{type:"button",onPointerDown:()=>{x(!0),m(e),b(e,e)},onPointerEnter:()=>{d&&null!==h&&b(h,e)},className:`h-9 w-9 rounded-md border text-xs font-semibold transition ${t?r?"border-violet-400 bg-violet-500/25 text-violet-200 shadow-[0_0_12px_rgba(139,92,246,0.35)]":"border-violet-500/40 bg-violet-500/15 text-violet-300":"border-white/10 bg-zinc-950/50 text-zinc-400 hover:border-white/30 hover:text-zinc-200"}`,children:e},`floor-${e}`)})}),(0,a.jsx)("span",{className:"text-[11px] text-zinc-500",children:"可點選或拖曳選取樓層範圍"})]}),o&&(0,a.jsxs)("div",{className:"flex flex-wrap items-center gap-4 animate-in fade-in",children:[(0,a.jsxs)("div",{className:"flex flex-col",children:[(0,a.jsx)("span",{className:"text-xs text-zinc-500",children:"平均單價 (加權)"}),(0,a.jsxs)("span",{className:"text-lg font-bold text-violet-400",children:[o.avg.toFixed(2)," 萬/坪"]})]}),(0,a.jsxs)("div",{className:"flex flex-col",children:[(0,a.jsx)("span",{className:"text-xs text-zinc-500",children:"參考筆數"}),(0,a.jsxs)("span",{className:"text-sm text-zinc-300",children:[o.count," 筆"]})]})]})]})}function _({data:e,visibleSections:t=["grid","stats","comparison"]}){let[r,i]=(0,s.useState)(""),[l,o]=(0,s.useState)(!1),[c,d]=(0,s.useState)(.3),[x,h]=(0,s.useState)(14),[m,u]=(0,s.useState)(!1),[p,b]=(0,s.useState)(!1),j=(0,F.P)(e=>e.excludeCommercial),{counties:v,districts:w,transactionType:y,buildingType:z,dateRange:M,startDate:_,endDate:W}=(0,F.P)(),[B,U]=(0,s.useState)(null),[q,H]=(0,s.useState)(!1),V=s.useRef(null),Z=s.useRef(null),G=s.useRef(null);if((0,s.useEffect)(()=>{!l&&e?.priceGridAnalysis?.projectNames?.length&&!r&&i(e.priceGridAnalysis.projectNames[0])},[e,r,l]),!e?.priceGridAnalysis)return null;let{projectNames:Y,byProject:J}=e.priceGridAnalysis,X=t.includes("grid"),Q=t.includes("stats"),K=t.includes("comparison"),ee=e=>String(e??"").normalize("NFKC").replace(/\s+/g,"").trim().toLowerCase(),et=s.useMemo(()=>{if(!r||!e.transactionDetails)return null;let t=ee(r);return t?e.transactionDetails.filter(e=>ee(e["建案名稱"])===t):null},[r,e.transactionDetails]);(0,s.useEffect)(()=>{let e=!0;return(async()=>{if(!r||et&&et.length>0)return U(null);let t=v.map(e=>I.WG[e]||e).filter(Boolean);if(0===t.length)return;let a=_,s=W;if("custom"!==M&&(!a||!s)){let e=(0,D.P)(M);a=e.startDate||a,s=e.endDate||s}H(!0);try{let n=[];for(let i of t){let t=1,l=1/0;for(;n.length<l;){let o=await R.FH.fetchData({countyCode:i,districts:w,type:y,transactionType:y,projectNames:[r],buildingType:z,dateStart:a,dateEnd:s},{page:t,pageSize:1e3,totalRecords:0});if(!e)return;let c=o?.data||[],d="number"==typeof o?.count?o.count:null;if(n.push(...c),null!==d&&(l=d),c.length<1e3||null!==d&&n.length>=d||(t+=1)>20)break}}e&&U(n)}catch(t){console.warn("Fetch project transactions failed:",t),e&&U([])}finally{e&&H(!1)}})(),()=>{e=!1}},[r,et,v,w,y,z,M,_,W]);let er=et&&et.length>0?et:B,ea=s.useMemo(()=>{if(!er||0===er.length)return{hasOffice:!1,hasResidential:!1,isMixed:!1};let e=er.reduce((e,t)=>{let{isStorefront:r,isOffice:a}=T(t);return a&&(e.hasOffice=!0),a||r||(e.hasResidential=!0),e},{hasOffice:!1,hasResidential:!1});return{...e,isMixed:e.hasOffice&&e.hasResidential}},[er]),es=s.useMemo(()=>!!er&&0!==er.length&&er.some(e=>{let t=e["備註"]||e.note||"";return t.includes("親友")||t.includes("員工")||t.includes("關係人")||t.includes("關係戶")||t.includes("員工關係")}),[er]);(0,s.useEffect)(()=>{r&&u(!ea.isMixed&&ea.hasOffice)},[r,ea.isMixed,ea.hasOffice]),(0,s.useEffect)(()=>{r&&b(!1)},[r]);let en=s.useMemo(()=>{if(!er)return null;let e=er;return j&&(e=e.filter(e=>{let{isStorefront:t,isOffice:r}=T(e);return!t&&!r})),e},[er,j]),ei=!j&&m,el=s.useMemo(()=>{if(!r)return null;if(en&&en.length>0)try{return function(e,t=.3,r=14,a={}){let s=e.reduce((e,t)=>{let{isStorefront:r,isOffice:a}=T(t);return a&&(e.hasOffice=!0),a||r||(e.hasResidential=!0),e},{hasOffice:!1,hasResidential:!1}),n=!(s.hasOffice&&s.hasResidential)&&s.hasOffice,i="boolean"==typeof a.includeOfficePremium?a.includeOfficePremium:n,l="boolean"==typeof a.includeStorefrontPremium&&a.includeStorefrontPremium,o="boolean"==typeof a.includeEmployeePremium&&a.includeEmployeePremium,c=e=>{let{isStorefront:t,isOffice:r,isEmployeeRelated:a}=$(e);return(!!l||!t)&&(!!i||!r)&&(!!o||!a)},d={},x=new Set,h=new Set,m=new g.B$(e);if(e.forEach(e=>{let t=e["樓層"]||e.floor||e.layer;if(null==t)return;"number"==typeof t&&(t=String(t)),"number"==typeof t&&(t=String(t));let r=(0,E.n)(e,m);x.add(t),h.add(r),d[t]||(d[t]={}),d[t][r]||(d[t][r]=[]);let a=parseFloat(e["房屋單價(萬)"]||e.unitPrice||0),s=parseFloat(e["交易總價(萬)"]||e.totalPrice||0),n=parseFloat(e["房屋總價(萬)"]||e.housePrice||0),i=parseFloat(e["車位總價(萬)"]||e.parkingPrice||0),l=parseFloat(e["房屋面積(坪)"]||e.houseArea||0),o=e["房數"]||e.rooms,c=e["車位類別"]||e.parkingType||"";"string"==typeof c&&c.includes("車位");let{note:u,isStorefront:p,isOffice:f,isEmployeeRelated:g}=$(e),b=e["交易日"]||e["交易年月日"]||e.transactionDate||"",j=b;if(b&&/^\d{6,7}$/.test(String(b))){let e=String(b),t=6===e.length?2:3;j=`${e.substring(0,t)}/${e.substring(t,t+2)}/${e.substring(t+2)}`}d[t][r].push({...e,unitPrice:a,floor:t,unit:r,transactionDate:j,remark:u,isStorefront:p,isOffice:f,isEmployeeRelated:g,hasParking:i>0,tooltipInfo:{totalPrice:s,housePrice:n,parkingPrice:i,houseArea:l,rooms:o}})}),0===x.size)return{horizontalGrid:{},sortedFloors:[],sortedUnits:[],unitColorMap:{},summary:{totalBaselineHousePrice:0,totalPricePremiumValue:0,totalSoldArea:0,transactionCount:0,calculationFlags:{includesOfficePremium:i,includesStorefrontPremium:l,includesEmployeePremium:o}},horizontalComparison:[]};let u=Array.from(x).sort((e,t)=>{let r=e=>e?e.startsWith("B")?-parseInt(e.substring(1)):parseInt(e)||0:0;return r(t)-r(e)}),p=e=>{let t=String(e||"").trim().toUpperCase(),r=t.match(/^([A-Z]+)(\d+)?$/);return r?{alpha:r[1]||"",num:r[2]?parseInt(r[2],10):Number.MAX_SAFE_INTEGER,raw:t}:{alpha:t,num:Number.MAX_SAFE_INTEGER,raw:t}},f=Array.from(h).sort((e,t)=>{let r=p(e),a=p(t),s=r.alpha.localeCompare(a.alpha,"en");return 0!==s?s:r.num!==a.num?r.num-a.num:r.raw.localeCompare(a.raw,"en")}),b={},j=e=>{if(!e)return null;let t=e.replace(/\//g,"");if(t.length<6)return null;let r=6===t.length?2:3,a=parseInt(t.substring(0,r)),s=parseInt(t.substring(r,r+2));return new Date(1911+a,s-1,parseInt(t.substring(r+2)))},v={};e.forEach(e=>{let t=(0,E.n)(e,m),{note:r}=$(e),a=parseFloat(e["房屋單價(萬)"]||e.unitPrice||0);!(!c(e)||r.includes("特殊")||r.includes("毛胚"))&&a>0&&(v[t]||(v[t]=[]),v[t].push(e))}),Object.keys(v).forEach(e=>{let a=v[e];if(a.sort((e,t)=>(j(e["交易年月日"]||e.transactionDate)?.getTime()||0x9184e729fff)-(j(t["交易年月日"]||t.transactionDate)?.getTime()||0x9184e729fff)),0===a.length)return;let s=j(a[0]["交易年月日"]||a[0].transactionDate);if(!s){b[e]=a.reduce((e,t)=>parseFloat(t["房屋單價(萬)"])<parseFloat(e["房屋單價(萬)"])?t:e,a[0]);return}let n=new Date(s);n.setDate(n.getDate()+r);let i=a.filter(e=>{let t=j(e["交易年月日"]||e.transactionDate);return t&&t<=n}),l=i[0]||a[0],o=1/0;i.forEach(e=>{let r,a=parseFloat(e["房屋單價(萬)"]||0)-((r=String(e["樓層"]))?r.startsWith("B")?-parseInt(r.substring(1)):parseInt(r):0)*t;a<o&&(o=a,l=e)}),b[e]=l});let w=0,y=0,N=0,z=0;Object.keys(d).forEach(e=>{Object.keys(d[e]).forEach(r=>{d[e][r].forEach((a,s)=>{let n=null,i=b[r];if(i&&c(a)){let l=e=>e?e.startsWith("B")?-parseInt(e.substring(1)):parseInt(e):0,o=String(i["樓層"]),c=String(a.floor),x=l(o),h=l(c),m=parseFloat(i["房屋單價(萬)"]||i.unitPrice||0)+(h-x)*t;if(m>0&&(n=(a["房屋單價(萬)"]-m)/m*100,(a===i||.1>Math.abs(a["房屋單價(萬)"]-m))&&(n=0)),a.tooltipInfo.housePrice&&a.tooltipInfo.houseArea){let e=m*a.tooltipInfo.houseArea;w+=e,y+=a.tooltipInfo.housePrice-e,N+=a.tooltipInfo.houseArea,z++}d[e][r][s].theoreticalPrice=m}else n=null,d[e][r][s].theoreticalPrice=null;d[e][r][s].premium=n})})});let S={},P=["#f87171","#fb923c","#fbbf24","#a3e635","#34d399","#22d3ee","#818cf8","#c084fc","#f472b6"];f.forEach((e,t)=>{S[e]=P[t%P.length]});let k={};f.forEach(e=>{k[e]={totalOriginalPriceValue:0,totalActualPriceValue:0,totalSoldArea:0,count:0,anchorPrice:null,anchorFloor:null};let t=b[e];t&&(k[e].anchorPrice=parseFloat(t["房屋單價(萬)"]||0),k[e].anchorFloor=String(t["樓層"]))}),Object.keys(d).forEach(e=>{Object.keys(d[e]).forEach(r=>{d[e][r].forEach(e=>{let a=b[r];if(c(e)&&e.tooltipInfo.houseArea&&a){let s=e=>e?e.startsWith("B")?-parseInt(e.substring(1)):parseInt(e):0,n=s(String(a["樓層"])),i=s(e.floor),l=parseFloat(e["房屋單價(萬)"]||e.unitPrice||0),o=l-(i-n)*t,c=e.tooltipInfo.houseArea;Number.isFinite(o)&&Number.isFinite(l)&&c>0&&k[r]&&(k[r].totalOriginalPriceValue+=o*c,k[r].totalActualPriceValue+=l*c,k[r].totalSoldArea+=c,k[r].count++)}})})});let M=[],A=[],C=null,F=null,R=1/0,I=1/0;Object.keys(k).forEach(e=>{let t=k[e];if(t.totalSoldArea>0){let r=t.totalOriginalPriceValue/t.totalSoldArea,a=t.totalActualPriceValue/t.totalSoldArea;M.push(r),A.push(a),r<R&&(R=r,C=e),a<I&&(I=a,F=e)}});let D=M.length?Math.min(...M):0,L=A.length?Math.min(...A):0,O=Object.keys(k).map(e=>{let t=k[e];if(0===t.count||0===t.totalSoldArea)return null;let r=t.totalOriginalPriceValue/t.totalSoldArea,a=t.totalActualPriceValue/t.totalSoldArea,s=a-r,n=s*t.totalSoldArea;return{unitType:e,anchorInfo:t.anchorPrice?`${t.anchorFloor}F / ${t.anchorPrice}萬`:"N/A",originalHorizontalDiff:r-D,actualHorizontalDiff:a-L,unitsSold:t.count,totalSoldArea:t.totalSoldArea,originalAvgPrice:r,actualAvgPrice:a,avgPremiumPerPing:s,timePremiumContribution:n}}).filter(Boolean),_=O.reduce((e,t)=>e+(t.timePremiumContribution||0),0);return O.forEach(e=>{e.contributionPercentage=_>0?e.timePremiumContribution/_*100:0}),{horizontalGrid:d,sortedFloors:u,sortedUnits:f,unitColorMap:S,summary:{totalBaselineHousePrice:w,totalPricePremiumValue:y,totalSoldArea:N,transactionCount:z,calculationFlags:{includesOfficePremium:i,includesStorefrontPremium:l,includesEmployeePremium:o}},horizontalComparison:O,comparisonMeta:{originalMinUnit:C,originalMinAvg:Number.isFinite(R)?R:null,actualMinUnit:F,actualMinAvg:Number.isFinite(I)?I:null}}}(en,c,x,{includeOfficePremium:ei,includeEmployeePremium:p})}catch(e){console.error("Heatmap generation error:",e)}return J[r]&&J[r].horizontalGrid?J[r]:null},[r,en,J,c,x,ei,p]),eo=s.useMemo(()=>{let e=el?.summary?.calculationFlags;if(!e)return"排除店舖/辦公室";let t=[];return e.includesStorefrontPremium||t.push("店舖"),e.includesOfficePremium||t.push("辦公室"),e.includesEmployeePremium||t.push("員工關係戶"),t.length?`排除${t.join("/")}`:"全部納入"},[el?.summary?.calculationFlags]);return(0,a.jsxs)("div",{className:"space-y-6 animate-in fade-in slide-in-from-bottom-4 duration-500",children:[(0,a.jsx)("div",{className:"flex flex-col gap-4 bg-zinc-900/30 p-4 rounded-lg border border-white/5","data-report-control":"hide",children:(0,a.jsx)("div",{className:"flex flex-col lg:flex-row flex-wrap items-start lg:items-center gap-4",children:(0,a.jsxs)("div",{className:"flex flex-col sm:flex-row items-start sm:items-center gap-2 w-full lg:w-auto",children:[(0,a.jsxs)("div",{className:"flex items-center gap-2",children:[(0,a.jsx)("span",{className:"text-sm text-zinc-400 whitespace-nowrap",children:"選擇建案:"}),(0,a.jsx)("button",{onClick:()=>o(!l),className:`p-1 rounded transition-colors ${l?"text-violet-400 bg-violet-400/10":"text-zinc-500 hover:text-zinc-300"}`,title:l?"切換回下拉選單":"切換手動輸入",children:(0,a.jsx)(A.A,{className:"w-3.5 h-3.5"})})]}),l?(0,a.jsxs)("div",{className:"relative w-full sm:w-[280px]",children:[(0,a.jsx)(k.p,{value:r,onChange:e=>i(e.target.value),placeholder:"輸入建案名稱...",className:"w-full h-9 bg-zinc-950/50 pl-8 pr-4",list:"project-list",autoComplete:"off"}),(0,a.jsx)(C.A,{className:"absolute left-2.5 top-1/2 -translate-y-1/2 w-4 h-4 text-zinc-500"}),(0,a.jsx)("datalist",{id:"project-list",children:Y.map(e=>(0,a.jsx)("option",{value:e},e))})]}):(0,a.jsxs)(P.l,{value:r,onChange:e=>i(e.target.value),className:"w-full sm:w-[280px] bg-zinc-950/50",children:[(0,a.jsx)("option",{value:"",disabled:!0,children:"請選擇建案..."}),Y.map(e=>(0,a.jsx)("option",{value:e,children:e},e))]})]})})}),r&&en&&en.length>0&&(0,a.jsx)("div",{"data-report-control":"hide",children:(0,a.jsx)(S,{componentName:"FloorDiffAnalyzer",children:(0,a.jsx)(N,{transactions:en,currentPremium:c,onApply:e=>d(e),onManualChange:e=>d(e)})})}),r&&en&&en.length>0&&(0,a.jsx)("div",{"data-report-control":"hide",children:(0,a.jsx)(O,{transactions:en,project:r})}),(0,a.jsxs)("div",{className:"flex flex-wrap gap-4 p-4 bg-zinc-900/20 rounded-lg border border-white/5",children:[(0,a.jsxs)("div",{className:"flex items-center gap-2",children:[(0,a.jsx)("span",{className:"text-xs text-zinc-500",children:"溢價圖例:"}),(0,a.jsxs)("span",{className:"flex items-center gap-1",children:[(0,a.jsx)("span",{className:"w-4 h-4 rounded bg-red-500/80"}),(0,a.jsx)("span",{className:"text-xs text-zinc-400",children:"> 5%"})]}),(0,a.jsxs)("span",{className:"flex items-center gap-1",children:[(0,a.jsx)("span",{className:"w-4 h-4 rounded bg-orange-500/80"}),(0,a.jsx)("span",{className:"text-xs text-zinc-400",children:"2-5%"})]}),(0,a.jsxs)("span",{className:"flex items-center gap-1",children:[(0,a.jsx)("span",{className:"w-4 h-4 rounded bg-yellow-500/80"}),(0,a.jsx)("span",{className:"text-xs text-zinc-400",children:"0-2%"})]}),(0,a.jsxs)("span",{className:"flex items-center gap-1",children:[(0,a.jsx)("span",{className:"w-4 h-4 rounded bg-green-500/80"}),(0,a.jsx)("span",{className:"text-xs text-zinc-400",children:"< 0%"})]})]}),(0,a.jsx)("div",{className:"ml-auto"})]}),X&&(0,a.jsx)(n.c,{title:"建案銷控表與調價熱力圖",description:"可視化建案各戶別的銷售狀況與價格調整幅度",containerRef:V,headerAction:(0,a.jsxs)("div",{className:"flex flex-wrap items-center gap-2",children:[!j&&ea.hasOffice&&(0,a.jsxs)("div",{className:"flex items-center gap-2",children:[(0,a.jsx)("span",{className:"text-xs text-zinc-400 whitespace-nowrap",children:"事務所/商辦調價"}),(0,a.jsx)("button",{onClick:()=>u(e=>!e),className:`px-2 h-8 rounded border text-[11px] transition ${m?"border-cyan-400 text-cyan-300 bg-cyan-500/10":"border-white/10 text-zinc-400 hover:text-zinc-200 hover:border-white/30"}`,title:m?"已納入事務所/商辦調價":"排除事務所/商辦調價",children:m?"納入":"排除"}),ea.isMixed&&(0,a.jsx)("span",{className:"text-[11px] text-zinc-500 whitespace-nowrap",children:"混合用途預設排除"})]}),es&&(0,a.jsxs)("div",{className:"flex items-center gap-2",children:[(0,a.jsx)("span",{className:"text-xs text-zinc-400 whitespace-nowrap",children:"員工關係戶調價"}),(0,a.jsx)("button",{onClick:()=>b(e=>!e),className:`px-2 h-8 rounded border text-[11px] transition ${p?"border-cyan-400 text-cyan-300 bg-cyan-500/10":"border-white/10 text-zinc-400 hover:text-zinc-200 hover:border-white/30"}`,title:p?"已納入員工關係戶調價":"排除員工關係戶調價",children:p?"納入":"排除"})]}),(0,a.jsxs)("div",{className:"flex items-center gap-2 bg-zinc-950/40 border border-white/10 rounded-lg px-2 py-1","data-report-control":"hide",children:[(0,a.jsx)("span",{className:"text-xs text-zinc-400",children:"基準天數"}),(0,a.jsx)(k.p,{type:"number",min:"1",max:"365",value:x,onChange:e=>h(Number(e.target.value)||14),className:"w-16 h-8 bg-zinc-950/50 text-right pr-2"}),(0,a.jsx)("span",{className:"text-xs font-mono text-violet-400 whitespace-nowrap",children:"天"})]}),(0,a.jsx)(L.N,{data:en||[],filename:`heatmap_grid_${r}`,label:"匯出",chartType:"heatmap-grid",targetRef:V,snapshotData:{projectData:el,floorPremium:c,selectedProject:r}})]}),children:el?(0,a.jsx)(S,{componentName:"PricingHeatmap (Grid)",children:(0,a.jsx)(f,{data:el,floorPremium:c,showGrid:!0,showSummary:!1,showComparison:!1})}):(0,a.jsx)("div",{className:"text-zinc-500 text-center p-12",children:"請選擇建案以查看銷控表"})}),Q&&el?.summary&&(0,a.jsx)(n.c,{title:`調價幅度統計摘要 (${eo})`,containerRef:Z,headerAction:(0,a.jsx)(L.N,{data:[el.summary],filename:`heatmap_stats_${r}`,label:"匯出",chartType:"heatmap-stats",targetRef:Z,snapshotData:{summary:el.summary,selectedProject:r}}),children:(0,a.jsx)(S,{componentName:"PricingHeatmap (Summary)",children:(0,a.jsx)(f,{data:el,showGrid:!1,showSummary:!0,showComparison:!1})})}),K&&el?.horizontalComparison&&el.horizontalComparison.length>0&&(0,a.jsx)(n.c,{title:"戶型水平價差與溢價貢獻",containerRef:G,headerAction:(0,a.jsx)(L.N,{data:el.horizontalComparison,filename:`heatmap_comparison_${r}`,label:"匯出",chartType:"heatmap-comparison",targetRef:G,snapshotData:{horizontalComparison:el.horizontalComparison,selectedProject:r}}),children:(0,a.jsx)(S,{componentName:"PricingHeatmap (Comparison)",children:(0,a.jsx)(f,{data:el,showGrid:!1,showSummary:!1,showComparison:!0,configProject:r,rawTransactions:en||void 0})})})]})}},81477:(e,t,r)=>{r.d(t,{BT:()=>c,Wu:()=>d,ZB:()=>o,Zp:()=>i,aR:()=>l});var a=r(95155),s=r(12115),n=r(40980);let i=s.forwardRef(({className:e,...t},r)=>(0,a.jsx)("div",{ref:r,className:(0,n.cn)("glass-panel rounded-xl text-card-foreground",e),...t}));i.displayName="Card";let l=s.forwardRef(({className:e,...t},r)=>(0,a.jsx)("div",{ref:r,className:(0,n.cn)("flex flex-col space-y-1.5 p-6",e),...t}));l.displayName="CardHeader";let o=s.forwardRef(({className:e,...t},r)=>(0,a.jsx)("h3",{ref:r,className:(0,n.cn)("text-lg font-semibold leading-none tracking-tight text-white",e),...t}));o.displayName="CardTitle";let c=s.forwardRef(({className:e,...t},r)=>(0,a.jsx)("p",{ref:r,className:(0,n.cn)("text-sm text-zinc-400",e),...t}));c.displayName="CardDescription";let d=s.forwardRef(({className:e,...t},r)=>(0,a.jsx)("div",{ref:r,className:(0,n.cn)("p-6 pt-0",e),...t}));d.displayName="CardContent",s.forwardRef(({className:e,...t},r)=>(0,a.jsx)("div",{ref:r,className:(0,n.cn)("flex items-center p-6 pt-0",e),...t})).displayName="CardFooter"},85623:(e,t,r)=>{r.d(t,{Q:()=>j});var a=r(95155),s=r(12115),n=r(68605),i=r(97085),l=r(37717);function o({data:e,selectedRooms:t,metric:r,chartId:n}){let o=(0,l.A)(),c=(0,s.useMemo)(()=>({count:{label:"交易筆數",unit:"筆",decimals:0},priceSum:{label:"產權總價",unit:"萬",decimals:0},areaSum:{label:"房屋坪數",unit:"坪",decimals:2}})[r],[r]),d=(0,s.useMemo)(()=>{if(!e||0===t.length)return[];let a=Object.keys(e).sort();return 0===a.length?[]:t.map(t=>({name:t,data:a.map(a=>e[a]?.[t]?.[r]||0)}))},[e,t,r]),x=(0,s.useMemo)(()=>{let t=e?Object.keys(e).sort():[];return{chart:{type:"line",height:350,background:"transparent",toolbar:{show:!1},zoom:{enabled:!1},foreColor:o.text,id:n},colors:o.chartPalette,stroke:{curve:"smooth",width:2},dataLabels:{enabled:!1},xaxis:{categories:t,labels:{style:{colors:o.textMuted}}},yaxis:{title:{text:c.label,style:{color:o.textMuted}},labels:{style:{colors:o.textMuted},formatter:e=>e.toLocaleString("zh-TW",{minimumFractionDigits:0,maximumFractionDigits:0})}},legend:{position:"top",horizontalAlign:"right"},tooltip:{theme:"dark",y:{formatter:e=>`${e.toLocaleString("zh-TW",{minimumFractionDigits:c.decimals,maximumFractionDigits:c.decimals})} ${c.unit}`}},grid:{borderColor:o.grid}}},[e,c,n,o]);return e&&0!==Object.keys(e).length&&0!==t.length?(0,a.jsx)(i.A,{type:"line",series:d,options:x,height:350,className:"w-full"}):(0,a.jsx)("div",{className:"text-zinc-500 text-center p-8",children:"請選擇房型以顯示銷售趨勢"})}function c({data:e,selectedRooms:t,minArea:r,maxArea:n,interval:o,onDataPointClick:c,height:d,chartId:x}){let h=(0,l.A)(),m=(0,s.useMemo)(()=>[{from:0,to:0,color:h.surface||"#27272a",name:"0 戶"},{from:1,to:5,color:"#facc15",name:"1-5 戶"},{from:6,to:20,color:"#fbbf24",name:"6-20 戶"},{from:21,to:50,color:"#f97316",name:"21-50 戶"},{from:51,to:1e4,color:"#dc2626",name:"> 50 戶"}],[h]),{series:u,maxValue:p}=(0,s.useMemo)(()=>{if(!e||0===t.length)return{series:[],maxValue:0};let a=[];for(let e=r;e<n;e+=o){let t=Number.isInteger(o)&&Number.isInteger(r),s=t?e.toFixed(0):e.toFixed(1),n=t?(e+o).toFixed(0):(e+o).toFixed(1);a.push(`${s}-${n}`)}let s=0;return{series:a.map(a=>{let[i,l]=a.split("-").map(parseFloat);return{name:a,data:t.map(t=>{let a=(e[t]||[]).filter(e=>e>=i&&e<l&&e>=r&&e<=n).length;return a>s&&(s=a),a})}}),maxValue:s}},[e,t,r,n,o]),f=(0,s.useMemo)(()=>({chart:{type:"heatmap",height:d||Math.max(400,22*u.length),background:"transparent",toolbar:{show:!1},foreColor:h.text,id:x,events:{dataPointSelection:(e,r,a)=>{if(c){let{seriesIndex:e,dataPointIndex:r}=a,s=a.w.globals.seriesNames[e];c(t[r],s)}}}},plotOptions:{heatmap:{radius:0,useFillColorAsStroke:!0,enableShades:!1,colorScale:{ranges:m}}},dataLabels:{enabled:!0,style:{colors:[({value:e})=>0===e?"transparent":h.text]},formatter:function(e){return 0===e?"":e}},xaxis:{type:"category",categories:t},title:{text:"房型面積分佈熱力圖",align:"center",style:{color:h.text,fontSize:"16px"}},grid:{borderColor:h.grid},tooltip:{theme:"dark",y:{formatter:e=>0===e?"無成交紀錄":`${e} 戶`}}}),[u,t,m,c,h,x,d]);return e&&0!==u.length?(0,a.jsx)(i.A,{type:"heatmap",series:u,options:f,height:f.chart?.height||400,className:"w-full h-full"}):(0,a.jsx)("div",{className:"text-zinc-500 text-center p-8",children:"無面積分佈資料"})}var d=r(40980);function x({data:e,viewType:t,selectedRooms:r}){if(!e||0===Object.keys(e).length)return(0,a.jsx)("div",{className:"text-zinc-500 text-center p-8",children:"無銷售速度資料"});let n=Object.keys(e).sort().reverse();return(0,a.jsx)("div",{className:"overflow-x-auto max-h-[600px] border border-white/5 rounded-lg",children:(0,a.jsxs)("table",{className:"w-full text-sm text-left border-collapse",children:[(0,a.jsxs)("thead",{className:"bg-zinc-900 sticky top-0 z-20 shadow-md",children:[(0,a.jsxs)("tr",{children:[(0,a.jsx)("th",{rowSpan:2,className:"px-4 py-3 sticky left-0 z-30 bg-zinc-900 border-r border-white/10 font-medium text-white min-w-[120px]",children:"時間"}),r.map(e=>(0,a.jsx)("th",{colSpan:3,className:"px-2 py-2 text-center border-l border-white/5 text-zinc-300 font-medium bg-zinc-900/90",children:e},e)),(0,a.jsx)("th",{colSpan:3,className:"px-2 py-2 text-center border-l-2 border-white/10 text-cyan-400 font-bold bg-zinc-900/90",children:"總計"})]}),(0,a.jsxs)("tr",{children:[r.map((e,t)=>(0,a.jsxs)(s.Fragment,{children:[(0,a.jsx)("th",{className:(0,d.cn)("px-2 py-2 text-center text-xs text-zinc-500 font-normal bg-zinc-900/90 border-b border-white/10",0===t&&"border-l border-white/5"),children:"筆數"}),(0,a.jsx)("th",{className:"px-2 py-2 text-center text-xs text-zinc-500 font-normal bg-zinc-900/90 border-b border-white/10",children:"總價(萬)"}),(0,a.jsx)("th",{className:"px-2 py-2 text-center text-xs text-zinc-500 font-normal bg-zinc-900/90 border-b border-white/10",children:"坪數"})]},e)),(0,a.jsx)("th",{className:"px-2 py-2 text-center text-xs text-zinc-400 font-medium bg-zinc-900/90 border-b border-white/10 border-l-2 border-white/10",children:"筆數"}),(0,a.jsx)("th",{className:"px-2 py-2 text-center text-xs text-zinc-400 font-medium bg-zinc-900/90 border-b border-white/10",children:"總價(萬)"}),(0,a.jsx)("th",{className:"px-2 py-2 text-center text-xs text-zinc-400 font-medium bg-zinc-900/90 border-b border-white/10",children:"坪數"})]})]}),(0,a.jsx)("tbody",{className:"divide-y divide-white/5",children:n.map(n=>{let i=e[n]||{},l={count:0,priceSum:0,areaSum:0};return(0,a.jsxs)("tr",{className:"hover:bg-zinc-800/30 transition-colors",children:[(0,a.jsx)("td",{className:"px-4 py-2 sticky left-0 z-10 bg-zinc-950/90 border-r border-white/10 font-mono text-xs text-zinc-400",children:(e=>{if("weekly"===t){let t=e.match(/^(\d{4})-W(\d{1,2})$/);if(t){let r=((e,t)=>{if(!Number.isFinite(e)||!Number.isFinite(t))return"";let r=new Date(Date.UTC(e,0,4)),a=r.getUTCDay()||7,s=new Date(r);s.setUTCDate(r.getUTCDate()-(a-1));let n=new Date(s);n.setUTCDate(s.getUTCDate()+(t-1)*7);let i=new Date(n);i.setUTCDate(n.getUTCDate()+6);let l=`${n.getUTCMonth()+1}/${n.getUTCDate()}`,o=`${i.getUTCMonth()+1}/${i.getUTCDate()}`;return`${l}-${o}`})(parseInt(t[1],10),parseInt(t[2],10));return(0,a.jsxs)("div",{className:"flex flex-col leading-tight text-xs",children:[(0,a.jsx)("span",{children:e}),r&&(0,a.jsx)("span",{className:"text-[9px] text-zinc-500 whitespace-nowrap",children:r})]})}}return e})(n)}),r.map((e,t)=>{let r=i[e];return r?(l.count+=r.count,l.priceSum+=r.priceSum,l.areaSum+=r.areaSum,(0,a.jsxs)(s.Fragment,{children:[(0,a.jsx)("td",{className:(0,d.cn)("px-2 py-2 text-center text-zinc-300",0===t&&"border-l border-white/5"),children:r.count>0?r.count.toLocaleString():"-"}),(0,a.jsx)("td",{className:"px-2 py-2 text-center text-zinc-500 font-mono text-xs",children:r.count>0?(0,d.Z)(r.priceSum,0):"-"}),(0,a.jsx)("td",{className:"px-2 py-2 text-center text-zinc-500 font-mono text-xs",children:r.count>0?(0,d.Z)(r.areaSum,1):"-"})]},e)):(0,a.jsxs)(s.Fragment,{children:[(0,a.jsx)("td",{className:(0,d.cn)("px-2 py-2 text-center text-zinc-700",0===t&&"border-l border-white/5"),children:"-"}),(0,a.jsx)("td",{className:"px-2 py-2 text-center text-zinc-700",children:"-"}),(0,a.jsx)("td",{className:"px-2 py-2 text-center text-zinc-700",children:"-"})]},e)}),(0,a.jsx)("td",{className:"px-2 py-2 text-center font-bold text-cyan-400 border-l-2 border-white/10",children:l.count.toLocaleString()}),(0,a.jsx)("td",{className:"px-2 py-2 text-center font-bold text-zinc-300 font-mono text-xs",children:(0,d.Z)(l.priceSum,0)}),(0,a.jsx)("td",{className:"px-2 py-2 text-center font-bold text-zinc-300 font-mono text-xs",children:(0,d.Z)(l.areaSum,1)})]},n)})})]})})}var h=r(29991),m=r(60529),u=r(89733),p=r(88743),f=r(48551),g=r(39430),b=r(80642);function j({data:e,visibleSections:t=["chart","table","heatmap"],uiSize:r="dashboard"}){let[i,l]=(0,s.useState)("monthly"),[j,v]=(0,s.useState)("count"),w=(0,d.cn)("bg-zinc-950/50","builder"===r?"text-xl h-12":"text-sm h-9"),[y,N]=(0,s.useState)(15),[z,S]=(0,s.useState)(65),[P,k]=(0,s.useState)(5),[M,A]=(0,s.useState)([]),[C,E]=(0,s.useState)(null),{selectedRoomTypes:T,setSelectedRoomTypes:$}=(0,p.P)();if(!e)return null;let{salesVelocityAnalysis:F,areaDistributionAnalysis:R}=e,I=e=>Math.round(e)+"萬",D=s.useRef(null),L=s.useRef(null),O=s.useRef(null),_=s.useRef(null),W=s.useRef(`sales-velocity-${Math.random().toString(36).slice(2,8)}`).current,B=s.useRef(`area-heatmap-${Math.random().toString(36).slice(2,8)}`).current,U=(t,r)=>{D.current&&(D.current.style.width=`${D.current.offsetWidth}px`);let a=0,s=1/0;if(r.includes("<"))s=parseFloat(r.replace("<","").trim());else if(r.includes(">"))a=parseFloat(r.replace(">","").trim());else if(r.includes("-")){let e=r.split("-");a=parseFloat(e[0].trim()),s=parseFloat(e[1].trim())}let n=(e.transactionDetails||[]).filter(e=>{let r=function(e){let t=e=>e?String(e).normalize("NFKC").toUpperCase().replace(/\s+/g,""):"",r=t(e["建物型態"]||e.buildingType),a=t(e["主要用途"]||e.mainPurpose),s=t(e["戶別"]||e.unit),n=void 0!==e["房數"]?e["房數"]:e.rooms,i=void 0!==e["房屋面積(坪)"]?parseFloat(e["房屋面積(坪)"]):parseFloat(e.houseArea||0);if(r.includes("住宅大樓")&&s.includes("S")||s.includes("店舖")||s.includes("店面")||s.includes("店鋪"))return"店舖";if(s.includes("事務所")||s.includes("辦公"))return"辦公/事務所";if(r.includes("店舖")||r.includes("店面")||r.includes("店鋪"))return"店舖";if(r.includes("工廠")||r.includes("倉庫")||r.includes("廠辦"))return"廠辦/工廠";if(a.includes("商業")||r.includes("辦公")||r.includes("事務所"))return"辦公/事務所";if((r.includes("住宅大樓")||r.includes("華廈"))&&0===n){if(i>35)return"毛胚";if(i<=35)return"套房"}if("number"==typeof n&&!isNaN(n)){if(1===n)return"1房";if(2===n)return"2房";if(3===n)return"3房";if(4===n)return"4房";if(n>=5)return"5房以上"}return"其他"}(e),n=parseFloat(e["房屋面積(坪)"]||e.houseArea||(e["建物移轉平方公尺"]?.3025*e["建物移移轉平方公尺"]:0));if(!r)return!1;let i=n>=a&&n<s;return r===t&&i});console.log(`[Heatmap Click] Room: ${t}, Range: ${a}-${s}, Found: ${n.length}`);let i={};n.forEach(e=>{let t=e["建案名稱"]||e.projectName||"未知建案";i[t]||(i[t]=[]),i[t].push(e)});let l=Object.entries(i).map(([e,t])=>{let r=t.map(e=>e["產權總價"]||e["交易總價(萬)"]||e.totalPrice||0).filter(e=>e>0).sort((e,t)=>e-t),a=t.map(e=>e["房屋單價"]||e["房屋單價(萬)"]||e.unitPrice||0).filter(e=>e>0),s=0;if(r.length>0){let e=Math.floor(r.length/2);s=r.length%2!=0?r[e]:(r[e-1]+r[e])/2}return{projectName:e,count:t.length,priceRange:{min:r.length>0?r[0]:0,max:r.length>0?r[r.length-1]:0,median:s},unitPriceRange:{min:a.length>0?Math.min(...a):0,max:a.length>0?Math.max(...a):0},transactions:t.sort((e,t)=>{let r=e["房屋單價"]||e["房屋單價(萬)"]||e.unitPrice||0;return(t["房屋單價"]||t["房屋單價(萬)"]||t.unitPrice||0)-r}),isExpanded:!1}});l.sort((e,t)=>t.unitPriceRange.max-e.unitPriceRange.max),A(l),E({roomType:t,areaRange:r,totalCount:n.length})},q=()=>{D.current&&(D.current.style.width=`${D.current.offsetWidth}px`),E(null)},H=t.includes("chart"),V=t.includes("table"),Z=t.includes("heatmap"),G=t.includes("heatmap-detail")&&!Z&&!H&&!V;s.useEffect(()=>{let t,r,a;if(!G||C||!e?.transactionDetails?.length)return;let s=T[0]||p.M[0];s&&U(s,(r=(t=Number.isInteger(P)&&Number.isInteger(y))?y.toFixed(0):y.toFixed(1),a=t?(y+P).toFixed(0):(y+P).toFixed(1),`${r}-${a}`))},[G,C,e?.transactionDetails,T,y,P]);let Y=()=>C?(0,a.jsxs)("div",{className:"flex-1 min-w-0 bg-zinc-900/50 border border-white/10 rounded-lg h-full flex flex-col p-4 overflow-hidden",children:[(0,a.jsxs)("div",{className:"flex justify-between items-start mb-4 pb-4 border-b border-white/5",children:[(0,a.jsxs)("div",{children:[(0,a.jsxs)("h4",{className:"text-white font-medium flex items-center gap-2 text-lg",children:[(0,a.jsx)("span",{className:"text-cyan-400",children:C.roomType}),(0,a.jsx)("span",{className:"text-zinc-500",children:"|"}),(0,a.jsxs)("span",{children:[C.areaRange," 坪"]})]}),(0,a.jsxs)("p",{className:"text-zinc-400 text-xs mt-1",children:["共找到 ",(0,a.jsx)("span",{className:"text-white font-mono",children:M.length})," 個建案",(0,a.jsx)("br",{}),"合計 ",(0,a.jsx)("span",{className:"text-white font-mono",children:C.totalCount})," 筆交易"]})]}),(0,a.jsxs)("div",{className:"flex gap-2 items-center",children:[(0,a.jsxs)("div",{className:"flex gap-1 mr-2",children:[(0,a.jsx)(u.N,{data:M,filename:`heatmap_aggregated_${C.roomType}_${C.areaRange}`,label:"統計",chartType:"sales-heatmap-detail",snapshotData:M,className:"whitespace-nowrap px-3 py-1 text-xs h-7 min-w-0"}),(0,a.jsx)(u.N,{data:M.flatMap(e=>e.transactions),filename:`heatmap_details_${C.roomType}_${C.areaRange}`,label:"明細",className:"whitespace-nowrap px-3 py-1 text-xs h-7 min-w-0"})]}),!G&&(0,a.jsxs)(a.Fragment,{children:[(0,a.jsx)("div",{className:"w-px h-4 bg-white/10 mx-1"}),(0,a.jsx)("button",{onClick:q,className:"text-zinc-400 hover:text-white p-1 hover:bg-zinc-800 rounded transition-colors",children:(0,a.jsxs)("svg",{xmlns:"http://www.w3.org/2000/svg",width:"20",height:"20",viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:"2",strokeLinecap:"round",strokeLinejoin:"round",children:[(0,a.jsx)("path",{d:"M18 6 6 18"}),(0,a.jsx)("path",{d:"m6 6 12 12"})]})})]})]})]}),M.length>0?(0,a.jsx)("div",{className:"flex-1 overflow-y-auto custom-scrollbar pr-1 -mr-1",children:(0,a.jsx)("div",{className:"space-y-3",children:M.map((e,t)=>(0,a.jsxs)("div",{className:"bg-zinc-950/30 rounded border border-white/5 overflow-hidden",children:[(0,a.jsxs)("div",{className:(0,d.cn)("p-3 cursor-pointer transition-colors flex justify-between items-center",e.isExpanded?"bg-zinc-800/80":"hover:bg-zinc-800/40"),onClick:()=>{A(e=>e.map((e,r)=>r===t?{...e,isExpanded:!e.isExpanded}:e))},children:[(0,a.jsxs)("div",{className:"flex items-center gap-2",children:[(0,a.jsx)("div",{className:(0,d.cn)("w-4 h-4 rounded-full bg-zinc-800 flex items-center justify-center text-[10px] text-zinc-400 transition-transform duration-200",e.isExpanded?"rotate-90 bg-violet-500/20 text-violet-300":""),children:"▶"}),(0,a.jsx)("span",{className:"font-medium text-sm text-zinc-200",children:e.projectName}),(0,a.jsxs)("span",{className:"px-1.5 py-0.5 rounded text-[10px] bg-zinc-800 text-zinc-400 border border-white/5",children:[e.count,"戶"]})]}),(0,a.jsx)("div",{className:"text-right",children:(0,a.jsxs)("div",{className:"text-xs font-mono text-cyan-400",children:[e.unitPriceRange.min===e.unitPriceRange.max?e.unitPriceRange.min.toFixed(1):`${e.unitPriceRange.min.toFixed(1)}~${e.unitPriceRange.max.toFixed(1)}`," ",(0,a.jsx)("span",{className:"text-zinc-500 text-[10px]",children:"萬/坪"})]})})]}),e.isExpanded&&(0,a.jsxs)("div",{className:"p-3 bg-black/20 border-t border-white/5",children:[(0,a.jsxs)("div",{className:"grid grid-cols-2 gap-x-4 gap-y-2 text-xs mb-3 text-zinc-400",children:[(0,a.jsxs)("div",{className:"flex justify-between border-b border-white/5 pb-1",children:[(0,a.jsx)("span",{children:"總價範圍"}),(0,a.jsx)("span",{className:"font-mono text-zinc-300",children:e.priceRange.min===e.priceRange.max?I(e.priceRange.min):`${I(e.priceRange.min)}~${I(e.priceRange.max)}`})]}),(0,a.jsxs)("div",{className:"flex justify-between border-b border-white/5 pb-1",children:[(0,a.jsx)("span",{children:"總價中位數"}),(0,a.jsx)("span",{className:"font-mono text-violet-300",children:I(e.priceRange.median||0)})]})]}),(0,a.jsxs)("div",{className:"space-y-1",children:[(0,a.jsxs)("div",{className:"grid grid-cols-5 text-[10px] text-zinc-500 pb-1 border-b border-white/5",children:[(0,a.jsx)("div",{className:"col-span-1",children:"樓層"}),(0,a.jsx)("div",{className:"col-span-1",children:"坪數"}),(0,a.jsx)("div",{className:"col-span-1 text-right",children:"單價"}),(0,a.jsx)("div",{className:"col-span-2 text-right",children:"總價"})]}),e.transactions.slice(0,e.showAll?void 0:10).map((e,t)=>(0,a.jsxs)("div",{className:"grid grid-cols-5 text-xs py-1 hover:bg-white/5 rounded px-1 -mx-1 transition-colors",children:[(0,a.jsx)("div",{className:"col-span-1 text-zinc-300",children:e["樓層"]||e.floor||"-"}),(0,a.jsx)("div",{className:"col-span-1 text-zinc-400",children:(e["房屋面積(坪)"]||e.houseArea||0).toFixed(1)}),(0,a.jsx)("div",{className:"col-span-1 text-right text-cyan-400",children:(e["房屋單價(萬)"]||e.unitPrice||0).toFixed(0)}),(0,a.jsx)("div",{className:"col-span-2 text-right text-zinc-300 font-mono",children:I(e["交易總價(萬)"]||e.totalPrice||0)})]},t)),e.transactions.length>10&&(0,a.jsx)("button",{onClick:e=>{e.stopPropagation(),A(e=>e.map((e,r)=>r===t?{...e,showAll:!e.showAll}:e))},className:"w-full text-center text-[10px] text-zinc-500 hover:text-cyan-400 py-1.5 mt-1 border-t border-white/5 transition-colors",children:e.showAll?"收合內容":`還有 ${e.transactions.length-10} 筆交易...`})]})]})]},t))})}):(0,a.jsx)("div",{className:"flex-1 flex flex-col items-center justify-center text-zinc-500 border border-dashed border-zinc-800 rounded bg-zinc-900/30",children:(0,a.jsx)("p",{children:"無詳細資料"})})]}):(0,a.jsx)("div",{className:"flex items-center justify-center text-zinc-500 border border-dashed border-zinc-800 rounded bg-zinc-900/30 p-6",children:"無詳細資料"});return G?(0,a.jsx)("div",{className:"space-y-4 animate-in fade-in slide-in-from-bottom-4 duration-500",children:(0,a.jsx)(Y,{})}):(0,a.jsxs)("div",{className:"space-y-6 animate-in fade-in slide-in-from-bottom-4 duration-500",children:[(0,a.jsxs)("div",{id:"room-type-filter-anchor","data-report-control":"hide",className:"p-4 bg-zinc-900/30 border border-white/5 rounded-lg flex flex-wrap gap-2 items-center scroll-mt-24",children:[(0,a.jsx)("span",{className:"text-zinc-400 text-sm mr-2",children:"分析房型:"}),p.M.map(e=>(0,a.jsx)("button",{onClick:()=>{$(T.includes(e)?T.filter(t=>t!==e):[...T,e])},className:(0,d.cn)("px-3 py-1 text-xs rounded-full border transition-colors",T.includes(e)?"bg-violet-500/20 border-violet-500 text-violet-200":"bg-zinc-800 border-zinc-700 text-zinc-500 hover:bg-zinc-700"),children:e},e))]}),H&&(0,a.jsx)(n.c,{title:"房型銷售速度與趨勢分析",containerRef:L,headerAction:(0,a.jsxs)("div",{className:"flex gap-2",children:[(0,a.jsx)("div",{"data-report-control":"hide",children:(0,a.jsxs)(h.l,{value:i,onChange:e=>l(e.target.value),className:w,children:[(0,a.jsx)("option",{value:"weekly",children:"每週"}),(0,a.jsx)("option",{value:"monthly",children:"每月"}),(0,a.jsx)("option",{value:"quarterly",children:"每季"})]})}),(0,a.jsx)("div",{"data-report-control":"hide",children:(0,a.jsxs)(h.l,{value:j,onChange:e=>v(e.target.value),className:w,children:[(0,a.jsx)("option",{value:"count",children:"交易筆數"}),(0,a.jsx)("option",{value:"priceSum",children:"總銷金額"}),(0,a.jsx)("option",{value:"areaSum",children:"總銷坪數"})]})}),(0,a.jsx)(u.N,{data:F?.[i]||[],filename:`sales_velocity_${i}`,label:"匯出",chartType:"sales-velocity-chart",targetRef:L,snapshotData:F?.[i]||[],chartId:W,columns:{period:"時間區間",count:"交易筆數",priceSum:"總銷金額",areaSum:"總銷坪數"}})]}),children:(0,a.jsx)(o,{data:F?.[i]||{},selectedRooms:T,metric:j,chartId:W})}),V&&(0,a.jsx)(n.c,{title:"銷售速度明細表",description:"各時間段詳細銷售數據統計",containerRef:O,headerAction:(0,a.jsx)(u.N,{data:F?.[i],filename:`sales_velocity_table_${i}`,label:"匯出",chartType:"sales-velocity-table",targetRef:O,snapshotData:F?.[i]||[],columns:{period:"時間區間",count:"交易筆數",priceSum:"總銷金額",areaSum:"總銷坪數"}}),children:(0,a.jsx)(x,{data:F?.[i]||[],viewType:i,selectedRooms:T})}),Z&&(0,a.jsx)(n.c,{title:"房型面積分佈熱力圖",description:"分析不同坪數區間的產品供給與去化分佈",containerRef:_,headerAction:(0,a.jsxs)("div",{className:"flex gap-2 items-center text-zinc-400 text-xs",children:[(0,a.jsxs)("div",{className:"flex gap-2 items-center","data-report-control":"hide",children:[(0,a.jsx)("span",{children:"範圍:"}),(0,a.jsx)(m.p,{type:"number",value:y,onChange:e=>N(Number(e.target.value)),className:"w-16 h-8 text-xs bg-zinc-950/50"}),(0,a.jsx)("span",{children:"-"}),(0,a.jsx)(m.p,{type:"number",value:z,onChange:e=>S(Number(e.target.value)),className:"w-16 h-8 text-xs bg-zinc-950/50"}),(0,a.jsx)("span",{className:"ml-2",children:"級距:"}),(0,a.jsx)(m.p,{type:"number",value:P,onChange:e=>k(Number(e.target.value)),step:"0.5",className:"w-16 h-8 text-xs bg-zinc-950/50"}),(0,a.jsx)("div",{className:"border-l border-white/10 h-4 mx-1"})]}),(0,a.jsx)(u.N,{data:R?Object.entries(R).map(([e,t])=>({key:e,value:JSON.stringify(t)})):[],filename:"area_distribution_heatmap",label:"匯出",chartType:"sales-heatmap",targetRef:_,snapshotData:{distribution:R,selectedRooms:T,min:y,max:z,interval:P},chartId:B,columns:{key:"坪數區間",value:"分佈數據"}})]}),children:(0,a.jsxs)("div",{className:(0,d.cn)("flex flex-col lg:flex-row gap-6 relative overflow-hidden items-stretch transition-all duration-300",C?"lg:h-[600px]":"min-h-[500px]"),children:[(0,a.jsx)(g.P.div,{layout:!0,initial:!1,animate:{flex:C?"0 0 60%":"0 0 100%"},transition:{type:"spring",stiffness:300,damping:35,mass:1},onAnimationStart:()=>{},onAnimationComplete:()=>{D.current&&(D.current.style.width="100%",window.dispatchEvent(new Event("resize")))},className:"min-w-0 overflow-hidden h-full flex flex-col",children:(0,a.jsx)("div",{ref:D,className:"w-full h-full flex flex-col",children:(0,a.jsx)(c,{data:R||{},selectedRooms:T,minArea:y,maxArea:z,interval:P,onDataPointClick:U,height:C?"100%":void 0,chartId:B})})}),(0,a.jsx)(b.N,{mode:"wait",children:C&&(0,a.jsx)(g.P.div,{initial:{opacity:0,x:50,width:0},animate:{opacity:1,x:0,width:"40%"},exit:{opacity:0,x:50,width:0},transition:{type:"spring",stiffness:300,damping:35},className:"min-w-0 h-full flex",children:(0,a.jsx)(Y,{})})})]})}),(0,a.jsx)(f.K,{})]})}},89733:(e,t,r)=>{r.d(t,{N:()=>y});var a=r(95155),s=r(98500),n=r.n(s);r(12115);var i=r(73321),l=r(6296),o=r(25777),c=r(6962),d=r(66088),x=r(95057),h=r(89239),m=r(38346),u=r(96066),p=r(70872),f=r(72264),g=r(40980),b=r(62400),j=r(66609),v=r(37717),w=r(98028);function y({data:e,filename:t="export",label:s="匯出",className:y,disabled:N=!1,columns:z,chartType:S,snapshotData:P,targetRef:k,chartId:M}){let{role:A,isLoading:C}=(0,m.h)(),E=(0,i.useRouter)(),T=(0,u.Q)(e=>e.addItem),$=(0,v.A)(),F=["pro","pro_max","admin","super_admin"].includes(A||""),R=!C,I=()=>{if(R&&F){if(!e||0===e.length)return void alert("無數據可導出");try{let r=Object.keys(e[0]),a=[r.map(e=>z&&z[e]||e).join(","),...e.map(e=>r.map(t=>{let r=e[t];if(null==r)return"";if("number"==typeof r){let e=z&&z[t]||t;return/Area|坪|Rate|Ratio|Share|Percent|比|率/.test(t)||/Area|坪|Rate|Ratio|Share|Percent|比|率/.test(e)?r.toFixed(2):Math.round(r).toFixed(0)}if("object"==typeof r)try{return`"${JSON.stringify(r).replace(/"/g,'""')}"`}catch(e){return""}return"string"==typeof r?`"${r.replace(/"/g,'""').replace(/\n/g," ")}"`:r}).join(","))].join("\n"),s=new Blob(["\uFEFF"+a],{type:"text/csv;charset=utf-8;"}),n=URL.createObjectURL(s),i=document.createElement("a"),l=new Date().toISOString().split("T")[0],o=`${t}_${l}.csv`;i.href=n,i.setAttribute("download",o),document.body.appendChild(i),i.click(),document.body.removeChild(i),URL.revokeObjectURL(n)}catch(e){console.error("Export failed:",e),alert("匯出失敗，請查看控制台日誌")}}},D=async()=>{if(F&&k?.current){if(M&&await L(M,k.current,t))return void j.o.success("已成功匯出圖片");try{let e=k.current,r=e.querySelectorAll('[data-export-footer="true"]');r.forEach(e=>{e.style.display="flex"}),await new Promise(e=>{requestAnimationFrame(()=>e())});let a=await (0,w.domToPng)(e,{scale:2,backgroundColor:$.card||$.bg,filter:e=>!(e instanceof HTMLElement&&e.getAttribute("data-html2canvas-ignore"))});r.forEach(e=>{e.style.display="none"});let s=document.createElement("a"),n=new Date().toISOString().split("T")[0];s.href=a,s.download=`${t}_${n}.png`,document.body.appendChild(s),s.click(),document.body.removeChild(s),j.o.success("已成功匯出圖片")}catch(t){console.error("PNG export failed:",t);let e=k.current;e&&e.querySelectorAll('[data-export-footer="true"]').forEach(e=>{e.style.display="none"}),j.o.error("匯出圖片失敗",{description:"請稍後再試或聯繫客服"})}}},L=async(e,t,a)=>{try{let s,{default:n}=await r.e(7776).then(r.bind(r,95338)),i=n.getChartByID(e);if(!i||!i.el)return!1;let l=i.el.querySelector(".apexcharts-canvas"),o=l?.style.backgroundColor;if(l&&(l.style.backgroundColor=$.card||$.bg),"function"==typeof i.dataURI)try{s=await i.dataURI()}catch(t){s=await n.exec(e,"dataURI")}else s=await n.exec(e,"dataURI");l&&(l.style.backgroundColor=o||"");let c=null,d=null;if(s?.blob instanceof Blob&&(d=c=URL.createObjectURL(s.blob)),c||(c=s?.imgURI||s?.imgUri||s?.dataURI),!c)return!1;let x=new Image;x.src=c,await new Promise((e,t)=>{x.onload=()=>e(null),x.onerror=t});let h=window.getComputedStyle(t),m=parseFloat(h.paddingTop||"0")||0,u=parseFloat(h.paddingBottom||"0")||0,p=parseFloat(h.paddingLeft||"0")||0,f=parseFloat(h.paddingRight||"0")||0,g=t.querySelector(":scope > div"),j=g?.querySelector("div"),v=j?.querySelector("h3"),w=j?.querySelector("p"),y=g&&parseFloat(window.getComputedStyle(g).marginBottom||"0")||0,N=v?.textContent?.trim()||"",z=w?.textContent?.trim()||"",S=v?window.getComputedStyle(v):null,P=w?window.getComputedStyle(w):null,k=S&&parseFloat(S.fontSize||"20")||20,M=S&&parseFloat(S.lineHeight||`${1.3*k}`)||1.3*k,A=S?.fontWeight||"700",C=S?.fontFamily||'"Noto Sans TC", "Inter", sans-serif',E=P&&parseFloat(P.fontSize||"13")||13,T=P&&parseFloat(P.lineHeight||`${1.4*E}`)||1.4*E,F=P?.fontWeight||"400",R=P?.fontFamily||'"Noto Sans TC", "Inter", sans-serif',I=N&&z?6:0,D=(N?M:0)+(z?T+I:0),L=x.width,O=Math.max(L+p+f,t.clientWidth||0),_=O-p-f,W=_/L,B=x.height*W,U=m+D+y+B+64+u,q=window.devicePixelRatio||1,H=document.createElement("canvas");H.width=Math.round(O*q),H.height=Math.round(U*q);let V=H.getContext("2d");if(!V)return!1;V.scale(q,q),V.fillStyle=$.card||$.bg,V.fillRect(0,0,O,U);let Z=m;V.textBaseline="top",N&&(V.font=`${A} ${k}px ${C}`,V.fillStyle=$.text,V.textAlign="left",V.fillText(N,p,Z),Z+=M),z&&(Z+=I,V.font=`${F} ${E}px ${R}`,V.fillStyle=$.textMuted,V.textAlign="left",V.fillText(z,p,Z),Z+=T),Z+=y,V.drawImage(x,p,Z,_,B);let G=U-64-u;V.strokeStyle=$.border,V.beginPath(),V.moveTo(0,G),V.lineTo(O,G),V.stroke();let Y=`搜尋條件：${(0,b.b)()}`,J=O-48;V.textAlign="center",V.font=`600 13px ${C}`,V.fillStyle=$.text,V.fillText("彙整：平米內參 　來源：內政部實登",O/2,G+18),V.font=`400 11px ${R}`,V.fillStyle=$.textMuted;let X=Y;for(;V.measureText(X).width>J&&X.length>4;)X=X.slice(0,-1);X!==Y&&(X=`${X.slice(0,-1)}…`),V.fillText(X,O/2,G+38);let Q=H.toDataURL("image/png"),K=document.createElement("a"),ee=new Date().toISOString().split("T")[0];return K.href=Q,K.download=`${a}_${ee}.png`,document.body.appendChild(K),K.click(),document.body.removeChild(K),d&&URL.revokeObjectURL(d),!0}catch(e){return console.warn("ApexCharts export failed",e),!1}};return C?(0,a.jsxs)(h.$,{variant:"outline",size:"sm",disabled:!0,"data-report-control":"always-hide",className:`gap-2 border-dashed border-zinc-700 bg-zinc-900/50 text-zinc-600 ${y}`,children:[(0,a.jsx)(l.A,{className:"h-4 w-4 animate-spin"}),(0,a.jsx)("span",{className:"hidden sm:inline",children:"載入中..."})]}):S?(0,a.jsx)(p.Bc,{children:(0,a.jsxs)(p.m_,{delayDuration:0,children:[(0,a.jsx)(p.k$,{asChild:!0,children:(0,a.jsx)("span",{className:"inline-flex",tabIndex:F?-1:0,"data-report-control":"always-hide",children:F?(0,a.jsxs)(f.rI,{children:[(0,a.jsx)(f.ty,{asChild:!0,children:(0,a.jsxs)(h.$,{variant:"outline",size:"sm",disabled:N||!e||0===e.length,className:(0,g.cn)("gap-1.5 border-dashed transition-all border-zinc-700 bg-zinc-900/50 hover:bg-zinc-800 text-zinc-400 hover:text-white",y),children:[(0,a.jsx)(c.A,{className:"h-4 w-4"}),(0,a.jsx)("span",{className:"hidden sm:inline",children:s}),(0,a.jsx)(d.A,{className:"h-3 w-3"})]})}),(0,a.jsxs)(f.SQ,{align:"start",className:"min-w-[180px] bg-zinc-900 border-zinc-700",children:[(0,a.jsxs)(f._2,{onClick:I,className:"flex items-center gap-2 text-zinc-300 hover:text-white focus:text-white cursor-pointer",children:[(0,a.jsx)(c.A,{className:"h-4 w-4 text-zinc-500"}),"匯出 CSV"]}),k&&(0,a.jsxs)(f._2,{onClick:D,className:"flex items-center gap-2 text-zinc-300 hover:text-white focus:text-white cursor-pointer",children:[(0,a.jsx)("div",{className:"h-4 w-4 flex items-center justify-center text-zinc-500 font-bold text-[10px] border border-zinc-600 rounded",children:"P"}),"匯出 PNG (圖片)"]}),(0,a.jsxs)(f._2,{onClick:()=>{F&&S&&(T(S,void 0!==P?P:e),j.o.success("已新增至報表編輯器",{description:"請點選左側「生成報告」繼續編輯",action:{label:"前往編輯",onClick:()=>E.push("/reports/builder")}}))},className:"flex items-center gap-2 text-zinc-300 hover:text-violet-300 focus:text-violet-300 hover:bg-violet-600/20 focus:bg-violet-600/20 cursor-pointer",children:[(0,a.jsx)(x.A,{className:"h-4 w-4 text-violet-500"}),"新增到報表編輯器"]})]})]}):(0,a.jsxs)(h.$,{variant:"outline",size:"sm",disabled:!0,className:(0,g.cn)("gap-1.5 border-dashed transition-all border-zinc-800 bg-zinc-900/30 text-zinc-600 cursor-not-allowed hover:bg-zinc-900/30",y),children:[(0,a.jsx)(o.A,{className:"h-3 w-3"}),(0,a.jsx)("span",{className:"hidden sm:inline",children:s})]})})}),!F&&(0,a.jsx)(p.ZI,{className:"bg-zinc-950 border border-zinc-800 p-0 overflow-hidden",children:(0,a.jsxs)("div",{className:"flex flex-col gap-1 items-center p-3",children:[(0,a.jsx)("p",{className:"font-medium text-zinc-200",children:"Pro 會員限定功能"}),(0,a.jsx)(n(),{href:"/pricing",className:"text-xs text-violet-400 hover:text-violet-300 underline underline-offset-2 transition-colors flex items-center gap-1",children:"查看升級方案 →"})]})})]})}):(0,a.jsx)(p.Bc,{children:(0,a.jsxs)(p.m_,{delayDuration:0,children:[(0,a.jsx)(p.k$,{asChild:!0,children:(0,a.jsx)("span",{className:"inline-flex",tabIndex:F?-1:0,"data-report-control":"always-hide",children:(0,a.jsxs)(h.$,{variant:"outline",size:"sm",onClick:I,disabled:N||F&&(!e||0===e.length),className:(0,g.cn)("gap-1.5 border-dashed transition-all",F?"border-zinc-700 bg-zinc-900/50 hover:bg-zinc-800 text-zinc-400 hover:text-white":"border-zinc-800 bg-zinc-900/30 text-zinc-600 cursor-not-allowed hover:bg-zinc-900/30",y),children:[F?(0,a.jsx)(c.A,{className:"h-4 w-4"}):(0,a.jsx)(o.A,{className:"h-3 w-3"}),(0,a.jsx)("span",{className:"hidden sm:inline",children:s})]})})}),!F&&(0,a.jsx)(p.ZI,{className:"bg-zinc-950 border border-zinc-800 p-0 overflow-hidden",children:(0,a.jsxs)("div",{className:"flex flex-col gap-1 items-center p-3",children:[(0,a.jsx)("p",{className:"font-medium text-zinc-200",children:"Pro 會員限定功能"}),(0,a.jsx)(n(),{href:"/pricing",className:"text-xs text-violet-400 hover:text-violet-300 underline underline-offset-2 transition-colors flex items-center gap-1",children:"查看升級方案 →"})]})})]})})}},96066:(e,t,r)=>{r.d(t,{Q:()=>l});var a=r(1934),s=r(31692);let n={"cover-template":{width:900,height:500},"ranking-chart":{width:400,height:300},"ranking-table":{width:600,height:400},"ranking-metrics":{width:600,height:200},"price-band-chart":{width:450,height:280},"price-band-table":{width:600,height:400},"price-band-location-table":{width:600,height:400},"price-band-location-chart":{width:600,height:400},"unit-price-bubble":{width:380,height:320},"unit-price-stats":{width:1e3,height:400},"type-comparison-table":{width:600,height:350},"sales-velocity-chart":{width:420,height:260},"sales-velocity-table":{width:600,height:400},"sales-heatmap":{width:450,height:350},"sales-heatmap-detail":{width:800,height:400},"parking-pie":{width:300,height:300},"parking-price":{width:400,height:300},"parking-scatter":{width:450,height:350},"parking-floor":{width:400,height:400},"parking-floor-detail":{width:900,height:420},"policy-timeline":{width:900,height:500},heatmap:{width:500,height:350},"heatmap-grid":{width:800,height:500},"heatmap-stats":{width:800,height:120},"heatmap-comparison":{width:800,height:300},"data-list":{width:600,height:400},"text-box":{width:280,height:90}},i=e=>({id:`page-${Date.now()}`,name:`第 ${e+1} 頁`,items:[]}),l=(0,a.v)()((0,s.Zr)((e,t)=>({pages:[i(0)],currentPageIndex:0,canvasRatio:"16:9",zoomLevel:100,viewMode:"continuous",selectedIds:[],isDragging:!1,draggedItemCount:0,hoveredPageIndex:null,setViewMode:t=>e({viewMode:t}),setDragging:(t,r=0)=>e({isDragging:t,draggedItemCount:r}),setHoveredPageIndex:t=>e({hoveredPageIndex:t}),get items(){let e=t();return e.pages[e.currentPageIndex]?.items||[]},addPage:()=>{e(e=>{let t=i(e.pages.length);return{pages:[...e.pages,t],currentPageIndex:e.pages.length,selectedIds:[]}})},deletePage:t=>{e(e=>{if(e.pages.length<=1||-1===e.pages.findIndex(e=>e.id===t))return e;let r=e.pages.filter(e=>e.id!==t).map((e,t)=>({...e,name:`第 ${t+1} 頁`})),a=Math.min(e.currentPageIndex,r.length-1);return{pages:r,currentPageIndex:a,selectedIds:[]}})},setCurrentPage:t=>{e(e=>({currentPageIndex:Math.max(0,Math.min(t,e.pages.length-1)),selectedIds:[]}))},renamePage:(t,r)=>{e(e=>({pages:e.pages.map(e=>e.id===t?{...e,name:r}:e)}))},reorderPages:(t,r)=>{e(e=>{if(t===r)return e;let a=[...e.pages],[s]=a.splice(t,1);a.splice(r,0,s);let n=a.map((e,t)=>({...e,name:`第 ${t+1} 頁`})),i=e.currentPageIndex;return e.currentPageIndex===t?i=r:t<e.currentPageIndex&&r>=e.currentPageIndex?i=e.currentPageIndex-1:t>e.currentPageIndex&&r<=e.currentPageIndex&&(i=e.currentPageIndex+1),{pages:n,currentPageIndex:i}})},addItem:(t,r)=>{let a=n[t]||{width:400,height:300};e(e=>{let s=e.pages[e.currentPageIndex];if(!s)return e;let n=20*s.items.length,i="cover-template"===t,l={id:`item-${Date.now()}`,type:t,x:i?0:50+n,y:i?0:50+n,width:a.width,height:a.height,contentBase:{width:a.width,height:a.height},headerLocked:!1,showControls:"text-box"===t,scaleMode:"select",panOffset:{x:0,y:0},contentScale:i||"text-box"===t?1:.5,data:r??(e=>{if("cover-template"===e){let e=new Date,t=e.getFullYear(),r=String(e.getMonth()+1).padStart(2,"0"),a=String(e.getDate()).padStart(2,"0");return{logoText:"平米內參",title:"市場分析報告",subtitle:"價格帶與銷售動能評估",projectName:"請填寫建案名稱",period:"2026 Q1",preparedBy:"平米內參",reportDate:`${t}-${r}-${a}`,searchConditions:[]}}if("text-box"===e)return{html:"<div>請輸入文字或數字</div>",align:"left",verticalAlign:"top",fontSize:20,maxFontSize:20,fontFamily:'"Noto Sans TC", "PingFang TC", "Microsoft JhengHei", system-ui, sans-serif',fontWeight:500,italic:!1,underline:!1,color:"var(--color-text-primary)",autoFit:!1,autoGrow:!0,rotation:0}})(t)};return{pages:e.pages.map((t,r)=>r===e.currentPageIndex?{...t,items:[...t.items,l]}:t),selectedIds:[l.id]}})},addItems:t=>{t.length&&e(e=>e.pages[e.currentPageIndex]?{pages:e.pages.map((r,a)=>a===e.currentPageIndex?{...r,items:[...r.items,...t]}:r),selectedIds:t.map(e=>e.id)}:e)},updateItem:(t,r)=>{e(e=>({pages:e.pages.map((a,s)=>s===e.currentPageIndex?{...a,items:a.items.map(e=>e.id===t?{...e,...r}:e)}:a)}))},removeItem:t=>{e(e=>({pages:e.pages.map((r,a)=>a===e.currentPageIndex?{...r,items:r.items.filter(e=>e.id!==t)}:r),selectedIds:e.selectedIds.filter(e=>e!==t)}))},moveItemToPage:(t,r)=>{e(e=>{let a=e.pages[e.currentPageIndex],s=a?.items.find(e=>e.id===t);return!s||r===e.currentPageIndex||r<0||r>=e.pages.length?e:{pages:e.pages.map((a,n)=>n===e.currentPageIndex?{...a,items:a.items.filter(e=>e.id!==t)}:n===r?{...a,items:[...a.items,{...s,x:50,y:50}]}:a),selectedIds:[]}})},clearCanvas:()=>{e(e=>({pages:e.pages.map((t,r)=>r===e.currentPageIndex?{...t,items:[]}:t),selectedIds:[]}))},batchUpdateItems:t=>{e(e=>({pages:e.pages.map((r,a)=>a===e.currentPageIndex?{...r,items:r.items.map(e=>t[e.id]?{...e,...t[e.id]}:e)}:r)}))},setCanvasRatio:t=>e({canvasRatio:t}),setZoomLevel:t=>e({zoomLevel:Math.max(25,Math.min(400,t))}),resetZoom:()=>e({zoomLevel:100}),setSelectedIds:t=>e({selectedIds:t}),toggleSelection:t=>{e(e=>({selectedIds:e.selectedIds.includes(t)?e.selectedIds.filter(e=>e!==t):[...e.selectedIds,t]}))},addToSelection:t=>{e(e=>({selectedIds:e.selectedIds.includes(t)?e.selectedIds:[...e.selectedIds,t]}))},clearSelection:()=>e({selectedIds:[]}),removeSelectedItems:()=>{e(e=>e.pages[e.currentPageIndex]?{pages:e.pages.map((t,r)=>r===e.currentPageIndex?{...t,items:t.items.filter(t=>!e.selectedIds.includes(t.id))}:t),selectedIds:[]}:e)},moveSelectedItemsToPage:t=>{e(e=>{if(t===e.currentPageIndex||t<0||t>=e.pages.length)return e;let r=e.pages[e.currentPageIndex].items.filter(t=>e.selectedIds.includes(t.id));return 0===r.length?e:{pages:e.pages.map((a,s)=>s===e.currentPageIndex?{...a,items:a.items.filter(t=>!e.selectedIds.includes(t.id))}:s===t?{...a,items:[...a.items,...r.map((e,t)=>({...e,x:50+20*t,y:50+20*t}))]}:a),selectedIds:[]}})}}),{name:"report-builder-storage"}))},97085:(e,t,r)=>{r.d(t,{A:()=>o});var a=r(95155);r(12115);var s=r(37206),n=r(81477),i=r(37717);let l=(0,s.default)(()=>Promise.all([r.e(7776),r.e(4822)]).then(r.bind(r,44822)),{loadableGenerated:{webpack:()=>[null]},ssr:!1});function o({type:e,series:t,options:r,height:s=350,title:o,description:c,className:d,loading:x}){let h=(0,i.A)(),m={chart:{background:"transparent",foreColor:h.text,toolbar:{show:!1}},theme:{mode:"dark",palette:"palette1"},dataLabels:{enabled:!1,style:{colors:[h.text]}},grid:{borderColor:h.grid,strokeDashArray:4},xaxis:{labels:{style:{colors:h.textMuted}},axisBorder:{color:h.border},axisTicks:{color:h.border}},yaxis:{labels:{style:{colors:h.textMuted}}},tooltip:{theme:"dark",style:{fontSize:"12px"},x:{show:!0}},legend:{labels:{colors:h.textMuted}}},u={...m,...r,chart:{...m.chart,...r.chart}};return(0,a.jsxs)(n.Zp,{className:`p-4 ${d}`,children:[(o||c)&&(0,a.jsxs)("div",{className:"mb-4",children:[o&&(0,a.jsx)("h3",{className:"text-lg font-bold text-text-primary mb-1",children:o}),c&&(0,a.jsx)("p",{className:"text-sm text-text-secondary",children:c})]}),x?(0,a.jsx)("div",{className:"flex items-center justify-center",style:{height:s},children:(0,a.jsx)("div",{className:"loader"})}):(0,a.jsx)(l,{options:u,series:t,type:e,height:s,width:"100%"})]})}},98883:(e,t,r)=>{r.d(t,{P:()=>a});let a=e=>{let t=new Date,r=new Date,a=e.match(/^(\d+)m$/);if(a){let e=parseInt(a[1],10);if(Number.isFinite(e))return r.setMonth(t.getMonth()-e),{startDate:r.toISOString().split("T")[0],endDate:t.toISOString().split("T")[0]}}switch(e){case"1q":r.setMonth(t.getMonth()-3);break;case"2q":r.setMonth(t.getMonth()-6);break;case"3q":r.setMonth(t.getMonth()-9);break;case"1y":r.setFullYear(t.getFullYear()-1);break;case"this_year":r=new Date(t.getFullYear(),0,1);break;case"last_2_years":r=new Date(t.getFullYear()-1,0,1);break;case"last_3_years":r=new Date(t.getFullYear()-2,0,1);break;default:return{startDate:"",endDate:""}}return{startDate:r.toISOString().split("T")[0],endDate:t.toISOString().split("T")[0]}}}}]);