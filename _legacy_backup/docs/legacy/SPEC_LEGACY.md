### 1.1 資料篩選 (Data Filtering)
- **縣市 (County)**: 
  - 支援 **多縣市選擇 (Multi-City Selection)**。
  - **限制**: 使用者至多可選擇 **6** 個縣市。
  - **互動**: 使用標籤 (Tag) 形式顯示已選縣市，支援個別刪除與一鍵清除。
  - **載入機制**: 採用 **佇列式依序載入 (Sequential Queue Loading)**，避免同時發送過多 API 請求導致超時。系統會顯示載入進度 (例如: 'Loading 臺北市 (1/3)...')。
- **行政區 (District)**: 
  - 根據已選縣市動態載入對應行政區。
  - 支援跨縣市行政區篩選。
  - **分組顯示**: 下拉選單中依縣市分組顯示行政區。
- **交易類型 (Transaction Type)**:
  - 預售交易 (Pre-sale) - **Default**
  - 中古交易 (Resale) - (Reserved for Future)
  - 租賃交易 (Lease) - (Reserved for Future)
- **建物型態 (Building Type)**:
  - 支援多選，例如：住宅大樓, 華廈, 公寓, 套房等。
- **日期範圍 (Date Range)**:
  - 支援快捷選項 (近一季, 近一年...) 與自訂範圍。
- **建案名稱 (Project Name)**:
  - 支援關鍵字搜尋與多選。
  - 根據已選縣市動態提供建議列表。
- **排除商辦 (Exclude Commercial)**:
  - Toggle switch, 預設開啟。排除主要用途非住家或型態為店面/辦公室的交易。
# 📋 SPEC.md - 平米內參需求真理源

**版本**: 2.0.0  
**最後更新**: 2026-01-12

---

## 🎯 產品定位

**「平米內參」是一個不動產數據分析平台**，將台灣實價登錄數據轉化為可視化的決策支援系統。

### 目標用戶
- 代銷人員
- 房仲業者
- 建商
- 估價師
- 投資者

---

## 🧠 核心業務邏輯

### 1. 建案分析功能

| 功能 | 說明 | 核心指標 |
|------|------|----------|
| 核心指標與排名 | 區域建案的綜合排名分析 (含行政區標籤) | 總銷金額、成交件數、坪數統計、市佔率、行政區 |
| 總價帶分析 | 不同價格區間的分佈分析 | 價格區間、成交比例、箱型圖統計 |
| 房屋單價分析 | 無車位房屋單價的類型分析 | 住宅/店舖/商辦倍數比較 |
| 房型去化分析 | 各戶型的銷售速度與定價策略 | 基準戶、樓層價差、熱力圖 |
| 車位單價分析 | 車位定價與3D樓層視覺化 | 車位均價、樓層分佈、房車配比 |
| 垂直水平分析 | 樓層溢價與水平比較 | 樓層價差百分比、水平比較表 |

### 2. 關鍵計算公式

```
房屋單價(萬) = (交易總價 - 車位總價) / (房屋面積 ÷ 3.30579) / 10000
```

---

## 🔍 數據篩選邏輯

### 1. 主要篩選條件

| 篩選項 | 說明 | 欄位對應 |
|--------|------|----------|
| 縣市 | 選擇分析的縣市範圍 | `countyCode` → 資料表名稱 |
| 區域 | 可多選行政區 | `districts` → `行政區` |
| 交易類型 | 預售交易 / 中古交易 | `type` → 表名後綴 `_b` / `_a` |
| 日期範圍 | 交易日期區間 | `dateStart`, `dateEnd` → `交易日` |
| 建物型態 | 住宅大樓/華廈/店面等 | `buildingType` → `建物型態` |
| 建案名稱 | 可多選指定建案 | `projectNames` → `建案名稱` |
| 排除商辦店面 | 開關控制 | `excludeCommercial` |

### 2. 建物型態特殊篩選：店面(店鋪)

當 `buildingType === '店面(店鋪)'` 時，使用 OR 組合查詢：
```sql
"建物型態" ILIKE '%店面%' OR
"建物型態" ILIKE '%店舖%' OR
"建物型態" ILIKE '%店鋪%' OR
("主要用途" = '商業用' AND "樓層" = 1) OR
("主要用途" = '住商用' AND "樓層" = 1) OR
"備註" ILIKE '%店面%' OR
"戶別" ILIKE '%店面%' OR
("建物型態" ILIKE '%住宅大樓%' AND "樓層" = 1 AND "房數" = 0)
```

### 3. 房型分類邏輯（互斥優先級）

```
優先級 1: 店舖
├── building_type 包含 "店舖" / "店面" / "店鋪"
├── 戶別 包含 "店舖" / "店面" / "店鋪"
├── 備註 包含 "店面" / "店舖" / "店鋪"
├── (主要用途 = '商業用' AND 樓層 = 1)
├── (主要用途 = '住商用' AND 樓層 = 1)
├── (建物型態 = 住宅大樓 AND 戶別含 'S')
└── (建物型態 = 住宅大樓 AND 樓層 = 1 AND 房數 = 0)

優先級 2: 辦公/事務所
├── 戶別 包含 "事務所" 或 "辦公"
├── 主要用途 包含 "商業"
└── 建物型態 包含 "辦公" 或 "事務所"

優先級 3: 廠辦/工廠
└── 建物型態 包含 "工廠" / "倉庫" / "廠辦"

優先級 4: 特殊住宅 (0房)
├── 住宅大樓/華廈 且 房數 = 0 且 面積 > 35坪 → 毛胚
└── 住宅大樓/華廈 且 房數 = 0 且 面積 ≤ 35坪 → 套房

優先級 5: 標準住宅
├── 房數 = 1 → 1房
├── 房數 = 2 → 2房
├── 房數 = 3 → 3房
├── 房數 = 4 → 4房
└── 房數 ≥ 5 → 5房以上

其他: 不符合以上任何條件
```

### 4. 單價統計篩選

#### 排除商辦店面模式
當開啟 `excludeCommercial` 時，排除以下類別：
- 店舖
- 辦公/事務所
- 廠辦/工廠

### 5. 戶別解析器（兩階段演算法）

#### 第一階段：廣譜模式匹配
- 內建 20+ 個正規表示式規則庫
- 匹配常見格式：`A1-15F`、`A1棟15樓`、`B棟五樓`

#### 第二階段：自適應校正
1. **主流風格檢測**：統計已解析戶別，判斷是 `letterNumber`（A1）還是 `plainLetter`（A）格式
2. **二次打撈**：對未解析戶別使用寬鬆規則
3. **風格統一**：將非主流格式轉換為主流格式

> 準確率從 80% 提升至 95% 以上

### 5.5. 建案名稱自動替換功能 (Uploader)

上傳工具 (update.html) 支援建案名稱的自動替換，解決實價登錄資料中的亂碼問題。

#### 觸發條件
- 只有當**舊建案名稱包含「？」**時，才會儲存對應規則
- 例如：「達麗河？」→「達麗河藴」會儲存，「達麗河蘊」→「達麗河藴」不會儲存

#### 運作流程
```
CSV 檔案輸入
    │
    │  「達麗河？」(亂碼)
    ▼
┌─────────────────────────────┐
│  第 1 步：本機自動替換       │  ← file-handler.js
│  查 project_name_mappings   │
│  「達麗河？」→「達麗河藴」   │
└─────────────────────────────┘
    │
    │  「達麗河藴」(已修正)
    ▼
┌─────────────────────────────┐
│  第 2 步：比對資料庫         │  ← utils.js isEqual()
│  跳過空值欄位比對            │
│  (如 Supabase 自動計算欄位)  │
└─────────────────────────────┘
    │
    ▼
┌─────────────────────────────┐
│  第 3 步：上傳 Supabase     │
│  送出的是正確名稱            │
└─────────────────────────────┘
```

#### 關鍵設計
1. **替換發生在上傳前**：CSV 中的亂碼永遠不會進入資料庫
2. **空值比對保護**：CSV 缺少的欄位（如 Supabase 自動計算的 `交易總價(萬)`）不會觸發誤判更新
3. **儲存於 `project_name_mappings` 表**：連線成功時自動載入所有對應規則

### 6. 基準戶篩選演算法

```
輸入: 建案所有交易數據

步驟:
1. 按 finalUnitId 分組 (A1, A2, B1...)
2. 對每組，找出最早交易日期
3. 選取「最早日期 + 14天」窗口內的交易
4. 取窗口內「房屋單價(萬)」最低者為基準戶
5. 記錄 anchorPrice 和 anchorFloor

輸出: 每個戶型的基準戶資訊
```

### 7. 樓層價差計算

```javascript
floorPremium = ((currentUnitPrice / anchorPrice) - 1) * 100
```

### 8. 坪數加權平均

```javascript
加權平均單價 = Σ(單價 × 房屋坪數) / Σ(房屋坪數)
```

> 動機：避免極端小坪數高單價交易扭曲均價

---

## 📊 分析報告類型

### 1. 核心指標與排名 (projectRanking)
- **總銷金額**: 區域內建案的交易總價加總
- **坪數統計**: 房屋面積加總
- **均價**: 加權平均單價
- **市佔率**: 該建案總銷 / 區域總銷 × 100%
- **支援排序**: 總銷金額、成交件數、坪數、均價

### 2. 總價帶分析 (priceBandAnalysis)
- **價格區間**: 自動分群
- **成交件數**: 各區間成交筆數
- **箱型圖**: Q1, 中位數, Q3, 最大最小值

### 3. 房屋單價分析 (unitPriceAnalysis)
- **住宅均價**: 純住宅加權平均單價
- **店舖均價**: 店舖加權平均單價
- **商辦均價**: 商辦加權平均單價
- **店舖倍數**: 店舖均價 / 住宅均價
- **商辦倍數**: 商辦均價 / 住宅均價

### 4. 車位分析 (parkingAnalysis)
- **車位均價**: 按車位類型分類（僅統計有明確車位價格的交易）
- **交易筆數/車位總數**: 統計所有含車位的交易/車位，包含價格為 0 或已打包在總價中的情況
- **樓層分佈**: B1-B4 個別統計，B5 以下歸類為 `B5_below`，無法識別樓層歸類為 `Unknown`
- **房車配比**: 戶數 vs 車位數圓餅圖
- **計數邏輯**: 均價僅計算有效價格(>0)的車位，但總數統計包含所有車位（含無價格者）

### 5. 銷售速度分析 (salesVelocityAnalysis)
- **月度趨勢**: 按月統計成交件數與金額
- **週度趨勢**: 按週統計
- **房型篩選**: 可選擇特定房型查看

### 6. 垂直水平分析 (priceGridAnalysis)
- **樓層價差熱力圖**: 顯示各樓層相對基準的溢價
- **水平比較表**: 同樓層不同戶型比較
- **特殊標籤**: 頂樓加價、露台戶、親友戶

---

## 👤 用戶流程

```
選擇縣市 → 選擇區域 → 選擇建案 → 點擊分析 → 瀏覽各報告頁籤 → 導出 PDF
```

---

## 🔐 會員機制

- 目前已禁用強制登入（使用 Service Role Key 繞過認證）
- 未來計劃：Q4 2025 引入 Supabase Auth

---

## 📱 響應式設計

- 桌面版：完整功能
- 行動版：優化表格滾動、卡片佈局

---

## 📤 導出功能

- PDF 報告：包含所有分析頁面數據
- 使用 html2pdf.js 生成
- 深色主題背景樣式

---

## 🌏 SEO 與社群分享

### 1. Meta Tags 規範
- **Title**: `平米內參 - 預售屋數據儀表板 | 實價登錄與銷控表分析`
- **Description**: 強調「獨家預售屋數據儀表板」、「銷控表」、「調價熱力圖」。
- **Keywords**: 包含「預售屋, 實價登錄, 房地產數據, 銷控表, 房價分析」。
- **Canonical**: 指向 `https://sqm7.github.io/kthd/`。

### 2. Open Graph / Twitter Card
- **og:type**: `website`
- **og:image**: 使用專屬設計的 `og-cover.png`
- **twitter:card**: `summary_large_image`

### 3. OG 圖片標準
- **路徑**: `css/images/og-cover.png`
- **尺寸**: 1200x630 (1.91:1)
- **設計風格**: 深色科技感 (#0f172a)、無文字(通用)、數據視覺化元素。

---

## ⚠️ 業務規則約束

1. **單價計算必須排除車位** - 這是系統的黃金指標
2. **房型互斥分類** - 一筆交易只能歸入一個類別（店舖 > 商辦 > 住宅）
3. **坪數加權平均** - 避免極端值扭曲均價
4. **戶別風格統一** - 同建案內統一為主流命名風格

### 5.6. 建案搜尋與顯示增強

搜尋建議清單 (Suggest List) 旨在提供更豐富的上下文資訊以輔助決策。

#### 顯示資訊
- **建案名稱**: 基礎資訊
- **行政區**: 顯示於名稱右側 (灰色標籤)，解決同名建案混淆問題
- **最早交易年月**: 顯示於行政區右側 (藍色標籤)，格式為 YYYY/MM，輔助判斷建案新舊

#### 視覺設計
- 建案名稱: 主色調 (白色/淺灰)
- 行政區: 弱化顯示 (灰色背景、小字)
- 交易年月: 強調顯示 (Cyan/藍色背景、小字)


### 5.7. 多縣市複選分析 (Multi-City Selection)

#### 功能描述
允許使用者同時選擇多個縣市進行合併分析，以滿足跨區域比較或大範圍市調的需求。

#### 核心規則
1. **複選限制**: 最多同時選擇 **6** 個縣市。
2. **依序載入 (Sequential Loading)**: 
   - 避免同時發出過多請求導致 Timeout。
   - 依序對每個選定縣市發起 API 請求。
   - 介面需顯示載入進度 (例: "正在載入 臺北市 (1/3)...")。
3. **數據聚合 (Aggregation)**:
   - **核心指標**: 加總所有縣市的交易量、總銷金額；重新計算整體加權均價。
   - **排名表**: 合併所有建案清單並重新排序。
   - **圖表分析**: 針對房型、單價等分佈圖，進行數據合併 (Sum) 或加權平均 (Weighted Avg)。
   - **限制**: 部分統計值 (如總體中位數) 為近似估算或加權平均結果。
