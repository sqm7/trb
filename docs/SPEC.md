# 📋 SPEC.md - 平米內參需求真理源

- **Report Generator**: Custom PDF report builder allowing users to select specific modules (charts, tables) from various analysis tabs (Ranking, Price Band, etc.) based on current dashboard filters.

**版本**: 3.0.0  
**最後更新**: 2026-01-15

---

## 🎯 產品定位

**「平米內參」是一個不動產數據分析平台**，將台灣實價登錄數據轉化為可視化的決策支援系統。

### 目標用戶
- 代銷人員
- 房仲業者
- 建商
- 估價師
- 投資者

---

## 🧠 核心業務邏輯

### 1. 建案分析功能

| 功能 | 說明 | 核心指標 |
|------|------|----------|
| 核心指標與排名 | 區域建案的綜合排名分析 (含行政區標籤) | 總銷金額、成交件數、坪數統計、市佔率、行政區 |
| 總價帶分析 | 不同價格區間的分佈分析 | 價格區間、成交比例、箱型圖統計、**依房型合併 (Merge Bathrooms)** |
| 房屋單價分析 | 無車位房屋單價的類型分析 | 住宅/店舖/商辦倍數比較、**單價泡泡圖** |
| 房型去化分析 | 各戶型的銷售速度與定價策略 | 基準戶、樓層價差、熱力圖、**區域房型交叉表** |
| 車位單價分析 | 車位定價與3D樓層視覺化 | 車位均價、樓層分佈、房車配比 |
| 垂直水平分析 | 樓層溢價與水平比較 | 樓層價差百分比、水平比較表 |

### 2. 關鍵計算公式

```
房屋單價(萬) = (交易總價 - 車位總價) / (房屋面積 ÷ 3.30579) / 10000
```

### 3. 車位附表邏輯 (Data Fallback)

由於部分實價登錄資料存在「主表有紀錄、附表缺漏」的情況，前端需實作以下容錯機制：

1.  **優先讀取附表**：嘗試調用 `query-sub-data` 獲取詳細車位資料（含樓層）。
2.  **智慧補償 (Fallback)**：若附表回傳為空，但主表 (`TransactionRecord`) 中 `車位數 > 0`，則自動從主表讀取：
    -   車位價格：使用主表 `車位總價`
    -   車位面積：使用主表 `車位總面積`
    -   車位類型：使用主表 `車位類別`
    -   車位樓層：顯示 `-` (因主表無此欄位)

---

## 🔍 數據篩選邏輯

### 1. 主要篩選條件

| 篩選項 | 說明 | 欄位對應 |
|--------|------|----------|
| 縣市 | **可多選**縣市範圍 | `selectedCounties` → 資料表名稱 |
| 區域 | 可多選行政區 | `districts` → `行政區` |
| 交易類型 | 預售交易 / 中古交易 | `type` → 表名後綴 `_b` / `_a` |
| 日期範圍 | 交易日期區間 | `dateStart`, `dateEnd` → `交易日` |
| 建物型態 | 住宅大樓/華廈/店面等 | `buildingType` → `建物型態` |
| 建案名稱 | 可多選指定建案 | `projectNames` → `建案名稱` |
| 排除商辦店面 | 開關控制 | `excludeCommercial` |

### 2. 建物型態特殊篩選：店面(店鋪)

當 `buildingType === '店面(店鋪)'` 時，使用 OR 組合查詢：
```sql
"建物型態" ILIKE '%店面%' OR
"建物型態" ILIKE '%店舖%' OR
"建物型態" ILIKE '%店鋪%' OR
("主要用途" = '商業用' AND "樓層" = 1) OR
("主要用途" = '住商用' AND "樓層" = 1) OR
"備註" ILIKE '%店面%' OR
"戶別" ILIKE '%店面%' OR
("建物型態" ILIKE '%住宅大樓%' AND "樓層" = 1 AND "房數" = 0)
```

### 3. 房型分類邏輯（互斥優先級）

```
優先級 1: 店舖
├── building_type 包含 "店舖" / "店面" / "店鋪"
├── 戶別 包含 "店舖" / "店面" / "店鋪"
├── 備註 包含 "店面" / "店舖" / "店鋪"
├── (主要用途 = '商業用' AND 樓層 = 1)
├── (主要用途 = '住商用' AND 樓層 = 1)
├── (建物型態 = 住宅大樓 AND 戶別含 'S')
└── (建物型態 = 住宅大樓 AND 樓層 = 1 AND 房數 = 0)

優先級 2: 辦公/事務所
├── 戶別 包含 "事務所" 或 "辦公"
├── 主要用途 包含 "商業"
└── 建物型態 包含 "辦公" 或 "事務所"

優先級 3: 廠辦/工廠
└── 建物型態 包含 "工廠" / "倉庫" / "廠辦"

優先級 4: 特殊住宅 (0房)
├── 住宅大樓/華廈 且 房數 = 0 且 面積 > 35坪 → 毛胚
└── 住宅大樓/華廈 且 房數 = 0 且 面積 ≤ 35坪 → 套房

優先級 5: 標準住宅
├── 房數 = 1 → 1房
├── 房數 = 2 → 2房
├── 房數 = 3 → 3房
├── 房數 = 4 → 4房
└── 房數 ≥ 5 → 5房以上

優先級 6: 其他
└── 無法分類 → 其他
```

---

## 📊 新增功能規格 (2026-01-15)

### 1. 區域房型成交筆數交叉表格

**位置**：房型去化分析頁籤底部

**功能**：
- 顯示各行政區/縣市的房型成交筆數
- 支援維度切換（行政區 / 縣市）
- 支援縣市篩選（行政區維度時）
- 與房型篩選器連動

**UI 控制項**：
- 分組維度切換按鈕
- 顯示範圍下拉選單（僅行政區維度時顯示）
- 交叉表格（行=房型, 列=區域）
- 堆疊橫向長條圖

### 2. 單價分佈泡泡圖

**位置**：房屋單價分析頁籤底部

**功能**：
- 顯示不同單價區間的成交分佈
- 泡泡大小 = 影響力（成交件數或總坪數）
- 漸層色彩 = 單價高低
- 支援自訂單價區間

**UI 控制項**：
- 最低單價輸入框
- 最高單價輸入框
- 單價級距輸入框
- 影響力指標切換按鈕（成交件數 / 房屋坪數）
- 更新圖表按鈕
- 影響力指標切換按鈕（成交件數 / 房屋坪數）
- **顯示模式切換**：座標模式 (Coordinate) / 自然模式 (Natural)
- **視覺呈現**：需具備質感 (Premium Aesthetics)，使用漸層與光影效果

### 3. 建案搜尋增強 (2026-01-16)

**位置**：頂部篩選器 (FilterBar)

**功能**：
- 下拉選單顯示詳細資訊
- 包含：建案名稱、縣市行政區標籤、首筆成交年月
- 支援模糊搜尋與中文輸入

### 4. 外部連結整合 (Sidebar)
- 新增「開發者日誌」：連結至 Medium
- 新增「Threads」：連結至 Threads 社群

### 5. 樓層區間均價試算 (2026-01-17)

**位置**：熱力圖報告上方

**功能**：
- 用戶輸入起始樓層與結束樓層（如 5~10樓）
- 計算該區間內所有成交的加權平均單價
- **公式**：`Sum(房屋總價) / Sum(房屋面積)`
- 顯示：平均單價 (加權) 與 參考筆數

### 6. 首頁與登入整合 (2026-01-18)
- **路徑重構**：
    - `/` (Root): 顯示登入頁面 (Login)
    - `/dashboard`: 顯示總覽儀表板 (Dashboard)
- **Sidebar 整合**：
    - 登入頁面需保留 Sidebar 佈局
    - Sidebar 新增「會員登入」連結指向 `/`
    - Sidebar「總覽儀表板」連結指向 `/dashboard`

### 7. 房市政策時光機增強 (2026-01-18)

**位置**：分析報告 > 房市政策時光機 (Timeline)

**功能**：
- **多建案可視化 (Multi-Project)**：支援同時顯示多個建案的銷售期，以堆疊 (Stacked) 方式呈現。
- **動態高度調整**：時間軸高度隨建案數量自動增長。
- **政策細節展開**：完整收錄 2012-2025 年政策/金融事件，支援展開查看完整規範。
- **顯示邏輯**：
    - 僅當 FilterBar 選擇「建案名稱」時顯示銷售條。
    - 時間軸固定從 2012 年 (實價登錄 1.0) 開始。



---

## 🔄 多縣市分析邏輯

### 數據聚合策略

當用戶選擇多個縣市時：
1. 對每個縣市並行發送 API 請求
2. 使用 `aggregator.js` 合併分析結果
3. 核心指標直接相加
4. 分位數在前端使用 `transactionDetails` 重新計算
5. 排名、總價帶分析等合併顯示

### 標籤顯示規則

- 單縣市：不顯示縣市標籤
- 多縣市：顯示縣市標籤協助區分

---

## 📱 響應式設計規格

| 斷點 | 說明 |
|------|------|
| `< 640px` | 行動版：單欄佈局 |
| `640px - 1024px` | 平板：兩欄佈局 |
| `> 1024px` | 桌面版：完整佈局 |

---

## 📤 PDF 導出規格

### 包含內容
1. 核心指標摘要
2. 建案排名表格
3. 總價帶分析圖表
4. 房屋單價分析表格
5. 車位分析報表

### 格式
- A4 縱向
- 深色主題
- 自動分頁

---

## 🔐 權限規格

### 目前狀態
- 用戶認證：**停用**（開發階段）
- 所有功能公開可用

### 未來規劃
- Supabase Auth 整合
- 付費會員分級
- API 限流機制
