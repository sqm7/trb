# 📋 SPEC.md - 平米內參需求真理源

**版本**: 3.0.0  
**最後更新**: 2026-01-15

---

## 🎯 產品定位

**「平米內參」是一個不動產數據分析平台**，將台灣實價登錄數據轉化為可視化的決策支援系統。

### 目標用戶
- 代銷人員
- 房仲業者
- 建商
- 估價師
- 投資者

---

## 🧠 核心業務邏輯

### 1. 建案分析功能

| 功能 | 說明 | 核心指標 |
|------|------|----------|
| 核心指標與排名 | 區域建案的綜合排名分析 (含行政區標籤) | 總銷金額、成交件數、坪數統計、市佔率、行政區 |
| 總價帶分析 | 不同價格區間的分佈分析 | 價格區間、成交比例、箱型圖統計 |
| 房屋單價分析 | 無車位房屋單價的類型分析 | 住宅/店舖/商辦倍數比較、**單價泡泡圖** |
| 房型去化分析 | 各戶型的銷售速度與定價策略 | 基準戶、樓層價差、熱力圖、**區域房型交叉表** |
| 車位單價分析 | 車位定價與3D樓層視覺化 | 車位均價、樓層分佈、房車配比 |
| 垂直水平分析 | 樓層溢價與水平比較 | 樓層價差百分比、水平比較表 |

### 2. 關鍵計算公式

```
房屋單價(萬) = (交易總價 - 車位總價) / (房屋面積 ÷ 3.30579) / 10000
```

---

## 🔍 數據篩選邏輯

### 1. 主要篩選條件

| 篩選項 | 說明 | 欄位對應 |
|--------|------|----------|
| 縣市 | **可多選**縣市範圍 | `selectedCounties` → 資料表名稱 |
| 區域 | 可多選行政區 | `districts` → `行政區` |
| 交易類型 | 預售交易 / 中古交易 | `type` → 表名後綴 `_b` / `_a` |
| 日期範圍 | 交易日期區間 | `dateStart`, `dateEnd` → `交易日` |
| 建物型態 | 住宅大樓/華廈/店面等 | `buildingType` → `建物型態` |
| 建案名稱 | 可多選指定建案 | `projectNames` → `建案名稱` |
| 排除商辦店面 | 開關控制 | `excludeCommercial` |

### 2. 建物型態特殊篩選：店面(店鋪)

當 `buildingType === '店面(店鋪)'` 時，使用 OR 組合查詢：
```sql
"建物型態" ILIKE '%店面%' OR
"建物型態" ILIKE '%店舖%' OR
"建物型態" ILIKE '%店鋪%' OR
("主要用途" = '商業用' AND "樓層" = 1) OR
("主要用途" = '住商用' AND "樓層" = 1) OR
"備註" ILIKE '%店面%' OR
"戶別" ILIKE '%店面%' OR
("建物型態" ILIKE '%住宅大樓%' AND "樓層" = 1 AND "房數" = 0)
```

### 3. 房型分類邏輯（互斥優先級）

```
優先級 1: 店舖
├── building_type 包含 "店舖" / "店面" / "店鋪"
├── 戶別 包含 "店舖" / "店面" / "店鋪"
├── 備註 包含 "店面" / "店舖" / "店鋪"
├── (主要用途 = '商業用' AND 樓層 = 1)
├── (主要用途 = '住商用' AND 樓層 = 1)
├── (建物型態 = 住宅大樓 AND 戶別含 'S')
└── (建物型態 = 住宅大樓 AND 樓層 = 1 AND 房數 = 0)

優先級 2: 辦公/事務所
├── 戶別 包含 "事務所" 或 "辦公"
├── 主要用途 包含 "商業"
└── 建物型態 包含 "辦公" 或 "事務所"

優先級 3: 廠辦/工廠
└── 建物型態 包含 "工廠" / "倉庫" / "廠辦"

優先級 4: 特殊住宅 (0房)
├── 住宅大樓/華廈 且 房數 = 0 且 面積 > 35坪 → 毛胚
└── 住宅大樓/華廈 且 房數 = 0 且 面積 ≤ 35坪 → 套房

優先級 5: 標準住宅
├── 房數 = 1 → 1房
├── 房數 = 2 → 2房
├── 房數 = 3 → 3房
├── 房數 = 4 → 4房
└── 房數 ≥ 5 → 5房以上

優先級 6: 其他
└── 無法分類 → 其他
```

---

## 📊 新增功能規格 (2026-01-15)

### 1. 區域房型成交筆數交叉表格

**位置**：房型去化分析頁籤底部

**功能**：
- 顯示各行政區/縣市的房型成交筆數
- 支援維度切換（行政區 / 縣市）
- 支援縣市篩選（行政區維度時）
- 與房型篩選器連動

**UI 控制項**：
- 分組維度切換按鈕
- 顯示範圍下拉選單（僅行政區維度時顯示）
- 交叉表格（行=房型, 列=區域）
- 堆疊橫向長條圖

### 2. 單價分佈泡泡圖

**位置**：房屋單價分析頁籤底部

**功能**：
- 顯示不同單價區間的成交分佈
- 泡泡大小 = 影響力（成交件數或總坪數）
- 漸層色彩 = 單價高低
- 支援自訂單價區間

**UI 控制項**：
- 最低單價輸入框
- 最高單價輸入框
- 單價級距輸入框
- 影響力指標切換按鈕（成交件數 / 房屋坪數）
- 更新圖表按鈕

---

## 🔄 多縣市分析邏輯

### 數據聚合策略

當用戶選擇多個縣市時：
1. 對每個縣市並行發送 API 請求
2. 使用 `aggregator.js` 合併分析結果
3. 核心指標直接相加
4. 分位數在前端使用 `transactionDetails` 重新計算
5. 排名、總價帶分析等合併顯示

### 標籤顯示規則

- 單縣市：不顯示縣市標籤
- 多縣市：顯示縣市標籤協助區分

---

## 📱 響應式設計規格

| 斷點 | 說明 |
|------|------|
| `< 640px` | 行動版：單欄佈局 |
| `640px - 1024px` | 平板：兩欄佈局 |
| `> 1024px` | 桌面版：完整佈局 |

---

## 📤 PDF 導出規格

### 包含內容
1. 核心指標摘要
2. 建案排名表格
3. 總價帶分析圖表
4. 房屋單價分析表格
5. 車位分析報表

### 格式
- A4 縱向
- 深色主題
- 自動分頁

---

## 🔐 權限規格

### 目前狀態
- 用戶認證：**停用**（開發階段）
- 所有功能公開可用

### 未來規劃
- Supabase Auth 整合
- 付費會員分級
- API 限流機制
