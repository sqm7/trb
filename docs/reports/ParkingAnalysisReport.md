# Parking Analysis Report (車位分析)

## 1. 概述
`ParkingAnalysisReport` 專注於分析車位市場的供需與價格結構。包含房車配比、車位價格分佈、坪數分析以及樓層價差分析。

## 2. 功能特點
- **房車配比 (`ParkingRatioChart`)**: 
  - 分析建案中「有購置車位」與「無車位」的交易比例。
  - 圓餅圖展示。
- **車位類型均價**: 
  - 列表展示坡道平面、機械車位等不同類型的平均價格、中位數與數量。
- **車位坪數/價格散佈圖 (`ParkingScatterChart`)**:
  - **規模分析**: X軸(車位總數) vs Y軸(平均坪數)。觀察大社區是否傾向規劃大車位。
  - **價值分析**: X軸(平均價格) vs Y軸(平均坪數)。觀測價格與坪數的相關性。
  - 支援滑鼠懸停 tooltip 顯示建案詳情。
- **坡道平面樓層價差分析**:
  - **3D 互動堆疊圖**: 採用物理光影計算(頂面/側面/前面不同亮度)增強立體感。
  - **動態縮放系統**: 樓層過多時自動縮放 (`scale = 4 / n`)，確保堆疊始終維持在 600px 畫布內。
  - **Portal 滑鼠追蹤**: 資訊標籤透過 `createPortal` 渲染至 Body，徹底解決 3D 座標偏移問題，實現零延遲跟隨。
  - **明細一鍵查看**: 表格欄位與 3D 方塊點擊均可連動至詳情 transactions 面板。

## 3. props 定義
- `data`: `AnalysisData` 物件，需包含 `parkingAnalysis` 與 `transactionDetails`。

## 4. 關鍵邏輯
- **樓層統計計算 (`calculateFloorStats`)**: 
  - 前端即時聚合所選樓層（如 B1+B2）的車位價格，計算加權平均與四分位數。
- **散佈圖數據處理**: 
  - 聚合每個建案的車位坪數與價格，生成散佈圖所需的 XY 座標點。
- **車位明細匹配**: 
  - 優先使用後端聚合的 `trustedRecords`。
  - 若無，則透過關鍵字（"B1", "地下一層"）對原始交易備註進行模糊匹配 (`Legacy Flattened Filter`)。
