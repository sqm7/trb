# ğŸ—ï¸ ARCHITECTURE.md - æŠ€è¡“æ¶æ§‹ (Next.js)

**ç‰ˆæœ¬**: 3.1.0  
**æœ€å¾Œæ›´æ–°**: 2026-01-16

> **âš ï¸ èˆŠç‰ˆæ–‡ä»¶**: è‹¥æ‚¨éœ€è¦åƒè€ƒ Vanilla JS ç‰ˆæœ¬çš„æ¶æ§‹ï¼Œè«‹æŸ¥çœ‹ [docs/legacy/ARCHITECTURE_LEGACY.md](legacy/ARCHITECTURE_LEGACY.md)ã€‚

---

## ğŸ—ï¸ Next.js æ¶æ§‹ (Current)

### ç›®éŒ„çµæ§‹ (next-app/src)
```
src/
â”œâ”€â”€ app/
â”‚   â”œâ”€â”€ page.tsx               # ä¸»å„€è¡¨æ¿é é¢
â”‚   â”œâ”€â”€ login/                 # [New] ç™»å…¥é é¢
â”‚   â”‚   â””â”€â”€ page.tsx
â”‚   â”œâ”€â”€ admin/                 # [New] å¾Œå°ç®¡ç†
â”‚   â”‚   â”œâ”€â”€ features/
â”‚   â”‚   â”‚   â”œâ”€â”€ Analysis/       # Charts & Data reports
â”‚   â”‚   â”‚   â”œâ”€â”€ Map/            # Map Tool Components
â”‚   â”‚   â”‚   â”‚   â””â”€â”€ LeafletMap.tsx
â”‚   â”‚   â”‚   â””â”€â”€ FloorPlan/      # Floor Plan Tool Components
â”‚   â”‚   â”‚       â””â”€â”€ FloorPlanCanvas.tsx
â”‚   â”‚   â”œâ”€â”€ layout/             # Sidebar, Header
â”‚   â””â”€â”€ globals.css            # å…¨åŸŸæ¨£å¼ (Tailwind) å…¨åŸŸæ¨£å¼ (Aura Theme)
â”œâ”€â”€ components/
â”‚   â”œâ”€â”€ ui/                 # åŸºç¤å…ƒä»¶ (Button, Card, Input...)
â”‚   â”œâ”€â”€ features/
â”‚   â”‚   â””â”€â”€ FilterBar.tsx   # ç¯©é¸æ§åˆ¶åˆ—
â”‚   â”œâ”€â”€ charts/             # Atomic åœ–è¡¨å…ƒä»¶
â”‚   â”‚   â”œâ”€â”€ RankingChart.tsx
â”‚   â”‚   â”œâ”€â”€ PriceBandChart.tsx
â”‚   â”‚   â”œâ”€â”€ SalesVelocityChart.tsx
â”‚   â”‚   â”œâ”€â”€ AreaHeatmapChart.tsx
â”‚   â”‚   â”œâ”€â”€ ParkingRatioChart.tsx
â”‚   â”‚   â””â”€â”€ BubbleChart.tsx # [New]
â”‚   â””â”€â”€ reports/            # æ•´åˆå ±å‘Šè¦–åœ–
â”‚       â”œâ”€â”€ ReportWrapper.tsx
â”‚       â”œâ”€â”€ RankingReport.tsx
â”‚       â”œâ”€â”€ PriceBandReport.tsx
â”‚       â”œâ”€â”€ SalesVelocityReport.tsx
â”‚       â”œâ”€â”€ ParkingAnalysisReport.tsx
â”‚       â”œâ”€â”€ UnitPriceAnalysisReport.tsx
â”‚       â”œâ”€â”€ HeatmapReport.tsx
â”‚       â””â”€â”€ DataListReport.tsx
â”œâ”€â”€ lib/
â”‚   â”œâ”€â”€ api.ts              # API å®¢æˆ¶ç«¯
â”‚   â”œâ”€â”€ config.ts           # è¨­å®šæª”
â”‚   â”œâ”€â”€ utils.ts            # å·¥å…·å‡½å¼ (cn)
â”‚   â””â”€â”€ store/
â”‚       â””â”€â”€ useFilterStore.ts # Zustand å…¨åŸŸç‹€æ…‹
```

---

## ğŸ”„ æ•¸æ“šæµæ¶æ§‹ (Next.js)

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                         ä½¿ç”¨è€…ç€è¦½å™¨                              â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  Next.js App (src/app/page.tsx)                                 â”‚
â”‚    â”œâ”€â”€ useFilterStore (Zustand) â—„â”€â”€â”€â”€ ä¸­å¤®ç‹€æ…‹ç®¡ç†               â”‚
â”‚    â”œâ”€â”€ FilterBar (Component) â”€â”€â”€ è§¸ç™¼ç¯©é¸è®Šæ›´                   â”‚
â”‚    â”œâ”€â”€ api.ts â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ å°è£ fetch è«‹æ±‚                  â”‚
â”‚    â”œâ”€â”€ aggregator.ts â”€â”€â”€â”€â”€â”€â”€â”€â”€ å¤šç¸£å¸‚æ•¸æ“šå‰ç«¯èšåˆ               â”‚
â”‚    â””â”€â”€ components/reports/* â”€â”€ æ¥æ”¶ Data Prop é€²è¡Œæ¸²æŸ“          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                         â”‚ HTTPS POST
                         â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    Supabase Edge Functions                      â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  analyze-project-ranking/index.ts                               â”‚
â”‚    â”œâ”€â”€ è®€å– filters åƒæ•¸                                        â”‚
â”‚    â”œâ”€â”€ å»ºæ§‹ SQL æŸ¥è©¢ï¼ˆå«ç‰¹æ®Šåº—é¢ç¯©é¸ï¼‰                           â”‚
â”‚    â”œâ”€â”€ èª¿ç”¨ _shared/unit-parser.ts (æˆ¶åˆ¥è§£æ)                   â”‚
â”‚    â”œâ”€â”€ èª¿ç”¨ _shared/analysis-engine.ts (åˆ†æè¨ˆç®—)               â”‚
â”‚    â”œâ”€â”€ æ³¨å…¥ç¸£å¸‚åç¨±è‡³ transactionDetails (ä¾›å‰ç«¯èšåˆç”¨)         â”‚
â”‚    â””â”€â”€ å›å‚³ JSON çµæœ                                           â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                         â”‚ Postgres Query
                         â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    Supabase PostgreSQL                          â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  è³‡æ–™è¡¨: {ç¸£å¸‚}_lvr_land_{äº¤æ˜“é¡å‹}                              â”‚
â”‚    â”œâ”€â”€ a_lvr_land_b (å°åŒ—å¸‚é å”®)                                â”‚
â”‚    â”œâ”€â”€ a_lvr_land_a (å°åŒ—å¸‚ä¸­å¤)                                â”‚
â”‚    â”œâ”€â”€ a_lvr_land_b_park (å°åŒ—å¸‚é å”®è»Šä½é™„è¡¨)                   â”‚
â”‚    â””â”€â”€ ...                                                      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## ğŸ“Š å‰ç«¯æ¨¡çµ„è©³è§£ (Next.js)

### useFilterStore.ts - Zustand ç‹€æ…‹ç®¡ç†

è² è²¬ç®¡ç†å…¨åŸŸçš„ç¯©é¸æ¢ä»¶èˆ‡ UI ç‹€æ…‹ï¼š

*   **Filters**: `countyCode`, `districts`, `projectNames`, `dateStart`, `dateEnd`...
*   **Settings**: `excludeCommercial`, `parkingFloorFilter`, `velocityView`...
*   **Actions**: `setFilters`, `resetFilters`, `toggleProperty`...

### DataListReport.tsx - ç¨ç«‹æ•¸æ“šæŸ¥è©¢

ç‚ºäº†ä¿è­‰è³‡æ–™åˆ—è¡¨çš„å®Œæ•´æ€§ï¼Œæˆ‘å€‘æ¡ç”¨äº† **ç¨ç«‹æŸ¥è©¢ç­–ç•¥**ï¼š
1.  **ä¸å…±ç”¨åˆ†æ API**: ä¸ä½¿ç”¨ `analyze-project-ranking` çš„å›å‚³æ•¸æ“šï¼ˆå› å¯èƒ½è¢«æˆªæ–·æˆ–éæ¿¾ï¼‰ã€‚
2.  **ç¨ç«‹ Fetch**: ç›´æ¥å‘¼å« `api.fetchData` (å°æ‡‰ `query-data` ç«¯é»)ã€‚
3.  **æ™ºæ…§è£œå„Ÿ (Smart Fallback)**:
    *   ç•¶ä½¿ç”¨è€…é»æ“Šã€Œé™„è¡¨ã€æŒ‰éˆ•æ™‚ï¼Œèª¿ç”¨ `api.fetchSubData`ã€‚
    *   è‹¥ç„¡é™„è¡¨è³‡æ–™ï¼ˆå›å‚³ç©ºï¼‰ï¼Œä½†ä¸»è¡¨æœ‰è»Šä½ç´€éŒ„ï¼Œå‰‡**è‡ªå‹•é™ç´š**é¡¯ç¤ºä¸»è¡¨çš„åŒ¯ç¸½è³‡è¨Šï¼ˆåƒ¹æ ¼/é¢ç©ï¼‰ï¼Œä¸¦æ¨™ç¤ºæ¨“å±¤ç‚º `Unknown`ã€‚

### ParkingAnalysisReport.tsx - è»Šä½åˆ†æ

*   **Unknown Floor Support**: æ”¯æ´é¡¯ç¤º `Unknown` æ¨“å±¤çš„æ•¸æ“šï¼ˆç°è‰²æ¨™ç¤ºï¼‰ï¼Œè§£æ±ºè³‡æ–™ç¼ºæ¼é€ æˆçš„çµ±è¨ˆä¸ç¬¦å•é¡Œã€‚
*   **Trusted Data Source**: è©³ç´°åˆ—è¡¨å„ªå…ˆä½¿ç”¨å¾Œç«¯èšåˆçš„ `rawRecords`ï¼Œè§£æ±ºå‰ç«¯ç¯©é¸ç„¡æ³•åŒ¹é…å­è¡¨æ•¸æ“šçš„å•é¡Œã€‚

---

## ğŸ”§ å¾Œç«¯æ¨¡çµ„è©³è§£

### analysis-engine.ts - åˆ†æå¼•æ“

| å‡½å¼ | åŠŸèƒ½ |
|------|------|
| `getRoomCategory(record)` | æˆ¿å‹åˆ†é¡ï¼ˆäº’æ–¥å„ªå…ˆç´šï¼‰ |
| `calculatePriceBandAnalysis(data)` | ç¸½åƒ¹å¸¶åˆ†æè¨ˆç®— (å« `byDistrict` å€åŸŸçµ±è¨ˆ) |
| `calculateUnitPriceAnalysis(data, unitIds)` | æˆ¿å±‹å–®åƒ¹åˆ†æ |
| `calculateParkingAnalysis(data, parkMap, unitIds)` | è»Šä½åˆ†æ |
| `calculateSalesVelocity(data)` | éŠ·å”®é€Ÿåº¦è¨ˆç®— |
| `calculatePriceGridAnalysis(data, parkMap, unitIds, premium)` | å‚ç›´æ°´å¹³åˆ†æ |
| `calculateAreaDistribution(data)` | é¢ç©åˆ†ä½ˆè¨ˆç®— |
| `calculateStats(transactions, unitIds)` | çµ±è¨ˆæ•¸æ“šè¨ˆç®— |
| `calculateQuantile(arr, q)` | åˆ†ä½æ•¸è¨ˆç®— |
| `fetchAllData(query)` | è‡ªå‹•åˆ†é æ’ˆå– |

### unit-parser.ts - æˆ¶åˆ¥è§£æå™¨

| é¡åˆ¥/å‡½å¼ | åŠŸèƒ½ |
|-----------|------|
| `PatternDetector` | æ¨¡å¼åµæ¸¬å™¨ï¼ˆ20+ æ­£è¦è¡¨ç¤ºå¼ï¼‰ |
| `AdaptiveUnitResolver` | è‡ªé©æ‡‰è§£æå™¨ |
| `resolveWithContext(record)` | å–®ç­†è§£æ |
| `getProjectProfile(projectName)` | å»ºæ¡ˆé¢¨æ ¼åˆ†æ |

### constants.ts - å¸¸æ•¸å®šç¾©

| å¸¸æ•¸ | åŠŸèƒ½ |
|------|------|
| `countyCodeToName` | ç¸£å¸‚ä»£ç¢¼è½‰ç¸£å¸‚åç¨±å°ç…§è¡¨ |

---

## ğŸ›ï¸ é—œéµæŠ€è¡“æ±ºç­– (Technical Decisions)

### 1. å¤šç¸£å¸‚æ•¸æ“šèšåˆç­–ç•¥ (2026-01-15)

**å•é¡Œ**ï¼šç”¨æˆ¶éœ€è¦åŒæ™‚åˆ†æå¤šå€‹ç¸£å¸‚çš„æ•¸æ“šã€‚

**è§£æ±ºæ–¹æ¡ˆ**ï¼š
- åœ¨ `eventHandlers.js` å¯¦ä½œä¸¦è¡Œ API è«‹æ±‚
- ä½¿ç”¨ `aggregator.js` åˆä½µå¤šç¸£å¸‚åˆ†æçµæœ
- å°æ–¼åˆ†ä½æ•¸ç­‰éœ€è¦åŸå§‹æ•¸æ“šçš„è¨ˆç®—ï¼Œåœ¨å‰ç«¯ä½¿ç”¨ `transactionDetails` é‡æ–°è¨ˆç®—

### 4. æ··åˆå¼æ•¸æ“šèšåˆ (Hybrid Aggregation) - Next.js Price Band (2026-01-16)

**å•é¡Œ**ï¼šå¾Œç«¯ API é èšåˆçš„ `locationCrossTable` åƒ…åŒ…å«å–®ä¸€ç¶­åº¦ï¼ˆé€šå¸¸æ˜¯è¡Œæ”¿å€ï¼‰ï¼Œç„¡æ³•å³æ™‚åˆ‡æ›è‡³ç¸£å¸‚å±¤ç´šã€‚

**è§£æ±ºæ–¹æ¡ˆ**ï¼š
- ä¿ç•™å¾Œç«¯é èšåˆæ•¸æ“šç”¨æ–¼é è¨­é¡¯ç¤º (District)ã€‚
- ç•¶ç”¨æˆ¶åˆ‡æ›è‡³ã€Œç¸£å¸‚ (County)ã€ç¶­åº¦æ™‚ï¼Œå‰ç«¯å³æ™‚å° `transactionDetails` é€²è¡Œèšåˆè¨ˆç®—ã€‚
- å„ªé»ï¼šç„¡éœ€é‡æ–°ç™¼é€ API è«‹æ±‚å³å¯åˆ‡æ›ç¶­åº¦ï¼Œæå‡äº’å‹•é«”é©—ã€‚

### 5. ç¸½åƒ¹å¸¶è©³æƒ…è¡¨æ ¼èšåˆ (Detailed Table Aggregation) - Next.js (2026-01-16)

**å•é¡Œ**ï¼šä½¿ç”¨è€…èªç‚ºä¾ã€Œæˆ¿æ•¸-è¡›æµ´æ•¸ã€å€åˆ†çš„è¡¨æ ¼å¤ªéç´°ç¢ï¼Œå¸Œæœ›çœ‹åˆ°ä¾ã€Œæˆ¿å‹ã€åˆä½µçš„è¦–åœ–ï¼Œä¸”èƒ½ä¿æŒå‘ä¸‹é‘½å–çš„èƒ½åŠ›ã€‚

**è§£æ±ºæ–¹æ¡ˆ**ï¼š
- å¯¦ä½œå‰ç«¯ `Merge Bathrooms` Toggleã€‚
- é–‹å•Ÿæ™‚ï¼Œå°‡æ•¸æ“šæŒ‰æˆ¿å‹ (Room Type) é‡æ–°èšåˆï¼Œä¸¦è¨ˆç®—åŠ æ¬Šå¹³å‡ã€‚
- å¯¦ä½œã€Œå±•é–‹è¡Œ (Expandable Row)ã€åŠŸèƒ½ï¼Œé»æ“Šåˆä½µè¡Œå¯æŸ¥çœ‹å…·é«”çš„è¡›æµ´æ•¸åˆ†ä½ˆã€‚
- å„ªé»ï¼šåŒæ™‚æ»¿è¶³æ¦‚è¦½èˆ‡ç´°ç¯€éœ€æ±‚ï¼Œç„¡éœ€å¾Œç«¯é‡æ–°æŸ¥è©¢ã€‚

### 2. å€åŸŸæˆ¿å‹äº¤å‰è¡¨æ ¼ (2026-01-15)

**å•é¡Œ**ï¼šç”¨æˆ¶éœ€è¦æŸ¥çœ‹å„è¡Œæ”¿å€/ç¸£å¸‚çš„æˆ¿å‹æˆäº¤ç­†æ•¸åˆ†ä½ˆã€‚

**è§£æ±ºæ–¹æ¡ˆ**ï¼š
- åœ¨ `analyze-project-ranking` å¾Œç«¯ç‚ºæ¯ç­†äº¤æ˜“æ³¨å…¥ç¸£å¸‚åç¨±
- å‰ç«¯ä½¿ç”¨ `transactionDetails` é‡æ–°èšåˆæ•¸æ“š
- æ”¯æ´è¡Œæ”¿å€/ç¸£å¸‚ç¶­åº¦åˆ‡æ›
- æ”¯æ´ç¸£å¸‚ç¯©é¸ï¼ˆåªé¡¯ç¤ºç‰¹å®šç¸£å¸‚çš„è¡Œæ”¿å€ï¼‰

### 3. å–®åƒ¹æ³¡æ³¡åœ– (2026-01-15)

**åŠŸèƒ½**ï¼šå¯è¦–åŒ–ä¸åŒå–®åƒ¹å€é–“çš„æˆäº¤åˆ†ä½ˆèˆ‡å½±éŸ¿åŠ›ã€‚

**æŠ€è¡“å¯¦ä½œ**ï¼š
- ä½¿ç”¨ ApexCharts Bubble Chart
- æ³¡æ³¡å¤§å° = å½±éŸ¿åŠ›ï¼ˆæˆäº¤ä»¶æ•¸æˆ–ç¸½åªæ•¸ï¼‰
- æ¼¸å±¤é¡è‰² = å–®åƒ¹é«˜ä½
- æ”¯æ´è‡ªè¨‚å–®åƒ¹å€é–“å’Œç´šè·

### 4. è³‡æ–™åˆ—è¡¨ç¨ç«‹æŸ¥è©¢ (Data List Independent Fetching) - Next.js (2026-01-16)

**å•é¡Œ**ï¼š`analyze-project-ranking` ç«¯é»å›å‚³çš„ `transactionDetails` ç‚ºäº†è§£æèˆ‡è¨ˆç®—æ–¹ä¾¿ï¼Œé€šå¸¸æœƒé€²è¡Œç¯©é¸æˆ–æˆªæ–·ï¼Œä¸”ä¸åŒ…å«æ‰€æœ‰åŸå§‹æ¬„ä½ï¼ˆå¦‚äº¤æ˜“ç­†æ£Ÿæ•¸ï¼‰ï¼Œå°è‡´åˆ—è¡¨è³‡æ–™ä¸å®Œæ•´ã€‚

**è§£æ±ºæ–¹æ¡ˆ**ï¼š
- å°‡ `DataListReport.tsx` çš„è³‡æ–™ä¾†æºæ”¹ç‚ºç¨ç«‹èª¿ç”¨ `api.fetchData` (å°æ‡‰å¾Œç«¯ `query-data`)ã€‚
- æ”¯æ´å®¢æˆ¶ç«¯åˆ†é èˆ‡å¤šç¸£å¸‚ä¸¦è¡ŒæŸ¥è©¢ (Client-side pagination with multi-county fetching)ã€‚
- å„ªé»ï¼šç¢ºä¿åˆ—è¡¨é¡¯ç¤ºå®Œæ•´çš„åŸå§‹è³‡æ–™ï¼Œä¸å—åˆ†æé‚è¼¯çš„ç¯©é¸å½±éŸ¿ï¼Œä¸¦è£œé½Šéºæ¼æ¬„ä½ã€‚

### 6. Portal Tooltip Implementation (2026-01-17)

**å•é¡Œ**ï¼šç†±åŠ›åœ–è¡¨æ ¼éœ€è¦ `overflow-x-auto` æ”¯æ´æ°´å¹³æ»¾å‹•ï¼Œå°è‡´å…§éƒ¨çš„ Tooltip åœ¨é‚Šç•Œè™•è¢«è£åˆ‡ (Clipping)ã€‚

**è§£æ±ºæ–¹æ¡ˆ**ï¼š
- ä½¿ç”¨ `React.createPortal` å°‡ Tooltip æ¸²æŸ“è‡³ `document.body`ã€‚
- æ ¹æ“šè§¸ç™¼å…ƒç´  (Cell) çš„ `getBoundingClientRect` å‹•æ…‹è¨ˆç®—å›ºå®šä½ç½®ã€‚
- å¯¦ä½œæ™ºæ…§å®šä½ï¼šå‰å¹¾æ’ (Top Rows) å‘ä¸‹é¡¯ç¤ºï¼Œå…¶é¤˜å‘ä¸Šé¡¯ç¤ºï¼Œé¿å…è¢«è¦–çª—é‚Šç•Œåˆ‡æ–·ã€‚

---

## ğŸ—„ï¸ è³‡æ–™åº« Schema

### è¡¨å‘½åè¦å‰‡
```
{ç¸£å¸‚ä»£ç¢¼}_lvr_land_{äº¤æ˜“é¡å‹}
{ç¸£å¸‚ä»£ç¢¼}_lvr_land_{äº¤æ˜“é¡å‹}_park  (è»Šä½é™„è¡¨)

ç¸£å¸‚ä»£ç¢¼: A=å°åŒ—, B=å°ä¸­, C=åŸºéš†, D=å°å—, E=é«˜é›„, F=æ–°åŒ—...
äº¤æ˜“é¡å‹: a=ä¸­å¤äº¤æ˜“, b=é å”®äº¤æ˜“
```

### ä¸»è¡¨æ¬„ä½

| æ¬„ä½ | èªªæ˜ |
|------|------|
| `ç·¨è™Ÿ` | ä¸»éµ |
| `å»ºæ¡ˆåç¨±` | å»ºæ¡ˆè­˜åˆ¥ |
| `è¡Œæ”¿å€` | å€åŸŸ |
| `äº¤æ˜“æ—¥` | äº¤æ˜“æ—¥æœŸ |
| `æˆ¶åˆ¥` | åŸå§‹æˆ¶åˆ¥å­—ä¸² |
| `æ¨“å±¤` | æ¨“å±¤æ•¸ |
| `å»ºç‰©å‹æ…‹` | ä½å®…å¤§æ¨“/è¯å»ˆ/é€å¤©ç­‰ |
| `ä¸»è¦ç”¨é€”` | ä½å®¶ç”¨/å•†æ¥­ç”¨ç­‰ |
| `äº¤æ˜“ç¸½åƒ¹(è¬)` | ç¸½äº¤æ˜“é‡‘é¡ |
| `æˆ¿å±‹ç¸½åƒ¹(è¬)` | ä¸å«è»Šä½åƒ¹æ ¼ |
| `æˆ¿å±‹é¢ç©(åª)` | æˆ¿å±‹é¢ç© |
| `æˆ¿å±‹å–®åƒ¹(è¬)` | è¨ˆç®—æ¬„ä½ |
| `è»Šä½ç¸½åƒ¹(è¬)` | è»Šä½åƒ¹æ ¼ |
| `è»Šä½æ•¸` | è»Šä½æ•¸é‡ |
| `æˆ¿æ•¸` | æˆ¿é–“æ•¸ |
| `å‚™è¨»` | ç‰¹æ®Šäº¤æ˜“å‚™è¨» |

### è»Šä½é™„è¡¨æ¬„ä½

| æ¬„ä½ | èªªæ˜ |
|------|------|
| `ç·¨è™Ÿ` | å°æ‡‰ä¸»è¡¨ |
| `è»Šä½æ¨“å±¤` | B1, B2 ç­‰ |
| `è»Šä½åƒ¹æ ¼(è¬)` | å–®ä¸€è»Šä½åƒ¹æ ¼ |
| `è»Šä½é¢ç©(åª)` | è»Šä½é¢ç© |

### å»ºæ¡ˆåç¨±å°æ‡‰è¡¨ (project_name_mappings)

| æ¬„ä½ | èªªæ˜ |
|------|------|
| `id` | ä¸»éµ |
| `old_name` | åŸå§‹åç¨±ï¼ˆå«äº‚ç¢¼æˆ–éŒ¯å­—ï¼‰ |
| `new_name` | ä¿®æ­£å¾Œçš„åç¨± |
| `city` | ç¸£å¸‚åç¨± |
| `county_code` | ç¸£å¸‚ä»£ç¢¼ï¼ˆå¯é¸ï¼‰ |
| `created_at` | å‰µå»ºæ™‚é–“ |
| `created_at` | å‰µå»ºæ™‚é–“ |
| `updated_at` | æ›´æ–°æ™‚é–“ |

### æœƒå“¡è³‡æ–™è¡¨ (profiles)

| æ¬„ä½ | èªªæ˜ |
|------|------|
| `id` | å°æ‡‰ auth.users (UUID) |
| `email` | é›»å­ä¿¡ç®± |
| `full_name` | é¡¯ç¤ºåç¨± |
| `avatar_url` | é ­åƒé€£çµ |
| `provider` | è¨»å†Šä¾†æº (line/email) |
| `line_user_id` | Line User ID (é¸å¡«) |
| `created_at` | å‰µå»ºæ™‚é–“ |
| `updated_at` | æ›´æ–°æ™‚é–“ |

---

## ğŸ”Œ API ç«¯é»

| Endpoint | æ–¹æ³• | åŠŸèƒ½ |
|----------|------|------|
| `/functions/v1/query-data` | POST | æŸ¥è©¢äº¤æ˜“æ•¸æ“šåˆ—è¡¨ |
| `/functions/v1/query-names` | POST | æŸ¥è©¢å»ºæ¡ˆåç¨±å»ºè­° |
| `/functions/v1/query-sub-data` | POST | æŸ¥è©¢é™„è¡¨æ•¸æ“š |
| `/functions/v1/analyze-project-ranking` | POST | å®Œæ•´åˆ†æå ±å‘Š |
| `/functions/v1/generate-share-link` | POST | ç”Ÿæˆåˆ†äº«é€£çµ |
| `/functions/v1/get-users` | POST | Admin å–å¾—æœƒå“¡åˆ—è¡¨ (Secure) |
| `/functions/v1/public-report` | GET | å…¬é–‹å ±å‘ŠæŸ¥çœ‹ |

### è«‹æ±‚æ ¼å¼ç¯„ä¾‹

```javascript
// analyze-project-ranking
{
  filters: {
    countyCode: 'A',
    districts: ['ä¿¡ç¾©å€', 'å¤§å®‰å€'],
    type: 'é å”®äº¤æ˜“',
    dateStart: '2025-01-01',
    dateEnd: '2025-12-31',
    projectNames: ['å»ºæ¡ˆA', 'å»ºæ¡ˆB'],
    buildingType: 'ä½å®…å¤§æ¨“',
    excludeCommercial: false,
    floorPremium: 0.3
  }
}
```

### å›æ‡‰æ ¼å¼

```javascript
{
  coreMetrics: { totalSaleAmount, totalHouseArea, overallAveragePrice, transactionCount },
  projectRanking: [...],
  priceBandAnalysis: { details, locationCrossTable, allDistricts, allRoomTypes },
  unitPriceAnalysis: { residence, shop, office, multipliers },
  parkingAnalysis: { rampParking, mechanicalParking, ratioData },
  salesVelocityAnalysis: { monthly, weekly, roomTypes },
  priceGridAnalysis: { projects: [...], summary },
  areaDistributionAnalysis: [...],
  transactionDetails: [...] // æ¯ç­†å« 'ç¸£å¸‚' æ¬„ä½
}
```

---

## ğŸ› ï¸ æŠ€è¡“æ£§

| é¡åˆ¥ | æŠ€è¡“ |
|------|------|
| å‰ç«¯ | Vanilla JavaScript (ES6 Modules) |
| æ¨£å¼ | Vanilla CSS (æ·±è‰²ä¸»é¡Œ) |
| å¾Œç«¯ | Supabase Edge Functions (Deno + TypeScript) |
| è³‡æ–™åº« | PostgreSQL (Supabase) |
| åœ–è¡¨ | ApexCharts |
| PDF | html2pdf.js |
| éƒ¨ç½² | GitHub Pages (Netlify å‚™ç”¨) |

---

## ğŸ“¦ å¤–éƒ¨ä¾è³´

### å‰ç«¯ CDN
- ApexCharts
- html2pdf.js
- Supabase JS Client
- **`aggregator.ts`**: è³‡æ–™èšåˆæ ¸å¿ƒé‚è¼¯ (è¨ˆç®—ä¸­ä½æ•¸ã€å¹³å‡æ•¸ã€å»åŒ–é€Ÿåº¦ç­‰)ã€‚
- **`heatmap-utils.ts`**: ç†±åŠ›åœ–æ•¸æ“šç”Ÿæˆé‚è¼¯ã€‚
- **`file-handler.ts`**: [New] è™•ç†æœ¬åœ°æª”æ¡ˆç³»çµ±å­˜å– (File System Access API) èˆ‡ CSV è§£æ (PapaParse)ã€‚
- **`uploader-service.ts`**: [New] è³‡æ–™ä¸Šå‚³æœå‹™ï¼ŒåŒ…å«æ™ºæ…§æ›´æ–°æª¢æ¸¬èˆ‡ Supabase æ‰¹æ¬¡å¯«å…¥é‚è¼¯ã€‚
- **`uploader-config.ts`**: [New] ä¸Šå‚³å·¥å…·å°ˆç”¨é…ç½® (æ¬„ä½å°æ‡‰ã€ç¸£å¸‚ä»£ç¢¼)ã€‚
- **`api.ts`**: API è«‹æ±‚å°è£ã€‚
- **`supabase.ts`**: Supabase Client åˆå§‹åŒ–ã€‚

### å¾Œç«¯ Deno
- `https://deno.land/std@0.168.0/http/server.ts`
- Supabase JS Client

---

## ğŸš€ éƒ¨ç½²ç’°å¢ƒ

### GitHub Pages é…ç½®
(Next.js App Router)

| ç’°å¢ƒ | å€‰åº« (Branch) | ç¶²å€ | Base Path | éƒ¨ç½²è…³æœ¬ |
|------|--------------|------|-----------|----------|
| **æ¸¬è©¦ç‰ˆ** | `sqm7/trb` (`main`) | https://sqm7.github.io/trb | `/trb` | `deploy_next_trb.sh` |
| **æ­£å¼ç‰ˆ** | `sqm7/kthd` (`main`) | https://www.sqmtalk.com | `""` (Root) | `deploy_next_prod.sh` |

> âš ï¸ èˆŠç‰ˆçš„åŸç”Ÿ JS æ­£å¼ç‰ˆ (`deploy_github.sh`) å·²åœç”¨ã€‚

### è‡ªå®šç¾©ç¶²åŸŸé…ç½® (Custom Domain)

æ­£å¼ç‰ˆç¶å®š `www.sqmtalk.com`ï¼Œéœ€ç‰¹åˆ¥è™•ç†è·¯å¾‘ï¼š

1.  **CNAME**: éƒ¨ç½²è…³æœ¬æœƒè‡ªå‹•å°‡æ ¹ç›®éŒ„çš„ `CNAME` è¤‡è£½åˆ°ç™¼å¸ƒç›®éŒ„ã€‚
2.  **Base Path**: `next.config.ts` é€éç’°å¢ƒè®Šæ•¸å‹•æ…‹èª¿æ•´ï¼š
    - æ¸¬è©¦ç‰ˆ: `NEXT_PUBLIC_BASE_PATH='/trb'`
    - æ­£å¼ç‰ˆ: `NEXT_PUBLIC_BASE_PATH=''` (ç©ºå­—ä¸²ï¼Œå°æ‡‰æ ¹ç›®éŒ„)

### éƒ¨ç½²æŒ‡ä»¤

```bash
# éƒ¨ç½²åˆ°æ¸¬è©¦ç‰ˆ (Builds to /trb)
bash scripts/deploy_next_trb.sh

# éƒ¨ç½²åˆ°æ­£å¼ç‰ˆ (Builds to Root for Custom Domain)
bash scripts/deploy_next_prod.sh
```

> âš ï¸ **æ³¨æ„**: éƒ¨ç½²è…³æœ¬åŒ…å« GitHub Tokenï¼Œå·²åŠ å…¥ `.gitignore`ã€‚

### è³‡æ–™åº«å‚™ä»½

| é …ç›® | èªªæ˜ |
|------|------|
| **å‚™ä»½è…³æœ¬** | `backup_supabase.sh` |
| **å‚™ä»½ç›®éŒ„** | `supabase_schema_sqm/YYYY-MM-DD/` |
| **Project Ref** | `zxbmbbfrzbtuueysicoc` |

```bash
# åŸ·è¡Œè³‡æ–™åº«çµæ§‹å‚™ä»½
bash scripts/backup_supabase.sh
```

> âš ï¸ **æ³¨æ„**: `backup_supabase.sh` å’Œ `supabase_schema_sqm/` å·²åŠ å…¥ `.gitignore`ï¼Œä¸æœƒä¸Šå‚³åˆ° GitHubã€‚
